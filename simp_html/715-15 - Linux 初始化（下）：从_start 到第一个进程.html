
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 15 | Linux 初始化（下）：从_start 到第一个进程</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>15 | Linux 初始化（下）：从_start 到第一个进程</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0"> 15 | Linux 初始化（下）：从_start 到第一个进程</h1><div><span>LMOS</span> <span>2021-06-11</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/09/4c/09217b78dd958f9603865795a003c84c.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：14.16M</span><span> 时长：15:27</span></div></div><audio title="15 | Linux初始化（下）：从_start到第一个进程" src="https://res001.geekbang.org/media/audio/d6/95/d64f06e45853119a667550a65a568495/ld/ld.m3u8" __idm_id__="942100"></audio></div><div><div><div><div data-slate-editor="true" data-key="13012" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="13013"><span data-slate-object="text" data-key="13014"><span data-slate-leaf="true" data-offset-key="13014:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13015"><span data-slate-object="text" data-key="13016"><span data-slate-leaf="true" data-offset-key="13016:0" data-first-offset="true"><span data-slate-string="true">今天我们继续来研究 Linux 的初始化流程，为你讲解如何解压内核，然后讲解 Linux 内核第一个 C 函数。最后，我们会用 Linux 的第一个用户进程的建立来收尾。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13017"><span data-slate-object="text" data-key="13018"><span data-slate-leaf="true" data-offset-key="13018:0" data-first-offset="true"><span data-slate-string="true">如果用你上手去玩一款新游戏做类比的话，那么上节课只是新手教程，而这节课就是更深入的实战了。后面你会看到很多熟悉的 “面孔”，像是我们前面讲过的 CPU 工作模式、MMU 页表等等基础知识，这节课都会得到运用。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13019" id="sr-toc-1"><span data-slate-object="text" data-key="13020"><span data-slate-leaf="true" data-offset-key="13020:0" data-first-offset="true"><span data-slate-string="true">解压后内核初始化</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13021"><span data-slate-object="text" data-key="13022"><span data-slate-leaf="true" data-offset-key="13022:0" data-first-offset="true"><span data-slate-string="true">下面，我们先从 setup.bin 文件的入口 _start 开始，了解启动信息结构，接着由 16 位 main 函数切换 CPU 到保护模式，然后跳入 vmlinux.bin 文件中的 startup_32 函数重新加载段描述符。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13023"><span data-slate-object="text" data-key="13024"><span data-slate-leaf="true" data-offset-key="13024:0" data-first-offset="true"><span data-slate-string="true">如果是 64 位的系统，就要进入 startup_64 函数，切换到 CPU 到长模式，最后调用 extract_kernel 函数解压 Linux 内核，并进入内核的 startup_64 函数，由此 Linux 内核开始运行。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13025" id="sr-toc-2"><span data-slate-object="text" data-key="13026"><span data-slate-leaf="true" data-offset-key="13026:0" data-first-offset="true"><span data-slate-string="true">为何要从 _start 开始</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13027"><span data-slate-object="text" data-key="13028"><span data-slate-leaf="true" data-offset-key="13028:0" data-first-offset="true"><span data-slate-string="true">通过上节课对 vmlinuz 文件结构的研究，我们已经搞清楚了其中的 vmlinux.bin 是如何产生的，它是由 linux/arch/x86/boot/compressed 目录下的一些目标文件，以及 piggy.S 包含的一个 vmlinux.bin.gz 的压缩文件一起生成的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13029"><span data-slate-object="text" data-key="13030"><span data-slate-leaf="true" data-offset-key="13030:0" data-first-offset="true"><span data-slate-string="true">vmlinux.bin.gz 文件则是由编译的 Linux 内核所生成的 elf 格式的 vmlinux 文件，去掉了文件的符号信息和重定位信息后，压缩得到的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13031"><span data-slate-object="text" data-key="13032"><span data-slate-leaf="true" data-offset-key="13032:0" data-first-offset="true"><span data-slate-string="true">CPU 是无法识别压缩文件中的指令直接运行的，必须先进行解压后，然后解析 elf 格式的文件，把其中的指令段和数据段加载到指定的内存空间中，才能由 CPU 执行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13033"><span data-slate-object="text" data-key="13034"><span data-slate-leaf="true" data-offset-key="13034:0" data-first-offset="true"><span data-slate-string="true">这就需要用到前面的 setup.bin 文件了，_start 正是 setup.bin 文件的入口，在 head.S 文件中定义，代码如下。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13035"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13036"><span data-slate-object="text" data-key="13037"><span data-slate-leaf="true" data-offset-key="13037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#linux/arch/x86/boot/head.S</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13038"><span data-slate-object="text" data-key="13039"><span data-slate-leaf="true" data-offset-key="13039:0" data-first-offset="true"><span data-slate-string="true">  .code16</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13040"><span data-slate-object="text" data-key="13041"><span data-slate-leaf="true" data-offset-key="13041:0" data-first-offset="true"><span data-slate-string="true">  .section </span></span></span><span data-slate-object="text" data-key="13042"><span data-slate-leaf="true" data-offset-key="13042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">".bstext"</span></span></span></span><span data-slate-object="text" data-key="13043"><span data-slate-leaf="true" data-offset-key="13043:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13044"><span data-slate-leaf="true" data-offset-key="13044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ax"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13045"><span data-slate-object="text" data-key="13046"><span data-slate-leaf="true" data-offset-key="13046:0" data-first-offset="true"><span data-slate-string="true">  .global bootsect_start</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13047"><span data-slate-object="text" data-key="13048"><span data-slate-leaf="true" data-offset-key="13048:0" data-first-offset="true"><span data-slate-string="true">bootsect_start:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13049"><span data-slate-object="text" data-key="13050"><span data-slate-leaf="true" data-offset-key="13050:0" data-first-offset="true"><span data-slate-string="true">  ljmp  </span></span></span><span data-slate-object="text" data-key="13051"><span data-slate-leaf="true" data-offset-key="13051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$BOOTSEG</span></span></span></span><span data-slate-object="text" data-key="13052"><span data-slate-leaf="true" data-offset-key="13052:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13053"><span data-slate-leaf="true" data-offset-key="13053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$start2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13054"><span data-slate-object="text" data-key="13055"><span data-slate-leaf="true" data-offset-key="13055:0" data-first-offset="true"><span data-slate-string="true">start2:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13056"><span data-slate-object="text" data-key="13057"><span data-slate-leaf="true" data-offset-key="13057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13058"><span data-slate-object="text" data-key="13059"><span data-slate-leaf="true" data-offset-key="13059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#这里的 512 字段 bootsector 对于硬盘启动是用不到的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13060"><span data-slate-object="text" data-key="13061"><span data-slate-leaf="true" data-offset-key="13061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13062"><span data-slate-object="text" data-key="13063"><span data-slate-leaf="true" data-offset-key="13063:0" data-first-offset="true"><span data-slate-string="true">  .globl  _start</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13064"><span data-slate-object="text" data-key="13065"><span data-slate-leaf="true" data-offset-key="13065:0" data-first-offset="true"><span data-slate-string="true">_start:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13066"><span data-slate-object="text" data-key="13067"><span data-slate-leaf="true" data-offset-key="13067:0" data-first-offset="true"><span data-slate-string="true">    .byte  0xeb    </span></span></span><span data-slate-object="text" data-key="13068"><span data-slate-leaf="true" data-offset-key="13068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># short (2-byte) jump</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13069"><span data-slate-object="text" data-key="13070"><span data-slate-leaf="true" data-offset-key="13070:0" data-first-offset="true"><span data-slate-string="true">    .byte  start_of_setup-1f </span></span></span><span data-slate-object="text" data-key="13071"><span data-slate-leaf="true" data-offset-key="13071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#这指令是用. byte 定义出来的，跳转 start_of_setup-1f</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13072"><span data-slate-object="text" data-key="13073"><span data-slate-leaf="true" data-offset-key="13073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13074"><span data-slate-object="text" data-key="13075"><span data-slate-leaf="true" data-offset-key="13075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#这里是一个庞大的数据结构，没展示出来，与 linux/arch/x86/include/uapi/asm/bootparam.h 文件中的 struct setup_header 一一对应。这个数据结构定义了启动时所需的默认参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13076"><span data-slate-object="text" data-key="13077"><span data-slate-leaf="true" data-offset-key="13077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13078"><span data-slate-object="text" data-key="13079"><span data-slate-leaf="true" data-offset-key="13079:0" data-first-offset="true"><span data-slate-string="true">start_of_setup:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13080"><span data-slate-object="text" data-key="13081"><span data-slate-leaf="true" data-offset-key="13081:0" data-first-offset="true"><span data-slate-string="true">  movw  %ds, %ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13082"><span data-slate-object="text" data-key="13083"><span data-slate-leaf="true" data-offset-key="13083:0" data-first-offset="true"><span data-slate-string="true">  movw  %ax, %es   </span></span></span><span data-slate-object="text" data-key="13084"><span data-slate-leaf="true" data-offset-key="13084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#ds = es</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13085"><span data-slate-object="text" data-key="13086"><span data-slate-leaf="true" data-offset-key="13086:0" data-first-offset="true"><span data-slate-string="true">  cld               </span></span></span><span data-slate-object="text" data-key="13087"><span data-slate-leaf="true" data-offset-key="13087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#主要指定 si、di 寄存器的自增方向，即 si++ di++</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13088"></div><div data-slate-type="code-line" data-slate-object="block" data-key="13089"><span data-slate-object="text" data-key="13090"><span data-slate-leaf="true" data-offset-key="13090:0" data-first-offset="true"><span data-slate-string="true">  movw  %ss, %dx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13091"><span data-slate-object="text" data-key="13092"><span data-slate-leaf="true" data-offset-key="13092:0" data-first-offset="true"><span data-slate-string="true">  cmpw  %ax, %dx  </span></span></span><span data-slate-object="text" data-key="13093"><span data-slate-leaf="true" data-offset-key="13093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># ds 是否等于 ss</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13094"><span data-slate-object="text" data-key="13095"><span data-slate-leaf="true" data-offset-key="13095:0" data-first-offset="true"><span data-slate-string="true">  movw  %sp, %dx     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13096"><span data-slate-object="text" data-key="13097"><span data-slate-leaf="true" data-offset-key="13097:0" data-first-offset="true"><span data-slate-string="true">  je  2f    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13098"><span data-slate-object="text" data-key="13099"><span data-slate-leaf="true" data-offset-key="13099:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13100"><span data-slate-leaf="true" data-offset-key="13100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 如果 ss 为空则建立新栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13101"><span data-slate-object="text" data-key="13102"><span data-slate-leaf="true" data-offset-key="13102:0" data-first-offset="true"><span data-slate-string="true">  movw  </span></span></span><span data-slate-object="text" data-key="13103"><span data-slate-leaf="true" data-offset-key="13103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$_end</span></span></span></span><span data-slate-object="text" data-key="13104"><span data-slate-leaf="true" data-offset-key="13104:0" data-first-offset="true"><span data-slate-string="true">, %dx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13105"><span data-slate-object="text" data-key="13106"><span data-slate-leaf="true" data-offset-key="13106:0" data-first-offset="true"><span data-slate-string="true">  testb  </span></span></span><span data-slate-object="text" data-key="13107"><span data-slate-leaf="true" data-offset-key="13107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$CAN_USE_HEAP</span></span></span></span><span data-slate-object="text" data-key="13108"><span data-slate-leaf="true" data-offset-key="13108:0" data-first-offset="true"><span data-slate-string="true">, loadflags</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13109"><span data-slate-object="text" data-key="13110"><span data-slate-leaf="true" data-offset-key="13110:0" data-first-offset="true"><span data-slate-string="true">  jz  1f</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13111"><span data-slate-object="text" data-key="13112"><span data-slate-leaf="true" data-offset-key="13112:0" data-first-offset="true"><span data-slate-string="true">  movw  heap_end_ptr, %dx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13113"><span data-slate-object="text" data-key="13114"><span data-slate-leaf="true" data-offset-key="13114:0" data-first-offset="true"><span data-slate-string="true">1:  addw  </span></span></span><span data-slate-object="text" data-key="13115"><span data-slate-leaf="true" data-offset-key="13115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$STACK_SIZE</span></span></span></span><span data-slate-object="text" data-key="13116"><span data-slate-leaf="true" data-offset-key="13116:0" data-first-offset="true"><span data-slate-string="true">, %dx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13117"><span data-slate-object="text" data-key="13118"><span data-slate-leaf="true" data-offset-key="13118:0" data-first-offset="true"><span data-slate-string="true">  jnc  2f</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13119"><span data-slate-object="text" data-key="13120"><span data-slate-leaf="true" data-offset-key="13120:0" data-first-offset="true"><span data-slate-string="true">  xorw  %dx, %dx  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13121"><span data-slate-object="text" data-key="13122"><span data-slate-leaf="true" data-offset-key="13122:0" data-first-offset="true"><span data-slate-string="true">2:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13123"><span data-slate-object="text" data-key="13124"><span data-slate-leaf="true" data-offset-key="13124:0" data-first-offset="true"><span data-slate-string="true">  andw  $~3, %dx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13125"><span data-slate-object="text" data-key="13126"><span data-slate-leaf="true" data-offset-key="13126:0" data-first-offset="true"><span data-slate-string="true">  jnz  3f</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13127"><span data-slate-object="text" data-key="13128"><span data-slate-leaf="true" data-offset-key="13128:0" data-first-offset="true"><span data-slate-string="true">  movw  </span></span></span><span data-slate-object="text" data-key="13129"><span data-slate-leaf="true" data-offset-key="13129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0xfffc</span></span></span></span><span data-slate-object="text" data-key="13130"><span data-slate-leaf="true" data-offset-key="13130:0" data-first-offset="true"><span data-slate-string="true">, %dx  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13131"><span data-slate-object="text" data-key="13132"><span data-slate-leaf="true" data-offset-key="13132:0" data-first-offset="true"><span data-slate-string="true">3:  movw  %ax, %ss</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13133"><span data-slate-object="text" data-key="13134"><span data-slate-leaf="true" data-offset-key="13134:0" data-first-offset="true"><span data-slate-string="true">  movzwl  %dx, %esp  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13135"><span data-slate-object="text" data-key="13136"><span data-slate-leaf="true" data-offset-key="13136:0" data-first-offset="true"><span data-slate-string="true">  sti      </span></span></span><span data-slate-object="text" data-key="13137"><span data-slate-leaf="true" data-offset-key="13137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 栈已经初始化好，开中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13138"><span data-slate-object="text" data-key="13139"><span data-slate-leaf="true" data-offset-key="13139:0" data-first-offset="true"><span data-slate-string="true">  pushw  %ds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13140"><span data-slate-object="text" data-key="13141"><span data-slate-leaf="true" data-offset-key="13141:0" data-first-offset="true"><span data-slate-string="true">  pushw  </span></span></span><span data-slate-object="text" data-key="13142"><span data-slate-leaf="true" data-offset-key="13142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$6f</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13143"><span data-slate-object="text" data-key="13144"><span data-slate-leaf="true" data-offset-key="13144:0" data-first-offset="true"><span data-slate-string="true">  lretw      </span></span></span><span data-slate-object="text" data-key="13145"><span data-slate-leaf="true" data-offset-key="13145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># cs=ds ip=6：跳转到标号 6 处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13146"><span data-slate-object="text" data-key="13147"><span data-slate-leaf="true" data-offset-key="13147:0" data-first-offset="true"><span data-slate-string="true">6:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13148"><span data-slate-object="text" data-key="13149"><span data-slate-leaf="true" data-offset-key="13149:0" data-first-offset="true"><span data-slate-string="true">  cmpl  </span></span></span><span data-slate-object="text" data-key="13150"><span data-slate-leaf="true" data-offset-key="13150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0x5a5aaa55</span></span></span></span><span data-slate-object="text" data-key="13151"><span data-slate-leaf="true" data-offset-key="13151:0" data-first-offset="true"><span data-slate-string="true">, setup_sig </span></span></span><span data-slate-object="text" data-key="13152"><span data-slate-leaf="true" data-offset-key="13152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#检查 setup 标记</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13153"><span data-slate-object="text" data-key="13154"><span data-slate-leaf="true" data-offset-key="13154:0" data-first-offset="true"><span data-slate-string="true">  jne  setup_bad</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13155"><span data-slate-object="text" data-key="13156"><span data-slate-leaf="true" data-offset-key="13156:0" data-first-offset="true"><span data-slate-string="true">  movw  </span></span></span><span data-slate-object="text" data-key="13157"><span data-slate-leaf="true" data-offset-key="13157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$__bss_start</span></span></span></span><span data-slate-object="text" data-key="13158"><span data-slate-leaf="true" data-offset-key="13158:0" data-first-offset="true"><span data-slate-string="true">, %di</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13159"><span data-slate-object="text" data-key="13160"><span data-slate-leaf="true" data-offset-key="13160:0" data-first-offset="true"><span data-slate-string="true">  movw  </span></span></span><span data-slate-object="text" data-key="13161"><span data-slate-leaf="true" data-offset-key="13161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$_end</span></span></span></span><span data-slate-object="text" data-key="13162"><span data-slate-leaf="true" data-offset-key="13162:0" data-first-offset="true"><span data-slate-string="true">+3, %cx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13163"><span data-slate-object="text" data-key="13164"><span data-slate-leaf="true" data-offset-key="13164:0" data-first-offset="true"><span data-slate-string="true">  xorl  %eax, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13165"><span data-slate-object="text" data-key="13166"><span data-slate-leaf="true" data-offset-key="13166:0" data-first-offset="true"><span data-slate-string="true">  subw  %di, %cx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13167"><span data-slate-object="text" data-key="13168"><span data-slate-leaf="true" data-offset-key="13168:0" data-first-offset="true"><span data-slate-string="true">  shrw  </span></span></span><span data-slate-object="text" data-key="13169"><span data-slate-leaf="true" data-offset-key="13169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$2</span></span></span></span><span data-slate-object="text" data-key="13170"><span data-slate-leaf="true" data-offset-key="13170:0" data-first-offset="true"><span data-slate-string="true">, %cx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13171"><span data-slate-object="text" data-key="13172"><span data-slate-leaf="true" data-offset-key="13172:0" data-first-offset="true"><span data-slate-string="true">  rep; stosl          </span></span></span><span data-slate-object="text" data-key="13173"><span data-slate-leaf="true" data-offset-key="13173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#清空 setup 程序的 bss 段</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13174"><span data-slate-object="text" data-key="13175"><span data-slate-leaf="true" data-offset-key="13175:0" data-first-offset="true"><span data-slate-string="true">  calll  main  </span></span></span><span data-slate-object="text" data-key="13176"><span data-slate-leaf="true" data-offset-key="13176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#调用 C 语言 main 函数 </span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13177" id="sr-toc-3"><span data-slate-object="text" data-key="13178"><span data-slate-leaf="true" data-offset-key="13178:0" data-first-offset="true"><span data-slate-string="true">setup_header 结构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13179"><span data-slate-object="text" data-key="13180"><span data-slate-leaf="true" data-offset-key="13180:0" data-first-offset="true"><span data-slate-string="true">下面我们重点研究一下 setup_header 结构，这对我们后面的流程很关键。它定义在 linux/arch/x86/include/uapi/asm/bootparam.h 文件中，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="13181"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13182"><span data-slate-object="text" data-key="13183"><span data-slate-leaf="true" data-offset-key="13183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="13184"><span data-slate-leaf="true" data-offset-key="13184:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13185"><span data-slate-leaf="true" data-offset-key="13185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">setup_header</span></span></span></span><span data-slate-object="text" data-key="13186"><span data-slate-leaf="true" data-offset-key="13186:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13187"><span data-slate-object="text" data-key="13188"><span data-slate-leaf="true" data-offset-key="13188:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13189"><span data-slate-leaf="true" data-offset-key="13189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8</span></span></span></span><span data-slate-object="text" data-key="13190"><span data-slate-leaf="true" data-offset-key="13190:0" data-first-offset="true"><span data-slate-string="true">    setup_sects;        </span></span></span><span data-slate-object="text" data-key="13191"><span data-slate-leaf="true" data-offset-key="13191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//setup 大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13192"><span data-slate-object="text" data-key="13193"><span data-slate-leaf="true" data-offset-key="13193:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13194"><span data-slate-leaf="true" data-offset-key="13194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13195"><span data-slate-leaf="true" data-offset-key="13195:0" data-first-offset="true"><span data-slate-string="true">   root_flags;         </span></span></span><span data-slate-object="text" data-key="13196"><span data-slate-leaf="true" data-offset-key="13196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根标志   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13197"><span data-slate-object="text" data-key="13198"><span data-slate-leaf="true" data-offset-key="13198:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13199"><span data-slate-leaf="true" data-offset-key="13199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="13200"><span data-slate-leaf="true" data-offset-key="13200:0" data-first-offset="true"><span data-slate-string="true">   syssize;            </span></span></span><span data-slate-object="text" data-key="13201"><span data-slate-leaf="true" data-offset-key="13201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 系统文件大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13202"><span data-slate-object="text" data-key="13203"><span data-slate-leaf="true" data-offset-key="13203:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13204"><span data-slate-leaf="true" data-offset-key="13204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13205"><span data-slate-leaf="true" data-offset-key="13205:0" data-first-offset="true"><span data-slate-string="true">   ram_size;           </span></span></span><span data-slate-object="text" data-key="13206"><span data-slate-leaf="true" data-offset-key="13206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13207"><span data-slate-object="text" data-key="13208"><span data-slate-leaf="true" data-offset-key="13208:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13209"><span data-slate-leaf="true" data-offset-key="13209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13210"><span data-slate-leaf="true" data-offset-key="13210:0" data-first-offset="true"><span data-slate-string="true">   vid_mode;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13211"><span data-slate-object="text" data-key="13212"><span data-slate-leaf="true" data-offset-key="13212:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13213"><span data-slate-leaf="true" data-offset-key="13213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13214"><span data-slate-leaf="true" data-offset-key="13214:0" data-first-offset="true"><span data-slate-string="true">   root_dev;           </span></span></span><span data-slate-object="text" data-key="13215"><span data-slate-leaf="true" data-offset-key="13215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根设备号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13216"><span data-slate-object="text" data-key="13217"><span data-slate-leaf="true" data-offset-key="13217:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13218"><span data-slate-leaf="true" data-offset-key="13218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13219"><span data-slate-leaf="true" data-offset-key="13219:0" data-first-offset="true"><span data-slate-string="true">   boot_flag;          </span></span></span><span data-slate-object="text" data-key="13220"><span data-slate-leaf="true" data-offset-key="13220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 引导标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13221"><span data-slate-object="text" data-key="13222"><span data-slate-leaf="true" data-offset-key="13222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13223"><span data-slate-object="text" data-key="13224"><span data-slate-leaf="true" data-offset-key="13224:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13225"><span data-slate-leaf="true" data-offset-key="13225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="13226"><span data-slate-leaf="true" data-offset-key="13226:0" data-first-offset="true"><span data-slate-string="true">   realmode_swtch;     </span></span></span><span data-slate-object="text" data-key="13227"><span data-slate-leaf="true" data-offset-key="13227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 切换回实模式的函数地址     </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13228"><span data-slate-object="text" data-key="13229"><span data-slate-leaf="true" data-offset-key="13229:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13230"><span data-slate-leaf="true" data-offset-key="13230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13231"><span data-slate-leaf="true" data-offset-key="13231:0" data-first-offset="true"><span data-slate-string="true">   start_sys_seg;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13232"><span data-slate-object="text" data-key="13233"><span data-slate-leaf="true" data-offset-key="13233:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13234"><span data-slate-leaf="true" data-offset-key="13234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13235"><span data-slate-leaf="true" data-offset-key="13235:0" data-first-offset="true"><span data-slate-string="true">   kernel_version;     </span></span></span><span data-slate-object="text" data-key="13236"><span data-slate-leaf="true" data-offset-key="13236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内核版本    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13237"><span data-slate-object="text" data-key="13238"><span data-slate-leaf="true" data-offset-key="13238:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13239"><span data-slate-leaf="true" data-offset-key="13239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8</span></span></span></span><span data-slate-object="text" data-key="13240"><span data-slate-leaf="true" data-offset-key="13240:0" data-first-offset="true"><span data-slate-string="true">    type_of_loader;     </span></span></span><span data-slate-object="text" data-key="13241"><span data-slate-leaf="true" data-offset-key="13241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 引导器类型 我们这里是 GRUB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13242"><span data-slate-object="text" data-key="13243"><span data-slate-leaf="true" data-offset-key="13243:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13244"><span data-slate-leaf="true" data-offset-key="13244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8</span></span></span></span><span data-slate-object="text" data-key="13245"><span data-slate-leaf="true" data-offset-key="13245:0" data-first-offset="true"><span data-slate-string="true">    loadflags;          </span></span></span><span data-slate-object="text" data-key="13246"><span data-slate-leaf="true" data-offset-key="13246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加载内核的标志 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13247"><span data-slate-object="text" data-key="13248"><span data-slate-leaf="true" data-offset-key="13248:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13249"><span data-slate-leaf="true" data-offset-key="13249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16</span></span></span></span><span data-slate-object="text" data-key="13250"><span data-slate-leaf="true" data-offset-key="13250:0" data-first-offset="true"><span data-slate-string="true">   setup_move_size;    </span></span></span><span data-slate-object="text" data-key="13251"><span data-slate-leaf="true" data-offset-key="13251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 移动 setup 的大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13252"><span data-slate-object="text" data-key="13253"><span data-slate-leaf="true" data-offset-key="13253:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13254"><span data-slate-leaf="true" data-offset-key="13254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="13255"><span data-slate-leaf="true" data-offset-key="13255:0" data-first-offset="true"><span data-slate-string="true">   code32_start;       </span></span></span><span data-slate-object="text" data-key="13256"><span data-slate-leaf="true" data-offset-key="13256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将要跳转到 32 位模式下的地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13257"><span data-slate-object="text" data-key="13258"><span data-slate-leaf="true" data-offset-key="13258:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13259"><span data-slate-leaf="true" data-offset-key="13259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="13260"><span data-slate-leaf="true" data-offset-key="13260:0" data-first-offset="true"><span data-slate-string="true">   ramdisk_image;      </span></span></span><span data-slate-object="text" data-key="13261"><span data-slate-leaf="true" data-offset-key="13261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化内存盘映像地址，里面有内核驱动模块 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13262"><span data-slate-object="text" data-key="13263"><span data-slate-leaf="true" data-offset-key="13263:0" data-first-offset="true"><span data-slate-string="true">__</span></span></span><span data-slate-object="text" data-key="13264"><span data-slate-leaf="true" data-offset-key="13264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="13265"><span data-slate-leaf="true" data-offset-key="13265:0" data-first-offset="true"><span data-slate-string="true">   ramdisk_size;       </span></span></span><span data-slate-object="text" data-key="13266"><span data-slate-leaf="true" data-offset-key="13266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化内存盘映像大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13267"><span data-slate-object="text" data-key="13268"><span data-slate-leaf="true" data-offset-key="13268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13269"><span data-slate-object="text" data-key="13270"><span data-slate-leaf="true" data-offset-key="13270:0" data-first-offset="true"><span data-slate-string="true">} __attribute__((packed));</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13271"><span data-slate-object="text" data-key="13272"><span data-slate-leaf="true" data-offset-key="13272:0" data-first-offset="true"><span data-slate-string="true">前面提到过，硬盘中 MBR 是由 GRUB 写入的 boot.img，因此这里的 linux/arch/x86/boot/head.S 中的 bootsector 对于硬盘启动是无用的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13273"><span data-slate-object="text" data-key="13274"><span data-slate-leaf="true" data-offset-key="13274:0" data-first-offset="true"><span data-slate-string="true">GRUB 将 vmlinuz 的 setup.bin 部分读到内存地址 0x90000 处，然后跳转到 0x90200 开始执行，恰好跳过了前面 512 字节的 bootsector，从 _start 开始。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13275" id="sr-toc-4"><span data-slate-object="text" data-key="13276"><span data-slate-leaf="true" data-offset-key="13276:0" data-first-offset="true"><span data-slate-string="true">16 位的 main 函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13277"><span data-slate-object="text" data-key="13278"><span data-slate-leaf="true" data-offset-key="13278:0" data-first-offset="true"><span data-slate-string="true">我们通常用 C 编译器编译的代码，是 32 位保护模式下的或者是 64 位长模式的，却很少编译成 16 位实模式下的，其实 setup.bin 大部分代码都是 16 位实模式下的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13279"><span data-slate-object="text" data-key="13280"><span data-slate-leaf="true" data-offset-key="13280:0" data-first-offset="true"><span data-slate-string="true">从前面的代码里，我们能够看到在 linux/arch/x86/boot/head.S 中调用了 main 函数，该函数在 linux/arch/x86/boot/main.c 文件中，代码如下 。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13281"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13282"><span data-slate-object="text" data-key="13283"><span data-slate-leaf="true" data-offset-key="13283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义 boot_params 变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13284"><span data-slate-object="text" data-key="13285"><span data-slate-leaf="true" data-offset-key="13285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="13286"><span data-slate-leaf="true" data-offset-key="13286:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13287"><span data-slate-leaf="true" data-offset-key="13287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">boot_params</span></span></span></span><span data-slate-object="text" data-key="13288"><span data-slate-leaf="true" data-offset-key="13288:0" data-first-offset="true"><span data-slate-string="true"> boot_params __attribute__((</span></span></span><span data-slate-object="text" data-key="13289"><span data-slate-leaf="true" data-offset-key="13289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">aligned</span></span></span></span><span data-slate-object="text" data-key="13290"><span data-slate-leaf="true" data-offset-key="13290:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13291"><span data-slate-leaf="true" data-offset-key="13291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="13292"><span data-slate-leaf="true" data-offset-key="13292:0" data-first-offset="true"><span data-slate-string="true">)));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13293"><span data-slate-object="text" data-key="13294"><span data-slate-leaf="true" data-offset-key="13294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="13295"><span data-slate-leaf="true" data-offset-key="13295:0" data-first-offset="true"><span data-slate-string="true"> *HEAP = _end;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13296"><span data-slate-object="text" data-key="13297"><span data-slate-leaf="true" data-offset-key="13297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="13298"><span data-slate-leaf="true" data-offset-key="13298:0" data-first-offset="true"><span data-slate-string="true"> *heap_end = _end; </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13299"><span data-slate-object="text" data-key="13300"><span data-slate-leaf="true" data-offset-key="13300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13301"><span data-slate-object="text" data-key="13302"><span data-slate-leaf="true" data-offset-key="13302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="13303"><span data-slate-leaf="true" data-offset-key="13303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13304"><span data-slate-leaf="true" data-offset-key="13304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="13305"><span data-slate-leaf="true" data-offset-key="13305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="13306"><span data-slate-leaf="true" data-offset-key="13306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="13307"><span data-slate-leaf="true" data-offset-key="13307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="13308"><span data-slate-leaf="true" data-offset-key="13308:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13309"><span data-slate-object="text" data-key="13310"><span data-slate-leaf="true" data-offset-key="13310:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13311"><span data-slate-leaf="true" data-offset-key="13311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把先前 setup_header 结构复制到 boot_params 结构中的 hdr 变量中，在 linux/arch/x86/include/uapi/asm/bootparam.h 文件中你会发现 boot_params 结构中的 hdr 的类型正是 setup_header 结构  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13312"><span data-slate-object="text" data-key="13313"><span data-slate-leaf="true" data-offset-key="13313:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13314"><span data-slate-leaf="true" data-offset-key="13314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy_boot_params</span></span></span></span><span data-slate-object="text" data-key="13315"><span data-slate-leaf="true" data-offset-key="13315:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13316"><span data-slate-object="text" data-key="13317"><span data-slate-leaf="true" data-offset-key="13317:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13318"><span data-slate-leaf="true" data-offset-key="13318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化早期引导所用的 console    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13319"><span data-slate-object="text" data-key="13320"><span data-slate-leaf="true" data-offset-key="13320:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13321"><span data-slate-leaf="true" data-offset-key="13321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">console_init</span></span></span></span><span data-slate-object="text" data-key="13322"><span data-slate-leaf="true" data-offset-key="13322:0" data-first-offset="true"><span data-slate-string="true">();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13323"><span data-slate-object="text" data-key="13324"><span data-slate-leaf="true" data-offset-key="13324:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13325"><span data-slate-leaf="true" data-offset-key="13325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化堆 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13326"><span data-slate-object="text" data-key="13327"><span data-slate-leaf="true" data-offset-key="13327:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13328"><span data-slate-leaf="true" data-offset-key="13328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_heap</span></span></span></span><span data-slate-object="text" data-key="13329"><span data-slate-leaf="true" data-offset-key="13329:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13330"><span data-slate-object="text" data-key="13331"><span data-slate-leaf="true" data-offset-key="13331:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13332"><span data-slate-leaf="true" data-offset-key="13332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查 CPU 是否支持运行 Linux    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13333"><span data-slate-object="text" data-key="13334"><span data-slate-leaf="true" data-offset-key="13334:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13335"><span data-slate-leaf="true" data-offset-key="13335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13336"><span data-slate-leaf="true" data-offset-key="13336:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="13337"><span data-slate-leaf="true" data-offset-key="13337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">validate_cpu</span></span></span></span><span data-slate-object="text" data-key="13338"><span data-slate-leaf="true" data-offset-key="13338:0" data-first-offset="true"><span data-slate-string="true">()) {        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13339"><span data-slate-object="text" data-key="13340"><span data-slate-leaf="true" data-offset-key="13340:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13341"><span data-slate-leaf="true" data-offset-key="13341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">puts</span></span></span></span><span data-slate-object="text" data-key="13342"><span data-slate-leaf="true" data-offset-key="13342:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13343"><span data-slate-leaf="true" data-offset-key="13343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Unable to boot - please use a kernel appropriate"</span></span></span></span><span data-slate-object="text" data-key="13344"><span data-slate-leaf="true" data-offset-key="13344:0" data-first-offset="true"><span data-slate-string="true">             </span></span></span><span data-slate-object="text" data-key="13345"><span data-slate-leaf="true" data-offset-key="13345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"for your CPU.\n"</span></span></span></span><span data-slate-object="text" data-key="13346"><span data-slate-leaf="true" data-offset-key="13346:0" data-first-offset="true"><span data-slate-string="true">);        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13347"><span data-slate-object="text" data-key="13348"><span data-slate-leaf="true" data-offset-key="13348:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13349"><span data-slate-leaf="true" data-offset-key="13349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">die</span></span></span></span><span data-slate-object="text" data-key="13350"><span data-slate-leaf="true" data-offset-key="13350:0" data-first-offset="true"><span data-slate-string="true">();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13351"><span data-slate-object="text" data-key="13352"><span data-slate-leaf="true" data-offset-key="13352:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13353"><span data-slate-object="text" data-key="13354"><span data-slate-leaf="true" data-offset-key="13354:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13355"><span data-slate-leaf="true" data-offset-key="13355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 告诉 BIOS 我们打算在什么 CPU 模式下运行它</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13356"><span data-slate-object="text" data-key="13357"><span data-slate-leaf="true" data-offset-key="13357:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13358"><span data-slate-leaf="true" data-offset-key="13358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_bios_mode</span></span></span></span><span data-slate-object="text" data-key="13359"><span data-slate-leaf="true" data-offset-key="13359:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13360"><span data-slate-object="text" data-key="13361"><span data-slate-leaf="true" data-offset-key="13361:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13362"><span data-slate-leaf="true" data-offset-key="13362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查看物理内存空间布局    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13363"><span data-slate-object="text" data-key="13364"><span data-slate-leaf="true" data-offset-key="13364:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13365"><span data-slate-leaf="true" data-offset-key="13365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">detect_memory</span></span></span></span><span data-slate-object="text" data-key="13366"><span data-slate-leaf="true" data-offset-key="13366:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13367"><span data-slate-object="text" data-key="13368"><span data-slate-leaf="true" data-offset-key="13368:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13369"><span data-slate-leaf="true" data-offset-key="13369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化键盘</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13370"><span data-slate-object="text" data-key="13371"><span data-slate-leaf="true" data-offset-key="13371:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13372"><span data-slate-leaf="true" data-offset-key="13372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">keyboard_init</span></span></span></span><span data-slate-object="text" data-key="13373"><span data-slate-leaf="true" data-offset-key="13373:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13374"><span data-slate-object="text" data-key="13375"><span data-slate-leaf="true" data-offset-key="13375:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13376"><span data-slate-leaf="true" data-offset-key="13376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查询 Intel 的 (IST) 信息。    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13377"><span data-slate-object="text" data-key="13378"><span data-slate-leaf="true" data-offset-key="13378:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13379"><span data-slate-leaf="true" data-offset-key="13379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">query_ist</span></span></span></span><span data-slate-object="text" data-key="13380"><span data-slate-leaf="true" data-offset-key="13380:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13381"><span data-slate-object="text" data-key="13382"><span data-slate-leaf="true" data-offset-key="13382:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13383"><span data-slate-leaf="true" data-offset-key="13383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 查询 APM BIOS 电源管理信息。*/</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13384"><span data-slate-object="text" data-key="13385"><span data-slate-leaf="true" data-offset-key="13385:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13386"><span data-slate-leaf="true" data-offset-key="13386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13387"><span data-slate-leaf="true" data-offset-key="13387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span></span><span data-slate-object="text" data-key="13388"><span data-slate-leaf="true" data-offset-key="13388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> defined(CONFIG_APM) || defined(CONFIG_APM_MODULE)   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13389"><span data-slate-object="text" data-key="13390"><span data-slate-leaf="true" data-offset-key="13390:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13391"><span data-slate-leaf="true" data-offset-key="13391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">query_apm_bios</span></span></span></span><span data-slate-object="text" data-key="13392"><span data-slate-leaf="true" data-offset-key="13392:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13393"><span data-slate-object="text" data-key="13394"><span data-slate-leaf="true" data-offset-key="13394:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13395"><span data-slate-leaf="true" data-offset-key="13395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13396"><span data-slate-leaf="true" data-offset-key="13396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13397"><span data-slate-object="text" data-key="13398"><span data-slate-leaf="true" data-offset-key="13398:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13399"><span data-slate-leaf="true" data-offset-key="13399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查询 EDD BIOS 扩展数据区域的信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13400"><span data-slate-object="text" data-key="13401"><span data-slate-leaf="true" data-offset-key="13401:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13402"><span data-slate-leaf="true" data-offset-key="13402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13403"><span data-slate-leaf="true" data-offset-key="13403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span></span><span data-slate-object="text" data-key="13404"><span data-slate-leaf="true" data-offset-key="13404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> defined(CONFIG_EDD) || defined(CONFIG_EDD_MODULE) </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13405"><span data-slate-object="text" data-key="13406"><span data-slate-leaf="true" data-offset-key="13406:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13407"><span data-slate-leaf="true" data-offset-key="13407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">query_edd</span></span></span></span><span data-slate-object="text" data-key="13408"><span data-slate-leaf="true" data-offset-key="13408:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13409"><span data-slate-object="text" data-key="13410"><span data-slate-leaf="true" data-offset-key="13410:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13411"><span data-slate-leaf="true" data-offset-key="13411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13412"><span data-slate-leaf="true" data-offset-key="13412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13413"><span data-slate-object="text" data-key="13414"><span data-slate-leaf="true" data-offset-key="13414:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13415"><span data-slate-leaf="true" data-offset-key="13415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置显卡的图形模式    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13416"><span data-slate-object="text" data-key="13417"><span data-slate-leaf="true" data-offset-key="13417:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13418"><span data-slate-leaf="true" data-offset-key="13418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_video</span></span></span></span><span data-slate-object="text" data-key="13419"><span data-slate-leaf="true" data-offset-key="13419:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13420"><span data-slate-object="text" data-key="13421"><span data-slate-leaf="true" data-offset-key="13421:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13422"><span data-slate-leaf="true" data-offset-key="13422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进入 CPU 保护模式，不会返回了       </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13423"><span data-slate-object="text" data-key="13424"><span data-slate-leaf="true" data-offset-key="13424:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13425"><span data-slate-leaf="true" data-offset-key="13425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go_to_protected_mode</span></span></span></span><span data-slate-object="text" data-key="13426"><span data-slate-leaf="true" data-offset-key="13426:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13427"><span data-slate-object="text" data-key="13428"><span data-slate-leaf="true" data-offset-key="13428:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13429"><span data-slate-object="text" data-key="13430"><span data-slate-leaf="true" data-offset-key="13430:0" data-first-offset="true"><span data-slate-string="true">上面这些函数都在 linux/arch/x86/boot/ 目录对应的文件中，都是调用 BIOS 中断完成的，具体细节，你可以自行查看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13431"><span data-slate-object="text" data-key="13432"><span data-slate-leaf="true" data-offset-key="13432:0" data-first-offset="true"><span data-slate-string="true">我这里列出的代码只是帮助你理清流程，我们继续看看 go_to_protected_mode () 函数，在 linux/arch/x86/boot/pm.c 中，代码如下。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13433"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13434"><span data-slate-object="text" data-key="13435"><span data-slate-leaf="true" data-offset-key="13435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//linux/arch/x86/boot/pm.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13436"><span data-slate-object="text" data-key="13437"><span data-slate-leaf="true" data-offset-key="13437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="13438"><span data-slate-leaf="true" data-offset-key="13438:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13439"><span data-slate-leaf="true" data-offset-key="13439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go_to_protected_mode</span></span></span></span><span data-slate-object="text" data-key="13440"><span data-slate-leaf="true" data-offset-key="13440:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13441"><span data-slate-leaf="true" data-offset-key="13441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="13442"><span data-slate-leaf="true" data-offset-key="13442:0" data-first-offset="true"><span data-slate-string="true">){    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13443"><span data-slate-object="text" data-key="13444"><span data-slate-leaf="true" data-offset-key="13444:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13445"><span data-slate-leaf="true" data-offset-key="13445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 安装切换实模式的函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13446"><span data-slate-object="text" data-key="13447"><span data-slate-leaf="true" data-offset-key="13447:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13448"><span data-slate-leaf="true" data-offset-key="13448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">realmode_switch_hook</span></span></span></span><span data-slate-object="text" data-key="13449"><span data-slate-leaf="true" data-offset-key="13449:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13450"><span data-slate-object="text" data-key="13451"><span data-slate-leaf="true" data-offset-key="13451:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13452"><span data-slate-leaf="true" data-offset-key="13452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开启 a20 地址线，是为了能访问 1MB 以上的内存空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13453"><span data-slate-object="text" data-key="13454"><span data-slate-leaf="true" data-offset-key="13454:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13455"><span data-slate-leaf="true" data-offset-key="13455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13456"><span data-slate-leaf="true" data-offset-key="13456:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="13457"><span data-slate-leaf="true" data-offset-key="13457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">enable_a20</span></span></span></span><span data-slate-object="text" data-key="13458"><span data-slate-leaf="true" data-offset-key="13458:0" data-first-offset="true"><span data-slate-string="true">()) {        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13459"><span data-slate-object="text" data-key="13460"><span data-slate-leaf="true" data-offset-key="13460:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13461"><span data-slate-leaf="true" data-offset-key="13461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">puts</span></span></span></span><span data-slate-object="text" data-key="13462"><span data-slate-leaf="true" data-offset-key="13462:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13463"><span data-slate-leaf="true" data-offset-key="13463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"A20 gate not responding, unable to boot...\n"</span></span></span></span><span data-slate-object="text" data-key="13464"><span data-slate-leaf="true" data-offset-key="13464:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13465"><span data-slate-object="text" data-key="13466"><span data-slate-leaf="true" data-offset-key="13466:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13467"><span data-slate-leaf="true" data-offset-key="13467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">die</span></span></span></span><span data-slate-object="text" data-key="13468"><span data-slate-leaf="true" data-offset-key="13468:0" data-first-offset="true"><span data-slate-string="true">();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13469"><span data-slate-object="text" data-key="13470"><span data-slate-leaf="true" data-offset-key="13470:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13471"><span data-slate-object="text" data-key="13472"><span data-slate-leaf="true" data-offset-key="13472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13473"><span data-slate-leaf="true" data-offset-key="13473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 重置协处理器，早期 x86 上的浮点运算单元是以协处理器的方式存在的    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13474"><span data-slate-object="text" data-key="13475"><span data-slate-leaf="true" data-offset-key="13475:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13476"><span data-slate-leaf="true" data-offset-key="13476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">reset_coprocessor</span></span></span></span><span data-slate-object="text" data-key="13477"><span data-slate-leaf="true" data-offset-key="13477:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13478"><span data-slate-object="text" data-key="13479"><span data-slate-leaf="true" data-offset-key="13479:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13480"><span data-slate-leaf="true" data-offset-key="13480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 屏蔽 8259 所示的中断源   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13481"><span data-slate-object="text" data-key="13482"><span data-slate-leaf="true" data-offset-key="13482:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13483"><span data-slate-leaf="true" data-offset-key="13483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mask_all_interrupts</span></span></span></span><span data-slate-object="text" data-key="13484"><span data-slate-leaf="true" data-offset-key="13484:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13485"><span data-slate-object="text" data-key="13486"><span data-slate-leaf="true" data-offset-key="13486:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13487"><span data-slate-leaf="true" data-offset-key="13487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 安装中断描述符表和全局描述符表，    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13488"><span data-slate-object="text" data-key="13489"><span data-slate-leaf="true" data-offset-key="13489:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13490"><span data-slate-leaf="true" data-offset-key="13490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">setup_idt</span></span></span></span><span data-slate-object="text" data-key="13491"><span data-slate-leaf="true" data-offset-key="13491:0" data-first-offset="true"><span data-slate-string="true">();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13492"><span data-slate-object="text" data-key="13493"><span data-slate-leaf="true" data-offset-key="13493:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13494"><span data-slate-leaf="true" data-offset-key="13494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">setup_gdt</span></span></span></span><span data-slate-object="text" data-key="13495"><span data-slate-leaf="true" data-offset-key="13495:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13496"><span data-slate-object="text" data-key="13497"><span data-slate-leaf="true" data-offset-key="13497:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13498"><span data-slate-leaf="true" data-offset-key="13498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保护模式下长跳转到 boot_params.hdr.code32_start</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13499"><span data-slate-object="text" data-key="13500"><span data-slate-leaf="true" data-offset-key="13500:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13501"><span data-slate-leaf="true" data-offset-key="13501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected_mode_jump</span></span></span></span><span data-slate-object="text" data-key="13502"><span data-slate-leaf="true" data-offset-key="13502:0" data-first-offset="true"><span data-slate-string="true">(boot_params.</span></span></span><span data-slate-object="text" data-key="13503"><span data-slate-leaf="true" data-offset-key="13503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hdr</span></span></span></span><span data-slate-object="text" data-key="13504"><span data-slate-leaf="true" data-offset-key="13504:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13505"><span data-slate-leaf="true" data-offset-key="13505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">code32_start</span></span></span></span><span data-slate-object="text" data-key="13506"><span data-slate-leaf="true" data-offset-key="13506:0" data-first-offset="true"><span data-slate-string="true">,                (u32)&amp;boot_params + (</span></span></span><span data-slate-object="text" data-key="13507"><span data-slate-leaf="true" data-offset-key="13507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ds</span></span></span></span><span data-slate-object="text" data-key="13508"><span data-slate-leaf="true" data-offset-key="13508:0" data-first-offset="true"><span data-slate-string="true">() &lt;&lt; </span></span></span><span data-slate-object="text" data-key="13509"><span data-slate-leaf="true" data-offset-key="13509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="13510"><span data-slate-leaf="true" data-offset-key="13510:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13511"><span data-slate-object="text" data-key="13512"><span data-slate-leaf="true" data-offset-key="13512:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13513"><span data-slate-object="text" data-key="13514"><span data-slate-leaf="true" data-offset-key="13514:0" data-first-offset="true"><span data-slate-string="true">protected_mode_jump 是个汇编函数，在 linux/arch/x86/boot/pmjump.S 文件中。代码逻辑和我们前面（</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13515"><span data-slate-object="text" data-key="13516"><span data-slate-leaf="true" data-offset-key="13516:0" data-first-offset="true"><span data-slate-string="true">第 5 节课</span></span></span></a><span data-slate-object="text" data-key="13517"><span data-slate-leaf="true" data-offset-key="13517:0" data-first-offset="true"><span data-slate-string="true">）学到的保护模式切换是一样的。只是多了</span></span></span><span data-slate-object="text" data-key="13518"><span data-slate-leaf="true" data-offset-key="13518:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">处理参数的逻辑</span></span></span></span><span data-slate-object="text" data-key="13519"><span data-slate-leaf="true" data-offset-key="13519:0" data-first-offset="true"><span data-slate-string="true">，即跳转到 boot_params.hdr.code32_start 中的地址。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13520"><span data-slate-object="text" data-key="13521"><span data-slate-leaf="true" data-offset-key="13521:0" data-first-offset="true"><span data-slate-string="true">这个地址在 linux/arch/x86/boot/head.S 文件中设为 0x100000，如下所示。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13522"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13523"><span data-slate-object="text" data-key="13524"><span data-slate-leaf="true" data-offset-key="13524:0" data-first-offset="true"><span data-slate-string="true">code32_start:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13525"><span data-slate-object="text" data-key="13526"><span data-slate-leaf="true" data-offset-key="13526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13527"><span data-slate-leaf="true" data-offset-key="13527:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13528"><span data-slate-leaf="true" data-offset-key="13528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x100000</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13529"><span data-slate-object="text" data-key="13530"><span data-slate-leaf="true" data-offset-key="13530:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">需要注意的是，GRUB 会把 vmlinuz 中的 vmlinux.bin 部分，放在 1MB 开始的内存空间中。通过这一跳转，正式进入 vmlinux.bin 中。</span></span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13531" id="sr-toc-5"><span data-slate-object="text" data-key="13532"><span data-slate-leaf="true" data-offset-key="13532:0" data-first-offset="true"><span data-slate-string="true">startup_32 函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13533"><span data-slate-object="text" data-key="13534"><span data-slate-leaf="true" data-offset-key="13534:0" data-first-offset="true"><span data-slate-string="true">startup_32 中需要重新加载段描述符，之后计算 vmlinux.bin 文件的编译生成的地址和实际加载地址的偏移，然后重新设置内核栈，检测 CPU 是否支持长模式，接着再次计算 vmlinux.bin 加载地址的偏移，来确定对其中 vmlinux.bin.gz 解压缩的地址。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13535"><span data-slate-object="text" data-key="13536"><span data-slate-leaf="true" data-offset-key="13536:0" data-first-offset="true"><span data-slate-string="true">如果 CPU 支持长模式的话，就要设置 64 位的全局描述表，开启 CPU 的 PAE 物理地址扩展特性。再设置最初的 MMU 页表，最后开启分页并进入长模式，跳转到 startup_64，代码如下。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13537"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13538"><span data-slate-object="text" data-key="13539"><span data-slate-leaf="true" data-offset-key="13539:0" data-first-offset="true"><span data-slate-string="true">  .code32</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13540"><span data-slate-object="text" data-key="13541"><span data-slate-leaf="true" data-offset-key="13541:0" data-first-offset="true"><span data-slate-string="true">SYM_FUNC_START(startup_32)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13542"><span data-slate-object="text" data-key="13543"><span data-slate-leaf="true" data-offset-key="13543:0" data-first-offset="true"><span data-slate-string="true">  cld</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13544"><span data-slate-object="text" data-key="13545"><span data-slate-leaf="true" data-offset-key="13545:0" data-first-offset="true"><span data-slate-string="true">  cli</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13546"><span data-slate-object="text" data-key="13547"><span data-slate-leaf="true" data-offset-key="13547:0" data-first-offset="true"><span data-slate-string="true">  leal  (BP_scratch+4)(%esi), %esp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13548"><span data-slate-object="text" data-key="13549"><span data-slate-leaf="true" data-offset-key="13549:0" data-first-offset="true"><span data-slate-string="true">  call  1f</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13550"><span data-slate-object="text" data-key="13551"><span data-slate-leaf="true" data-offset-key="13551:0" data-first-offset="true"><span data-slate-string="true">1:  popl  %ebp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13552"><span data-slate-object="text" data-key="13553"><span data-slate-leaf="true" data-offset-key="13553:0" data-first-offset="true"><span data-slate-string="true">  subl  $ rva(1b), %ebp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13554"><span data-slate-object="text" data-key="13555"><span data-slate-leaf="true" data-offset-key="13555:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13556"><span data-slate-leaf="true" data-offset-key="13556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#重新加载全局段描述符表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13557"><span data-slate-object="text" data-key="13558"><span data-slate-leaf="true" data-offset-key="13558:0" data-first-offset="true"><span data-slate-string="true">  leal  rva(gdt)(%ebp), %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13559"><span data-slate-object="text" data-key="13560"><span data-slate-leaf="true" data-offset-key="13560:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, 2(%eax)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13561"><span data-slate-object="text" data-key="13562"><span data-slate-leaf="true" data-offset-key="13562:0" data-first-offset="true"><span data-slate-string="true">  lgdt  (%eax)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13563"><span data-slate-object="text" data-key="13564"><span data-slate-leaf="true" data-offset-key="13564:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13565"><span data-slate-leaf="true" data-offset-key="13565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 篇幅所限未全部展示代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13566"><span data-slate-object="text" data-key="13567"><span data-slate-leaf="true" data-offset-key="13567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13568"><span data-slate-leaf="true" data-offset-key="13568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#重新设置栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13569"><span data-slate-object="text" data-key="13570"><span data-slate-leaf="true" data-offset-key="13570:0" data-first-offset="true"><span data-slate-string="true">  leal  rva(boot_stack_end)(%ebp), %esp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13571"><span data-slate-object="text" data-key="13572"><span data-slate-leaf="true" data-offset-key="13572:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13573"><span data-slate-leaf="true" data-offset-key="13573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#检测 CPU 是否支持长模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13574"><span data-slate-object="text" data-key="13575"><span data-slate-leaf="true" data-offset-key="13575:0" data-first-offset="true"><span data-slate-string="true">  call  verify_cpu</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13576"><span data-slate-object="text" data-key="13577"><span data-slate-leaf="true" data-offset-key="13577:0" data-first-offset="true"><span data-slate-string="true">  testl  %eax, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13578"><span data-slate-object="text" data-key="13579"><span data-slate-leaf="true" data-offset-key="13579:0" data-first-offset="true"><span data-slate-string="true">  jnz  .Lno_longmode</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13580"><span data-slate-object="text" data-key="13581"><span data-slate-leaf="true" data-offset-key="13581:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13582"><span data-slate-leaf="true" data-offset-key="13582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 计算偏移的代码略过</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13583"><span data-slate-object="text" data-key="13584"><span data-slate-leaf="true" data-offset-key="13584:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13585"><span data-slate-leaf="true" data-offset-key="13585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#开启 PAE</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13586"><span data-slate-object="text" data-key="13587"><span data-slate-leaf="true" data-offset-key="13587:0" data-first-offset="true"><span data-slate-string="true">    movl  %cr4, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13588"><span data-slate-object="text" data-key="13589"><span data-slate-leaf="true" data-offset-key="13589:0" data-first-offset="true"><span data-slate-string="true">  orl  </span></span></span><span data-slate-object="text" data-key="13590"><span data-slate-leaf="true" data-offset-key="13590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$X86_CR4_PAE</span></span></span></span><span data-slate-object="text" data-key="13591"><span data-slate-leaf="true" data-offset-key="13591:0" data-first-offset="true"><span data-slate-string="true">, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13592"><span data-slate-object="text" data-key="13593"><span data-slate-leaf="true" data-offset-key="13593:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %cr4</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13594"><span data-slate-object="text" data-key="13595"><span data-slate-leaf="true" data-offset-key="13595:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13596"><span data-slate-leaf="true" data-offset-key="13596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 建立 MMU 页表的代码略过</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13597"><span data-slate-object="text" data-key="13598"><span data-slate-leaf="true" data-offset-key="13598:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13599"><span data-slate-leaf="true" data-offset-key="13599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#开启长模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13600"><span data-slate-object="text" data-key="13601"><span data-slate-leaf="true" data-offset-key="13601:0" data-first-offset="true"><span data-slate-string="true">    movl  </span></span></span><span data-slate-object="text" data-key="13602"><span data-slate-leaf="true" data-offset-key="13602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$MSR_EFER</span></span></span></span><span data-slate-object="text" data-key="13603"><span data-slate-leaf="true" data-offset-key="13603:0" data-first-offset="true"><span data-slate-string="true">, %ecx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13604"><span data-slate-object="text" data-key="13605"><span data-slate-leaf="true" data-offset-key="13605:0" data-first-offset="true"><span data-slate-string="true">  rdmsr</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13606"><span data-slate-object="text" data-key="13607"><span data-slate-leaf="true" data-offset-key="13607:0" data-first-offset="true"><span data-slate-string="true">  btsl  </span></span></span><span data-slate-object="text" data-key="13608"><span data-slate-leaf="true" data-offset-key="13608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$_EFER_LME</span></span></span></span><span data-slate-object="text" data-key="13609"><span data-slate-leaf="true" data-offset-key="13609:0" data-first-offset="true"><span data-slate-string="true">, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13610"><span data-slate-object="text" data-key="13611"><span data-slate-leaf="true" data-offset-key="13611:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13612"><span data-slate-leaf="true" data-offset-key="13612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#获取 startup_64 的地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13613"><span data-slate-object="text" data-key="13614"><span data-slate-leaf="true" data-offset-key="13614:0" data-first-offset="true"><span data-slate-string="true">    leal  rva(startup_64)(%ebp), %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13615"><span data-slate-object="text" data-key="13616"><span data-slate-leaf="true" data-offset-key="13616:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13617"><span data-slate-leaf="true" data-offset-key="13617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 篇幅所限未全部展示代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13618"><span data-slate-object="text" data-key="13619"><span data-slate-leaf="true" data-offset-key="13619:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13620"><span data-slate-leaf="true" data-offset-key="13620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#内核代码段描述符索和 startup_64 的地址引压入栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13621"><span data-slate-object="text" data-key="13622"><span data-slate-leaf="true" data-offset-key="13622:0" data-first-offset="true"><span data-slate-string="true">    pushl  </span></span></span><span data-slate-object="text" data-key="13623"><span data-slate-leaf="true" data-offset-key="13623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$__KERNEL_CS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13624"><span data-slate-object="text" data-key="13625"><span data-slate-leaf="true" data-offset-key="13625:0" data-first-offset="true"><span data-slate-string="true">  pushl  %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13626"><span data-slate-object="text" data-key="13627"><span data-slate-leaf="true" data-offset-key="13627:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13628"><span data-slate-leaf="true" data-offset-key="13628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#开启分页和保护模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13629"><span data-slate-object="text" data-key="13630"><span data-slate-leaf="true" data-offset-key="13630:0" data-first-offset="true"><span data-slate-string="true">  movl  $(X86_CR0_PG | X86_CR0_PE), %eax </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13631"><span data-slate-object="text" data-key="13632"><span data-slate-leaf="true" data-offset-key="13632:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %cr0</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13633"><span data-slate-object="text" data-key="13634"><span data-slate-leaf="true" data-offset-key="13634:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13635"><span data-slate-leaf="true" data-offset-key="13635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#弹出刚刚栈中压入的内核代码段描述符和 startup_64 的地址到 CS 和 RIP 中，实现跳转，真正进入长模式。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13636"><span data-slate-object="text" data-key="13637"><span data-slate-leaf="true" data-offset-key="13637:0" data-first-offset="true"><span data-slate-string="true">  lret</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13638"><span data-slate-object="text" data-key="13639"><span data-slate-leaf="true" data-offset-key="13639:0" data-first-offset="true"><span data-slate-string="true">SYM_FUNC_END(startup_32）</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13640" id="sr-toc-6"><span data-slate-object="text" data-key="13641"><span data-slate-leaf="true" data-offset-key="13641:0" data-first-offset="true"><span data-slate-string="true">startup_64 函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13642"><span data-slate-object="text" data-key="13643"><span data-slate-leaf="true" data-offset-key="13643:0" data-first-offset="true"><span data-slate-string="true">现在，我们终于开启了 CPU 长模式，从 startup_64 开始真正进入了 64 位的时代，可喜可贺。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13644"><span data-slate-object="text" data-key="13645"><span data-slate-leaf="true" data-offset-key="13645:0" data-first-offset="true"><span data-slate-string="true">startup_64 函数同样也是在 linux/arch/x86/boot/compressed/head64.S 文件中定义的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13646"><span data-slate-object="text" data-key="13647"><span data-slate-leaf="true" data-offset-key="13647:0" data-first-offset="true"><span data-slate-string="true">startup_64 函数中，初始化长模式下数据段寄存器，确定最终解压缩地址，然后拷贝压缩 vmlinux.bin 到该地址，跳转到 decompress_kernel 地址处，开始解压 vmlinux.bin.gz，代码如下。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13648"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13649"><span data-slate-object="text" data-key="13650"><span data-slate-leaf="true" data-offset-key="13650:0" data-first-offset="true"><span data-slate-string="true">  .code64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13651"><span data-slate-object="text" data-key="13652"><span data-slate-leaf="true" data-offset-key="13652:0" data-first-offset="true"><span data-slate-string="true">  .org 0x200</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13653"><span data-slate-object="text" data-key="13654"><span data-slate-leaf="true" data-offset-key="13654:0" data-first-offset="true"><span data-slate-string="true">SYM_CODE_START(startup_64)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13655"><span data-slate-object="text" data-key="13656"><span data-slate-leaf="true" data-offset-key="13656:0" data-first-offset="true"><span data-slate-string="true">  cld</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13657"><span data-slate-object="text" data-key="13658"><span data-slate-leaf="true" data-offset-key="13658:0" data-first-offset="true"><span data-slate-string="true">  cli</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13659"><span data-slate-object="text" data-key="13660"><span data-slate-leaf="true" data-offset-key="13660:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13661"><span data-slate-leaf="true" data-offset-key="13661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#初始化长模式下数据段寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13662"><span data-slate-object="text" data-key="13663"><span data-slate-leaf="true" data-offset-key="13663:0" data-first-offset="true"><span data-slate-string="true">  xorl  %eax, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13664"><span data-slate-object="text" data-key="13665"><span data-slate-leaf="true" data-offset-key="13665:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %ds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13666"><span data-slate-object="text" data-key="13667"><span data-slate-leaf="true" data-offset-key="13667:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %es</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13668"><span data-slate-object="text" data-key="13669"><span data-slate-leaf="true" data-offset-key="13669:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %ss</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13670"><span data-slate-object="text" data-key="13671"><span data-slate-leaf="true" data-offset-key="13671:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %fs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13672"><span data-slate-object="text" data-key="13673"><span data-slate-leaf="true" data-offset-key="13673:0" data-first-offset="true"><span data-slate-string="true">  movl  %eax, %gs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13674"><span data-slate-object="text" data-key="13675"><span data-slate-leaf="true" data-offset-key="13675:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13676"><span data-slate-leaf="true" data-offset-key="13676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 重新确定内核映像加载地址的代码略过</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13677"><span data-slate-object="text" data-key="13678"><span data-slate-leaf="true" data-offset-key="13678:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13679"><span data-slate-leaf="true" data-offset-key="13679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#重新初始化 64 位长模式下的栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13680"><span data-slate-object="text" data-key="13681"><span data-slate-leaf="true" data-offset-key="13681:0" data-first-offset="true"><span data-slate-string="true">    leaq  rva(boot_stack_end)(%rbx), %rsp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13682"><span data-slate-object="text" data-key="13683"><span data-slate-leaf="true" data-offset-key="13683:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13684"><span data-slate-leaf="true" data-offset-key="13684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 建立最新 5 级 MMU 页表的代码略过</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13685"><span data-slate-object="text" data-key="13686"><span data-slate-leaf="true" data-offset-key="13686:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13687"><span data-slate-leaf="true" data-offset-key="13687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#确定最终解压缩地址，然后拷贝压缩 vmlinux.bin 到该地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13688"><span data-slate-object="text" data-key="13689"><span data-slate-leaf="true" data-offset-key="13689:0" data-first-offset="true"><span data-slate-string="true">    pushq  %rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13690"><span data-slate-object="text" data-key="13691"><span data-slate-leaf="true" data-offset-key="13691:0" data-first-offset="true"><span data-slate-string="true">  leaq  (_bss-8)(%rip), %rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13692"><span data-slate-object="text" data-key="13693"><span data-slate-leaf="true" data-offset-key="13693:0" data-first-offset="true"><span data-slate-string="true">  leaq  rva(_bss-8)(%rbx), %rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13694"><span data-slate-object="text" data-key="13695"><span data-slate-leaf="true" data-offset-key="13695:0" data-first-offset="true"><span data-slate-string="true">  movl  $(_bss - startup_32), %ecx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13696"><span data-slate-object="text" data-key="13697"><span data-slate-leaf="true" data-offset-key="13697:0" data-first-offset="true"><span data-slate-string="true">  shrl  </span></span></span><span data-slate-object="text" data-key="13698"><span data-slate-leaf="true" data-offset-key="13698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$3</span></span></span></span><span data-slate-object="text" data-key="13699"><span data-slate-leaf="true" data-offset-key="13699:0" data-first-offset="true"><span data-slate-string="true">, %ecx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13700"><span data-slate-object="text" data-key="13701"><span data-slate-leaf="true" data-offset-key="13701:0" data-first-offset="true"><span data-slate-string="true">  std</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13702"><span data-slate-object="text" data-key="13703"><span data-slate-leaf="true" data-offset-key="13703:0" data-first-offset="true"><span data-slate-string="true">  rep  movsq</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13704"><span data-slate-object="text" data-key="13705"><span data-slate-leaf="true" data-offset-key="13705:0" data-first-offset="true"><span data-slate-string="true">  cld</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13706"><span data-slate-object="text" data-key="13707"><span data-slate-leaf="true" data-offset-key="13707:0" data-first-offset="true"><span data-slate-string="true">  popq  %rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13708"><span data-slate-object="text" data-key="13709"><span data-slate-leaf="true" data-offset-key="13709:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13710"><span data-slate-leaf="true" data-offset-key="13710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#跳转到重定位的 Lrelocated 处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13711"><span data-slate-object="text" data-key="13712"><span data-slate-leaf="true" data-offset-key="13712:0" data-first-offset="true"><span data-slate-string="true">    leaq  rva(.Lrelocated)(%rbx), %rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13713"><span data-slate-object="text" data-key="13714"><span data-slate-leaf="true" data-offset-key="13714:0" data-first-offset="true"><span data-slate-string="true">  jmp  *%rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13715"><span data-slate-object="text" data-key="13716"><span data-slate-leaf="true" data-offset-key="13716:0" data-first-offset="true"><span data-slate-string="true">SYM_CODE_END(startup_64)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13717"></div><div data-slate-type="code-line" data-slate-object="block" data-key="13718"><span data-slate-object="text" data-key="13719"><span data-slate-leaf="true" data-offset-key="13719:0" data-first-offset="true"><span data-slate-string="true">  .text</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13720"><span data-slate-object="text" data-key="13721"><span data-slate-leaf="true" data-offset-key="13721:0" data-first-offset="true"><span data-slate-string="true">SYM_FUNC_START_LOCAL_NOALIGN(.Lrelocated)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13722"><span data-slate-object="text" data-key="13723"><span data-slate-leaf="true" data-offset-key="13723:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13724"><span data-slate-leaf="true" data-offset-key="13724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#清理程序文件中需要的 BSS 段</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13725"><span data-slate-object="text" data-key="13726"><span data-slate-leaf="true" data-offset-key="13726:0" data-first-offset="true"><span data-slate-string="true">  xorl  %eax, %eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13727"><span data-slate-object="text" data-key="13728"><span data-slate-leaf="true" data-offset-key="13728:0" data-first-offset="true"><span data-slate-string="true">  leaq    _bss(%rip), %rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13729"><span data-slate-object="text" data-key="13730"><span data-slate-leaf="true" data-offset-key="13730:0" data-first-offset="true"><span data-slate-string="true">  leaq    _ebss(%rip), %rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13731"><span data-slate-object="text" data-key="13732"><span data-slate-leaf="true" data-offset-key="13732:0" data-first-offset="true"><span data-slate-string="true">  subq  %rdi, %rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13733"><span data-slate-object="text" data-key="13734"><span data-slate-leaf="true" data-offset-key="13734:0" data-first-offset="true"><span data-slate-string="true">  shrq  </span></span></span><span data-slate-object="text" data-key="13735"><span data-slate-leaf="true" data-offset-key="13735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$3</span></span></span></span><span data-slate-object="text" data-key="13736"><span data-slate-leaf="true" data-offset-key="13736:0" data-first-offset="true"><span data-slate-string="true">, %rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13737"><span data-slate-object="text" data-key="13738"><span data-slate-leaf="true" data-offset-key="13738:0" data-first-offset="true"><span data-slate-string="true">  rep  stosq</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13739"><span data-slate-object="text" data-key="13740"><span data-slate-leaf="true" data-offset-key="13740:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13741"><span data-slate-leaf="true" data-offset-key="13741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#…… 省略无关代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13742"><span data-slate-object="text" data-key="13743"><span data-slate-leaf="true" data-offset-key="13743:0" data-first-offset="true"><span data-slate-string="true">  pushq  %rsi      </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13744"><span data-slate-object="text" data-key="13745"><span data-slate-leaf="true" data-offset-key="13745:0" data-first-offset="true"><span data-slate-string="true">  movq  %rsi, %rdi    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13746"><span data-slate-object="text" data-key="13747"><span data-slate-leaf="true" data-offset-key="13747:0" data-first-offset="true"><span data-slate-string="true">  leaq  boot_heap(%rip), %rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13748"><span data-slate-object="text" data-key="13749"><span data-slate-leaf="true" data-offset-key="13749:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13750"><span data-slate-leaf="true" data-offset-key="13750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#准备参数：被解压数据的开始地址   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13751"><span data-slate-object="text" data-key="13752"><span data-slate-leaf="true" data-offset-key="13752:0" data-first-offset="true"><span data-slate-string="true">  leaq  input_data(%rip), %rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13753"><span data-slate-object="text" data-key="13754"><span data-slate-leaf="true" data-offset-key="13754:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13755"><span data-slate-leaf="true" data-offset-key="13755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#准备参数：被解压数据的长度   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13756"><span data-slate-object="text" data-key="13757"><span data-slate-leaf="true" data-offset-key="13757:0" data-first-offset="true"><span data-slate-string="true">  movl  input_len(%rip), %ecx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13758"><span data-slate-object="text" data-key="13759"><span data-slate-leaf="true" data-offset-key="13759:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13760"><span data-slate-leaf="true" data-offset-key="13760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#准备参数：解压数据后的开始地址     </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13761"><span data-slate-object="text" data-key="13762"><span data-slate-leaf="true" data-offset-key="13762:0" data-first-offset="true"><span data-slate-string="true">  movq  %rbp, %r8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13763"><span data-slate-object="text" data-key="13764"><span data-slate-leaf="true" data-offset-key="13764:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13765"><span data-slate-leaf="true" data-offset-key="13765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#准备参数：解压数据后的长度</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13766"><span data-slate-object="text" data-key="13767"><span data-slate-leaf="true" data-offset-key="13767:0" data-first-offset="true"><span data-slate-string="true">  movl  output_len(%rip), %r9d</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13768"><span data-slate-object="text" data-key="13769"><span data-slate-leaf="true" data-offset-key="13769:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13770"><span data-slate-leaf="true" data-offset-key="13770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#调用解压函数解压 vmlinux.bin.gz，返回入口地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13771"><span data-slate-object="text" data-key="13772"><span data-slate-leaf="true" data-offset-key="13772:0" data-first-offset="true"><span data-slate-string="true">    call  extract_kernel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13773"><span data-slate-object="text" data-key="13774"><span data-slate-leaf="true" data-offset-key="13774:0" data-first-offset="true"><span data-slate-string="true">  popq  %rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13775"><span data-slate-object="text" data-key="13776"><span data-slate-leaf="true" data-offset-key="13776:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13777"><span data-slate-leaf="true" data-offset-key="13777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#跳转到内核入口地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13778"><span data-slate-object="text" data-key="13779"><span data-slate-leaf="true" data-offset-key="13779:0" data-first-offset="true"><span data-slate-string="true">  jmp  *%rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13780"><span data-slate-object="text" data-key="13781"><span data-slate-leaf="true" data-offset-key="13781:0" data-first-offset="true"><span data-slate-string="true">SYM_FUNC_END(.Lrelocated)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13782"><span data-slate-object="text" data-key="13783"><span data-slate-leaf="true" data-offset-key="13783:0" data-first-offset="true"><span data-slate-string="true">上述代码中最后到了 extract_kernel 函数，它就是解压内核的函数，下面我们就来研究它。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13784" id="sr-toc-7"><span data-slate-object="text" data-key="13785"><span data-slate-leaf="true" data-offset-key="13785:0" data-first-offset="true"><span data-slate-string="true">extract_kernel 函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13786"><span data-slate-object="text" data-key="13787"><span data-slate-leaf="true" data-offset-key="13787:0" data-first-offset="true"><span data-slate-string="true">从 startup_32 函数到 startup_64 函数，其间经过了保护模式、长模式，最终到达了 extract_kernel 函数，extract_kernel 函数根据 piggy.o 中的信息从 vmlinux.bin.gz 中解压出 vmlinux。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13788"><span data-slate-object="text" data-key="13789"><span data-slate-leaf="true" data-offset-key="13789:0" data-first-offset="true"><span data-slate-string="true">根据前面的知识点，我们知道 vmlinux 正是编译出 Linux 内核 elf 格式的文件，只不过它被去掉了符号信息。所以，extract_kernel 函数不仅仅是解压，还需要解析 elf 格式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13790"><span data-slate-object="text" data-key="13791"><span data-slate-leaf="true" data-offset-key="13791:0" data-first-offset="true"><span data-slate-string="true">extract_kernel 函数是在 linux/arch/x86/boot/compressed/misc.c 文件中定义的。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13792"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13793"><span data-slate-object="text" data-key="13794"><span data-slate-leaf="true" data-offset-key="13794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asmlinkage __visible </span></span></span></span><span data-slate-object="text" data-key="13795"><span data-slate-leaf="true" data-offset-key="13795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="13796"><span data-slate-leaf="true" data-offset-key="13796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="13797"><span data-slate-leaf="true" data-offset-key="13797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extract_kernel</span></span></span></span></span><span data-slate-object="text" data-key="13798"><span data-slate-leaf="true" data-offset-key="13798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13799"><span data-slate-object="text" data-key="13800"><span data-slate-leaf="true" data-offset-key="13800:0" data-first-offset="true"><span data-slate-string="true">                                </span></span></span><span data-slate-object="text" data-key="13801"><span data-slate-leaf="true" data-offset-key="13801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="13802"><span data-slate-leaf="true" data-offset-key="13802:0" data-first-offset="true"><span data-slate-string="true"> *rmode, memptr heap,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13803"><span data-slate-object="text" data-key="13804"><span data-slate-leaf="true" data-offset-key="13804:0" data-first-offset="true"><span data-slate-string="true">                                </span></span></span><span data-slate-object="text" data-key="13805"><span data-slate-leaf="true" data-offset-key="13805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13806"><span data-slate-leaf="true" data-offset-key="13806:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13807"><span data-slate-leaf="true" data-offset-key="13807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="13808"><span data-slate-leaf="true" data-offset-key="13808:0" data-first-offset="true"><span data-slate-string="true"> *input_data,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13809"><span data-slate-object="text" data-key="13810"><span data-slate-leaf="true" data-offset-key="13810:0" data-first-offset="true"><span data-slate-string="true">                                </span></span></span><span data-slate-object="text" data-key="13811"><span data-slate-leaf="true" data-offset-key="13811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13812"><span data-slate-leaf="true" data-offset-key="13812:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13813"><span data-slate-leaf="true" data-offset-key="13813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13814"><span data-slate-leaf="true" data-offset-key="13814:0" data-first-offset="true"><span data-slate-string="true"> input_len,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13815"><span data-slate-object="text" data-key="13816"><span data-slate-leaf="true" data-offset-key="13816:0" data-first-offset="true"><span data-slate-string="true">                                </span></span></span><span data-slate-object="text" data-key="13817"><span data-slate-leaf="true" data-offset-key="13817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13818"><span data-slate-leaf="true" data-offset-key="13818:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13819"><span data-slate-leaf="true" data-offset-key="13819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="13820"><span data-slate-leaf="true" data-offset-key="13820:0" data-first-offset="true"><span data-slate-string="true"> *output,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13821"><span data-slate-object="text" data-key="13822"><span data-slate-leaf="true" data-offset-key="13822:0" data-first-offset="true"><span data-slate-string="true">                                </span></span></span><span data-slate-object="text" data-key="13823"><span data-slate-leaf="true" data-offset-key="13823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13824"><span data-slate-leaf="true" data-offset-key="13824:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13825"><span data-slate-leaf="true" data-offset-key="13825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13826"><span data-slate-leaf="true" data-offset-key="13826:0" data-first-offset="true"><span data-slate-string="true"> output_len</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13827"><span data-slate-object="text" data-key="13828"><span data-slate-leaf="true" data-offset-key="13828:0" data-first-offset="true"><span data-slate-string="true">                                ){    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13829"><span data-slate-object="text" data-key="13830"><span data-slate-leaf="true" data-offset-key="13830:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13831"><span data-slate-leaf="true" data-offset-key="13831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="13832"><span data-slate-leaf="true" data-offset-key="13832:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13833"><span data-slate-leaf="true" data-offset-key="13833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13834"><span data-slate-leaf="true" data-offset-key="13834:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13835"><span data-slate-leaf="true" data-offset-key="13835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13836"><span data-slate-leaf="true" data-offset-key="13836:0" data-first-offset="true"><span data-slate-string="true"> kernel_total_size = VO__end - VO__text;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13837"><span data-slate-object="text" data-key="13838"><span data-slate-leaf="true" data-offset-key="13838:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13839"><span data-slate-leaf="true" data-offset-key="13839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13840"><span data-slate-leaf="true" data-offset-key="13840:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13841"><span data-slate-leaf="true" data-offset-key="13841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13842"><span data-slate-leaf="true" data-offset-key="13842:0" data-first-offset="true"><span data-slate-string="true"> virt_addr = LOAD_PHYSICAL_ADDR;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13843"><span data-slate-object="text" data-key="13844"><span data-slate-leaf="true" data-offset-key="13844:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13845"><span data-slate-leaf="true" data-offset-key="13845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="13846"><span data-slate-leaf="true" data-offset-key="13846:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13847"><span data-slate-leaf="true" data-offset-key="13847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13848"><span data-slate-leaf="true" data-offset-key="13848:0" data-first-offset="true"><span data-slate-string="true"> needed_size;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13849"><span data-slate-object="text" data-key="13850"><span data-slate-leaf="true" data-offset-key="13850:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13851"><span data-slate-leaf="true" data-offset-key="13851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 省略了无关性代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13852"><span data-slate-object="text" data-key="13853"><span data-slate-leaf="true" data-offset-key="13853:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13854"><span data-slate-leaf="true" data-offset-key="13854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">debug_putstr</span></span></span></span><span data-slate-object="text" data-key="13855"><span data-slate-leaf="true" data-offset-key="13855:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13856"><span data-slate-leaf="true" data-offset-key="13856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"\nDecompressing Linux..."</span></span></span></span><span data-slate-object="text" data-key="13857"><span data-slate-leaf="true" data-offset-key="13857:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13858"><span data-slate-object="text" data-key="13859"><span data-slate-leaf="true" data-offset-key="13859:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13860"><span data-slate-leaf="true" data-offset-key="13860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用具体的解压缩算法解压</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13861"><span data-slate-object="text" data-key="13862"><span data-slate-leaf="true" data-offset-key="13862:0" data-first-offset="true"><span data-slate-string="true">    __decompress(input_data, input_len, </span></span></span><span data-slate-object="text" data-key="13863"><span data-slate-leaf="true" data-offset-key="13863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="13864"><span data-slate-leaf="true" data-offset-key="13864:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13865"><span data-slate-leaf="true" data-offset-key="13865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="13866"><span data-slate-leaf="true" data-offset-key="13866:0" data-first-offset="true"><span data-slate-string="true">, output, output_len,            </span></span></span><span data-slate-object="text" data-key="13867"><span data-slate-leaf="true" data-offset-key="13867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="13868"><span data-slate-leaf="true" data-offset-key="13868:0" data-first-offset="true"><span data-slate-string="true">, error);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13869"><span data-slate-object="text" data-key="13870"><span data-slate-leaf="true" data-offset-key="13870:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13871"><span data-slate-leaf="true" data-offset-key="13871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解压出的 vmlinux 是 elf 格式，所以要解析出里面的指令数据段和常规数据段</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13872"><span data-slate-object="text" data-key="13873"><span data-slate-leaf="true" data-offset-key="13873:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13874"><span data-slate-leaf="true" data-offset-key="13874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回 vmlinux 的入口点即 Linux 内核程序的开始地址  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13875"><span data-slate-object="text" data-key="13876"><span data-slate-leaf="true" data-offset-key="13876:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13877"><span data-slate-leaf="true" data-offset-key="13877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">parse_elf</span></span></span></span><span data-slate-object="text" data-key="13878"><span data-slate-leaf="true" data-offset-key="13878:0" data-first-offset="true"><span data-slate-string="true">(output); </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13879"><span data-slate-object="text" data-key="13880"><span data-slate-leaf="true" data-offset-key="13880:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13881"><span data-slate-leaf="true" data-offset-key="13881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handle_relocations</span></span></span></span><span data-slate-object="text" data-key="13882"><span data-slate-leaf="true" data-offset-key="13882:0" data-first-offset="true"><span data-slate-string="true">(output, output_len, virt_addr);    </span></span></span><span data-slate-object="text" data-key="13883"><span data-slate-leaf="true" data-offset-key="13883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">debug_putstr</span></span></span></span><span data-slate-object="text" data-key="13884"><span data-slate-leaf="true" data-offset-key="13884:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13885"><span data-slate-leaf="true" data-offset-key="13885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"done.\nBooting the kernel.\n"</span></span></span></span><span data-slate-object="text" data-key="13886"><span data-slate-leaf="true" data-offset-key="13886:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13887"><span data-slate-object="text" data-key="13888"><span data-slate-leaf="true" data-offset-key="13888:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13889"><span data-slate-leaf="true" data-offset-key="13889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13890"><span data-slate-leaf="true" data-offset-key="13890:0" data-first-offset="true"><span data-slate-string="true"> output;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13891"><span data-slate-object="text" data-key="13892"><span data-slate-leaf="true" data-offset-key="13892:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13893"><span data-slate-object="text" data-key="13894"><span data-slate-leaf="true" data-offset-key="13894:0" data-first-offset="true"><span data-slate-string="true">正如上面代码所示，extract_kernel 函数调用 __decompress 函数，对 vmlinux.bin.gz 使用特定的解压算法进行解压。解压算法是编译内核的配置选项决定的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13895"><span data-slate-object="text" data-key="13896"><span data-slate-leaf="true" data-offset-key="13896:0" data-first-offset="true"><span data-slate-string="true">但是，__decompress 函数解压出来的是 vmlinux 文件是 elf 格式的，所以还要调用 parse_elf 函数进一步解析 elf 格式，把 vmlinux 中的指令段、数据段、BSS 段，根据 elf 中信息和要求放入特定的内存空间，返回指令段的入口地址。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13897"><span data-slate-object="text" data-key="13898"><span data-slate-leaf="true" data-offset-key="13898:0" data-first-offset="true"><span data-slate-string="true">请你注意，在 Lrelocated 函数的最后一条指令：jmp *rax，其中的 rax 中就是保存的 extract_kernel 函数返回的入口点，就是从这里开始进入了 Linux 内核。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13899" id="sr-toc-8"><span data-slate-object="text" data-key="13900"><span data-slate-leaf="true" data-offset-key="13900:0" data-first-offset="true"><span data-slate-string="true">Linux 内核的 startup_64</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13901"><span data-slate-object="text" data-key="13902"><span data-slate-leaf="true" data-offset-key="13902:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这里我提醒你留意，此时的 startup_64 函数并不是之前的 startup_64 函数，也不参与前面的链接工作。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13903"><span data-slate-object="text" data-key="13904"><span data-slate-leaf="true" data-offset-key="13904:0" data-first-offset="true"><span data-slate-string="true">这个 startup_64 函数定义在 linux/arch/x86/kernel/head_64.S 文件中，它是内核的入口函数，如下所示。</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="13905"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13906"><span data-slate-object="text" data-key="13907"><span data-slate-leaf="true" data-offset-key="13907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13908"><span data-slate-leaf="true" data-offset-key="13908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">linux/arch/x86/kernel/head_64.S</span></span></span></span><span data-slate-object="text" data-key="13909"><span data-slate-leaf="true" data-offset-key="13909:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13910"><span data-slate-object="text" data-key="13911"><span data-slate-leaf="true" data-offset-key="13911:0" data-first-offset="true"><span data-slate-string="true">    .code64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13912"><span data-slate-object="text" data-key="13913"><span data-slate-leaf="true" data-offset-key="13913:0" data-first-offset="true"><span data-slate-string="true">SYM_CODE_START_NOALIGN(startup_64)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13914"><span data-slate-object="text" data-key="13915"><span data-slate-leaf="true" data-offset-key="13915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">  #</span></span></span></span><span data-slate-object="text" data-key="13916"><span data-slate-leaf="true" data-offset-key="13916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">切换栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13917"><span data-slate-object="text" data-key="13918"><span data-slate-leaf="true" data-offset-key="13918:0" data-first-offset="true"><span data-slate-string="true">    leaq  (__end_init_task - SIZEOF_PTREGS)(%rip), %rsp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13919"><span data-slate-object="text" data-key="13920"><span data-slate-leaf="true" data-offset-key="13920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">  #</span></span></span></span><span data-slate-object="text" data-key="13921"><span data-slate-leaf="true" data-offset-key="13921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">跳转到. Lon_kernel_cs:</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13922"><span data-slate-object="text" data-key="13923"><span data-slate-leaf="true" data-offset-key="13923:0" data-first-offset="true"><span data-slate-string="true">    pushq  $__KERNEL_CS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13924"><span data-slate-object="text" data-key="13925"><span data-slate-leaf="true" data-offset-key="13925:0" data-first-offset="true"><span data-slate-string="true">  leaq  .Lon_kernel_cs(%rip), %rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13926"><span data-slate-object="text" data-key="13927"><span data-slate-leaf="true" data-offset-key="13927:0" data-first-offset="true"><span data-slate-string="true">  pushq  %rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13928"><span data-slate-object="text" data-key="13929"><span data-slate-leaf="true" data-offset-key="13929:0" data-first-offset="true"><span data-slate-string="true">  lretq</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13930"><span data-slate-object="text" data-key="13931"><span data-slate-leaf="true" data-offset-key="13931:0" data-first-offset="true"><span data-slate-string="true">.Lon_kernel_cs:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13932"><span data-slate-object="text" data-key="13933"><span data-slate-leaf="true" data-offset-key="13933:0" data-first-offset="true"><span data-slate-string="true">    #对于第一个 CPU，则会跳转 secondary_startup_64 函数中 1 标号处</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13934"><span data-slate-object="text" data-key="13935"><span data-slate-leaf="true" data-offset-key="13935:0" data-first-offset="true"><span data-slate-string="true">  jmp 1f</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13936"><span data-slate-object="text" data-key="13937"><span data-slate-leaf="true" data-offset-key="13937:0" data-first-offset="true"><span data-slate-string="true">SYM_CODE_END(startup_64)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13938"><span data-slate-object="text" data-key="13939"><span data-slate-leaf="true" data-offset-key="13939:0" data-first-offset="true"><span data-slate-string="true">上述代码中省略了和流程无关的代码，对于 SMP 系统加电之后，总线仲裁机制会选出多个 CPU 中的一个 CPU，称为 BSP，也叫第一个 CPU。它负责让 BSP CPU 先启动，其它 CPU 则等待 BSP CPU 的唤醒。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13940"><span data-slate-object="text" data-key="13941"><span data-slate-leaf="true" data-offset-key="13941:0" data-first-offset="true"><span data-slate-string="true">这里我来分情况给你说说。对于第一个启动的 CPU，会跳转 secondary_startup_64 函数中 1 标号处，对于其它被唤醒的 CPU 则会直接执行 secondary_startup_64 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13942"><span data-slate-object="text" data-key="13943"><span data-slate-leaf="true" data-offset-key="13943:0" data-first-offset="true"><span data-slate-string="true">接下来，我给你快速过一遍 secondary_startup_64 函数，后面的代码我省略了这个函数对更多 CPU 特性（设置 GDT、IDT，处理了 MMU 页表等）的检查，因为这些工作我们早已很熟悉了，代码如下所示。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13944"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13945"><span data-slate-object="text" data-key="13946"><span data-slate-leaf="true" data-offset-key="13946:0" data-first-offset="true"><span data-slate-string="true">SYM_CODE_START(secondary_startup_64)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13947"><span data-slate-object="text" data-key="13948"><span data-slate-leaf="true" data-offset-key="13948:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13949"><span data-slate-leaf="true" data-offset-key="13949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#省略了大量无关性代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13950"><span data-slate-object="text" data-key="13951"><span data-slate-leaf="true" data-offset-key="13951:0" data-first-offset="true"><span data-slate-string="true">1:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13952"><span data-slate-object="text" data-key="13953"><span data-slate-leaf="true" data-offset-key="13953:0" data-first-offset="true"><span data-slate-string="true">  movl  $(X86_CR4_PAE | X86_CR4_PGE), %ecx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13954"><span data-slate-object="text" data-key="13955"><span data-slate-leaf="true" data-offset-key="13955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#ifdef CONFIG_X86_5LEVEL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13956"><span data-slate-object="text" data-key="13957"><span data-slate-leaf="true" data-offset-key="13957:0" data-first-offset="true"><span data-slate-string="true">  testl  </span></span></span><span data-slate-object="text" data-key="13958"><span data-slate-leaf="true" data-offset-key="13958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$1</span></span></span></span><span data-slate-object="text" data-key="13959"><span data-slate-leaf="true" data-offset-key="13959:0" data-first-offset="true"><span data-slate-string="true">, __pgtable_l5_enabled(%rip)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13960"><span data-slate-object="text" data-key="13961"><span data-slate-leaf="true" data-offset-key="13961:0" data-first-offset="true"><span data-slate-string="true">  jz  1f</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13962"><span data-slate-object="text" data-key="13963"><span data-slate-leaf="true" data-offset-key="13963:0" data-first-offset="true"><span data-slate-string="true">  orl  </span></span></span><span data-slate-object="text" data-key="13964"><span data-slate-leaf="true" data-offset-key="13964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$X86_CR4_LA57</span></span></span></span><span data-slate-object="text" data-key="13965"><span data-slate-leaf="true" data-offset-key="13965:0" data-first-offset="true"><span data-slate-string="true">, %ecx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13966"><span data-slate-object="text" data-key="13967"><span data-slate-leaf="true" data-offset-key="13967:0" data-first-offset="true"><span data-slate-string="true">1:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13968"><span data-slate-object="text" data-key="13969"><span data-slate-leaf="true" data-offset-key="13969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#endif</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13970"><span data-slate-object="text" data-key="13971"><span data-slate-leaf="true" data-offset-key="13971:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13972"><span data-slate-leaf="true" data-offset-key="13972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#省略了大量无关性代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13973"><span data-slate-object="text" data-key="13974"><span data-slate-leaf="true" data-offset-key="13974:0" data-first-offset="true"><span data-slate-string="true">.Ljump_to_C_code:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13975"><span data-slate-object="text" data-key="13976"><span data-slate-leaf="true" data-offset-key="13976:0" data-first-offset="true"><span data-slate-string="true">  pushq  $.Lafter_lret  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13977"><span data-slate-object="text" data-key="13978"><span data-slate-leaf="true" data-offset-key="13978:0" data-first-offset="true"><span data-slate-string="true">  xorl  %ebp, %ebp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13979"><span data-slate-object="text" data-key="13980"><span data-slate-leaf="true" data-offset-key="13980:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13981"><span data-slate-leaf="true" data-offset-key="13981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#获取 x86_64_start_kernel 函数地址赋给 rax  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13982"><span data-slate-object="text" data-key="13983"><span data-slate-leaf="true" data-offset-key="13983:0" data-first-offset="true"><span data-slate-string="true">  movq  initial_code(%rip), %rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13984"><span data-slate-object="text" data-key="13985"><span data-slate-leaf="true" data-offset-key="13985:0" data-first-offset="true"><span data-slate-string="true">  pushq  </span></span></span><span data-slate-object="text" data-key="13986"><span data-slate-leaf="true" data-offset-key="13986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$__KERNEL_CS</span></span></span></span><span data-slate-object="text" data-key="13987"><span data-slate-leaf="true" data-offset-key="13987:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13988"><span data-slate-object="text" data-key="13989"><span data-slate-leaf="true" data-offset-key="13989:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13990"><span data-slate-leaf="true" data-offset-key="13990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#将 x86_64_start_kernel 函数地址压入栈中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13991"><span data-slate-object="text" data-key="13992"><span data-slate-leaf="true" data-offset-key="13992:0" data-first-offset="true"><span data-slate-string="true">  pushq  %rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13993"><span data-slate-object="text" data-key="13994"><span data-slate-leaf="true" data-offset-key="13994:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13995"><span data-slate-leaf="true" data-offset-key="13995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#弹出__KERNEL_CS  和 x86_64_start_kernel 函数地址到 CS：RIP 完成调用  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13996"><span data-slate-object="text" data-key="13997"><span data-slate-leaf="true" data-offset-key="13997:0" data-first-offset="true"><span data-slate-string="true">    lretq</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13998"><span data-slate-object="text" data-key="13999"><span data-slate-leaf="true" data-offset-key="13999:0" data-first-offset="true"><span data-slate-string="true">.Lafter_lret:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14000"><span data-slate-object="text" data-key="14001"><span data-slate-leaf="true" data-offset-key="14001:0" data-first-offset="true"><span data-slate-string="true">SYM_CODE_END(secondary_startup_64)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14002"><span data-slate-object="text" data-key="14003"><span data-slate-leaf="true" data-offset-key="14003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#保存了 x86_64_start_kernel 函数地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14004"><span data-slate-object="text" data-key="14005"><span data-slate-leaf="true" data-offset-key="14005:0" data-first-offset="true"><span data-slate-string="true">SYM_DATA(initial_code,  .quad x86_64_start_kernel)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14006"><span data-slate-object="text" data-key="14007"><span data-slate-leaf="true" data-offset-key="14007:0" data-first-offset="true"><span data-slate-string="true">在 secondary_startup_64 函数一切准备就绪之后，最后就会调用 x86_64_start_kernel 函数，看它的名字好像是内核的开始函数，但真的是这样吗，我们一起看看才知道。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14008" id="sr-toc-9"><span data-slate-object="text" data-key="14009"><span data-slate-leaf="true" data-offset-key="14009:0" data-first-offset="true"><span data-slate-string="true">Linux 内核的第一个 C 函数</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14010"><span data-slate-object="text" data-key="14011"><span data-slate-leaf="true" data-offset-key="14011:0" data-first-offset="true"><span data-slate-string="true">若不是经历了前面的分析讲解。要是我问你 Linux 内核的第一个 C 函数是什么，你可能无从说起，就算一通百度之后，仍然无法确定。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14012"><span data-slate-object="text" data-key="14013"><span data-slate-leaf="true" data-offset-key="14013:0" data-first-offset="true"><span data-slate-string="true">但是，只要我们跟着代码的执行流程，就会发现</span></span></span><span data-slate-object="text" data-key="14014"><span data-slate-leaf="true" data-offset-key="14014:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 secondary_startup_64 函数的最后，调用的 x86_64_start_kernel 函数是用 C 语言写的，那么它一定就是 Linux 内核的第一个 C 函数。</span></span></span></span><span data-slate-object="text" data-key="14015"><span data-slate-leaf="true" data-offset-key="14015:0" data-first-offset="true"><span data-slate-string="true">它在 linux/arch/x86/kernel/head64.c 文件中被定义，这个文件名你甚至都能猜出来，如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="14016"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14017"><span data-slate-object="text" data-key="14018"><span data-slate-leaf="true" data-offset-key="14018:0" data-first-offset="true"><span data-slate-string="true">asmlinkage __visible </span></span></span><span data-slate-object="text" data-key="14019"><span data-slate-leaf="true" data-offset-key="14019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14020"><span data-slate-leaf="true" data-offset-key="14020:0" data-first-offset="true"><span data-slate-string="true"> __init </span></span></span><span data-slate-object="text" data-key="14021"><span data-slate-leaf="true" data-offset-key="14021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">x86_64_start_kernel</span></span></span></span><span data-slate-object="text" data-key="14022"><span data-slate-leaf="true" data-offset-key="14022:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14023"><span data-slate-leaf="true" data-offset-key="14023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char * real_mode_data</span></span></span></span><span data-slate-object="text" data-key="14024"><span data-slate-leaf="true" data-offset-key="14024:0" data-first-offset="true"><span data-slate-string="true">){    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14025"><span data-slate-object="text" data-key="14026"><span data-slate-leaf="true" data-offset-key="14026:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14027"><span data-slate-leaf="true" data-offset-key="14027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 重新设置早期页表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14028"><span data-slate-object="text" data-key="14029"><span data-slate-leaf="true" data-offset-key="14029:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14030"><span data-slate-leaf="true" data-offset-key="14030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">reset_early_page_tables</span></span></span></span><span data-slate-object="text" data-key="14031"><span data-slate-leaf="true" data-offset-key="14031:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14032"><span data-slate-object="text" data-key="14033"><span data-slate-leaf="true" data-offset-key="14033:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14034"><span data-slate-leaf="true" data-offset-key="14034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清理 BSS 段</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14035"><span data-slate-object="text" data-key="14036"><span data-slate-leaf="true" data-offset-key="14036:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14037"><span data-slate-leaf="true" data-offset-key="14037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clear_bss</span></span></span></span><span data-slate-object="text" data-key="14038"><span data-slate-leaf="true" data-offset-key="14038:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14039"><span data-slate-object="text" data-key="14040"><span data-slate-leaf="true" data-offset-key="14040:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14041"><span data-slate-leaf="true" data-offset-key="14041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清理之前的顶层页目录</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14042"><span data-slate-object="text" data-key="14043"><span data-slate-leaf="true" data-offset-key="14043:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14044"><span data-slate-leaf="true" data-offset-key="14044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clear_page</span></span></span></span><span data-slate-object="text" data-key="14045"><span data-slate-leaf="true" data-offset-key="14045:0" data-first-offset="true"><span data-slate-string="true">(init_top_pgt);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14046"><span data-slate-object="text" data-key="14047"><span data-slate-leaf="true" data-offset-key="14047:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14048"><span data-slate-leaf="true" data-offset-key="14048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 复制引导信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14049"><span data-slate-object="text" data-key="14050"><span data-slate-leaf="true" data-offset-key="14050:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14051"><span data-slate-leaf="true" data-offset-key="14051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy_bootdata</span></span></span></span><span data-slate-object="text" data-key="14052"><span data-slate-leaf="true" data-offset-key="14052:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14053"><span data-slate-leaf="true" data-offset-key="14053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">__va</span></span></span></span><span data-slate-object="text" data-key="14054"><span data-slate-leaf="true" data-offset-key="14054:0" data-first-offset="true"><span data-slate-string="true">(real_mode_data));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14055"><span data-slate-object="text" data-key="14056"><span data-slate-leaf="true" data-offset-key="14056:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14057"><span data-slate-leaf="true" data-offset-key="14057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加载 BSP CPU 的微码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14058"><span data-slate-object="text" data-key="14059"><span data-slate-leaf="true" data-offset-key="14059:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14060"><span data-slate-leaf="true" data-offset-key="14060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">load_ucode_bsp</span></span></span></span><span data-slate-object="text" data-key="14061"><span data-slate-leaf="true" data-offset-key="14061:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14062"><span data-slate-object="text" data-key="14063"><span data-slate-leaf="true" data-offset-key="14063:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14064"><span data-slate-leaf="true" data-offset-key="14064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 让顶层页目录指向重新设置早期页表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14065"><span data-slate-object="text" data-key="14066"><span data-slate-leaf="true" data-offset-key="14066:0" data-first-offset="true"><span data-slate-string="true">    init_top_pgt[</span></span></span><span data-slate-object="text" data-key="14067"><span data-slate-leaf="true" data-offset-key="14067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">511</span></span></span></span><span data-slate-object="text" data-key="14068"><span data-slate-leaf="true" data-offset-key="14068:0" data-first-offset="true"><span data-slate-string="true">] = early_top_pgt[</span></span></span><span data-slate-object="text" data-key="14069"><span data-slate-leaf="true" data-offset-key="14069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">511</span></span></span></span><span data-slate-object="text" data-key="14070"><span data-slate-leaf="true" data-offset-key="14070:0" data-first-offset="true"><span data-slate-string="true">];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14071"><span data-slate-object="text" data-key="14072"><span data-slate-leaf="true" data-offset-key="14072:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14073"><span data-slate-leaf="true" data-offset-key="14073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">x86_64_start_reservations</span></span></span></span><span data-slate-object="text" data-key="14074"><span data-slate-leaf="true" data-offset-key="14074:0" data-first-offset="true"><span data-slate-string="true">(real_mode_data);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14075"><span data-slate-object="text" data-key="14076"><span data-slate-leaf="true" data-offset-key="14076:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14077"><span data-slate-object="text" data-key="14078"><span data-slate-leaf="true" data-offset-key="14078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14079"><span data-slate-leaf="true" data-offset-key="14079:0" data-first-offset="true"><span data-slate-string="true"> __init </span></span></span><span data-slate-object="text" data-key="14080"><span data-slate-leaf="true" data-offset-key="14080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">x86_64_start_reservations</span></span></span></span><span data-slate-object="text" data-key="14081"><span data-slate-leaf="true" data-offset-key="14081:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14082"><span data-slate-leaf="true" data-offset-key="14082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char *real_mode_data</span></span></span></span><span data-slate-object="text" data-key="14083"><span data-slate-leaf="true" data-offset-key="14083:0" data-first-offset="true"><span data-slate-string="true">){  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14084"><span data-slate-object="text" data-key="14085"><span data-slate-leaf="true" data-offset-key="14085:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="14086"><span data-slate-leaf="true" data-offset-key="14086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 略过无关的代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14087"><span data-slate-object="text" data-key="14088"><span data-slate-leaf="true" data-offset-key="14088:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14089"><span data-slate-leaf="true" data-offset-key="14089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start_kernel</span></span></span></span><span data-slate-object="text" data-key="14090"><span data-slate-leaf="true" data-offset-key="14090:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14091"><span data-slate-object="text" data-key="14092"><span data-slate-leaf="true" data-offset-key="14092:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14093"><span data-slate-object="text" data-key="14094"><span data-slate-leaf="true" data-offset-key="14094:0" data-first-offset="true"><span data-slate-string="true">x86_64_start_kernel 函数中又一次处理了页表，处理页表就是处理 Linux 内核虚拟地址空间，Linux 虚拟地址空间是一步步完善的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14095"><span data-slate-object="text" data-key="14096"><span data-slate-leaf="true" data-offset-key="14096:0" data-first-offset="true"><span data-slate-string="true">然后，x86_64_start_kernel 函数复制了引导信息，即 struct boot_params 结构体。最后调用了 x86_64_start_reservations 函数，其中处理了平台固件相关的东西，就是调用了大名鼎鼎的 start_kernel 函数。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14097" id="sr-toc-10"><span data-slate-object="text" data-key="14098"><span data-slate-leaf="true" data-offset-key="14098:0" data-first-offset="true"><span data-slate-string="true">有名的 start_kernel 函数</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14099"><span data-slate-object="text" data-key="14100"><span data-slate-leaf="true" data-offset-key="14100:0" data-first-offset="true"><span data-slate-string="true">start_kernel 函数之所以有名，这是因为在互联网上，在各大 Linux 名著之中，都会大量宣传它 Linux 内核中的地位和作用，正如其名字表达的含意，这是内核的开始。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14101"><span data-slate-object="text" data-key="14102"><span data-slate-leaf="true" data-offset-key="14102:0" data-first-offset="true"><span data-slate-string="true">但是问题来了。我们一路走来，发现 start_kernel 函数之前有大量的代码执行，那这些代码算不算内核的开始呢？当然也可以说那就是内核的开始，也可以说是前期工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14103"><span data-slate-object="text" data-key="14104"><span data-slate-leaf="true" data-offset-key="14104:0" data-first-offset="true"><span data-slate-string="true">其实，start_kernel 函数中调用了大量 Linux 内核功能的初始化函数，它定义在 /linux/init/main.c 文件中。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="14105"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14106"><span data-slate-object="text" data-key="14107"><span data-slate-leaf="true" data-offset-key="14107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14108"><span data-slate-leaf="true" data-offset-key="14108:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14109"><span data-slate-leaf="true" data-offset-key="14109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start_kernel</span></span></span></span><span data-slate-object="text" data-key="14110"><span data-slate-leaf="true" data-offset-key="14110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="14111"><span data-slate-leaf="true" data-offset-key="14111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="14112"><span data-slate-leaf="true" data-offset-key="14112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span><span data-slate-object="text" data-key="14113"><span data-slate-leaf="true" data-offset-key="14113:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14114"><span data-slate-object="text" data-key="14115"><span data-slate-leaf="true" data-offset-key="14115:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14116"><span data-slate-leaf="true" data-offset-key="14116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="14117"><span data-slate-leaf="true" data-offset-key="14117:0" data-first-offset="true"><span data-slate-string="true"> *command_line;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14118"><span data-slate-object="text" data-key="14119"><span data-slate-leaf="true" data-offset-key="14119:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14120"><span data-slate-leaf="true" data-offset-key="14120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="14121"><span data-slate-leaf="true" data-offset-key="14121:0" data-first-offset="true"><span data-slate-string="true"> *after_dashes;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14122"><span data-slate-object="text" data-key="14123"><span data-slate-leaf="true" data-offset-key="14123:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14124"><span data-slate-leaf="true" data-offset-key="14124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//CPU 组早期初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14125"><span data-slate-object="text" data-key="14126"><span data-slate-leaf="true" data-offset-key="14126:0" data-first-offset="true"><span data-slate-string="true">    cgroup_init_early();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14127"><span data-slate-object="text" data-key="14128"><span data-slate-leaf="true" data-offset-key="14128:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14129"><span data-slate-leaf="true" data-offset-key="14129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14130"><span data-slate-object="text" data-key="14131"><span data-slate-leaf="true" data-offset-key="14131:0" data-first-offset="true"><span data-slate-string="true">    local_irq_disable();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14132"><span data-slate-object="text" data-key="14133"><span data-slate-leaf="true" data-offset-key="14133:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14134"><span data-slate-leaf="true" data-offset-key="14134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//ARCH 层初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14135"><span data-slate-object="text" data-key="14136"><span data-slate-leaf="true" data-offset-key="14136:0" data-first-offset="true"><span data-slate-string="true">    setup_arch(&amp;command_line);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14137"><span data-slate-object="text" data-key="14138"><span data-slate-leaf="true" data-offset-key="14138:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14139"><span data-slate-leaf="true" data-offset-key="14139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 日志初始化      </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14140"><span data-slate-object="text" data-key="14141"><span data-slate-leaf="true" data-offset-key="14141:0" data-first-offset="true"><span data-slate-string="true">    setup_log_buf(</span></span></span><span data-slate-object="text" data-key="14142"><span data-slate-leaf="true" data-offset-key="14142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14143"><span data-slate-leaf="true" data-offset-key="14143:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14144"><span data-slate-object="text" data-key="14145"><span data-slate-leaf="true" data-offset-key="14145:0" data-first-offset="true"><span data-slate-string="true">    sort_main_extable();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14146"><span data-slate-object="text" data-key="14147"><span data-slate-leaf="true" data-offset-key="14147:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14148"><span data-slate-leaf="true" data-offset-key="14148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 陷阱门初始化    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14149"><span data-slate-object="text" data-key="14150"><span data-slate-leaf="true" data-offset-key="14150:0" data-first-offset="true"><span data-slate-string="true">    trap_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14151"><span data-slate-object="text" data-key="14152"><span data-slate-leaf="true" data-offset-key="14152:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14153"><span data-slate-leaf="true" data-offset-key="14153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存初始化    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14154"><span data-slate-object="text" data-key="14155"><span data-slate-leaf="true" data-offset-key="14155:0" data-first-offset="true"><span data-slate-string="true">    mm_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14156"><span data-slate-object="text" data-key="14157"><span data-slate-leaf="true" data-offset-key="14157:0" data-first-offset="true"><span data-slate-string="true">    ftrace_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14158"><span data-slate-object="text" data-key="14159"><span data-slate-leaf="true" data-offset-key="14159:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14160"><span data-slate-leaf="true" data-offset-key="14160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调度器初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14161"><span data-slate-object="text" data-key="14162"><span data-slate-leaf="true" data-offset-key="14162:0" data-first-offset="true"><span data-slate-string="true">    sched_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14163"><span data-slate-object="text" data-key="14164"><span data-slate-leaf="true" data-offset-key="14164:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14165"><span data-slate-leaf="true" data-offset-key="14165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 工作队列初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14166"><span data-slate-object="text" data-key="14167"><span data-slate-leaf="true" data-offset-key="14167:0" data-first-offset="true"><span data-slate-string="true">    workqueue_init_early();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14168"><span data-slate-object="text" data-key="14169"><span data-slate-leaf="true" data-offset-key="14169:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14170"><span data-slate-leaf="true" data-offset-key="14170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//RCU 锁初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14171"><span data-slate-object="text" data-key="14172"><span data-slate-leaf="true" data-offset-key="14172:0" data-first-offset="true"><span data-slate-string="true">    rcu_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14173"><span data-slate-object="text" data-key="14174"><span data-slate-leaf="true" data-offset-key="14174:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14175"><span data-slate-leaf="true" data-offset-key="14175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//IRQ 中断请求初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14176"><span data-slate-object="text" data-key="14177"><span data-slate-leaf="true" data-offset-key="14177:0" data-first-offset="true"><span data-slate-string="true">    early_irq_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14178"><span data-slate-object="text" data-key="14179"><span data-slate-leaf="true" data-offset-key="14179:0" data-first-offset="true"><span data-slate-string="true">    init_IRQ();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14180"><span data-slate-object="text" data-key="14181"><span data-slate-leaf="true" data-offset-key="14181:0" data-first-offset="true"><span data-slate-string="true">    tick_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14182"><span data-slate-object="text" data-key="14183"><span data-slate-leaf="true" data-offset-key="14183:0" data-first-offset="true"><span data-slate-string="true">    rcu_init_nohz();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14184"><span data-slate-object="text" data-key="14185"><span data-slate-leaf="true" data-offset-key="14185:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14186"><span data-slate-leaf="true" data-offset-key="14186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定时器初始化 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14187"><span data-slate-object="text" data-key="14188"><span data-slate-leaf="true" data-offset-key="14188:0" data-first-offset="true"><span data-slate-string="true">    init_timers();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14189"><span data-slate-object="text" data-key="14190"><span data-slate-leaf="true" data-offset-key="14190:0" data-first-offset="true"><span data-slate-string="true">    hrtimers_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14191"><span data-slate-object="text" data-key="14192"><span data-slate-leaf="true" data-offset-key="14192:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14193"><span data-slate-leaf="true" data-offset-key="14193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 软中断初始化    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14194"><span data-slate-object="text" data-key="14195"><span data-slate-leaf="true" data-offset-key="14195:0" data-first-offset="true"><span data-slate-string="true">    softirq_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14196"><span data-slate-object="text" data-key="14197"><span data-slate-leaf="true" data-offset-key="14197:0" data-first-offset="true"><span data-slate-string="true">    timekeeping_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14198"><span data-slate-object="text" data-key="14199"><span data-slate-leaf="true" data-offset-key="14199:0" data-first-offset="true"><span data-slate-string="true">    mem_encrypt_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14200"><span data-slate-object="text" data-key="14201"><span data-slate-leaf="true" data-offset-key="14201:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14202"><span data-slate-leaf="true" data-offset-key="14202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每个 cpu 页面集初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14203"><span data-slate-object="text" data-key="14204"><span data-slate-leaf="true" data-offset-key="14204:0" data-first-offset="true"><span data-slate-string="true">    setup_per_cpu_pageset();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14205"><span data-slate-object="text" data-key="14206"><span data-slate-leaf="true" data-offset-key="14206:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14207"><span data-slate-leaf="true" data-offset-key="14207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//fork 初始化建立进程的 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14208"><span data-slate-object="text" data-key="14209"><span data-slate-leaf="true" data-offset-key="14209:0" data-first-offset="true"><span data-slate-string="true">    fork_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14210"><span data-slate-object="text" data-key="14211"><span data-slate-leaf="true" data-offset-key="14211:0" data-first-offset="true"><span data-slate-string="true">    proc_caches_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14212"><span data-slate-object="text" data-key="14213"><span data-slate-leaf="true" data-offset-key="14213:0" data-first-offset="true"><span data-slate-string="true">    uts_ns_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14214"><span data-slate-object="text" data-key="14215"><span data-slate-leaf="true" data-offset-key="14215:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14216"><span data-slate-leaf="true" data-offset-key="14216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内核缓冲区初始化    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14217"><span data-slate-object="text" data-key="14218"><span data-slate-leaf="true" data-offset-key="14218:0" data-first-offset="true"><span data-slate-string="true">    buffer_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14219"><span data-slate-object="text" data-key="14220"><span data-slate-leaf="true" data-offset-key="14220:0" data-first-offset="true"><span data-slate-string="true">    key_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14221"><span data-slate-object="text" data-key="14222"><span data-slate-leaf="true" data-offset-key="14222:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14223"><span data-slate-leaf="true" data-offset-key="14223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 安全相关的初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14224"><span data-slate-object="text" data-key="14225"><span data-slate-leaf="true" data-offset-key="14225:0" data-first-offset="true"><span data-slate-string="true">    security_init();  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14226"><span data-slate-object="text" data-key="14227"><span data-slate-leaf="true" data-offset-key="14227:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14228"><span data-slate-leaf="true" data-offset-key="14228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//VFS 数据结构内存池初始化  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14229"><span data-slate-object="text" data-key="14230"><span data-slate-leaf="true" data-offset-key="14230:0" data-first-offset="true"><span data-slate-string="true">    vfs_caches_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14231"><span data-slate-object="text" data-key="14232"><span data-slate-leaf="true" data-offset-key="14232:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14233"><span data-slate-leaf="true" data-offset-key="14233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 页缓存初始化    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14234"><span data-slate-object="text" data-key="14235"><span data-slate-leaf="true" data-offset-key="14235:0" data-first-offset="true"><span data-slate-string="true">    pagecache_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14236"><span data-slate-object="text" data-key="14237"><span data-slate-leaf="true" data-offset-key="14237:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14238"><span data-slate-leaf="true" data-offset-key="14238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程信号初始化    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14239"><span data-slate-object="text" data-key="14240"><span data-slate-leaf="true" data-offset-key="14240:0" data-first-offset="true"><span data-slate-string="true">    signals_init();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14241"><span data-slate-object="text" data-key="14242"><span data-slate-leaf="true" data-offset-key="14242:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14243"><span data-slate-leaf="true" data-offset-key="14243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行第一个进程 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14244"><span data-slate-object="text" data-key="14245"><span data-slate-leaf="true" data-offset-key="14245:0" data-first-offset="true"><span data-slate-string="true">    arch_call_rest_init();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14246"><span data-slate-object="text" data-key="14247"><span data-slate-leaf="true" data-offset-key="14247:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14248"><span data-slate-object="text" data-key="14249"><span data-slate-leaf="true" data-offset-key="14249:0" data-first-offset="true"><span data-slate-string="true">start_kernel 函数我如果不做精简，会有 200 多行，全部都是初始化函数，我只留下几个主要的初始化函数，这些函数的实现细节我们无需关心。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14250"><span data-slate-object="text" data-key="14251"><span data-slate-leaf="true" data-offset-key="14251:0" data-first-offset="true"><span data-slate-string="true">可以看到，Linux 内核所有功能的初始化函数都是在 start_kernel 函数中调用的，这也是它如此出名，如此重要的原因。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14252"><span data-slate-object="text" data-key="14253"><span data-slate-leaf="true" data-offset-key="14253:0" data-first-offset="true"><span data-slate-string="true">一旦 start_kernel 函数执行完成，Linux 内核就具备了向应用程序提供一系列功能服务的能力。这里对我们而言，我们只关注一个 arch_call_rest_init 函数。下面我们就来研究它。 如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="14254"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14255"><span data-slate-object="text" data-key="14256"><span data-slate-leaf="true" data-offset-key="14256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14257"><span data-slate-leaf="true" data-offset-key="14257:0" data-first-offset="true"><span data-slate-string="true"> __init __weak </span></span></span><span data-slate-object="text" data-key="14258"><span data-slate-leaf="true" data-offset-key="14258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_call_rest_init</span></span></span></span><span data-slate-object="text" data-key="14259"><span data-slate-leaf="true" data-offset-key="14259:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14260"><span data-slate-leaf="true" data-offset-key="14260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="14261"><span data-slate-leaf="true" data-offset-key="14261:0" data-first-offset="true"><span data-slate-string="true">){    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14262"><span data-slate-object="text" data-key="14263"><span data-slate-leaf="true" data-offset-key="14263:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14264"><span data-slate-leaf="true" data-offset-key="14264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rest_init</span></span></span></span><span data-slate-object="text" data-key="14265"><span data-slate-leaf="true" data-offset-key="14265:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14266"><span data-slate-object="text" data-key="14267"><span data-slate-leaf="true" data-offset-key="14267:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14268"><span data-slate-object="text" data-key="14269"><span data-slate-leaf="true" data-offset-key="14269:0" data-first-offset="true"><span data-slate-string="true">这个函数其实非常简单，它是一个</span></span></span><span data-slate-object="text" data-key="14270"><span data-slate-leaf="true" data-offset-key="14270:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">包装函数</span></span></span></span><span data-slate-object="text" data-key="14271"><span data-slate-leaf="true" data-offset-key="14271:0" data-first-offset="true"><span data-slate-string="true">，其中只是直接调用了 rest_init 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14272"><span data-slate-object="text" data-key="14273"><span data-slate-leaf="true" data-offset-key="14273:0" data-first-offset="true"><span data-slate-string="true">rest_init 函数的重要功能就是建立了两个 Linux 内核线程，我们看看精简后的 rest_init 函数：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="14274"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14275"><span data-slate-object="text" data-key="14276"><span data-slate-leaf="true" data-offset-key="14276:0" data-first-offset="true"><span data-slate-string="true">noinline </span></span></span><span data-slate-object="text" data-key="14277"><span data-slate-leaf="true" data-offset-key="14277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14278"><span data-slate-leaf="true" data-offset-key="14278:0" data-first-offset="true"><span data-slate-string="true"> __ref rest_init(</span></span></span><span data-slate-object="text" data-key="14279"><span data-slate-leaf="true" data-offset-key="14279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14280"><span data-slate-leaf="true" data-offset-key="14280:0" data-first-offset="true"><span data-slate-string="true">){    </span></span></span><span data-slate-object="text" data-key="14281"><span data-slate-leaf="true" data-offset-key="14281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14282"><span data-slate-leaf="true" data-offset-key="14282:0" data-first-offset="true"><span data-slate-string="true"> task_struct *tsk;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14283"><span data-slate-object="text" data-key="14284"><span data-slate-leaf="true" data-offset-key="14284:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14285"><span data-slate-leaf="true" data-offset-key="14285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14286"><span data-slate-leaf="true" data-offset-key="14286:0" data-first-offset="true"><span data-slate-string="true"> pid;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14287"><span data-slate-object="text" data-key="14288"><span data-slate-leaf="true" data-offset-key="14288:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14289"><span data-slate-leaf="true" data-offset-key="14289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 kernel_init 线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14290"><span data-slate-object="text" data-key="14291"><span data-slate-leaf="true" data-offset-key="14291:0" data-first-offset="true"><span data-slate-string="true">    pid = kernel_thread(kernel_init, </span></span></span><span data-slate-object="text" data-key="14292"><span data-slate-leaf="true" data-offset-key="14292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14293"><span data-slate-leaf="true" data-offset-key="14293:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="14294"><span data-slate-leaf="true" data-offset-key="14294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLONE_FS</span></span></span></span><span data-slate-object="text" data-key="14295"><span data-slate-leaf="true" data-offset-key="14295:0" data-first-offset="true"><span data-slate-string="true">);   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14296"><span data-slate-object="text" data-key="14297"><span data-slate-leaf="true" data-offset-key="14297:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14298"><span data-slate-leaf="true" data-offset-key="14298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 khreadd 线程 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14299"><span data-slate-object="text" data-key="14300"><span data-slate-leaf="true" data-offset-key="14300:0" data-first-offset="true"><span data-slate-string="true">    pid = kernel_thread(kthreadd, </span></span></span><span data-slate-object="text" data-key="14301"><span data-slate-leaf="true" data-offset-key="14301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14302"><span data-slate-leaf="true" data-offset-key="14302:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="14303"><span data-slate-leaf="true" data-offset-key="14303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLONE_FS</span></span></span></span><span data-slate-object="text" data-key="14304"><span data-slate-leaf="true" data-offset-key="14304:0" data-first-offset="true"><span data-slate-string="true"> | </span></span></span><span data-slate-object="text" data-key="14305"><span data-slate-leaf="true" data-offset-key="14305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLONE_FILES</span></span></span></span><span data-slate-object="text" data-key="14306"><span data-slate-leaf="true" data-offset-key="14306:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14307"><span data-slate-object="text" data-key="14308"><span data-slate-leaf="true" data-offset-key="14308:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14309"><span data-slate-object="text" data-key="14310"><span data-slate-leaf="true" data-offset-key="14310:0" data-first-offset="true"><span data-slate-string="true">Linux 内核线程可以执行一个内核函数， 只不过这个函数有独立的线程上下文，可以被 Linux 的进程调度器调度，对于 kernel_init 线程来说，执行的就是 kernel_init 函数。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14311" id="sr-toc-11"><span data-slate-object="text" data-key="14312"><span data-slate-leaf="true" data-offset-key="14312:0" data-first-offset="true"><span data-slate-string="true">Linux 的第一个用户进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14313"><span data-slate-object="text" data-key="14314"><span data-slate-leaf="true" data-offset-key="14314:0" data-first-offset="true"><span data-slate-string="true">当我们可以建立第一个用户进程的时候，就代表 Linux 内核的初始流程已经基本完成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14315"><span data-slate-object="text" data-key="14316"><span data-slate-leaf="true" data-offset-key="14316:0" data-first-offset="true"><span data-slate-string="true">经历了 “长途跋涉”，我们也终于走到了这里</span></span></span><span data-slate-object="text" data-key="14317"><span data-slate-leaf="true" data-offset-key="14317:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">。Linux 内核的第一个用户态进程是在 kernel_init 线程建立的，而 kernel_init 线程执行的就是 kernel_init 函数。</span></span></span></span><span data-slate-object="text" data-key="14318"><span data-slate-leaf="true" data-offset-key="14318:0" data-first-offset="true"><span data-slate-string="true">那 kernel_init 函数到底做了什么呢？</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="14319"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14320"><span data-slate-object="text" data-key="14321"><span data-slate-leaf="true" data-offset-key="14321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="14322"><span data-slate-leaf="true" data-offset-key="14322:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14323"><span data-slate-leaf="true" data-offset-key="14323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14324"><span data-slate-leaf="true" data-offset-key="14324:0" data-first-offset="true"><span data-slate-string="true"> __ref </span></span></span><span data-slate-object="text" data-key="14325"><span data-slate-leaf="true" data-offset-key="14325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kernel_init</span></span></span></span><span data-slate-object="text" data-key="14326"><span data-slate-leaf="true" data-offset-key="14326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="14327"><span data-slate-leaf="true" data-offset-key="14327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="14328"><span data-slate-leaf="true" data-offset-key="14328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *unused)</span></span></span></span><span data-slate-object="text" data-key="14329"><span data-slate-leaf="true" data-offset-key="14329:0" data-first-offset="true"><span data-slate-string="true">{   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14330"><span data-slate-object="text" data-key="14331"><span data-slate-leaf="true" data-offset-key="14331:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="14332"><span data-slate-leaf="true" data-offset-key="14332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14333"><span data-slate-leaf="true" data-offset-key="14333:0" data-first-offset="true"><span data-slate-string="true"> ret;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14334"><span data-slate-object="text" data-key="14335"><span data-slate-leaf="true" data-offset-key="14335:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="14336"><span data-slate-leaf="true" data-offset-key="14336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14337"><span data-slate-leaf="true" data-offset-key="14337:0" data-first-offset="true"><span data-slate-string="true"> (ramdisk_execute_command) {       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14338"><span data-slate-object="text" data-key="14339"><span data-slate-leaf="true" data-offset-key="14339:0" data-first-offset="true"><span data-slate-string="true">         ret = run_init_process(ramdisk_execute_command);        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14340"><span data-slate-object="text" data-key="14341"><span data-slate-leaf="true" data-offset-key="14341:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="14342"><span data-slate-leaf="true" data-offset-key="14342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14343"><span data-slate-leaf="true" data-offset-key="14343:0" data-first-offset="true"><span data-slate-string="true"> (!ret)            </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14344"><span data-slate-object="text" data-key="14345"><span data-slate-leaf="true" data-offset-key="14345:0" data-first-offset="true"><span data-slate-string="true">             </span></span></span><span data-slate-object="text" data-key="14346"><span data-slate-leaf="true" data-offset-key="14346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14347"><span data-slate-leaf="true" data-offset-key="14347:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14348"><span data-slate-leaf="true" data-offset-key="14348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14349"><span data-slate-leaf="true" data-offset-key="14349:0" data-first-offset="true"><span data-slate-string="true">;        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14350"><span data-slate-object="text" data-key="14351"><span data-slate-leaf="true" data-offset-key="14351:0" data-first-offset="true"><span data-slate-string="true">         pr_err(</span></span></span><span data-slate-object="text" data-key="14352"><span data-slate-leaf="true" data-offset-key="14352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Failed to execute %s (error %d)\n"</span></span></span></span><span data-slate-object="text" data-key="14353"><span data-slate-leaf="true" data-offset-key="14353:0" data-first-offset="true"><span data-slate-string="true">,ramdisk_execute_command, ret);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14354"><span data-slate-object="text" data-key="14355"><span data-slate-leaf="true" data-offset-key="14355:0" data-first-offset="true"><span data-slate-string="true">     }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14356"><span data-slate-object="text" data-key="14357"><span data-slate-leaf="true" data-offset-key="14357:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="14358"><span data-slate-leaf="true" data-offset-key="14358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14359"><span data-slate-leaf="true" data-offset-key="14359:0" data-first-offset="true"><span data-slate-string="true"> (execute_command) {        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14360"><span data-slate-object="text" data-key="14361"><span data-slate-leaf="true" data-offset-key="14361:0" data-first-offset="true"><span data-slate-string="true">         ret = run_init_process(execute_command);        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14362"><span data-slate-object="text" data-key="14363"><span data-slate-leaf="true" data-offset-key="14363:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="14364"><span data-slate-leaf="true" data-offset-key="14364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14365"><span data-slate-leaf="true" data-offset-key="14365:0" data-first-offset="true"><span data-slate-string="true"> (!ret)            </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14366"><span data-slate-object="text" data-key="14367"><span data-slate-leaf="true" data-offset-key="14367:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="14368"><span data-slate-leaf="true" data-offset-key="14368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14369"><span data-slate-leaf="true" data-offset-key="14369:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14370"><span data-slate-leaf="true" data-offset-key="14370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14371"><span data-slate-leaf="true" data-offset-key="14371:0" data-first-offset="true"><span data-slate-string="true">;        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14372"><span data-slate-object="text" data-key="14373"><span data-slate-leaf="true" data-offset-key="14373:0" data-first-offset="true"><span data-slate-string="true">         panic(</span></span></span><span data-slate-object="text" data-key="14374"><span data-slate-leaf="true" data-offset-key="14374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Requested init %s failed (error %d)."</span></span></span></span><span data-slate-object="text" data-key="14375"><span data-slate-leaf="true" data-offset-key="14375:0" data-first-offset="true"><span data-slate-string="true">,              execute_command, ret);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14376"><span data-slate-object="text" data-key="14377"><span data-slate-leaf="true" data-offset-key="14377:0" data-first-offset="true"><span data-slate-string="true">     }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14378"><span data-slate-object="text" data-key="14379"><span data-slate-leaf="true" data-offset-key="14379:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14380"><span data-slate-leaf="true" data-offset-key="14380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14381"><span data-slate-leaf="true" data-offset-key="14381:0" data-first-offset="true"><span data-slate-string="true"> (!try_to_run_init_process(</span></span></span><span data-slate-object="text" data-key="14382"><span data-slate-leaf="true" data-offset-key="14382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/sbin/init"</span></span></span></span><span data-slate-object="text" data-key="14383"><span data-slate-leaf="true" data-offset-key="14383:0" data-first-offset="true"><span data-slate-string="true">) ||                    !try_to_run_init_process(</span></span></span><span data-slate-object="text" data-key="14384"><span data-slate-leaf="true" data-offset-key="14384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/etc/init"</span></span></span></span><span data-slate-object="text" data-key="14385"><span data-slate-leaf="true" data-offset-key="14385:0" data-first-offset="true"><span data-slate-string="true">) ||        !try_to_run_init_process(</span></span></span><span data-slate-object="text" data-key="14386"><span data-slate-leaf="true" data-offset-key="14386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/bin/init"</span></span></span></span><span data-slate-object="text" data-key="14387"><span data-slate-leaf="true" data-offset-key="14387:0" data-first-offset="true"><span data-slate-string="true">) ||        !try_to_run_init_process(</span></span></span><span data-slate-object="text" data-key="14388"><span data-slate-leaf="true" data-offset-key="14388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/bin/sh"</span></span></span></span><span data-slate-object="text" data-key="14389"><span data-slate-leaf="true" data-offset-key="14389:0" data-first-offset="true"><span data-slate-string="true">))        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14390"><span data-slate-object="text" data-key="14391"><span data-slate-leaf="true" data-offset-key="14391:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14392"><span data-slate-leaf="true" data-offset-key="14392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14393"><span data-slate-leaf="true" data-offset-key="14393:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14394"><span data-slate-leaf="true" data-offset-key="14394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14395"><span data-slate-leaf="true" data-offset-key="14395:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14396"><span data-slate-object="text" data-key="14397"><span data-slate-leaf="true" data-offset-key="14397:0" data-first-offset="true"><span data-slate-string="true">panic(</span></span></span><span data-slate-object="text" data-key="14398"><span data-slate-leaf="true" data-offset-key="14398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"No working init found.  Try passing init= option to kernel."</span></span></span></span><span data-slate-object="text" data-key="14399"><span data-slate-leaf="true" data-offset-key="14399:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14400"><span data-slate-leaf="true" data-offset-key="14400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"See Linux Documentation/admin-guide/init.rst for guidance."</span></span></span></span><span data-slate-object="text" data-key="14401"><span data-slate-leaf="true" data-offset-key="14401:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14402"><span data-slate-object="text" data-key="14403"><span data-slate-leaf="true" data-offset-key="14403:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14404"><span data-slate-object="text" data-key="14405"><span data-slate-leaf="true" data-offset-key="14405:0" data-first-offset="true"><span data-slate-string="true">结合上述代码，可以发现 ramdisk_execute_command 和 execute_command 都是内核启动时传递的参数，它们可以在 GRUB 启动选项中设置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14406"><span data-slate-object="text" data-key="14407"><span data-slate-leaf="true" data-offset-key="14407:0" data-first-offset="true"><span data-slate-string="true">比方说，通常引导内核时向 command line 传递的参数都是 init=xxx ，而对于 initrd 则是传递 rdinit=xxx 。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14408"><span data-slate-object="text" data-key="14409"><span data-slate-leaf="true" data-offset-key="14409:0" data-first-offset="true"><span data-slate-string="true">但是，通常我们不会传递参数，所以这个函数会执行到上述代码的 15 行，依次尝试以 /sbin/init、/etc/init、/bin/init、/bin/sh 这些文件为可执行文件建立进程，但是只要其中之一成功就行了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14410"><span data-slate-object="text" data-key="14411"><span data-slate-leaf="true" data-offset-key="14411:0" data-first-offset="true"><span data-slate-string="true">try_to_run_init_process 和 run_init_process 函数的核心都是调用 sys_fork 函数建立进程的，这里我们不用关注它的实现细节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14412"><span data-slate-object="text" data-key="14413"><span data-slate-leaf="true" data-offset-key="14413:0" data-first-offset="true"><span data-slate-string="true">到这里，Linux 内核已经建立了第一个进程，Linux 内核的初始化流程也到此为止了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14414" id="sr-toc-12"><span data-slate-object="text" data-key="14415"><span data-slate-leaf="true" data-offset-key="14415:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14416"><span data-slate-object="text" data-key="14417"><span data-slate-leaf="true" data-offset-key="14417:0" data-first-offset="true"><span data-slate-string="true">又到了课程尾声，Linux 初始化流程的学习我们就告一段落了，我来给你做个总结。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14418"><span data-slate-object="text" data-key="14419"><span data-slate-leaf="true" data-offset-key="14419:0" data-first-offset="true"><span data-slate-string="true">今天我们讲得内容有点多，我们从 _start 开始到 startup32、startup64 函数 ，到 extract_kernel 函数解压出真正的 Linux 内核文件 vmlinux 开始，然后从 Linux 内核的入口函数 startup_64 到 Linux 内核第一个 C 函数，最后接着从 Linux 内核 start_kernel 函数的建立 ，说到了第一个用户进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14420"><span data-slate-object="text" data-key="14421"><span data-slate-leaf="true" data-offset-key="14421:0" data-first-offset="true"><span data-slate-string="true">一起来回顾一下这节课的重点：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14422"><span data-slate-object="text" data-key="14423"><span data-slate-leaf="true" data-offset-key="14423:0" data-first-offset="true"><span data-slate-string="true">1.GRUB 加载 vmlinuz 文件之后，会把控制权交给 vmlinuz 文件的 setup.bin 的部分中 _start，它会设置好栈，清空 bss，设置好 setup_header 结构，调用 16 位 main 切换到保护模式，最后跳转到 1MB 处的 vmlinux.bin 文件中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14424"><span data-slate-object="text" data-key="14425"><span data-slate-leaf="true" data-offset-key="14425:0" data-first-offset="true"><span data-slate-string="true">2. 从 vmlinux.bin 文件中 startup32、startup64 函数开始建立新的全局段描述符表和 MMU 页表，切换到长模式下解压 vmlinux.bin.gz。释放出 vmlinux 文件之后，由解析 elf 格式的函数进行解析，释放 vmlinux 中的代码段和数据段到指定的内存。然后调用其中的 startup_64 函数，在这个函数的最后调用 Linux 内核的第一个 C 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14426"><span data-slate-object="text" data-key="14427"><span data-slate-leaf="true" data-offset-key="14427:0" data-first-offset="true"><span data-slate-string="true">3.Linux 内核第一个 C 函数重新设置 MMU 页表，随后便调用了最有名的 start_kernel 函数， start_kernel 函数中调用了大多数 Linux 内核功能性初始化函数，在最后调用 rest_init 函数建立了两个内核线程，在其中的 kernel_init 线程建立了第一个用户态进程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14428"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/09/58/0910c3a68df6dde27b511cf13f85d158.jpg?wh=3245*1638"></div><div>Linux 初始化要点示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14429"><span data-slate-object="text" data-key="14430"><span data-slate-leaf="true" data-offset-key="14430:0" data-first-offset="true"><span data-slate-string="true">不知道你感觉到没有，Linux 的启动流程相比于我们的 Cosmos 启动流程复杂得多。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14431"><span data-slate-object="text" data-key="14432"><span data-slate-leaf="true" data-offset-key="14432:0" data-first-offset="true"><span data-slate-string="true">Linux 之所以如此复杂，是因为它把完成各种功能的模块组装了一起，而我们 Cosmos 则把内核之前的初始化工作，分离出来，形成二级引导器，二级引导器也是由多文件模块组成的，最后用我们的映像工具把它们封装在一起。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14433"><span data-slate-object="text" data-key="14434"><span data-slate-leaf="true" data-offset-key="14434:0" data-first-offset="true"><span data-slate-string="true">对比之下，你就可以明白，</span></span></span><span data-slate-object="text" data-key="14435"><span data-slate-leaf="true" data-offset-key="14435:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">软件工程模块化</span></span></span></span><span data-slate-object="text" data-key="14436"><span data-slate-leaf="true" data-offset-key="14436:0" data-first-offset="true"><span data-slate-string="true">是多么重要了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14437" id="sr-toc-13"><span data-slate-object="text" data-key="14438"><span data-slate-leaf="true" data-offset-key="14438:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14439"><span data-slate-object="text" data-key="14440"><span data-slate-leaf="true" data-offset-key="14440:0" data-first-offset="true"><span data-slate-string="true">你能指出上文中 Linux 初始化流程里，主要函数都被链接到哪些对应的二进制文件中了？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14441"><span data-slate-object="text" data-key="14442"><span data-slate-leaf="true" data-offset-key="14442:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我交流互动，也欢迎你把这节课分享给同事、朋友。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14443"><span data-slate-object="text" data-key="14444"><span data-slate-leaf="true" data-offset-key="14444:0" data-first-offset="true"><span data-slate-string="true">我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-14">精选留言 (14)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>大体上整理了一下，有问题欢迎帮忙指正【上】：
Grub 在 /boot 目录下找到的 linux 内核，是 bzImage 格式
1、bzImage 格式生成：
1.1、head_64.S + 其他源文件 -&gt; 编译 -&gt; vmlinux【A】
1.2、objcopy 工具拷贝【 拷贝时，删除了文件中 “.comment” 段，符号表和重定位表】-&gt;vmlinux.bin【A】
1.3、gzib 压缩 -&gt;vmlinux.bin.gz
1.4、piggy 打包，附加解压信息 -&gt;piggy.o-&gt; 其他. o 文件一起链接 -&gt;vmlinux【B】
1.5、objcopy 工具拷贝【 拷贝时，删除了文件中 “.comment” 段，符号表和重定位表】-&gt;vmlinux【B】
1.6、head.S +main.c + 其他 -&gt;setup.bin
1.7、setup.bin+vmlinux.bin【B】-&gt;bzImage 合并 -&gt;bzImage

2、GRUB 加载 bzImage 文件
2.1、会将 bzImage 的 setup.bin 加载到内存地址 0x90000 处
2.2、把 vmlinuz 中的 vmlinux.bin 部分，加载到 1MB 开始的内存地址

3、GRUB 会继续执行 setup.bin 代码，入口在 header.S【arch/x86/boot/header.S】
GRUB 会填充 linux 内核的一个 setup_header 结构，将内核启动需要的信息，写入到内核中对应位置，而且 GRUB 自身也维护了一个相似的结构。
Header.S 文件中从 start_of_setup 开始，其实就是这个 setup_header 的结构。
此外， bootparam.h 有这个结构的 C 语言定义，会从 Header.S 中把数据拷贝到结构体中，方便后续使用。

4、GRUB 然后会跳转到 0x90200 开始执行【恰好跳过了最开始 512 字节的 bootsector】，正好是 head.S 的_start 这个位置；

5、在 head.S 最后，调用 main 函数继续执行

6、main 函数【 arch/x86/boot/main.c】【16 位实模式】
6.1、拷贝 header.S 中 setup_header 结构，到 boot_params【arch\x86\include\uapi\asm\bootparam.h】
6.2、调用 BIOS 中断，进行初始化设置，包括 console、堆、CPU 模式、内存、键盘、APM、显卡模式等
6.3、调用 go_to_protected_mode 进入保护模式

7、 go_to_protected_mode 函数【 arch/x86/boot/pm.c】
7.1、安装实模式切换钩子
7.2、启用 1M 以上内存
7.3、设置中断描述符表 IDT
7.4、设置全局描述符表 GDT
7.4、protected_mode_jump，跳转到 boot_params.hdr.code32_start【保护模式下，长跳转，地址为 0x100000】 

8、恰好是 vmlinux.bin 在内存中的位置，通过这一跳转，正式进入 vmlinux.bin

9、startup_32【 arch/x86/boot/compressed/head64.S】
全局描述符 GDT
加载段描述符
设置栈
检查 CPU 是否支持长模式
开启 PAE
建立 MMU【4 级，4G】
开启长模式
段描述符和 startup_64 地址入栈
开启分页和保护模式
弹出段描述符和 startup_64 地址到 CS：RIP 中，进入长模式

10、 startup_64【 arch/x86/boot/compressed/head64.S】
初始化寄存器
初始化栈
调准给 MMU 级别
压缩内核移动到 Buffer 最后
调用. Lrelocated

11、.Lrelocated
申请内存
被解压数据开始地址
被解压数据长度
解压数据开始地址
解压后数据长度
调用 extract_kernel 解压内核

12、extract_kernel 解压内核【 arch/x86/boot/compressed/misc.c】
保存 boot_params
解压内核
解析 ELF，处理重定向， 把 vmlinux 中的指令段、数据段、BSS 段，根据 elf 中信息和要求放入特定的内存空间
返回了解压后内核地址，保存到 % rax

13、返回到. Lrelocated 继续执行
跳转到 % rax【解压后内核地址】，继续执行
解压后的内核文件，入口函数为【arch/x86/kernel/head_64.S】</div><div><p>作者回复：学习非常认真啊 </p></div><div><div>2021-06-12</div><div><div><i></i><span>2</span></div><div><i></i><span>24</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>大体上整理了一下，有问题欢迎帮忙指正【下】：
14、SYM_CODE_START_NOALIGN (startup_64)【arch/x86/kernel/head_64.S】
SMP 系统加电之后，总线仲裁机制会选出多个 CPU 中的一个 CPU，称为 BSP，也叫第一个 CPU。它负责让 BSP CPU 先启动，其它 CPU 则等待 BSP CPU 的唤醒。
第一个启动的 CPU，会跳转 secondary_startup_64 函数中 1 标号处，对于其它被唤醒的 CPU 则会直接执行 secondary_startup_64 函数。

15、secondary_startup_64 函数【arch/x86/kernel/head_64.S】
各类初始化工作，gdt、描述符等
跳转到 initial_code，也就是 x86_64_start_kernel

16、 x86_64_start_kernel【 arch/x86/kernel/head64.c】
各类初始化工作，清理 bss 段，清理页目录，复制引导信息等
调用 x86_64_start_reservations

17、x86_64_start_reservations【 arch/x86/kernel/head64.c】
调用 start_kernel ();

18、start_kernel【 init/main.c】
各类初始化：ARCH、日志、陷阱门、内存、调度器、工作队列、RCU 锁、Trace 事件、IRQ 中断、定时器、软中断、ACPI、fork、缓存、安全、pagecache、信号量、cpuset、cgroup 等等
调用 arch_call_rest_init，调用到 rest_init

19、rest_init【 init/main.c】
kernel_thread，调用_do_fork，创建了 kernel_init 进程，pid=1 . 是系统中所有其它用户进程的祖先
kernel_thread，调用_do_fork，创建了 kernel_thread 进程，pid=2， 负责所有内核线程的调度和管理
【最后当前的进程， 会变成 idle 进程，pid=0】

20、kernel_init
根据内核启动参数，调用 run_init_process，创建对应进程
调用 try_to_run_init_process 函数，尝试以 /sbin/init、/etc/init、/bin/init、/bin/sh 这些文件为可执行文件建立 init 进程，只要其中之一成功就可以

调用链如下：
try_to_run_init_process
run_init_process
kernel_execve
bprm_execve
exec_binprm
search_binary_handler-》依次尝试按各种可执行文件格式进行加载，而 ELF 的处理函数为 load_elf_binary
load_elf_binary
start_thread
start_thread_common，会将寄存器地址，设置为 ELF 启动地址
当从系统调用返回用户态时，init 进程【1 号进程】，就从 ELF 执行了

到此为止，系统的启动过程结束。</div><div><p>作者回复：是的 大写 6666</p></div><div><div>2021-06-12</div><div><div><i></i><span>2</span></div><div><i></i><span>12</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>_start 在 setup.bin 的开头， x86_64_start_kernel 在 vmlinux.bin 的开头，然后 start_kernel 初始化，然后 rest_init 初始化第一个用户进程和第一个内核进程，开始操作系统罪恶的一生。</div><div><p>作者回复：哈哈 </p></div><div><div>2021-06-11</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlaNica7xRH6LlMNJtrbK0toc1od8YdqLZOD2AbnOZ2QyKC13gvrrL9cOx5dyYNcsHnJkR6K4ibxZQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_59a6f9</span></div></div><div>老师，你这里说的 grub 是 grub legacy 还是 grub2 啊？grub2 应该首先会进入保护模式，那 grub2 还会跳转到 inux/arch/x86/boot/head.S 里的 main 函数 再去执行一次切换保护模式吗？这个时候应该早就是保护模式了吧</div><div><p>作者回复：是的 ，但是 Linux 并不用 GRUB 初始化的保护模式</p></div><div><div>2021-06-24</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 青玉白露</span></div></div><div>课程已经快进入正题了，下一步就是内存了吧</div><div><p>编辑回复：是的，下个模块是内存管理，更加有挑战性，敬请期待！</p></div><div><div>2021-07-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>收获盛大，终于看到了稍微能消化的一篇了</div><div><p>作者回复：你好，你平常接触 Linux 吧</p></div><div><div>2021-06-11</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div></div><div>这个问题是考对 Linux 熟悉程度了。哈</div><div><p>作者回复：这很难吗 </p></div><div><div>2021-06-11</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/5f/09/2ec44412.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Qfeng</span></div></div><div>内核启动最后创建了两个进程：kernel_init 和 kernel_thread，前面是第一个用户进程，后续用户进程都是从它 fork 而来，后面是内核进程，用来管理后续内核线程调度。这两个进程令我印象深刻。
</div><div><p>作者回复: 666666</p></div><div><div>2022-06-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>艾恩凝</span></div></div><div>这节终于结束了，计划俩月完成，感觉进度有点慢了，到现在快 20 天了，应该去年来参与这门课的</div><div><p>编辑回复：相逢即有缘，现在跟进也不迟，有什么收获或疑问欢迎多多分享哦 (ง・̀_・́)ง</p></div><div><div>2022-04-10</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>if...else...</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>果然厉害了</div><div><p>作者回复：什么厉害了</p></div><div><div>2022-02-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/ef/18/6a620733.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>王子玉</span></div></div><div>请问为什么有两个重名的 startup_64 啊  名字不回冲突么</div><div><p>作者回复：编译时会处理的</p></div><div><div>2021-12-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/cabLXAUXiavXnEckAgo971o4l1CxP4L9wOV2eUGTyKBUicTib6gJyKV9iatM4GG1scz5Ym17GOzXWQEGzhE31tXUtQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>日就月将</span></div></div><div>老师，自动编译配置文件里有修改 grub menuentry 选项吗 要是想修改在哪里改啊</div><div><p>作者回复：没有</p></div><div><div>2021-11-02</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/82/3e/1fc6e36a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>zlig</span></div></div><div>还是不理解为啥 linux 要把 vmlinux.bin 压缩这么多次。</div><div><div>2021-09-19</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlaNica7xRH6LlMNJtrbK0toc1od8YdqLZOD2AbnOZ2QyKC13gvrrL9cOx5dyYNcsHnJkR6K4ibxZQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_59a6f9</span></div></div><div>老师，对于非 boot cpu 的启动不是很清楚。是 BSP 启动以后发一个中断唤醒其他 cpu，然后执行到 secondary_startup_64 吗？接着还是会去执行 start_kernel? 可是我们主 cpu 已经初始化内核里内存部分了，其他 cpu 再去执行的话就会有问题吧？</div><div><p>作者回复：只有 BSP 会执行 start_kernel</p></div><div><div>2021-06-19</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1d"><outline class="toc-level-h1" data-reactid=".1d.0" style="width: 175px;"><active data-reactid=".1d.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1d.0.1"><span data-reactid=".1d.0.1.0"> 15 | Linux 初始化（下）：从_start 到第一个进程</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.1" style="width: 165px;"><active data-reactid=".1d.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1d.1.1"><span data-reactid=".1d.1.1.0">解压后内核初始化</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.2" style="width: 155px;"><active data-reactid=".1d.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1d.2.1"><span data-reactid=".1d.2.1.0">为何要从 _start 开始</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.3" style="width: 155px;"><active data-reactid=".1d.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1d.3.1"><span data-reactid=".1d.3.1.0">setup_header 结构</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.4" style="width: 155px;"><active data-reactid=".1d.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1d.4.1"><span data-reactid=".1d.4.1.0">16 位的 main 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.5" style="width: 155px;"><active data-reactid=".1d.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1d.5.1"><span data-reactid=".1d.5.1.0">startup_32 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.6" style="width: 155px;"><active data-reactid=".1d.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1d.6.1"><span data-reactid=".1d.6.1.0">startup_64 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.7" style="width: 155px;"><active data-reactid=".1d.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1d.7.1"><span data-reactid=".1d.7.1.0">extract_kernel 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.8" style="width: 155px;"><active data-reactid=".1d.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1d.8.1"><span data-reactid=".1d.8.1.0">Linux 内核的 startup_64</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.9" style="width: 165px;"><active data-reactid=".1d.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1d.9.1"><span data-reactid=".1d.9.1.0">Linux 内核的第一个 C 函数</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.a" style="width: 165px;"><active data-reactid=".1d.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1d.a.1"><span data-reactid=".1d.a.1.0">有名的 start_kernel 函数</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.b" style="width: 165px;"><active data-reactid=".1d.b.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1d.b.1"><span data-reactid=".1d.b.1.0">Linux 的第一个用户进程</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.c" style="width: 165px;"><active data-reactid=".1d.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".1d.c.1"><span data-reactid=".1d.c.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.d" style="width: 165px;"><active data-reactid=".1d.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".1d.d.1"><span data-reactid=".1d.d.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.e" style="width: 165px;"><active data-reactid=".1d.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".1d.e.1"><span data-reactid=".1d.e.1.0">精选留言 (14)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/383611" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>