
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 第 22 讲 | AtomicInteger 底层实现原理是什么？如何在自己的产品代码中应用 CAS 操作？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>第 22 讲 | AtomicInteger 底层实现原理是什么？如何在自己的产品代码中应用 CAS 操作？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">第 22 讲 | AtomicInteger 底层实现原理是什么？如何在自己的产品代码中应用 CAS 操作？</h1><div><span>杨晓峰</span> <span> 2018-06-26</span></div><div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1b/25/1bb240a020054c7f14b30498473fb225.jpg" style="width: auto;"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：黄洲君</span><span>大小：5.06M</span><span> 时长：11:04</span></div></div><audio title="第22讲 | AtomicInteger底层实现原理是什么？如何在自己的产品代码中应用CAS操作？" src="https://res001.geekbang.org/media/audio/1d/ae/1d3d56bddfd62fbcb2f9d0246e01d9ae/ld/ld.m3u8" __idm_id__="1900565"></audio></div><div><div><div><div data-slate-editor="true" data-key="10284" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="10285"><span data-slate-object="text" data-key="10286"><span data-slate-leaf="true" data-offset-key="10286:0" data-first-offset="true"><span data-slate-string="true">在今天这一讲中，我来分析一下并发包内部的组成，</span></span><span data-slate-leaf="true" data-offset-key="10286:1"><span data-slate-object="annotation" data-annotation-key="gkann_15354d4f" data-attr-id="11464" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一起来看看各种同步结构、线程池等，是基于什么原理来设计和实现的。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10287"><span data-slate-object="text" data-key="10288"><span data-slate-leaf="true" data-offset-key="10288:0" data-first-offset="true"><span data-slate-string="true">今天我要问你的问题是，</span></span></span><span data-slate-object="text" data-key="10289"><span data-slate-leaf="true" data-offset-key="10289:0" data-first-offset="true"><span data-slate-type="primary" data-slate-object="mark"><span data-slate-string="true">AtomicInteger 底层实现原理是什么？如何在自己的产品代码中应用 CAS 操作？</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10290" id="sr-toc-1"><span data-slate-object="text" data-key="10291"><span data-slate-leaf="true" data-offset-key="10291:0" data-first-offset="true"><span data-slate-string="true">典型回答</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10292"><span data-slate-object="text" data-key="10293"><span data-slate-leaf="true" data-offset-key="10293:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f5315284" data-attr-id="14215" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">AtomicIntger 是对 int 类型的一个封装，</span></span></span><span data-slate-leaf="true" data-offset-key="10293:1"><span data-slate-object="annotation" data-annotation-key="gkann_82664d27" data-attr-id="19349" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_263c2c10" data-attr-id="19350" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">提供原子性的访问和更新操作，其原子性操作的实现是基于 CAS（</span></span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10294"><span data-slate-object="text" data-key="10295"><span data-slate-leaf="true" data-offset-key="10295:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_82664d27" data-attr-id="19349" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_263c2c10" data-attr-id="19350" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">compare-and-swap</span></span></span></span></span></a><span data-slate-object="text" data-key="10296"><span data-slate-leaf="true" data-offset-key="10296:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_82664d27" data-attr-id="19349" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_263c2c10" data-attr-id="19350" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">）技术。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10297"><span data-slate-object="text" data-key="10298"><span data-slate-leaf="true" data-offset-key="10298:0" data-first-offset="true"><span data-slate-string="true">所谓 CAS，表征的是一系列操作的集合，获取当前数值，进行一些运算，利用 CAS 指令试图进行更新。</span></span><span data-slate-leaf="true" data-offset-key="10298:1"><span data-slate-object="annotation" data-annotation-key="gkann_239037b9" data-attr-id="6811" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_af418644" data-attr-id="40945" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果当前数值未变，代表没有其他线程进行并发修改，则成功更新。否则，可能出现不同的选择，要么进行重试，要么就返回一个成功或者失败的结果。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10299"><span data-slate-object="text" data-key="10300"><span data-slate-leaf="true" data-offset-key="10300:0" data-first-offset="true"><span data-slate-string="true">从 AtomicInteger 的内部属性可以看出，它依赖于 Unsafe 提供的一些底层能力，进行底层操作；以 volatile 的 value 字段，记录数值，以保证可见性。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10301"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10302"><span data-slate-object="text" data-key="10303"><span data-slate-leaf="true" data-offset-key="10303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10304"><span data-slate-leaf="true" data-offset-key="10304:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10305"><span data-slate-leaf="true" data-offset-key="10305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="10306"><span data-slate-leaf="true" data-offset-key="10306:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10307"><span data-slate-leaf="true" data-offset-key="10307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10308"><span data-slate-leaf="true" data-offset-key="10308:0" data-first-offset="true"><span data-slate-string="true"> jdk.internal.misc.</span></span></span><span data-slate-object="text" data-key="10309"><span data-slate-leaf="true" data-offset-key="10309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unsafe</span></span></span></span><span data-slate-object="text" data-key="10310"><span data-slate-leaf="true" data-offset-key="10310:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10311"><span data-slate-leaf="true" data-offset-key="10311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">U</span></span></span></span><span data-slate-object="text" data-key="10312"><span data-slate-leaf="true" data-offset-key="10312:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10313"><span data-slate-leaf="true" data-offset-key="10313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10314"><span data-slate-leaf="true" data-offset-key="10314:0" data-first-offset="true"><span data-slate-string="true"> jdk.internal.misc.Unsafe.getUnsafe();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10315"><span data-slate-object="text" data-key="10316"><span data-slate-leaf="true" data-offset-key="10316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10317"><span data-slate-leaf="true" data-offset-key="10317:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10318"><span data-slate-leaf="true" data-offset-key="10318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="10319"><span data-slate-leaf="true" data-offset-key="10319:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10320"><span data-slate-leaf="true" data-offset-key="10320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10321"><span data-slate-leaf="true" data-offset-key="10321:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10322"><span data-slate-leaf="true" data-offset-key="10322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="10323"><span data-slate-leaf="true" data-offset-key="10323:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10324"><span data-slate-leaf="true" data-offset-key="10324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">VALUE</span></span></span></span><span data-slate-object="text" data-key="10325"><span data-slate-leaf="true" data-offset-key="10325:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10326"><span data-slate-leaf="true" data-offset-key="10326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10327"><span data-slate-leaf="true" data-offset-key="10327:0" data-first-offset="true"><span data-slate-string="true"> U.objectFieldOffset(AtomicInteger.class, </span></span></span><span data-slate-object="text" data-key="10328"><span data-slate-leaf="true" data-offset-key="10328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"value"</span></span></span></span><span data-slate-object="text" data-key="10329"><span data-slate-leaf="true" data-offset-key="10329:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10330"><span data-slate-object="text" data-key="10331"><span data-slate-leaf="true" data-offset-key="10331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10332"><span data-slate-leaf="true" data-offset-key="10332:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10333"><span data-slate-leaf="true" data-offset-key="10333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span><span data-slate-object="text" data-key="10334"><span data-slate-leaf="true" data-offset-key="10334:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10335"><span data-slate-leaf="true" data-offset-key="10335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10336"><span data-slate-leaf="true" data-offset-key="10336:0" data-first-offset="true"><span data-slate-string="true"> value;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10337"><span data-slate-object="text" data-key="10338"><span data-slate-leaf="true" data-offset-key="10338:0" data-first-offset="true"><span data-slate-string="true">具体的原子操作细节，可以参考任意一个原子更新方法，比如下面的 getAndIncrement。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10339"><span data-slate-object="text" data-key="10340"><span data-slate-leaf="true" data-offset-key="10340:0" data-first-offset="true"><span data-slate-string="true">Unsafe 会利用 value 字段的内存地址偏移，直接完成操作。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10341"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10342"><span data-slate-object="text" data-key="10343"><span data-slate-leaf="true" data-offset-key="10343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10344"><span data-slate-leaf="true" data-offset-key="10344:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10345"><span data-slate-leaf="true" data-offset-key="10345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10346"><span data-slate-leaf="true" data-offset-key="10346:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10347"><span data-slate-leaf="true" data-offset-key="10347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10348"><span data-slate-leaf="true" data-offset-key="10348:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10349"><span data-slate-leaf="true" data-offset-key="10349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getAndIncrement</span></span></span></span><span data-slate-object="text" data-key="10350"><span data-slate-leaf="true" data-offset-key="10350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="10351"><span data-slate-leaf="true" data-offset-key="10351:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10352"><span data-slate-object="text" data-key="10353"><span data-slate-leaf="true" data-offset-key="10353:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10354"><span data-slate-leaf="true" data-offset-key="10354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10355"><span data-slate-leaf="true" data-offset-key="10355:0" data-first-offset="true"><span data-slate-string="true"> U.getAndAddInt(</span></span></span><span data-slate-object="text" data-key="10356"><span data-slate-leaf="true" data-offset-key="10356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="10357"><span data-slate-leaf="true" data-offset-key="10357:0" data-first-offset="true"><span data-slate-string="true">, VALUE, </span></span></span><span data-slate-object="text" data-key="10358"><span data-slate-leaf="true" data-offset-key="10358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10359"><span data-slate-leaf="true" data-offset-key="10359:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10360"><span data-slate-object="text" data-key="10361"><span data-slate-leaf="true" data-offset-key="10361:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10362"><span data-slate-object="text" data-key="10363"><span data-slate-leaf="true" data-offset-key="10363:0" data-first-offset="true"><span data-slate-string="true">因为 getAndIncrement 需要返归数值，所以需要添加失败重试逻辑。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10364"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10365"><span data-slate-object="text" data-key="10366"><span data-slate-leaf="true" data-offset-key="10366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10367"><span data-slate-leaf="true" data-offset-key="10367:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10368"><span data-slate-leaf="true" data-offset-key="10368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10369"><span data-slate-leaf="true" data-offset-key="10369:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10370"><span data-slate-leaf="true" data-offset-key="10370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10371"><span data-slate-leaf="true" data-offset-key="10371:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10372"><span data-slate-leaf="true" data-offset-key="10372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getAndAddInt</span></span></span></span><span data-slate-object="text" data-key="10373"><span data-slate-leaf="true" data-offset-key="10373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(Object o, </span></span></span></span><span data-slate-object="text" data-key="10374"><span data-slate-leaf="true" data-offset-key="10374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="10375"><span data-slate-leaf="true" data-offset-key="10375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> offset, </span></span></span></span><span data-slate-object="text" data-key="10376"><span data-slate-leaf="true" data-offset-key="10376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="10377"><span data-slate-leaf="true" data-offset-key="10377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> delta)</span></span></span></span><span data-slate-object="text" data-key="10378"><span data-slate-leaf="true" data-offset-key="10378:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10379"><span data-slate-object="text" data-key="10380"><span data-slate-leaf="true" data-offset-key="10380:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10381"><span data-slate-leaf="true" data-offset-key="10381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10382"><span data-slate-leaf="true" data-offset-key="10382:0" data-first-offset="true"><span data-slate-string="true"> v;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10383"><span data-slate-object="text" data-key="10384"><span data-slate-leaf="true" data-offset-key="10384:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10385"><span data-slate-leaf="true" data-offset-key="10385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">do</span></span></span></span><span data-slate-object="text" data-key="10386"><span data-slate-leaf="true" data-offset-key="10386:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10387"><span data-slate-object="text" data-key="10388"><span data-slate-leaf="true" data-offset-key="10388:0" data-first-offset="true"><span data-slate-string="true">        v = getIntVolatile(o, offset);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10389"><span data-slate-object="text" data-key="10390"><span data-slate-leaf="true" data-offset-key="10390:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="10391"><span data-slate-leaf="true" data-offset-key="10391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="10392"><span data-slate-leaf="true" data-offset-key="10392:0" data-first-offset="true"><span data-slate-string="true"> (!weakCompareAndSetInt(o, offset, v, v + delta));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10393"><span data-slate-object="text" data-key="10394"><span data-slate-leaf="true" data-offset-key="10394:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10395"><span data-slate-leaf="true" data-offset-key="10395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10396"><span data-slate-leaf="true" data-offset-key="10396:0" data-first-offset="true"><span data-slate-string="true"> v;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10397"><span data-slate-object="text" data-key="10398"><span data-slate-leaf="true" data-offset-key="10398:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10399"><span data-slate-object="text" data-key="10400"><span data-slate-leaf="true" data-offset-key="10400:0" data-first-offset="true"><span data-slate-string="true">而类似 compareAndSet 这种返回 boolean 类型的函数，因为其返回值表现的就是成功与否，所以不需要重试。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10401"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10402"><span data-slate-object="text" data-key="10403"><span data-slate-leaf="true" data-offset-key="10403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10404"><span data-slate-leaf="true" data-offset-key="10404:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10405"><span data-slate-leaf="true" data-offset-key="10405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10406"><span data-slate-leaf="true" data-offset-key="10406:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10407"><span data-slate-leaf="true" data-offset-key="10407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">boolean</span></span></span></span><span data-slate-object="text" data-key="10408"><span data-slate-leaf="true" data-offset-key="10408:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10409"><span data-slate-leaf="true" data-offset-key="10409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">compareAndSet</span></span></span></span><span data-slate-object="text" data-key="10410"><span data-slate-leaf="true" data-offset-key="10410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="10411"><span data-slate-leaf="true" data-offset-key="10411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="10412"><span data-slate-leaf="true" data-offset-key="10412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> expectedValue, </span></span></span></span><span data-slate-object="text" data-key="10413"><span data-slate-leaf="true" data-offset-key="10413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="10414"><span data-slate-leaf="true" data-offset-key="10414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> newValue)</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10415"><span data-slate-object="text" data-key="10416"><span data-slate-leaf="true" data-offset-key="10416:0" data-first-offset="true"><span data-slate-string="true">CAS 是 Java 并发中所谓 lock-free 机制的基础。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10417" id="sr-toc-2"><span data-slate-object="text" data-key="10418"><span data-slate-leaf="true" data-offset-key="10418:0" data-first-offset="true"><span data-slate-string="true">考点分析</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10419"><span data-slate-object="text" data-key="10420"><span data-slate-leaf="true" data-offset-key="10420:0" data-first-offset="true"><span data-slate-string="true">今天的问题有点偏向于 Java 并发机制的底层了，虽然我们在开发中未必会涉及 CAS 的实现层面，但是理解其机制，掌握如何在 Java 中运用该技术，还是十分有必要的，尤其是这也是个并发编程的面试热点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10421"><span data-slate-object="text" data-key="10422"><span data-slate-leaf="true" data-offset-key="10422:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7adcfce9" data-attr-id="22666" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">有的同学反馈面试官会问 CAS 更加底层是如何实现的，这依赖于 CPU 提供的特定指令，具体根据体系结构的不同还存在着明显区别。比如，x86 CPU 提供 cmpxchg 指令；而在精简指令集的体系架构中，则通常是靠一对儿指令（如 “load and reserve” 和 “store conditional”）实现的，在大多数处理器上 CAS 都是个非常轻量级的操作，这也是其优势所在。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10423"><span data-slate-object="text" data-key="10424"><span data-slate-leaf="true" data-offset-key="10424:0" data-first-offset="true"><span data-slate-string="true">大部分情况下，掌握到这个程度也就够用了，我认为没有必要让每个 Java 工程师都去了解到指令级别，我们进行抽象、分工就是为了让不同层面的开发者在开发中，可以尽量屏蔽不相关的细节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10425"><span data-slate-object="text" data-key="10426"><span data-slate-leaf="true" data-offset-key="10426:0" data-first-offset="true"><span data-slate-string="true">如果我作为面试官，很有可能深入考察这些方向：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10427"><div data-slate-type="list-line" data-slate-object="block" data-key="10428"><span data-slate-object="text" data-key="10429"><span data-slate-leaf="true" data-offset-key="10429:0" data-first-offset="true"><span data-slate-string="true">在什么场景下，可以采用 CAS 技术，调用 Unsafe 毕竟不是大多数场景的最好选择，有没有更加推荐的方式呢？毕竟我们掌握一个技术，cool 不是目的，更不是为了应付面试，我们还是希望能在实际产品中有价值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10430"><span data-slate-object="text" data-key="10431"><span data-slate-leaf="true" data-offset-key="10431:0" data-first-offset="true"><span data-slate-string="true">对 ReentrantLock、CyclicBarrier 等并发结构底层的实现技术的理解。</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10432" id="sr-toc-3"><span data-slate-object="text" data-key="10433"><span data-slate-leaf="true" data-offset-key="10433:0" data-first-offset="true"><span data-slate-string="true">知识扩展</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10434"><span data-slate-object="text" data-key="10435"><span data-slate-leaf="true" data-offset-key="10435:0" data-first-offset="true"><span data-slate-string="true">关于 CAS 的使用，你可以设想这样一个场景：在数据库产品中，为保证索引的一致性，一个常见的选择是，保证只有一个线程能够排他性地修改一个索引分区，如何在数据库抽象层面实现呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10436"><span data-slate-object="text" data-key="10437"><span data-slate-leaf="true" data-offset-key="10437:0" data-first-offset="true"><span data-slate-string="true">可以考虑为索引分区对象添加一个逻辑上的锁，例如，以当前独占的线程 ID 作为锁的数值，然后通过原子操作设置 lock 数值，来实现加锁和释放锁，伪代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10438"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10439"><span data-slate-object="text" data-key="10440"><span data-slate-leaf="true" data-offset-key="10440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10441"><span data-slate-leaf="true" data-offset-key="10441:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10442"><span data-slate-leaf="true" data-offset-key="10442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="10443"><span data-slate-leaf="true" data-offset-key="10443:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10444"><span data-slate-leaf="true" data-offset-key="10444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AtomicBTreePartition</span></span></span></span><span data-slate-object="text" data-key="10445"><span data-slate-leaf="true" data-offset-key="10445:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10446"><span data-slate-object="text" data-key="10447"><span data-slate-leaf="true" data-offset-key="10447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10448"><span data-slate-leaf="true" data-offset-key="10448:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10449"><span data-slate-leaf="true" data-offset-key="10449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span><span data-slate-object="text" data-key="10450"><span data-slate-leaf="true" data-offset-key="10450:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10451"><span data-slate-leaf="true" data-offset-key="10451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="10452"><span data-slate-leaf="true" data-offset-key="10452:0" data-first-offset="true"><span data-slate-string="true"> lock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10453"><span data-slate-object="text" data-key="10454"><span data-slate-leaf="true" data-offset-key="10454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10455"><span data-slate-leaf="true" data-offset-key="10455:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10456"><span data-slate-leaf="true" data-offset-key="10456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10457"><span data-slate-leaf="true" data-offset-key="10457:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10458"><span data-slate-leaf="true" data-offset-key="10458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">acquireLock</span></span></span></span><span data-slate-object="text" data-key="10459"><span data-slate-leaf="true" data-offset-key="10459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="10460"><span data-slate-leaf="true" data-offset-key="10460:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10461"><span data-slate-object="text" data-key="10462"><span data-slate-leaf="true" data-offset-key="10462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10463"><span data-slate-leaf="true" data-offset-key="10463:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10464"><span data-slate-leaf="true" data-offset-key="10464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10465"><span data-slate-leaf="true" data-offset-key="10465:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10466"><span data-slate-leaf="true" data-offset-key="10466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">releaseeLock</span></span></span></span><span data-slate-object="text" data-key="10467"><span data-slate-leaf="true" data-offset-key="10467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="10468"><span data-slate-leaf="true" data-offset-key="10468:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10469"><span data-slate-object="text" data-key="10470"><span data-slate-leaf="true" data-offset-key="10470:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10471"><span data-slate-object="text" data-key="10472"><span data-slate-leaf="true" data-offset-key="10472:0" data-first-offset="true"><span data-slate-string="true">那么在 Java 代码中，我们怎么实现锁操作呢？Unsafe 似乎不是个好的选择，例如，我就注意到类似 Cassandra 等产品，因为 Java 9 中移除了 Unsafe.moniterEnter ()/moniterExit ()，导致无法平滑升级到新的 JDK 版本。目前 Java 提供了两种公共 API，可以实现这种 CAS 操作，比如使用 java.util.concurrent.atomic.AtomicLongFieldUpdater，它是基于反射机制创建，我们需要保证类型和字段名称正确。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10473"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10474"><span data-slate-object="text" data-key="10475"><span data-slate-leaf="true" data-offset-key="10475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10476"><span data-slate-leaf="true" data-offset-key="10476:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10477"><span data-slate-leaf="true" data-offset-key="10477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="10478"><span data-slate-leaf="true" data-offset-key="10478:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10479"><span data-slate-leaf="true" data-offset-key="10479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10480"><span data-slate-leaf="true" data-offset-key="10480:0" data-first-offset="true"><span data-slate-string="true"> AtomicLongFieldUpdater&lt;AtomicBTreePartition&gt; lockFieldUpdater =</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10481"><span data-slate-object="text" data-key="10482"><span data-slate-leaf="true" data-offset-key="10482:0" data-first-offset="true"><span data-slate-string="true">        AtomicLongFieldUpdater.</span></span></span><span data-slate-object="text" data-key="10483"><span data-slate-leaf="true" data-offset-key="10483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newUpdater</span></span></span></span><span data-slate-object="text" data-key="10484"><span data-slate-leaf="true" data-offset-key="10484:0" data-first-offset="true"><span data-slate-string="true">(AtomicBTreePartition.</span></span></span><span data-slate-object="text" data-key="10485"><span data-slate-leaf="true" data-offset-key="10485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="10486"><span data-slate-leaf="true" data-offset-key="10486:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10487"><span data-slate-leaf="true" data-offset-key="10487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"lock"</span></span></span></span><span data-slate-object="text" data-key="10488"><span data-slate-leaf="true" data-offset-key="10488:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10489"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10490"><span data-slate-object="text" data-key="10491"><span data-slate-leaf="true" data-offset-key="10491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="10492"><span data-slate-leaf="true" data-offset-key="10492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10493"><span data-slate-leaf="true" data-offset-key="10493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="10494"><span data-slate-leaf="true" data-offset-key="10494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10495"><span data-slate-leaf="true" data-offset-key="10495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">acquireLock</span></span></span></span></span><span data-slate-object="text" data-key="10496"><span data-slate-leaf="true" data-offset-key="10496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10497"><span data-slate-leaf="true" data-offset-key="10497:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10498"><span data-slate-object="text" data-key="10499"><span data-slate-leaf="true" data-offset-key="10499:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10500"><span data-slate-leaf="true" data-offset-key="10500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="10501"><span data-slate-leaf="true" data-offset-key="10501:0" data-first-offset="true"><span data-slate-string="true"> t = Thread.</span></span></span><span data-slate-object="text" data-key="10502"><span data-slate-leaf="true" data-offset-key="10502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">currentThread</span></span></span></span><span data-slate-object="text" data-key="10503"><span data-slate-leaf="true" data-offset-key="10503:0" data-first-offset="true"><span data-slate-string="true">().</span></span></span><span data-slate-object="text" data-key="10504"><span data-slate-leaf="true" data-offset-key="10504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getId</span></span></span></span><span data-slate-object="text" data-key="10505"><span data-slate-leaf="true" data-offset-key="10505:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10506"><span data-slate-object="text" data-key="10507"><span data-slate-leaf="true" data-offset-key="10507:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10508"><span data-slate-leaf="true" data-offset-key="10508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="10509"><span data-slate-leaf="true" data-offset-key="10509:0" data-first-offset="true"><span data-slate-string="true"> (!lockFieldUpdater.</span></span></span><span data-slate-object="text" data-key="10510"><span data-slate-leaf="true" data-offset-key="10510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">compareAndSet</span></span></span></span><span data-slate-object="text" data-key="10511"><span data-slate-leaf="true" data-offset-key="10511:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10512"><span data-slate-leaf="true" data-offset-key="10512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="10513"><span data-slate-leaf="true" data-offset-key="10513:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10514"><span data-slate-leaf="true" data-offset-key="10514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0L</span></span></span></span><span data-slate-object="text" data-key="10515"><span data-slate-leaf="true" data-offset-key="10515:0" data-first-offset="true"><span data-slate-string="true">, t)){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10516"><span data-slate-object="text" data-key="10517"><span data-slate-leaf="true" data-offset-key="10517:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10518"><span data-slate-leaf="true" data-offset-key="10518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待一会儿，数据库操作可能比较慢</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10519"><span data-slate-object="text" data-key="10520"><span data-slate-leaf="true" data-offset-key="10520:0" data-first-offset="true"><span data-slate-string="true">         …</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10521"><span data-slate-object="text" data-key="10522"><span data-slate-leaf="true" data-offset-key="10522:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10523"><span data-slate-object="text" data-key="10524"><span data-slate-leaf="true" data-offset-key="10524:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10525"><a data-slate-type="link" data-slate-object="inline" data-key="10526"><span data-slate-object="text" data-key="10527"><span data-slate-leaf="true" data-offset-key="10527:0" data-first-offset="true"><span data-slate-string="true">Atomic 包</span></span></span></a><span data-slate-object="text" data-key="10528"><span data-slate-leaf="true" data-offset-key="10528:0" data-first-offset="true"><span data-slate-string="true">提供了最常用的原子性数据类型，甚至是引用、数组等相关原子类型和更新操作工具，是很多线程安全程序的首选。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10529"><span data-slate-object="text" data-key="10530"><span data-slate-leaf="true" data-offset-key="10530:0" data-first-offset="true"><span data-slate-string="true">我在专栏第七讲中曾介绍使用原子数据类型和 Atomic*FieldUpdater，创建更加紧凑的计数器实现，以替代 AtomicLong。优化永远是针对特定需求、特定目的，我这里的侧重点是介绍可能的思路，具体还是要看需求。如果仅仅创建一两个对象，其实完全没有必要进行前面的优化，但是如果对象成千上万或者更多，就要考虑紧凑性的影响了。而 atomic 包提供的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10531"><span data-slate-object="text" data-key="10532"><span data-slate-leaf="true" data-offset-key="10532:0" data-first-offset="true"><span data-slate-string="true">LongAdder</span></span></span></a><span data-slate-object="text" data-key="10533"><span data-slate-leaf="true" data-offset-key="10533:0" data-first-offset="true"><span data-slate-string="true">，在高度竞争环境下，可能就是比 AtomicLong 更佳的选择，尽管它的本质是空间换时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10534"><span data-slate-object="text" data-key="10535"><span data-slate-leaf="true" data-offset-key="10535:0" data-first-offset="true"><span data-slate-string="true">回归正题，如果是 Java 9 以后，我们完全可以采用另外一种方式实现，也就是 Variable Handle API，这是源自于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10536"><span data-slate-object="text" data-key="10537"><span data-slate-leaf="true" data-offset-key="10537:0" data-first-offset="true"><span data-slate-string="true">JEP 193</span></span></span></a><span data-slate-object="text" data-key="10538"><span data-slate-leaf="true" data-offset-key="10538:0" data-first-offset="true"><span data-slate-string="true">，提供了各种粒度的原子或者有序性的操作等。我将前面的代码修改为如下实现：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10539"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10540"><span data-slate-object="text" data-key="10541"><span data-slate-leaf="true" data-offset-key="10541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10542"><span data-slate-leaf="true" data-offset-key="10542:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10543"><span data-slate-leaf="true" data-offset-key="10543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="10544"><span data-slate-leaf="true" data-offset-key="10544:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10545"><span data-slate-leaf="true" data-offset-key="10545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10546"><span data-slate-leaf="true" data-offset-key="10546:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10547"><span data-slate-leaf="true" data-offset-key="10547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">VarHandle</span></span></span></span><span data-slate-object="text" data-key="10548"><span data-slate-leaf="true" data-offset-key="10548:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10549"><span data-slate-leaf="true" data-offset-key="10549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HANDLE</span></span></span></span><span data-slate-object="text" data-key="10550"><span data-slate-leaf="true" data-offset-key="10550:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10551"><span data-slate-leaf="true" data-offset-key="10551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10552"><span data-slate-leaf="true" data-offset-key="10552:0" data-first-offset="true"><span data-slate-string="true"> MethodHandles.lookup().findStaticVarHandle</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10553"><span data-slate-object="text" data-key="10554"><span data-slate-leaf="true" data-offset-key="10554:0" data-first-offset="true"><span data-slate-string="true">        (AtomicBTreePartition.class, </span></span></span><span data-slate-object="text" data-key="10555"><span data-slate-leaf="true" data-offset-key="10555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"lock"</span></span></span></span><span data-slate-object="text" data-key="10556"><span data-slate-leaf="true" data-offset-key="10556:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10557"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10558"><span data-slate-object="text" data-key="10559"><span data-slate-leaf="true" data-offset-key="10559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10560"><span data-slate-leaf="true" data-offset-key="10560:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10561"><span data-slate-leaf="true" data-offset-key="10561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10562"><span data-slate-leaf="true" data-offset-key="10562:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10563"><span data-slate-leaf="true" data-offset-key="10563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">acquireLock</span></span></span></span><span data-slate-object="text" data-key="10564"><span data-slate-leaf="true" data-offset-key="10564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="10565"><span data-slate-leaf="true" data-offset-key="10565:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10566"><span data-slate-object="text" data-key="10567"><span data-slate-leaf="true" data-offset-key="10567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10568"><span data-slate-leaf="true" data-offset-key="10568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="10569"><span data-slate-leaf="true" data-offset-key="10569:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10570"><span data-slate-leaf="true" data-offset-key="10570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">t</span></span></span></span><span data-slate-object="text" data-key="10571"><span data-slate-leaf="true" data-offset-key="10571:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10572"><span data-slate-leaf="true" data-offset-key="10572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10573"><span data-slate-leaf="true" data-offset-key="10573:0" data-first-offset="true"><span data-slate-string="true"> Thread.currentThread().getId();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10574"><span data-slate-object="text" data-key="10575"><span data-slate-leaf="true" data-offset-key="10575:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10576"><span data-slate-leaf="true" data-offset-key="10576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="10577"><span data-slate-leaf="true" data-offset-key="10577:0" data-first-offset="true"><span data-slate-string="true"> (!HANDLE.compareAndSet(</span></span></span><span data-slate-object="text" data-key="10578"><span data-slate-leaf="true" data-offset-key="10578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="10579"><span data-slate-leaf="true" data-offset-key="10579:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10580"><span data-slate-leaf="true" data-offset-key="10580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0L</span></span></span></span><span data-slate-object="text" data-key="10581"><span data-slate-leaf="true" data-offset-key="10581:0" data-first-offset="true"><span data-slate-string="true">, t)){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10582"><span data-slate-object="text" data-key="10583"><span data-slate-leaf="true" data-offset-key="10583:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10584"><span data-slate-leaf="true" data-offset-key="10584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待一会儿，数据库操作可能比较慢</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10585"><span data-slate-object="text" data-key="10586"><span data-slate-leaf="true" data-offset-key="10586:0" data-first-offset="true"><span data-slate-string="true">        …</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10587"><span data-slate-object="text" data-key="10588"><span data-slate-leaf="true" data-offset-key="10588:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10589"><span data-slate-object="text" data-key="10590"><span data-slate-leaf="true" data-offset-key="10590:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10591"><span data-slate-object="text" data-key="10592"><span data-slate-leaf="true" data-offset-key="10592:0" data-first-offset="true"><span data-slate-string="true">过程非常直观，首先，获取相应的变量句柄，然后直接调用其提供的 CAS 方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10593"><span data-slate-object="text" data-key="10594"><span data-slate-leaf="true" data-offset-key="10594:0" data-first-offset="true"><span data-slate-string="true">一般来说，我们进行的类似 CAS 操作，可以并且推荐使用 Variable Handle API 去实现，其提供了精细粒度的公共底层 API。我这里强调公共，是因为其 API 不会像内部 API 那样，发生不可预测的修改，这一点提供了对于未来产品维护和升级的基础保障，</span></span><span data-slate-leaf="true" data-offset-key="10594:1"><span data-slate-object="annotation" data-annotation-key="gkann_6135ac1f" data-attr-id="32749" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">坦白说，很多额外工作量，都是源于我们使用了 Hack 而非 Solution 的方式解决问题。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10595"><span data-slate-object="text" data-key="10596"><span data-slate-leaf="true" data-offset-key="10596:0" data-first-offset="true"><span data-slate-string="true">CAS 也并不是没有副作用，试想，其常用的失败重试机制，隐含着一个假设，即竞争情况是短暂的。大多数应用场景中，确实大部分重试只会发生一次就获得了成功，但是总是有意外情况，所以在有需要的时候，还是要考虑限制自旋的次数，以免过度消耗 CPU。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10597"><span data-slate-object="text" data-key="10598"><span data-slate-leaf="true" data-offset-key="10598:0" data-first-offset="true"><span data-slate-string="true">另外一个就是著名的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10599"><span data-slate-object="text" data-key="10600"><span data-slate-leaf="true" data-offset-key="10600:0" data-first-offset="true"><span data-slate-string="true">ABA</span></span></span></a><span data-slate-object="text" data-key="10601"><span data-slate-leaf="true" data-offset-key="10601:0" data-first-offset="true"><span data-slate-string="true"> 问题，这是通常只在 lock-free 算法下暴露的问题。我前面说过 CAS 是在更新时比较前值，如果对方只是恰好相同，例如期间发生了 A -&gt; B -&gt; A 的更新，仅仅判断数值是 A，可能导致不合理的修改操作。针对这种情况，</span></span><span data-slate-leaf="true" data-offset-key="10601:1"><span data-slate-object="annotation" data-annotation-key="gkann_b28f7ec0" data-attr-id="15597" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Java 提供了 AtomicStampedReference 工具类，</span></span></span><span data-slate-leaf="true" data-offset-key="10601:2"><span data-slate-string="true">通过为引用建立类似版本号（stamp）的方式，来保证 CAS 的正确性，具体用法请参考这里的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10602"><span data-slate-object="text" data-key="10603"><span data-slate-leaf="true" data-offset-key="10603:0" data-first-offset="true"><span data-slate-string="true">介绍</span></span></span></a><span data-slate-object="text" data-key="10604"><span data-slate-leaf="true" data-offset-key="10604:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10605"><span data-slate-object="text" data-key="10606"><span data-slate-leaf="true" data-offset-key="10606:0" data-first-offset="true"><span data-slate-string="true">前面介绍了 CAS 的场景与实现，幸运的是，大多数情况下，Java 开发者并不需要直接利用 CAS 代码去实现线程安全容器等，更多是通过并发包等间接享受到 lock-free 机制在扩展性上的好处。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10607"><span data-slate-object="text" data-key="10608"><span data-slate-leaf="true" data-offset-key="10608:0" data-first-offset="true"><span data-slate-string="true">下面我来介绍一下 AbstractQueuedSynchronizer（AQS），其是 Java 并发包中，实现各种同步结构和部分其他组成单元（如线程池中的 Worker）的基础。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10609"><span data-slate-object="text" data-key="10610"><span data-slate-leaf="true" data-offset-key="10610:0" data-first-offset="true"><span data-slate-string="true">学习 AQS，如果上来就去看它的一系列方法（下图所示），很有可能把自己看晕，这种似懂非懂的状态也没有太大的实践意义。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10611"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/e3/36/e3b4b7fe5a94a88ca2feb04d734b9c36.png?wh=1062*424"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10612"><span data-slate-object="text" data-key="10613"><span data-slate-leaf="true" data-offset-key="10613:0" data-first-offset="true"><span data-slate-string="true">我建议的思路是，尽量简化一下，理解为什么需要 AQS，如何使用 AQS，</span></span></span><span data-slate-object="text" data-key="10614"><span data-slate-leaf="true" data-offset-key="10614:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">至少</span></span></span></span><span data-slate-object="text" data-key="10615"><span data-slate-leaf="true" data-offset-key="10615:0" data-first-offset="true"><span data-slate-string="true">要做什么，再进一步结合 JDK 源代码中的实践，理解 AQS 的原理与应用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10616"><a data-slate-type="link" data-slate-object="inline" data-key="10617"><span data-slate-object="text" data-key="10618"><span data-slate-leaf="true" data-offset-key="10618:0" data-first-offset="true"><span data-slate-string="true">Doug Lea</span></span></span></a><span data-slate-object="text" data-key="10619"><span data-slate-leaf="true" data-offset-key="10619:0" data-first-offset="true"><span data-slate-string="true"> 曾经介绍过 AQS 的设计初衷。从原理上，一种同步结构往往是可以利用其他的结构实现的，例如我在专栏第 19 讲中提到过可以使用 Semaphore 实现互斥锁。但是，对某种同步结构的倾向，会导致复杂、晦涩的实现逻辑，所以，他选择了将基础的同步相关操作抽象在 AbstractQueuedSynchronizer 中，利用 AQS 为我们构建同步结构提供了范本。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10620"><span data-slate-object="text" data-key="10621"><span data-slate-leaf="true" data-offset-key="10621:0" data-first-offset="true"><span data-slate-string="true">AQS 内部数据和方法，可以简单拆分为：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10622"><div data-slate-type="list-line" data-slate-object="block" data-key="10623"><span data-slate-object="text" data-key="10624"><span data-slate-leaf="true" data-offset-key="10624:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_af770fa7" data-attr-id="12312" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一个 volatile 的整数成员表征状态，同时提供了 setState 和 getState 方法</span></span></span></span></div></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10625"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10626"><span data-slate-object="text" data-key="10627"><span data-slate-leaf="true" data-offset-key="10627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10628"><span data-slate-leaf="true" data-offset-key="10628:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10629"><span data-slate-leaf="true" data-offset-key="10629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span><span data-slate-object="text" data-key="10630"><span data-slate-leaf="true" data-offset-key="10630:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10631"><span data-slate-leaf="true" data-offset-key="10631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10632"><span data-slate-leaf="true" data-offset-key="10632:0" data-first-offset="true"><span data-slate-string="true"> state;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="10633"><div data-slate-type="list-line" data-slate-object="block" data-key="10634"><span data-slate-object="text" data-key="10635"><span data-slate-leaf="true" data-offset-key="10635:0" data-first-offset="true"><span data-slate-string="true">一个先入先出（FIFO）的等待线程队列，以实现多线程间竞争和等待，这是 AQS 机制的核心之一。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10636"><span data-slate-object="text" data-key="10637"><span data-slate-leaf="true" data-offset-key="10637:0" data-first-offset="true"><span data-slate-string="true">各种基于 CAS 的基础操作方法，以及各种期望具体同步结构去实现的 acquire/release 方法。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10638"><span data-slate-object="text" data-key="10639"><span data-slate-leaf="true" data-offset-key="10639:0" data-first-offset="true"><span data-slate-string="true">利用 AQS 实现一个同步结构，至少要实现两个基本类型的方法，分别是 acquire 操作，获取资源的独占权；还有就是 release 操作，释放对某个资源的独占。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10640"><span data-slate-object="text" data-key="10641"><span data-slate-leaf="true" data-offset-key="10641:0" data-first-offset="true"><span data-slate-string="true">以 ReentrantLock 为例，它内部通过扩展 AQS 实现了 Sync 类型，以 AQS 的 state 来反映锁的持有情况。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10642"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10643"><span data-slate-object="text" data-key="10644"><span data-slate-leaf="true" data-offset-key="10644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10645"><span data-slate-leaf="true" data-offset-key="10645:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10646"><span data-slate-leaf="true" data-offset-key="10646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10647"><span data-slate-leaf="true" data-offset-key="10647:0" data-first-offset="true"><span data-slate-string="true"> Sync sync;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10648"><span data-slate-object="text" data-key="10649"><span data-slate-leaf="true" data-offset-key="10649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">abstract</span></span></span></span><span data-slate-object="text" data-key="10650"><span data-slate-leaf="true" data-offset-key="10650:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10651"><span data-slate-leaf="true" data-offset-key="10651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="10652"><span data-slate-leaf="true" data-offset-key="10652:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10653"><span data-slate-leaf="true" data-offset-key="10653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="10654"><span data-slate-leaf="true" data-offset-key="10654:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10655"><span data-slate-leaf="true" data-offset-key="10655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Sync</span></span></span></span><span data-slate-object="text" data-key="10656"><span data-slate-leaf="true" data-offset-key="10656:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10657"><span data-slate-leaf="true" data-offset-key="10657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="10658"><span data-slate-leaf="true" data-offset-key="10658:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10659"><span data-slate-leaf="true" data-offset-key="10659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractQueuedSynchronizer</span></span></span></span><span data-slate-object="text" data-key="10660"><span data-slate-leaf="true" data-offset-key="10660:0" data-first-offset="true"><span data-slate-string="true"> {…}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10661"><span data-slate-object="text" data-key="10662"><span data-slate-leaf="true" data-offset-key="10662:0" data-first-offset="true"><span data-slate-string="true">下面是 ReentrantLock 对应 acquire 和 release 操作，如果是 CountDownLatch 则可以看作是 await ()/countDown ()，具体实现也有区别。</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="10663"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10664"><span data-slate-object="text" data-key="10665"><span data-slate-leaf="true" data-offset-key="10665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10666"><span data-slate-leaf="true" data-offset-key="10666:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10667"><span data-slate-leaf="true" data-offset-key="10667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10668"><span data-slate-leaf="true" data-offset-key="10668:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10669"><span data-slate-leaf="true" data-offset-key="10669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">lock</span></span></span></span><span data-slate-object="text" data-key="10670"><span data-slate-leaf="true" data-offset-key="10670:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10671"><span data-slate-leaf="true" data-offset-key="10671:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10672"><span data-slate-object="text" data-key="10673"><span data-slate-leaf="true" data-offset-key="10673:0" data-first-offset="true"><span data-slate-string="true">    sync.</span></span></span><span data-slate-object="text" data-key="10674"><span data-slate-leaf="true" data-offset-key="10674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">acquire</span></span></span></span><span data-slate-object="text" data-key="10675"><span data-slate-leaf="true" data-offset-key="10675:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10676"><span data-slate-leaf="true" data-offset-key="10676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10677"><span data-slate-leaf="true" data-offset-key="10677:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10678"><span data-slate-object="text" data-key="10679"><span data-slate-leaf="true" data-offset-key="10679:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10680"><span data-slate-object="text" data-key="10681"><span data-slate-leaf="true" data-offset-key="10681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10682"><span data-slate-leaf="true" data-offset-key="10682:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10683"><span data-slate-leaf="true" data-offset-key="10683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10684"><span data-slate-leaf="true" data-offset-key="10684:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10685"><span data-slate-leaf="true" data-offset-key="10685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlock</span></span></span></span><span data-slate-object="text" data-key="10686"><span data-slate-leaf="true" data-offset-key="10686:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10687"><span data-slate-leaf="true" data-offset-key="10687:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10688"><span data-slate-object="text" data-key="10689"><span data-slate-leaf="true" data-offset-key="10689:0" data-first-offset="true"><span data-slate-string="true">    sync.</span></span></span><span data-slate-object="text" data-key="10690"><span data-slate-leaf="true" data-offset-key="10690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">release</span></span></span></span><span data-slate-object="text" data-key="10691"><span data-slate-leaf="true" data-offset-key="10691:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10692"><span data-slate-leaf="true" data-offset-key="10692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10693"><span data-slate-leaf="true" data-offset-key="10693:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10694"><span data-slate-object="text" data-key="10695"><span data-slate-leaf="true" data-offset-key="10695:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10696"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10697"><span data-slate-object="text" data-key="10698"><span data-slate-leaf="true" data-offset-key="10698:0" data-first-offset="true"><span data-slate-string="true">排除掉一些细节，整体地分析 acquire 方法逻辑，其直接实现是在 AQS 内部，调用了 tryAcquire 和 acquireQueued，这是两个需要搞清楚的基本部分。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10699"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10700"><span data-slate-object="text" data-key="10701"><span data-slate-leaf="true" data-offset-key="10701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10702"><span data-slate-leaf="true" data-offset-key="10702:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10703"><span data-slate-leaf="true" data-offset-key="10703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10704"><span data-slate-leaf="true" data-offset-key="10704:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10705"><span data-slate-leaf="true" data-offset-key="10705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10706"><span data-slate-leaf="true" data-offset-key="10706:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10707"><span data-slate-leaf="true" data-offset-key="10707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">acquire</span></span></span></span><span data-slate-object="text" data-key="10708"><span data-slate-leaf="true" data-offset-key="10708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="10709"><span data-slate-leaf="true" data-offset-key="10709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="10710"><span data-slate-leaf="true" data-offset-key="10710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> arg)</span></span></span></span><span data-slate-object="text" data-key="10711"><span data-slate-leaf="true" data-offset-key="10711:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10712"><span data-slate-object="text" data-key="10713"><span data-slate-leaf="true" data-offset-key="10713:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10714"><span data-slate-leaf="true" data-offset-key="10714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10715"><span data-slate-leaf="true" data-offset-key="10715:0" data-first-offset="true"><span data-slate-string="true"> (!tryAcquire(arg) &amp;&amp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10716"><span data-slate-object="text" data-key="10717"><span data-slate-leaf="true" data-offset-key="10717:0" data-first-offset="true"><span data-slate-string="true">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10718"><span data-slate-object="text" data-key="10719"><span data-slate-leaf="true" data-offset-key="10719:0" data-first-offset="true"><span data-slate-string="true">        selfInterrupt();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10720"><span data-slate-object="text" data-key="10721"><span data-slate-leaf="true" data-offset-key="10721:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10722"><span data-slate-object="text" data-key="10723"><span data-slate-leaf="true" data-offset-key="10723:0" data-first-offset="true"><span data-slate-string="true">首先，我们来看看 tryAcquire。在 ReentrantLock 中，tryAcquire 逻辑实现在 NonfairSync 和 FairSync 中，分别提供了进一步的非公平或公平性方法，而 AQS 内部 tryAcquire 仅仅是个接近未实现的方法（直接抛异常），这是留个实现者自己定义的操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10724"><span data-slate-object="text" data-key="10725"><span data-slate-leaf="true" data-offset-key="10725:0" data-first-offset="true"><span data-slate-string="true">我们可以看到公平性在 ReentrantLock 构建时如何指定的，具体如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10726"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10727"><span data-slate-object="text" data-key="10728"><span data-slate-leaf="true" data-offset-key="10728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10729"><span data-slate-leaf="true" data-offset-key="10729:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10730"><span data-slate-leaf="true" data-offset-key="10730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReentrantLock</span></span></span></span><span data-slate-object="text" data-key="10731"><span data-slate-leaf="true" data-offset-key="10731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="10732"><span data-slate-leaf="true" data-offset-key="10732:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10733"><span data-slate-object="text" data-key="10734"><span data-slate-leaf="true" data-offset-key="10734:0" data-first-offset="true"><span data-slate-string="true">        sync = </span></span></span><span data-slate-object="text" data-key="10735"><span data-slate-leaf="true" data-offset-key="10735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10736"><span data-slate-leaf="true" data-offset-key="10736:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10737"><span data-slate-leaf="true" data-offset-key="10737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NonfairSync</span></span></span></span><span data-slate-object="text" data-key="10738"><span data-slate-leaf="true" data-offset-key="10738:0" data-first-offset="true"><span data-slate-string="true">(); </span></span></span><span data-slate-object="text" data-key="10739"><span data-slate-leaf="true" data-offset-key="10739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 默认是非公平的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10740"><span data-slate-object="text" data-key="10741"><span data-slate-leaf="true" data-offset-key="10741:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10742"><span data-slate-object="text" data-key="10743"><span data-slate-leaf="true" data-offset-key="10743:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10744"><span data-slate-leaf="true" data-offset-key="10744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="10745"><span data-slate-leaf="true" data-offset-key="10745:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10746"><span data-slate-leaf="true" data-offset-key="10746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReentrantLock</span></span></span></span><span data-slate-object="text" data-key="10747"><span data-slate-leaf="true" data-offset-key="10747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="10748"><span data-slate-leaf="true" data-offset-key="10748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">boolean</span></span></span></span></span><span data-slate-object="text" data-key="10749"><span data-slate-leaf="true" data-offset-key="10749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> fair)</span></span></span></span><span data-slate-object="text" data-key="10750"><span data-slate-leaf="true" data-offset-key="10750:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10751"><span data-slate-object="text" data-key="10752"><span data-slate-leaf="true" data-offset-key="10752:0" data-first-offset="true"><span data-slate-string="true">        sync = fair ? </span></span></span><span data-slate-object="text" data-key="10753"><span data-slate-leaf="true" data-offset-key="10753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10754"><span data-slate-leaf="true" data-offset-key="10754:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10755"><span data-slate-leaf="true" data-offset-key="10755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">FairSync</span></span></span></span><span data-slate-object="text" data-key="10756"><span data-slate-leaf="true" data-offset-key="10756:0" data-first-offset="true"><span data-slate-string="true">() : </span></span></span><span data-slate-object="text" data-key="10757"><span data-slate-leaf="true" data-offset-key="10757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10758"><span data-slate-leaf="true" data-offset-key="10758:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10759"><span data-slate-leaf="true" data-offset-key="10759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NonfairSync</span></span></span></span><span data-slate-object="text" data-key="10760"><span data-slate-leaf="true" data-offset-key="10760:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10761"><span data-slate-object="text" data-key="10762"><span data-slate-leaf="true" data-offset-key="10762:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10763"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10764"><span data-slate-object="text" data-key="10765"><span data-slate-leaf="true" data-offset-key="10765:0" data-first-offset="true"><span data-slate-string="true">以非公平的 tryAcquire 为例，其内部实现了如何配合状态与 CAS 获取锁，注意，对比公平版本的 tryAcquire，它在锁无人占有时，并不检查是否有其他等待者，这里体现了非公平的语义。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10766"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10767"><span data-slate-object="text" data-key="10768"><span data-slate-leaf="true" data-offset-key="10768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10769"><span data-slate-leaf="true" data-offset-key="10769:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10770"><span data-slate-leaf="true" data-offset-key="10770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">boolean</span></span></span></span><span data-slate-object="text" data-key="10771"><span data-slate-leaf="true" data-offset-key="10771:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10772"><span data-slate-leaf="true" data-offset-key="10772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nonfairTryAcquire</span></span></span></span><span data-slate-object="text" data-key="10773"><span data-slate-leaf="true" data-offset-key="10773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="10774"><span data-slate-leaf="true" data-offset-key="10774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="10775"><span data-slate-leaf="true" data-offset-key="10775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> acquires)</span></span></span></span><span data-slate-object="text" data-key="10776"><span data-slate-leaf="true" data-offset-key="10776:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10777"><span data-slate-object="text" data-key="10778"><span data-slate-leaf="true" data-offset-key="10778:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10779"><span data-slate-leaf="true" data-offset-key="10779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10780"><span data-slate-leaf="true" data-offset-key="10780:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10781"><span data-slate-leaf="true" data-offset-key="10781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Thread</span></span></span></span><span data-slate-object="text" data-key="10782"><span data-slate-leaf="true" data-offset-key="10782:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10783"><span data-slate-leaf="true" data-offset-key="10783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">current</span></span></span></span><span data-slate-object="text" data-key="10784"><span data-slate-leaf="true" data-offset-key="10784:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10785"><span data-slate-leaf="true" data-offset-key="10785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10786"><span data-slate-leaf="true" data-offset-key="10786:0" data-first-offset="true"><span data-slate-string="true"> Thread.currentThread();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10787"><span data-slate-object="text" data-key="10788"><span data-slate-leaf="true" data-offset-key="10788:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10789"><span data-slate-leaf="true" data-offset-key="10789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10790"><span data-slate-leaf="true" data-offset-key="10790:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10791"><span data-slate-leaf="true" data-offset-key="10791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">c</span></span></span></span><span data-slate-object="text" data-key="10792"><span data-slate-leaf="true" data-offset-key="10792:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10793"><span data-slate-leaf="true" data-offset-key="10793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10794"><span data-slate-leaf="true" data-offset-key="10794:0" data-first-offset="true"><span data-slate-string="true"> getState();</span></span></span><span data-slate-object="text" data-key="10795"><span data-slate-leaf="true" data-offset-key="10795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前 AQS 内部状态量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10796"><span data-slate-object="text" data-key="10797"><span data-slate-leaf="true" data-offset-key="10797:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10798"><span data-slate-leaf="true" data-offset-key="10798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10799"><span data-slate-leaf="true" data-offset-key="10799:0" data-first-offset="true"><span data-slate-string="true"> (c == </span></span></span><span data-slate-object="text" data-key="10800"><span data-slate-leaf="true" data-offset-key="10800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10801"><span data-slate-leaf="true" data-offset-key="10801:0" data-first-offset="true"><span data-slate-string="true">) { </span></span></span><span data-slate-object="text" data-key="10802"><span data-slate-leaf="true" data-offset-key="10802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 0 表示无人占有，则直接用 CAS 修改状态位，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10803"><span data-slate-object="text" data-key="10804"><span data-slate-leaf="true" data-offset-key="10804:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10805"><span data-slate-leaf="true" data-offset-key="10805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10806"><span data-slate-leaf="true" data-offset-key="10806:0" data-first-offset="true"><span data-slate-string="true"> (compareAndSetState(</span></span></span><span data-slate-object="text" data-key="10807"><span data-slate-leaf="true" data-offset-key="10807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10808"><span data-slate-leaf="true" data-offset-key="10808:0" data-first-offset="true"><span data-slate-string="true">, acquires)) {</span></span></span><span data-slate-object="text" data-key="10809"><span data-slate-leaf="true" data-offset-key="10809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不检查排队情况，直接争抢</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10810"><span data-slate-object="text" data-key="10811"><span data-slate-leaf="true" data-offset-key="10811:0" data-first-offset="true"><span data-slate-string="true">          setExclusiveOwnerThread(current);  </span></span></span><span data-slate-object="text" data-key="10812"><span data-slate-leaf="true" data-offset-key="10812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 并设置当前线程独占锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10813"><span data-slate-object="text" data-key="10814"><span data-slate-leaf="true" data-offset-key="10814:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10815"><span data-slate-leaf="true" data-offset-key="10815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10816"><span data-slate-leaf="true" data-offset-key="10816:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10817"><span data-slate-leaf="true" data-offset-key="10817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="10818"><span data-slate-leaf="true" data-offset-key="10818:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10819"><span data-slate-object="text" data-key="10820"><span data-slate-leaf="true" data-offset-key="10820:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10821"><span data-slate-object="text" data-key="10822"><span data-slate-leaf="true" data-offset-key="10822:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="10823"><span data-slate-leaf="true" data-offset-key="10823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="10824"><span data-slate-leaf="true" data-offset-key="10824:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10825"><span data-slate-leaf="true" data-offset-key="10825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10826"><span data-slate-leaf="true" data-offset-key="10826:0" data-first-offset="true"><span data-slate-string="true"> (current == getExclusiveOwnerThread()) { </span></span></span><span data-slate-object="text" data-key="10827"><span data-slate-leaf="true" data-offset-key="10827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 即使状态不是 0，也可能当前线程是锁持有者，因为这是再入锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10828"><span data-slate-object="text" data-key="10829"><span data-slate-leaf="true" data-offset-key="10829:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10830"><span data-slate-leaf="true" data-offset-key="10830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="10831"><span data-slate-leaf="true" data-offset-key="10831:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10832"><span data-slate-leaf="true" data-offset-key="10832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nextc</span></span></span></span><span data-slate-object="text" data-key="10833"><span data-slate-leaf="true" data-offset-key="10833:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10834"><span data-slate-leaf="true" data-offset-key="10834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10835"><span data-slate-leaf="true" data-offset-key="10835:0" data-first-offset="true"><span data-slate-string="true"> c + acquires;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10836"><span data-slate-object="text" data-key="10837"><span data-slate-leaf="true" data-offset-key="10837:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10838"><span data-slate-leaf="true" data-offset-key="10838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10839"><span data-slate-leaf="true" data-offset-key="10839:0" data-first-offset="true"><span data-slate-string="true"> (nextc &lt; </span></span></span><span data-slate-object="text" data-key="10840"><span data-slate-leaf="true" data-offset-key="10840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10841"><span data-slate-leaf="true" data-offset-key="10841:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="10842"><span data-slate-leaf="true" data-offset-key="10842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// overflow</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10843"><span data-slate-object="text" data-key="10844"><span data-slate-leaf="true" data-offset-key="10844:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10845"><span data-slate-leaf="true" data-offset-key="10845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="10846"><span data-slate-leaf="true" data-offset-key="10846:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10847"><span data-slate-leaf="true" data-offset-key="10847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10848"><span data-slate-leaf="true" data-offset-key="10848:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10849"><span data-slate-leaf="true" data-offset-key="10849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Error</span></span></span></span><span data-slate-object="text" data-key="10850"><span data-slate-leaf="true" data-offset-key="10850:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10851"><span data-slate-leaf="true" data-offset-key="10851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Maximum lock count exceeded"</span></span></span></span><span data-slate-object="text" data-key="10852"><span data-slate-leaf="true" data-offset-key="10852:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10853"><span data-slate-object="text" data-key="10854"><span data-slate-leaf="true" data-offset-key="10854:0" data-first-offset="true"><span data-slate-string="true">      setState(nextc);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10855"><span data-slate-object="text" data-key="10856"><span data-slate-leaf="true" data-offset-key="10856:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10857"><span data-slate-leaf="true" data-offset-key="10857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10858"><span data-slate-leaf="true" data-offset-key="10858:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10859"><span data-slate-leaf="true" data-offset-key="10859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="10860"><span data-slate-leaf="true" data-offset-key="10860:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10861"><span data-slate-object="text" data-key="10862"><span data-slate-leaf="true" data-offset-key="10862:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10863"><span data-slate-object="text" data-key="10864"><span data-slate-leaf="true" data-offset-key="10864:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10865"><span data-slate-leaf="true" data-offset-key="10865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10866"><span data-slate-leaf="true" data-offset-key="10866:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10867"><span data-slate-leaf="true" data-offset-key="10867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="10868"><span data-slate-leaf="true" data-offset-key="10868:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10869"><span data-slate-object="text" data-key="10870"><span data-slate-leaf="true" data-offset-key="10870:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10871"><span data-slate-object="text" data-key="10872"><span data-slate-leaf="true" data-offset-key="10872:0" data-first-offset="true"><span data-slate-string="true">接下来我再来分析 acquireQueued，如果前面的 tryAcquire 失败，代表着锁争抢失败，进入排队竞争阶段。这里就是我们所说的，利用 FIFO 队列，实现线程间对锁的竞争的部分，算是是 AQS 的核心逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10873"><span data-slate-object="text" data-key="10874"><span data-slate-leaf="true" data-offset-key="10874:0" data-first-offset="true"><span data-slate-string="true">当前线程会被包装成为一个排他模式的节点（EXCLUSIVE），通过 addWaiter 方法添加到队列中。acquireQueued 的逻辑，简要来说，就是如果当前节点的前面是头节点，则试图获取锁，一切顺利则成为新的头节点；否则，有必要则等待，具体处理逻辑请参考我添加的注释。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10875"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10876"><span data-slate-object="text" data-key="10877"><span data-slate-leaf="true" data-offset-key="10877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10878"><span data-slate-leaf="true" data-offset-key="10878:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10879"><span data-slate-leaf="true" data-offset-key="10879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">boolean</span></span></span></span><span data-slate-object="text" data-key="10880"><span data-slate-leaf="true" data-offset-key="10880:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10881"><span data-slate-leaf="true" data-offset-key="10881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">acquireQueued</span></span></span></span><span data-slate-object="text" data-key="10882"><span data-slate-leaf="true" data-offset-key="10882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="10883"><span data-slate-leaf="true" data-offset-key="10883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span></span><span data-slate-object="text" data-key="10884"><span data-slate-leaf="true" data-offset-key="10884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> Node node, </span></span></span></span><span data-slate-object="text" data-key="10885"><span data-slate-leaf="true" data-offset-key="10885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="10886"><span data-slate-leaf="true" data-offset-key="10886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> arg)</span></span></span></span><span data-slate-object="text" data-key="10887"><span data-slate-leaf="true" data-offset-key="10887:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10888"><span data-slate-object="text" data-key="10889"><span data-slate-leaf="true" data-offset-key="10889:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10890"><span data-slate-leaf="true" data-offset-key="10890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">boolean</span></span></span></span><span data-slate-object="text" data-key="10891"><span data-slate-leaf="true" data-offset-key="10891:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10892"><span data-slate-leaf="true" data-offset-key="10892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interrupted</span></span></span></span><span data-slate-object="text" data-key="10893"><span data-slate-leaf="true" data-offset-key="10893:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10894"><span data-slate-leaf="true" data-offset-key="10894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10895"><span data-slate-leaf="true" data-offset-key="10895:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10896"><span data-slate-leaf="true" data-offset-key="10896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="10897"><span data-slate-leaf="true" data-offset-key="10897:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10898"><span data-slate-object="text" data-key="10899"><span data-slate-leaf="true" data-offset-key="10899:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10900"><span data-slate-leaf="true" data-offset-key="10900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="10901"><span data-slate-leaf="true" data-offset-key="10901:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10902"><span data-slate-object="text" data-key="10903"><span data-slate-leaf="true" data-offset-key="10903:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10904"><span data-slate-leaf="true" data-offset-key="10904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10905"><span data-slate-leaf="true" data-offset-key="10905:0" data-first-offset="true"><span data-slate-string="true"> (;;) {</span></span></span><span data-slate-object="text" data-key="10906"><span data-slate-leaf="true" data-offset-key="10906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 循环</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10907"><span data-slate-object="text" data-key="10908"><span data-slate-leaf="true" data-offset-key="10908:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10909"><span data-slate-leaf="true" data-offset-key="10909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="10910"><span data-slate-leaf="true" data-offset-key="10910:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10911"><span data-slate-leaf="true" data-offset-key="10911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Node</span></span></span></span><span data-slate-object="text" data-key="10912"><span data-slate-leaf="true" data-offset-key="10912:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10913"><span data-slate-leaf="true" data-offset-key="10913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">p</span></span></span></span><span data-slate-object="text" data-key="10914"><span data-slate-leaf="true" data-offset-key="10914:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10915"><span data-slate-leaf="true" data-offset-key="10915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10916"><span data-slate-leaf="true" data-offset-key="10916:0" data-first-offset="true"><span data-slate-string="true"> node.predecessor();</span></span></span><span data-slate-object="text" data-key="10917"><span data-slate-leaf="true" data-offset-key="10917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取前一个节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10918"><span data-slate-object="text" data-key="10919"><span data-slate-leaf="true" data-offset-key="10919:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10920"><span data-slate-leaf="true" data-offset-key="10920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10921"><span data-slate-leaf="true" data-offset-key="10921:0" data-first-offset="true"><span data-slate-string="true"> (p == head &amp;&amp; tryAcquire(arg)) { </span></span></span><span data-slate-object="text" data-key="10922"><span data-slate-leaf="true" data-offset-key="10922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果前一个节点是头结点，表示当前节点合适去 tryAcquire</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10923"><span data-slate-object="text" data-key="10924"><span data-slate-leaf="true" data-offset-key="10924:0" data-first-offset="true"><span data-slate-string="true">              setHead(node); </span></span></span><span data-slate-object="text" data-key="10925"><span data-slate-leaf="true" data-offset-key="10925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//acquire 成功，则设置新的头节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10926"><span data-slate-object="text" data-key="10927"><span data-slate-leaf="true" data-offset-key="10927:0" data-first-offset="true"><span data-slate-string="true">              p.next = </span></span></span><span data-slate-object="text" data-key="10928"><span data-slate-leaf="true" data-offset-key="10928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="10929"><span data-slate-leaf="true" data-offset-key="10929:0" data-first-offset="true"><span data-slate-string="true">; </span></span></span><span data-slate-object="text" data-key="10930"><span data-slate-leaf="true" data-offset-key="10930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将前面节点对当前节点的引用清空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10931"><span data-slate-object="text" data-key="10932"><span data-slate-leaf="true" data-offset-key="10932:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="10933"><span data-slate-leaf="true" data-offset-key="10933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10934"><span data-slate-leaf="true" data-offset-key="10934:0" data-first-offset="true"><span data-slate-string="true"> interrupted;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10935"><span data-slate-object="text" data-key="10936"><span data-slate-leaf="true" data-offset-key="10936:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10937"><span data-slate-object="text" data-key="10938"><span data-slate-leaf="true" data-offset-key="10938:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10939"><span data-slate-leaf="true" data-offset-key="10939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10940"><span data-slate-leaf="true" data-offset-key="10940:0" data-first-offset="true"><span data-slate-string="true"> (shouldParkAfterFailedAcquire(p, node)) </span></span></span><span data-slate-object="text" data-key="10941"><span data-slate-leaf="true" data-offset-key="10941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查是否失败后需要 park</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10942"><span data-slate-object="text" data-key="10943"><span data-slate-leaf="true" data-offset-key="10943:0" data-first-offset="true"><span data-slate-string="true">              interrupted |= parkAndCheckInterrupt();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10944"><span data-slate-object="text" data-key="10945"><span data-slate-leaf="true" data-offset-key="10945:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10946"><span data-slate-object="text" data-key="10947"><span data-slate-leaf="true" data-offset-key="10947:0" data-first-offset="true"><span data-slate-string="true">       } </span></span></span><span data-slate-object="text" data-key="10948"><span data-slate-leaf="true" data-offset-key="10948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="10949"><span data-slate-leaf="true" data-offset-key="10949:0" data-first-offset="true"><span data-slate-string="true"> (Throwable t) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10950"><span data-slate-object="text" data-key="10951"><span data-slate-leaf="true" data-offset-key="10951:0" data-first-offset="true"><span data-slate-string="true">      cancelAcquire(node);</span></span></span><span data-slate-object="text" data-key="10952"><span data-slate-leaf="true" data-offset-key="10952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 出现异常，取消</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10953"><span data-slate-object="text" data-key="10954"><span data-slate-leaf="true" data-offset-key="10954:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10955"><span data-slate-leaf="true" data-offset-key="10955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10956"><span data-slate-leaf="true" data-offset-key="10956:0" data-first-offset="true"><span data-slate-string="true"> (interrupted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10957"><span data-slate-object="text" data-key="10958"><span data-slate-leaf="true" data-offset-key="10958:0" data-first-offset="true"><span data-slate-string="true">              selfInterrupt();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10959"><span data-slate-object="text" data-key="10960"><span data-slate-leaf="true" data-offset-key="10960:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10961"><span data-slate-leaf="true" data-offset-key="10961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="10962"><span data-slate-leaf="true" data-offset-key="10962:0" data-first-offset="true"><span data-slate-string="true"> t;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10963"><span data-slate-object="text" data-key="10964"><span data-slate-leaf="true" data-offset-key="10964:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10965"><span data-slate-object="text" data-key="10966"><span data-slate-leaf="true" data-offset-key="10966:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10967"><span data-slate-object="text" data-key="10968"><span data-slate-leaf="true" data-offset-key="10968:0" data-first-offset="true"><span data-slate-string="true">到这里线程试图获取锁的过程基本展现出来了，tryAcquire 是按照特定场景需要开发者去实现的部分，而线程间竞争则是 AQS 通过 Waiter 队列与 acquireQueued 提供的，在 release 方法中，同样会对队列进行对应操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10969"><span data-slate-object="text" data-key="10970"><span data-slate-leaf="true" data-offset-key="10970:0" data-first-offset="true"><span data-slate-string="true">今天我介绍了 Atomic 数据类型的底层技术 CAS，并通过实例演示了如何在产品代码中利用 CAS，最后介绍了并发包的基础技术 AQS，希望对你有所帮助。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10971" id="sr-toc-4"><span data-slate-object="text" data-key="10972"><span data-slate-leaf="true" data-offset-key="10972:0" data-first-offset="true"><span data-slate-string="true">一课一练</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10973"><span data-slate-object="text" data-key="10974"><span data-slate-leaf="true" data-offset-key="10974:0" data-first-offset="true"><span data-slate-string="true">关于今天我们讨论的题目你做到心中有数了吗？今天布置一个源码阅读作业，AQS 中 Node 的 waitStatus 有什么作用？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10975"><span data-slate-object="text" data-key="10976"><span data-slate-leaf="true" data-offset-key="10976:0" data-first-offset="true"><span data-slate-string="true">请你在留言区写写你对这个问题的思考，我会选出经过认真思考的留言，送给你一份学习奖励礼券，欢迎你与我一起讨论。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10977"><span data-slate-object="text" data-key="10978"><span data-slate-leaf="true" data-offset-key="10978:0" data-first-offset="true"><span data-slate-string="true">你的朋友是不是也在准备面试呢？你可以 “请朋友读”，把今天的题目分享给好友，或许你能帮到他。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>18</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-5">精选留言 (32)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI2icbib62icXtibTkThtyRksbuJLoTLMts7zook2S30MiaBtbz0f5JskwYicwqXkhpYfvCpuYkcvPTibEaQ/132"></div></div><div><div><div><span>xuanyuan</span></div></div><div>建议；

1. 希望能有推外内存的主题，范型部分希望能与 cpp 比较讲解。
2. 一些主题如果已经有公开的比较好的资料，可以提供链接，对重点强调即可。希望能看到更多公开资料所没有的信息，这也是老鸟们付费的初衷。
同意的点赞</div><div><div>2018-06-26</div><div><div><i></i><span>5</span></div><div><i></i><span>149</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/8a/fc/d1dd57dd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>ipofss</span></div></div><div>这一讲对于我来说，挺有难度的，还是基础比较薄弱，整体上没太听懂。老师对于 Java 的理解真是太深入了，等我以后技术精进了，再回来看看老师的 36 讲，应该会有新的认识。继续往下听吧，已经懂点的加深理解，没听过的就当是听了名字以后用到了再仔细研究</div><div><div>2018-08-07</div><div><div><i></i><span>4</span></div><div><i></i><span>38</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/1f/2f/e35d6a1d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>I.am DZX</span></div></div><div>CANCELLED 1 因为超时或中断设置为此状态，标志节点不可用
SIGNAL -1 处于此状态的节点释放资源时会唤醒后面的节点
CONDITION -2 处于条件队列里，等待条件成立 (signal signalall) 条件成立后会置入获取资源的队列里
PROPAGATE -3 共享模式下使用，头节点获取资源时将后面节点设置为此状态，如果头节点获取资源后还有足够的资源，则后面节点会尝试获取，这个状态主要是为了共享状态下队列里足够多的节点同时获取资源
0 初始状态</div><div><p>作者回复：好</p></div><div><div>2018-06-26</div><div><div><i></i></div><div><i></i><span>28</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/e3/57/e5de0216.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Cui</span></div></div><div>老师，看了 AQS 的实现原理后，我再回顾了您之前关于 synchronized 的文章，心中有些疑问：
1、synchronized 在 JVM 中是会进行锁升级和降级的，并且是基于 CAS 来掌握竞争的情况，在竞争不多的情况下利用 CAS 的轻量级操作来减少开销。
2、而 AQS 也是基于 CAS 操作队列的，位于队列头的节点优先获得锁，其他的节点会被 LockSupport.park () 起来（这个好像依赖的是操作系统的互斥锁，应该也是个重量级操作）。
我觉得这两种方式都是基于 CAS 操作的，只是操作的对象不同（一个是 Mark Word，一个是队列节点），当竞争较多时，还是不可避免地会使用到操作系统的互斥锁。然而，我再测试这两者的性能时，在无竞争的情况下，两者性能相当，但是，当竞争起来后，AQS 的性能明显比 synchronized 要好（测试案例是 8 个线程并发对一个 int 递增，每个线程递增 1000 万次，AQS 的耗时大概要少 30%），这是为什么呢？</div><div><p>作者回复: Locksupport 的实现据说速度快，我也没具体对比过；不过 jdk9 里，monitor 相关操作也加快了，可以看看 jep143</p></div><div><div>2018-06-26</div><div><div><i></i><span>6</span></div><div><i></i><span>18</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/07/5a/abb7bfe3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>OneThin</span></div></div><div>能否出一节讲一下 unsafe，感觉这个才是最基础的。另外 unsafe 为什么叫 unsafe 呢</div><div><div>2018-07-16</div><div><div><i></i><span>3</span></div><div><i></i><span>16</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/0c/49/d71e939d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 三口先生</span></div></div><div>大于 0 取消状态，小于 0 有效状态，表示等待状态四种 cancelled，signal，condition，propagate</div><div><p>作者回复：不错</p></div><div><div>2018-06-26</div><div><div><i></i></div><div><i></i><span>15</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/MdmRMTV2IwvQZF2IO0G0CFWbKxT9CIibmcdicS3J4SmrA4P1e36jCwyXZpia06ItwP4GibGnCrPJHicBbd5y9libTpiaA/132"></div></div><div><div><div><span>^_^</span></div></div><div>要讲 AQS 的话，这点篇幅远远不够。推荐 b 站寒食君 AQS 的讲解，很详细。</div><div><div>2021-02-18</div><div><div><i></i><span>1</span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/20/39/3168c4ca.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 二木🐶</span></div></div><div>一直很好奇，为何 CAS 指令在发现内容未变的时候就能判断没有其他线程修改呢？可能被修改后的值与比较的值一样呀</div><div><div>2018-06-28</div><div><div><i></i><span>3</span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/6e/84/45a909a6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 卡斯瓦德</span></div></div><div>老师请教个问题，acquireQueued 的源代码中，使用 for（；；）做了个自旋锁吧，作者为什么不用 while（true），这种方式呢，是因为开销不一样吗？</div><div><p>作者回复：也许，这个我不知道具体原因，看上去 while 会比 for 多一个变量</p></div><div><div>2018-07-05</div><div><div><i></i><span>2</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/04/b5/8bc4790b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Geek_987169</span></div></div><div>老师，您说的 "更加紧凑"，是什么意思？不太理解</div><div><div>2019-03-26</div><div><div><i></i><span></span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/14/b1/7d974f0a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 黄明恩</span></div></div><div>老师可否分析下 Object.wait 和 notify 的原理</div><div><div>2018-06-28</div><div><div><i></i><span></span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/05/f3/4dd9e515.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>TonyEasy</span></div></div><div>老师，说实话这一期的对我来说有点难度了，钦佩老师对知识理解的深入，请问老师可以指点下 java 学习的路线图吗，或者您分享下您自己的学习路线。</div><div><p>作者回复：大家基础不一样，以后被问到不生疏也好；关于路线，不知道你的兴趣和规划是什么，通常来说 Java 只是技能树中的一项，项目经验，领域知识，综合起来才能要到高价</p></div><div><div>2018-06-26</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/e9/29/629d9bb0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 天王</span></div></div><div>22 AutomicInteger 原理是什么，cas 原理，cas 操作怎么应用 1 Automic 提供了对 int 类型的原子操作和更新，操作基于 cas 原理，cas 全称 Compare and Swap， cas 的原理是操作前试图获取当前值，在操作时，看值是否改变，如果未改变，代表没有其他线程同步修改，操作成功，已经改变，返回操作失败或者重试。有 2 个属性 jdk.internal.misc.Unsafe u＝idk.internal.misc.Unsafe.getUnsafe (); volatile int value;Long VALUE＝U.objectFiledOffset (AutomicInter.Class,"value"); Unsafe 会利用 value 字段的内存地址偏移完成操作 2 cas 底层实现 依赖于 CPU 底层提供的指令，java 提供了 2 个公共 api 支持 cas 操作，long tid＝Thread.currenThread ().getId (); AutomicFiledUpdator.compareAndSet (this,0l,tid);Automic 包提供了很多原子处理类，是很多原子操作的选择，java.9 以后提供了 Variable Hand Api， private static final VarHandle handle 首先获取句柄，再调用 cas 方法，推荐使用 Variable Handle Api，后续维护有保障，3 AQS AbstractQueueSynchronized 是实现各种同步结构的基础</div><div><div>2020-01-10</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/d4/f3/129d6dfe.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 李二木</span></div></div><div>最近遇到配置 tomcat 连接池，导致 cpu 过高问题，最后发现配置连接池数过大导致上下文切换次数过多
，也就是线程池中任务数过少，空闲的线程过多，我想问为什么会导致上下文切换过多？</div><div><div>2018-06-26</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/43/14/8e2b48fb.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Maxonor Love Muz 🎈</span></div></div><div>老师把原理讲的差不多了，不过光看原理就以为自己会了，那是浅层次的理解。 有必要 把 AQS 源码走一遍</div><div><div>2020-05-12</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/76/48/5ab89daa.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 护爽使者</span></div></div><div>cas  是乐观锁，while 循环</div><div><div>2020-03-22</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/61/c2/94c1d4c9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 今天</span></div></div><div>听起来还是很有难度的，我基础有点差</div><div><div>2020-03-22</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/88/93/26076028.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 七个猪</span></div></div><div>CAS 有部分实现是解决 ABA 问题，可以讲一下 ABA 问题是如何解决的，除了 version 外，还有没有其他的方式</div><div><div>2018-07-09</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/58/5d/8de7f8dc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 爱新觉罗老流氓</span></div></div><div>ReentrantLock 的非公平锁，其实只有一次非公平的机会！那一次就是在 lock 方法中，非公平锁的实现有 if else 分支，在 if 时就进行一次 cas state，成功的线程去执行任务代码去了。那么失败的线程就会进入 else 逻辑，就是 AQS#acquired，从这里开始非公平锁和公平锁就完全一样了，只是公平锁被欺负了一次，它的 lock 方法是直接调 acquired 方法。

为什么只有这一次呢？先看 AQS#acquired，第一个逻辑是 tryAcquired，公平锁和非公平锁实现略有区别。但记住，在这个时刻下，即使你看到公平锁 trtAcquired 实现中多一个 hasQueuedPredecessors 判断，无关紧要，重要的是这个时刻，还没有执行后面的 addWaiter 逻辑，根本没有入队，那么公平锁进入这个 hasXXX 方法，当然也是马上出来，执行后面的 cas state，跟非公平锁没有不同...

如果，AQS#acquired 的第一个 tryAcquired 失败了，都会进入 acquiredQueued，此方法中有个强制的逻辑，就是无限 for 循环中的 final Node p = node.predecessors (); 在这个逻辑下，非平锁锁也要乖乖排队......

以上只是分析了 lock 方法，带超时的 tryLock 方法还没有具体看代码。如果我的 lock 分析有误，欢迎指出批评！</div><div><div>2018-06-27</div><div><div><i></i><span>1</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/dd/b6/fcf322a7.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>antipas</span></div></div><div>看 AQS 源码过程中产生了新问题，它对线程的挂起唤醒是通过 locksupport 实现的，那么它与 wait/notify 又有何不同，使用场景有何不同。我的理解是使用 wait/notify 需要 synchronized 锁，而且 wait 需要条件触发</div><div><p>作者回复：这是两种方式，wait 基于 monitor；一般用并发库就不用 Object.wait、notify 之类了</p></div><div><div>2018-06-26</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1w"><outline class="toc-level-h1" data-reactid=".1w.0" style="width: 175px;"><active data-reactid=".1w.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1w.0.1"><span data-reactid=".1w.0.1.0">第 22 讲 | AtomicInteger 底层实现原理是什么？如何在自己的产品代码中应用 CAS 操作？</span></a></outline><outline class="toc-level-h2" data-reactid=".1w.1" style="width: 165px;"><active data-reactid=".1w.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1w.1.1"><span data-reactid=".1w.1.1.0">典型回答</span></a></outline><outline class="toc-level-h2" data-reactid=".1w.2" style="width: 165px;"><active data-reactid=".1w.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1w.2.1"><span data-reactid=".1w.2.1.0">考点分析</span></a></outline><outline class="toc-level-h2" data-reactid=".1w.3" style="width: 165px;"><active data-reactid=".1w.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1w.3.1"><span data-reactid=".1w.3.1.0">知识扩展</span></a></outline><outline class="toc-level-h2" data-reactid=".1w.4" style="width: 165px;"><active data-reactid=".1w.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1w.4.1"><span data-reactid=".1w.4.1.0">一课一练</span></a></outline><outline class="toc-level-h2" data-reactid=".1w.5" style="width: 165px;"><active data-reactid=".1w.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1w.5.1"><span data-reactid=".1w.5.1.0">精选留言 (32)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/9788" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>