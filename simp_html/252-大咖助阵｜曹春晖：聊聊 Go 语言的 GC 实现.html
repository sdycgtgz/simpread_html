
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 大咖助阵｜曹春晖：聊聊 Go 语言的 GC 实现</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>大咖助阵｜曹春晖：聊聊 Go 语言的 GC 实现</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">继续挑战核心篇的即学即练吧！</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">大咖助阵｜曹春晖：聊聊 Go 语言的 GC 实现</h1><div><span>曹春晖</span> <span> 2022-02-04</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/22/e6/22ecf3cee101ec449ac3bbc017b86ae6.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：大荣</span><span>大小：22.12M</span><span> 时长：24:13</span></div></div><audio title="大咖助阵｜曹春晖：聊聊 Go 语言的 GC 实现" src="https://res001.geekbang.org/media/audio/10/94/10ba000eee432f174af72098ed880d94/ld/ld.m3u8" __idm_id__="262158"></audio></div><div><div><div><div data-slate-editor="true" data-key="12512" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="block-quote" data-slate-object="block" data-key="12513"><div data-slate-type="quote-line" data-slate-object="block" data-key="12514"><span data-slate-object="text" data-key="12515"><span data-slate-leaf="true" data-offset-key="12515:0" data-first-offset="true"><span data-slate-string="true">作者注：本文只作了解，不建议作为面试题考察。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12516"><span data-slate-object="text" data-key="12517"><span data-slate-leaf="true" data-offset-key="12517:0" data-first-offset="true"><span data-slate-string="true">你好，我是曹春晖，是《Go 语言高级编程》的作者之一。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12518"><span data-slate-object="text" data-key="12519"><span data-slate-leaf="true" data-offset-key="12519:0" data-first-offset="true"><span data-slate-string="true">今天我想跟你分享一下 Go 语言内存方面的话题，聊一聊 Go 语言中的垃圾回收（GC）机制的实现，希望你能从中有所收获。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12520" id="sr-toc-1"><span data-slate-object="text" data-key="12521"><span data-slate-leaf="true" data-offset-key="12521:0" data-first-offset="true"><span data-slate-string="true">武林秘籍救不了段错误</span></span></span></h2><div data-slate-type="image" data-slate-object="block" data-key="12522"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/5f/c8/5f4574358998f372abcab606df8803c8.png?wh=500x300"></div><div>包教包会包分配</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12523"><span data-slate-object="text" data-key="12524"><span data-slate-leaf="true" data-offset-key="12524:0" data-first-offset="true"><span data-slate-string="true">在各种流传甚广的 C 语言葵花宝典里，一般都有这么一条神秘的规则，不能返回局部变量：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="12525"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12526"><span data-slate-object="text" data-key="12527"><span data-slate-leaf="true" data-offset-key="12527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12528"><span data-slate-leaf="true" data-offset-key="12528:0" data-first-offset="true"><span data-slate-string="true"> * func(</span></span></span><span data-slate-object="text" data-key="12529"><span data-slate-leaf="true" data-offset-key="12529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12530"><span data-slate-leaf="true" data-offset-key="12530:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12531"><span data-slate-object="text" data-key="12532"><span data-slate-leaf="true" data-offset-key="12532:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12533"><span data-slate-leaf="true" data-offset-key="12533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12534"><span data-slate-leaf="true" data-offset-key="12534:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12535"><span data-slate-leaf="true" data-offset-key="12535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">num</span></span></span></span><span data-slate-object="text" data-key="12536"><span data-slate-leaf="true" data-offset-key="12536:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="12537"><span data-slate-leaf="true" data-offset-key="12537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1234</span></span></span></span><span data-slate-object="text" data-key="12538"><span data-slate-leaf="true" data-offset-key="12538:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12539"><span data-slate-object="text" data-key="12540"><span data-slate-leaf="true" data-offset-key="12540:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12541"><span data-slate-leaf="true" data-offset-key="12541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* ... */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12542"><span data-slate-object="text" data-key="12543"><span data-slate-leaf="true" data-offset-key="12543:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12544"><span data-slate-leaf="true" data-offset-key="12544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12545"><span data-slate-leaf="true" data-offset-key="12545:0" data-first-offset="true"><span data-slate-string="true"> &amp;</span></span></span><span data-slate-object="text" data-key="12546"><span data-slate-leaf="true" data-offset-key="12546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">num</span></span></span></span><span data-slate-object="text" data-key="12547"><span data-slate-leaf="true" data-offset-key="12547:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12548"><span data-slate-object="text" data-key="12549"><span data-slate-leaf="true" data-offset-key="12549:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12550"><span data-slate-object="text" data-key="12551"><span data-slate-leaf="true" data-offset-key="12551:0" data-first-offset="true"><span data-slate-string="true">duang!</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12552"><span data-slate-object="text" data-key="12553"><span data-slate-leaf="true" data-offset-key="12553:0" data-first-offset="true"><span data-slate-string="true">当函数返回后，函数的栈帧（stack frame）就会被销毁，引用了被销毁位置的内存，轻则数据错乱，重则 segmentation fault。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12554"><span data-slate-object="text" data-key="12555"><span data-slate-leaf="true" data-offset-key="12555:0" data-first-offset="true"><span data-slate-string="true">可以说，即使经过了八十一难，终于成为了 C 语言绝世高手，我们还是逃不过复杂的堆上对象引用关系导致的 dangling pointer：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12556"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/8c/73/8c834c68ab195cc01200a84fc942bc73.gif?wh=984x616"></div><div>当 B 被 free 掉之后</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12557"><span data-slate-object="text" data-key="12558"><span data-slate-leaf="true" data-offset-key="12558:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_800af3dc" data-attr-id="41187" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">你看，在这张图中，当 B 被 free 掉之后，应用程序依然可能会使用指向 B 的指针，这就是比较典型的 dangling pointer 问题，</span></span></span><span data-slate-leaf="true" data-offset-key="12558:1"><span data-slate-string="true">堆上的对象依赖关系可能会非常复杂。所以，我们要正确地写出 free 逻辑，还得先把对象图给画出来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12559"><span data-slate-object="text" data-key="12560"><span data-slate-leaf="true" data-offset-key="12560:0" data-first-offset="true"><span data-slate-string="true">不过，依赖人去处理复杂的对象内存管理的问题是不科学、不合理的。C 和 C++ 程序员已经被折磨了数十年，我们不应该再重蹈覆辙了，于是，后来的很多编程语言就用上垃圾回收（GC）机制。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12561" id="sr-toc-2"><span data-slate-object="text" data-key="12562"><span data-slate-leaf="true" data-offset-key="12562:0" data-first-offset="true"><span data-slate-string="true">GC 拯救程序员</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12563"><span data-slate-object="text" data-key="12564"><span data-slate-leaf="true" data-offset-key="12564:0" data-first-offset="true"><span data-slate-string="true">垃圾回收（Garbage Collection）也被称为自动内存管理技术，在现代编程语言中使用得相当广泛，常见的 Java、Go、C# 均在语言的 runtime 中集成了相应的实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12565"><span data-slate-object="text" data-key="12566"><span data-slate-leaf="true" data-offset-key="12566:0" data-first-offset="true"><span data-slate-string="true">在传统的不带 GC 的编程语言中，我们需要关注对象的分配位置，要自己去选择对象是分配在堆还是栈上，但在 Go 这门有 GC 的语言中，集成了逃逸分析功能来帮助我们自动判断对象应该在堆上还是栈上，我们可以使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="12567"><span data-slate-object="text" data-key="12568"><span data-slate-leaf="true" data-offset-key="12568:0" data-first-offset="true"><span data-slate-string="true">go build -gcflags="-m"</span></span></span></span><span data-slate-object="text" data-key="12569"><span data-slate-leaf="true" data-offset-key="12569:0" data-first-offset="true"><span data-slate-string="true"> 来观察逃逸分析的结果：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="12570"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12571"><span data-slate-object="text" data-key="12572"><span data-slate-leaf="true" data-offset-key="12572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="12573"><span data-slate-leaf="true" data-offset-key="12573:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12574"></div><div data-slate-type="code-line" data-slate-object="block" data-key="12575"><span data-slate-object="text" data-key="12576"><span data-slate-leaf="true" data-offset-key="12576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="12577"><span data-slate-leaf="true" data-offset-key="12577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12578"><span data-slate-leaf="true" data-offset-key="12578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="12579"><span data-slate-leaf="true" data-offset-key="12579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="12580"><span data-slate-leaf="true" data-offset-key="12580:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12581"><span data-slate-object="text" data-key="12582"><span data-slate-leaf="true" data-offset-key="12582:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12583"><span data-slate-leaf="true" data-offset-key="12583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="12584"><span data-slate-leaf="true" data-offset-key="12584:0" data-first-offset="true"><span data-slate-string="true"> m = </span></span></span><span data-slate-object="text" data-key="12585"><span data-slate-leaf="true" data-offset-key="12585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="12586"><span data-slate-leaf="true" data-offset-key="12586:0" data-first-offset="true"><span data-slate-string="true">([]</span></span></span><span data-slate-object="text" data-key="12587"><span data-slate-leaf="true" data-offset-key="12587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12588"><span data-slate-leaf="true" data-offset-key="12588:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12589"><span data-slate-leaf="true" data-offset-key="12589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10240</span></span></span></span><span data-slate-object="text" data-key="12590"><span data-slate-leaf="true" data-offset-key="12590:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12591"><span data-slate-object="text" data-key="12592"><span data-slate-leaf="true" data-offset-key="12592:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12593"><span data-slate-leaf="true" data-offset-key="12593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="12594"><span data-slate-leaf="true" data-offset-key="12594:0" data-first-offset="true"><span data-slate-string="true">(m[</span></span></span><span data-slate-object="text" data-key="12595"><span data-slate-leaf="true" data-offset-key="12595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12596"><span data-slate-leaf="true" data-offset-key="12596:0" data-first-offset="true"><span data-slate-string="true">])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12597"><span data-slate-object="text" data-key="12598"><span data-slate-leaf="true" data-offset-key="12598:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12599"><span data-slate-object="text" data-key="12600"><span data-slate-leaf="true" data-offset-key="12600:0" data-first-offset="true"><span data-slate-string="true">你可以看到，较大的对象也会被放在堆上。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12601"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/b9/f1/b9d2859c1c108213620a17e805a69bf1.png?wh=1654x234"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12602"><span data-slate-object="text" data-key="12603"><span data-slate-leaf="true" data-offset-key="12603:0" data-first-offset="true"><span data-slate-string="true">这里，执行 gcflags=“-m” 的输出，我们就可以看到发生了逃逸。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12604"><span data-slate-object="text" data-key="12605"><span data-slate-leaf="true" data-offset-key="12605:0" data-first-offset="true"><span data-slate-string="true">若对象被分配在栈上，它的管理成本就比较低，我们通过挪动栈顶寄存器就可以实现对象的分配和释放。若对象被分配在堆上，我们就要经历层层的内存申请过程。但这些流程对用户都是透明的，在编写代码时我们并不需要在意它。只有需要优化时，我们才需要研究具体的逃逸分析规则。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12606"><span data-slate-object="text" data-key="12607"><span data-slate-leaf="true" data-offset-key="12607:0" data-first-offset="true"><span data-slate-string="true">逃逸分析与垃圾回收结合在一起，极大地解放了程序员们的心智，我们在编写代码时，似乎再也没必要去担心内存的分配和释放问题了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12608"><span data-slate-object="text" data-key="12609"><span data-slate-leaf="true" data-offset-key="12609:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">然而，一切抽象皆有成本，这个成本要么花在编译期，要么花在运行期。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12610"><span data-slate-object="text" data-key="12611"><span data-slate-leaf="true" data-offset-key="12611:0" data-first-offset="true"><span data-slate-string="true">GC 这种方案是选择在运行期来解决问题，不过在极端场景下 GC 本身引起的问题依然是令人难以忽视的：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12612"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/45/31/4561e0c863e3af8b4d785b31714fdd31.png?wh=1894x624"></div><div>图来自网友，GC 使用了 90% 以上的 CPU 资源</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12613"><span data-slate-object="text" data-key="12614"><span data-slate-leaf="true" data-offset-key="12614:0" data-first-offset="true"><span data-slate-string="true">这张图的场景是在内存中缓存了上亿的 kv，这时 GC 使用的 CPU 甚至占到了总 CPU 占用的 90% 以上。简单粗暴地在内存中缓存对象，到头来发现 GC 成为了 CPU 杀手，吃掉了大量的服务器资源，这显然不是我们期望的结果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12615"><span data-slate-object="text" data-key="12616"><span data-slate-leaf="true" data-offset-key="12616:0" data-first-offset="true"><span data-slate-string="true">想要正确地分析原因，就需要我们对 GC 本身的实现机制有稍微深入一些的理解。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12617" id="sr-toc-3"><span data-slate-object="text" data-key="12618"><span data-slate-leaf="true" data-offset-key="12618:0" data-first-offset="true"><span data-slate-string="true">内存管理的三个参与者</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12619"><span data-slate-object="text" data-key="12620"><span data-slate-leaf="true" data-offset-key="12620:0" data-first-offset="true"><span data-slate-string="true">当讨论内存管理问题时，我们主要会讲三个参与者，mutator，allocator 和 garbage collector。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12621"><div data-slate-type="list-line" data-slate-object="block" data-key="12622"><span data-slate-object="text" data-key="12623"><span data-slate-leaf="true" data-offset-key="12623:0" data-first-offset="true"><span data-slate-string="true">mutator 指的是我们的应用，也就是 application，我们将堆上的对象看作一个图，跳出应用来看的话，应用的代码就是在不停地修改这张堆对象图里的指向关系。下面的图可以帮我们理解 mutator 对堆上的对象的影响：</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="12624"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/13/56/131e1a3e08e0c2fcac022c197c433556.gif?wh=1228x676"></div><div>应用运行过程中会不断修改对象的引用关系</div></div><div data-slate-type="list" data-slate-object="block" data-key="12625"><div data-slate-type="list-line" data-slate-object="block" data-key="12626"><span data-slate-object="text" data-key="12627"><span data-slate-leaf="true" data-offset-key="12627:0" data-first-offset="true"><span data-slate-string="true">allocator 就很好理解了，指的是内存分配器，应用需要内存的时候都要向 allocator 申请。allocator 要维护好内存分配的数据结构，在多线程场景下工作的内存分配器还需要考虑高并发场景下锁的影响，并针对性地进行设计以降低锁冲突。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12628"><span data-slate-object="text" data-key="12629"><span data-slate-leaf="true" data-offset-key="12629:0" data-first-offset="true"><span data-slate-string="true">collector 是垃圾回收器。死掉的堆对象、不用的堆内存都要由 collector 回收，最终归还给操作系统。当 GC 扫描流程开始执行时，collector 需要扫描内存中存活的堆对象，扫描完成后，未被扫描到的对象就是无法访问的堆上垃圾，需要将其占用内存回收掉。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12630"><span data-slate-object="text" data-key="12631"><span data-slate-leaf="true" data-offset-key="12631:0" data-first-offset="true"><span data-slate-string="true">三者的交互过程可以用下图来表示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12632"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/09/yy/093e3db4643e289d0803943124115dyy.png?wh=1920x1268"></div><div>mutator、allocator 和 collector 的交互过程</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12633"><span data-slate-object="text" data-key="12634"><span data-slate-leaf="true" data-offset-key="12634:0" data-first-offset="true"><span data-slate-string="true">我们可以看到，应用需要在堆上申请内存时，会由编译器帮程序员自动调用 runtime.newobject，这时 allocator 会使用 mmap 这个系统调用从操作系统中申请内存，若 allocator 发现之前申请的内存还有富余，会从本地预先分配的数据结构中划分出一块内存，并把它以指针的形式返回给应用。在内存分配的过程中，allocator 要负责维护内存管理对应的数据结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12635"><span data-slate-object="text" data-key="12636"><span data-slate-leaf="true" data-offset-key="12636:0" data-first-offset="true"><span data-slate-string="true">而 collector 要扫描的就是 allocator 管理的这些数据结构，应用不再使用的部分便应该被回收，通过 madvise 这个系统调用返还给操作系统。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12637"><span data-slate-object="text" data-key="12638"><span data-slate-leaf="true" data-offset-key="12638:0" data-first-offset="true"><span data-slate-string="true">现在我们来看看这些交互的细节吧。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12639" id="sr-toc-4"><span data-slate-object="text" data-key="12640"><span data-slate-leaf="true" data-offset-key="12640:0" data-first-offset="true"><span data-slate-string="true">分配内存</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12641"><span data-slate-object="text" data-key="12642"><span data-slate-leaf="true" data-offset-key="12642:0" data-first-offset="true"><span data-slate-string="true">应用程序使用 mmap 向 OS 申请内存，操作系统提供的接口比较简单，mmap 返回的结果是连续的内存区域。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12643"><span data-slate-object="text" data-key="12644"><span data-slate-leaf="true" data-offset-key="12644:0" data-first-offset="true"><span data-slate-string="true">mutator 申请内存是以应用视角来看问题。比如说，我需要的是某一个 struct 和某一个 slice 对应的内存，这与从操作系统中获取内存的接口之间还有一个鸿沟。这就需要由 allocator 进行映射与转换，将以 “块” 来看待的内存与以 “对象” 来看待的内存进行映射：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12645"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/92/76/926bc8690be714ed9140f25c0e03c276.png?wh=1556x782"></div><div>应用代码中的对象与内存间怎么做映射？</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12646"><span data-slate-object="text" data-key="12647"><span data-slate-leaf="true" data-offset-key="12647:0" data-first-offset="true"><span data-slate-string="true">你可以从上面这张图看到，在应用的视角看，我们需要初始化的 a 是一个 1024000 长度的 int 切片；在内存管理的视角来看，我们需要管理的只是 start、offset 对应的一段内存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12648"><span data-slate-object="text" data-key="12649"><span data-slate-leaf="true" data-offset-key="12649:0" data-first-offset="true"><span data-slate-string="true">在现代 CPU 上，除了内存分配的正确性以外，我们还要考虑分配过程的效率问题，应用执行期间小对象会不断地生成与销毁，如果每一次对象的分配与释放都需要与操作系统交互，那么成本是很高的。这就需要我们在应用层设计好内存分配的多级缓存，尽量减少小对象高频创建与销毁时的锁竞争，这个问题在传统的 C/C++ 语言中已经有了解法，那就是 tcmalloc：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12650"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/fd/60/fd5c558298850305b5dae88b856d1c60.png?wh=833x353"></div><div>tcmalloc 的全局图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12651"><span data-slate-object="text" data-key="12652"><span data-slate-leaf="true" data-offset-key="12652:0" data-first-offset="true"><span data-slate-string="true">你可以看到，tcmalloc 通过维护一套多级缓存结构，降低了应用内存分配过程中对全局锁的使用频率，使小对象的内存分配做到了</span></span></span><span data-slate-object="text" data-key="12653"><span data-slate-leaf="true" data-offset-key="12653:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">尽量无锁</span></span></span></span><span data-slate-object="text" data-key="12654"><span data-slate-leaf="true" data-offset-key="12654:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12655"><span data-slate-object="text" data-key="12656"><span data-slate-leaf="true" data-offset-key="12656:0" data-first-offset="true"><span data-slate-string="true">Go 语言的内存分配器基本是 tcmalloc 的 1:1 搬运…… 毕竟都是 Google 的项目。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12657"><span data-slate-object="text" data-key="12658"><span data-slate-leaf="true" data-offset-key="12658:0" data-first-offset="true"><span data-slate-string="true">在 Go 语言中，根据对象中是否有指针以及对象的大小，将内存分配过程分为三类：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12659"><div data-slate-type="list-line" data-slate-object="block" data-key="12660"><span data-slate-object="text" data-key="12661"><span data-slate-leaf="true" data-offset-key="12661:0" data-first-offset="true"><span data-slate-string="true">tiny ：size &lt;16 bytes &amp;&amp; has no pointer(noscan)；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12662"><span data-slate-object="text" data-key="12663"><span data-slate-leaf="true" data-offset-key="12663:0" data-first-offset="true"><span data-slate-string="true">small ：has pointer(scan) || (size &gt;= 16 bytes &amp;&amp; size &lt;= 32 KB)；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12664"><span data-slate-object="text" data-key="12665"><span data-slate-leaf="true" data-offset-key="12665:0" data-first-offset="true"><span data-slate-string="true">large ：size &gt; 32 KB。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12666"><span data-slate-object="text" data-key="12667"><span data-slate-leaf="true" data-offset-key="12667:0" data-first-offset="true"><span data-slate-string="true">接下来我们一个个分析。在内存分配过程中，最复杂的就是 tiny 类型的分配。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12668"><span data-slate-object="text" data-key="12669"><span data-slate-leaf="true" data-offset-key="12669:0" data-first-offset="true"><span data-slate-string="true">我们可以将内存分配的路径与 CPU 的多级缓存作类比，这里 mcache 内部的 tiny 可以类比为 L1 cache，而 alloc 数组中的元素可以类比为 L2 cache，全局的 mheap.mcentral 结构为 L3 cache，mheap.arenas 是 L4，L4 是以页为单位将内存向下派发的，由 pageAlloc 来管理 arena 中的空闲内存。具体你可以看下这张表：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12670"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/13/8c/13be38850045c513f9393da115fdc18c.jpg?wh=856x268"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12671"><span data-slate-object="text" data-key="12672"><span data-slate-leaf="true" data-offset-key="12672:0" data-first-offset="true"><span data-slate-string="true">如果 L4 也没法满足我们的内存分配需求，那我们就需要向操作系统去要内存了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12673"><span data-slate-object="text" data-key="12674"><span data-slate-leaf="true" data-offset-key="12674:0" data-first-offset="true"><span data-slate-string="true">和 tiny 的四级分配路径相比，small 类型的内存没有本地的 mcache.tiny 缓存，其余的与 tiny 分配路径完全一致：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12675"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/b0/5f/b0f9dbb98c61175265e79c1a222d475f.jpg?wh=834x256"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12676"><span data-slate-object="text" data-key="12677"><span data-slate-leaf="true" data-offset-key="12677:0" data-first-offset="true"><span data-slate-string="true">large 内存分配稍微特殊一些，没有前面这两类这样复杂的缓存流程，而是直接从 mheap.arenas 中要内存，直接走 pageAlloc 页分配器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12678"><span data-slate-object="text" data-key="12679"><span data-slate-leaf="true" data-offset-key="12679:0" data-first-offset="true"><span data-slate-string="true">页分配器在 Go 语言中迭代了多个版本，从简单的 freelist 结构，到 treap 结构，再到现在最新版本的 radix 结构，它的查找时间复杂度也从 O (N) -&gt; O (log (n)) -&gt; O (1)。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12680"><span data-slate-object="text" data-key="12681"><span data-slate-leaf="true" data-offset-key="12681:0" data-first-offset="true"><span data-slate-string="true">在当前版本中，我们只需要知道常数时间复杂度就可以确定空闲页组成的 radix tree 是否能够满足内存分配需求。若不满足，则要对 arena 继续进行切分，或向操作系统申请更多的 arena。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12682"><span data-slate-object="text" data-key="12683"><span data-slate-leaf="true" data-offset-key="12683:0" data-first-offset="true"><span data-slate-string="true">只看这些分类文字不太好理解，接下来我们看看 arenas、page、mspan、alloc 这些概念是怎么关联在一起组成 Go 的内存分配流程的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12684" id="sr-toc-5"><span data-slate-object="text" data-key="12685"><span data-slate-leaf="true" data-offset-key="12685:0" data-first-offset="true"><span data-slate-string="true">内存分配的数据结构之间的关系</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12686"><span data-slate-object="text" data-key="12687"><span data-slate-leaf="true" data-offset-key="12687:0" data-first-offset="true"><span data-slate-string="true">arenas 是 Go 向操作系统申请内存时的最小单位，每个 arena 为 64MB 大小，在内存中可以部分连续，但整体是个稀疏结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12688"><span data-slate-object="text" data-key="12689"><span data-slate-leaf="true" data-offset-key="12689:0" data-first-offset="true"><span data-slate-string="true">单个 arena 会被切分成以 8KB 为单位的 page，由 page allocator 管理，一个或多个 page 可以组成一个 mspan，每个 mspan 可以按照 sizeclass 再划分成多个 element。同样大小的 mspan 又分为 scan 和 noscan 两种，分别对应内部有指针的 object 和内部没有指针的 object。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12690"><span data-slate-object="text" data-key="12691"><span data-slate-leaf="true" data-offset-key="12691:0" data-first-offset="true"><span data-slate-string="true">之前讲到的四级分配结构如下图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12692"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/0b/9a/0be6329b8a9a40d3eaa693c2e6b3ed9a.png?wh=1920x1500"></div><div>各种内存分配结构之间的关系，图上省略了页分配器的结构</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12693"><span data-slate-object="text" data-key="12694"><span data-slate-leaf="true" data-offset-key="12694:0" data-first-offset="true"><span data-slate-string="true">你可以从上图清晰地看到内存分配的多级路径，我们可以再研究一下这里面的 mspan。每一个 mspan 都有一个 allocBits 结构，从 mspan 里分配 element 时，我们只要将 mspan 中对应该 element 位置的 bit 位置一就可以了，其实就是将 mspan 对应 allocBits 中的对应 bit 位置一。每一个 mspan 都会对应一个 allocBits 结构，如下图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12695"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e9/5f/e9c7b25f9fc787c7317a07aac648d65f.png?wh=1664x726"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12696"><span data-slate-object="text" data-key="12697"><span data-slate-leaf="true" data-offset-key="12697:0" data-first-offset="true"><span data-slate-string="true">当然，在代码中还有一些位操作优化（如 freeIndex、allocCache），你课后可以再去探索一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12698"><span data-slate-object="text" data-key="12699"><span data-slate-leaf="true" data-offset-key="12699:0" data-first-offset="true"><span data-slate-string="true">了解了 Go 语言中内存管理和内存分配的基础知识之后，我们就可以具体看看 Go 语言中垃圾回收的实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12700" id="sr-toc-6"><span data-slate-object="text" data-key="12701"><span data-slate-leaf="true" data-offset-key="12701:0" data-first-offset="true"><span data-slate-string="true">垃圾回收</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12702"><span data-slate-object="text" data-key="12703"><span data-slate-leaf="true" data-offset-key="12703:0" data-first-offset="true"><span data-slate-string="true">Go 语言使用了</span></span></span><span data-slate-object="text" data-key="12704"><span data-slate-leaf="true" data-offset-key="12704:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">并发标记与清扫算法</span></span></span></span><span data-slate-object="text" data-key="12705"><span data-slate-leaf="true" data-offset-key="12705:0" data-first-offset="true"><span data-slate-string="true">作为它的 GC 实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12706"><span data-slate-object="text" data-key="12707"><span data-slate-leaf="true" data-offset-key="12707:0" data-first-offset="true"><span data-slate-string="true">标记、清扫算法是一种古老的 GC 算法，是指将内存中正在使用的对象进行标记，之后清扫掉那些未被标记的对象的一种垃圾回收算法。并发标记与清扫重点在</span></span></span><span data-slate-object="text" data-key="12708"><span data-slate-leaf="true" data-offset-key="12708:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">并发</span></span></span></span><span data-slate-object="text" data-key="12709"><span data-slate-leaf="true" data-offset-key="12709:0" data-first-offset="true"><span data-slate-string="true">，是指垃圾回收的</span></span></span><span data-slate-object="text" data-key="12710"><span data-slate-leaf="true" data-offset-key="12710:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">标记和清扫过程能够与应用代码并发执行</span></span></span></span><span data-slate-object="text" data-key="12711"><span data-slate-leaf="true" data-offset-key="12711:0" data-first-offset="true"><span data-slate-string="true">。但并发标记清扫算法的一大缺陷是无法解决内存碎片问题，而 tcmalloc 恰好一定程度上缓解了内存碎片问题，两者配合使用相得益彰。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12712"><span data-slate-object="text" data-key="12713"><span data-slate-leaf="true" data-offset-key="12713:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">但这并不是说 tcmalloc 完全没有内存碎片，不信你可以在代码里搜搜 max waste</span></span></span></span><span data-slate-object="text" data-key="12714"><span data-slate-leaf="true" data-offset-key="12714:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12715" id="sr-toc-7"><span data-slate-object="text" data-key="12716"><span data-slate-leaf="true" data-offset-key="12716:0" data-first-offset="true"><span data-slate-string="true">垃圾分类</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12717"><span data-slate-object="text" data-key="12718"><span data-slate-leaf="true" data-offset-key="12718:0" data-first-offset="true"><span data-slate-string="true">进行垃圾回收之前，我们要先对内存垃圾进行分类，主要可以分为语义垃圾和语法垃圾两类，但并不是所有垃圾都可以被垃圾回收器回收。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12719"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/69/85/690e321578d8a90c5808a63656af9485.png?wh=512x218"></div><div>语法垃圾和语义垃圾</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12720"><span data-slate-object="text" data-key="12721"><span data-slate-leaf="true" data-offset-key="12721:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">语义垃圾（semantic garbage）</span></span></span></span><span data-slate-object="text" data-key="12722"><span data-slate-leaf="true" data-offset-key="12722:0" data-first-offset="true"><span data-slate-string="true">，有些场景也被称为内存泄露，指的是从语法上可达（可以通过局部、全局变量被引用）的对象，但从语义上来讲他们是垃圾，垃圾回收器对此无能为力。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12723"><span data-slate-object="text" data-key="12724"><span data-slate-leaf="true" data-offset-key="12724:0" data-first-offset="true"><span data-slate-string="true">我们来看一个语义垃圾在 Go 语言中的实例：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12725"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/8e/d5/8eb4fc5be983a6821b0581eab2a3aed5.png?wh=1900x1072"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12726"><span data-slate-object="text" data-key="12727"><span data-slate-leaf="true" data-offset-key="12727:0" data-first-offset="true"><span data-slate-string="true">这里，我们初始化了一个 slice，元素均为指针，每个指针都指向了堆上 10MB 大小的一个对象。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12728"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a4/87/a45499dab31de5e0888d3002e3529387.png?wh=1870x1174"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12729"><span data-slate-object="text" data-key="12730"><span data-slate-leaf="true" data-offset-key="12730:0" data-first-offset="true"><span data-slate-string="true">当这个 slice 缩容时，底层数组的后两个元素已经无法再访问了，但它关联的堆上内存依然是无法释放的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12731"><span data-slate-object="text" data-key="12732"><span data-slate-leaf="true" data-offset-key="12732:0" data-first-offset="true"><span data-slate-string="true">碰到类似的场景，你可能需要在缩容前，</span></span></span><span data-slate-object="text" data-key="12733"><span data-slate-leaf="true" data-offset-key="12733:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">先将数组元素置为 nil</span></span></span></span><span data-slate-object="text" data-key="12734"><span data-slate-leaf="true" data-offset-key="12734:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12735"><span data-slate-object="text" data-key="12736"><span data-slate-leaf="true" data-offset-key="12736:0" data-first-offset="true"><span data-slate-string="true">另外一种内存垃圾就是</span></span></span><span data-slate-object="text" data-key="12737"><span data-slate-leaf="true" data-offset-key="12737:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">语法垃圾（syntactic garbage）</span></span></span></span><span data-slate-object="text" data-key="12738"><span data-slate-leaf="true" data-offset-key="12738:0" data-first-offset="true"><span data-slate-string="true">，讲的是那些从语法上无法到达的对象，这些才是垃圾收集器主要的收集目标。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12739"><span data-slate-object="text" data-key="12740"><span data-slate-leaf="true" data-offset-key="12740:0" data-first-offset="true"><span data-slate-string="true">我们用一个简单的例子来理解一下语法垃圾：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12741"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f6/f3/f687c68dbf35ee45b208e561352493f3.png?wh=1152x978"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12742"><span data-slate-object="text" data-key="12743"><span data-slate-leaf="true" data-offset-key="12743:0" data-first-offset="true"><span data-slate-string="true">这段代码中，在 allocOnHeap 返回后，堆上的 a 无法访问，便成为了语法垃圾。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12744"><span data-slate-object="text" data-key="12745"><span data-slate-leaf="true" data-offset-key="12745:0" data-first-offset="true"><span data-slate-string="true">现在，我们已经明白了垃圾回收的对象是语法垃圾，那 Go GC 的执行流程具体是怎么样的呢？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12746" id="sr-toc-8"><span data-slate-object="text" data-key="12747"><span data-slate-leaf="true" data-offset-key="12747:0" data-first-offset="true"><span data-slate-string="true">GC 流程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12748"><span data-slate-object="text" data-key="12749"><span data-slate-leaf="true" data-offset-key="12749:0" data-first-offset="true"><span data-slate-string="true">Go 的每一轮版本迭代几乎都会对 GC 做优化。经过多次优化后，较新的 GC 流程如下图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12750"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/64/7b/64d7433118dc109f6616c07681bc127b.png?wh=1920x738"></div><div>GC 执行流程</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12751"><span data-slate-object="text" data-key="12752"><span data-slate-leaf="true" data-offset-key="12752:0" data-first-offset="true"><span data-slate-string="true">在这张图中，你可以看到，在并发标记开始前和并发标记终止时，有两个短暂的 stw，该 stw 可以使用 pprof 的 pauseNs 来观测，也可以直接采集到监控系统中：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12753"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/a0/2c/a0b73ddd6dbeca15dc491d4738af332c.png?wh=1514x414"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12754"><span data-slate-object="text" data-key="12755"><span data-slate-leaf="true" data-offset-key="12755:0" data-first-offset="true"><span data-slate-string="true">监控系统中的 PauseNs 就是每次 stw 的时长。尽管官方声称 Go 的 stw 已经是亚毫秒级了，但我们在高压力的系统中仍然能够看到毫秒级的 stw。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12756"><span data-slate-object="text" data-key="12757"><span data-slate-leaf="true" data-offset-key="12757:0" data-first-offset="true"><span data-slate-string="true">对 Go GC 流程有了一些基本了解后，我们现在 “划重点”，具体看看 Go GC 中的那些关键流程和关键问题。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12758" id="sr-toc-9"><span data-slate-object="text" data-key="12759"><span data-slate-leaf="true" data-offset-key="12759:0" data-first-offset="true"><span data-slate-string="true">标记流程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12760"><span data-slate-object="text" data-key="12761"><span data-slate-leaf="true" data-offset-key="12761:0" data-first-offset="true"><span data-slate-string="true">Go 语言使用三色抽象作为其并发标记的实现。所以这里我们首先要理解三种颜色的抽象：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12762"><div data-slate-type="list-line" data-slate-object="block" data-key="12763"><span data-slate-object="text" data-key="12764"><span data-slate-leaf="true" data-offset-key="12764:0" data-first-offset="true"><span data-slate-string="true">黑表示已经扫描完毕，子节点扫描完毕（gcmarkbits = 1，且在队列外）；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12765"><span data-slate-object="text" data-key="12766"><span data-slate-leaf="true" data-offset-key="12766:0" data-first-offset="true"><span data-slate-string="true">灰表示已经扫描完毕，子节点未扫描完毕（gcmarkbits = 1, 在队列内）；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12767"><span data-slate-object="text" data-key="12768"><span data-slate-leaf="true" data-offset-key="12768:0" data-first-offset="true"><span data-slate-string="true">白表示未扫描，collector 不知道任何相关信息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12769"><span data-slate-object="text" data-key="12770"><span data-slate-leaf="true" data-offset-key="12770:0" data-first-offset="true"><span data-slate-string="true">使用三色抽象，主要是为了能让垃圾回收流程与应用流程并发执行，这样将对象扫描过程拆分为多个阶段，不需要一次性完成整个扫描流程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12771"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e8/11/e87f2cc71ea90d0e2a084211d33cf311.jpeg?wh=1920x1080"></div><div>GC 线程与应用线程大部分情况下是并发执行的</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12772"><span data-slate-object="text" data-key="12773"><span data-slate-leaf="true" data-offset-key="12773:0" data-first-offset="true"><span data-slate-string="true">GC 扫描的起点是根对象，忽略掉那些不重要的（finalizer 相关的先省略），常见的根对象可以参见下图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12774"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/db/f5/dbc5ab091c2ac0f026ebddc97926fef5.png?wh=1920x1301"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12775"><span data-slate-object="text" data-key="12776"><span data-slate-leaf="true" data-offset-key="12776:0" data-first-offset="true"><span data-slate-string="true">所以在 Go 语言中，从根开始扫描的含义是从 .bss 段，.data 段以及 goroutine 的栈开始扫描，最终遍历整个堆上的对象树。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12777"><span data-slate-object="text" data-key="12778"><span data-slate-leaf="true" data-offset-key="12778:0" data-first-offset="true"><span data-slate-string="true">标记过程是一个广度优先的遍历过程。它是扫描节点，将节点的子节点推到任务队列中，然后递归扫描子节点的子节点，直到所有工作队列都被排空为止。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12779"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/39/df/3942dd9c208f7841d0f5d0310fa2f0df.gif?wh=1222x678"></div><div>后台标记 worker 的工作过程</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12780"><span data-slate-object="text" data-key="12781"><span data-slate-leaf="true" data-offset-key="12781:0" data-first-offset="true"><span data-slate-string="true">标记过程会将白色对象标记，并推进队列中变成灰色对象。我们可以看看 scanobject 的具体过程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12782"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/94/4c/94ddaa38fc4923d3be06de7b47f3964c.gif?wh=1226x678"></div><div>在后台的 mark worker 执行对象扫描，并将 ptr push 到工作队列</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12783"><span data-slate-object="text" data-key="12784"><span data-slate-leaf="true" data-offset-key="12784:0" data-first-offset="true"><span data-slate-string="true">在标记过程中，gc mark worker 会一边从工作队列（gcw）中弹出对象，一边把它的子对象 push 到工作队列（gcw）中，如果工作队列满了，则要将一部分元素向全局队列转移。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12785"><span data-slate-object="text" data-key="12786"><span data-slate-leaf="true" data-offset-key="12786:0" data-first-offset="true"><span data-slate-string="true">我们知道，堆上对象本质上是图，会存储引用关系互相交叉的时候，在标记过程中也有简单的剪枝逻辑：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12787"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/8d/5c/8d9066cdfd55f0cc3a6e23216dd42f5c.png?wh=1920x1287"></div><div>如果两个后台 mark worker 分别从 A、B 这两个根开始标记，他们会重复标记 D 吗？</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12788"><span data-slate-object="text" data-key="12789"><span data-slate-leaf="true" data-offset-key="12789:0" data-first-offset="true"><span data-slate-string="true">这里，D 是 A 和 B 的共同子节点，在标记过程中自然会减枝，防止重复标记浪费计算资源：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12790"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/0a/b5/0a139bd980ff1e88ec529e4eb29849b5.png?wh=808x306"></div><div>标记过程中通过 isMarked 判断来进行剪枝</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12791"><span data-slate-object="text" data-key="12792"><span data-slate-leaf="true" data-offset-key="12792:0" data-first-offset="true"><span data-slate-string="true">如果多个后台 mark worker 确实产生了并发，标记时使用的是 atomic.Or8，也是并发安全的：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12793"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/16/f2/168d6ba157a7ac43c699873d3ccbf7f2.png?wh=1428x402"></div><div>标记使用 atomic.Or8，是并发安全的</div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12794" id="sr-toc-10"><span data-slate-object="text" data-key="12795"><span data-slate-leaf="true" data-offset-key="12795:0" data-first-offset="true"><span data-slate-string="true">协助标记</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12796"><span data-slate-object="text" data-key="12797"><span data-slate-leaf="true" data-offset-key="12797:0" data-first-offset="true"><span data-slate-string="true">当应用分配内存过快时，后台的 mark worker 无法及时完成标记工作，这时应用本身需要进行堆内存分配时，会判断是否需要适当协助 GC 的标记过程，防止应用因为分配过快发生 OOM。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12798"><span data-slate-object="text" data-key="12799"><span data-slate-leaf="true" data-offset-key="12799:0" data-first-offset="true"><span data-slate-string="true">碰到这种情况时，我们会在火焰图中看到对应的协助标记的调用栈：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12800"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/82/93/8248e8a329a139e5d7ea34424991da93.png?wh=1030x962"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12801"><span data-slate-object="text" data-key="12802"><span data-slate-leaf="true" data-offset-key="12802:0" data-first-offset="true"><span data-slate-string="true">不过，协助标记会对应用的响应延迟产生影响，我们可以尝试降低应用的对象分配数量进行优化。Go 内部具体是通过一套记账还账系统来实现协助标记的流程的，这一部分不是我们这一讲的重点，如果你感兴趣，可以去看看</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12803"><span data-slate-object="text" data-key="12804"><span data-slate-leaf="true" data-offset-key="12804:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="12805"><span data-slate-leaf="true" data-offset-key="12805:0" data-first-offset="true"><span data-slate-string="true"> 。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12806" id="sr-toc-11"><span data-slate-object="text" data-key="12807"><span data-slate-leaf="true" data-offset-key="12807:0" data-first-offset="true"><span data-slate-string="true">对象丢失问题</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12808"><span data-slate-object="text" data-key="12809"><span data-slate-leaf="true" data-offset-key="12809:0" data-first-offset="true"><span data-slate-string="true">前面我们提到了 GC 线程 / 协程与应用线程 / 协程是并发执行的，在 GC 标记 worker 工作期间，应用还会不断地修改堆上对象的引用关系，这就可能导致对象丢失问题。下面是一个典型的应用与 GC 同时执行时，由于应用对指针的变更导致对象漏标记，从而被 GC 误回收的情况。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12810"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/19/a5/193926b4yydde270f88c62d2a8dc21a5.gif?wh=1224x674"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12811"><span data-slate-object="text" data-key="12812"><span data-slate-leaf="true" data-offset-key="12812:0" data-first-offset="true"><span data-slate-string="true">在这张图表现的 GC 标记过程中，应用动态地修改了 A 和 C 的指针，让 A 对象的内部指针指向了 B，C 的内部指针指向了 D。如果标记过程垃圾收集器无法感知到这种变化，最终 B 对象在标记完成后是白色，会被错误地认作内存垃圾被回收。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12813"><span data-slate-object="text" data-key="12814"><span data-slate-leaf="true" data-offset-key="12814:0" data-first-offset="true"><span data-slate-string="true">为了解决漏标，错标的问题，我们先需要定义 “</span></span></span><span data-slate-object="text" data-key="12815"><span data-slate-leaf="true" data-offset-key="12815:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">三色不变性</span></span></span></span><span data-slate-object="text" data-key="12816"><span data-slate-leaf="true" data-offset-key="12816:0" data-first-offset="true"><span data-slate-string="true">”，如果我们的堆上对象的引用关系不管怎么修改，都能满足三色不变性，那么也不会发生对象丢失问题。三色不变性可以分为强三色不变性和弱三色不变性两种，</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12817"><span data-slate-object="text" data-key="12818"><span data-slate-leaf="true" data-offset-key="12818:0" data-first-offset="true"><span data-slate-string="true">首先是强三色不变性（strong tricolor invariant），禁止黑色对象指向白色对象：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12819"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/e5/7e/e5bc46c9a0d590dc7e4baa8b6391527e.png?wh=866x1188"></div><div>强三色不变性</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12820"><span data-slate-object="text" data-key="12821"><span data-slate-leaf="true" data-offset-key="12821:0" data-first-offset="true"><span data-slate-string="true">然后是弱三色不变性（weak tricolor invariant），黑色对象可以指向白色对象，但指向的白色对象，必须有能从灰色对象可达的路径：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12822"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/00/1a/00af8b225d3f5ca747bc6356d389671a.png?wh=964x1188"></div><div>弱三色不变性</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12823"><span data-slate-object="text" data-key="12824"><span data-slate-leaf="true" data-offset-key="12824:0" data-first-offset="true"><span data-slate-string="true">无论应用在与 GC 并发执行期间如何修改堆上对象的关系，只要修改之后，堆上对象能</span></span></span><span data-slate-object="text" data-key="12825"><span data-slate-leaf="true" data-offset-key="12825:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">满足任意一种不变性</span></span></span></span><span data-slate-object="text" data-key="12826"><span data-slate-leaf="true" data-offset-key="12826:0" data-first-offset="true"><span data-slate-string="true">，就不会发生对象的丢失问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12827"><span data-slate-object="text" data-key="12828"><span data-slate-leaf="true" data-offset-key="12828:0" data-first-offset="true"><span data-slate-string="true">而实现强 / 弱三色不变性均需要引入屏障技术。在 Go 语言中，使用写屏障，也就是 write barrier 来解决上述问题。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12829" id="sr-toc-12"><span data-slate-object="text" data-key="12830"><span data-slate-leaf="true" data-offset-key="12830:0" data-first-offset="true"><span data-slate-string="true">write barrier</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12831"><span data-slate-object="text" data-key="12832"><span data-slate-leaf="true" data-offset-key="12832:0" data-first-offset="true"><span data-slate-string="true">这里 barrier 的本质是 : snippet of code insert before pointer modify。不过，</span></span></span><span data-slate-object="text" data-key="12833"><span data-slate-leaf="true" data-offset-key="12833:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在并发编程领域也有 memory barrier，但这个含义与 GC 领域的 barrier 是完全不同的</span></span></span></span><span data-slate-object="text" data-key="12834"><span data-slate-leaf="true" data-offset-key="12834:0" data-first-offset="true"><span data-slate-string="true">，在阅读相关材料时，你一定要注意不要混淆这两个概念。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12835"><span data-slate-object="text" data-key="12836"><span data-slate-leaf="true" data-offset-key="12836:0" data-first-offset="true"><span data-slate-string="true">Go 语言的 GC 只有 write barrier，没有 read barrier。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12837"><span data-slate-object="text" data-key="12838"><span data-slate-leaf="true" data-offset-key="12838:0" data-first-offset="true"><span data-slate-string="true">在应用进入 GC 标记阶段前的 stw 阶段，会将全局变量 runtime.writeBarrier.enabled 修改为 true，这时所有的堆上指针修改操作在修改之前便会额外调用 runtime.gcWriteBarrier：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12839"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/a5/17/a5f34e9yy590a5504504bbcede940817.png?wh=1602x560"></div><div>在指针修改时被插入的 write barrier 函数调用</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12840"><span data-slate-object="text" data-key="12841"><span data-slate-leaf="true" data-offset-key="12841:0" data-first-offset="true"><span data-slate-string="true">在反汇编结果中，我们可以通过行数找到原始的代码位置：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12842"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/f9/cd/f92b0yy86fd889ba8099955aef47a5cd.png?wh=1160x458"></div><div>用行数找到真正的代码实现</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12843"><span data-slate-object="text" data-key="12844"><span data-slate-leaf="true" data-offset-key="12844:0" data-first-offset="true"><span data-slate-string="true">在 GC 领域中，常见的 write barrier 有两种：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12845"><div data-slate-type="list-line" data-slate-object="block" data-key="12846"><span data-slate-object="text" data-key="12847"><span data-slate-leaf="true" data-offset-key="12847:0" data-first-offset="true"><span data-slate-string="true">Dijistra Insertion Barrier，指针修改时，指向的新对象要标灰：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12848"><div data-slate-type="image" data-slate-object="block" data-key="12849"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/ed/36/ed18f2d72c1411761d85645d726c2c36.png?wh=982x352"></div><div>Dijistra 插入屏障</div></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="12850"><span data-slate-object="text" data-key="12851"><span data-slate-leaf="true" data-offset-key="12851:0" data-first-offset="true"><span data-slate-string="true">Yuasa Deletion Barrier，指针修改时，修改前指向的对象要标灰：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12852"><div data-slate-type="image" data-slate-object="block" data-key="12853"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/0a/ba/0a399de8c0764c53e9d765a3dd2b53ba.png?wh=942x346"></div><div>Yuasa 删除屏障</div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12854"><span data-slate-object="text" data-key="12855"><span data-slate-leaf="true" data-offset-key="12855:0" data-first-offset="true"><span data-slate-string="true">从理论上来讲，如果 Go 语言的所有对象都在堆上，使用上述两种屏障的任意一种，都不会发生对象丢失的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12856"><span data-slate-object="text" data-key="12857"><span data-slate-leaf="true" data-offset-key="12857:0" data-first-offset="true"><span data-slate-string="true">但我们不要忽略，在 Go 语言中，还有很多对象被分配在栈上。栈上的对象操作极其频繁，给栈上对象增加写屏障成本很高，所以 Go 是不给栈上对象开启屏障的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12858"><span data-slate-object="text" data-key="12859"><span data-slate-leaf="true" data-offset-key="12859:0" data-first-offset="true"><span data-slate-string="true">只对堆上对象开启写屏障的话，使用上述两种屏障其中的任意一种，都需要在 stw 阶段对栈进行重扫。所以经过多个版本的迭代，现在 Go 的写屏障混合了上述两种屏障，实现是这样的：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12860"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c9/8a/c9e2810ee27e6b19e8a62372e2afe98a.png?wh=976x398"></div><div>Go 的真实屏障实现</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12861"><span data-slate-object="text" data-key="12862"><span data-slate-leaf="true" data-offset-key="12862:0" data-first-offset="true"><span data-slate-string="true">这和 Go 语言在混合屏障的 proposal 上的实现不太相符，本来 proposal 是这么写的：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12863"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/f7/4b/f702ab3e26452fb20643e3ac095b054b.png?wh=964x426"></div><div>proposal 上声称的混合屏障实现</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12864"><span data-slate-object="text" data-key="12865"><span data-slate-leaf="true" data-offset-key="12865:0" data-first-offset="true"><span data-slate-string="true">为什么会有这种差异呢？这主要是因为栈的颜色判断成本是很高的，官方最终还是选择了更为简单的实现，即指针断开的老对象和新对象都标灰的实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12866"><span data-slate-object="text" data-key="12867"><span data-slate-leaf="true" data-offset-key="12867:0" data-first-offset="true"><span data-slate-string="true">我们再来详细地看看前面两种屏障的对象丢失问题。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12868"><div data-slate-type="list-line" data-slate-object="block" data-key="12869"><span data-slate-object="text" data-key="12870"><span data-slate-leaf="true" data-offset-key="12870:0" data-first-offset="true"><span data-slate-string="true">Dijistra Insertion Barrier 的对象丢失问题：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12871"><div data-slate-type="image" data-slate-object="block" data-key="12872"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/5d/ae/5d1fbbf17b04dea2f69b2b3e78651eae.gif?wh=1228x678"></div><div>栈上的黑色对象会指向堆上的白色对象</div></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="12873"><span data-slate-object="text" data-key="12874"><span data-slate-leaf="true" data-offset-key="12874:0" data-first-offset="true"><span data-slate-string="true">Yuasa Deletion Barrier 的对象丢失问题：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12875"><div data-slate-type="image" data-slate-object="block" data-key="12876"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/bd/4f/bd9782b5dc063ec6abe99fa23888134f.gif?wh=1224x684"></div><div>堆上的黑色对象会指向堆上的白色对象</div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12877"><span data-slate-object="text" data-key="12878"><span data-slate-leaf="true" data-offset-key="12878:0" data-first-offset="true"><span data-slate-string="true">早期 Go 只使用了 Dijistra 屏障，但因为会有上述对象丢失问题，需要在第二个 stw 周期进行栈重扫（stack rescan）。当 goroutine 数量较多时，stw 时间会变得很长。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12879"><span data-slate-object="text" data-key="12880"><span data-slate-leaf="true" data-offset-key="12880:0" data-first-offset="true"><span data-slate-string="true">但单独使用任意一种 barrier ，又没法满足 Go 消除栈重扫的要求，所以最新版本中 Go 的混合屏障其实是 Dijistra Insertion Barrier &nbsp;+ Yuasa Deletion Barrier。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12881"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/db/47/db60442b35719f182f24b06b407a3e47.png?wh=1068x684"></div><div>混合 barrier 的实现</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12882"><span data-slate-object="text" data-key="12883"><span data-slate-leaf="true" data-offset-key="12883:0" data-first-offset="true"><span data-slate-string="true">混合 write barrier 会将两个指针推到 p 的 wbBuf 结构去，我们来看看这个过程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12884"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/1b/4e/1b1baacb690f73730869c7203f102b4e.gif?wh=1220x680"></div><div>混合 barrier 会将指针推进 P 的 wbBuf 结构中，满了就往 gcw 推</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12885"><span data-slate-object="text" data-key="12886"><span data-slate-leaf="true" data-offset-key="12886:0" data-first-offset="true"><span data-slate-string="true">现在我们可以看看 mutator 和后台的 mark worker 在并发执行时的完整过程了：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12887"><div class="sr-rd-content-center-small" data-balloon-pos="up" aria-label="点击重新加载"><img class="simpread-img-broken" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==" org-src="https://static001.geekbang.org/resource/image/40/b9/40521717150c4813e97a8586984b06b9.gif?wh=1220x680"></div><div>mutator 和 mark worker 同时在执行时</div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12888" id="sr-toc-13"><span data-slate-object="text" data-key="12889"><span data-slate-leaf="true" data-offset-key="12889:0" data-first-offset="true"><span data-slate-string="true">回收流程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12890"><span data-slate-object="text" data-key="12891"><span data-slate-leaf="true" data-offset-key="12891:0" data-first-offset="true"><span data-slate-string="true">相比复杂的标记流程，对象的回收和内存释放就简单多了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12892"><span data-slate-object="text" data-key="12893"><span data-slate-leaf="true" data-offset-key="12893:0" data-first-offset="true"><span data-slate-string="true">进程启动时会有两个特殊 goroutine：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12894"><div data-slate-type="list-line" data-slate-object="block" data-key="12895"><span data-slate-object="text" data-key="12896"><span data-slate-leaf="true" data-offset-key="12896:0" data-first-offset="true"><span data-slate-string="true">一个叫 sweep.g，主要负责清扫死对象，合并相关的空闲页；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12897"><span data-slate-object="text" data-key="12898"><span data-slate-leaf="true" data-offset-key="12898:0" data-first-offset="true"><span data-slate-string="true">一个叫 scvg.g，主要负责向操作系统归还内存。</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="12899"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12900"><span data-slate-object="text" data-key="12901"><span data-slate-leaf="true" data-offset-key="12901:0" data-first-offset="true"><span data-slate-string="true">(dlv) goroutines</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12902"><span data-slate-object="text" data-key="12903"><span data-slate-leaf="true" data-offset-key="12903:0" data-first-offset="true"><span data-slate-string="true">* Goroutine </span></span></span><span data-slate-object="text" data-key="12904"><span data-slate-leaf="true" data-offset-key="12904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="12905"><span data-slate-leaf="true" data-offset-key="12905:0" data-first-offset="true"><span data-slate-string="true"> - User: ./</span></span></span><span data-slate-object="text" data-key="12906"><span data-slate-leaf="true" data-offset-key="12906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12907"><span data-slate-leaf="true" data-offset-key="12907:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12908"><span data-slate-leaf="true" data-offset-key="12908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12909"><span data-slate-leaf="true" data-offset-key="12909:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="12910"><span data-slate-leaf="true" data-offset-key="12910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">22</span></span></span></span><span data-slate-object="text" data-key="12911"><span data-slate-leaf="true" data-offset-key="12911:0" data-first-offset="true"><span data-slate-string="true"> main.main (</span></span></span><span data-slate-object="text" data-key="12912"><span data-slate-leaf="true" data-offset-key="12912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x10572a6</span></span></span></span><span data-slate-object="text" data-key="12913"><span data-slate-leaf="true" data-offset-key="12913:0" data-first-offset="true"><span data-slate-string="true">) (thread </span></span></span><span data-slate-object="text" data-key="12914"><span data-slate-leaf="true" data-offset-key="12914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5247606</span></span></span></span><span data-slate-object="text" data-key="12915"><span data-slate-leaf="true" data-offset-key="12915:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12916"><span data-slate-object="text" data-key="12917"><span data-slate-leaf="true" data-offset-key="12917:0" data-first-offset="true"><span data-slate-string="true">  Goroutine </span></span></span><span data-slate-object="text" data-key="12918"><span data-slate-leaf="true" data-offset-key="12918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="12919"><span data-slate-leaf="true" data-offset-key="12919:0" data-first-offset="true"><span data-slate-string="true"> - User: /usr/local/</span></span></span><span data-slate-object="text" data-key="12920"><span data-slate-leaf="true" data-offset-key="12920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12921"><span data-slate-leaf="true" data-offset-key="12921:0" data-first-offset="true"><span data-slate-string="true">/src/runtime/proc.</span></span></span><span data-slate-object="text" data-key="12922"><span data-slate-leaf="true" data-offset-key="12922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12923"><span data-slate-leaf="true" data-offset-key="12923:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="12924"><span data-slate-leaf="true" data-offset-key="12924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">367</span></span></span></span><span data-slate-object="text" data-key="12925"><span data-slate-leaf="true" data-offset-key="12925:0" data-first-offset="true"><span data-slate-string="true"> runtime.gopark (</span></span></span><span data-slate-object="text" data-key="12926"><span data-slate-leaf="true" data-offset-key="12926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x102e596</span></span></span></span><span data-slate-object="text" data-key="12927"><span data-slate-leaf="true" data-offset-key="12927:0" data-first-offset="true"><span data-slate-string="true">) [force gc (idle) </span></span></span><span data-slate-object="text" data-key="12928"><span data-slate-leaf="true" data-offset-key="12928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">455634</span></span></span></span><span data-slate-object="text" data-key="12929"><span data-slate-leaf="true" data-offset-key="12929:0" data-first-offset="true"><span data-slate-string="true">h24m29</span></span></span><span data-slate-object="text" data-key="12930"><span data-slate-leaf="true" data-offset-key="12930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.787802783</span></span></span></span><span data-slate-object="text" data-key="12931"><span data-slate-leaf="true" data-offset-key="12931:0" data-first-offset="true"><span data-slate-string="true">s]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12932"><span data-slate-object="text" data-key="12933"><span data-slate-leaf="true" data-offset-key="12933:0" data-first-offset="true"><span data-slate-string="true">  Goroutine </span></span></span><span data-slate-object="text" data-key="12934"><span data-slate-leaf="true" data-offset-key="12934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="12935"><span data-slate-leaf="true" data-offset-key="12935:0" data-first-offset="true"><span data-slate-string="true"> - User: /usr/local/</span></span></span><span data-slate-object="text" data-key="12936"><span data-slate-leaf="true" data-offset-key="12936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12937"><span data-slate-leaf="true" data-offset-key="12937:0" data-first-offset="true"><span data-slate-string="true">/src/runtime/proc.</span></span></span><span data-slate-object="text" data-key="12938"><span data-slate-leaf="true" data-offset-key="12938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12939"><span data-slate-leaf="true" data-offset-key="12939:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="12940"><span data-slate-leaf="true" data-offset-key="12940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">367</span></span></span></span><span data-slate-object="text" data-key="12941"><span data-slate-leaf="true" data-offset-key="12941:0" data-first-offset="true"><span data-slate-string="true"> runtime.gopark (</span></span></span><span data-slate-object="text" data-key="12942"><span data-slate-leaf="true" data-offset-key="12942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x102e596</span></span></span></span><span data-slate-object="text" data-key="12943"><span data-slate-leaf="true" data-offset-key="12943:0" data-first-offset="true"><span data-slate-string="true">) [GC sweep wait]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12944"><span data-slate-object="text" data-key="12945"><span data-slate-leaf="true" data-offset-key="12945:0" data-first-offset="true"><span data-slate-string="true">  Goroutine </span></span></span><span data-slate-object="text" data-key="12946"><span data-slate-leaf="true" data-offset-key="12946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="12947"><span data-slate-leaf="true" data-offset-key="12947:0" data-first-offset="true"><span data-slate-string="true"> - User: /usr/local/</span></span></span><span data-slate-object="text" data-key="12948"><span data-slate-leaf="true" data-offset-key="12948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12949"><span data-slate-leaf="true" data-offset-key="12949:0" data-first-offset="true"><span data-slate-string="true">/src/runtime/proc.</span></span></span><span data-slate-object="text" data-key="12950"><span data-slate-leaf="true" data-offset-key="12950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="12951"><span data-slate-leaf="true" data-offset-key="12951:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="12952"><span data-slate-leaf="true" data-offset-key="12952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">367</span></span></span></span><span data-slate-object="text" data-key="12953"><span data-slate-leaf="true" data-offset-key="12953:0" data-first-offset="true"><span data-slate-string="true"> runtime.gopark (</span></span></span><span data-slate-object="text" data-key="12954"><span data-slate-leaf="true" data-offset-key="12954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x102e596</span></span></span></span><span data-slate-object="text" data-key="12955"><span data-slate-leaf="true" data-offset-key="12955:0" data-first-offset="true"><span data-slate-string="true">) [GC scavenge wait]</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12956"><span data-slate-object="text" data-key="12957"><span data-slate-leaf="true" data-offset-key="12957:0" data-first-offset="true"><span data-slate-string="true">注意看这里的 GC sweep wait 和 GC scavenge wait， 就是这两个 goroutine。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12958"><span data-slate-object="text" data-key="12959"><span data-slate-leaf="true" data-offset-key="12959:0" data-first-offset="true"><span data-slate-string="true">当 GC 的标记流程结束之后，sweep goroutine 就会被唤醒，进行清扫工作，其实就是循环执行 sweepone -&gt; sweep。针对每个 mspan，sweep.g 的工作是将标记期间生成的 bitmap 替换掉分配时使用的 bitmap：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12960"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/b9/29/b9ec19a138f667df5730d7895d9e3d29.png?wh=1042x666"></div><div>mspan：用标记期间生成的 bitmap 替换掉分配内存时使用的 bitmap</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12961"><span data-slate-object="text" data-key="12962"><span data-slate-leaf="true" data-offset-key="12962:0" data-first-offset="true"><span data-slate-string="true">然后根据 mspan 中的槽位情况决定该 mspan 的去向：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12963"><div data-slate-type="list-line" data-slate-object="block" data-key="12964"><span data-slate-object="text" data-key="12965"><span data-slate-leaf="true" data-offset-key="12965:0" data-first-offset="true"><span data-slate-string="true">如果 mspan 中存活对象数 = 0，也就是所有 element 都变成了内存垃圾，那执行 freeSpan -&gt; 归还组成该 mspan 所使用的页，并更新全局的页分配器摘要信息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12966"><span data-slate-object="text" data-key="12967"><span data-slate-leaf="true" data-offset-key="12967:0" data-first-offset="true"><span data-slate-string="true">如果 mspan 中没有空槽，说明所有对象都是存活的，将其放入 fullSwept 队列中；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12968"><span data-slate-object="text" data-key="12969"><span data-slate-leaf="true" data-offset-key="12969:0" data-first-offset="true"><span data-slate-string="true">如果 mspan 中有空槽，说明这个 mspan 还可以拿来做内存分配，将其放入 partialSweep 队列中。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12970"><span data-slate-object="text" data-key="12971"><span data-slate-leaf="true" data-offset-key="12971:0" data-first-offset="true"><span data-slate-string="true">之后 “清道夫” scvg goroutine 被唤醒，执行线性流程，一路运行到将页内存归还给操作系统，也就是 bgscavenge -&gt; pageAlloc.scavenge -&gt; pageAlloc.scavengeOne -&gt; pageAlloc.scavengeRangeLocked -&gt; sysUnused -&gt; madvise：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12972"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/a9/f4/a9575cf87774fed288cf20f976a42af4.png?wh=1636x652"></div><div>最终还是要用 madvise 来将内存归还给操作系统</div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12973" id="sr-toc-14"><span data-slate-object="text" data-key="12974"><span data-slate-leaf="true" data-offset-key="12974:0" data-first-offset="true"><span data-slate-string="true">问题分析</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12975"><span data-slate-object="text" data-key="12976"><span data-slate-leaf="true" data-offset-key="12976:0" data-first-offset="true"><span data-slate-string="true">从前面的基础知识中，我们可以总结出 Go 语言垃圾回收的关键点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12977"><div data-slate-type="list-line" data-slate-object="block" data-key="12978"><span data-slate-object="text" data-key="12979"><span data-slate-leaf="true" data-offset-key="12979:0" data-first-offset="true"><span data-slate-string="true">无分代；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12980"><span data-slate-object="text" data-key="12981"><span data-slate-leaf="true" data-offset-key="12981:0" data-first-offset="true"><span data-slate-string="true">与应用执行并发；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12982"><span data-slate-object="text" data-key="12983"><span data-slate-leaf="true" data-offset-key="12983:0" data-first-offset="true"><span data-slate-string="true">协助标记流程；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="12984"><span data-slate-object="text" data-key="12985"><span data-slate-leaf="true" data-offset-key="12985:0" data-first-offset="true"><span data-slate-string="true">并发执行时开启 write barrier。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12986"><span data-slate-object="text" data-key="12987"><span data-slate-leaf="true" data-offset-key="12987:0" data-first-offset="true"><span data-slate-string="true">我们日常编码中就需要考虑这些关键点，进行一些针对性的设计与优化。比如，因为无分代，当我们遇到一些需要在内存中保留几千万 kv map 的场景（比如机器学习的特征系统）时，就需要想办法降低 GC 扫描成本。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12988"><span data-slate-object="text" data-key="12989"><span data-slate-leaf="true" data-offset-key="12989:0" data-first-offset="true"><span data-slate-string="true">又比如，因为有协助标记，当应用的 GC 占用的 CPU 超过 25% 时，会触发大量的协助标记，影响应用的延迟，这时也要对 GC 进行优化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12990"><span data-slate-object="text" data-key="12991"><span data-slate-leaf="true" data-offset-key="12991:0" data-first-offset="true"><span data-slate-string="true">简单的业务场景，我们使用 sync.Pool 就可以带来较好的优化效果，若碰到一些复杂的业务场景，还要考虑 offheap 之类的欺骗 GC 的方案，比如 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12992"><span data-slate-object="text" data-key="12993"><span data-slate-leaf="true" data-offset-key="12993:0" data-first-offset="true"><span data-slate-string="true">dgraph 的方案</span></span></span></a><span data-slate-object="text" data-key="12994"><span data-slate-leaf="true" data-offset-key="12994:0" data-first-offset="true"><span data-slate-string="true">。因为我们这讲聚焦于内存分配和 GC 的实现，就不展开介绍这些具体方案了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12995"><span data-slate-object="text" data-key="12996"><span data-slate-leaf="true" data-offset-key="12996:0" data-first-offset="true"><span data-slate-string="true">另外，这讲中涉及的所有内存管理的名词，你都可以在：</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12997"><span data-slate-object="text" data-key="12998"><span data-slate-leaf="true" data-offset-key="12998:0" data-first-offset="true"><span data-slate-string="true">https://memorymanagement.org</span></span></span></a><span data-slate-object="text" data-key="12999"><span data-slate-leaf="true" data-offset-key="12999:0" data-first-offset="true"><span data-slate-string="true"> 上找到。如果你还对垃圾回收的理论还有什么不解，我推荐你阅读：《</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13000"><span data-slate-object="text" data-key="13001"><span data-slate-leaf="true" data-offset-key="13001:0" data-first-offset="true"><span data-slate-string="true">GC Handbook</span></span></span></a><span data-slate-object="text" data-key="13002"><span data-slate-leaf="true" data-offset-key="13002:0" data-first-offset="true"><span data-slate-string="true">》，它可以解答你所有的疑问。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>16</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-15">精选留言 (5)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/a8/b0/6f87ab08.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Tony Bai</span></div></div><div>曹老师把 GC 原理讲得好通透！👍 </div><div><div>2022-02-12</div><div><div><i></i><span></span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/50/82/32a2bf86.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 叶剑峰</span></div></div><div>膜拜曹大</div><div><div>2022-02-16</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 骨汤鸡蛋面</span></div></div><div>大佬，go 在变量赋值时调用 write barrier，可以多补充些细节嘛？</div><div><div>2022-02-07</div><div><div><i></i><span>4</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1c/96/dd/1620a744.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>simple_孙</span></div></div><div>PauseNs 数组中的数字是啥意思呢</div><div><div>2022-03-19</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/16/3e/5965e58b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>风</span></div></div><div>曹大 yyds</div><div><div>2022-02-26</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".15"><outline class="toc-level-h1" data-reactid=".15.0" style="width: 175px;"><active data-reactid=".15.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".15.0.1"><span data-reactid=".15.0.1.0">大咖助阵｜曹春晖：聊聊 Go 语言的 GC 实现</span></a></outline><outline class="toc-level-h2" data-reactid=".15.1" style="width: 165px;"><active data-reactid=".15.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".15.1.1"><span data-reactid=".15.1.1.0">武林秘籍救不了段错误</span></a></outline><outline class="toc-level-h2" data-reactid=".15.2" style="width: 165px;"><active data-reactid=".15.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".15.2.1"><span data-reactid=".15.2.1.0">GC 拯救程序员</span></a></outline><outline class="toc-level-h2" data-reactid=".15.3" style="width: 165px;"><active data-reactid=".15.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".15.3.1"><span data-reactid=".15.3.1.0">内存管理的三个参与者</span></a></outline><outline class="toc-level-h2" data-reactid=".15.4" style="width: 165px;"><active data-reactid=".15.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".15.4.1"><span data-reactid=".15.4.1.0">分配内存</span></a></outline><outline class="toc-level-h3" data-reactid=".15.5" style="width: 155px;"><active data-reactid=".15.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".15.5.1"><span data-reactid=".15.5.1.0">内存分配的数据结构之间的关系</span></a></outline><outline class="toc-level-h2" data-reactid=".15.6" style="width: 165px;"><active data-reactid=".15.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".15.6.1"><span data-reactid=".15.6.1.0">垃圾回收</span></a></outline><outline class="toc-level-h3" data-reactid=".15.7" style="width: 155px;"><active data-reactid=".15.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".15.7.1"><span data-reactid=".15.7.1.0">垃圾分类</span></a></outline><outline class="toc-level-h3" data-reactid=".15.8" style="width: 155px;"><active data-reactid=".15.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".15.8.1"><span data-reactid=".15.8.1.0">GC 流程</span></a></outline><outline class="toc-level-h3" data-reactid=".15.9" style="width: 155px;"><active data-reactid=".15.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".15.9.1"><span data-reactid=".15.9.1.0">标记流程</span></a></outline><outline class="toc-level-h3" data-reactid=".15.a" style="width: 155px;"><active data-reactid=".15.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".15.a.1"><span data-reactid=".15.a.1.0">协助标记</span></a></outline><outline class="toc-level-h3" data-reactid=".15.b" style="width: 155px;"><active data-reactid=".15.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".15.b.1"><span data-reactid=".15.b.1.0">对象丢失问题</span></a></outline><outline class="toc-level-h3" data-reactid=".15.c" style="width: 155px;"><active data-reactid=".15.c.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".15.c.1"><span data-reactid=".15.c.1.0">write barrier</span></a></outline><outline class="toc-level-h3" data-reactid=".15.d" style="width: 155px;"><active data-reactid=".15.d.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".15.d.1"><span data-reactid=".15.d.1.0">回收流程</span></a></outline><outline class="toc-level-h2" data-reactid=".15.e" style="width: 165px;"><active data-reactid=".15.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".15.e.1"><span data-reactid=".15.e.1.0">问题分析</span></a></outline><outline class="toc-level-h2" data-reactid=".15.f" style="width: 165px;"><active data-reactid=".15.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".15.f.1"><span data-reactid=".15.f.1.0">精选留言 (5)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/484271" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>