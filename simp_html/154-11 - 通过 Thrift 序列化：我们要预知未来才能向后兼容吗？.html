
                <html lang="en" class="simpread-font simpread-theme-root" style='undefined'>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 11 | 通过 Thrift 序列化：我们要预知未来才能向后兼容吗？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>11 | 通过 Thrift 序列化：我们要预知未来才能向后兼容吗？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">我会带着你从最简单的 CSV 格式开始，根据需求一步步优化扩展，看看为什么我们需要 Thrift 里像 TCompactProtocol 这样的编码格式</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 11 | 通过 Thrift 序列化：我们要预知未来才能向后兼容吗？</h1><div><span>徐文浩</span> <span> 2021-10-13</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/11/8a/11e28e86ab3fb9656caf8355bb23c48a.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;" one-link-mark="yes"> 1.0x <i><span></span></i></a></div><div><span>讲述：徐文浩</span><span>大小：18.08M</span><span> 时长：19:47</span></div></div><audio title="11 | 通过Thrift序列化：我们要预知未来才能向后兼容吗？" src="https://res001.geekbang.org/media/audio/0c/8a/0cc599748c36aa5d2a89e4a14cebed8a/ld/ld.m3u8" __idm_id__="548865"></audio></div><div><div><div><div data-slate-editor="true" data-key="0" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="1"><span data-slate-object="text" data-key="2"><span data-slate-leaf="true" data-offset-key="2:0" data-first-offset="true"><span data-slate-string="true">你好，我是徐文浩。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3"><span data-slate-object="text" data-key="4"><span data-slate-leaf="true" data-offset-key="4:0" data-first-offset="true"><span data-slate-string="true">现在，我们已经解读完了 GFS、MapReduce 以及 Bigtable 这三篇论文，这三篇论文之所以被称为 Google 的三驾马车，一方面是因为它们发表得早，分别在 2003、2004 和 2006 年就发表了。另一方面，是这三篇论文正好覆盖了大数据的存储、大数据的批处理也就是计算，以及大数据的在线服务领域。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5"><span data-slate-object="text" data-key="6"><span data-slate-leaf="true" data-offset-key="6:0" data-first-offset="true"><span data-slate-string="true">相信你到这里，也看到了一个反复出现的关键字，那就是 “数据”。在过去的三篇论文里，我们花了很多精力去分析谷歌是如何设计了分布式的系统架构，数据在硬件层面应该怎么存储。其中的很多设计面临的主要瓶颈和挑战，就是硬盘读写和网络传输性能。比如 GFS 里的数据复制，需要走流水线式的传输就是为了减少网络传输的数据量；Bigtable 里，我们会对一个个 data block 进行压缩，目的是让数据存储的空间可以小一些。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7"><span data-slate-object="text" data-key="8"><span data-slate-leaf="true" data-offset-key="8:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">那么，我们能不能在 “数据” 本身上直接做点文章呢？</span></span></span></span><span data-slate-object="text" data-key="9"><span data-slate-leaf="true" data-offset-key="9:0" data-first-offset="true"><span data-slate-string="true">答案当然是可以的，今天这节课，我们就来一起读一篇 Facebook 在 2007 年发表的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10" one-link-mark="yes"><span data-slate-object="text" data-key="11"><span data-slate-leaf="true" data-offset-key="11:0" data-first-offset="true"><span data-slate-string="true">《Thrift: Scalable Cross-Language Services Implementation》</span></span></span></a><span data-slate-object="text" data-key="12"><span data-slate-leaf="true" data-offset-key="12:0" data-first-offset="true"><span data-slate-string="true">技术论文，它的背后也就是这 Apache Thrift 这个开源项目。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13"><span data-slate-object="text" data-key="14"><span data-slate-leaf="true" data-offset-key="14:0" data-first-offset="true"><span data-slate-string="true">Thrift 是我自己长期在大数据处理，以及分布式系统中长期使用的一个开源项目。可能你会问，为什么不选择来自 Google 血统更纯正的 Protobuf 和 gRPC 呢？那是因为 Thrift 更早开源发表。Thrift 发表的时候，Protobuf 还只是在 Sawzall 论文中被提到，它要到 2008 年的 7 月才正式发布，而 gRPC 更是要到 2015 年才正式开源。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15"><span data-slate-object="text" data-key="16"><span data-slate-leaf="true" data-offset-key="16:0" data-first-offset="true"><span data-slate-string="true">好了，闲话不多说，回归正题。在这一讲里，我会带着你从最简单的 CSV 格式开始，根据需求一步步优化扩展，看看为什么我们需要 Thrift 里像 TCompactProtocol 这样的编码格式，然后我会带你来理解它是如何设计，做到可以跨语言、跨协议、可扩展的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17"><span data-slate-object="text" data-key="18"><span data-slate-leaf="true" data-offset-key="18:0" data-first-offset="true"><span data-slate-string="true">而通过这一讲的学习，相信你在对如何进行高效的数据序列化和反序列化，以及让系统设计的 “正交化” 这两点上，能有充分的收获。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19" id="sr-toc-1"><span data-slate-object="text" data-key="20"><span data-slate-leaf="true" data-offset-key="20:0" data-first-offset="true"><span data-slate-string="true">常用的 CSV 和 JSON 格式</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="21"><span data-slate-object="text" data-key="22"><span data-slate-leaf="true" data-offset-key="22:0" data-first-offset="true"><span data-slate-string="true">我们先来看看，在之前的论文里，Google 有没有说过他们是用什么样的编码来存储数据的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="23"><span data-slate-object="text" data-key="24"><span data-slate-leaf="true" data-offset-key="24:0" data-first-offset="true"><span data-slate-string="true">在 MapReduce 的论文里，Google 说 MapReduce 的实现，输入输出都是字符串，然后让开发者自己决定去做数据的解码，或者编码变成自己需要的类型。的确，最简单的编码数据的方式，就是用字符串把数据存下来，再用各种方法解析就好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="25"><span data-slate-object="text" data-key="26"><span data-slate-leaf="true" data-offset-key="26:0" data-first-offset="true"><span data-slate-string="true">如果你是做后端开发的，那么日常读写数据最常见的办法之一，无非就是 </span></span></span><span data-slate-object="text" data-key="27"><span data-slate-leaf="true" data-offset-key="27:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">CSV 格式</span></span></span></span><span data-slate-object="text" data-key="28"><span data-slate-leaf="true" data-offset-key="28:0" data-first-offset="true"><span data-slate-string="true">。举一个最简单的例子，要想把 Google 这样的搜索引擎，每一次搜索后的用户点击记录给存储下来，就会是下面这样的：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="29"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/52/5b/52bf3b6a944c5e5fc077ff86d021285b.jpg?wh=1920x870"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="30"><span data-slate-object="text" data-key="31"><span data-slate-leaf="true" data-offset-key="31:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">我们希望存储的数据</span></span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="32"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="33"><span data-slate-object="text" data-key="34"><span data-slate-leaf="true" data-offset-key="34:0" data-first-offset="true"><span data-slate-string="true">user_id,search_term,rank,landing_url,click_timestmap</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="35"><span data-slate-object="text" data-key="36"><span data-slate-leaf="true" data-offset-key="36:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">597819210</span></span></span></span><span data-slate-object="text" data-key="37"><span data-slate-leaf="true" data-offset-key="37:0" data-first-offset="true"><span data-slate-string="true">, 大数据，</span></span></span><span data-slate-object="text" data-key="38"><span data-slate-leaf="true" data-offset-key="38:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="39"><span data-slate-leaf="true" data-offset-key="39:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="40"><span data-slate-leaf="true" data-offset-key="40:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://aws.amazon.com/cn/big-data/what-is-big-data/"</span></span></span></span><span data-slate-object="text" data-key="41"><span data-slate-leaf="true" data-offset-key="41:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="42"><span data-slate-leaf="true" data-offset-key="42:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1592373781</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="43"><span data-slate-object="text" data-key="44"><span data-slate-leaf="true" data-offset-key="44:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">297612312</span></span></span></span><span data-slate-object="text" data-key="45"><span data-slate-leaf="true" data-offset-key="45:0" data-first-offset="true"><span data-slate-string="true">, 极客时间，</span></span></span><span data-slate-object="text" data-key="46"><span data-slate-leaf="true" data-offset-key="46:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="47"><span data-slate-leaf="true" data-offset-key="47:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="48"><span data-slate-leaf="true" data-offset-key="48:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://b.geekbang.org/"</span></span></span></span><span data-slate-object="text" data-key="49"><span data-slate-leaf="true" data-offset-key="49:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="50"><span data-slate-leaf="true" data-offset-key="50:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1618954621</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="51"><span data-slate-object="text" data-key="52"><span data-slate-leaf="true" data-offset-key="52:0" data-first-offset="true"><span data-slate-string="true">……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="53"><span data-slate-object="text" data-key="54"><span data-slate-leaf="true" data-offset-key="54:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">A23123711</span></span></span></span><span data-slate-object="text" data-key="55"><span data-slate-leaf="true" data-offset-key="55:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="56"><span data-slate-leaf="true" data-offset-key="56:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Thrift</span></span></span></span><span data-slate-object="text" data-key="57"><span data-slate-leaf="true" data-offset-key="57:0" data-first-offset="true"><span data-slate-string="true"> 论文，</span></span></span><span data-slate-object="text" data-key="58"><span data-slate-leaf="true" data-offset-key="58:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="59"><span data-slate-leaf="true" data-offset-key="59:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="60"><span data-slate-leaf="true" data-offset-key="60:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://zh.wikipedia.org/zh-hans/Thrift"</span></span></span></span><span data-slate-object="text" data-key="61"><span data-slate-leaf="true" data-offset-key="61:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="62"><span data-slate-leaf="true" data-offset-key="62:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1632373689</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="63"><span data-slate-object="text" data-key="64"><span data-slate-leaf="true" data-offset-key="64:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">CSV 存储上面数据的格式</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="65"><span data-slate-object="text" data-key="66"><span data-slate-leaf="true" data-offset-key="66:0" data-first-offset="true"><span data-slate-string="true">我们一共存储了 5 个字段，分别是用户 ID、搜索词、搜索排名、用户点击的落地页，以及点击时间。其中，搜索排名和点击时间是一个整数，其他的都是字符串。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="67"><span data-slate-object="text" data-key="68"><span data-slate-leaf="true" data-offset-key="68:0" data-first-offset="true"><span data-slate-string="true">我们用 CSV 把这个数据存下来，就是一行代表一条数据记录，各个字段之间用逗号分隔开来，每个字段无论是什么类型，我们都把它用纯文本的方式存储下来。如果我们要用前面讲过的 MapReduce 去处理数据，也很简单，一行就是一条数据，简单用逗号来 Split 一行就能得到需要的各个字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="69"><span data-slate-object="text" data-key="70"><span data-slate-leaf="true" data-offset-key="70:0" data-first-offset="true"><span data-slate-string="true">但是仔细一琢磨，你会发现这个格式有两个缺点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="71"><div data-slate-type="list-line" data-slate-object="block" data-key="72"><span data-slate-object="text" data-key="73"><span data-slate-leaf="true" data-offset-key="73:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一个是数据里面没有告诉我们数据类型是什么，我们只能根据字段的名称，以及查看少数几条数据来猜测</span></span></span></span><span data-slate-object="text" data-key="74"><span data-slate-leaf="true" data-offset-key="74:0" data-first-offset="true"><span data-slate-string="true">。比如数据里面的用户 ID，前几条数据里全部都是数字，我们可能就以为用户 ID 是用一个整型数来表示的，但实际上它是一个字符串。我们很有可能写完代码跑到任务出错了，才会发现这一点，浪费很多时间。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="75"><span data-slate-object="text" data-key="76"><span data-slate-leaf="true" data-offset-key="76:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第二个是很多数据用文本来保存有些浪费空间。</span></span></span></span><span data-slate-object="text" data-key="77"><span data-slate-leaf="true" data-offset-key="77:0" data-first-offset="true"><span data-slate-string="true">前面例子里的点击时间，如果我们用一个整型数来存储，那么只需要占用 4 个 byte，但是用纯文本的话，需要 10 个 byte。数据量少问题还不大，但是如果记录数量多，这样的字段多，额外占用的空间就会让人难以忽视了。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="78"><span data-slate-object="text" data-key="79"><span data-slate-leaf="true" data-offset-key="79:0" data-first-offset="true"><span data-slate-string="true">那么，我们有什么好的办法呢？对于第一个问题，很多前端程序员可能会说，我们可以用 JSON 呀！</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="80"><span data-slate-object="text" data-key="81"><span data-slate-leaf="true" data-offset-key="81:0" data-first-offset="true"><span data-slate-string="true">没错，我们可以用 JSON Schema，定义好字段类型。但是对于第二个问题，使用 JSON 的话，问题就更糟糕了。因为对于每一条数据，我们不仅要存储数据，还要再存储一份字段名，占用的空间就更大了。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="82"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="83"><span data-slate-object="text" data-key="84"><span data-slate-leaf="true" data-offset-key="84:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="85"><span data-slate-object="text" data-key="86"><span data-slate-leaf="true" data-offset-key="86:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="87"><span data-slate-object="text" data-key="88"><span data-slate-leaf="true" data-offset-key="88:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="89"><span data-slate-leaf="true" data-offset-key="89:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"user_id"</span></span></span></span><span data-slate-object="text" data-key="90"><span data-slate-leaf="true" data-offset-key="90:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="91"><span data-slate-leaf="true" data-offset-key="91:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"597819210"</span></span></span></span><span data-slate-object="text" data-key="92"><span data-slate-leaf="true" data-offset-key="92:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="93"><span data-slate-object="text" data-key="94"><span data-slate-leaf="true" data-offset-key="94:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="95"><span data-slate-leaf="true" data-offset-key="95:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"search_term"</span></span></span></span><span data-slate-object="text" data-key="96"><span data-slate-leaf="true" data-offset-key="96:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="97"><span data-slate-leaf="true" data-offset-key="97:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"大数据"</span></span></span></span><span data-slate-object="text" data-key="98"><span data-slate-leaf="true" data-offset-key="98:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="99"><span data-slate-object="text" data-key="100"><span data-slate-leaf="true" data-offset-key="100:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="101"><span data-slate-leaf="true" data-offset-key="101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rank"</span></span></span></span><span data-slate-object="text" data-key="102"><span data-slate-leaf="true" data-offset-key="102:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="103"><span data-slate-leaf="true" data-offset-key="103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="104"><span data-slate-leaf="true" data-offset-key="104:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="105"><span data-slate-object="text" data-key="106"><span data-slate-leaf="true" data-offset-key="106:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="107"><span data-slate-leaf="true" data-offset-key="107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"landing_url"</span></span></span></span><span data-slate-object="text" data-key="108"><span data-slate-leaf="true" data-offset-key="108:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="109"><span data-slate-leaf="true" data-offset-key="109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://aws.amazon.com/cn/big-data/what-is-big-data/"</span></span></span></span><span data-slate-object="text" data-key="110"><span data-slate-leaf="true" data-offset-key="110:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="111"><span data-slate-object="text" data-key="112"><span data-slate-leaf="true" data-offset-key="112:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="113"><span data-slate-leaf="true" data-offset-key="113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"click_timestamp"</span></span></span></span><span data-slate-object="text" data-key="114"><span data-slate-leaf="true" data-offset-key="114:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="115"><span data-slate-leaf="true" data-offset-key="115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1592373781</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="116"><span data-slate-object="text" data-key="117"><span data-slate-leaf="true" data-offset-key="117:0" data-first-offset="true"><span data-slate-string="true">  },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="118"><span data-slate-object="text" data-key="119"><span data-slate-leaf="true" data-offset-key="119:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="120"><span data-slate-object="text" data-key="121"><span data-slate-leaf="true" data-offset-key="121:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="122"><span data-slate-leaf="true" data-offset-key="122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"user_id"</span></span></span></span><span data-slate-object="text" data-key="123"><span data-slate-leaf="true" data-offset-key="123:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="124"><span data-slate-leaf="true" data-offset-key="124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"297612312"</span></span></span></span><span data-slate-object="text" data-key="125"><span data-slate-leaf="true" data-offset-key="125:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="126"><span data-slate-object="text" data-key="127"><span data-slate-leaf="true" data-offset-key="127:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="128"><span data-slate-leaf="true" data-offset-key="128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"search_term"</span></span></span></span><span data-slate-object="text" data-key="129"><span data-slate-leaf="true" data-offset-key="129:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="130"><span data-slate-leaf="true" data-offset-key="130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"极客时间"</span></span></span></span><span data-slate-object="text" data-key="131"><span data-slate-leaf="true" data-offset-key="131:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="132"><span data-slate-object="text" data-key="133"><span data-slate-leaf="true" data-offset-key="133:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="134"><span data-slate-leaf="true" data-offset-key="134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rank"</span></span></span></span><span data-slate-object="text" data-key="135"><span data-slate-leaf="true" data-offset-key="135:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="136"><span data-slate-leaf="true" data-offset-key="136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="137"><span data-slate-leaf="true" data-offset-key="137:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="138"><span data-slate-object="text" data-key="139"><span data-slate-leaf="true" data-offset-key="139:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="140"><span data-slate-leaf="true" data-offset-key="140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"landing_url"</span></span></span></span><span data-slate-object="text" data-key="141"><span data-slate-leaf="true" data-offset-key="141:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="142"><span data-slate-leaf="true" data-offset-key="142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://b.geekbang.org/"</span></span></span></span><span data-slate-object="text" data-key="143"><span data-slate-leaf="true" data-offset-key="143:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="144"><span data-slate-object="text" data-key="145"><span data-slate-leaf="true" data-offset-key="145:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="146"><span data-slate-leaf="true" data-offset-key="146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"click_timestamp"</span></span></span></span><span data-slate-object="text" data-key="147"><span data-slate-leaf="true" data-offset-key="147:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="148"><span data-slate-leaf="true" data-offset-key="148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1618954621</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="149"><span data-slate-object="text" data-key="150"><span data-slate-leaf="true" data-offset-key="150:0" data-first-offset="true"><span data-slate-string="true">  },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="151"><span data-slate-object="text" data-key="152"><span data-slate-leaf="true" data-offset-key="152:0" data-first-offset="true"><span data-slate-string="true">  ……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="153"><span data-slate-object="text" data-key="154"><span data-slate-leaf="true" data-offset-key="154:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="155"><span data-slate-object="text" data-key="156"><span data-slate-leaf="true" data-offset-key="156:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="157"><span data-slate-leaf="true" data-offset-key="157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"user_id"</span></span></span></span><span data-slate-object="text" data-key="158"><span data-slate-leaf="true" data-offset-key="158:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="159"><span data-slate-leaf="true" data-offset-key="159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"A23123711"</span></span></span></span><span data-slate-object="text" data-key="160"><span data-slate-leaf="true" data-offset-key="160:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="161"><span data-slate-object="text" data-key="162"><span data-slate-leaf="true" data-offset-key="162:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="163"><span data-slate-leaf="true" data-offset-key="163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"search_term"</span></span></span></span><span data-slate-object="text" data-key="164"><span data-slate-leaf="true" data-offset-key="164:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="165"><span data-slate-leaf="true" data-offset-key="165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Thrift 论文"</span></span></span></span><span data-slate-object="text" data-key="166"><span data-slate-leaf="true" data-offset-key="166:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="167"><span data-slate-object="text" data-key="168"><span data-slate-leaf="true" data-offset-key="168:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="169"><span data-slate-leaf="true" data-offset-key="169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rank"</span></span></span></span><span data-slate-object="text" data-key="170"><span data-slate-leaf="true" data-offset-key="170:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="171"><span data-slate-leaf="true" data-offset-key="171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="172"><span data-slate-leaf="true" data-offset-key="172:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="173"><span data-slate-object="text" data-key="174"><span data-slate-leaf="true" data-offset-key="174:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="175"><span data-slate-leaf="true" data-offset-key="175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"landing_url"</span></span></span></span><span data-slate-object="text" data-key="176"><span data-slate-leaf="true" data-offset-key="176:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="177"><span data-slate-leaf="true" data-offset-key="177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://zh.wikipedia.org/zh-hans/Thrift"</span></span></span></span><span data-slate-object="text" data-key="178"><span data-slate-leaf="true" data-offset-key="178:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="179"><span data-slate-object="text" data-key="180"><span data-slate-leaf="true" data-offset-key="180:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="181"><span data-slate-leaf="true" data-offset-key="181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"click_timestamp"</span></span></span></span><span data-slate-object="text" data-key="182"><span data-slate-leaf="true" data-offset-key="182:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="183"><span data-slate-leaf="true" data-offset-key="183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1632373689</span></span></span></span><span data-slate-object="text" data-key="184"><span data-slate-leaf="true" data-offset-key="184:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="185"><span data-slate-object="text" data-key="186"><span data-slate-leaf="true" data-offset-key="186:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="187"><span data-slate-object="text" data-key="188"><span data-slate-leaf="true" data-offset-key="188:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="189"><span data-slate-object="text" data-key="190"><span data-slate-leaf="true" data-offset-key="190:0" data-first-offset="true"><span data-slate-string="true">事实上，CSV 也好，JSON 也好，乃至 XML 也好，这些针对结构化数据进行编码主要想解决的问题是提升开发人员的效率，所以重视的是数据的 “人类可读性”。因为在小数据量的情况下，程序员的开发效率是核心问题，多浪费一点存储空间算不了什么。</span></span></span><span data-slate-object="text" data-key="191"><span data-slate-leaf="true" data-offset-key="191:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">但是在 “大数据” 的场景下，除了程序员的效率，存储数据本身的 “效率” 就变得非常重要了。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="192" id="sr-toc-2"><span data-slate-object="text" data-key="193"><span data-slate-leaf="true" data-offset-key="193:0" data-first-offset="true"><span data-slate-string="true">优化存储空间为目标的二进制序列化</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="194"><span data-slate-object="text" data-key="195"><span data-slate-leaf="true" data-offset-key="195:0" data-first-offset="true"><span data-slate-string="true">想要减少存储所占的空间，那最直接的想法，自然是我们自定义一个序列化方法，按照各个字段实际的格式把数据写进去。典型的办法就是 </span></span></span><span data-slate-object="text" data-key="196"><span data-slate-leaf="true" data-offset-key="196:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Java 的序列化</span></span></span></span><span data-slate-object="text" data-key="197"><span data-slate-leaf="true" data-offset-key="197:0" data-first-offset="true"><span data-slate-string="true">，我们按照 String—&gt;String—&gt;Int—&gt;String—&gt;Int 的顺序，把数据写入到一个字节数组里面，等需要读数据的时候，我们就按照这个顺序读出来就好了。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="198"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="199"><span data-slate-object="text" data-key="200"><span data-slate-leaf="true" data-offset-key="200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="201"><span data-slate-leaf="true" data-offset-key="201:0" data-first-offset="true"><span data-slate-string="true"> java.io.*;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="202"><span data-slate-object="text" data-key="203"><span data-slate-leaf="true" data-offset-key="203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="204"><span data-slate-leaf="true" data-offset-key="204:0" data-first-offset="true"><span data-slate-string="true"> java.util.Arrays;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="205"><span data-slate-object="text" data-key="206"><span data-slate-leaf="true" data-offset-key="206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="207"><span data-slate-leaf="true" data-offset-key="207:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="208"><span data-slate-leaf="true" data-offset-key="208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="209"><span data-slate-leaf="true" data-offset-key="209:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="210"><span data-slate-leaf="true" data-offset-key="210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Main</span></span></span></span><span data-slate-object="text" data-key="211"><span data-slate-leaf="true" data-offset-key="211:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="212"><span data-slate-object="text" data-key="213"><span data-slate-leaf="true" data-offset-key="213:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="214"><span data-slate-leaf="true" data-offset-key="214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="215"><span data-slate-leaf="true" data-offset-key="215:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="216"><span data-slate-leaf="true" data-offset-key="216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="217"><span data-slate-leaf="true" data-offset-key="217:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="218"><span data-slate-leaf="true" data-offset-key="218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="219"><span data-slate-leaf="true" data-offset-key="219:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="220"><span data-slate-leaf="true" data-offset-key="220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span><span data-slate-object="text" data-key="221"><span data-slate-leaf="true" data-offset-key="221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(String[] args)</span></span></span></span><span data-slate-object="text" data-key="222"><span data-slate-leaf="true" data-offset-key="222:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="223"><span data-slate-leaf="true" data-offset-key="223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throws</span></span></span></span><span data-slate-object="text" data-key="224"><span data-slate-leaf="true" data-offset-key="224:0" data-first-offset="true"><span data-slate-string="true"> IOException {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="225"><span data-slate-object="text" data-key="226"><span data-slate-leaf="true" data-offset-key="226:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="227"><span data-slate-leaf="true" data-offset-key="227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ByteArrayOutputStream</span></span></span></span><span data-slate-object="text" data-key="228"><span data-slate-leaf="true" data-offset-key="228:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="229"><span data-slate-leaf="true" data-offset-key="229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">buffer</span></span></span></span><span data-slate-object="text" data-key="230"><span data-slate-leaf="true" data-offset-key="230:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="231"><span data-slate-leaf="true" data-offset-key="231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="232"><span data-slate-leaf="true" data-offset-key="232:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="233"><span data-slate-leaf="true" data-offset-key="233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="234"><span data-slate-leaf="true" data-offset-key="234:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="235"><span data-slate-leaf="true" data-offset-key="235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ByteArrayOutputStream</span></span></span></span><span data-slate-object="text" data-key="236"><span data-slate-leaf="true" data-offset-key="236:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="237"><span data-slate-object="text" data-key="238"><span data-slate-leaf="true" data-offset-key="238:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="239"><span data-slate-leaf="true" data-offset-key="239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="240"><span data-slate-leaf="true" data-offset-key="240:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="241"><span data-slate-leaf="true" data-offset-key="241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ObjectOutputStream</span></span></span></span><span data-slate-object="text" data-key="242"><span data-slate-leaf="true" data-offset-key="242:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="243"><span data-slate-leaf="true" data-offset-key="243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">output</span></span></span></span><span data-slate-object="text" data-key="244"><span data-slate-leaf="true" data-offset-key="244:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="245"><span data-slate-leaf="true" data-offset-key="245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="246"><span data-slate-leaf="true" data-offset-key="246:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="247"><span data-slate-leaf="true" data-offset-key="247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="248"><span data-slate-leaf="true" data-offset-key="248:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="249"><span data-slate-leaf="true" data-offset-key="249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ObjectOutputStream</span></span></span></span><span data-slate-object="text" data-key="250"><span data-slate-leaf="true" data-offset-key="250:0" data-first-offset="true"><span data-slate-string="true">(buffer)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="251"><span data-slate-object="text" data-key="252"><span data-slate-leaf="true" data-offset-key="252:0" data-first-offset="true"><span data-slate-string="true">            output.writeUTF(</span></span></span><span data-slate-object="text" data-key="253"><span data-slate-leaf="true" data-offset-key="253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"597819210"</span></span></span></span><span data-slate-object="text" data-key="254"><span data-slate-leaf="true" data-offset-key="254:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="255"><span data-slate-object="text" data-key="256"><span data-slate-leaf="true" data-offset-key="256:0" data-first-offset="true"><span data-slate-string="true">            output.writeUTF(</span></span></span><span data-slate-object="text" data-key="257"><span data-slate-leaf="true" data-offset-key="257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"大数据"</span></span></span></span><span data-slate-object="text" data-key="258"><span data-slate-leaf="true" data-offset-key="258:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="259"><span data-slate-object="text" data-key="260"><span data-slate-leaf="true" data-offset-key="260:0" data-first-offset="true"><span data-slate-string="true">            output.writeInt(</span></span></span><span data-slate-object="text" data-key="261"><span data-slate-leaf="true" data-offset-key="261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="262"><span data-slate-leaf="true" data-offset-key="262:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="263"><span data-slate-object="text" data-key="264"><span data-slate-leaf="true" data-offset-key="264:0" data-first-offset="true"><span data-slate-string="true">            output.writeUTF(</span></span></span><span data-slate-object="text" data-key="265"><span data-slate-leaf="true" data-offset-key="265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"https://aws.amazon.com/cn/big-data/what-is-big-data/"</span></span></span></span><span data-slate-object="text" data-key="266"><span data-slate-leaf="true" data-offset-key="266:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="267"><span data-slate-object="text" data-key="268"><span data-slate-leaf="true" data-offset-key="268:0" data-first-offset="true"><span data-slate-string="true">            output.writeInt(</span></span></span><span data-slate-object="text" data-key="269"><span data-slate-leaf="true" data-offset-key="269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1592373781</span></span></span></span><span data-slate-object="text" data-key="270"><span data-slate-leaf="true" data-offset-key="270:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="271"><span data-slate-object="text" data-key="272"><span data-slate-leaf="true" data-offset-key="272:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="273"><span data-slate-object="text" data-key="274"><span data-slate-leaf="true" data-offset-key="274:0" data-first-offset="true"><span data-slate-string="true">        System.out.println(Arrays.toString(buffer.toByteArray()));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="275"><span data-slate-object="text" data-key="276"><span data-slate-leaf="true" data-offset-key="276:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="277"><span data-slate-object="text" data-key="278"><span data-slate-leaf="true" data-offset-key="278:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="279"><span data-slate-object="text" data-key="280"><span data-slate-leaf="true" data-offset-key="280:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">通过 Java 代码进行序列化的示例</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="281"><span data-slate-object="text" data-key="282"><span data-slate-leaf="true" data-offset-key="282:0" data-first-offset="true"><span data-slate-string="true">这个方法的确确保了数据都有类型，并且占用的存储空间尽可能小。</span></span></span><span data-slate-object="text" data-key="283"><span data-slate-leaf="true" data-offset-key="283:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">但是这个实现却有一个重大缺点</span></span></span></span><span data-slate-object="text" data-key="284"><span data-slate-leaf="true" data-offset-key="284:0" data-first-offset="true"><span data-slate-string="true">，就是我们读写数据的 Schema，是隐式地包含在代码里的，而且每有一张新的数据表或者说新的数据格式，我们就要手写序列化反序列化的代码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="285"><span data-slate-object="text" data-key="286"><span data-slate-leaf="true" data-offset-key="286:0" data-first-offset="true"><span data-slate-string="true">那么，我们有没有什么解决办法呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="287" id="sr-toc-3"><span data-slate-object="text" data-key="288"><span data-slate-leaf="true" data-offset-key="288:0" data-first-offset="true"><span data-slate-string="true">包含 IDL 并能向前和向后兼容的 Thrift 的 TBinaryProtocol</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="289"><span data-slate-object="text" data-key="290"><span data-slate-leaf="true" data-offset-key="290:0" data-first-offset="true"><span data-slate-string="true">我能想到的办法，其实已经接近 Thrift 的实现了，我们可以这么做：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="291"><div data-slate-type="list-line" data-slate-object="block" data-key="292"><span data-slate-object="text" data-key="293"><span data-slate-leaf="true" data-offset-key="293:0" data-first-offset="true"><span data-slate-string="true">通过 Schema 文件，定义出一个结构体，然后在里面列清楚字段的顺序、类型以及名称。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="294"><span data-slate-object="text" data-key="295"><span data-slate-leaf="true" data-offset-key="295:0" data-first-offset="true"><span data-slate-string="true">写一个程序，能够解析这个 Schema 文件，然后自动生成可以根据结构体的 Schema 进行序列化和反序列化的代码。这个序列化和反序列化的代码是非常简单的，只要按照 Schema 里面出现的字段顺序，一个个对着字节数组去读或者写数据就好了。</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="296"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="297"><span data-slate-object="text" data-key="298"><span data-slate-leaf="true" data-offset-key="298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="299"><span data-slate-leaf="true" data-offset-key="299:0" data-first-offset="true"><span data-slate-string="true"> SearchClick</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="300"><span data-slate-object="text" data-key="301"><span data-slate-leaf="true" data-offset-key="301:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="302"><span data-slate-object="text" data-key="303"><span data-slate-leaf="true" data-offset-key="303:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="304"><span data-slate-leaf="true" data-offset-key="304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="305"><span data-slate-leaf="true" data-offset-key="305:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="306"><span data-slate-leaf="true" data-offset-key="306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="307"><span data-slate-leaf="true" data-offset-key="307:0" data-first-offset="true"><span data-slate-string="true"> user_id,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="308"><span data-slate-object="text" data-key="309"><span data-slate-leaf="true" data-offset-key="309:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="310"><span data-slate-leaf="true" data-offset-key="310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="311"><span data-slate-leaf="true" data-offset-key="311:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="312"><span data-slate-leaf="true" data-offset-key="312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="313"><span data-slate-leaf="true" data-offset-key="313:0" data-first-offset="true"><span data-slate-string="true"> search_term,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="314"><span data-slate-object="text" data-key="315"><span data-slate-leaf="true" data-offset-key="315:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="316"><span data-slate-leaf="true" data-offset-key="316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="317"><span data-slate-leaf="true" data-offset-key="317:0" data-first-offset="true"><span data-slate-string="true">:i16 rank,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="318"><span data-slate-object="text" data-key="319"><span data-slate-leaf="true" data-offset-key="319:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="320"><span data-slate-leaf="true" data-offset-key="320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="321"><span data-slate-leaf="true" data-offset-key="321:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="322"><span data-slate-leaf="true" data-offset-key="322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="323"><span data-slate-leaf="true" data-offset-key="323:0" data-first-offset="true"><span data-slate-string="true"> landing_url,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="324"><span data-slate-object="text" data-key="325"><span data-slate-leaf="true" data-offset-key="325:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="326"><span data-slate-leaf="true" data-offset-key="326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="327"><span data-slate-leaf="true" data-offset-key="327:0" data-first-offset="true"><span data-slate-string="true">:i32 click_timestamp,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="328"><span data-slate-object="text" data-key="329"><span data-slate-leaf="true" data-offset-key="329:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="330"><span data-slate-object="text" data-key="331"><span data-slate-leaf="true" data-offset-key="331:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">Thrift IDL 文件</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="332"><span data-slate-object="text" data-key="333"><span data-slate-leaf="true" data-offset-key="333:0" data-first-offset="true"><span data-slate-string="true">这里我把前面 5 个字段的 CSV 格式，用 Thrift 的 IDL 写了出来，你会发现它就是定义了序号、类型以及名称。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="334"><span data-slate-object="text" data-key="335"><span data-slate-leaf="true" data-offset-key="335:0" data-first-offset="true"><span data-slate-string="true">我们前面的实现思路已经非常接近于 Thrift 里，TBinaryProtocol 这个协议的实现了，但是仍然有小小的差异。这个差异，就是我们要面临的下一个问题：数据格式可能会变，我们需要考虑</span></span></span><span data-slate-object="text" data-key="336"><span data-slate-leaf="true" data-offset-key="336:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">数据格式的多版本问题</span></span></span></span><span data-slate-object="text" data-key="337"><span data-slate-leaf="true" data-offset-key="337:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="338"><span data-slate-object="text" data-key="339"><span data-slate-leaf="true" data-offset-key="339:0" data-first-offset="true"><span data-slate-string="true">回到前面的搜索点击数据，我们发现，现有的这 5 个字段满足不了需求。根据实际情况，我们需要增加两个新字段，去掉一个老字段：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="340"><div data-slate-type="list-line" data-slate-object="block" data-key="341"><span data-slate-object="text" data-key="342"><span data-slate-leaf="true" data-offset-key="342:0" data-first-offset="true"><span data-slate-string="true">首先，是我们想要根据用户的地理位置信息，做一些统计分析，所以我们需要在原来的数据里，加上 IP 地址这个字段；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="343"><span data-slate-object="text" data-key="344"><span data-slate-leaf="true" data-offset-key="344:0" data-first-offset="true"><span data-slate-string="true">其次，是原先的点击时间字段，用的是 32 位整型数，数据精度只能到秒。那么同一个用户如果在同一秒内连续点击了两条搜索结果，我们就分不清先后了，所以我们希望能够用一个 64 位整型来表示这个数据，而且原先那个字段要废弃掉。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="345"><span data-slate-object="text" data-key="346"><span data-slate-leaf="true" data-offset-key="346:0" data-first-offset="true"><span data-slate-string="true">既然如此，那最直接的想法，自然是定义一个新的数据格式呗，有我们需要的 6 个字段就好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="347"><span data-slate-object="text" data-key="348"><span data-slate-leaf="true" data-offset-key="348:0" data-first-offset="true"><span data-slate-string="true">但是现实生活总是比我们想得更复杂，我们把原来格式的数据叫做 v1 版本的数据，新的格式叫做 v2 版本的数据，现在我们来看看，直接换上一个新的 v2 格式，会遇到一些什么问题：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="349"><div data-slate-type="list-line" data-slate-object="block" data-key="350"><span data-slate-object="text" data-key="351"><span data-slate-leaf="true" data-offset-key="351:0" data-first-offset="true"><span data-slate-string="true">首先，是我们历史上已经生成了很多 v1 版本的数据了，如果在格式切换之后，要去统计一段时间的数据，我们的新程序就需要同时能够解析 v1 和 v2 版本的数据。这个，也就是我们的程序需要有</span></span></span><span data-slate-object="text" data-key="352"><span data-slate-leaf="true" data-offset-key="352:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">向前兼容</span></span></span></span><span data-slate-object="text" data-key="353"><span data-slate-leaf="true" data-offset-key="353:0" data-first-offset="true"><span data-slate-string="true">能力。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="354"><span data-slate-object="text" data-key="355"><span data-slate-leaf="true" data-offset-key="355:0" data-first-offset="true"><span data-slate-string="true">其次，是除了要满足新需求之外，我们可能有各种各样的数据分析程序，仍然依赖原有的数据格式。如果我们要替换数据格式，意味着对所有这些程序都需要在当天切换的时候做完改造。这样既不现实，也不经济。最好，我们的老程序仍然可以读新的数据格式，也就是有</span></span></span><span data-slate-object="text" data-key="356"><span data-slate-leaf="true" data-offset-key="356:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">向后兼容</span></span></span></span><span data-slate-object="text" data-key="357"><span data-slate-leaf="true" data-offset-key="357:0" data-first-offset="true"><span data-slate-string="true">的能力。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="358"><span data-slate-object="text" data-key="359"><span data-slate-leaf="true" data-offset-key="359:0" data-first-offset="true"><span data-slate-string="true">这个能够同时向前向后兼容的能力，就是我们对于 Thrift 的 TBinaryProtocol 协议的序列化提出的要求了。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="360"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="361"><span data-slate-object="text" data-key="362"><span data-slate-leaf="true" data-offset-key="362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="363"><span data-slate-leaf="true" data-offset-key="363:0" data-first-offset="true"><span data-slate-string="true"> SearchClick</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="364"><span data-slate-object="text" data-key="365"><span data-slate-leaf="true" data-offset-key="365:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="366"><span data-slate-object="text" data-key="367"><span data-slate-leaf="true" data-offset-key="367:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="368"><span data-slate-leaf="true" data-offset-key="368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="369"><span data-slate-leaf="true" data-offset-key="369:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="370"><span data-slate-leaf="true" data-offset-key="370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="371"><span data-slate-leaf="true" data-offset-key="371:0" data-first-offset="true"><span data-slate-string="true"> user_id,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="372"><span data-slate-object="text" data-key="373"><span data-slate-leaf="true" data-offset-key="373:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="374"><span data-slate-leaf="true" data-offset-key="374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="375"><span data-slate-leaf="true" data-offset-key="375:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="376"><span data-slate-leaf="true" data-offset-key="376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="377"><span data-slate-leaf="true" data-offset-key="377:0" data-first-offset="true"><span data-slate-string="true"> search_term,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="378"><span data-slate-object="text" data-key="379"><span data-slate-leaf="true" data-offset-key="379:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="380"><span data-slate-leaf="true" data-offset-key="380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="381"><span data-slate-leaf="true" data-offset-key="381:0" data-first-offset="true"><span data-slate-string="true">:i16 rank,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="382"><span data-slate-object="text" data-key="383"><span data-slate-leaf="true" data-offset-key="383:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="384"><span data-slate-leaf="true" data-offset-key="384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="385"><span data-slate-leaf="true" data-offset-key="385:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="386"><span data-slate-leaf="true" data-offset-key="386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="387"><span data-slate-leaf="true" data-offset-key="387:0" data-first-offset="true"><span data-slate-string="true"> landing_url,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="388"><span data-slate-object="text" data-key="389"><span data-slate-leaf="true" data-offset-key="389:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="390"><span data-slate-leaf="true" data-offset-key="390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 5:i32 click_timestamp, deprecated 已废弃</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="391"><span data-slate-object="text" data-key="392"><span data-slate-leaf="true" data-offset-key="392:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="393"><span data-slate-leaf="true" data-offset-key="393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span><span data-slate-object="text" data-key="394"><span data-slate-leaf="true" data-offset-key="394:0" data-first-offset="true"><span data-slate-string="true">:i64 click_long_timestamp,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="395"><span data-slate-object="text" data-key="396"><span data-slate-leaf="true" data-offset-key="396:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="397"><span data-slate-leaf="true" data-offset-key="397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="398"><span data-slate-leaf="true" data-offset-key="398:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="399"><span data-slate-leaf="true" data-offset-key="399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="400"><span data-slate-leaf="true" data-offset-key="400:0" data-first-offset="true"><span data-slate-string="true"> ip_address</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="401"><span data-slate-object="text" data-key="402"><span data-slate-leaf="true" data-offset-key="402:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="403"><span data-slate-object="text" data-key="404"><span data-slate-leaf="true" data-offset-key="404:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">加上新字段，废弃老字段的 IDL</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="405"><span data-slate-object="text" data-key="406"><span data-slate-leaf="true" data-offset-key="406:0" data-first-offset="true"><span data-slate-string="true">而 Thrift 里的 </span></span></span><span data-slate-object="text" data-key="407"><span data-slate-leaf="true" data-offset-key="407:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">TBinaryProtocol 的实现方式</span></span></span></span><span data-slate-object="text" data-key="408"><span data-slate-leaf="true" data-offset-key="408:0" data-first-offset="true"><span data-slate-string="true">也很简单，那就是顺序写入数据的过程中，不仅会写入数据的值（field-value），还会写入数据的编号（field-id）和类型（field-type）；读取的时候也一样。并且，在每一条记录的结束都会写下一个标志位。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="409"><span data-slate-object="text" data-key="410"><span data-slate-leaf="true" data-offset-key="410:0" data-first-offset="true"><span data-slate-string="true">这样，在读取数据的时候，老版本的 v1 代码，看到自己没有见过的编号就可以跳过。新版本的 v2 代码，对于老数据里没有的字段，也就是读不到值而已，并不会出现不兼容的情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="411"><span data-slate-object="text" data-key="412"><span data-slate-leaf="true" data-offset-key="412:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在这个机制下，我们顺序排列的编号，就起到了版本的作用，而我们不需要再专门去进行数据版本的管理了。</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="413"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/73/51/7354c9c60254bc184b9ea7974155e451.jpg?wh=1920x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="414"><span data-slate-object="text" data-key="415"><span data-slate-leaf="true" data-offset-key="415:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">Thrift 更详细的结构的规格书，可以参看对应开源项目中的</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="416" one-link-mark="yes"><span data-slate-object="text" data-key="417"><span data-slate-leaf="true" data-offset-key="417:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">文档</span></span></span></span></a></div><div data-slate-type="paragraph" data-slate-object="block" data-key="418"><span data-slate-object="text" data-key="419"><span data-slate-leaf="true" data-offset-key="419:0" data-first-offset="true"><span data-slate-string="true">而且，</span></span></span><span data-slate-object="text" data-key="420"><span data-slate-leaf="true" data-offset-key="420:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">写下编号还带来了一个好处</span></span></span></span><span data-slate-object="text" data-key="421"><span data-slate-leaf="true" data-offset-key="421:0" data-first-offset="true"><span data-slate-string="true">，就是我们不再需要确保每个字段都填上值了，这个帮我们解决了很多问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="422"><span data-slate-object="text" data-key="423"><span data-slate-leaf="true" data-offset-key="423:0" data-first-offset="true"><span data-slate-string="true">我们可以废弃字段，并且这些废弃的字段不会占用存储空间。我们会随着需求变更不断新加字段，数十乃至上百个字段的 struct 在真实的工程场景中是非常正常的。而在这个过程中，很多字段都会被逐步废弃不再使用。如果这些字段仍然要占用存储空间的话，也会是一大浪费。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="424"><span data-slate-object="text" data-key="425"><span data-slate-leaf="true" data-offset-key="425:0" data-first-offset="true"><span data-slate-string="true">那么，对于不需要的老字段，我们只要在 IDL 中，将对应的编号注释掉，写入数据的时候不写这些数据，就不会占用空间。而且因为 Thrift 读取数据是读取编号并解析值的，这个也不会破坏数据的兼容性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="426"><span data-slate-object="text" data-key="427"><span data-slate-leaf="true" data-offset-key="427:0" data-first-offset="true"><span data-slate-string="true">这样下来，整个 struct 其实就变成了一个稀疏结构，不是每个字段都需要填上值。</span></span><span data-slate-leaf="true" data-offset-key="427:1"><span data-slate-object="annotation" data-annotation-key="gkann_e66f2346" data-attr-id="30483" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这个思路其实和 Bigtable 里 Column（列）的设计一脉相成。</span></span></span><span data-slate-leaf="true" data-offset-key="427:2"><span data-slate-string="true">本质上，在大数据的场景下，我们的代码、需求都无法保证在设计第一个版本的时候就 100% 想清楚。</span></span></span><span data-slate-object="text" data-key="428"><span data-slate-leaf="true" data-offset-key="428:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">我们无法预测未来，我们又需要很多人一起共同协作，所以我们就需要保障数据、代码不仅能向前兼容，而且还能向后兼容。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="429" id="sr-toc-4"><span data-slate-object="text" data-key="430"><span data-slate-leaf="true" data-offset-key="430:0" data-first-offset="true"><span data-slate-string="true">进一步优化的 TCompactProtocol</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="431"><span data-slate-object="text" data-key="432"><span data-slate-leaf="true" data-offset-key="432:0" data-first-offset="true"><span data-slate-string="true">Thrift 的论文里，对于数据的序列化，到 TBinaryProtocol 就已经结束了。但是作为开发者，我们的优化还没有到极致。通过编号和类型的确让我们有了向前向后兼容性，但是似乎又让我们的数据冗余变大了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="433"><span data-slate-object="text" data-key="434"><span data-slate-leaf="true" data-offset-key="434:0" data-first-offset="true"><span data-slate-string="true">就以一开始 CSV 里的 click_timestamp 字段为例，我们虽然通过把字符串换成了整型数（i32），节约了 6 个字节。但是，我们加了一个编号，就又把这省下来的 4 个字节给用掉了，并且每个字段都需要编号，另外别忘了我们还有类型需要写下来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="435"><span data-slate-object="text" data-key="436"><span data-slate-leaf="true" data-offset-key="436:0" data-first-offset="true"><span data-slate-string="true">不过，为了向前向后兼容性，编号和类型都是少不了的。那么，</span></span></span><span data-slate-object="text" data-key="437"><span data-slate-leaf="true" data-offset-key="437:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">有没有什么别的办法能够进一步减少需要的存储空间呢？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="438"><span data-slate-object="text" data-key="439"><span data-slate-leaf="true" data-offset-key="439:0" data-first-offset="true"><span data-slate-string="true">你别说，在 Thrift 的开源项目里还真有这样的办法，那就是通过 TCompactProtocol 进行编码。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="440" id="sr-toc-5"><span data-slate-object="text" data-key="441"><span data-slate-leaf="true" data-offset-key="441:0" data-first-offset="true"><span data-slate-string="true">Delta Encoding</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="442"><span data-slate-object="text" data-key="443"><span data-slate-leaf="true" data-offset-key="443:0" data-first-offset="true"><span data-slate-string="true">顾名思义，</span></span></span><span data-slate-object="text" data-key="444"><span data-slate-leaf="true" data-offset-key="444:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">TCompactProtocol 就是一种 “紧凑” 的编码方式</span></span></span></span><span data-slate-object="text" data-key="445"><span data-slate-leaf="true" data-offset-key="445:0" data-first-offset="true"><span data-slate-string="true">。Thrift 的 IDL 都是从 1 开始编号的，而且通常两个字段的编号是连续的。所以这个协议在存储编号的时候，存储的不是编号的值，而是存储编号和上一个编号的差。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="446"><span data-slate-object="text" data-key="447"><span data-slate-leaf="true" data-offset-key="447:0" data-first-offset="true"><span data-slate-string="true">比如，第一个编号是 1，第二个编号是 5，编号 2、3、4 没有值或者已经被我们废弃掉了，那么，第二个编号存储的直接就是 4。这种方式叫做 </span></span></span><span data-slate-object="text" data-key="448"><span data-slate-leaf="true" data-offset-key="448:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Delta Encoding</span></span></span></span><span data-slate-object="text" data-key="449"><span data-slate-leaf="true" data-offset-key="449:0" data-first-offset="true"><span data-slate-string="true">，在倒排索引中也经常会用到，用来节约存储空间。我们用 4 个 bit 来存储这个差值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="450"><span data-slate-object="text" data-key="451"><span data-slate-leaf="true" data-offset-key="451:0" data-first-offset="true"><span data-slate-string="true">然后，我们再通过另外 4 个 bit 表示类型信息。那么通常来说，通过一个字节，我们就能把编号和类型表示出来。毕竟，我们的类型不到 16 种，4 个 bit 就够了，而通常两个字段之间的差，也不会超过 15，也就是 4 个 bit 能表示的最大整型数。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="452"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/6e/a8/6e90cf645d8ba7a33dfd497a63da52a8.jpg?wh=1920x712"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="453"><span data-slate-object="text" data-key="454"><span data-slate-leaf="true" data-offset-key="454:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">TCompactProtocol 的实现其实很简单，如果你想深入了解细节，可以直接去读一读</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="455" one-link-mark="yes"><span data-slate-object="text" data-key="456"><span data-slate-leaf="true" data-offset-key="456:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">源码</span></span></span></span></a></div><div data-slate-type="paragraph" data-slate-object="block" data-key="457"><span data-slate-object="text" data-key="458"><span data-slate-leaf="true" data-offset-key="458:0" data-first-offset="true"><span data-slate-string="true">不过，如果两个序号的差如果超过 15 怎么办呢？那么，我们就通过 1 个字节来表示类型，然后再用 1~5 个字节来表示两个连续编号之间的差，也就是下面我要介绍的 </span></span></span><span data-slate-object="text" data-key="459"><span data-slate-leaf="true" data-offset-key="459:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ZigZag+VQL</span></span></span></span><span data-slate-object="text" data-key="460"><span data-slate-leaf="true" data-offset-key="460:0" data-first-offset="true"><span data-slate-string="true"> 的编码方式。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="461" id="sr-toc-6"><span data-slate-object="text" data-key="462"><span data-slate-leaf="true" data-offset-key="462:0" data-first-offset="true"><span data-slate-string="true">ZigZag 编码 +VQL 可变长数值表示</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="463"><span data-slate-object="text" data-key="464"><span data-slate-leaf="true" data-offset-key="464:0" data-first-offset="true"><span data-slate-string="true">很多时候，我们存储的整数都不会很大，比如通过一个整型数来表示系统中存在的状态，我们并不需要 2 的 32 次方，也就是 40 亿种状态，可能一个字节的 127 种状态就绰绰有余了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="465"><span data-slate-object="text" data-key="466"><span data-slate-leaf="true" data-offset-key="466:0" data-first-offset="true"><span data-slate-string="true">所以，TCompactProtocol 对于所有的整数类型的值，都采用了</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="467" one-link-mark="yes"><span data-slate-object="text" data-key="468"><span data-slate-leaf="true" data-offset-key="468:0" data-first-offset="true"><span data-slate-string="true">可变长数值</span></span></span></a><span data-slate-object="text" data-key="469"><span data-slate-leaf="true" data-offset-key="469:0" data-first-offset="true"><span data-slate-string="true">（VQL，Variable-length quantity）的表示方式，通过 1~N 个 byte 来表示整数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="470"><span data-slate-object="text" data-key="471"><span data-slate-leaf="true" data-offset-key="471:0" data-first-offset="true"><span data-slate-string="true">这个编码方式的每一个字节的高位，都会用第一个 bit 用来标记，也就是第一个 bit 用来标记整个整数是否还需要读入下一个字节，而后面的 7 个 bit 用来表示实际存放的数据。这样，一个 32 位的整型数，最少只要用一个字节来表示，最多也只需要用 5 个字节来表示，因为 7bit x 5=35 bit 已经足够有 32 位了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="472"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/6d/08/6dfdaba653c70444468d05b6d24e3508.jpg?wh=1920x1051"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="473"><span data-slate-object="text" data-key="474"><span data-slate-leaf="true" data-offset-key="474:0" data-first-offset="true"><span data-slate-string="true">而因为整型数的负数，首位一定是 1。这样，对于像 -1 这样常用的数，用 16 进制表示就会是 0XFFFFFFFF，用 0 和 1 表示的话就是连续 32 个 1，会占用 5 个字节。所以，后面 7 个 bit 一组的编码，并没有采用普通的编码方式，而是采用了一种叫做 </span></span></span><span data-slate-object="text" data-key="475"><span data-slate-leaf="true" data-offset-key="475:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ZigZag</span></span></span></span><span data-slate-object="text" data-key="476"><span data-slate-leaf="true" data-offset-key="476:0" data-first-offset="true"><span data-slate-string="true"> 的编码方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="477"><span data-slate-object="text" data-key="478"><span data-slate-leaf="true" data-offset-key="478:0" data-first-offset="true"><span data-slate-string="true">简单来说，就是负数变成正数，而正数去乘以 2。这样的情况下，7 个 bit 就可以表示 -64 到 63 这 128 个数了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="479"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/13/e9/13104c5ef486bcd891d525ffb78b1ae9.jpg?wh=1920x1001"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="480"><span data-slate-object="text" data-key="481"><span data-slate-leaf="true" data-offset-key="481:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">通过 ZigZag+VQL 的编码方式，只要整数的绝对值小，占用的空间就少</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="482"><span data-slate-object="text" data-key="483"><span data-slate-leaf="true" data-offset-key="483:0" data-first-offset="true"><span data-slate-string="true">通过 ZigZag+VQL 这两种方式，你可以看到，存储一个整数，常常只需要 2 个字节就够了，可以说大大缩小了需要占用的硬盘空间。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="484" id="sr-toc-7"><span data-slate-object="text" data-key="485"><span data-slate-leaf="true" data-offset-key="485:0" data-first-offset="true"><span data-slate-string="true">跨语言、跨协议和可扩展性</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="486"><span data-slate-object="text" data-key="487"><span data-slate-leaf="true" data-offset-key="487:0" data-first-offset="true"><span data-slate-string="true">不知道你有没有发现，直到目前的讲解中，我们并没有涉及到任何编程语言。没错，Thrift 本身并不绑定任何编程语言，这也是论文标题中 “</span></span></span><span data-slate-object="text" data-key="488"><span data-slate-leaf="true" data-offset-key="488:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Cross-Language Service Implementation</span></span></span></span><span data-slate-object="text" data-key="489"><span data-slate-leaf="true" data-offset-key="489:0" data-first-offset="true"><span data-slate-string="true">” 的含义，也就是跨语言的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="490"><span data-slate-object="text" data-key="491"><span data-slate-leaf="true" data-offset-key="491:0" data-first-offset="true"><span data-slate-string="true">今天，在 Thrift 的官方文档里，已经支持了 28 种不同的编程语言。并且，Thrift 同样支持生成跨语言的 RPC 代码，就是一个人完成了 Protobuf 和 gRPC 这样两个项目的作用。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="492"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="493"><span data-slate-object="text" data-key="494"><span data-slate-leaf="true" data-offset-key="494:0" data-first-offset="true"><span data-slate-string="true">namespace cpp Sample</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="495"><span data-slate-object="text" data-key="496"><span data-slate-leaf="true" data-offset-key="496:0" data-first-offset="true"><span data-slate-string="true">  namespace java Sample</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="497"><span data-slate-object="text" data-key="498"><span data-slate-leaf="true" data-offset-key="498:0" data-first-offset="true"><span data-slate-string="true">  namespace perl Sample</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="499"><span data-slate-object="text" data-key="500"><span data-slate-leaf="true" data-offset-key="500:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="501"><span data-slate-object="text" data-key="502"><span data-slate-leaf="true" data-offset-key="502:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="503"><span data-slate-leaf="true" data-offset-key="503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//This struct is not used in the sample. Shown here for illustrative purposes only.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="504"><span data-slate-object="text" data-key="505"><span data-slate-leaf="true" data-offset-key="505:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="506"><span data-slate-leaf="true" data-offset-key="506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="507"><span data-slate-object="text" data-key="508"><span data-slate-leaf="true" data-offset-key="508:0" data-first-offset="true"><span data-slate-string="true">  struct SampleStruct</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="509"><span data-slate-object="text" data-key="510"><span data-slate-leaf="true" data-offset-key="510:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="511"><span data-slate-object="text" data-key="512"><span data-slate-leaf="true" data-offset-key="512:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="513"><span data-slate-leaf="true" data-offset-key="513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="514"><span data-slate-leaf="true" data-offset-key="514:0" data-first-offset="true"><span data-slate-string="true">: i32 key</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="515"><span data-slate-object="text" data-key="516"><span data-slate-leaf="true" data-offset-key="516:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="517"><span data-slate-leaf="true" data-offset-key="517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="518"><span data-slate-leaf="true" data-offset-key="518:0" data-first-offset="true"><span data-slate-string="true">: string value</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="519"><span data-slate-object="text" data-key="520"><span data-slate-leaf="true" data-offset-key="520:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="521"><span data-slate-object="text" data-key="522"><span data-slate-leaf="true" data-offset-key="522:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="523"><span data-slate-object="text" data-key="524"><span data-slate-leaf="true" data-offset-key="524:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="525"><span data-slate-object="text" data-key="526"><span data-slate-leaf="true" data-offset-key="526:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="527"><span data-slate-leaf="true" data-offset-key="527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//A service contains the RPC(s).</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="528"><span data-slate-object="text" data-key="529"><span data-slate-leaf="true" data-offset-key="529:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="530"><span data-slate-leaf="true" data-offset-key="530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="531"><span data-slate-object="text" data-key="532"><span data-slate-leaf="true" data-offset-key="532:0" data-first-offset="true"><span data-slate-string="true">  service SampleService</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="533"><span data-slate-object="text" data-key="534"><span data-slate-leaf="true" data-offset-key="534:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="535"><span data-slate-object="text" data-key="536"><span data-slate-leaf="true" data-offset-key="536:0" data-first-offset="true"><span data-slate-string="true">    string </span></span></span><span data-slate-object="text" data-key="537"><span data-slate-leaf="true" data-offset-key="537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HelloThere</span></span></span></span><span data-slate-object="text" data-key="538"><span data-slate-leaf="true" data-offset-key="538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="539"><span data-slate-leaf="true" data-offset-key="539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></span><span data-slate-object="text" data-key="540"><span data-slate-leaf="true" data-offset-key="540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">:string HelloString)</span></span></span></span><span data-slate-object="text" data-key="541"><span data-slate-leaf="true" data-offset-key="541:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="542"><span data-slate-object="text" data-key="543"><span data-slate-leaf="true" data-offset-key="543:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="544"><span data-slate-leaf="true" data-offset-key="544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="545"><span data-slate-leaf="true" data-offset-key="545:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="546"><span data-slate-leaf="true" data-offset-key="546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ServerDoSomething</span></span></span></span><span data-slate-object="text" data-key="547"><span data-slate-leaf="true" data-offset-key="547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="548"><span data-slate-leaf="true" data-offset-key="548:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="549"><span data-slate-object="text" data-key="550"><span data-slate-leaf="true" data-offset-key="550:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="551"><span data-slate-object="text" data-key="552"><span data-slate-leaf="true" data-offset-key="552:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="553"><span data-slate-leaf="true" data-offset-key="553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Client calls this to tell server which port to connect back on.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="554"><span data-slate-object="text" data-key="555"><span data-slate-leaf="true" data-offset-key="555:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="556"><span data-slate-leaf="true" data-offset-key="556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="557"><span data-slate-leaf="true" data-offset-key="557:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="558"><span data-slate-leaf="true" data-offset-key="558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ClientSideListenPort</span></span></span></span><span data-slate-object="text" data-key="559"><span data-slate-leaf="true" data-offset-key="559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="560"><span data-slate-leaf="true" data-offset-key="560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></span><span data-slate-object="text" data-key="561"><span data-slate-leaf="true" data-offset-key="561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">:i16 Port)</span></span></span></span><span data-slate-object="text" data-key="562"><span data-slate-leaf="true" data-offset-key="562:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="563"><span data-slate-object="text" data-key="564"><span data-slate-leaf="true" data-offset-key="564:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="565"><span data-slate-leaf="true" data-offset-key="565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Named pipe version</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="566"><span data-slate-object="text" data-key="567"><span data-slate-leaf="true" data-offset-key="567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="568"><span data-slate-leaf="true" data-offset-key="568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="569"><span data-slate-leaf="true" data-offset-key="569:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="570"><span data-slate-leaf="true" data-offset-key="570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ClientSidePipeName</span></span></span></span><span data-slate-object="text" data-key="571"><span data-slate-leaf="true" data-offset-key="571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="572"><span data-slate-leaf="true" data-offset-key="572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></span><span data-slate-object="text" data-key="573"><span data-slate-leaf="true" data-offset-key="573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">:string name)</span></span></span></span><span data-slate-object="text" data-key="574"><span data-slate-leaf="true" data-offset-key="574:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="575"><span data-slate-object="text" data-key="576"><span data-slate-leaf="true" data-offset-key="576:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="577"><span data-slate-object="text" data-key="578"><span data-slate-leaf="true" data-offset-key="578:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="579"><span data-slate-object="text" data-key="580"><span data-slate-leaf="true" data-offset-key="580:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="581"><span data-slate-leaf="true" data-offset-key="581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Sample RPC on the 'client' side that the master server can call.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="582"><span data-slate-object="text" data-key="583"><span data-slate-leaf="true" data-offset-key="583:0" data-first-offset="true"><span data-slate-string="true">  service SampleCallback</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="584"><span data-slate-object="text" data-key="585"><span data-slate-leaf="true" data-offset-key="585:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="586"><span data-slate-object="text" data-key="587"><span data-slate-leaf="true" data-offset-key="587:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="588"><span data-slate-leaf="true" data-offset-key="588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="589"><span data-slate-leaf="true" data-offset-key="589:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="590"><span data-slate-leaf="true" data-offset-key="590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pingclient</span></span></span></span><span data-slate-object="text" data-key="591"><span data-slate-leaf="true" data-offset-key="591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="592"><span data-slate-leaf="true" data-offset-key="592:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="593"><span data-slate-object="text" data-key="594"><span data-slate-leaf="true" data-offset-key="594:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="595"><span data-slate-object="text" data-key="596"><span data-slate-leaf="true" data-offset-key="596:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">Thrift 的 IDL 支持直接定义 RPC，其实 RPC 方法的调用，在网络上也是编码成一条 “数据”</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="597"><span data-slate-object="text" data-key="598"><span data-slate-leaf="true" data-offset-key="598:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">跨语言 + 序列化 +RPC，使得 Thrift 解决了一个在 “大数据领域” 中很重要的问题，就是习惯于使用不同编程语言团队之间的协作问题</span></span></span></span><span data-slate-object="text" data-key="599"><span data-slate-leaf="true" data-offset-key="599:0" data-first-offset="true"><span data-slate-string="true">。通过定义一个中间格式的 Thrift IDL 文件，然后通过 Thrift 自动生成代码，写 Web 应用的 PHP 工程师和写后端数据系统的 Java 工程师，就可以直接无缝协作了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="600"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/9b/69/9b49f37da76bdafeb5f82e914587c569.jpg?wh=1920x820"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="601"><span data-slate-object="text" data-key="602"><span data-slate-leaf="true" data-offset-key="602:0" data-first-offset="true"><span data-slate-string="true">不仅如此，Thrift 的设计非常清晰，也非常容易扩展。我们可以根据它的规格书，支持更多的语言，乃至自己定义和实现协议。Thrift 封装好了各类接口，使得底层编码数据的协议（Protocol）、定义如何传输数据的 Transport 都是可以替换的。你只需要实现 Thrift 的一系列函数接口，就能实现一个你需要的协议。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="603"><span data-slate-object="text" data-key="604"><span data-slate-leaf="true" data-offset-key="604:0" data-first-offset="true"><span data-slate-string="true">这也是为什么，Thrift 也支持 JSON、XML 这些序列化的方式。如果你想要把对应的数据传输和处理方式，从 TCP 换成 HTTP，那么也只需要实现一个对应的 Transport 就可以了。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="605"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="606"><span data-slate-object="text" data-key="607"><span data-slate-leaf="true" data-offset-key="607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeMessageBegin</span></span></span></span><span data-slate-object="text" data-key="608"><span data-slate-leaf="true" data-offset-key="608:0" data-first-offset="true"><span data-slate-string="true">(name, </span></span></span><span data-slate-object="text" data-key="609"><span data-slate-leaf="true" data-offset-key="609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="610"><span data-slate-leaf="true" data-offset-key="610:0" data-first-offset="true"><span data-slate-string="true">, seq)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="611"><span data-slate-object="text" data-key="612"><span data-slate-leaf="true" data-offset-key="612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeMessageEnd</span></span></span></span><span data-slate-object="text" data-key="613"><span data-slate-leaf="true" data-offset-key="613:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="614"><span data-slate-object="text" data-key="615"><span data-slate-leaf="true" data-offset-key="615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeStructBegin</span></span></span></span><span data-slate-object="text" data-key="616"><span data-slate-leaf="true" data-offset-key="616:0" data-first-offset="true"><span data-slate-string="true">(name)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="617"><span data-slate-object="text" data-key="618"><span data-slate-leaf="true" data-offset-key="618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeStructEnd</span></span></span></span><span data-slate-object="text" data-key="619"><span data-slate-leaf="true" data-offset-key="619:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="620"><span data-slate-object="text" data-key="621"><span data-slate-leaf="true" data-offset-key="621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeFieldBegin</span></span></span></span><span data-slate-object="text" data-key="622"><span data-slate-leaf="true" data-offset-key="622:0" data-first-offset="true"><span data-slate-string="true">(name, </span></span></span><span data-slate-object="text" data-key="623"><span data-slate-leaf="true" data-offset-key="623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="624"><span data-slate-leaf="true" data-offset-key="624:0" data-first-offset="true"><span data-slate-string="true">, id)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="625"><span data-slate-object="text" data-key="626"><span data-slate-leaf="true" data-offset-key="626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeFieldEnd</span></span></span></span><span data-slate-object="text" data-key="627"><span data-slate-leaf="true" data-offset-key="627:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="628"><span data-slate-object="text" data-key="629"><span data-slate-leaf="true" data-offset-key="629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeFieldStop</span></span></span></span><span data-slate-object="text" data-key="630"><span data-slate-leaf="true" data-offset-key="630:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="631"><span data-slate-object="text" data-key="632"><span data-slate-leaf="true" data-offset-key="632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeMapBegin</span></span></span></span><span data-slate-object="text" data-key="633"><span data-slate-leaf="true" data-offset-key="633:0" data-first-offset="true"><span data-slate-string="true">(ktype, vtype, size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="634"><span data-slate-object="text" data-key="635"><span data-slate-leaf="true" data-offset-key="635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeMapEnd</span></span></span></span><span data-slate-object="text" data-key="636"><span data-slate-leaf="true" data-offset-key="636:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="637"><span data-slate-object="text" data-key="638"><span data-slate-leaf="true" data-offset-key="638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeListBegin</span></span></span></span><span data-slate-object="text" data-key="639"><span data-slate-leaf="true" data-offset-key="639:0" data-first-offset="true"><span data-slate-string="true">(etype, size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="640"><span data-slate-object="text" data-key="641"><span data-slate-leaf="true" data-offset-key="641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeListEnd</span></span></span></span><span data-slate-object="text" data-key="642"><span data-slate-leaf="true" data-offset-key="642:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="643"><span data-slate-object="text" data-key="644"><span data-slate-leaf="true" data-offset-key="644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeSetBegin</span></span></span></span><span data-slate-object="text" data-key="645"><span data-slate-leaf="true" data-offset-key="645:0" data-first-offset="true"><span data-slate-string="true">(etype, size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="646"><span data-slate-object="text" data-key="647"><span data-slate-leaf="true" data-offset-key="647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeSetEnd</span></span></span></span><span data-slate-object="text" data-key="648"><span data-slate-leaf="true" data-offset-key="648:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="649"><span data-slate-object="text" data-key="650"><span data-slate-leaf="true" data-offset-key="650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeBool</span></span></span></span><span data-slate-object="text" data-key="651"><span data-slate-leaf="true" data-offset-key="651:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="652"><span data-slate-leaf="true" data-offset-key="652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="653"><span data-slate-leaf="true" data-offset-key="653:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="654"><span data-slate-object="text" data-key="655"><span data-slate-leaf="true" data-offset-key="655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeByte</span></span></span></span><span data-slate-object="text" data-key="656"><span data-slate-leaf="true" data-offset-key="656:0" data-first-offset="true"><span data-slate-string="true">(byte)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="657"><span data-slate-object="text" data-key="658"><span data-slate-leaf="true" data-offset-key="658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeI16</span></span></span></span><span data-slate-object="text" data-key="659"><span data-slate-leaf="true" data-offset-key="659:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="660"><span data-slate-leaf="true" data-offset-key="660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i16</span></span></span></span><span data-slate-object="text" data-key="661"><span data-slate-leaf="true" data-offset-key="661:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="662"><span data-slate-object="text" data-key="663"><span data-slate-leaf="true" data-offset-key="663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeI32</span></span></span></span><span data-slate-object="text" data-key="664"><span data-slate-leaf="true" data-offset-key="664:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="665"><span data-slate-leaf="true" data-offset-key="665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i32</span></span></span></span><span data-slate-object="text" data-key="666"><span data-slate-leaf="true" data-offset-key="666:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="667"><span data-slate-object="text" data-key="668"><span data-slate-leaf="true" data-offset-key="668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeI64</span></span></span></span><span data-slate-object="text" data-key="669"><span data-slate-leaf="true" data-offset-key="669:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="670"><span data-slate-leaf="true" data-offset-key="670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i64</span></span></span></span><span data-slate-object="text" data-key="671"><span data-slate-leaf="true" data-offset-key="671:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="672"><span data-slate-object="text" data-key="673"><span data-slate-leaf="true" data-offset-key="673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeDouble</span></span></span></span><span data-slate-object="text" data-key="674"><span data-slate-leaf="true" data-offset-key="674:0" data-first-offset="true"><span data-slate-string="true">(double)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="675"><span data-slate-object="text" data-key="676"><span data-slate-leaf="true" data-offset-key="676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeString</span></span></span></span><span data-slate-object="text" data-key="677"><span data-slate-leaf="true" data-offset-key="677:0" data-first-offset="true"><span data-slate-string="true">(string)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="678"><span data-slate-object="text" data-key="679"><span data-slate-leaf="true" data-offset-key="679:0" data-first-offset="true"><span data-slate-string="true">name, </span></span></span><span data-slate-object="text" data-key="680"><span data-slate-leaf="true" data-offset-key="680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="681"><span data-slate-leaf="true" data-offset-key="681:0" data-first-offset="true"><span data-slate-string="true">, seq = </span></span></span><span data-slate-object="text" data-key="682"><span data-slate-leaf="true" data-offset-key="682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readMessageBegin</span></span></span></span><span data-slate-object="text" data-key="683"><span data-slate-leaf="true" data-offset-key="683:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="684"><span data-slate-object="text" data-key="685"><span data-slate-leaf="true" data-offset-key="685:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="686"><span data-slate-leaf="true" data-offset-key="686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readMessageEnd</span></span></span></span><span data-slate-object="text" data-key="687"><span data-slate-leaf="true" data-offset-key="687:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="688"><span data-slate-object="text" data-key="689"><span data-slate-leaf="true" data-offset-key="689:0" data-first-offset="true"><span data-slate-string="true">name = </span></span></span><span data-slate-object="text" data-key="690"><span data-slate-leaf="true" data-offset-key="690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readStructBegin</span></span></span></span><span data-slate-object="text" data-key="691"><span data-slate-leaf="true" data-offset-key="691:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="692"><span data-slate-object="text" data-key="693"><span data-slate-leaf="true" data-offset-key="693:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="694"><span data-slate-leaf="true" data-offset-key="694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readStructEnd</span></span></span></span><span data-slate-object="text" data-key="695"><span data-slate-leaf="true" data-offset-key="695:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="696"><span data-slate-object="text" data-key="697"><span data-slate-leaf="true" data-offset-key="697:0" data-first-offset="true"><span data-slate-string="true">name, </span></span></span><span data-slate-object="text" data-key="698"><span data-slate-leaf="true" data-offset-key="698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="699"><span data-slate-leaf="true" data-offset-key="699:0" data-first-offset="true"><span data-slate-string="true">, id = </span></span></span><span data-slate-object="text" data-key="700"><span data-slate-leaf="true" data-offset-key="700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readFieldBegin</span></span></span></span><span data-slate-object="text" data-key="701"><span data-slate-leaf="true" data-offset-key="701:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="702"><span data-slate-object="text" data-key="703"><span data-slate-leaf="true" data-offset-key="703:0" data-first-offset="true"><span data-slate-string="true">                 </span></span></span><span data-slate-object="text" data-key="704"><span data-slate-leaf="true" data-offset-key="704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readFieldEnd</span></span></span></span><span data-slate-object="text" data-key="705"><span data-slate-leaf="true" data-offset-key="705:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="706"><span data-slate-object="text" data-key="707"><span data-slate-leaf="true" data-offset-key="707:0" data-first-offset="true"><span data-slate-string="true">k, v, size = </span></span></span><span data-slate-object="text" data-key="708"><span data-slate-leaf="true" data-offset-key="708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readMapBegin</span></span></span></span><span data-slate-object="text" data-key="709"><span data-slate-leaf="true" data-offset-key="709:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="710"><span data-slate-object="text" data-key="711"><span data-slate-leaf="true" data-offset-key="711:0" data-first-offset="true"><span data-slate-string="true">             </span></span></span><span data-slate-object="text" data-key="712"><span data-slate-leaf="true" data-offset-key="712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readMapEnd</span></span></span></span><span data-slate-object="text" data-key="713"><span data-slate-leaf="true" data-offset-key="713:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="714"><span data-slate-object="text" data-key="715"><span data-slate-leaf="true" data-offset-key="715:0" data-first-offset="true"><span data-slate-string="true">etype, size = </span></span></span><span data-slate-object="text" data-key="716"><span data-slate-leaf="true" data-offset-key="716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readListBegin</span></span></span></span><span data-slate-object="text" data-key="717"><span data-slate-leaf="true" data-offset-key="717:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="718"><span data-slate-object="text" data-key="719"><span data-slate-leaf="true" data-offset-key="719:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="720"><span data-slate-leaf="true" data-offset-key="720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readListEnd</span></span></span></span><span data-slate-object="text" data-key="721"><span data-slate-leaf="true" data-offset-key="721:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="722"><span data-slate-object="text" data-key="723"><span data-slate-leaf="true" data-offset-key="723:0" data-first-offset="true"><span data-slate-string="true">etype, size = </span></span></span><span data-slate-object="text" data-key="724"><span data-slate-leaf="true" data-offset-key="724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readSetBegin</span></span></span></span><span data-slate-object="text" data-key="725"><span data-slate-leaf="true" data-offset-key="725:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="726"><span data-slate-object="text" data-key="727"><span data-slate-leaf="true" data-offset-key="727:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="728"><span data-slate-leaf="true" data-offset-key="728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readSetEnd</span></span></span></span><span data-slate-object="text" data-key="729"><span data-slate-leaf="true" data-offset-key="729:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="730"><span data-slate-object="text" data-key="731"><span data-slate-leaf="true" data-offset-key="731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="732"><span data-slate-leaf="true" data-offset-key="732:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="733"><span data-slate-leaf="true" data-offset-key="733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readBool</span></span></span></span><span data-slate-object="text" data-key="734"><span data-slate-leaf="true" data-offset-key="734:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="735"><span data-slate-object="text" data-key="736"><span data-slate-leaf="true" data-offset-key="736:0" data-first-offset="true"><span data-slate-string="true">byte = </span></span></span><span data-slate-object="text" data-key="737"><span data-slate-leaf="true" data-offset-key="737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readByte</span></span></span></span><span data-slate-object="text" data-key="738"><span data-slate-leaf="true" data-offset-key="738:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="739"><span data-slate-object="text" data-key="740"><span data-slate-leaf="true" data-offset-key="740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i16</span></span></span></span><span data-slate-object="text" data-key="741"><span data-slate-leaf="true" data-offset-key="741:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="742"><span data-slate-leaf="true" data-offset-key="742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readI16</span></span></span></span><span data-slate-object="text" data-key="743"><span data-slate-leaf="true" data-offset-key="743:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="744"><span data-slate-object="text" data-key="745"><span data-slate-leaf="true" data-offset-key="745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i32</span></span></span></span><span data-slate-object="text" data-key="746"><span data-slate-leaf="true" data-offset-key="746:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="747"><span data-slate-leaf="true" data-offset-key="747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readI32</span></span></span></span><span data-slate-object="text" data-key="748"><span data-slate-leaf="true" data-offset-key="748:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="749"><span data-slate-object="text" data-key="750"><span data-slate-leaf="true" data-offset-key="750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i64</span></span></span></span><span data-slate-object="text" data-key="751"><span data-slate-leaf="true" data-offset-key="751:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="752"><span data-slate-leaf="true" data-offset-key="752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readI64</span></span></span></span><span data-slate-object="text" data-key="753"><span data-slate-leaf="true" data-offset-key="753:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="754"><span data-slate-object="text" data-key="755"><span data-slate-leaf="true" data-offset-key="755:0" data-first-offset="true"><span data-slate-string="true">double = </span></span></span><span data-slate-object="text" data-key="756"><span data-slate-leaf="true" data-offset-key="756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readDouble</span></span></span></span><span data-slate-object="text" data-key="757"><span data-slate-leaf="true" data-offset-key="757:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="758"><span data-slate-object="text" data-key="759"><span data-slate-leaf="true" data-offset-key="759:0" data-first-offset="true"><span data-slate-string="true">string = </span></span></span><span data-slate-object="text" data-key="760"><span data-slate-leaf="true" data-offset-key="760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readString</span></span></span></span><span data-slate-object="text" data-key="761"><span data-slate-leaf="true" data-offset-key="761:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="762"><span data-slate-object="text" data-key="763"><span data-slate-leaf="true" data-offset-key="763:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">你只需要实现这些方法，就可以实现一个自己的序列化协议，可以查看</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="764" one-link-mark="yes"><span data-slate-object="text" data-key="765"><span data-slate-leaf="true" data-offset-key="765:0" data-first-offset="true"><span data-slate-type="secondary" data-slate-object="mark"><span data-slate-string="true">文档</span></span></span></span></a></div><h2 data-slate-type="heading" data-slate-object="block" data-key="766" id="sr-toc-8"><span data-slate-object="text" data-key="767"><span data-slate-leaf="true" data-offset-key="767:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="768"><span data-slate-object="text" data-key="769"><span data-slate-leaf="true" data-offset-key="769:0" data-first-offset="true"><span data-slate-string="true">到这里，我们的 Thrift 论文就讲完了。在学完这一讲之后，相信你能够得到这样三点收获。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="770"><span data-slate-object="text" data-key="771"><span data-slate-leaf="true" data-offset-key="771:0" data-first-offset="true"><span data-slate-string="true">第一，你会深入理解 </span></span></span><span data-slate-object="text" data-key="772"><span data-slate-leaf="true" data-offset-key="772:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Thrift 的数据序列化最优方案</span></span></span></span><span data-slate-object="text" data-key="773"><span data-slate-leaf="true" data-offset-key="773:0" data-first-offset="true"><span data-slate-string="true">是怎么样的，其实 Protobuf 等其他的开源框架，虽然具体细节可能有所不同，但是基本设计是一样的。通过采用编码为二进制，通过存储编号、类型、字段数据，Thrift 做到了向前向后兼容。而通过 Delta Encoding、ZigZag 以及 VQL，TCompactProtocol 这个协议就使得数据序列化之后占用的空间尽可能小了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="774"><span data-slate-object="text" data-key="775"><span data-slate-leaf="true" data-offset-key="775:0" data-first-offset="true"><span data-slate-string="true">第二，你能够学会</span></span></span><span data-slate-object="text" data-key="776"><span data-slate-leaf="true" data-offset-key="776:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">逐步根据真实的业务需求进行系统迭代的思路</span></span></span></span><span data-slate-object="text" data-key="777"><span data-slate-leaf="true" data-offset-key="777:0" data-first-offset="true"><span data-slate-string="true">，希望你也能在未来其他系统的开发过程中借鉴这一思路。我们并不是凭空产生了 TCompactProtocol 这样一个协议，而是通过分析 CSV、JSON、Java 序列化等方式的优缺点，思考如何尽可能向前向后兼容，并且如何尽可能节约空间，逐步迭代到了 TCompactProtocol 这样一个序列化协议。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="778"><span data-slate-object="text" data-key="779"><span data-slate-leaf="true" data-offset-key="779:0" data-first-offset="true"><span data-slate-string="true">第三，你能够学会在系统设计中，</span></span></span><span data-slate-object="text" data-key="780"><span data-slate-leaf="true" data-offset-key="780:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">尽量让各个模块具有 “正交性”，使得系统容易迭代优化</span></span></span></span><span data-slate-object="text" data-key="781"><span data-slate-leaf="true" data-offset-key="781:0" data-first-offset="true"><span data-slate-string="true">，不会遇到 “按下葫芦起来瓢” 的情况，导致系统难以进化。为了支持不同的语言、序列化方式（编码协议）、数据传输方式（网络协议），Thrift 通过良好的面向对象设计和分层，给我们做了一个很好的示范。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="782" id="sr-toc-9"><span data-slate-object="text" data-key="783"><span data-slate-leaf="true" data-offset-key="783:0" data-first-offset="true"><span data-slate-string="true">推荐阅读</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="784"><span data-slate-object="text" data-key="785"><span data-slate-leaf="true" data-offset-key="785:0" data-first-offset="true"><span data-slate-string="true">如果在学习这节课的过程中，你觉得自己缺乏对于数据编码问题的基本了解，你可以去读一读我之前的专栏《深入浅出计算机组成原理》的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="786" one-link-mark="yes"><span data-slate-object="text" data-key="787"><span data-slate-leaf="true" data-offset-key="787:0" data-first-offset="true"><span data-slate-string="true">第 11 讲</span></span></span></a><span data-slate-object="text" data-key="788"><span data-slate-leaf="true" data-offset-key="788:0" data-first-offset="true"><span data-slate-string="true">，对数据编码问题建立一个基本的认识。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="789"><span data-slate-object="text" data-key="790"><span data-slate-leaf="true" data-offset-key="790:0" data-first-offset="true"><span data-slate-string="true">如果你对数据序列化这个问题非常有兴趣，你可以进一步去研究 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="791" one-link-mark="yes"><span data-slate-object="text" data-key="792"><span data-slate-leaf="true" data-offset-key="792:0" data-first-offset="true"><span data-slate-string="true">Apache Avro</span></span></span></a><span data-slate-object="text" data-key="793"><span data-slate-leaf="true" data-offset-key="793:0" data-first-offset="true"><span data-slate-string="true">，相比于 Thrift 和 Protobuf，Avro 无需预先进行代码生成，并且也不需要指定数据的编号。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="794" id="sr-toc-10"><span data-slate-object="text" data-key="795"><span data-slate-leaf="true" data-offset-key="795:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="796"><span data-slate-object="text" data-key="797"><span data-slate-leaf="true" data-offset-key="797:0" data-first-offset="true"><span data-slate-string="true">最后，给你留一道思考题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="798"><span data-slate-object="text" data-key="799"><span data-slate-leaf="true" data-offset-key="799:0" data-first-offset="true"><span data-slate-string="true">在使用 Thrift 的情况下，其实数据序列化，是依赖于数据文件之外的一个外部 IDL 文件的。那么，我们是否可以把这个 IDL 直接序列化，然后放到存储实际数据的 Header 里呢？这样是不是我们的序列化程序，就可以像操作系统读取引导扇区一样，直接从存储数据的文件里面读到我们应该怎么序列化数据呢？如果这么做的话，我们会遇到那些困难呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="800"><span data-slate-object="text" data-key="801"><span data-slate-leaf="true" data-offset-key="801:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区，留下你的思考和答案，我们共同探讨。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);" one-link-mark="yes">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div><div data-v-70874338=""><div data-v-70874338=""><div data-v-70874338=""><div data-v-70874338=""><div data-v-70874338="">01 | 什么是大数据：从 GFS 到 Dataflow，12 年大数据生态演化图</div></div><div data-v-70874338=""><div data-v-70874338="">02 | 学习方法：建立你的大数据知识网络</div></div><div data-v-70874338=""><div data-v-70874338="">09 | Bigtable（二）：不认识 “主人” 的分布式架构</div></div></div><div data-v-70874338=""><div data-v-70874338=""><div data-v-70874338="">13 | 分布式锁 Chubby（二） ：众口铄金的真相</div></div><div data-v-70874338=""><div data-v-70874338="">20 | Megastore（二）：把 Bigtable 玩出花来</div></div><div data-v-70874338=""><div data-v-70874338="">加餐 3 | 我该使用什么样的大数据系统？</div></div></div></div></div><div data-v-21c32101=""><div data-v-21c32101=""><span data-v-21c32101="">该试读文章来自《大数据经典论文解读》，如需阅读全部文章，<br>请购买文章所属专栏</span></div><div data-v-21c32101="">立即购买</div></div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-11">精选留言 (12)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/00/4e/be2b206b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>吴小智</span></div></div><div>对于思考题，能想到两个问题：1. 每次需要传输到数据多了，对于 RPC 不是长链接交互的场景，每次都需要带上 Header，就跟 HTTP 一样每次都传输了重复的数据；2. 那就是需要每次都要解析 Header ，然后在对数据进行序列化，多做了运算，Thrift 生成代码的方式，就是把解析 Header 的这个计算，直接变成代码了，直接就可以对数据进行序列化，会快一点。</div><div><div>2021-10-13</div><div><div><i></i><span></span></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/66/8f/02be926d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 在路上</span></div></div><div>2007 年发表的 Thrift 论文，提到自己的优点在于提供了一套语言中立的软件栈，以很低的性能代价获得了很高的开发效率和系统可靠性。核心组件包括 Types、Transport、Protocol、Versioning 和 Processors，Types 是指跨语言的类型系统，开发者不用定义任何类型的序列化代码，Transport 是指开发者可以灵活定义数据的来源和目的地，可能是网络，可能是内存的片段，也可能是文件，Protocol 是指数据的序列化和反序列化过程，开发者通常不用关心，如果有需要也可以定制，Versioning 是指协议支持版本，使得客户端可以向前向后兼容，Processors 指的是数据的处理器，具体的逻辑由开发者实现。这种灵活的软件栈的代价是，The performance tradeoff incurred by an abstracted I/O layer (roughly one virtual method lookup /function call per operation) was immaterial compared to the cost of actual I/O operations (typically invoking system calls)，也就是没什么代价。</div><div><div>2021-10-14</div><div><div><i></i><span></span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/66/8f/02be926d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 在路上</span></div></div><div>徐老师好，TCompactProtocol 处理 Delta Encoding 的方式非常巧妙，通过判断 Field 第一个字节的高 4 位是否为 0，得知到底是用了一个还是多个字节存储 fieldId 和 fieldType。
readFieldBegin () 的部分源码：
```
//mask off the 4 MSB of the type header. it could contain a field id delta.
short modifier = (short)((type &amp; 0xf0) &gt;&gt; 4);
if (modifier == 0) {
  //not a delta. look ahead for the zigzag varint field id.
  fieldId = readI16 ();
} else {
  //has a delta. add the delta to the last read field id.
  fieldId = (short)(lastFieldId_ + modifier);
}
```
writeFieldBeginInternal () 的部分源码：
```
//check if we can use delta encoding for the field id
if (field.id &gt; lastFieldId_ &amp;&amp; field.id - lastFieldId_ &lt;= 15) {
  //write them together
  writeByteDirect ((field.id - lastFieldId_) &lt;&lt; 4 | typeToWrite);
} else {
  //write them separate
  writeByteDirect (typeToWrite);
  writeI16 (field.id);
}
```


直接把 IDL 写入协议的 Header，协议的接收者可以根据 Header 的信息得知如何解析协议，但是如果每次传输的数据量不大，额外传输的 IDL 就会成为严重的网络负担。Apache Avro 很好的解决了这个问题，在 Apache Avro Specification 的 Protocol Declaration/Protocol Wire Format/Schema Resolution/Parsing Canonical Form for Schemas 四个章节中详细地描述了整个过程。

谁负责写数据，就以谁的 IDL 为准。当客户端第一次发起一种请求时，会先发送一条消息（HandshakeRequest），告知服务端接下来的请求的 IDL，服务端会响应消息（HandshakeResponse），告知服务端针对这个请求响应的 IDL。之后再发起相同类型的请求时，只需要发送 IDL 的指纹，指纹对的上，接收方就使用缓存的 IDL，如果对不上，接收方会要求发送方重发 Handshake。哪些内容构成了一个 IDL 的指纹呢？并非整个文本，因为在文本中增加一个空格，调整字段的书写顺序，并不影响数据的序列化和反序列化，只有真正影响序列化和反序列化的内容，才会被当作计算指纹的一部分。</div><div><div>2021-10-13</div><div><div><i></i><span></span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/7c/10/165cb374.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Scott</span></div></div><div>其实这题我们还真做过，主要的问题是 thrift 是需要预先编译的，但是也不是没有法子，我就提个当时解决问题的关键字，janino。</div><div><div>2021-10-14</div><div><div><i></i><span></span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1e/4f/40/6cfa75cb.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 哈达 syn$</span></div></div><div>老师会讲 lsm 相关的论文吗</div><div><div>2021-10-13</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/c6/c0/dab2830e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 平然</span></div></div><div>TCompactProtocol 中为什么还要记录 field type，不是在 IDL 能查到么。</div><div><div>2022-05-05</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/f9/e6/47742988.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>webmin</span></div></div><div>思考题：IDL 直接序列化，然后放到存储实际数据的 Header 里呢？
这样做对于动态语言是友好的，动态语言可以根据 IDL 来实时生成数据结构，但是对于静态语言通常情况下都是事先通过 IDL 来生成不同语言的数据结构，居于这个前题那大可不必把 IDL 都传输，只需要传输 IDL 的版本号即可。
上面只是从编解码的角度讨论了 IDL 是否需要通过 Header 来保存，试想如果从数据逻辑处理角度看，在事前不知道会有什么样的数据的情况下，自然这些数据也不知道怎么处理，那么把这些解出来貌似就是一种浪费。
如果只是把数据持久化后，让后续程序来处理，那么从保存不同版本 IDL 的角度考虑，是有必要把 IDL 单独持久化，只是在设计上，可以调整为用版本号来对应 IDL（每个版本的 IDL 单独保存），而不需要在每块数据的 Head 上都保存一份 IDL 信息。</div><div><div>2021-10-16</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/2d/75/e7c29de4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>wkq2786130</span></div></div><div>很棒的文章，看完以后自己也总结了一下 放在 http://weikeqin.com/2022/06/26/thrift-protocol/</div><div><div>2022-07-27</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKJrOl63enWXCRxN0SoucliclBme0qrRb19ATrWIOIvibKIz8UAuVgicBMibIVUznerHnjotI4dm6ibODA/132"></div></div><div><div><div><span>Helios</span></div></div><div>放在 header 里面对于强类型需要来说还是需要定义一套 schema 的，感觉没啥意义而且还要浪费解析的性能，自己包体变大。</div><div><div>2021-12-30</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/9b/e1/aa0af424.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>可加</span></div></div><div>模块之间的正交性是怎么理解的？尽量解耦的意思吗？</div><div><div>2021-12-14</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/22/f4/9fd6f8f0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>核桃</span></div></div><div>ZigZag 编码的方式，把负数变成正数，然后乘以 2。这里怎么知道开头第一位的 1 到底是什么作用呢？就是是读取下一个字节还是负数？</div><div><div>2021-11-24</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/8f/60/be0a8805.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>陈迪</span></div></div><div>思考题：avro 就是这么做的？ 可以不用事先生成代码了，我觉得不适合比如微服务之间的 API 调用，IDL 还有文档的作用。 业务代码总归是要知道数据的严格结构的，不然业务代码咋往下写呢，那么还得有个文档</div><div><div>2021-10-15</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1"><outline class="toc-level-h1" data-reactid=".1.0" style="width: 175px;"><active data-reactid=".1.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1.0.1"><span data-reactid=".1.0.1.0"> 11 | 通过 Thrift 序列化：我们要预知未来才能向后兼容吗？</span></a></outline><outline class="toc-level-h2" data-reactid=".1.1" style="width: 165px;"><active data-reactid=".1.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1.1.1"><span data-reactid=".1.1.1.0">常用的 CSV 和 JSON 格式</span></a></outline><outline class="toc-level-h2" data-reactid=".1.2" style="width: 165px;"><active data-reactid=".1.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1.2.1"><span data-reactid=".1.2.1.0">优化存储空间为目标的二进制序列化</span></a></outline><outline class="toc-level-h2" data-reactid=".1.3" style="width: 165px;"><active data-reactid=".1.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1.3.1"><span data-reactid=".1.3.1.0">包含 IDL 并能向前和向后兼容的 Thrift 的 TBinaryProtocol</span></a></outline><outline class="toc-level-h2" data-reactid=".1.4" style="width: 165px;"><active data-reactid=".1.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1.4.1"><span data-reactid=".1.4.1.0">进一步优化的 TCompactProtocol</span></a></outline><outline class="toc-level-h3" data-reactid=".1.5" style="width: 155px;"><active data-reactid=".1.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1.5.1"><span data-reactid=".1.5.1.0">Delta Encoding</span></a></outline><outline class="toc-level-h3" data-reactid=".1.6" style="width: 155px;"><active data-reactid=".1.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1.6.1"><span data-reactid=".1.6.1.0">ZigZag 编码 +VQL 可变长数值表示</span></a></outline><outline class="toc-level-h2" data-reactid=".1.7" style="width: 165px;"><active data-reactid=".1.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1.7.1"><span data-reactid=".1.7.1.0">跨语言、跨协议和可扩展性</span></a></outline><outline class="toc-level-h2" data-reactid=".1.8" style="width: 165px;"><active data-reactid=".1.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1.8.1"><span data-reactid=".1.8.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".1.9" style="width: 165px;"><active data-reactid=".1.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1.9.1"><span data-reactid=".1.9.1.0">推荐阅读</span></a></outline><outline class="toc-level-h2" data-reactid=".1.a" style="width: 165px;"><active data-reactid=".1.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1.a.1"><span data-reactid=".1.a.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1.b" style="width: 165px;"><active data-reactid=".1.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1.b.1"><span data-reactid=".1.b.1.0">精选留言 (12)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/425863" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>