
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 24 | 活动的描述：到底什么是进程？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>24 | 活动的描述：到底什么是进程？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我会带你实现分配和释放内存页面，达到内存管理的目的。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">24 | 活动的描述：到底什么是进程？</h1><div><span>LMOS</span> <span>2021-07-02</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/34/8b/34c3f8d43256186f955cd78ca6196e8b.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：16.72M</span><span> 时长：18:18</span></div></div><audio title="24 | 活动的描述：到底什么是进程？" src="https://res001.geekbang.org/media/audio/ee/cb/ee23a886df8f8bd5253c87ccd3f1cecb/ld/ld.m3u8" __idm_id__="950279"></audio></div><div><div><div><div data-slate-editor="true" data-key="11232" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="11233"><span data-slate-object="text" data-key="11234"><span data-slate-leaf="true" data-offset-key="11234:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11235"><span data-slate-object="text" data-key="11236"><span data-slate-leaf="true" data-offset-key="11236:0" data-first-offset="true"><span data-slate-string="true">在前面的课程里，我们已经实现了数据同步、hal 层的初始化，中断框架、物理内存、内存对象、虚拟内存管理，这些都是操作系统中最核心的东西。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11237"><span data-slate-object="text" data-key="11238"><span data-slate-leaf="true" data-offset-key="11238:0" data-first-offset="true"><span data-slate-string="true">今天，我再给你讲讲操作系统里一个层次非常高的组件 —— 进程，而它又非常依赖于内存管理、中断、硬件体系结构。好在前面课程中，这些基础知识我们已经搞得清清楚楚，安排得明明白白了，所以我们今天理解进程就变得顺理成章。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11239" id="sr-toc-1"><span data-slate-object="text" data-key="11240"><span data-slate-leaf="true" data-offset-key="11240:0" data-first-offset="true"><span data-slate-string="true">感受一下</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11241"><span data-slate-object="text" data-key="11242"><span data-slate-leaf="true" data-offset-key="11242:0" data-first-offset="true"><span data-slate-string="true">在你看来，什么是进程呢？日常我们跟计算机打交道的时候，最常接触的就是一些应用程序，比如 Word、浏览器，你可以直观感受到它们的存在。而我们却很难直观感受到什么是进程，自然也就不容易描述它的模样与形态了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11243"><span data-slate-object="text" data-key="11244"><span data-slate-leaf="true" data-offset-key="11244:0" data-first-offset="true"><span data-slate-string="true">其实，在我们启用 Word 这些应用时，操作系统在背后就会建立至少一个进程。虽然我们难以观察它的形态，但我们绝对可以通过一些状态数据来发现进程的存在。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11245"><span data-slate-object="text" data-key="11246"><span data-slate-leaf="true" data-offset-key="11246:0" data-first-offset="true"><span data-slate-string="true">在 Linux 的终端下输入 ps 命令， 我们就可以看到系统中有多少个进程了。如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="11247"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/bb/99/bb69be65d794c9105d57f3f0b7583499.jpg?wh=1070x611%22%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E4%B8%AA%E6%95%B0%22"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11248"><span data-slate-object="text" data-key="11249"><span data-slate-leaf="true" data-offset-key="11249:0" data-first-offset="true"><span data-slate-string="true">这是进程吗？是的，不过这只是一些具体进程的数据，如创建进程和用户、进程 ID、使用 CPU 的百分比，进程运行状态，进程的建立时间、进程的运行时间、进程名等，这些数据综合起来就代表了一个进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11250"><span data-slate-object="text" data-key="11251"><span data-slate-leaf="true" data-offset-key="11251:0" data-first-offset="true"><span data-slate-string="true">也许看到这，你会呵呵一笑，觉得原来抽象的进程背后，不过是一堆数据而已，关于进程这就是我们能直观感受到的东西，这就完了吗？当然没有，我们接着往下看。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11252" id="sr-toc-2"><span data-slate-object="text" data-key="11253"><span data-slate-leaf="true" data-offset-key="11253:0" data-first-offset="true"><span data-slate-string="true">什么是进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11254"><span data-slate-object="text" data-key="11255"><span data-slate-leaf="true" data-offset-key="11255:0" data-first-offset="true"><span data-slate-string="true">如果你要组织一个活动怎么办？你首先会想到，这个活动的流程是什么，需要配备哪些人员和物资，中途要不要休息，活动当前进行到哪里了…… 如果你是个精明的人，你大概会用</span></span></span><span data-slate-object="text" data-key="11256"><span data-slate-leaf="true" data-offset-key="11256:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">表格</span></span></span></span><span data-slate-object="text" data-key="11257"><span data-slate-leaf="true" data-offset-key="11257:0" data-first-offset="true"><span data-slate-string="true">把这些信息记录下来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11258"><span data-slate-object="text" data-key="11259"><span data-slate-leaf="true" data-offset-key="11259:0" data-first-offset="true"><span data-slate-string="true">同理，你运行一个应用程序时，操作系统也要记录这个应用程序使用多少内存，打开了什么文件，当有些资源不可用的时候要不要睡眠，当前进程运行到哪里了。操作系统把这些信息综合统计，存放在内存中，抽象为进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11260"><span data-slate-object="text" data-key="11261"><span data-slate-leaf="true" data-offset-key="11261:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d512a6a5" data-attr-id="38707" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">现在你就可以回答什么是进程了：进程是一个应用程序运行时刻的实例（从进程的结构看）；进程是应用程序运行时所需资源的容器（从进程的功能看）；甚至进程是一堆数据结构（从操作系统对进程实现的角度来说）。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11262"><span data-slate-object="text" data-key="11263"><span data-slate-leaf="true" data-offset-key="11263:0" data-first-offset="true"><span data-slate-string="true">这也太简单了吧？对，进程的抽象概念就是这么简单。我知道这一定不能让你真正明白什么是进程，抽象的概念就是如此，你不在实践中设计并实现它，是很难真正明白的。下面我们先来细化设计。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11264" id="sr-toc-3"><span data-slate-object="text" data-key="11265"><span data-slate-leaf="true" data-offset-key="11265:0" data-first-offset="true"><span data-slate-string="true">进程的结构</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11266"><span data-slate-object="text" data-key="11267"><span data-slate-leaf="true" data-offset-key="11267:0" data-first-offset="true"><span data-slate-string="true">首先，进程是一个应用程序运行时刻的实例，它的目的就是操作系统用于管理和运行多个应用程序的；其次，从前面我们实现的内存管理组件角度看，操作系统是给应用程序提供服务的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11268"><span data-slate-object="text" data-key="11269"><span data-slate-leaf="true" data-offset-key="11269:0" data-first-offset="true"><span data-slate-string="true">所以，从这两个角度看，进程必须要有一个地址空间，这个地址空间至少包括两部分内容：一部分是内核，一部分是用户的应用程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11270"><span data-slate-object="text" data-key="11271"><span data-slate-leaf="true" data-offset-key="11271:0" data-first-offset="true"><span data-slate-string="true">最后，结合 x86 硬件平台对虚拟地址空间的制约，我给你画了一幅图，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="11272"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/72/b3/725580e605b20be40ac3e0b24d82d0b3.jpg?wh=3455x1955"></div><div>进程结构示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11273"><span data-slate-object="text" data-key="11274"><span data-slate-leaf="true" data-offset-key="11274:0" data-first-offset="true"><span data-slate-string="true">上图中有 8 个进程，每个进程拥有 x86 CPU 的整个虚拟地址空间，这个虚拟地址空间被分成了两个部分，上半部分是所有进程都共享的内核部分 ，里面放着一份内核代码和数据，下半部分是应用程序，分别独立，互不干扰。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11275"><span data-slate-object="text" data-key="11276"><span data-slate-leaf="true" data-offset-key="11276:0" data-first-offset="true"><span data-slate-string="true">还记得我们讲过的 x86 CPU 的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11277"><span data-slate-object="text" data-key="11278"><span data-slate-leaf="true" data-offset-key="11278:0" data-first-offset="true"><span data-slate-string="true">特权级</span></span></span></a><span data-slate-object="text" data-key="11279"><span data-slate-leaf="true" data-offset-key="11279:0" data-first-offset="true"><span data-slate-string="true">吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11280"><span data-slate-object="text" data-key="11281"><span data-slate-leaf="true" data-offset-key="11281:0" data-first-offset="true"><span data-slate-string="true">当 CPU 在 R0 特权级运行时，就运行在上半部分内核的地址空间中，当 CPU 在 R3 特权级时，就运行在下半部分的应用程序地址空间中。各进程的虚拟地址空间是相同的，它们之间物理地址不同，是由 MMU 页表进行隔离的，所以每个进程的应用程序的代码绝对不能随意访问内核的代码和数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11282"><span data-slate-object="text" data-key="11283"><span data-slate-leaf="true" data-offset-key="11283:0" data-first-offset="true"><span data-slate-string="true">以上是整体结构，下面我们来细化一下进程需要实现哪些功能？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11284"><span data-slate-object="text" data-key="11285"><span data-slate-leaf="true" data-offset-key="11285:0" data-first-offset="true"><span data-slate-string="true">我们先从</span></span></span><span data-slate-object="text" data-key="11286"><span data-slate-leaf="true" data-offset-key="11286:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">应用程序和内核的关系</span></span></span></span><span data-slate-object="text" data-key="11287"><span data-slate-leaf="true" data-offset-key="11287:0" data-first-offset="true"><span data-slate-string="true">看。应用程序需要内核提供资源，而内核需要控制应用程序的运行。那么内核必须能够命令应用程序，让它</span></span></span><span data-slate-object="text" data-key="11288"><span data-slate-leaf="true" data-offset-key="11288:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">随时中断（进入内核地址空间）或恢复执行</span></span></span></span><span data-slate-object="text" data-key="11289"><span data-slate-leaf="true" data-offset-key="11289:0" data-first-offset="true"><span data-slate-string="true">，这就需要保存应用程序的机器上下文和它运行时刻的栈。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11290"><span data-slate-object="text" data-key="11291"><span data-slate-leaf="true" data-offset-key="11291:0" data-first-offset="true"><span data-slate-string="true">接着，我们深入</span></span></span><span data-slate-object="text" data-key="11292"><span data-slate-leaf="true" data-offset-key="11292:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">内核提供服务的机制</span></span></span></span><span data-slate-object="text" data-key="11293"><span data-slate-leaf="true" data-offset-key="11293:0" data-first-offset="true"><span data-slate-string="true">。众所周知，内核是这样提供服务的：通过停止应用程序代码运行，进入内核地址空间运行内核代码，然后返回结果。就像活动组织者会用表格备案一样，内核还需要记录一个应用程序都访问了哪些资源，比如打开了某个文件，或是访问了某个设备。而这样的 “记录表”，我们就用 “</span></span></span><span data-slate-object="text" data-key="11294"><span data-slate-leaf="true" data-offset-key="11294:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">资源描述符</span></span></span></span><span data-slate-object="text" data-key="11295"><span data-slate-leaf="true" data-offset-key="11295:0" data-first-offset="true"><span data-slate-string="true">” 来表示。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11296"><span data-slate-object="text" data-key="11297"><span data-slate-leaf="true" data-offset-key="11297:0" data-first-offset="true"><span data-slate-string="true">而我们前面已经说了，进程是一个应用程序运行时刻的实例。那这样一来，一个细化的进程结构，就可以像下图这样设计。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="11298"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/65/68/6577df8ebc8323fa9f34835371a4b268.jpg?wh=3360x2805"></div><div>进程结构细化示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11299"><span data-slate-object="text" data-key="11300"><span data-slate-leaf="true" data-offset-key="11300:0" data-first-offset="true"><span data-slate-string="true">上图中表示了一个进程详细且必要的结构，其中带 * 号是每个进程都有独立一份，有了这样的设计结构，多个进程就能并发运行了。前面这些内容还是纸上谈兵，你重点搞明白进程的概念和结构就行了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11301" id="sr-toc-4"><span data-slate-object="text" data-key="11302"><span data-slate-leaf="true" data-offset-key="11302:0" data-first-offset="true"><span data-slate-string="true">实现进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11303"><span data-slate-object="text" data-key="11304"><span data-slate-leaf="true" data-offset-key="11304:0" data-first-offset="true"><span data-slate-string="true">前面我们简单介绍了进程的概念和结构，之所以简单，是为了不在理论层面就把问题复杂化，这对我们实现 Cosmos 的进程组件没有任何好处。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11305"><span data-slate-object="text" data-key="11306"><span data-slate-leaf="true" data-offset-key="11306:0" data-first-offset="true"><span data-slate-string="true">但只懂理论还是空中阁楼，我们可以一步步在设计实现中，由浅到深地理解什么是进程。我们这就把前面的概念和设计，一步步落实到代码，设计出对应的数据结构。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11307" id="sr-toc-5"><span data-slate-object="text" data-key="11308"><span data-slate-leaf="true" data-offset-key="11308:0" data-first-offset="true"><span data-slate-string="true">如何表示一个进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11309"><span data-slate-object="text" data-key="11310"><span data-slate-leaf="true" data-offset-key="11310:0" data-first-offset="true"><span data-slate-string="true">根据前面课程的经验，如果要在软件代码中表示一个什么东西时，就要设计出对应的数据结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11311"><span data-slate-object="text" data-key="11312"><span data-slate-leaf="true" data-offset-key="11312:0" data-first-offset="true"><span data-slate-string="true">那么对于一个进程，它有状态，id，运行时间，优先级，应用程序栈，内核栈，机器上下文，资源描述符，地址空间，我们将这些信息组织在一起，就形成了一个进程的数据结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11313"><span data-slate-object="text" data-key="11314"><span data-slate-leaf="true" data-offset-key="11314:0" data-first-offset="true"><span data-slate-string="true">下面我带你把它变成代码，在 cosmos/include/knlinc/ 目录下建立一个 krlthread_t.h 文件，在其中写上代码，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11315"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11316"><span data-slate-object="text" data-key="11317"><span data-slate-leaf="true" data-offset-key="11317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11318"><span data-slate-leaf="true" data-offset-key="11318:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11319"><span data-slate-leaf="true" data-offset-key="11319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11320"><span data-slate-leaf="true" data-offset-key="11320:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11321"><span data-slate-leaf="true" data-offset-key="11321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_THREAD</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11322"><span data-slate-object="text" data-key="11323"><span data-slate-leaf="true" data-offset-key="11323:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11324"><span data-slate-object="text" data-key="11325"><span data-slate-leaf="true" data-offset-key="11325:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11326"><span data-slate-leaf="true" data-offset-key="11326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="11327"><span data-slate-leaf="true" data-offset-key="11327:0" data-first-offset="true"><span data-slate-string="true">  td_lock;           </span></span></span><span data-slate-object="text" data-key="11328"><span data-slate-leaf="true" data-offset-key="11328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11329"><span data-slate-object="text" data-key="11330"><span data-slate-leaf="true" data-offset-key="11330:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11331"><span data-slate-leaf="true" data-offset-key="11331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11332"><span data-slate-leaf="true" data-offset-key="11332:0" data-first-offset="true"><span data-slate-string="true">    td_list;           </span></span></span><span data-slate-object="text" data-key="11333"><span data-slate-leaf="true" data-offset-key="11333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程链表 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11334"><span data-slate-object="text" data-key="11335"><span data-slate-leaf="true" data-offset-key="11335:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11336"><span data-slate-leaf="true" data-offset-key="11336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11337"><span data-slate-leaf="true" data-offset-key="11337:0" data-first-offset="true"><span data-slate-string="true">      td_flgs;           </span></span></span><span data-slate-object="text" data-key="11338"><span data-slate-leaf="true" data-offset-key="11338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11339"><span data-slate-object="text" data-key="11340"><span data-slate-leaf="true" data-offset-key="11340:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11341"><span data-slate-leaf="true" data-offset-key="11341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11342"><span data-slate-leaf="true" data-offset-key="11342:0" data-first-offset="true"><span data-slate-string="true">      td_stus;           </span></span></span><span data-slate-object="text" data-key="11343"><span data-slate-leaf="true" data-offset-key="11343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11344"><span data-slate-object="text" data-key="11345"><span data-slate-leaf="true" data-offset-key="11345:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11346"><span data-slate-leaf="true" data-offset-key="11346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11347"><span data-slate-leaf="true" data-offset-key="11347:0" data-first-offset="true"><span data-slate-string="true">      td_cpuid;          </span></span></span><span data-slate-object="text" data-key="11348"><span data-slate-leaf="true" data-offset-key="11348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程所在的 CPU 的 id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11349"><span data-slate-object="text" data-key="11350"><span data-slate-leaf="true" data-offset-key="11350:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11351"><span data-slate-leaf="true" data-offset-key="11351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11352"><span data-slate-leaf="true" data-offset-key="11352:0" data-first-offset="true"><span data-slate-string="true">      td_id;             </span></span></span><span data-slate-object="text" data-key="11353"><span data-slate-leaf="true" data-offset-key="11353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的 id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11354"><span data-slate-object="text" data-key="11355"><span data-slate-leaf="true" data-offset-key="11355:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11356"><span data-slate-leaf="true" data-offset-key="11356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11357"><span data-slate-leaf="true" data-offset-key="11357:0" data-first-offset="true"><span data-slate-string="true">      td_tick;           </span></span></span><span data-slate-object="text" data-key="11358"><span data-slate-leaf="true" data-offset-key="11358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程运行了多少 tick</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11359"><span data-slate-object="text" data-key="11360"><span data-slate-leaf="true" data-offset-key="11360:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11361"><span data-slate-leaf="true" data-offset-key="11361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11362"><span data-slate-leaf="true" data-offset-key="11362:0" data-first-offset="true"><span data-slate-string="true">      td_privilege;      </span></span></span><span data-slate-object="text" data-key="11363"><span data-slate-leaf="true" data-offset-key="11363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的权限</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11364"><span data-slate-object="text" data-key="11365"><span data-slate-leaf="true" data-offset-key="11365:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11366"><span data-slate-leaf="true" data-offset-key="11366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11367"><span data-slate-leaf="true" data-offset-key="11367:0" data-first-offset="true"><span data-slate-string="true">      td_priority;       </span></span></span><span data-slate-object="text" data-key="11368"><span data-slate-leaf="true" data-offset-key="11368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11369"><span data-slate-object="text" data-key="11370"><span data-slate-leaf="true" data-offset-key="11370:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11371"><span data-slate-leaf="true" data-offset-key="11371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11372"><span data-slate-leaf="true" data-offset-key="11372:0" data-first-offset="true"><span data-slate-string="true">      td_runmode;        </span></span></span><span data-slate-object="text" data-key="11373"><span data-slate-leaf="true" data-offset-key="11373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程的运行模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11374"><span data-slate-object="text" data-key="11375"><span data-slate-leaf="true" data-offset-key="11375:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11376"><span data-slate-leaf="true" data-offset-key="11376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11377"><span data-slate-leaf="true" data-offset-key="11377:0" data-first-offset="true"><span data-slate-string="true">       td_krlstktop;      </span></span></span><span data-slate-object="text" data-key="11378"><span data-slate-leaf="true" data-offset-key="11378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用程序内核栈顶地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11379"><span data-slate-object="text" data-key="11380"><span data-slate-leaf="true" data-offset-key="11380:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11381"><span data-slate-leaf="true" data-offset-key="11381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11382"><span data-slate-leaf="true" data-offset-key="11382:0" data-first-offset="true"><span data-slate-string="true">       td_krlstkstart;    </span></span></span><span data-slate-object="text" data-key="11383"><span data-slate-leaf="true" data-offset-key="11383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用程序内核栈开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11384"><span data-slate-object="text" data-key="11385"><span data-slate-leaf="true" data-offset-key="11385:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11386"><span data-slate-leaf="true" data-offset-key="11386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11387"><span data-slate-leaf="true" data-offset-key="11387:0" data-first-offset="true"><span data-slate-string="true">       td_usrstktop;      </span></span></span><span data-slate-object="text" data-key="11388"><span data-slate-leaf="true" data-offset-key="11388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用程序栈顶地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11389"><span data-slate-object="text" data-key="11390"><span data-slate-leaf="true" data-offset-key="11390:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11391"><span data-slate-leaf="true" data-offset-key="11391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11392"><span data-slate-leaf="true" data-offset-key="11392:0" data-first-offset="true"><span data-slate-string="true">       td_usrstkstart;    </span></span></span><span data-slate-object="text" data-key="11393"><span data-slate-leaf="true" data-offset-key="11393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用程序栈开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11394"><span data-slate-object="text" data-key="11395"><span data-slate-leaf="true" data-offset-key="11395:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11396"><span data-slate-leaf="true" data-offset-key="11396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mmadrsdsc_t</span></span></span></span><span data-slate-object="text" data-key="11397"><span data-slate-leaf="true" data-offset-key="11397:0" data-first-offset="true"><span data-slate-string="true">* td_mmdsc;         </span></span></span><span data-slate-object="text" data-key="11398"><span data-slate-leaf="true" data-offset-key="11398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 地址空间结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11399"><span data-slate-object="text" data-key="11400"><span data-slate-leaf="true" data-offset-key="11400:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11401"><span data-slate-leaf="true" data-offset-key="11401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context_t</span></span></span></span><span data-slate-object="text" data-key="11402"><span data-slate-leaf="true" data-offset-key="11402:0" data-first-offset="true"><span data-slate-string="true">   td_context;        </span></span></span><span data-slate-object="text" data-key="11403"><span data-slate-leaf="true" data-offset-key="11403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 机器上下文件结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11404"><span data-slate-object="text" data-key="11405"><span data-slate-leaf="true" data-offset-key="11405:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11406"><span data-slate-leaf="true" data-offset-key="11406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span><span data-slate-object="text" data-key="11407"><span data-slate-leaf="true" data-offset-key="11407:0" data-first-offset="true"><span data-slate-string="true">*  td_handtbl[TD_HAND_MAX];</span></span></span><span data-slate-object="text" data-key="11408"><span data-slate-leaf="true" data-offset-key="11408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打开的对象数组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11409"><span data-slate-object="text" data-key="11410"><span data-slate-leaf="true" data-offset-key="11410:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="11411"><span data-slate-leaf="true" data-offset-key="11411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="11412"><span data-slate-leaf="true" data-offset-key="11412:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11413"><span data-slate-object="text" data-key="11414"><span data-slate-leaf="true" data-offset-key="11414:0" data-first-offset="true"><span data-slate-string="true">在 Cosmos 中，我们就使用 thread_t 结构的一个实例变量代表一个进程。进程的内核栈和进程的应用程序栈是两块内存空间，进程的权限表示一个进程是用户进程还是系统进程。进程的权限不同，它们能完成功能也不同。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11415"><span data-slate-object="text" data-key="11416"><span data-slate-leaf="true" data-offset-key="11416:0" data-first-offset="true"><span data-slate-string="true">万事都有轻重缓急，进程也一样，进程有 64 个优先级，td_priority 数值越小优先级越高。td_handtbl 只是一个 objnode_t 结构的指针类型数组。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11417"><span data-slate-object="text" data-key="11418"><span data-slate-leaf="true" data-offset-key="11418:0" data-first-offset="true"><span data-slate-string="true">比方说，一个进程打开一个文件内核就会创建一个对应的 objnode_t 结构的实例变量，这个 objnode_t 结构的地址就保存在 td_handtbl 数组中。你可以这么理解：这个 objnode_t 结构就是进程打开资源的描述符。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11419" id="sr-toc-6"><span data-slate-object="text" data-key="11420"><span data-slate-leaf="true" data-offset-key="11420:0" data-first-offset="true"><span data-slate-string="true">进程的地址空间</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11421"><span data-slate-object="text" data-key="11422"><span data-slate-leaf="true" data-offset-key="11422:0" data-first-offset="true"><span data-slate-string="true">在 thread_t 结构中有个 mmadrsdsc_t 结构的指针，在这个结构中有虚拟地址区间结构和 MMU 相关的信息。mmadrsdsc_t 结构你应该很熟悉，在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11423"><span data-slate-object="text" data-key="11424"><span data-slate-leaf="true" data-offset-key="11424:0" data-first-offset="true"><span data-slate-string="true">虚拟内存</span></span></span></a><span data-slate-object="text" data-key="11425"><span data-slate-leaf="true" data-offset-key="11425:0" data-first-offset="true"><span data-slate-string="true">那节课中，我们学习过，今天我们再次复习一下，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11426"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11427"><span data-slate-object="text" data-key="11428"><span data-slate-leaf="true" data-offset-key="11428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11429"><span data-slate-leaf="true" data-offset-key="11429:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11430"><span data-slate-leaf="true" data-offset-key="11430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11431"><span data-slate-leaf="true" data-offset-key="11431:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11432"><span data-slate-leaf="true" data-offset-key="11432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_MMADRSDSC</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11433"><span data-slate-object="text" data-key="11434"><span data-slate-leaf="true" data-offset-key="11434:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11435"><span data-slate-object="text" data-key="11436"><span data-slate-leaf="true" data-offset-key="11436:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11437"><span data-slate-leaf="true" data-offset-key="11437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="11438"><span data-slate-leaf="true" data-offset-key="11438:0" data-first-offset="true"><span data-slate-string="true"> msd_lock;               </span></span></span><span data-slate-object="text" data-key="11439"><span data-slate-leaf="true" data-offset-key="11439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保护自身的自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11440"><span data-slate-object="text" data-key="11441"><span data-slate-leaf="true" data-offset-key="11441:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11442"><span data-slate-leaf="true" data-offset-key="11442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11443"><span data-slate-leaf="true" data-offset-key="11443:0" data-first-offset="true"><span data-slate-string="true"> msd_list;                 </span></span></span><span data-slate-object="text" data-key="11444"><span data-slate-leaf="true" data-offset-key="11444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11445"><span data-slate-object="text" data-key="11446"><span data-slate-leaf="true" data-offset-key="11446:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11447"><span data-slate-leaf="true" data-offset-key="11447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11448"><span data-slate-leaf="true" data-offset-key="11448:0" data-first-offset="true"><span data-slate-string="true"> msd_flag;                   </span></span></span><span data-slate-object="text" data-key="11449"><span data-slate-leaf="true" data-offset-key="11449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 状态和标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11450"><span data-slate-object="text" data-key="11451"><span data-slate-leaf="true" data-offset-key="11451:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11452"><span data-slate-leaf="true" data-offset-key="11452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11453"><span data-slate-leaf="true" data-offset-key="11453:0" data-first-offset="true"><span data-slate-string="true"> msd_stus;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11454"><span data-slate-object="text" data-key="11455"><span data-slate-leaf="true" data-offset-key="11455:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11456"><span data-slate-leaf="true" data-offset-key="11456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11457"><span data-slate-leaf="true" data-offset-key="11457:0" data-first-offset="true"><span data-slate-string="true"> msd_scount;                 </span></span></span><span data-slate-object="text" data-key="11458"><span data-slate-leaf="true" data-offset-key="11458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 计数，该结构可能被共享</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11459"><span data-slate-object="text" data-key="11460"><span data-slate-leaf="true" data-offset-key="11460:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11461"><span data-slate-leaf="true" data-offset-key="11461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sem_t</span></span></span></span><span data-slate-object="text" data-key="11462"><span data-slate-leaf="true" data-offset-key="11462:0" data-first-offset="true"><span data-slate-string="true">  msd_sem;                    </span></span></span><span data-slate-object="text" data-key="11463"><span data-slate-leaf="true" data-offset-key="11463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11464"><span data-slate-object="text" data-key="11465"><span data-slate-leaf="true" data-offset-key="11465:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11466"><span data-slate-leaf="true" data-offset-key="11466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mmudsc_t</span></span></span></span><span data-slate-object="text" data-key="11467"><span data-slate-leaf="true" data-offset-key="11467:0" data-first-offset="true"><span data-slate-string="true"> msd_mmu;                  </span></span></span><span data-slate-object="text" data-key="11468"><span data-slate-leaf="true" data-offset-key="11468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//MMU 页表相关的信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11469"><span data-slate-object="text" data-key="11470"><span data-slate-leaf="true" data-offset-key="11470:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11471"><span data-slate-leaf="true" data-offset-key="11471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">virmemadrs_t</span></span></span></span><span data-slate-object="text" data-key="11472"><span data-slate-leaf="true" data-offset-key="11472:0" data-first-offset="true"><span data-slate-string="true"> msd_virmemadrs;       </span></span></span><span data-slate-object="text" data-key="11473"><span data-slate-leaf="true" data-offset-key="11473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 虚拟地址空间结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11474"><span data-slate-object="text" data-key="11475"><span data-slate-leaf="true" data-offset-key="11475:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11476"><span data-slate-leaf="true" data-offset-key="11476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11477"><span data-slate-leaf="true" data-offset-key="11477:0" data-first-offset="true"><span data-slate-string="true"> msd_stext;                   </span></span></span><span data-slate-object="text" data-key="11478"><span data-slate-leaf="true" data-offset-key="11478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用的指令区的开始、结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11479"><span data-slate-object="text" data-key="11480"><span data-slate-leaf="true" data-offset-key="11480:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11481"><span data-slate-leaf="true" data-offset-key="11481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11482"><span data-slate-leaf="true" data-offset-key="11482:0" data-first-offset="true"><span data-slate-string="true"> msd_etext;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11483"><span data-slate-object="text" data-key="11484"><span data-slate-leaf="true" data-offset-key="11484:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11485"><span data-slate-leaf="true" data-offset-key="11485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11486"><span data-slate-leaf="true" data-offset-key="11486:0" data-first-offset="true"><span data-slate-string="true"> msd_sdata;                   </span></span></span><span data-slate-object="text" data-key="11487"><span data-slate-leaf="true" data-offset-key="11487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用的数据区的开始、结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11488"><span data-slate-object="text" data-key="11489"><span data-slate-leaf="true" data-offset-key="11489:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11490"><span data-slate-leaf="true" data-offset-key="11490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11491"><span data-slate-leaf="true" data-offset-key="11491:0" data-first-offset="true"><span data-slate-string="true"> msd_edata;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11492"><span data-slate-object="text" data-key="11493"><span data-slate-leaf="true" data-offset-key="11493:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11494"><span data-slate-leaf="true" data-offset-key="11494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11495"><span data-slate-leaf="true" data-offset-key="11495:0" data-first-offset="true"><span data-slate-string="true"> msd_sbss;                    </span></span></span><span data-slate-object="text" data-key="11496"><span data-slate-leaf="true" data-offset-key="11496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用初始化为 0 的区域开始、结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11497"><span data-slate-object="text" data-key="11498"><span data-slate-leaf="true" data-offset-key="11498:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11499"><span data-slate-leaf="true" data-offset-key="11499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11500"><span data-slate-leaf="true" data-offset-key="11500:0" data-first-offset="true"><span data-slate-string="true"> msd_ebss;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11501"><span data-slate-object="text" data-key="11502"><span data-slate-leaf="true" data-offset-key="11502:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11503"><span data-slate-leaf="true" data-offset-key="11503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11504"><span data-slate-leaf="true" data-offset-key="11504:0" data-first-offset="true"><span data-slate-string="true"> msd_sbrk;                    </span></span></span><span data-slate-object="text" data-key="11505"><span data-slate-leaf="true" data-offset-key="11505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用的堆区的开始、结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11506"><span data-slate-object="text" data-key="11507"><span data-slate-leaf="true" data-offset-key="11507:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11508"><span data-slate-leaf="true" data-offset-key="11508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11509"><span data-slate-leaf="true" data-offset-key="11509:0" data-first-offset="true"><span data-slate-string="true"> msd_ebrk;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11510"><span data-slate-object="text" data-key="11511"><span data-slate-leaf="true" data-offset-key="11511:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="11512"><span data-slate-leaf="true" data-offset-key="11512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mmadrsdsc_t</span></span></span></span><span data-slate-object="text" data-key="11513"><span data-slate-leaf="true" data-offset-key="11513:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11514"><span data-slate-object="text" data-key="11515"><span data-slate-leaf="true" data-offset-key="11515:0" data-first-offset="true"><span data-slate-string="true">上述代码中，注释已经很清楚了，mmadrsdsc_t 结构描述了一个进程的完整的地址空间。需要搞清楚的是：在常规情况下，新建一个进程就要建立一个 mmadrsdsc_t 结构，让 thread_t 结构的 td_mmdsc 的指针变量指向它。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11516" id="sr-toc-7"><span data-slate-object="text" data-key="11517"><span data-slate-leaf="true" data-offset-key="11517:0" data-first-offset="true"><span data-slate-string="true">进程的机器上下文</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11518"><span data-slate-object="text" data-key="11519"><span data-slate-leaf="true" data-offset-key="11519:0" data-first-offset="true"><span data-slate-string="true">进程的机器上下文分为几个部分，一部分是 CPU 寄存器，一部分是内核函数调用路径。CPU 的通用寄存器，是中断发生进入内核时，压入内核栈中的，从中断入口处开始调用的函数，都是属于内核的函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11520"><span data-slate-object="text" data-key="11521"><span data-slate-leaf="true" data-offset-key="11521:0" data-first-offset="true"><span data-slate-string="true">函数的调用路径就在内核栈中，整个过程是这样的：进程调度器函数会调用进程切换函数，完成切换进程这个操作，而</span></span></span><span data-slate-object="text" data-key="11522"><span data-slate-leaf="true" data-offset-key="11522:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在进程切换函数中会保存栈寄存器的值。</span></span></span></span><span data-slate-object="text" data-key="11523"><span data-slate-leaf="true" data-offset-key="11523:0" data-first-offset="true"><span data-slate-string="true">好，下面我们来设计这样一个结构来保存这些信息。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11524"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11525"><span data-slate-object="text" data-key="11526"><span data-slate-leaf="true" data-offset-key="11526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11527"><span data-slate-leaf="true" data-offset-key="11527:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11528"><span data-slate-leaf="true" data-offset-key="11528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11529"><span data-slate-leaf="true" data-offset-key="11529:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11530"><span data-slate-leaf="true" data-offset-key="11530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_CONTEXT</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11531"><span data-slate-object="text" data-key="11532"><span data-slate-leaf="true" data-offset-key="11532:0" data-first-offset="true"><span data-slate-string="true">{  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11533"><span data-slate-object="text" data-key="11534"><span data-slate-leaf="true" data-offset-key="11534:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11535"><span data-slate-leaf="true" data-offset-key="11535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11536"><span data-slate-leaf="true" data-offset-key="11536:0" data-first-offset="true"><span data-slate-string="true">       ctx_nextrip; </span></span></span><span data-slate-object="text" data-key="11537"><span data-slate-leaf="true" data-offset-key="11537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存下一次运行的地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11538"><span data-slate-object="text" data-key="11539"><span data-slate-leaf="true" data-offset-key="11539:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11540"><span data-slate-leaf="true" data-offset-key="11540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11541"><span data-slate-leaf="true" data-offset-key="11541:0" data-first-offset="true"><span data-slate-string="true">       ctx_nextrsp; </span></span></span><span data-slate-object="text" data-key="11542"><span data-slate-leaf="true" data-offset-key="11542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存下一次运行时内核栈的地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11543"><span data-slate-object="text" data-key="11544"><span data-slate-leaf="true" data-offset-key="11544:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11545"><span data-slate-leaf="true" data-offset-key="11545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">x64tss_t</span></span></span></span><span data-slate-object="text" data-key="11546"><span data-slate-leaf="true" data-offset-key="11546:0" data-first-offset="true"><span data-slate-string="true">*    ctx_nexttss; </span></span></span><span data-slate-object="text" data-key="11547"><span data-slate-leaf="true" data-offset-key="11547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向 tss 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11548"><span data-slate-object="text" data-key="11549"><span data-slate-leaf="true" data-offset-key="11549:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="11550"><span data-slate-leaf="true" data-offset-key="11550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context_t</span></span></span></span><span data-slate-object="text" data-key="11551"><span data-slate-leaf="true" data-offset-key="11551:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11552"><span data-slate-object="text" data-key="11553"><span data-slate-leaf="true" data-offset-key="11553:0" data-first-offset="true"><span data-slate-string="true">context_t 结构中的字段不多，我们相对陌生的就是 x64tss_t 结构的指针，这个结构是 CPU 要求的一个结构，这个结构它本身的地址放在一个 GDT 表项中，由 CPU 的 tr 寄存器指向，tr 寄存器中的值是 GDT 中 x64tss_t 结构项对应的索引。x64tss_t 结构的代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11554"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11555"><span data-slate-object="text" data-key="11556"><span data-slate-leaf="true" data-offset-key="11556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// cosmos/hal/x86/halglobal.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11557"><span data-slate-object="text" data-key="11558"><span data-slate-leaf="true" data-offset-key="11558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每个 CPU 核心一个 tss </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11559"><span data-slate-object="text" data-key="11560"><span data-slate-leaf="true" data-offset-key="11560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HAL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="11561"><span data-slate-leaf="true" data-offset-key="11561:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="11562"><span data-slate-leaf="true" data-offset-key="11562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">x64tss_t</span></span></span></span><span data-slate-object="text" data-key="11563"><span data-slate-leaf="true" data-offset-key="11563:0" data-first-offset="true"><span data-slate-string="true">,x64tss)[CPUCORE_MAX]; </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11564"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11565"><span data-slate-object="text" data-key="11566"><span data-slate-leaf="true" data-offset-key="11566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11567"><span data-slate-leaf="true" data-offset-key="11567:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11568"><span data-slate-leaf="true" data-offset-key="11568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11569"><span data-slate-leaf="true" data-offset-key="11569:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11570"><span data-slate-leaf="true" data-offset-key="11570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_X64TSS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11571"><span data-slate-object="text" data-key="11572"><span data-slate-leaf="true" data-offset-key="11572:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11573"><span data-slate-object="text" data-key="11574"><span data-slate-leaf="true" data-offset-key="11574:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11575"><span data-slate-leaf="true" data-offset-key="11575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11576"><span data-slate-leaf="true" data-offset-key="11576:0" data-first-offset="true"><span data-slate-string="true"> reserv0; </span></span></span><span data-slate-object="text" data-key="11577"><span data-slate-leaf="true" data-offset-key="11577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保留</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11578"><span data-slate-object="text" data-key="11579"><span data-slate-leaf="true" data-offset-key="11579:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11580"><span data-slate-leaf="true" data-offset-key="11580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11581"><span data-slate-leaf="true" data-offset-key="11581:0" data-first-offset="true"><span data-slate-string="true"> rsp0;  </span></span></span><span data-slate-object="text" data-key="11582"><span data-slate-leaf="true" data-offset-key="11582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//R0 特权级的栈地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11583"><span data-slate-object="text" data-key="11584"><span data-slate-leaf="true" data-offset-key="11584:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11585"><span data-slate-leaf="true" data-offset-key="11585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11586"><span data-slate-leaf="true" data-offset-key="11586:0" data-first-offset="true"><span data-slate-string="true"> rsp1;  </span></span></span><span data-slate-object="text" data-key="11587"><span data-slate-leaf="true" data-offset-key="11587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//R1 特权级的栈地址，我们未使用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11588"><span data-slate-object="text" data-key="11589"><span data-slate-leaf="true" data-offset-key="11589:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11590"><span data-slate-leaf="true" data-offset-key="11590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11591"><span data-slate-leaf="true" data-offset-key="11591:0" data-first-offset="true"><span data-slate-string="true"> rsp2;  </span></span></span><span data-slate-object="text" data-key="11592"><span data-slate-leaf="true" data-offset-key="11592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//R2 特权级的栈地址，我们未使用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11593"><span data-slate-object="text" data-key="11594"><span data-slate-leaf="true" data-offset-key="11594:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11595"><span data-slate-leaf="true" data-offset-key="11595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11596"><span data-slate-leaf="true" data-offset-key="11596:0" data-first-offset="true"><span data-slate-string="true"> reserv28;</span></span></span><span data-slate-object="text" data-key="11597"><span data-slate-leaf="true" data-offset-key="11597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保留</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11598"><span data-slate-object="text" data-key="11599"><span data-slate-leaf="true" data-offset-key="11599:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11600"><span data-slate-leaf="true" data-offset-key="11600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11601"><span data-slate-leaf="true" data-offset-key="11601:0" data-first-offset="true"><span data-slate-string="true"> ist[</span></span></span><span data-slate-object="text" data-key="11602"><span data-slate-leaf="true" data-offset-key="11602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="11603"><span data-slate-leaf="true" data-offset-key="11603:0" data-first-offset="true"><span data-slate-string="true">];  </span></span></span><span data-slate-object="text" data-key="11604"><span data-slate-leaf="true" data-offset-key="11604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 我们未使用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11605"><span data-slate-object="text" data-key="11606"><span data-slate-leaf="true" data-offset-key="11606:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11607"><span data-slate-leaf="true" data-offset-key="11607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11608"><span data-slate-leaf="true" data-offset-key="11608:0" data-first-offset="true"><span data-slate-string="true"> reserv92;</span></span></span><span data-slate-object="text" data-key="11609"><span data-slate-leaf="true" data-offset-key="11609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保留</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11610"><span data-slate-object="text" data-key="11611"><span data-slate-leaf="true" data-offset-key="11611:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11612"><span data-slate-leaf="true" data-offset-key="11612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11613"><span data-slate-leaf="true" data-offset-key="11613:0" data-first-offset="true"><span data-slate-string="true"> reserv100;</span></span></span><span data-slate-object="text" data-key="11614"><span data-slate-leaf="true" data-offset-key="11614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保留</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11615"><span data-slate-object="text" data-key="11616"><span data-slate-leaf="true" data-offset-key="11616:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11617"><span data-slate-leaf="true" data-offset-key="11617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11618"><span data-slate-leaf="true" data-offset-key="11618:0" data-first-offset="true"><span data-slate-string="true"> iobase;   </span></span></span><span data-slate-object="text" data-key="11619"><span data-slate-leaf="true" data-offset-key="11619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 我们未使用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11620"><span data-slate-object="text" data-key="11621"><span data-slate-leaf="true" data-offset-key="11621:0" data-first-offset="true"><span data-slate-string="true">}__attribute__((packed)) </span></span></span><span data-slate-object="text" data-key="11622"><span data-slate-leaf="true" data-offset-key="11622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">x64tss_t</span></span></span></span><span data-slate-object="text" data-key="11623"><span data-slate-leaf="true" data-offset-key="11623:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11624"><span data-slate-object="text" data-key="11625"><span data-slate-leaf="true" data-offset-key="11625:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f28f171f" data-attr-id="43609" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">CPU 在发生中断时，会根据中断门描述里的目标段选择子，进行必要的特权级切换，特权级的切换就必须要切换栈，CPU 硬件会自己把当前 rsp 寄存器保存到内部的临时寄存器 tmprsp；然后从 x64tss_t 结构体中找出对应的栈地址，装入 rsp 寄存器中；接着，再把当前的 ss、tmprsp、rflags、cs、rip，依次压入当前 rsp 指向的栈中。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11626" id="sr-toc-8"><span data-slate-object="text" data-key="11627"><span data-slate-leaf="true" data-offset-key="11627:0" data-first-offset="true"><span data-slate-string="true">建立进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11628"><span data-slate-object="text" data-key="11629"><span data-slate-leaf="true" data-offset-key="11629:0" data-first-offset="true"><span data-slate-string="true">之前我们已经设计好了进程相关的数据结构，现在我们要讨论如何建立一个新的进程了。建立进程非常简单，就是在内存中建立起对应的数据结构的实例变量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11630"><span data-slate-object="text" data-key="11631"><span data-slate-leaf="true" data-offset-key="11631:0" data-first-offset="true"><span data-slate-string="true">但是对进程来说，并不是建立 thread_t 结构的实例变量就完事了，还要建立进程的应用程序栈和进程的内核栈，进程地址空间等。下面我们一起来实现建立进程的功能。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11632" id="sr-toc-9"><span data-slate-object="text" data-key="11633"><span data-slate-leaf="true" data-offset-key="11633:0" data-first-offset="true"><span data-slate-string="true">建立进程接口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11634"><span data-slate-object="text" data-key="11635"><span data-slate-leaf="true" data-offset-key="11635:0" data-first-offset="true"><span data-slate-string="true">我们先从建立进程的接口开始写起，先在 cosmos/kernel/ 目录下新建一个文件 krlthread.c，在其中写上一个函数。接口函数总是简单的，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11636"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11637"><span data-slate-object="text" data-key="11638"><span data-slate-leaf="true" data-offset-key="11638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="11639"><span data-slate-leaf="true" data-offset-key="11639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="11640"><span data-slate-leaf="true" data-offset-key="11640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_thread</span></span></span></span></span><span data-slate-object="text" data-key="11641"><span data-slate-leaf="true" data-offset-key="11641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11642"><span data-slate-leaf="true" data-offset-key="11642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="11643"><span data-slate-leaf="true" data-offset-key="11643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *filerun, </span></span></span></span></span><span data-slate-object="text" data-key="11644"><span data-slate-leaf="true" data-offset-key="11644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11645"><span data-slate-leaf="true" data-offset-key="11645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> flg, </span></span></span></span></span><span data-slate-object="text" data-key="11646"><span data-slate-leaf="true" data-offset-key="11646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11647"><span data-slate-leaf="true" data-offset-key="11647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> prilg, </span></span></span></span></span><span data-slate-object="text" data-key="11648"><span data-slate-leaf="true" data-offset-key="11648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11649"><span data-slate-leaf="true" data-offset-key="11649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> prity, </span></span></span></span></span><span data-slate-object="text" data-key="11650"><span data-slate-leaf="true" data-offset-key="11650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11651"><span data-slate-leaf="true" data-offset-key="11651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> usrstksz, </span></span></span></span></span><span data-slate-object="text" data-key="11652"><span data-slate-leaf="true" data-offset-key="11652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11653"><span data-slate-leaf="true" data-offset-key="11653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> krlstksz)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11654"><span data-slate-object="text" data-key="11655"><span data-slate-leaf="true" data-offset-key="11655:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11656"><span data-slate-object="text" data-key="11657"><span data-slate-leaf="true" data-offset-key="11657:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11658"><span data-slate-leaf="true" data-offset-key="11658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="11659"><span data-slate-leaf="true" data-offset-key="11659:0" data-first-offset="true"><span data-slate-string="true"> tustksz = usrstksz, tkstksz = krlstksz;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11660"><span data-slate-object="text" data-key="11661"><span data-slate-leaf="true" data-offset-key="11661:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11662"><span data-slate-leaf="true" data-offset-key="11662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对参数进行检查，不合乎要求就返回 NULL 表示创建失败</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11663"><span data-slate-object="text" data-key="11664"><span data-slate-leaf="true" data-offset-key="11664:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11665"><span data-slate-leaf="true" data-offset-key="11665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11666"><span data-slate-leaf="true" data-offset-key="11666:0" data-first-offset="true"><span data-slate-string="true"> (filerun == </span></span></span><span data-slate-object="text" data-key="11667"><span data-slate-leaf="true" data-offset-key="11667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11668"><span data-slate-leaf="true" data-offset-key="11668:0" data-first-offset="true"><span data-slate-string="true"> || usrstksz &gt; DAFT_TDUSRSTKSZ || krlstksz &gt; DAFT_TDKRLSTKSZ)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11669"><span data-slate-object="text" data-key="11670"><span data-slate-leaf="true" data-offset-key="11670:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11671"><span data-slate-object="text" data-key="11672"><span data-slate-leaf="true" data-offset-key="11672:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11673"><span data-slate-leaf="true" data-offset-key="11673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11674"><span data-slate-leaf="true" data-offset-key="11674:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11675"><span data-slate-leaf="true" data-offset-key="11675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11676"><span data-slate-leaf="true" data-offset-key="11676:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11677"><span data-slate-object="text" data-key="11678"><span data-slate-leaf="true" data-offset-key="11678:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11679"><span data-slate-object="text" data-key="11680"><span data-slate-leaf="true" data-offset-key="11680:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11681"><span data-slate-leaf="true" data-offset-key="11681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11682"><span data-slate-leaf="true" data-offset-key="11682:0" data-first-offset="true"><span data-slate-string="true"> ((prilg != PRILG_USR &amp;&amp; prilg != PRILG_SYS) || (prity &gt;= PRITY_MAX))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11683"><span data-slate-object="text" data-key="11684"><span data-slate-leaf="true" data-offset-key="11684:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11685"><span data-slate-object="text" data-key="11686"><span data-slate-leaf="true" data-offset-key="11686:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11687"><span data-slate-leaf="true" data-offset-key="11687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11688"><span data-slate-leaf="true" data-offset-key="11688:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11689"><span data-slate-leaf="true" data-offset-key="11689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11690"><span data-slate-leaf="true" data-offset-key="11690:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11691"><span data-slate-object="text" data-key="11692"><span data-slate-leaf="true" data-offset-key="11692:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11693"><span data-slate-object="text" data-key="11694"><span data-slate-leaf="true" data-offset-key="11694:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11695"><span data-slate-leaf="true" data-offset-key="11695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程应用程序栈大小检查，大于默认大小则使用默认大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11696"><span data-slate-object="text" data-key="11697"><span data-slate-leaf="true" data-offset-key="11697:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11698"><span data-slate-leaf="true" data-offset-key="11698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11699"><span data-slate-leaf="true" data-offset-key="11699:0" data-first-offset="true"><span data-slate-string="true"> (usrstksz &lt; DAFT_TDUSRSTKSZ)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11700"><span data-slate-object="text" data-key="11701"><span data-slate-leaf="true" data-offset-key="11701:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11702"><span data-slate-object="text" data-key="11703"><span data-slate-leaf="true" data-offset-key="11703:0" data-first-offset="true"><span data-slate-string="true">        tustksz = DAFT_TDUSRSTKSZ;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11704"><span data-slate-object="text" data-key="11705"><span data-slate-leaf="true" data-offset-key="11705:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11706"><span data-slate-object="text" data-key="11707"><span data-slate-leaf="true" data-offset-key="11707:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11708"><span data-slate-leaf="true" data-offset-key="11708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程内核栈大小检查，大于默认大小则使用默认大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11709"><span data-slate-object="text" data-key="11710"><span data-slate-leaf="true" data-offset-key="11710:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11711"><span data-slate-leaf="true" data-offset-key="11711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11712"><span data-slate-leaf="true" data-offset-key="11712:0" data-first-offset="true"><span data-slate-string="true"> (krlstksz &lt; DAFT_TDKRLSTKSZ)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11713"><span data-slate-object="text" data-key="11714"><span data-slate-leaf="true" data-offset-key="11714:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11715"><span data-slate-object="text" data-key="11716"><span data-slate-leaf="true" data-offset-key="11716:0" data-first-offset="true"><span data-slate-string="true">        tkstksz = DAFT_TDKRLSTKSZ;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11717"><span data-slate-object="text" data-key="11718"><span data-slate-leaf="true" data-offset-key="11718:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11719"><span data-slate-object="text" data-key="11720"><span data-slate-leaf="true" data-offset-key="11720:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11721"><span data-slate-leaf="true" data-offset-key="11721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否建立内核进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11722"><span data-slate-object="text" data-key="11723"><span data-slate-leaf="true" data-offset-key="11723:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11724"><span data-slate-leaf="true" data-offset-key="11724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11725"><span data-slate-leaf="true" data-offset-key="11725:0" data-first-offset="true"><span data-slate-string="true"> (KERNTHREAD_FLG == flg)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11726"><span data-slate-object="text" data-key="11727"><span data-slate-leaf="true" data-offset-key="11727:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11728"><span data-slate-object="text" data-key="11729"><span data-slate-leaf="true" data-offset-key="11729:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11730"><span data-slate-leaf="true" data-offset-key="11730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11731"><span data-slate-leaf="true" data-offset-key="11731:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11732"><span data-slate-leaf="true" data-offset-key="11732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_kern_thread_core</span></span></span></span><span data-slate-object="text" data-key="11733"><span data-slate-leaf="true" data-offset-key="11733:0" data-first-offset="true"><span data-slate-string="true">(filerun, flg, prilg, prity, tustksz, tkstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11734"><span data-slate-object="text" data-key="11735"><span data-slate-leaf="true" data-offset-key="11735:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11736"><span data-slate-object="text" data-key="11737"><span data-slate-leaf="true" data-offset-key="11737:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11738"><span data-slate-leaf="true" data-offset-key="11738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否建立普通进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11739"><span data-slate-object="text" data-key="11740"><span data-slate-leaf="true" data-offset-key="11740:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11741"><span data-slate-leaf="true" data-offset-key="11741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="11742"><span data-slate-leaf="true" data-offset-key="11742:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11743"><span data-slate-leaf="true" data-offset-key="11743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11744"><span data-slate-leaf="true" data-offset-key="11744:0" data-first-offset="true"><span data-slate-string="true"> (USERTHREAD_FLG == flg)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11745"><span data-slate-object="text" data-key="11746"><span data-slate-leaf="true" data-offset-key="11746:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11747"><span data-slate-object="text" data-key="11748"><span data-slate-leaf="true" data-offset-key="11748:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11749"><span data-slate-leaf="true" data-offset-key="11749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11750"><span data-slate-leaf="true" data-offset-key="11750:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11751"><span data-slate-leaf="true" data-offset-key="11751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_user_thread_core</span></span></span></span><span data-slate-object="text" data-key="11752"><span data-slate-leaf="true" data-offset-key="11752:0" data-first-offset="true"><span data-slate-string="true">(filerun, flg, prilg, prity, tustksz, tkstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11753"><span data-slate-object="text" data-key="11754"><span data-slate-leaf="true" data-offset-key="11754:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11755"><span data-slate-object="text" data-key="11756"><span data-slate-leaf="true" data-offset-key="11756:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11757"><span data-slate-leaf="true" data-offset-key="11757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11758"><span data-slate-leaf="true" data-offset-key="11758:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11759"><span data-slate-leaf="true" data-offset-key="11759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11760"><span data-slate-leaf="true" data-offset-key="11760:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11761"><span data-slate-object="text" data-key="11762"><span data-slate-leaf="true" data-offset-key="11762:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11763"><span data-slate-object="text" data-key="11764"><span data-slate-leaf="true" data-offset-key="11764:0" data-first-offset="true"><span data-slate-string="true">上述代码中的 krlnew_thread 函数的流程非常简单，对参数进行合理检查，其参数从左到右分别是应用程序启动运行的地址、创建标志、进程权限和进程优先级、进程的应用程序栈和内核栈大小。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11765"><span data-slate-object="text" data-key="11766"><span data-slate-leaf="true" data-offset-key="11766:0" data-first-offset="true"><span data-slate-string="true">进程对栈的大小有要求，如果小于默认大小 8 个页面就使用默认的栈大小，最后根据创建标志确认是建立内核态进程还是建立普通进程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11767" id="sr-toc-10"><span data-slate-object="text" data-key="11768"><span data-slate-leaf="true" data-offset-key="11768:0" data-first-offset="true"><span data-slate-string="true">建立内核进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11769"><span data-slate-object="text" data-key="11770"><span data-slate-leaf="true" data-offset-key="11770:0" data-first-offset="true"><span data-slate-string="true">你一定在想，什么是内核进程？其实内核进程就是</span></span></span><span data-slate-object="text" data-key="11771"><span data-slate-leaf="true" data-offset-key="11771:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">用进程的方式去运行一段内核代码，那么这段代码就可以随时暂停或者继续运行，又或者和其它代码段并发运行，只是这种进程永远不会回到进程应用程序地址空间中去，只会在内核地址空间中运行。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11772"><span data-slate-object="text" data-key="11773"><span data-slate-leaf="true" data-offset-key="11773:0" data-first-offset="true"><span data-slate-string="true">下面我来写代码实现建立一个内核态进程，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11774"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11775"><span data-slate-object="text" data-key="11776"><span data-slate-leaf="true" data-offset-key="11776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="11777"><span data-slate-leaf="true" data-offset-key="11777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="11778"><span data-slate-leaf="true" data-offset-key="11778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_kern_thread_core</span></span></span></span></span><span data-slate-object="text" data-key="11779"><span data-slate-leaf="true" data-offset-key="11779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11780"><span data-slate-leaf="true" data-offset-key="11780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="11781"><span data-slate-leaf="true" data-offset-key="11781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *filerun, </span></span></span></span></span><span data-slate-object="text" data-key="11782"><span data-slate-leaf="true" data-offset-key="11782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11783"><span data-slate-leaf="true" data-offset-key="11783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> flg, </span></span></span></span></span><span data-slate-object="text" data-key="11784"><span data-slate-leaf="true" data-offset-key="11784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11785"><span data-slate-leaf="true" data-offset-key="11785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> prilg, </span></span></span></span></span><span data-slate-object="text" data-key="11786"><span data-slate-leaf="true" data-offset-key="11786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11787"><span data-slate-leaf="true" data-offset-key="11787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> prity, </span></span></span></span></span><span data-slate-object="text" data-key="11788"><span data-slate-leaf="true" data-offset-key="11788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11789"><span data-slate-leaf="true" data-offset-key="11789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> usrstksz, </span></span></span></span></span><span data-slate-object="text" data-key="11790"><span data-slate-leaf="true" data-offset-key="11790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11791"><span data-slate-leaf="true" data-offset-key="11791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> krlstksz)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11792"><span data-slate-object="text" data-key="11793"><span data-slate-leaf="true" data-offset-key="11793:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11794"><span data-slate-object="text" data-key="11795"><span data-slate-leaf="true" data-offset-key="11795:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11796"><span data-slate-leaf="true" data-offset-key="11796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="11797"><span data-slate-leaf="true" data-offset-key="11797:0" data-first-offset="true"><span data-slate-string="true"> *ret_td = </span></span></span><span data-slate-object="text" data-key="11798"><span data-slate-leaf="true" data-offset-key="11798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11799"><span data-slate-leaf="true" data-offset-key="11799:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11800"><span data-slate-object="text" data-key="11801"><span data-slate-leaf="true" data-offset-key="11801:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11802"><span data-slate-leaf="true" data-offset-key="11802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool_t</span></span></span></span><span data-slate-object="text" data-key="11803"><span data-slate-leaf="true" data-offset-key="11803:0" data-first-offset="true"><span data-slate-string="true"> acs = FALSE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11804"><span data-slate-object="text" data-key="11805"><span data-slate-leaf="true" data-offset-key="11805:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11806"><span data-slate-leaf="true" data-offset-key="11806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11807"><span data-slate-leaf="true" data-offset-key="11807:0" data-first-offset="true"><span data-slate-string="true"> krlstkadr = </span></span></span><span data-slate-object="text" data-key="11808"><span data-slate-leaf="true" data-offset-key="11808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11809"><span data-slate-leaf="true" data-offset-key="11809:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11810"><span data-slate-object="text" data-key="11811"><span data-slate-leaf="true" data-offset-key="11811:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11812"><span data-slate-leaf="true" data-offset-key="11812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配内核栈空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11813"><span data-slate-object="text" data-key="11814"><span data-slate-leaf="true" data-offset-key="11814:0" data-first-offset="true"><span data-slate-string="true">    krlstkadr = </span></span></span><span data-slate-object="text" data-key="11815"><span data-slate-leaf="true" data-offset-key="11815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="11816"><span data-slate-leaf="true" data-offset-key="11816:0" data-first-offset="true"><span data-slate-string="true">(krlstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11817"><span data-slate-object="text" data-key="11818"><span data-slate-leaf="true" data-offset-key="11818:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11819"><span data-slate-leaf="true" data-offset-key="11819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11820"><span data-slate-leaf="true" data-offset-key="11820:0" data-first-offset="true"><span data-slate-string="true"> (krlstkadr == </span></span></span><span data-slate-object="text" data-key="11821"><span data-slate-leaf="true" data-offset-key="11821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11822"><span data-slate-leaf="true" data-offset-key="11822:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11823"><span data-slate-object="text" data-key="11824"><span data-slate-leaf="true" data-offset-key="11824:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11825"><span data-slate-object="text" data-key="11826"><span data-slate-leaf="true" data-offset-key="11826:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11827"><span data-slate-leaf="true" data-offset-key="11827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11828"><span data-slate-leaf="true" data-offset-key="11828:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11829"><span data-slate-leaf="true" data-offset-key="11829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11830"><span data-slate-leaf="true" data-offset-key="11830:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11831"><span data-slate-object="text" data-key="11832"><span data-slate-leaf="true" data-offset-key="11832:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11833"><span data-slate-object="text" data-key="11834"><span data-slate-leaf="true" data-offset-key="11834:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11835"><span data-slate-leaf="true" data-offset-key="11835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 thread_t 结构体的实例变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11836"><span data-slate-object="text" data-key="11837"><span data-slate-leaf="true" data-offset-key="11837:0" data-first-offset="true"><span data-slate-string="true">    ret_td = </span></span></span><span data-slate-object="text" data-key="11838"><span data-slate-leaf="true" data-offset-key="11838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_thread_dsc</span></span></span></span><span data-slate-object="text" data-key="11839"><span data-slate-leaf="true" data-offset-key="11839:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11840"><span data-slate-object="text" data-key="11841"><span data-slate-leaf="true" data-offset-key="11841:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11842"><span data-slate-leaf="true" data-offset-key="11842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11843"><span data-slate-leaf="true" data-offset-key="11843:0" data-first-offset="true"><span data-slate-string="true"> (ret_td == </span></span></span><span data-slate-object="text" data-key="11844"><span data-slate-leaf="true" data-offset-key="11844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11845"><span data-slate-leaf="true" data-offset-key="11845:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11846"><span data-slate-object="text" data-key="11847"><span data-slate-leaf="true" data-offset-key="11847:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="11848"><span data-slate-leaf="true" data-offset-key="11848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建失败必须要释放之前的栈空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11849"><span data-slate-object="text" data-key="11850"><span data-slate-leaf="true" data-offset-key="11850:0" data-first-offset="true"><span data-slate-string="true">        acs = </span></span></span><span data-slate-object="text" data-key="11851"><span data-slate-leaf="true" data-offset-key="11851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="11852"><span data-slate-leaf="true" data-offset-key="11852:0" data-first-offset="true"><span data-slate-string="true">(krlstkadr, krlstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11853"><span data-slate-object="text" data-key="11854"><span data-slate-leaf="true" data-offset-key="11854:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11855"><span data-slate-leaf="true" data-offset-key="11855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11856"><span data-slate-leaf="true" data-offset-key="11856:0" data-first-offset="true"><span data-slate-string="true"> (acs == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11857"><span data-slate-object="text" data-key="11858"><span data-slate-leaf="true" data-offset-key="11858:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11859"><span data-slate-object="text" data-key="11860"><span data-slate-leaf="true" data-offset-key="11860:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="11861"><span data-slate-leaf="true" data-offset-key="11861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11862"><span data-slate-leaf="true" data-offset-key="11862:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11863"><span data-slate-leaf="true" data-offset-key="11863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11864"><span data-slate-leaf="true" data-offset-key="11864:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11865"><span data-slate-object="text" data-key="11866"><span data-slate-leaf="true" data-offset-key="11866:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11867"><span data-slate-object="text" data-key="11868"><span data-slate-leaf="true" data-offset-key="11868:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11869"><span data-slate-leaf="true" data-offset-key="11869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11870"><span data-slate-leaf="true" data-offset-key="11870:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11871"><span data-slate-leaf="true" data-offset-key="11871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="11872"><span data-slate-leaf="true" data-offset-key="11872:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11873"><span data-slate-object="text" data-key="11874"><span data-slate-leaf="true" data-offset-key="11874:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11875"><span data-slate-object="text" data-key="11876"><span data-slate-leaf="true" data-offset-key="11876:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11877"><span data-slate-leaf="true" data-offset-key="11877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程权限 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11878"><span data-slate-object="text" data-key="11879"><span data-slate-leaf="true" data-offset-key="11879:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_privilege = prilg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11880"><span data-slate-object="text" data-key="11881"><span data-slate-leaf="true" data-offset-key="11881:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11882"><span data-slate-leaf="true" data-offset-key="11882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11883"><span data-slate-object="text" data-key="11884"><span data-slate-leaf="true" data-offset-key="11884:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_priority = prity;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11885"><span data-slate-object="text" data-key="11886"><span data-slate-leaf="true" data-offset-key="11886:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11887"><span data-slate-leaf="true" data-offset-key="11887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程的内核栈顶和内核栈开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11888"><span data-slate-object="text" data-key="11889"><span data-slate-leaf="true" data-offset-key="11889:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_krlstktop = krlstkadr + (</span></span></span><span data-slate-object="text" data-key="11890"><span data-slate-leaf="true" data-offset-key="11890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="11891"><span data-slate-leaf="true" data-offset-key="11891:0" data-first-offset="true"><span data-slate-string="true">)(krlstksz - </span></span></span><span data-slate-object="text" data-key="11892"><span data-slate-leaf="true" data-offset-key="11892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="11893"><span data-slate-leaf="true" data-offset-key="11893:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11894"><span data-slate-object="text" data-key="11895"><span data-slate-leaf="true" data-offset-key="11895:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_krlstkstart = krlstkadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11896"><span data-slate-object="text" data-key="11897"><span data-slate-leaf="true" data-offset-key="11897:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11898"><span data-slate-leaf="true" data-offset-key="11898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化进程的内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11899"><span data-slate-object="text" data-key="11900"><span data-slate-leaf="true" data-offset-key="11900:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11901"><span data-slate-leaf="true" data-offset-key="11901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlthread_kernstack_init</span></span></span></span><span data-slate-object="text" data-key="11902"><span data-slate-leaf="true" data-offset-key="11902:0" data-first-offset="true"><span data-slate-string="true">(ret_td, filerun, KMOD_EFLAGS);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11903"><span data-slate-object="text" data-key="11904"><span data-slate-leaf="true" data-offset-key="11904:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11905"><span data-slate-leaf="true" data-offset-key="11905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入进程调度系统</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11906"><span data-slate-object="text" data-key="11907"><span data-slate-leaf="true" data-offset-key="11907:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11908"><span data-slate-leaf="true" data-offset-key="11908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlschdclass_add_thread</span></span></span></span><span data-slate-object="text" data-key="11909"><span data-slate-leaf="true" data-offset-key="11909:0" data-first-offset="true"><span data-slate-string="true">(ret_td);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11910"><span data-slate-object="text" data-key="11911"><span data-slate-leaf="true" data-offset-key="11911:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11912"><span data-slate-leaf="true" data-offset-key="11912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回进程指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11913"><span data-slate-object="text" data-key="11914"><span data-slate-leaf="true" data-offset-key="11914:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11915"><span data-slate-leaf="true" data-offset-key="11915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11916"><span data-slate-leaf="true" data-offset-key="11916:0" data-first-offset="true"><span data-slate-string="true"> ret_td;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11917"><span data-slate-object="text" data-key="11918"><span data-slate-leaf="true" data-offset-key="11918:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11919"><span data-slate-object="text" data-key="11920"><span data-slate-leaf="true" data-offset-key="11920:0" data-first-offset="true"><span data-slate-string="true">上述代码的逻辑非常简单，首先分配一个内核栈的内存空间，接着创建 thread_t 结构的实例变量，然后对 thread_t 结构体的字段进行设置，最后，初始化进程内核栈把这个新进程加入到进程的调度系统之中，下面来一步步写入实现这些逻辑的代码。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11921" id="sr-toc-11"><span data-slate-object="text" data-key="11922"><span data-slate-leaf="true" data-offset-key="11922:0" data-first-offset="true"><span data-slate-string="true">创建 thread_t 结构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11923"><span data-slate-object="text" data-key="11924"><span data-slate-leaf="true" data-offset-key="11924:0" data-first-offset="true"><span data-slate-string="true">创建 thread_t 结构，其实就是分配一块内存用于存放 thread_t 结构的实例变量。类似这样的操作我们课程里做过多次，相信现在你已经能驾轻就熟了。下面我们来写代码实现这个操作，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11925"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11926"><span data-slate-object="text" data-key="11927"><span data-slate-leaf="true" data-offset-key="11927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 context_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11928"><span data-slate-object="text" data-key="11929"><span data-slate-leaf="true" data-offset-key="11929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="11930"><span data-slate-leaf="true" data-offset-key="11930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11931"><span data-slate-leaf="true" data-offset-key="11931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context_t_init</span></span></span></span></span><span data-slate-object="text" data-key="11932"><span data-slate-leaf="true" data-offset-key="11932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11933"><span data-slate-leaf="true" data-offset-key="11933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11934"><span data-slate-leaf="true" data-offset-key="11934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *initp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11935"><span data-slate-object="text" data-key="11936"><span data-slate-leaf="true" data-offset-key="11936:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11937"><span data-slate-object="text" data-key="11938"><span data-slate-leaf="true" data-offset-key="11938:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;ctx_nextrip = </span></span></span><span data-slate-object="text" data-key="11939"><span data-slate-leaf="true" data-offset-key="11939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11940"><span data-slate-leaf="true" data-offset-key="11940:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11941"><span data-slate-object="text" data-key="11942"><span data-slate-leaf="true" data-offset-key="11942:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;ctx_nextrsp = </span></span></span><span data-slate-object="text" data-key="11943"><span data-slate-leaf="true" data-offset-key="11943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11944"><span data-slate-leaf="true" data-offset-key="11944:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11945"><span data-slate-object="text" data-key="11946"><span data-slate-leaf="true" data-offset-key="11946:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11947"><span data-slate-leaf="true" data-offset-key="11947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向当前 CPU 的 tss</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11948"><span data-slate-object="text" data-key="11949"><span data-slate-leaf="true" data-offset-key="11949:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;ctx_nexttss = &amp;x64tss[</span></span></span><span data-slate-object="text" data-key="11950"><span data-slate-leaf="true" data-offset-key="11950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="11951"><span data-slate-leaf="true" data-offset-key="11951:0" data-first-offset="true"><span data-slate-string="true">()];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11952"><span data-slate-object="text" data-key="11953"><span data-slate-leaf="true" data-offset-key="11953:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11954"><span data-slate-leaf="true" data-offset-key="11954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11955"><span data-slate-leaf="true" data-offset-key="11955:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11956"><span data-slate-object="text" data-key="11957"><span data-slate-leaf="true" data-offset-key="11957:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11958"><span data-slate-object="text" data-key="11959"><span data-slate-leaf="true" data-offset-key="11959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回进程 id 其实就 thread_t 结构的地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11960"><span data-slate-object="text" data-key="11961"><span data-slate-leaf="true" data-offset-key="11961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span><span data-slate-object="text" data-key="11962"><span data-slate-leaf="true" data-offset-key="11962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11963"><span data-slate-leaf="true" data-offset-key="11963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlretn_thread_id</span></span></span></span></span><span data-slate-object="text" data-key="11964"><span data-slate-leaf="true" data-offset-key="11964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11965"><span data-slate-leaf="true" data-offset-key="11965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11966"><span data-slate-leaf="true" data-offset-key="11966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *tdp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11967"><span data-slate-object="text" data-key="11968"><span data-slate-leaf="true" data-offset-key="11968:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11969"><span data-slate-object="text" data-key="11970"><span data-slate-leaf="true" data-offset-key="11970:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11971"><span data-slate-leaf="true" data-offset-key="11971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11972"><span data-slate-leaf="true" data-offset-key="11972:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="11973"><span data-slate-leaf="true" data-offset-key="11973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11974"><span data-slate-leaf="true" data-offset-key="11974:0" data-first-offset="true"><span data-slate-string="true">)tdp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11975"><span data-slate-object="text" data-key="11976"><span data-slate-leaf="true" data-offset-key="11976:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11977"><span data-slate-object="text" data-key="11978"><span data-slate-leaf="true" data-offset-key="11978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 thread_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11979"><span data-slate-object="text" data-key="11980"><span data-slate-leaf="true" data-offset-key="11980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="11981"><span data-slate-leaf="true" data-offset-key="11981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11982"><span data-slate-leaf="true" data-offset-key="11982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t_init</span></span></span></span></span><span data-slate-object="text" data-key="11983"><span data-slate-leaf="true" data-offset-key="11983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11984"><span data-slate-leaf="true" data-offset-key="11984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11985"><span data-slate-leaf="true" data-offset-key="11985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *initp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11986"><span data-slate-object="text" data-key="11987"><span data-slate-leaf="true" data-offset-key="11987:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11988"><span data-slate-object="text" data-key="11989"><span data-slate-leaf="true" data-offset-key="11989:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11990"><span data-slate-leaf="true" data-offset-key="11990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_init</span></span></span></span><span data-slate-object="text" data-key="11991"><span data-slate-leaf="true" data-offset-key="11991:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp-&gt;td_lock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11992"><span data-slate-object="text" data-key="11993"><span data-slate-leaf="true" data-offset-key="11993:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11994"><span data-slate-leaf="true" data-offset-key="11994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_init</span></span></span></span><span data-slate-object="text" data-key="11995"><span data-slate-leaf="true" data-offset-key="11995:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp-&gt;td_list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11996"><span data-slate-object="text" data-key="11997"><span data-slate-leaf="true" data-offset-key="11997:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_flgs = TDFLAG_FREE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11998"><span data-slate-object="text" data-key="11999"><span data-slate-leaf="true" data-offset-key="11999:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_stus = TDSTUS_NEW;</span></span></span><span data-slate-object="text" data-key="12000"><span data-slate-leaf="true" data-offset-key="12000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程状态为新建</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12001"><span data-slate-object="text" data-key="12002"><span data-slate-leaf="true" data-offset-key="12002:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_cpuid = </span></span></span><span data-slate-object="text" data-key="12003"><span data-slate-leaf="true" data-offset-key="12003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="12004"><span data-slate-leaf="true" data-offset-key="12004:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12005"><span data-slate-object="text" data-key="12006"><span data-slate-leaf="true" data-offset-key="12006:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_id = </span></span></span><span data-slate-object="text" data-key="12007"><span data-slate-leaf="true" data-offset-key="12007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlretn_thread_id</span></span></span></span><span data-slate-object="text" data-key="12008"><span data-slate-leaf="true" data-offset-key="12008:0" data-first-offset="true"><span data-slate-string="true">(initp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12009"><span data-slate-object="text" data-key="12010"><span data-slate-leaf="true" data-offset-key="12010:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_tick = </span></span></span><span data-slate-object="text" data-key="12011"><span data-slate-leaf="true" data-offset-key="12011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12012"><span data-slate-leaf="true" data-offset-key="12012:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12013"><span data-slate-object="text" data-key="12014"><span data-slate-leaf="true" data-offset-key="12014:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_privilege = PRILG_USR;</span></span></span><span data-slate-object="text" data-key="12015"><span data-slate-leaf="true" data-offset-key="12015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 普通进程权限</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12016"><span data-slate-object="text" data-key="12017"><span data-slate-leaf="true" data-offset-key="12017:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_priority = PRITY_MIN;</span></span></span><span data-slate-object="text" data-key="12018"><span data-slate-leaf="true" data-offset-key="12018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最高优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12019"><span data-slate-object="text" data-key="12020"><span data-slate-leaf="true" data-offset-key="12020:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_runmode = </span></span></span><span data-slate-object="text" data-key="12021"><span data-slate-leaf="true" data-offset-key="12021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12022"><span data-slate-leaf="true" data-offset-key="12022:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12023"><span data-slate-object="text" data-key="12024"><span data-slate-leaf="true" data-offset-key="12024:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_krlstktop = </span></span></span><span data-slate-object="text" data-key="12025"><span data-slate-leaf="true" data-offset-key="12025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12026"><span data-slate-leaf="true" data-offset-key="12026:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12027"><span data-slate-object="text" data-key="12028"><span data-slate-leaf="true" data-offset-key="12028:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_krlstkstart = </span></span></span><span data-slate-object="text" data-key="12029"><span data-slate-leaf="true" data-offset-key="12029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12030"><span data-slate-leaf="true" data-offset-key="12030:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12031"><span data-slate-object="text" data-key="12032"><span data-slate-leaf="true" data-offset-key="12032:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_usrstktop = </span></span></span><span data-slate-object="text" data-key="12033"><span data-slate-leaf="true" data-offset-key="12033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12034"><span data-slate-leaf="true" data-offset-key="12034:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12035"><span data-slate-object="text" data-key="12036"><span data-slate-leaf="true" data-offset-key="12036:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_usrstkstart = </span></span></span><span data-slate-object="text" data-key="12037"><span data-slate-leaf="true" data-offset-key="12037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12038"><span data-slate-leaf="true" data-offset-key="12038:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12039"><span data-slate-object="text" data-key="12040"><span data-slate-leaf="true" data-offset-key="12040:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;td_mmdsc = &amp;initmmadrsdsc;</span></span></span><span data-slate-object="text" data-key="12041"><span data-slate-leaf="true" data-offset-key="12041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向默认的地址空间结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12042"></div><div data-slate-type="code-line" data-slate-object="block" data-key="12043"><span data-slate-object="text" data-key="12044"><span data-slate-leaf="true" data-offset-key="12044:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12045"><span data-slate-leaf="true" data-offset-key="12045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context_t_init</span></span></span></span><span data-slate-object="text" data-key="12046"><span data-slate-leaf="true" data-offset-key="12046:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp-&gt;td_context);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12047"><span data-slate-object="text" data-key="12048"><span data-slate-leaf="true" data-offset-key="12048:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12049"><span data-slate-leaf="true" data-offset-key="12049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 td_handtbl 数组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12050"><span data-slate-object="text" data-key="12051"><span data-slate-leaf="true" data-offset-key="12051:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12052"><span data-slate-leaf="true" data-offset-key="12052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="12053"><span data-slate-leaf="true" data-offset-key="12053:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="12054"><span data-slate-leaf="true" data-offset-key="12054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12055"><span data-slate-leaf="true" data-offset-key="12055:0" data-first-offset="true"><span data-slate-string="true"> hand = </span></span></span><span data-slate-object="text" data-key="12056"><span data-slate-leaf="true" data-offset-key="12056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12057"><span data-slate-leaf="true" data-offset-key="12057:0" data-first-offset="true"><span data-slate-string="true">; hand &lt;TD_HAND_MAX; hand++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12058"><span data-slate-object="text" data-key="12059"><span data-slate-leaf="true" data-offset-key="12059:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12060"><span data-slate-object="text" data-key="12061"><span data-slate-leaf="true" data-offset-key="12061:0" data-first-offset="true"><span data-slate-string="true">        initp-&gt;td_handtbl[hand] = </span></span></span><span data-slate-object="text" data-key="12062"><span data-slate-leaf="true" data-offset-key="12062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12063"><span data-slate-leaf="true" data-offset-key="12063:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12064"><span data-slate-object="text" data-key="12065"><span data-slate-leaf="true" data-offset-key="12065:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12066"><span data-slate-object="text" data-key="12067"><span data-slate-leaf="true" data-offset-key="12067:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12068"><span data-slate-leaf="true" data-offset-key="12068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12069"><span data-slate-leaf="true" data-offset-key="12069:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12070"><span data-slate-object="text" data-key="12071"><span data-slate-leaf="true" data-offset-key="12071:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12072"><span data-slate-object="text" data-key="12073"><span data-slate-leaf="true" data-offset-key="12073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 thread_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12074"><span data-slate-object="text" data-key="12075"><span data-slate-leaf="true" data-offset-key="12075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="12076"><span data-slate-leaf="true" data-offset-key="12076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="12077"><span data-slate-leaf="true" data-offset-key="12077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_thread_dsc</span></span></span></span></span><span data-slate-object="text" data-key="12078"><span data-slate-leaf="true" data-offset-key="12078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12079"><span data-slate-object="text" data-key="12080"><span data-slate-leaf="true" data-offset-key="12080:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12081"><span data-slate-object="text" data-key="12082"><span data-slate-leaf="true" data-offset-key="12082:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12083"><span data-slate-leaf="true" data-offset-key="12083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 thread_t 结构大小的内存空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12084"><span data-slate-object="text" data-key="12085"><span data-slate-leaf="true" data-offset-key="12085:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12086"><span data-slate-leaf="true" data-offset-key="12086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12087"><span data-slate-leaf="true" data-offset-key="12087:0" data-first-offset="true"><span data-slate-string="true"> *rettdp = (</span></span></span><span data-slate-object="text" data-key="12088"><span data-slate-leaf="true" data-offset-key="12088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12089"><span data-slate-leaf="true" data-offset-key="12089:0" data-first-offset="true"><span data-slate-string="true"> *)(</span></span></span><span data-slate-object="text" data-key="12090"><span data-slate-leaf="true" data-offset-key="12090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="12091"><span data-slate-leaf="true" data-offset-key="12091:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="12092"><span data-slate-leaf="true" data-offset-key="12092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="12093"><span data-slate-leaf="true" data-offset-key="12093:0" data-first-offset="true"><span data-slate-string="true">)(</span></span></span><span data-slate-object="text" data-key="12094"><span data-slate-leaf="true" data-offset-key="12094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="12095"><span data-slate-leaf="true" data-offset-key="12095:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12096"><span data-slate-leaf="true" data-offset-key="12096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12097"><span data-slate-leaf="true" data-offset-key="12097:0" data-first-offset="true"><span data-slate-string="true">))));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12098"><span data-slate-object="text" data-key="12099"><span data-slate-leaf="true" data-offset-key="12099:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12100"><span data-slate-leaf="true" data-offset-key="12100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12101"><span data-slate-leaf="true" data-offset-key="12101:0" data-first-offset="true"><span data-slate-string="true"> (rettdp == </span></span></span><span data-slate-object="text" data-key="12102"><span data-slate-leaf="true" data-offset-key="12102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12103"><span data-slate-leaf="true" data-offset-key="12103:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12104"><span data-slate-object="text" data-key="12105"><span data-slate-leaf="true" data-offset-key="12105:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12106"><span data-slate-object="text" data-key="12107"><span data-slate-leaf="true" data-offset-key="12107:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12108"><span data-slate-leaf="true" data-offset-key="12108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12109"><span data-slate-leaf="true" data-offset-key="12109:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12110"><span data-slate-leaf="true" data-offset-key="12110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12111"><span data-slate-leaf="true" data-offset-key="12111:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12112"><span data-slate-object="text" data-key="12113"><span data-slate-leaf="true" data-offset-key="12113:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12114"><span data-slate-object="text" data-key="12115"><span data-slate-leaf="true" data-offset-key="12115:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12116"><span data-slate-leaf="true" data-offset-key="12116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化刚刚分配的 thread_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12117"><span data-slate-object="text" data-key="12118"><span data-slate-leaf="true" data-offset-key="12118:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12119"><span data-slate-leaf="true" data-offset-key="12119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t_init</span></span></span></span><span data-slate-object="text" data-key="12120"><span data-slate-leaf="true" data-offset-key="12120:0" data-first-offset="true"><span data-slate-string="true">(rettdp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12121"><span data-slate-object="text" data-key="12122"><span data-slate-leaf="true" data-offset-key="12122:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12123"><span data-slate-leaf="true" data-offset-key="12123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12124"><span data-slate-leaf="true" data-offset-key="12124:0" data-first-offset="true"><span data-slate-string="true"> rettdp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12125"><span data-slate-object="text" data-key="12126"><span data-slate-leaf="true" data-offset-key="12126:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12127"><span data-slate-object="text" data-key="12128"><span data-slate-leaf="true" data-offset-key="12128:0" data-first-offset="true"><span data-slate-string="true">相信凭你现在的能力，上述代码一定是超级简单的。不过我们依然要注意这样几点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12129"><span data-slate-object="text" data-key="12130"><span data-slate-leaf="true" data-offset-key="12130:0" data-first-offset="true"><span data-slate-string="true">首先，我们以 thread_t 结构的地址作为进程的 ID，这个 ID 具有唯一性；其次，我们目前没有为一个进程分配 mmadrsdsc_t 结构体，而是指向了默认的地址空间结构 initmmadrsdsc；最后，hal_retn_cpuid 函数在目前的情况下永远返回 0，这是因为我们使用了一个 CPU。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12131" id="sr-toc-12"><span data-slate-object="text" data-key="12132"><span data-slate-leaf="true" data-offset-key="12132:0" data-first-offset="true"><span data-slate-string="true">初始化内核栈</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12133"><span data-slate-object="text" data-key="12134"><span data-slate-leaf="true" data-offset-key="12134:0" data-first-offset="true"><span data-slate-string="true">为什么要初始化进程的内核栈呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12135"><span data-slate-object="text" data-key="12136"><span data-slate-leaf="true" data-offset-key="12136:0" data-first-offset="true"><span data-slate-string="true">你也许会想，进程的内核栈无非是一块内存，其实只要初始化为 0 就好。当然不是这么简单，我们初始化进程的内核栈，其实是为了在进程的内核栈中放置一份 CPU 的寄存器数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12137"><span data-slate-object="text" data-key="12138"><span data-slate-leaf="true" data-offset-key="12138:0" data-first-offset="true"><span data-slate-string="true">这份 CPU 寄存器数据是一个进程机器上下文的一部分，当一个进程开始运行时，我们将会使用 “pop” 指令从进程的内核栈中弹出到 CPU 中，这样 CPU 就开始运行进程了，CPU 的一些寄存器是有位置关系的，所以我们要定义一个结构体来操作它们，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12139"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12140"><span data-slate-object="text" data-key="12141"><span data-slate-leaf="true" data-offset-key="12141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="12142"><span data-slate-leaf="true" data-offset-key="12142:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12143"><span data-slate-leaf="true" data-offset-key="12143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12144"><span data-slate-leaf="true" data-offset-key="12144:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12145"><span data-slate-leaf="true" data-offset-key="12145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_INTSTKREGS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12146"><span data-slate-object="text" data-key="12147"><span data-slate-leaf="true" data-offset-key="12147:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12148"><span data-slate-object="text" data-key="12149"><span data-slate-leaf="true" data-offset-key="12149:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12150"><span data-slate-leaf="true" data-offset-key="12150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12151"><span data-slate-leaf="true" data-offset-key="12151:0" data-first-offset="true"><span data-slate-string="true"> r_gs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12152"><span data-slate-object="text" data-key="12153"><span data-slate-leaf="true" data-offset-key="12153:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12154"><span data-slate-leaf="true" data-offset-key="12154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12155"><span data-slate-leaf="true" data-offset-key="12155:0" data-first-offset="true"><span data-slate-string="true"> r_fs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12156"><span data-slate-object="text" data-key="12157"><span data-slate-leaf="true" data-offset-key="12157:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12158"><span data-slate-leaf="true" data-offset-key="12158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12159"><span data-slate-leaf="true" data-offset-key="12159:0" data-first-offset="true"><span data-slate-string="true"> r_es;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12160"><span data-slate-object="text" data-key="12161"><span data-slate-leaf="true" data-offset-key="12161:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12162"><span data-slate-leaf="true" data-offset-key="12162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12163"><span data-slate-leaf="true" data-offset-key="12163:0" data-first-offset="true"><span data-slate-string="true"> r_ds;  </span></span></span><span data-slate-object="text" data-key="12164"><span data-slate-leaf="true" data-offset-key="12164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 段寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12165"><span data-slate-object="text" data-key="12166"><span data-slate-leaf="true" data-offset-key="12166:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12167"><span data-slate-leaf="true" data-offset-key="12167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12168"><span data-slate-leaf="true" data-offset-key="12168:0" data-first-offset="true"><span data-slate-string="true"> r_r15;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12169"><span data-slate-object="text" data-key="12170"><span data-slate-leaf="true" data-offset-key="12170:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12171"><span data-slate-leaf="true" data-offset-key="12171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12172"><span data-slate-leaf="true" data-offset-key="12172:0" data-first-offset="true"><span data-slate-string="true"> r_r14;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12173"><span data-slate-object="text" data-key="12174"><span data-slate-leaf="true" data-offset-key="12174:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12175"><span data-slate-leaf="true" data-offset-key="12175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12176"><span data-slate-leaf="true" data-offset-key="12176:0" data-first-offset="true"><span data-slate-string="true"> r_r13;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12177"><span data-slate-object="text" data-key="12178"><span data-slate-leaf="true" data-offset-key="12178:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12179"><span data-slate-leaf="true" data-offset-key="12179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12180"><span data-slate-leaf="true" data-offset-key="12180:0" data-first-offset="true"><span data-slate-string="true"> r_r12;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12181"><span data-slate-object="text" data-key="12182"><span data-slate-leaf="true" data-offset-key="12182:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12183"><span data-slate-leaf="true" data-offset-key="12183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12184"><span data-slate-leaf="true" data-offset-key="12184:0" data-first-offset="true"><span data-slate-string="true"> r_r11;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12185"><span data-slate-object="text" data-key="12186"><span data-slate-leaf="true" data-offset-key="12186:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12187"><span data-slate-leaf="true" data-offset-key="12187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12188"><span data-slate-leaf="true" data-offset-key="12188:0" data-first-offset="true"><span data-slate-string="true"> r_r10;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12189"><span data-slate-object="text" data-key="12190"><span data-slate-leaf="true" data-offset-key="12190:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12191"><span data-slate-leaf="true" data-offset-key="12191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12192"><span data-slate-leaf="true" data-offset-key="12192:0" data-first-offset="true"><span data-slate-string="true"> r_r9;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12193"><span data-slate-object="text" data-key="12194"><span data-slate-leaf="true" data-offset-key="12194:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12195"><span data-slate-leaf="true" data-offset-key="12195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12196"><span data-slate-leaf="true" data-offset-key="12196:0" data-first-offset="true"><span data-slate-string="true"> r_r8;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12197"><span data-slate-object="text" data-key="12198"><span data-slate-leaf="true" data-offset-key="12198:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12199"><span data-slate-leaf="true" data-offset-key="12199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12200"><span data-slate-leaf="true" data-offset-key="12200:0" data-first-offset="true"><span data-slate-string="true"> r_rdi;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12201"><span data-slate-object="text" data-key="12202"><span data-slate-leaf="true" data-offset-key="12202:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12203"><span data-slate-leaf="true" data-offset-key="12203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12204"><span data-slate-leaf="true" data-offset-key="12204:0" data-first-offset="true"><span data-slate-string="true"> r_rsi;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12205"><span data-slate-object="text" data-key="12206"><span data-slate-leaf="true" data-offset-key="12206:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12207"><span data-slate-leaf="true" data-offset-key="12207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12208"><span data-slate-leaf="true" data-offset-key="12208:0" data-first-offset="true"><span data-slate-string="true"> r_rbp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12209"><span data-slate-object="text" data-key="12210"><span data-slate-leaf="true" data-offset-key="12210:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12211"><span data-slate-leaf="true" data-offset-key="12211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12212"><span data-slate-leaf="true" data-offset-key="12212:0" data-first-offset="true"><span data-slate-string="true"> r_rdx; </span></span></span><span data-slate-object="text" data-key="12213"><span data-slate-leaf="true" data-offset-key="12213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通用寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12214"><span data-slate-object="text" data-key="12215"><span data-slate-leaf="true" data-offset-key="12215:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12216"><span data-slate-leaf="true" data-offset-key="12216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12217"><span data-slate-leaf="true" data-offset-key="12217:0" data-first-offset="true"><span data-slate-string="true"> r_rcx;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12218"><span data-slate-object="text" data-key="12219"><span data-slate-leaf="true" data-offset-key="12219:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12220"><span data-slate-leaf="true" data-offset-key="12220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12221"><span data-slate-leaf="true" data-offset-key="12221:0" data-first-offset="true"><span data-slate-string="true"> r_rbx;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12222"><span data-slate-object="text" data-key="12223"><span data-slate-leaf="true" data-offset-key="12223:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12224"><span data-slate-leaf="true" data-offset-key="12224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12225"><span data-slate-leaf="true" data-offset-key="12225:0" data-first-offset="true"><span data-slate-string="true"> r_rax;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12226"><span data-slate-object="text" data-key="12227"><span data-slate-leaf="true" data-offset-key="12227:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12228"><span data-slate-leaf="true" data-offset-key="12228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12229"><span data-slate-leaf="true" data-offset-key="12229:0" data-first-offset="true"><span data-slate-string="true"> r_rip_old;</span></span></span><span data-slate-object="text" data-key="12230"><span data-slate-leaf="true" data-offset-key="12230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 程序的指针寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12231"><span data-slate-object="text" data-key="12232"><span data-slate-leaf="true" data-offset-key="12232:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12233"><span data-slate-leaf="true" data-offset-key="12233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12234"><span data-slate-leaf="true" data-offset-key="12234:0" data-first-offset="true"><span data-slate-string="true"> r_cs_old;</span></span></span><span data-slate-object="text" data-key="12235"><span data-slate-leaf="true" data-offset-key="12235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 代码段寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12236"><span data-slate-object="text" data-key="12237"><span data-slate-leaf="true" data-offset-key="12237:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12238"><span data-slate-leaf="true" data-offset-key="12238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12239"><span data-slate-leaf="true" data-offset-key="12239:0" data-first-offset="true"><span data-slate-string="true"> r_rflgs; </span></span></span><span data-slate-object="text" data-key="12240"><span data-slate-leaf="true" data-offset-key="12240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rflags 标志寄存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12241"><span data-slate-object="text" data-key="12242"><span data-slate-leaf="true" data-offset-key="12242:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12243"><span data-slate-leaf="true" data-offset-key="12243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12244"><span data-slate-leaf="true" data-offset-key="12244:0" data-first-offset="true"><span data-slate-string="true"> r_rsp_old;</span></span></span><span data-slate-object="text" data-key="12245"><span data-slate-leaf="true" data-offset-key="12245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 栈指针寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12246"><span data-slate-object="text" data-key="12247"><span data-slate-leaf="true" data-offset-key="12247:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12248"><span data-slate-leaf="true" data-offset-key="12248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12249"><span data-slate-leaf="true" data-offset-key="12249:0" data-first-offset="true"><span data-slate-string="true"> r_ss_old; </span></span></span><span data-slate-object="text" data-key="12250"><span data-slate-leaf="true" data-offset-key="12250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 栈段寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12251"><span data-slate-object="text" data-key="12252"><span data-slate-leaf="true" data-offset-key="12252:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="12253"><span data-slate-leaf="true" data-offset-key="12253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intstkregs_t</span></span></span></span><span data-slate-object="text" data-key="12254"><span data-slate-leaf="true" data-offset-key="12254:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12255"><span data-slate-object="text" data-key="12256"><span data-slate-leaf="true" data-offset-key="12256:0" data-first-offset="true"><span data-slate-string="true">intstkregs_t 结构中，每个字段都是 8 字节 64 位的，因为 x86 CPU 在长模式下 rsp 栈指针寄存器始终 8 字节对齐。栈是向下伸长的（从高地址向低地址）所以这个结构是反向定义（相对于栈）如果你不理解这个寄存器位置，可以回到中断处理</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12257"><span data-slate-object="text" data-key="12258"><span data-slate-leaf="true" data-offset-key="12258:0" data-first-offset="true"><span data-slate-string="true">那节课</span></span></span></a><span data-slate-object="text" data-key="12259"><span data-slate-leaf="true" data-offset-key="12259:0" data-first-offset="true"><span data-slate-string="true">复习一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12260"><span data-slate-object="text" data-key="12261"><span data-slate-leaf="true" data-offset-key="12261:0" data-first-offset="true"><span data-slate-string="true">intstkregs_t 结构已经定义好了，下面我们来写代码初始化内核栈，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="12262"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12263"><span data-slate-object="text" data-key="12264"><span data-slate-leaf="true" data-offset-key="12264:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="12265"><span data-slate-leaf="true" data-offset-key="12265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlthread_kernstack_init</span></span></span></span><span data-slate-object="text" data-key="12266"><span data-slate-leaf="true" data-offset-key="12266:0" data-first-offset="true"><span data-slate-string="true">(thread_t *thdp, void *runadr, uint_t cpuflags)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12267"><span data-slate-object="text" data-key="12268"><span data-slate-leaf="true" data-offset-key="12268:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12269"><span data-slate-object="text" data-key="12270"><span data-slate-leaf="true" data-offset-key="12270:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12271"><span data-slate-leaf="true" data-offset-key="12271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理栈顶 16 字节对齐</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12272"><span data-slate-object="text" data-key="12273"><span data-slate-leaf="true" data-offset-key="12273:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12274"><span data-slate-leaf="true" data-offset-key="12274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12275"><span data-slate-leaf="true" data-offset-key="12275:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop &amp;= (~</span></span></span><span data-slate-object="text" data-key="12276"><span data-slate-leaf="true" data-offset-key="12276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xf</span></span></span></span><span data-slate-object="text" data-key="12277"><span data-slate-leaf="true" data-offset-key="12277:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12278"><span data-slate-object="text" data-key="12279"><span data-slate-leaf="true" data-offset-key="12279:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12280"><span data-slate-leaf="true" data-offset-key="12280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12281"><span data-slate-leaf="true" data-offset-key="12281:0" data-first-offset="true"><span data-slate-string="true">td_usrstktop &amp;= (~</span></span></span><span data-slate-object="text" data-key="12282"><span data-slate-leaf="true" data-offset-key="12282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xf</span></span></span></span><span data-slate-object="text" data-key="12283"><span data-slate-leaf="true" data-offset-key="12283:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12284"><span data-slate-object="text" data-key="12285"><span data-slate-leaf="true" data-offset-key="12285:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12286"><span data-slate-leaf="true" data-offset-key="12286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内核栈顶减去 intstkregs_t 结构的大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12287"><span data-slate-object="text" data-key="12288"><span data-slate-leaf="true" data-offset-key="12288:0" data-first-offset="true"><span data-slate-string="true">    intstkregs_t *arp = (intstkregs_t *)(thdp</span></span></span><span data-slate-object="text" data-key="12289"><span data-slate-leaf="true" data-offset-key="12289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12290"><span data-slate-leaf="true" data-offset-key="12290:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop - </span></span></span><span data-slate-object="text" data-key="12291"><span data-slate-leaf="true" data-offset-key="12291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="12292"><span data-slate-leaf="true" data-offset-key="12292:0" data-first-offset="true"><span data-slate-string="true">(intstkregs_t));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12293"><span data-slate-object="text" data-key="12294"><span data-slate-leaf="true" data-offset-key="12294:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12295"><span data-slate-leaf="true" data-offset-key="12295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 intstkregs_t 结构的空间初始化为 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12296"><span data-slate-object="text" data-key="12297"><span data-slate-leaf="true" data-offset-key="12297:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12298"><span data-slate-leaf="true" data-offset-key="12298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_memset</span></span></span></span><span data-slate-object="text" data-key="12299"><span data-slate-leaf="true" data-offset-key="12299:0" data-first-offset="true"><span data-slate-string="true">((void*)arp, </span></span></span><span data-slate-object="text" data-key="12300"><span data-slate-leaf="true" data-offset-key="12300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12301"><span data-slate-leaf="true" data-offset-key="12301:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12302"><span data-slate-leaf="true" data-offset-key="12302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="12303"><span data-slate-leaf="true" data-offset-key="12303:0" data-first-offset="true"><span data-slate-string="true">(intstkregs_t));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12304"><span data-slate-object="text" data-key="12305"><span data-slate-leaf="true" data-offset-key="12305:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12306"><span data-slate-leaf="true" data-offset-key="12306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rip 寄存器的值设为程序运行首地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12307"><span data-slate-object="text" data-key="12308"><span data-slate-leaf="true" data-offset-key="12308:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12309"><span data-slate-leaf="true" data-offset-key="12309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12310"><span data-slate-leaf="true" data-offset-key="12310:0" data-first-offset="true"><span data-slate-string="true">r_rip_old = (uint_t)runadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12311"><span data-slate-object="text" data-key="12312"><span data-slate-leaf="true" data-offset-key="12312:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12313"><span data-slate-leaf="true" data-offset-key="12313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cs 寄存器的值设为内核代码段选择子 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12314"><span data-slate-object="text" data-key="12315"><span data-slate-leaf="true" data-offset-key="12315:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12316"><span data-slate-leaf="true" data-offset-key="12316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12317"><span data-slate-leaf="true" data-offset-key="12317:0" data-first-offset="true"><span data-slate-string="true">r_cs_old = K_CS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12318"><span data-slate-object="text" data-key="12319"><span data-slate-leaf="true" data-offset-key="12319:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12320"><span data-slate-leaf="true" data-offset-key="12320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12321"><span data-slate-leaf="true" data-offset-key="12321:0" data-first-offset="true"><span data-slate-string="true">r_rflgs = cpuflags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12322"><span data-slate-object="text" data-key="12323"><span data-slate-leaf="true" data-offset-key="12323:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12324"><span data-slate-leaf="true" data-offset-key="12324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回进程的内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12325"><span data-slate-object="text" data-key="12326"><span data-slate-leaf="true" data-offset-key="12326:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12327"><span data-slate-leaf="true" data-offset-key="12327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12328"><span data-slate-leaf="true" data-offset-key="12328:0" data-first-offset="true"><span data-slate-string="true">r_rsp_old = thdp</span></span></span><span data-slate-object="text" data-key="12329"><span data-slate-leaf="true" data-offset-key="12329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12330"><span data-slate-leaf="true" data-offset-key="12330:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12331"><span data-slate-object="text" data-key="12332"><span data-slate-leaf="true" data-offset-key="12332:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12333"><span data-slate-leaf="true" data-offset-key="12333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12334"><span data-slate-leaf="true" data-offset-key="12334:0" data-first-offset="true"><span data-slate-string="true">r_ss_old = </span></span></span><span data-slate-object="text" data-key="12335"><span data-slate-leaf="true" data-offset-key="12335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12336"><span data-slate-leaf="true" data-offset-key="12336:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12337"><span data-slate-object="text" data-key="12338"><span data-slate-leaf="true" data-offset-key="12338:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12339"><span data-slate-leaf="true" data-offset-key="12339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 其它段寄存器的值设为内核数据段选择子</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12340"><span data-slate-object="text" data-key="12341"><span data-slate-leaf="true" data-offset-key="12341:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12342"><span data-slate-leaf="true" data-offset-key="12342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12343"><span data-slate-leaf="true" data-offset-key="12343:0" data-first-offset="true"><span data-slate-string="true">r_ds = K_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12344"><span data-slate-object="text" data-key="12345"><span data-slate-leaf="true" data-offset-key="12345:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12346"><span data-slate-leaf="true" data-offset-key="12346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12347"><span data-slate-leaf="true" data-offset-key="12347:0" data-first-offset="true"><span data-slate-string="true">r_es = K_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12348"><span data-slate-object="text" data-key="12349"><span data-slate-leaf="true" data-offset-key="12349:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12350"><span data-slate-leaf="true" data-offset-key="12350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12351"><span data-slate-leaf="true" data-offset-key="12351:0" data-first-offset="true"><span data-slate-string="true">r_fs = K_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12352"><span data-slate-object="text" data-key="12353"><span data-slate-leaf="true" data-offset-key="12353:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12354"><span data-slate-leaf="true" data-offset-key="12354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12355"><span data-slate-leaf="true" data-offset-key="12355:0" data-first-offset="true"><span data-slate-string="true">r_gs = K_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12356"><span data-slate-object="text" data-key="12357"><span data-slate-leaf="true" data-offset-key="12357:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12358"><span data-slate-leaf="true" data-offset-key="12358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程下一次运行的地址为 runadr</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12359"><span data-slate-object="text" data-key="12360"><span data-slate-leaf="true" data-offset-key="12360:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12361"><span data-slate-leaf="true" data-offset-key="12361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12362"><span data-slate-leaf="true" data-offset-key="12362:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nextrip = (uint_t)runadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12363"><span data-slate-object="text" data-key="12364"><span data-slate-leaf="true" data-offset-key="12364:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12365"><span data-slate-leaf="true" data-offset-key="12365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程下一次运行的栈地址为 arp</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12366"><span data-slate-object="text" data-key="12367"><span data-slate-leaf="true" data-offset-key="12367:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12368"><span data-slate-leaf="true" data-offset-key="12368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12369"><span data-slate-leaf="true" data-offset-key="12369:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nextrsp = (uint_t)arp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12370"><span data-slate-object="text" data-key="12371"><span data-slate-leaf="true" data-offset-key="12371:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12372"><span data-slate-leaf="true" data-offset-key="12372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12373"><span data-slate-leaf="true" data-offset-key="12373:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12374"><span data-slate-object="text" data-key="12375"><span data-slate-leaf="true" data-offset-key="12375:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12376"><span data-slate-object="text" data-key="12377"><span data-slate-leaf="true" data-offset-key="12377:0" data-first-offset="true"><span data-slate-string="true">上述代码没什么难点，就是第 7 行我要给你解释一下，arp 为什么要用内核栈顶地址减去 intstkregs_t 结构的大小呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12378"><span data-slate-object="text" data-key="12379"><span data-slate-leaf="true" data-offset-key="12379:0" data-first-offset="true"><span data-slate-string="true">C 语言处理结构体时，从结构体第一个字段到最后一个字段，这些字段的地址是从下向上（地址从低到高）伸长的，而栈正好相反，所以要减去 intstkregs_t 结构的大小，为 intstkregs_t 结构腾出空间，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12380"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/06/ba/06504e64c34ff37794b259ecbd4364ba.jpg?wh=3550x3005"></div><div>内核态进程结构</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12381"><span data-slate-object="text" data-key="12382"><span data-slate-leaf="true" data-offset-key="12382:0" data-first-offset="true"><span data-slate-string="true">因为我们建立的是内核态进程，所以上面初始化的内核栈是不能返回到进程的应用程序空间的。而如果要返回到进程的应用程序空间中，内核栈中的内容是不同的，但是内核栈结构却一样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12383"><span data-slate-object="text" data-key="12384"><span data-slate-leaf="true" data-offset-key="12384:0" data-first-offset="true"><span data-slate-string="true">下面我们动手写代码，初始化返回进程应用程序空间的内核栈。请注意，初始化的还是内核栈，只是内容不同，代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="12385"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12386"><span data-slate-object="text" data-key="12387"><span data-slate-leaf="true" data-offset-key="12387:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="12388"><span data-slate-leaf="true" data-offset-key="12388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlthread_userstack_init</span></span></span></span><span data-slate-object="text" data-key="12389"><span data-slate-leaf="true" data-offset-key="12389:0" data-first-offset="true"><span data-slate-string="true">(thread_t *thdp, void *runadr, uint_t cpuflags)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12390"><span data-slate-object="text" data-key="12391"><span data-slate-leaf="true" data-offset-key="12391:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12392"><span data-slate-object="text" data-key="12393"><span data-slate-leaf="true" data-offset-key="12393:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12394"><span data-slate-leaf="true" data-offset-key="12394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理栈顶 16 字节对齐</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12395"><span data-slate-object="text" data-key="12396"><span data-slate-leaf="true" data-offset-key="12396:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12397"><span data-slate-leaf="true" data-offset-key="12397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12398"><span data-slate-leaf="true" data-offset-key="12398:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop &amp;= (~</span></span></span><span data-slate-object="text" data-key="12399"><span data-slate-leaf="true" data-offset-key="12399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xf</span></span></span></span><span data-slate-object="text" data-key="12400"><span data-slate-leaf="true" data-offset-key="12400:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12401"><span data-slate-object="text" data-key="12402"><span data-slate-leaf="true" data-offset-key="12402:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12403"><span data-slate-leaf="true" data-offset-key="12403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12404"><span data-slate-leaf="true" data-offset-key="12404:0" data-first-offset="true"><span data-slate-string="true">td_usrstktop &amp;= (~</span></span></span><span data-slate-object="text" data-key="12405"><span data-slate-leaf="true" data-offset-key="12405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xf</span></span></span></span><span data-slate-object="text" data-key="12406"><span data-slate-leaf="true" data-offset-key="12406:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12407"><span data-slate-object="text" data-key="12408"><span data-slate-leaf="true" data-offset-key="12408:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12409"><span data-slate-leaf="true" data-offset-key="12409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内核栈顶减去 intstkregs_t 结构的大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12410"><span data-slate-object="text" data-key="12411"><span data-slate-leaf="true" data-offset-key="12411:0" data-first-offset="true"><span data-slate-string="true">    intstkregs_t *arp = (intstkregs_t *)(thdp</span></span></span><span data-slate-object="text" data-key="12412"><span data-slate-leaf="true" data-offset-key="12412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12413"><span data-slate-leaf="true" data-offset-key="12413:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop - </span></span></span><span data-slate-object="text" data-key="12414"><span data-slate-leaf="true" data-offset-key="12414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="12415"><span data-slate-leaf="true" data-offset-key="12415:0" data-first-offset="true"><span data-slate-string="true">(intstkregs_t));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12416"><span data-slate-object="text" data-key="12417"><span data-slate-leaf="true" data-offset-key="12417:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12418"><span data-slate-leaf="true" data-offset-key="12418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 intstkregs_t 结构的空间初始化为 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12419"><span data-slate-object="text" data-key="12420"><span data-slate-leaf="true" data-offset-key="12420:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12421"><span data-slate-leaf="true" data-offset-key="12421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_memset</span></span></span></span><span data-slate-object="text" data-key="12422"><span data-slate-leaf="true" data-offset-key="12422:0" data-first-offset="true"><span data-slate-string="true">((void*)arp, </span></span></span><span data-slate-object="text" data-key="12423"><span data-slate-leaf="true" data-offset-key="12423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12424"><span data-slate-leaf="true" data-offset-key="12424:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12425"><span data-slate-leaf="true" data-offset-key="12425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="12426"><span data-slate-leaf="true" data-offset-key="12426:0" data-first-offset="true"><span data-slate-string="true">(intstkregs_t));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12427"><span data-slate-object="text" data-key="12428"><span data-slate-leaf="true" data-offset-key="12428:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12429"><span data-slate-leaf="true" data-offset-key="12429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rip 寄存器的值设为程序运行首地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12430"><span data-slate-object="text" data-key="12431"><span data-slate-leaf="true" data-offset-key="12431:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12432"><span data-slate-leaf="true" data-offset-key="12432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12433"><span data-slate-leaf="true" data-offset-key="12433:0" data-first-offset="true"><span data-slate-string="true">r_rip_old = (uint_t)runadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12434"><span data-slate-object="text" data-key="12435"><span data-slate-leaf="true" data-offset-key="12435:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12436"><span data-slate-leaf="true" data-offset-key="12436:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cs 寄存器的值设为应用程序代码段选择子 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12437"><span data-slate-object="text" data-key="12438"><span data-slate-leaf="true" data-offset-key="12438:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12439"><span data-slate-leaf="true" data-offset-key="12439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12440"><span data-slate-leaf="true" data-offset-key="12440:0" data-first-offset="true"><span data-slate-string="true">r_cs_old = U_CS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12441"><span data-slate-object="text" data-key="12442"><span data-slate-leaf="true" data-offset-key="12442:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12443"><span data-slate-leaf="true" data-offset-key="12443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12444"><span data-slate-leaf="true" data-offset-key="12444:0" data-first-offset="true"><span data-slate-string="true">r_rflgs = cpuflags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12445"><span data-slate-object="text" data-key="12446"><span data-slate-leaf="true" data-offset-key="12446:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12447"><span data-slate-leaf="true" data-offset-key="12447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回进程应用程序空间的栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12448"><span data-slate-object="text" data-key="12449"><span data-slate-leaf="true" data-offset-key="12449:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12450"><span data-slate-leaf="true" data-offset-key="12450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12451"><span data-slate-leaf="true" data-offset-key="12451:0" data-first-offset="true"><span data-slate-string="true">r_rsp_old = thdp</span></span></span><span data-slate-object="text" data-key="12452"><span data-slate-leaf="true" data-offset-key="12452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12453"><span data-slate-leaf="true" data-offset-key="12453:0" data-first-offset="true"><span data-slate-string="true">td_usrstktop;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12454"><span data-slate-object="text" data-key="12455"><span data-slate-leaf="true" data-offset-key="12455:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12456"><span data-slate-leaf="true" data-offset-key="12456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 其它段寄存器的值设为应用程序数据段选择子</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12457"><span data-slate-object="text" data-key="12458"><span data-slate-leaf="true" data-offset-key="12458:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12459"><span data-slate-leaf="true" data-offset-key="12459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12460"><span data-slate-leaf="true" data-offset-key="12460:0" data-first-offset="true"><span data-slate-string="true">r_ss_old = U_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12461"><span data-slate-object="text" data-key="12462"><span data-slate-leaf="true" data-offset-key="12462:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12463"><span data-slate-leaf="true" data-offset-key="12463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12464"><span data-slate-leaf="true" data-offset-key="12464:0" data-first-offset="true"><span data-slate-string="true">r_ds = U_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12465"><span data-slate-object="text" data-key="12466"><span data-slate-leaf="true" data-offset-key="12466:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12467"><span data-slate-leaf="true" data-offset-key="12467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12468"><span data-slate-leaf="true" data-offset-key="12468:0" data-first-offset="true"><span data-slate-string="true">r_es = U_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12469"><span data-slate-object="text" data-key="12470"><span data-slate-leaf="true" data-offset-key="12470:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12471"><span data-slate-leaf="true" data-offset-key="12471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12472"><span data-slate-leaf="true" data-offset-key="12472:0" data-first-offset="true"><span data-slate-string="true">r_fs = U_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12473"><span data-slate-object="text" data-key="12474"><span data-slate-leaf="true" data-offset-key="12474:0" data-first-offset="true"><span data-slate-string="true">    arp</span></span></span><span data-slate-object="text" data-key="12475"><span data-slate-leaf="true" data-offset-key="12475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12476"><span data-slate-leaf="true" data-offset-key="12476:0" data-first-offset="true"><span data-slate-string="true">r_gs = U_DS_IDX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12477"><span data-slate-object="text" data-key="12478"><span data-slate-leaf="true" data-offset-key="12478:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12479"><span data-slate-leaf="true" data-offset-key="12479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程下一次运行的地址为 runadr</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12480"><span data-slate-object="text" data-key="12481"><span data-slate-leaf="true" data-offset-key="12481:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12482"><span data-slate-leaf="true" data-offset-key="12482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12483"><span data-slate-leaf="true" data-offset-key="12483:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nextrip = (uint_t)runadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12484"><span data-slate-object="text" data-key="12485"><span data-slate-leaf="true" data-offset-key="12485:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12486"><span data-slate-leaf="true" data-offset-key="12486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程下一次运行的栈地址为 arp</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12487"><span data-slate-object="text" data-key="12488"><span data-slate-leaf="true" data-offset-key="12488:0" data-first-offset="true"><span data-slate-string="true">    thdp</span></span></span><span data-slate-object="text" data-key="12489"><span data-slate-leaf="true" data-offset-key="12489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12490"><span data-slate-leaf="true" data-offset-key="12490:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nextrsp = (uint_t)arp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12491"><span data-slate-object="text" data-key="12492"><span data-slate-leaf="true" data-offset-key="12492:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12493"><span data-slate-leaf="true" data-offset-key="12493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12494"><span data-slate-leaf="true" data-offset-key="12494:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12495"><span data-slate-object="text" data-key="12496"><span data-slate-leaf="true" data-offset-key="12496:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12497"><span data-slate-object="text" data-key="12498"><span data-slate-leaf="true" data-offset-key="12498:0" data-first-offset="true"><span data-slate-string="true">上述代码中初始化进程的内核栈，所使用的段选择子指向的是应用程序的代码段和数据段，这个代码段和数据段它们特权级为 R3，CPU 正是根据这个代码段、数据段选择子来切换 CPU 工作特权级的。这样，CPU 的执行流就可以返回到进程的应用程序空间了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12499" id="sr-toc-13"><span data-slate-object="text" data-key="12500"><span data-slate-leaf="true" data-offset-key="12500:0" data-first-offset="true"><span data-slate-string="true">建立普通进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12501"><span data-slate-object="text" data-key="12502"><span data-slate-leaf="true" data-offset-key="12502:0" data-first-offset="true"><span data-slate-string="true">在建立进程的接口函数 krlnew_thread 的流程中，会根据参数 flg 的值，选择调用不同的函数，来建立不同类型的进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12503"><span data-slate-object="text" data-key="12504"><span data-slate-leaf="true" data-offset-key="12504:0" data-first-offset="true"><span data-slate-string="true">前面我们已经写好了建立内核进程的函数，接下来我们还要写好建立普通进程的函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12505"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12506"><span data-slate-object="text" data-key="12507"><span data-slate-leaf="true" data-offset-key="12507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="12508"><span data-slate-leaf="true" data-offset-key="12508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="12509"><span data-slate-leaf="true" data-offset-key="12509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_user_thread_core</span></span></span></span></span><span data-slate-object="text" data-key="12510"><span data-slate-leaf="true" data-offset-key="12510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12511"><span data-slate-leaf="true" data-offset-key="12511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12512"><span data-slate-leaf="true" data-offset-key="12512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *filerun, </span></span></span></span></span><span data-slate-object="text" data-key="12513"><span data-slate-leaf="true" data-offset-key="12513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12514"><span data-slate-leaf="true" data-offset-key="12514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> flg, </span></span></span></span></span><span data-slate-object="text" data-key="12515"><span data-slate-leaf="true" data-offset-key="12515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12516"><span data-slate-leaf="true" data-offset-key="12516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> prilg, </span></span></span></span></span><span data-slate-object="text" data-key="12517"><span data-slate-leaf="true" data-offset-key="12517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12518"><span data-slate-leaf="true" data-offset-key="12518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> prity, </span></span></span></span></span><span data-slate-object="text" data-key="12519"><span data-slate-leaf="true" data-offset-key="12519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12520"><span data-slate-leaf="true" data-offset-key="12520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> usrstksz, </span></span></span></span></span><span data-slate-object="text" data-key="12521"><span data-slate-leaf="true" data-offset-key="12521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12522"><span data-slate-leaf="true" data-offset-key="12522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> krlstksz)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12523"><span data-slate-object="text" data-key="12524"><span data-slate-leaf="true" data-offset-key="12524:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12525"><span data-slate-object="text" data-key="12526"><span data-slate-leaf="true" data-offset-key="12526:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12527"><span data-slate-leaf="true" data-offset-key="12527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12528"><span data-slate-leaf="true" data-offset-key="12528:0" data-first-offset="true"><span data-slate-string="true"> *ret_td = </span></span></span><span data-slate-object="text" data-key="12529"><span data-slate-leaf="true" data-offset-key="12529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12530"><span data-slate-leaf="true" data-offset-key="12530:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12531"><span data-slate-object="text" data-key="12532"><span data-slate-leaf="true" data-offset-key="12532:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12533"><span data-slate-leaf="true" data-offset-key="12533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool_t</span></span></span></span><span data-slate-object="text" data-key="12534"><span data-slate-leaf="true" data-offset-key="12534:0" data-first-offset="true"><span data-slate-string="true"> acs = FALSE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12535"><span data-slate-object="text" data-key="12536"><span data-slate-leaf="true" data-offset-key="12536:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12537"><span data-slate-leaf="true" data-offset-key="12537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="12538"><span data-slate-leaf="true" data-offset-key="12538:0" data-first-offset="true"><span data-slate-string="true"> usrstkadr = </span></span></span><span data-slate-object="text" data-key="12539"><span data-slate-leaf="true" data-offset-key="12539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12540"><span data-slate-leaf="true" data-offset-key="12540:0" data-first-offset="true"><span data-slate-string="true">, krlstkadr = </span></span></span><span data-slate-object="text" data-key="12541"><span data-slate-leaf="true" data-offset-key="12541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12542"><span data-slate-leaf="true" data-offset-key="12542:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12543"><span data-slate-object="text" data-key="12544"><span data-slate-leaf="true" data-offset-key="12544:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12545"><span data-slate-leaf="true" data-offset-key="12545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配应用程序栈空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12546"><span data-slate-object="text" data-key="12547"><span data-slate-leaf="true" data-offset-key="12547:0" data-first-offset="true"><span data-slate-string="true">    usrstkadr = </span></span></span><span data-slate-object="text" data-key="12548"><span data-slate-leaf="true" data-offset-key="12548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="12549"><span data-slate-leaf="true" data-offset-key="12549:0" data-first-offset="true"><span data-slate-string="true">(usrstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12550"><span data-slate-object="text" data-key="12551"><span data-slate-leaf="true" data-offset-key="12551:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12552"><span data-slate-leaf="true" data-offset-key="12552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12553"><span data-slate-leaf="true" data-offset-key="12553:0" data-first-offset="true"><span data-slate-string="true"> (usrstkadr == </span></span></span><span data-slate-object="text" data-key="12554"><span data-slate-leaf="true" data-offset-key="12554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12555"><span data-slate-leaf="true" data-offset-key="12555:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12556"><span data-slate-object="text" data-key="12557"><span data-slate-leaf="true" data-offset-key="12557:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12558"><span data-slate-object="text" data-key="12559"><span data-slate-leaf="true" data-offset-key="12559:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12560"><span data-slate-leaf="true" data-offset-key="12560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12561"><span data-slate-leaf="true" data-offset-key="12561:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12562"><span data-slate-leaf="true" data-offset-key="12562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12563"><span data-slate-leaf="true" data-offset-key="12563:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12564"><span data-slate-object="text" data-key="12565"><span data-slate-leaf="true" data-offset-key="12565:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12566"><span data-slate-object="text" data-key="12567"><span data-slate-leaf="true" data-offset-key="12567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12568"><span data-slate-leaf="true" data-offset-key="12568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配内核栈空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12569"><span data-slate-object="text" data-key="12570"><span data-slate-leaf="true" data-offset-key="12570:0" data-first-offset="true"><span data-slate-string="true">    krlstkadr = </span></span></span><span data-slate-object="text" data-key="12571"><span data-slate-leaf="true" data-offset-key="12571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="12572"><span data-slate-leaf="true" data-offset-key="12572:0" data-first-offset="true"><span data-slate-string="true">(krlstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12573"><span data-slate-object="text" data-key="12574"><span data-slate-leaf="true" data-offset-key="12574:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12575"><span data-slate-leaf="true" data-offset-key="12575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12576"><span data-slate-leaf="true" data-offset-key="12576:0" data-first-offset="true"><span data-slate-string="true"> (krlstkadr == </span></span></span><span data-slate-object="text" data-key="12577"><span data-slate-leaf="true" data-offset-key="12577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12578"><span data-slate-leaf="true" data-offset-key="12578:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12579"><span data-slate-object="text" data-key="12580"><span data-slate-leaf="true" data-offset-key="12580:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12581"><span data-slate-object="text" data-key="12582"><span data-slate-leaf="true" data-offset-key="12582:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12583"><span data-slate-leaf="true" data-offset-key="12583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12584"><span data-slate-leaf="true" data-offset-key="12584:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="12585"><span data-slate-leaf="true" data-offset-key="12585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="12586"><span data-slate-leaf="true" data-offset-key="12586:0" data-first-offset="true"><span data-slate-string="true">(usrstkadr, usrstksz) == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12587"><span data-slate-object="text" data-key="12588"><span data-slate-leaf="true" data-offset-key="12588:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12589"><span data-slate-object="text" data-key="12590"><span data-slate-leaf="true" data-offset-key="12590:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="12591"><span data-slate-leaf="true" data-offset-key="12591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12592"><span data-slate-leaf="true" data-offset-key="12592:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12593"><span data-slate-leaf="true" data-offset-key="12593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12594"><span data-slate-leaf="true" data-offset-key="12594:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12595"><span data-slate-object="text" data-key="12596"><span data-slate-leaf="true" data-offset-key="12596:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12597"><span data-slate-object="text" data-key="12598"><span data-slate-leaf="true" data-offset-key="12598:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12599"><span data-slate-leaf="true" data-offset-key="12599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12600"><span data-slate-leaf="true" data-offset-key="12600:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12601"><span data-slate-leaf="true" data-offset-key="12601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12602"><span data-slate-leaf="true" data-offset-key="12602:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12603"><span data-slate-object="text" data-key="12604"><span data-slate-leaf="true" data-offset-key="12604:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12605"><span data-slate-object="text" data-key="12606"><span data-slate-leaf="true" data-offset-key="12606:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12607"><span data-slate-leaf="true" data-offset-key="12607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 thread_t 结构体的实例变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12608"><span data-slate-object="text" data-key="12609"><span data-slate-leaf="true" data-offset-key="12609:0" data-first-offset="true"><span data-slate-string="true">    ret_td = </span></span></span><span data-slate-object="text" data-key="12610"><span data-slate-leaf="true" data-offset-key="12610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_thread_dsc</span></span></span></span><span data-slate-object="text" data-key="12611"><span data-slate-leaf="true" data-offset-key="12611:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12612"><span data-slate-object="text" data-key="12613"><span data-slate-leaf="true" data-offset-key="12613:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12614"><span data-slate-leaf="true" data-offset-key="12614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建失败必须要释放之前的栈空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12615"><span data-slate-object="text" data-key="12616"><span data-slate-leaf="true" data-offset-key="12616:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12617"><span data-slate-leaf="true" data-offset-key="12617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12618"><span data-slate-leaf="true" data-offset-key="12618:0" data-first-offset="true"><span data-slate-string="true"> (ret_td == </span></span></span><span data-slate-object="text" data-key="12619"><span data-slate-leaf="true" data-offset-key="12619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12620"><span data-slate-leaf="true" data-offset-key="12620:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12621"><span data-slate-object="text" data-key="12622"><span data-slate-leaf="true" data-offset-key="12622:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12623"><span data-slate-object="text" data-key="12624"><span data-slate-leaf="true" data-offset-key="12624:0" data-first-offset="true"><span data-slate-string="true">        acs = </span></span></span><span data-slate-object="text" data-key="12625"><span data-slate-leaf="true" data-offset-key="12625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="12626"><span data-slate-leaf="true" data-offset-key="12626:0" data-first-offset="true"><span data-slate-string="true">(usrstkadr, usrstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12627"><span data-slate-object="text" data-key="12628"><span data-slate-leaf="true" data-offset-key="12628:0" data-first-offset="true"><span data-slate-string="true">        acs = </span></span></span><span data-slate-object="text" data-key="12629"><span data-slate-leaf="true" data-offset-key="12629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="12630"><span data-slate-leaf="true" data-offset-key="12630:0" data-first-offset="true"><span data-slate-string="true">(krlstkadr, krlstksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12631"><span data-slate-object="text" data-key="12632"><span data-slate-leaf="true" data-offset-key="12632:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12633"><span data-slate-leaf="true" data-offset-key="12633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12634"><span data-slate-leaf="true" data-offset-key="12634:0" data-first-offset="true"><span data-slate-string="true"> (acs == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12635"><span data-slate-object="text" data-key="12636"><span data-slate-leaf="true" data-offset-key="12636:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12637"><span data-slate-object="text" data-key="12638"><span data-slate-leaf="true" data-offset-key="12638:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="12639"><span data-slate-leaf="true" data-offset-key="12639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12640"><span data-slate-leaf="true" data-offset-key="12640:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12641"><span data-slate-leaf="true" data-offset-key="12641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12642"><span data-slate-leaf="true" data-offset-key="12642:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12643"><span data-slate-object="text" data-key="12644"><span data-slate-leaf="true" data-offset-key="12644:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12645"><span data-slate-object="text" data-key="12646"><span data-slate-leaf="true" data-offset-key="12646:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12647"><span data-slate-leaf="true" data-offset-key="12647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12648"><span data-slate-leaf="true" data-offset-key="12648:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12649"><span data-slate-leaf="true" data-offset-key="12649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12650"><span data-slate-leaf="true" data-offset-key="12650:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12651"><span data-slate-object="text" data-key="12652"><span data-slate-leaf="true" data-offset-key="12652:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12653"><span data-slate-object="text" data-key="12654"><span data-slate-leaf="true" data-offset-key="12654:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12655"><span data-slate-leaf="true" data-offset-key="12655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程权限 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12656"><span data-slate-object="text" data-key="12657"><span data-slate-leaf="true" data-offset-key="12657:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_privilege = prilg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12658"><span data-slate-object="text" data-key="12659"><span data-slate-leaf="true" data-offset-key="12659:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12660"><span data-slate-leaf="true" data-offset-key="12660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12661"><span data-slate-object="text" data-key="12662"><span data-slate-leaf="true" data-offset-key="12662:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_priority = prity;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12663"><span data-slate-object="text" data-key="12664"><span data-slate-leaf="true" data-offset-key="12664:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12665"><span data-slate-leaf="true" data-offset-key="12665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程的内核栈顶和内核栈开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12666"><span data-slate-object="text" data-key="12667"><span data-slate-leaf="true" data-offset-key="12667:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_krlstktop = krlstkadr + (</span></span></span><span data-slate-object="text" data-key="12668"><span data-slate-leaf="true" data-offset-key="12668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="12669"><span data-slate-leaf="true" data-offset-key="12669:0" data-first-offset="true"><span data-slate-string="true">)(krlstksz - </span></span></span><span data-slate-object="text" data-key="12670"><span data-slate-leaf="true" data-offset-key="12670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="12671"><span data-slate-leaf="true" data-offset-key="12671:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12672"><span data-slate-object="text" data-key="12673"><span data-slate-leaf="true" data-offset-key="12673:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_krlstkstart = krlstkadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12674"><span data-slate-object="text" data-key="12675"><span data-slate-leaf="true" data-offset-key="12675:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12676"><span data-slate-leaf="true" data-offset-key="12676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程的应用程序栈顶和内核应用程序栈开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12677"><span data-slate-object="text" data-key="12678"><span data-slate-leaf="true" data-offset-key="12678:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_usrstktop = usrstkadr + (</span></span></span><span data-slate-object="text" data-key="12679"><span data-slate-leaf="true" data-offset-key="12679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="12680"><span data-slate-leaf="true" data-offset-key="12680:0" data-first-offset="true"><span data-slate-string="true">)(usrstksz - </span></span></span><span data-slate-object="text" data-key="12681"><span data-slate-leaf="true" data-offset-key="12681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="12682"><span data-slate-leaf="true" data-offset-key="12682:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12683"><span data-slate-object="text" data-key="12684"><span data-slate-leaf="true" data-offset-key="12684:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_usrstkstart = usrstkadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12685"><span data-slate-object="text" data-key="12686"><span data-slate-leaf="true" data-offset-key="12686:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12687"><span data-slate-leaf="true" data-offset-key="12687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化返回进程应用程序空间的内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12688"><span data-slate-object="text" data-key="12689"><span data-slate-leaf="true" data-offset-key="12689:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12690"><span data-slate-leaf="true" data-offset-key="12690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlthread_userstack_init</span></span></span></span><span data-slate-object="text" data-key="12691"><span data-slate-leaf="true" data-offset-key="12691:0" data-first-offset="true"><span data-slate-string="true">(ret_td, filerun, UMOD_EFLAGS);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12692"><span data-slate-object="text" data-key="12693"><span data-slate-leaf="true" data-offset-key="12693:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12694"><span data-slate-leaf="true" data-offset-key="12694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入调度器系统</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12695"><span data-slate-object="text" data-key="12696"><span data-slate-leaf="true" data-offset-key="12696:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12697"><span data-slate-leaf="true" data-offset-key="12697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlschdclass_add_thread</span></span></span></span><span data-slate-object="text" data-key="12698"><span data-slate-leaf="true" data-offset-key="12698:0" data-first-offset="true"><span data-slate-string="true">(ret_td);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12699"><span data-slate-object="text" data-key="12700"><span data-slate-leaf="true" data-offset-key="12700:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12701"><span data-slate-leaf="true" data-offset-key="12701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12702"><span data-slate-leaf="true" data-offset-key="12702:0" data-first-offset="true"><span data-slate-string="true"> ret_td;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12703"><span data-slate-object="text" data-key="12704"><span data-slate-leaf="true" data-offset-key="12704:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12705"><span data-slate-object="text" data-key="12706"><span data-slate-leaf="true" data-offset-key="12706:0" data-first-offset="true"><span data-slate-string="true">和建立内核进程相比，建立普通进程有两点不同。第一，</span></span></span><span data-slate-object="text" data-key="12707"><span data-slate-leaf="true" data-offset-key="12707:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">多分配了一个应用程序栈</span></span></span></span><span data-slate-object="text" data-key="12708"><span data-slate-leaf="true" data-offset-key="12708:0" data-first-offset="true"><span data-slate-string="true">。因为内核进程不会返回到进程的应用程序空间，所以不需要应用程序栈，而普通进程则需要；第二，在最后调用的是 </span></span></span><span data-slate-object="text" data-key="12709"><span data-slate-leaf="true" data-offset-key="12709:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">krlthread_userstack_init 函数</span></span></span></span><span data-slate-object="text" data-key="12710"><span data-slate-leaf="true" data-offset-key="12710:0" data-first-offset="true"><span data-slate-string="true">，该函数初始化返回进程应用程序空间的内核栈，这在前面已经介绍过了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12711"><span data-slate-object="text" data-key="12712"><span data-slate-leaf="true" data-offset-key="12712:0" data-first-offset="true"><span data-slate-string="true">到此为止，我们建立进程的功能已经实现了。但是最后将进程加入到调度系统的函数，我们还没有写，这个函数是进程调度器模块的函数，我们下节课再讨论。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12713" id="sr-toc-14"><span data-slate-object="text" data-key="12714"><span data-slate-leaf="true" data-offset-key="12714:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12715"><span data-slate-object="text" data-key="12716"><span data-slate-leaf="true" data-offset-key="12716:0" data-first-offset="true"><span data-slate-string="true">这节课我们用最简洁的方式了解了进程以及如何建立一个进程，我来为你梳理一下今天的课程重点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12717"><span data-slate-object="text" data-key="12718"><span data-slate-leaf="true" data-offset-key="12718:0" data-first-offset="true"><span data-slate-string="true">首先，我们在 Linux 系统上，用 ps 命令列出 Linux 系统上所有的进程，直观的感受了一下什么进程，从理论上了解了一下进程的结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12719"><span data-slate-object="text" data-key="12720"><span data-slate-leaf="true" data-offset-key="12720:0" data-first-offset="true"><span data-slate-string="true">然后我们把进程相关的信息，做了归纳整理，设计出一系列相应的数据结构，这其中包含了表示进程的数据结构，与进程相关内存地址空间结构，还有进程的机器上下文数据结构。这些数据结构综合起来就表示了进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12721"><span data-slate-object="text" data-key="12722"><span data-slate-leaf="true" data-offset-key="12722:0" data-first-offset="true"><span data-slate-string="true">最后进入建立进程的环节。有了进程相关的数据结构就可以写代码建立一个进程了，我们的建立进程的接口函数，既能建立普通进程又能建立内核进程，而建立进程的过程无非是创建进程结构体、分配进程的内核栈与应用程序栈，并对进程的内核栈进行初始化，最后将进程加入调度系统，以便后面将进程投入运行。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12723"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/33/fe/330a5c9553e4ce72bf4501bbae3ab9fe.jpg?wh=3232x1436"></div><div>进程建立流程图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12724"><span data-slate-object="text" data-key="12725"><span data-slate-leaf="true" data-offset-key="12725:0" data-first-offset="true"><span data-slate-string="true">很多理论书籍总是在开头就花大量篇幅讲进程，但你却很难搞懂，这是为什么呢？第一，他们在用抽象方法讲解抽象概念，对初学者很不友好；第二，讲解顺序不对，想搞懂进程，需要前置知识，它是一个高层次的组件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12726"><span data-slate-object="text" data-key="12727"><span data-slate-leaf="true" data-offset-key="12727:0" data-first-offset="true"><span data-slate-string="true">相信经过前面章节的学习，你现在理解进程会轻松自如。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12728" id="sr-toc-15"><span data-slate-object="text" data-key="12729"><span data-slate-leaf="true" data-offset-key="12729:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12730"><span data-slate-object="text" data-key="12731"><span data-slate-leaf="true" data-offset-key="12731:0" data-first-offset="true"><span data-slate-string="true">请问，各个进程是如何共享同一份内核代码和数据的？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12732"><span data-slate-object="text" data-key="12733"><span data-slate-leaf="true" data-offset-key="12733:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区和我交流，相信通过积极参与，你将更好地理解这节课的内容。也欢迎你把这节课分享给你的朋友，说不定可以帮他真正弄懂什么是进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12734"><span data-slate-object="text" data-key="12735"><span data-slate-leaf="true" data-offset-key="12735:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-16">精选留言 (11)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>一、数据结构
thread_t 表示一个线程，包括：
锁【并发】、链表
进程标志、进程状态、进程编号【内存地址】、CPU 编号【当前全是 0】、CPU 时间片、进程权限【内核 or 用户】、优先级【越小越高】、运行模式
栈信息【内核栈、应用栈】，每个进程的栈是独立的，向下生长
内存地址空间信息 virmemadrs_t，每个进程的内核部分是共用的，应用部分是独立的，通过页表实现
上下文信息，用于进程切换
进程打开资源的描述符，最多 TD_HAND_MAX 个

二、新建进程
init_krl-&gt;init_krlcpuidle-&gt;new_cpuidle-&gt;new_cpuidle_thread-&gt;krlnew_thread
-&gt;krlnew_kern_thread_core 新建内核进程
-&gt;krlnew_user_thread_core 新建用户进程

krlnew_kern_thread_core：
A、krlnew 分配内核栈空间
B、krlnew_thread_dsc 建立 thread_t 结构体的实例变量，并初始化
C、设置进程权限，优先级，进程的内核栈顶和内核栈开始地址
D、初始化进程的内核栈
E、加入进程调度系统，sschedcls.scls_schda [cpuid].sda_thdlst [td_priority].tdl_lsth

krlnew_user_thread_core：
A、krlnew 分配应用程序栈空间
B、krlnew 分配内核栈空间
C、krlnew_thread_dsc 建立 thread_t 结构体的实例变量，并初始化
D、设置进程权限，优先级，进程的内核栈顶和内核栈开始地址，进程用户栈顶和内核栈开始地址
E、初始化进程的应用栈
F、加入进程调度系统，sschedcls.scls_schda [cpuid].sda_thdlst [td_priority].tdl_lsth

三、中断进程切换【以硬件中断为例】
A、定义了宏 HARWINT，其中硬件中断分发器函数为 hal_hwint_allocator
% macro  HARWINT 1
    保存现场......
    mov   rdi, %1
    mov   rsi,rsp
    call    hal_hwint_allocator
    恢复现场......
% endmacro

B、定义了各种硬件中断编号，比如 hxi_hwint00，作为中断处理入口
ALIGN   16
hxi_hwint00:
    HARWINT (INT_VECTOR_IRQ0+0)

C、有硬件中断时
CPU 会根据中断门描述里的目标段选择子，进行必要的特权级切换；
特权级的切换就必须要切换栈，CPU 硬件会自己把当前 rsp 寄存器保存到内部的临时寄存器 tmprsp；
然后从 x64tss_t 结构体 【地址在 GDT 表，由 CPU 的 tr 寄存器指向】中找出对应的栈地址，装入 rsp 寄存器中；
接着，再把当前的 ss、tmprsp、rflags、cs、rip，依次压入当前 rsp 指向的栈中。

D、然后会先到达中断处理入口
保护现场
调用到硬件中断分发器函数 hal_hwint_allocator
第一个参数为中断编号，在 rdi
第二个参数为中断发生时的栈指针，在 rsi
然后调用异常处理函数 hal_do_hwint

E、hal_do_hwint
-&gt; 调用中断回调函数 hal_run_intflthandle
先获取中断异常表 intfltdsc_t
然后调用 intfltdsc_t.i_serlist 链表上，所有挂载 intserdsc_t 结构中的，中断处理的回调函数，让函数自行判断是否处理中断
-&gt; 中断处理完毕后调用 krlsched_chkneed_pmptsched
-&gt;-&gt; 一路返回，直到中断处理入口，还原现场，继续执行
-&gt;-&gt; 或者调用 krlschedul，继续进行调度，其实就可以返回用户态了

中断进程切换这部分，是硬理解的，不知道能对多少，还请老师指正。</div><div><p>作者回复：是正确的</p></div><div><div>2021-07-06</div><div><div><i></i></div><div><i></i><span>9</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>每个进程都有一个内核栈，指向同一个块内核内存区域，共享一份内核代码和内核数据。内核进程一份页表，用户进程两份页表，用户进程多了一份用户空间页表，与其它用户进程互不干扰。</div><div><p>作者回复：聪明如你</p></div><div><div>2021-07-02</div><div><div><i></i></div><div><i></i><span>9</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/8d/c6/e648d118.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 嗣树</span></div></div><div>各个进程内核空间都使用同一份页表，通过页表映射到同一物理内存。

咱们的进度还是挺快的，一不留神这周都挺近进程了哈哈哈</div><div><p>作者回复：是的 </p></div><div><div>2021-07-02</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>内存管理算是讲完了吗</div><div><p>编辑回复：是啊，告一段落了。关键之处课里都讲了，你还可以结合源代码（见 Gitee）继续深入学习。</p></div><div><div>2021-07-02</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2c/e1/13/23b9edd2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 弋</span></div></div><div>内核栈 krlstkadr = krlnew (krlstksz); 这个地方，返回的还是物理地址，新建进程的这一部分好像没看到有建立页表的内容
</div><div><p>作者回复：是虚拟地址 </p></div><div><div>2022-07-15</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>艾恩凝</span></div></div><div>打卡</div><div><div>2022-05-04</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>if...else...</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>膜拜各位大神</div><div><p>作者回复：哈哈</p></div><div><div>2022-02-17</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/20/8b/48/ea3f84f3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>O 俊</span></div></div><div>老师你好，我想问下，线程用到的栈空间在哪个地方？是在进程地址空间中的栈段吗？</div><div><p>作者回复：我没支持线程 </p></div><div><div>2021-09-17</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/09/58/4a89617c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>游城</span></div></div><div>usrstkadr = krlnew (usrstksz);  
krlstkadr = krlnew (krlstksz);
分配内核栈空间和用户栈空间调用的函数都是 krlnew，且没有参数区分，怎么确定最后返回的地址就是在各自符合的地址范围内的呢</div><div><p>作者回复：目前这个 usrstkadr 没起作用，因为本身是内核态进程</p></div><div><div>2021-08-23</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>青玉白露</span></div></div><div>请问，各个进程是如何共享同一份内核代码和数据的？
—— 描述进程的结构体中已经写明了：
adr_t td_krlstktop; // 应用程序内核栈顶地址
 adr_t td_krlstkstart; // 应用程序内核栈开始地址 
adr_t td_usrstktop; // 应用程序栈顶地址 
adr_t td_usrstkstart; // 应用程序栈开始地址
—— 用户进程中的内核指针都指向同一份内核空间</div><div><p>作者回复：不对哦 你再想想</p></div><div><div>2021-07-07</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div></div><div>这课的问题，让我想起了第 20 讲留下的小坑。原文如下

进程的物理地址空间，其实可以用一组 MMU 的页表数据表示，它保存在 mmudsc_t 数据结构中，但是这个数据结构我们不在这里研究，放在后面再研究。

只要把 mmudsc_t 的结构和使用搞明白了，本课的问题一清二楚了。 哈，是不是东哥要下文分解呀？</div><div><p>作者回复：哈哈 我留坑了？</p></div><div><div>2021-07-02</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".j"><outline class="toc-level-h1" data-reactid=".j.0" style="width: 175px;"><active data-reactid=".j.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".j.0.1"><span data-reactid=".j.0.1.0">24 | 活动的描述：到底什么是进程？</span></a></outline><outline class="toc-level-h2" data-reactid=".j.1" style="width: 165px;"><active data-reactid=".j.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".j.1.1"><span data-reactid=".j.1.1.0">感受一下</span></a></outline><outline class="toc-level-h2" data-reactid=".j.2" style="width: 165px;"><active data-reactid=".j.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".j.2.1"><span data-reactid=".j.2.1.0">什么是进程</span></a></outline><outline class="toc-level-h2" data-reactid=".j.3" style="width: 165px;"><active data-reactid=".j.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".j.3.1"><span data-reactid=".j.3.1.0">进程的结构</span></a></outline><outline class="toc-level-h2" data-reactid=".j.4" style="width: 165px;"><active data-reactid=".j.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".j.4.1"><span data-reactid=".j.4.1.0">实现进程</span></a></outline><outline class="toc-level-h3" data-reactid=".j.5" style="width: 155px;"><active data-reactid=".j.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".j.5.1"><span data-reactid=".j.5.1.0">如何表示一个进程</span></a></outline><outline class="toc-level-h3" data-reactid=".j.6" style="width: 155px;"><active data-reactid=".j.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".j.6.1"><span data-reactid=".j.6.1.0">进程的地址空间</span></a></outline><outline class="toc-level-h3" data-reactid=".j.7" style="width: 155px;"><active data-reactid=".j.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".j.7.1"><span data-reactid=".j.7.1.0">进程的机器上下文</span></a></outline><outline class="toc-level-h2" data-reactid=".j.8" style="width: 165px;"><active data-reactid=".j.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".j.8.1"><span data-reactid=".j.8.1.0">建立进程</span></a></outline><outline class="toc-level-h3" data-reactid=".j.9" style="width: 155px;"><active data-reactid=".j.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".j.9.1"><span data-reactid=".j.9.1.0">建立进程接口</span></a></outline><outline class="toc-level-h3" data-reactid=".j.a" style="width: 155px;"><active data-reactid=".j.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".j.a.1"><span data-reactid=".j.a.1.0">建立内核进程</span></a></outline><outline class="toc-level-h3" data-reactid=".j.b" style="width: 155px;"><active data-reactid=".j.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".j.b.1"><span data-reactid=".j.b.1.0">创建 thread_t 结构</span></a></outline><outline class="toc-level-h3" data-reactid=".j.c" style="width: 155px;"><active data-reactid=".j.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".j.c.1"><span data-reactid=".j.c.1.0">初始化内核栈</span></a></outline><outline class="toc-level-h3" data-reactid=".j.d" style="width: 155px;"><active data-reactid=".j.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".j.d.1"><span data-reactid=".j.d.1.0">建立普通进程</span></a></outline><outline class="toc-level-h2" data-reactid=".j.e" style="width: 165px;"><active data-reactid=".j.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".j.e.1"><span data-reactid=".j.e.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".j.f" style="width: 165px;"><active data-reactid=".j.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".j.f.1"><span data-reactid=".j.f.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".j.g" style="width: 165px;"><active data-reactid=".j.g.0"></active><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".j.g.1"><span data-reactid=".j.g.1.0">精选留言 (11)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/390674" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>