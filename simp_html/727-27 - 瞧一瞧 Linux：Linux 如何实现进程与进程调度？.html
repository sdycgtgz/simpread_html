
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAMAAAANIilAAAAA7VBMVEUAAAD///8ZGRnw8PBWVlb4+PgeHh719fVEREQlJSUODg6Ojo7Ly8v9/f1NTU2VlZUFBQV6enrCwsLy8vLh4eE0NDQLCwu8vLyXl5dxcXHa2trAwMCFhYVDQ0OysrKampo7OzssLCwICAioqKjJyckhISHu7u4/Pz9TU1NQUFBLS0tAQED6+vrS0tKRkZFISEgvLy+goKB+fn5vb29nZ2fm5uYbGxvk5OTX19d2dnZaWlre3t5hYWEyMjK5ubkoKCgVFRXQ0NDMzMzFxcW0tLSsrKykpKSMjIzq6urU1NSAgICvr6+cnJyHh4dsbGyfc25QAAAFkElEQVRIx4WXB3faMBCA74wHxgMMGAOh1MyyVyBAmtVmd/3/n1OdDtWstt/Li5JD35MtnU4CMnCIlkLEOpSKuMPhuI4FE444L9+dyv3zciad/rAjfU/yOPpGcjWS1NKSGsk29WTSD1IeYsIPkvsAJF+C5BIZkieYMNjJnsF4+JHk61wOSlVDyOIPqKBgZIxYTrqy/AmNtC1ps7yqlgE6dgYa1WqD5aV9SbKDbe6ZNnCq5A5ILlhGjEASIoawJdmHHo98AZLOnmxzKM9yK9Aht63FoAWBBmEgsEHnkfMgsZU8PJbpbXJd3MIep/Lg/MjbRqMRRuNtQ4Tthga5RiNzfmSWD97ZExQ64HhtgLb3CmbBGyj54vixjyeMsKjnV4AvOAHTwsHphKnH9toXki7Li3jLsgswizskv+c3PHKXe7ZHu5E/YMKcM2yqZIJkAclZTPClbJezivI1yTr4f+TeMib5qXxHsr7XtUFJDIc8pLAHA7Su4JXkd8ySnKZddQXH2NohswIutRu0Qu0jyS46JPugU+gISB1R8NBKWegVUsahTKEjAP9Bm5bKAc3DPlzjKaDvscE7PeEJu63WUg9a82tdA1O/ESupL9Cr6C1cXetjIe9zgQ4kvKLgHi6xC5LcGq9hhmiK0AYgUvLQtzm3n/x0jnum/Vo9j1jxg/pL3/f9W8isMOsv6/Ubf47rvl+u17nnZ1xQ+4iIXa6IpRVeimEEE3pnxO8kIz4CbFDyidVSpooBCCLLsj5noFlqUg2rwK0l+Anmm+VhCzKfrRHtqjGOLANxUKIUiYvFEcuaaZpXANniD5ZzpiBDTSRkuDJfWM6awxGuikUArp7fIOE7RlB6OygGTyhfsMyrtwDNIAkcp1YRhKC9Oh2IHUFQ6UPupnLL3icODaD5zVlUto7zhm1n7kmZ5kDSQBxykfZhD66eaQBoWriEGPcA182C4Crst90Z9NwvHgahDTALw/Ae4D500Pjq3oj/4sjtwcwVrCkkgB01HB8cdM0iIlWSr6IpNqFO+1mDHQFWORtO5EIi08b4jxy6giBsgKDnRnEYYdd9nIYvaLmuhS/h9DF5bEFr/7HTKAjUqWY1oUUBKgYEZdgIP6gJE2xQIWVvLhZBcAWx843kz87PDDi4cgR92s8/1FLpAGNeKiUbGtRQEIPkGb9TM1EF8MpCVEni7pIkkUdDs1ZcI/ZUer6YZg4WxTtqMmYsZJWebbOzEekZV4sCKaNhBaXQQ0NtjL71ZooNE1vWLfyyyFUbw7MsD0fWOFMSqAnbwj1Kuk0Aqp4aJ91MZhhvyS7+oQoMy5v63Jfoz/UYfPSiep2KQb5e4/gt1Ycdc7Se6jNyVbpuQNI08FrICQ6ccKnSXddrKCnqkqWFupJFAewKudSTBVAyBEjrLSXjCYnc5rrdQVl6VaiKqOTToi/kaSrlcW5fpGpgrlJTLvoGVxKDOg7PHzc6NLXOmuUHTZQhTWvS4T7T5ixPqGPz/EHXp/azkMeQoGOqBBOSq1gD4vwRe1culz8W8HlZKQt6Sjbm5XeS9eWizJw73HcsOW8mSpa0eT8zfK1w85LdtWKTf5dWfCPzMg5J+MBdsvvy6Q2QD/d91sfzouRz9zAdBp6HCcUzskccyBdKzjTC9ZE8HT8+JHLxtiE4d33Ud0uleOObvpXZk4E4/9h2sKD9t6oxgaCFxs9AHiI3wYJCndMbIMs9lLi7vEHFLxAUURyciOnTyzrLH6qSJwo+8CWuQIFL2wSoVyvQea/qtk2yvPtb4mekZMhJQkPwyvIzBbJGJD+jX3eGcfIFhWVmxsVAG5FMgSzm9y4wKL8aJdzvyctoTqEgep6K5lckWGM3uuuA5DadFvIhiTzBL1xzVtT0UDEDxd9ldeutcJLoyvUaoPgNdiqckZLamd0AAAAASUVORK5CYII=")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 27 | 瞧一瞧 Linux：Linux 如何实现进程与进程调度？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>27 | 瞧一瞧 Linux：Linux 如何实现进程与进程调度？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我会带你实现分配和释放内存页面，达到内存管理的目的。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">27 | 瞧一瞧 Linux：Linux 如何实现进程与进程调度？</h1><div><span>LMOS</span> <span>2021-07-09</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f1/23/f190c3ea677e4882e40f27c915cbd923.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：19.88M</span><span> 时长：21:46</span></div></div><audio title="27 | 瞧一瞧Linux：Linux如何实现进程与进程调度?" src="https://res001.geekbang.org/media/audio/6b/c2/6b66a8ff29ea29ceaaefe7f0f6fac3c2/ld/ld.m3u8" __idm_id__="950282"></audio></div><div><div><div><div data-slate-editor="true" data-key="14713" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="14714"><span data-slate-object="text" data-key="14715"><span data-slate-leaf="true" data-offset-key="14715:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14716"><span data-slate-object="text" data-key="14717"><span data-slate-leaf="true" data-offset-key="14717:0" data-first-offset="true"><span data-slate-string="true">在前面的课程中，我们已经写好了 Cosmos 的进程管理组件，实现了多进程调度运行，今天我们一起探索 Linux 如何表示进程以及如何进行多进程调度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14718"><span data-slate-object="text" data-key="14719"><span data-slate-leaf="true" data-offset-key="14719:0" data-first-offset="true"><span data-slate-string="true">好了，话不多说，我们开始吧。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14720" id="sr-toc-1"><span data-slate-object="text" data-key="14721"><span data-slate-leaf="true" data-offset-key="14721:0" data-first-offset="true"><span data-slate-string="true">Linux 如何表示进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14722"><span data-slate-object="text" data-key="14723"><span data-slate-leaf="true" data-offset-key="14723:0" data-first-offset="true"><span data-slate-string="true">在 Cosmos 中，我们设计了一个 thread_t 数据结构来代表一个进程，Linux 也同样是用一个数据结构表示一个进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14724"><span data-slate-object="text" data-key="14725"><span data-slate-leaf="true" data-offset-key="14725:0" data-first-offset="true"><span data-slate-string="true">下面我们先来研究 Linux 的进程数据结构，然后看看 Linux 进程的地址空间数据结构，最后再来理解 Linux 的文件表结构。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14726" id="sr-toc-2"><span data-slate-object="text" data-key="14727"><span data-slate-leaf="true" data-offset-key="14727:0" data-first-offset="true"><span data-slate-string="true">Linux 进程的数据结构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14728"><span data-slate-object="text" data-key="14729"><span data-slate-leaf="true" data-offset-key="14729:0" data-first-offset="true"><span data-slate-string="true">Linux 系统下，把运行中的应用程序抽象成一个数据结构 task_struct，一个应用程序所需要的各种资源，如内存、文件等都包含在 task_struct 结构中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14730"><span data-slate-object="text" data-key="14731"><span data-slate-leaf="true" data-offset-key="14731:0" data-first-offset="true"><span data-slate-string="true">因此，task_struct 结构是非常巨大的一个数据结构，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="14732"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14733"><span data-slate-object="text" data-key="14734"><span data-slate-leaf="true" data-offset-key="14734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14735"><span data-slate-leaf="true" data-offset-key="14735:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14736"><span data-slate-leaf="true" data-offset-key="14736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="14737"><span data-slate-leaf="true" data-offset-key="14737:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14738"><span data-slate-object="text" data-key="14739"><span data-slate-leaf="true" data-offset-key="14739:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14740"><span data-slate-leaf="true" data-offset-key="14740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14741"><span data-slate-leaf="true" data-offset-key="14741:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14742"><span data-slate-leaf="true" data-offset-key="14742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_info</span></span></span></span><span data-slate-object="text" data-key="14743"><span data-slate-leaf="true" data-offset-key="14743:0" data-first-offset="true"><span data-slate-string="true"> thread_info;</span></span></span><span data-slate-object="text" data-key="14744"><span data-slate-leaf="true" data-offset-key="14744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理器特有数据 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14745"><span data-slate-object="text" data-key="14746"><span data-slate-leaf="true" data-offset-key="14746:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14747"><span data-slate-leaf="true" data-offset-key="14747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span><span data-slate-object="text" data-key="14748"><span data-slate-leaf="true" data-offset-key="14748:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14749"><span data-slate-leaf="true" data-offset-key="14749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="14750"><span data-slate-leaf="true" data-offset-key="14750:0" data-first-offset="true"><span data-slate-string="true">   state;       </span></span></span><span data-slate-object="text" data-key="14751"><span data-slate-leaf="true" data-offset-key="14751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程状态 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14752"><span data-slate-object="text" data-key="14753"><span data-slate-leaf="true" data-offset-key="14753:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14754"><span data-slate-leaf="true" data-offset-key="14754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14755"><span data-slate-leaf="true" data-offset-key="14755:0" data-first-offset="true"><span data-slate-string="true">            *stack;      </span></span></span><span data-slate-object="text" data-key="14756"><span data-slate-leaf="true" data-offset-key="14756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程内核栈地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14757"><span data-slate-object="text" data-key="14758"><span data-slate-leaf="true" data-offset-key="14758:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14759"><span data-slate-leaf="true" data-offset-key="14759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">refcount_t</span></span></span></span><span data-slate-object="text" data-key="14760"><span data-slate-leaf="true" data-offset-key="14760:0" data-first-offset="true"><span data-slate-string="true">      usage;       </span></span></span><span data-slate-object="text" data-key="14761"><span data-slate-leaf="true" data-offset-key="14761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程使用计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14762"><span data-slate-object="text" data-key="14763"><span data-slate-leaf="true" data-offset-key="14763:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14764"><span data-slate-leaf="true" data-offset-key="14764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14765"><span data-slate-leaf="true" data-offset-key="14765:0" data-first-offset="true"><span data-slate-string="true">             on_rq;       </span></span></span><span data-slate-object="text" data-key="14766"><span data-slate-leaf="true" data-offset-key="14766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程是否在运行队列上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14767"><span data-slate-object="text" data-key="14768"><span data-slate-leaf="true" data-offset-key="14768:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14769"><span data-slate-leaf="true" data-offset-key="14769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14770"><span data-slate-leaf="true" data-offset-key="14770:0" data-first-offset="true"><span data-slate-string="true">             prio;        </span></span></span><span data-slate-object="text" data-key="14771"><span data-slate-leaf="true" data-offset-key="14771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 动态优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14772"><span data-slate-object="text" data-key="14773"><span data-slate-leaf="true" data-offset-key="14773:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14774"><span data-slate-leaf="true" data-offset-key="14774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14775"><span data-slate-leaf="true" data-offset-key="14775:0" data-first-offset="true"><span data-slate-string="true">             static_prio; </span></span></span><span data-slate-object="text" data-key="14776"><span data-slate-leaf="true" data-offset-key="14776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 静态优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14777"><span data-slate-object="text" data-key="14778"><span data-slate-leaf="true" data-offset-key="14778:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14779"><span data-slate-leaf="true" data-offset-key="14779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14780"><span data-slate-leaf="true" data-offset-key="14780:0" data-first-offset="true"><span data-slate-string="true">             normal_prio; </span></span></span><span data-slate-object="text" data-key="14781"><span data-slate-leaf="true" data-offset-key="14781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取决于静态优先级和调度策略</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14782"><span data-slate-object="text" data-key="14783"><span data-slate-leaf="true" data-offset-key="14783:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14784"><span data-slate-leaf="true" data-offset-key="14784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="14785"><span data-slate-leaf="true" data-offset-key="14785:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14786"><span data-slate-leaf="true" data-offset-key="14786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="14787"><span data-slate-leaf="true" data-offset-key="14787:0" data-first-offset="true"><span data-slate-string="true">    rt_priority; </span></span></span><span data-slate-object="text" data-key="14788"><span data-slate-leaf="true" data-offset-key="14788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实时优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14789"><span data-slate-object="text" data-key="14790"><span data-slate-leaf="true" data-offset-key="14790:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14791"><span data-slate-leaf="true" data-offset-key="14791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="14792"><span data-slate-leaf="true" data-offset-key="14792:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14793"><span data-slate-leaf="true" data-offset-key="14793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14794"><span data-slate-leaf="true" data-offset-key="14794:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14795"><span data-slate-leaf="true" data-offset-key="14795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="14796"><span data-slate-leaf="true" data-offset-key="14796:0" data-first-offset="true"><span data-slate-string="true">    *sched_class;</span></span></span><span data-slate-object="text" data-key="14797"><span data-slate-leaf="true" data-offset-key="14797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向其所在的调度类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14798"><span data-slate-object="text" data-key="14799"><span data-slate-leaf="true" data-offset-key="14799:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14800"><span data-slate-leaf="true" data-offset-key="14800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14801"><span data-slate-leaf="true" data-offset-key="14801:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14802"><span data-slate-leaf="true" data-offset-key="14802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="14803"><span data-slate-leaf="true" data-offset-key="14803:0" data-first-offset="true"><span data-slate-string="true">         se;</span></span></span><span data-slate-object="text" data-key="14804"><span data-slate-leaf="true" data-offset-key="14804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 普通进程的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14805"><span data-slate-object="text" data-key="14806"><span data-slate-leaf="true" data-offset-key="14806:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14807"><span data-slate-leaf="true" data-offset-key="14807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14808"><span data-slate-leaf="true" data-offset-key="14808:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14809"><span data-slate-leaf="true" data-offset-key="14809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_rt_entity</span></span></span></span><span data-slate-object="text" data-key="14810"><span data-slate-leaf="true" data-offset-key="14810:0" data-first-offset="true"><span data-slate-string="true">      rt;</span></span></span><span data-slate-object="text" data-key="14811"><span data-slate-leaf="true" data-offset-key="14811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实时进程的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14812"><span data-slate-object="text" data-key="14813"><span data-slate-leaf="true" data-offset-key="14813:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14814"><span data-slate-leaf="true" data-offset-key="14814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14815"><span data-slate-leaf="true" data-offset-key="14815:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14816"><span data-slate-leaf="true" data-offset-key="14816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_dl_entity</span></span></span></span><span data-slate-object="text" data-key="14817"><span data-slate-leaf="true" data-offset-key="14817:0" data-first-offset="true"><span data-slate-string="true">      dl;</span></span></span><span data-slate-object="text" data-key="14818"><span data-slate-leaf="true" data-offset-key="14818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 采用 EDF 算法调度实时进程的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14819"><span data-slate-object="text" data-key="14820"><span data-slate-leaf="true" data-offset-key="14820:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14821"><span data-slate-leaf="true" data-offset-key="14821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14822"><span data-slate-leaf="true" data-offset-key="14822:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14823"><span data-slate-leaf="true" data-offset-key="14823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_info</span></span></span></span><span data-slate-object="text" data-key="14824"><span data-slate-leaf="true" data-offset-key="14824:0" data-first-offset="true"><span data-slate-string="true">       sched_info;</span></span></span><span data-slate-object="text" data-key="14825"><span data-slate-leaf="true" data-offset-key="14825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于调度器统计进程的运行信息 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14826"><span data-slate-object="text" data-key="14827"><span data-slate-leaf="true" data-offset-key="14827:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14828"><span data-slate-leaf="true" data-offset-key="14828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14829"><span data-slate-leaf="true" data-offset-key="14829:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14830"><span data-slate-leaf="true" data-offset-key="14830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_head</span></span></span></span><span data-slate-object="text" data-key="14831"><span data-slate-leaf="true" data-offset-key="14831:0" data-first-offset="true"><span data-slate-string="true">        tasks;</span></span></span><span data-slate-object="text" data-key="14832"><span data-slate-leaf="true" data-offset-key="14832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 所有进程的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14833"><span data-slate-object="text" data-key="14834"><span data-slate-leaf="true" data-offset-key="14834:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14835"><span data-slate-leaf="true" data-offset-key="14835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14836"><span data-slate-leaf="true" data-offset-key="14836:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14837"><span data-slate-leaf="true" data-offset-key="14837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="14838"><span data-slate-leaf="true" data-offset-key="14838:0" data-first-offset="true"><span data-slate-string="true">        *mm;  </span></span></span><span data-slate-object="text" data-key="14839"><span data-slate-leaf="true" data-offset-key="14839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向进程内存结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14840"><span data-slate-object="text" data-key="14841"><span data-slate-leaf="true" data-offset-key="14841:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14842"><span data-slate-leaf="true" data-offset-key="14842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14843"><span data-slate-leaf="true" data-offset-key="14843:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14844"><span data-slate-leaf="true" data-offset-key="14844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="14845"><span data-slate-leaf="true" data-offset-key="14845:0" data-first-offset="true"><span data-slate-string="true">        *active_mm;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14846"><span data-slate-object="text" data-key="14847"><span data-slate-leaf="true" data-offset-key="14847:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14848"><span data-slate-leaf="true" data-offset-key="14848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pid_t</span></span></span></span><span data-slate-object="text" data-key="14849"><span data-slate-leaf="true" data-offset-key="14849:0" data-first-offset="true"><span data-slate-string="true">               pid;            </span></span></span><span data-slate-object="text" data-key="14850"><span data-slate-leaf="true" data-offset-key="14850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程 id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14851"><span data-slate-object="text" data-key="14852"><span data-slate-leaf="true" data-offset-key="14852:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14853"><span data-slate-leaf="true" data-offset-key="14853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14854"><span data-slate-leaf="true" data-offset-key="14854:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14855"><span data-slate-leaf="true" data-offset-key="14855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="14856"><span data-slate-leaf="true" data-offset-key="14856:0" data-first-offset="true"><span data-slate-string="true"> __rcu    *parent;</span></span></span><span data-slate-object="text" data-key="14857"><span data-slate-leaf="true" data-offset-key="14857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向其父进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14858"><span data-slate-object="text" data-key="14859"><span data-slate-leaf="true" data-offset-key="14859:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14860"><span data-slate-leaf="true" data-offset-key="14860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14861"><span data-slate-leaf="true" data-offset-key="14861:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14862"><span data-slate-leaf="true" data-offset-key="14862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_head</span></span></span></span><span data-slate-object="text" data-key="14863"><span data-slate-leaf="true" data-offset-key="14863:0" data-first-offset="true"><span data-slate-string="true">        children; </span></span></span><span data-slate-object="text" data-key="14864"><span data-slate-leaf="true" data-offset-key="14864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 链表中的所有元素都是它的子进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14865"><span data-slate-object="text" data-key="14866"><span data-slate-leaf="true" data-offset-key="14866:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14867"><span data-slate-leaf="true" data-offset-key="14867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14868"><span data-slate-leaf="true" data-offset-key="14868:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14869"><span data-slate-leaf="true" data-offset-key="14869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_head</span></span></span></span><span data-slate-object="text" data-key="14870"><span data-slate-leaf="true" data-offset-key="14870:0" data-first-offset="true"><span data-slate-string="true">        sibling;  </span></span></span><span data-slate-object="text" data-key="14871"><span data-slate-leaf="true" data-offset-key="14871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于把当前进程插入到兄弟链表中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14872"><span data-slate-object="text" data-key="14873"><span data-slate-leaf="true" data-offset-key="14873:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14874"><span data-slate-leaf="true" data-offset-key="14874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14875"><span data-slate-leaf="true" data-offset-key="14875:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14876"><span data-slate-leaf="true" data-offset-key="14876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="14877"><span data-slate-leaf="true" data-offset-key="14877:0" data-first-offset="true"><span data-slate-string="true">      *group_leader;</span></span></span><span data-slate-object="text" data-key="14878"><span data-slate-leaf="true" data-offset-key="14878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向其所在进程组的领头进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14879"><span data-slate-object="text" data-key="14880"><span data-slate-leaf="true" data-offset-key="14880:0" data-first-offset="true"><span data-slate-string="true">    u64             utime;   </span></span></span><span data-slate-object="text" data-key="14881"><span data-slate-leaf="true" data-offset-key="14881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于记录进程在用户态下所经过的节拍数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14882"><span data-slate-object="text" data-key="14883"><span data-slate-leaf="true" data-offset-key="14883:0" data-first-offset="true"><span data-slate-string="true">    u64             stime;   </span></span></span><span data-slate-object="text" data-key="14884"><span data-slate-leaf="true" data-offset-key="14884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于记录进程在内核态下所经过的节拍数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14885"><span data-slate-object="text" data-key="14886"><span data-slate-leaf="true" data-offset-key="14886:0" data-first-offset="true"><span data-slate-string="true">    u64             gtime;   </span></span></span><span data-slate-object="text" data-key="14887"><span data-slate-leaf="true" data-offset-key="14887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于记录作为虚拟机进程所经过的节拍数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14888"><span data-slate-object="text" data-key="14889"><span data-slate-leaf="true" data-offset-key="14889:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14890"><span data-slate-leaf="true" data-offset-key="14890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="14891"><span data-slate-leaf="true" data-offset-key="14891:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14892"><span data-slate-leaf="true" data-offset-key="14892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="14893"><span data-slate-leaf="true" data-offset-key="14893:0" data-first-offset="true"><span data-slate-string="true">           min_flt;</span></span></span><span data-slate-object="text" data-key="14894"><span data-slate-leaf="true" data-offset-key="14894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 缺页统计 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14895"><span data-slate-object="text" data-key="14896"><span data-slate-leaf="true" data-offset-key="14896:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14897"><span data-slate-leaf="true" data-offset-key="14897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="14898"><span data-slate-leaf="true" data-offset-key="14898:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14899"><span data-slate-leaf="true" data-offset-key="14899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="14900"><span data-slate-leaf="true" data-offset-key="14900:0" data-first-offset="true"><span data-slate-string="true">           maj_flt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14901"><span data-slate-object="text" data-key="14902"><span data-slate-leaf="true" data-offset-key="14902:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14903"><span data-slate-leaf="true" data-offset-key="14903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14904"><span data-slate-leaf="true" data-offset-key="14904:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14905"><span data-slate-leaf="true" data-offset-key="14905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fs_struct</span></span></span></span><span data-slate-object="text" data-key="14906"><span data-slate-leaf="true" data-offset-key="14906:0" data-first-offset="true"><span data-slate-string="true">        *fs;    </span></span></span><span data-slate-object="text" data-key="14907"><span data-slate-leaf="true" data-offset-key="14907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程相关的文件系统信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14908"><span data-slate-object="text" data-key="14909"><span data-slate-leaf="true" data-offset-key="14909:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14910"><span data-slate-leaf="true" data-offset-key="14910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14911"><span data-slate-leaf="true" data-offset-key="14911:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14912"><span data-slate-leaf="true" data-offset-key="14912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">files_struct</span></span></span></span><span data-slate-object="text" data-key="14913"><span data-slate-leaf="true" data-offset-key="14913:0" data-first-offset="true"><span data-slate-string="true">     *files;</span></span></span><span data-slate-object="text" data-key="14914"><span data-slate-leaf="true" data-offset-key="14914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程打开的所有文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14915"><span data-slate-object="text" data-key="14916"><span data-slate-leaf="true" data-offset-key="14916:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14917"><span data-slate-leaf="true" data-offset-key="14917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14918"><span data-slate-leaf="true" data-offset-key="14918:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14919"><span data-slate-leaf="true" data-offset-key="14919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">vm_struct</span></span></span></span><span data-slate-object="text" data-key="14920"><span data-slate-leaf="true" data-offset-key="14920:0" data-first-offset="true"><span data-slate-string="true">        *stack_vm_area;</span></span></span><span data-slate-object="text" data-key="14921"><span data-slate-leaf="true" data-offset-key="14921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内核栈的内存区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14922"><span data-slate-object="text" data-key="14923"><span data-slate-leaf="true" data-offset-key="14923:0" data-first-offset="true"><span data-slate-string="true">  };</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14924"><span data-slate-object="text" data-key="14925"><span data-slate-leaf="true" data-offset-key="14925:0" data-first-offset="true"><span data-slate-string="true">为了帮你掌握核心思路，关于 task_struct 结构体，我省略了进程的权能、性能跟踪、信号、numa、cgroup 等相关的近 500 行内容，你若有兴趣可以自行</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="14926"><span data-slate-object="text" data-key="14927"><span data-slate-leaf="true" data-offset-key="14927:0" data-first-offset="true"><span data-slate-string="true">阅读</span></span></span></a><span data-slate-object="text" data-key="14928"><span data-slate-leaf="true" data-offset-key="14928:0" data-first-offset="true"><span data-slate-string="true">，这里你只需要明白，在内存中，</span></span></span><span data-slate-object="text" data-key="14929"><span data-slate-leaf="true" data-offset-key="14929:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一个 task_struct 结构体的实例变量代表一个 Linux 进程</span></span></span></span><span data-slate-object="text" data-key="14930"><span data-slate-leaf="true" data-offset-key="14930:0" data-first-offset="true"><span data-slate-string="true">就行了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14931" id="sr-toc-3"><span data-slate-object="text" data-key="14932"><span data-slate-leaf="true" data-offset-key="14932:0" data-first-offset="true"><span data-slate-string="true">创建 task_struct 结构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14933"><span data-slate-object="text" data-key="14934"><span data-slate-leaf="true" data-offset-key="14934:0" data-first-offset="true"><span data-slate-string="true">Linux 创建 task_struct 结构体的实例变量，这里我们只关注早期和最新的创建方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14935"><span data-slate-object="text" data-key="14936"><span data-slate-leaf="true" data-offset-key="14936:0" data-first-offset="true"><span data-slate-string="true">Linux 早期是这样创建 task_struct 结构体的实例变量的：找伙伴内存管理系统，分配两个连续的页面（即 8KB），作为进程的内核栈，再把 task_struct 结构体的实例变量，放在这 8KB 内存空间的开始地址处。内核栈则是从上向下伸长的，task_struct 数据结构是从下向上伸长的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14937"><span data-slate-object="text" data-key="14938"><span data-slate-leaf="true" data-offset-key="14938:0" data-first-offset="true"><span data-slate-string="true">我给你画幅图，你就明白了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14939"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/9f/86/9f6acf3a5b6f31a3aeb8743726a65286.jpg?wh=2205x1335"></div><div>进程内核栈</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14940"><span data-slate-object="text" data-key="14941"><span data-slate-leaf="true" data-offset-key="14941:0" data-first-offset="true"><span data-slate-string="true">从图中不难发现，Linux 把 task_struct 结构和内核栈放在了一起 ，所以我们只要把 RSP 寄存器的值读取出来，然后将其低 13 位清零，就得到了当前 task_struct 结构体的地址。由于内核栈比较大，而且会向下伸长，覆盖掉 task_struct 结构体内容的概率就很小。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14942"><span data-slate-object="text" data-key="14943"><span data-slate-leaf="true" data-offset-key="14943:0" data-first-offset="true"><span data-slate-string="true">随着 Linux 版本的迭代，task_struct 结构体的体积越来越大，从前 task_struct 结构体和内核栈放在一起的方式就不合适了。最新的版本是分开放的，我们一起来看看后面的代码。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="14944"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14945"><span data-slate-object="text" data-key="14946"><span data-slate-leaf="true" data-offset-key="14946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="14947"><span data-slate-leaf="true" data-offset-key="14947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="14948"><span data-slate-leaf="true" data-offset-key="14948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span><span data-slate-object="text" data-key="14949"><span data-slate-leaf="true" data-offset-key="14949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="14950"><span data-slate-leaf="true" data-offset-key="14950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="14951"><span data-slate-leaf="true" data-offset-key="14951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="14952"><span data-slate-leaf="true" data-offset-key="14952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">alloc_thread_stack_node</span></span></span></span></span><span data-slate-object="text" data-key="14953"><span data-slate-leaf="true" data-offset-key="14953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="14954"><span data-slate-leaf="true" data-offset-key="14954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="14955"><span data-slate-leaf="true" data-offset-key="14955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> task_struct *tsk, </span></span></span></span></span><span data-slate-object="text" data-key="14956"><span data-slate-leaf="true" data-offset-key="14956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="14957"><span data-slate-leaf="true" data-offset-key="14957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> node)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14958"><span data-slate-object="text" data-key="14959"><span data-slate-leaf="true" data-offset-key="14959:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14960"><span data-slate-object="text" data-key="14961"><span data-slate-leaf="true" data-offset-key="14961:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14962"><span data-slate-leaf="true" data-offset-key="14962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="14963"><span data-slate-leaf="true" data-offset-key="14963:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14964"><span data-slate-leaf="true" data-offset-key="14964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">page</span></span></span></span><span data-slate-object="text" data-key="14965"><span data-slate-leaf="true" data-offset-key="14965:0" data-first-offset="true"><span data-slate-string="true"> *page = </span></span></span><span data-slate-object="text" data-key="14966"><span data-slate-leaf="true" data-offset-key="14966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">alloc_pages_node</span></span></span></span><span data-slate-object="text" data-key="14967"><span data-slate-leaf="true" data-offset-key="14967:0" data-first-offset="true"><span data-slate-string="true">(node, THREADINFO_GFP,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14968"><span data-slate-object="text" data-key="14969"><span data-slate-leaf="true" data-offset-key="14969:0" data-first-offset="true"><span data-slate-string="true">                         THREAD_SIZE_ORDER);</span></span></span><span data-slate-object="text" data-key="14970"><span data-slate-leaf="true" data-offset-key="14970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配两个页面</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14971"><span data-slate-object="text" data-key="14972"><span data-slate-leaf="true" data-offset-key="14972:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14973"><span data-slate-leaf="true" data-offset-key="14973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14974"><span data-slate-leaf="true" data-offset-key="14974:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="14975"><span data-slate-leaf="true" data-offset-key="14975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">likely</span></span></span></span><span data-slate-object="text" data-key="14976"><span data-slate-leaf="true" data-offset-key="14976:0" data-first-offset="true"><span data-slate-string="true">(page)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14977"><span data-slate-object="text" data-key="14978"><span data-slate-leaf="true" data-offset-key="14978:0" data-first-offset="true"><span data-slate-string="true">        tsk-&gt;stack = </span></span></span><span data-slate-object="text" data-key="14979"><span data-slate-leaf="true" data-offset-key="14979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kasan_reset_tag</span></span></span></span><span data-slate-object="text" data-key="14980"><span data-slate-leaf="true" data-offset-key="14980:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14981"><span data-slate-leaf="true" data-offset-key="14981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">page_address</span></span></span></span><span data-slate-object="text" data-key="14982"><span data-slate-leaf="true" data-offset-key="14982:0" data-first-offset="true"><span data-slate-string="true">(page));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14983"><span data-slate-object="text" data-key="14984"><span data-slate-leaf="true" data-offset-key="14984:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14985"><span data-slate-leaf="true" data-offset-key="14985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14986"><span data-slate-leaf="true" data-offset-key="14986:0" data-first-offset="true"><span data-slate-string="true"> tsk-&gt;stack;</span></span></span><span data-slate-object="text" data-key="14987"><span data-slate-leaf="true" data-offset-key="14987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 让 task_struct 结构的 stack 字段指向 page 的地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14988"><span data-slate-object="text" data-key="14989"><span data-slate-leaf="true" data-offset-key="14989:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14990"><span data-slate-object="text" data-key="14991"><span data-slate-leaf="true" data-offset-key="14991:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14992"><span data-slate-leaf="true" data-offset-key="14992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14993"><span data-slate-leaf="true" data-offset-key="14993:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14994"><span data-slate-leaf="true" data-offset-key="14994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14995"><span data-slate-leaf="true" data-offset-key="14995:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14996"><span data-slate-object="text" data-key="14997"><span data-slate-leaf="true" data-offset-key="14997:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14998"></div><div data-slate-type="code-line" data-slate-object="block" data-key="14999"><span data-slate-object="text" data-key="15000"><span data-slate-leaf="true" data-offset-key="15000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="15001"><span data-slate-leaf="true" data-offset-key="15001:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15002"><span data-slate-leaf="true" data-offset-key="15002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="15003"><span data-slate-leaf="true" data-offset-key="15003:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15004"><span data-slate-leaf="true" data-offset-key="15004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15005"><span data-slate-leaf="true" data-offset-key="15005:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15006"><span data-slate-leaf="true" data-offset-key="15006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15007"><span data-slate-leaf="true" data-offset-key="15007:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="15008"><span data-slate-leaf="true" data-offset-key="15008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">alloc_task_struct_node</span></span></span></span><span data-slate-object="text" data-key="15009"><span data-slate-leaf="true" data-offset-key="15009:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15010"><span data-slate-leaf="true" data-offset-key="15010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15011"><span data-slate-leaf="true" data-offset-key="15011:0" data-first-offset="true"><span data-slate-string="true"> node)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15012"><span data-slate-object="text" data-key="15013"><span data-slate-leaf="true" data-offset-key="15013:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15014"><span data-slate-object="text" data-key="15015"><span data-slate-leaf="true" data-offset-key="15015:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15016"><span data-slate-leaf="true" data-offset-key="15016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15017"><span data-slate-leaf="true" data-offset-key="15017:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15018"><span data-slate-leaf="true" data-offset-key="15018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kmem_cache_alloc_node</span></span></span></span><span data-slate-object="text" data-key="15019"><span data-slate-leaf="true" data-offset-key="15019:0" data-first-offset="true"><span data-slate-string="true">(task_struct_cachep, GFP_KERNEL, node);</span></span></span><span data-slate-object="text" data-key="15020"><span data-slate-leaf="true" data-offset-key="15020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 task_struct_cachep 内存对象中分配一个 task_struct 结构休对象 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15021"><span data-slate-object="text" data-key="15022"><span data-slate-leaf="true" data-offset-key="15022:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15023"><span data-slate-object="text" data-key="15024"><span data-slate-leaf="true" data-offset-key="15024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="15025"><span data-slate-leaf="true" data-offset-key="15025:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15026"><span data-slate-leaf="true" data-offset-key="15026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15027"><span data-slate-leaf="true" data-offset-key="15027:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15028"><span data-slate-leaf="true" data-offset-key="15028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15029"><span data-slate-leaf="true" data-offset-key="15029:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="15030"><span data-slate-leaf="true" data-offset-key="15030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dup_task_struct</span></span></span></span><span data-slate-object="text" data-key="15031"><span data-slate-leaf="true" data-offset-key="15031:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15032"><span data-slate-leaf="true" data-offset-key="15032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15033"><span data-slate-leaf="true" data-offset-key="15033:0" data-first-offset="true"><span data-slate-string="true"> task_struct *orig, </span></span></span><span data-slate-object="text" data-key="15034"><span data-slate-leaf="true" data-offset-key="15034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15035"><span data-slate-leaf="true" data-offset-key="15035:0" data-first-offset="true"><span data-slate-string="true"> node)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15036"><span data-slate-object="text" data-key="15037"><span data-slate-leaf="true" data-offset-key="15037:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15038"><span data-slate-object="text" data-key="15039"><span data-slate-leaf="true" data-offset-key="15039:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15040"><span data-slate-leaf="true" data-offset-key="15040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15041"><span data-slate-leaf="true" data-offset-key="15041:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15042"><span data-slate-leaf="true" data-offset-key="15042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15043"><span data-slate-leaf="true" data-offset-key="15043:0" data-first-offset="true"><span data-slate-string="true"> *tsk; </span></span></span><span data-slate-object="text" data-key="15044"><span data-slate-leaf="true" data-offset-key="15044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15045"><span data-slate-leaf="true" data-offset-key="15045:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15046"><span data-slate-leaf="true" data-offset-key="15046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15047"><span data-slate-leaf="true" data-offset-key="15047:0" data-first-offset="true"><span data-slate-string="true"> *stack;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15048"><span data-slate-object="text" data-key="15049"><span data-slate-leaf="true" data-offset-key="15049:0" data-first-offset="true"><span data-slate-string="true">    tsk = </span></span></span><span data-slate-object="text" data-key="15050"><span data-slate-leaf="true" data-offset-key="15050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">alloc_task_struct_node</span></span></span></span><span data-slate-object="text" data-key="15051"><span data-slate-leaf="true" data-offset-key="15051:0" data-first-offset="true"><span data-slate-string="true">(node);</span></span></span><span data-slate-object="text" data-key="15052"><span data-slate-leaf="true" data-offset-key="15052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 task_struct 结构体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15053"><span data-slate-object="text" data-key="15054"><span data-slate-leaf="true" data-offset-key="15054:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15055"><span data-slate-leaf="true" data-offset-key="15055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15056"><span data-slate-leaf="true" data-offset-key="15056:0" data-first-offset="true"><span data-slate-string="true"> (!tsk)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15057"><span data-slate-object="text" data-key="15058"><span data-slate-leaf="true" data-offset-key="15058:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15059"><span data-slate-leaf="true" data-offset-key="15059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15060"><span data-slate-leaf="true" data-offset-key="15060:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15061"><span data-slate-leaf="true" data-offset-key="15061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="15062"><span data-slate-leaf="true" data-offset-key="15062:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15063"><span data-slate-object="text" data-key="15064"><span data-slate-leaf="true" data-offset-key="15064:0" data-first-offset="true"><span data-slate-string="true">    stack = </span></span></span><span data-slate-object="text" data-key="15065"><span data-slate-leaf="true" data-offset-key="15065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">alloc_thread_stack_node</span></span></span></span><span data-slate-object="text" data-key="15066"><span data-slate-leaf="true" data-offset-key="15066:0" data-first-offset="true"><span data-slate-string="true">(tsk, node);</span></span></span><span data-slate-object="text" data-key="15067"><span data-slate-leaf="true" data-offset-key="15067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15068"><span data-slate-object="text" data-key="15069"><span data-slate-leaf="true" data-offset-key="15069:0" data-first-offset="true"><span data-slate-string="true">    tsk-&gt;stack = stack;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15070"><span data-slate-object="text" data-key="15071"><span data-slate-leaf="true" data-offset-key="15071:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15072"><span data-slate-leaf="true" data-offset-key="15072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15073"><span data-slate-leaf="true" data-offset-key="15073:0" data-first-offset="true"><span data-slate-string="true"> tsk;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15074"><span data-slate-object="text" data-key="15075"><span data-slate-leaf="true" data-offset-key="15075:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15076"><span data-slate-object="text" data-key="15077"><span data-slate-leaf="true" data-offset-key="15077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="15078"><span data-slate-leaf="true" data-offset-key="15078:0" data-first-offset="true"><span data-slate-string="true"> __latent_entropy </span></span></span><span data-slate-object="text" data-key="15079"><span data-slate-leaf="true" data-offset-key="15079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15080"><span data-slate-leaf="true" data-offset-key="15080:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15081"><span data-slate-leaf="true" data-offset-key="15081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15082"><span data-slate-leaf="true" data-offset-key="15082:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="15083"><span data-slate-leaf="true" data-offset-key="15083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy_process</span></span></span></span><span data-slate-object="text" data-key="15084"><span data-slate-leaf="true" data-offset-key="15084:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15085"><span data-slate-object="text" data-key="15086"><span data-slate-leaf="true" data-offset-key="15086:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="15087"><span data-slate-leaf="true" data-offset-key="15087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15088"><span data-slate-leaf="true" data-offset-key="15088:0" data-first-offset="true"><span data-slate-string="true"> pid *pid, </span></span></span><span data-slate-object="text" data-key="15089"><span data-slate-leaf="true" data-offset-key="15089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15090"><span data-slate-leaf="true" data-offset-key="15090:0" data-first-offset="true"><span data-slate-string="true"> trace, </span></span></span><span data-slate-object="text" data-key="15091"><span data-slate-leaf="true" data-offset-key="15091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15092"><span data-slate-leaf="true" data-offset-key="15092:0" data-first-offset="true"><span data-slate-string="true"> node,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15093"><span data-slate-object="text" data-key="15094"><span data-slate-leaf="true" data-offset-key="15094:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="15095"><span data-slate-leaf="true" data-offset-key="15095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15096"><span data-slate-leaf="true" data-offset-key="15096:0" data-first-offset="true"><span data-slate-string="true"> kernel_clone_args *args)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15097"><span data-slate-object="text" data-key="15098"><span data-slate-leaf="true" data-offset-key="15098:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15099"><span data-slate-object="text" data-key="15100"><span data-slate-leaf="true" data-offset-key="15100:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15101"><span data-slate-leaf="true" data-offset-key="15101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15102"><span data-slate-leaf="true" data-offset-key="15102:0" data-first-offset="true"><span data-slate-string="true"> pidfd = </span></span></span><span data-slate-object="text" data-key="15103"><span data-slate-leaf="true" data-offset-key="15103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="15104"><span data-slate-leaf="true" data-offset-key="15104:0" data-first-offset="true"><span data-slate-string="true">, retval;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15105"><span data-slate-object="text" data-key="15106"><span data-slate-leaf="true" data-offset-key="15106:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15107"><span data-slate-leaf="true" data-offset-key="15107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15108"><span data-slate-leaf="true" data-offset-key="15108:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15109"><span data-slate-leaf="true" data-offset-key="15109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15110"><span data-slate-leaf="true" data-offset-key="15110:0" data-first-offset="true"><span data-slate-string="true"> *p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15111"><span data-slate-object="text" data-key="15112"><span data-slate-leaf="true" data-offset-key="15112:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15113"><span data-slate-leaf="true" data-offset-key="15113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15114"><span data-slate-object="text" data-key="15115"><span data-slate-leaf="true" data-offset-key="15115:0" data-first-offset="true"><span data-slate-string="true">    retval = -ENOMEM;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15116"><span data-slate-object="text" data-key="15117"><span data-slate-leaf="true" data-offset-key="15117:0" data-first-offset="true"><span data-slate-string="true">    p = </span></span></span><span data-slate-object="text" data-key="15118"><span data-slate-leaf="true" data-offset-key="15118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dup_task_struct</span></span></span></span><span data-slate-object="text" data-key="15119"><span data-slate-leaf="true" data-offset-key="15119:0" data-first-offset="true"><span data-slate-string="true">(current, node);</span></span></span><span data-slate-object="text" data-key="15120"><span data-slate-leaf="true" data-offset-key="15120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 task_struct 和内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15121"><span data-slate-object="text" data-key="15122"><span data-slate-leaf="true" data-offset-key="15122:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15123"><span data-slate-leaf="true" data-offset-key="15123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15124"><span data-slate-object="text" data-key="15125"><span data-slate-leaf="true" data-offset-key="15125:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15126"><span data-slate-leaf="true" data-offset-key="15126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15127"><span data-slate-leaf="true" data-offset-key="15127:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15128"><span data-slate-leaf="true" data-offset-key="15128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ERR_PTR</span></span></span></span><span data-slate-object="text" data-key="15129"><span data-slate-leaf="true" data-offset-key="15129:0" data-first-offset="true"><span data-slate-string="true">(retval);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15130"><span data-slate-object="text" data-key="15131"><span data-slate-leaf="true" data-offset-key="15131:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15132"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15133"><span data-slate-object="text" data-key="15134"><span data-slate-leaf="true" data-offset-key="15134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pid_t</span></span></span></span></span><span data-slate-object="text" data-key="15135"><span data-slate-leaf="true" data-offset-key="15135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15136"><span data-slate-leaf="true" data-offset-key="15136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kernel_clone</span></span></span></span></span><span data-slate-object="text" data-key="15137"><span data-slate-leaf="true" data-offset-key="15137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="15138"><span data-slate-leaf="true" data-offset-key="15138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="15139"><span data-slate-leaf="true" data-offset-key="15139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> kernel_clone_args *args)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15140"><span data-slate-object="text" data-key="15141"><span data-slate-leaf="true" data-offset-key="15141:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15142"><span data-slate-object="text" data-key="15143"><span data-slate-leaf="true" data-offset-key="15143:0" data-first-offset="true"><span data-slate-string="true">    u64 clone_flags = args-&gt;flags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15144"><span data-slate-object="text" data-key="15145"><span data-slate-leaf="true" data-offset-key="15145:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15146"><span data-slate-leaf="true" data-offset-key="15146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15147"><span data-slate-leaf="true" data-offset-key="15147:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15148"><span data-slate-leaf="true" data-offset-key="15148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15149"><span data-slate-leaf="true" data-offset-key="15149:0" data-first-offset="true"><span data-slate-string="true"> *p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15150"><span data-slate-object="text" data-key="15151"><span data-slate-leaf="true" data-offset-key="15151:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15152"><span data-slate-leaf="true" data-offset-key="15152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pid_t</span></span></span></span><span data-slate-object="text" data-key="15153"><span data-slate-leaf="true" data-offset-key="15153:0" data-first-offset="true"><span data-slate-string="true"> nr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15154"><span data-slate-object="text" data-key="15155"><span data-slate-leaf="true" data-offset-key="15155:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15156"><span data-slate-leaf="true" data-offset-key="15156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15157"><span data-slate-object="text" data-key="15158"><span data-slate-leaf="true" data-offset-key="15158:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15159"><span data-slate-leaf="true" data-offset-key="15159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 复制进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15160"><span data-slate-object="text" data-key="15161"><span data-slate-leaf="true" data-offset-key="15161:0" data-first-offset="true"><span data-slate-string="true">    p = </span></span></span><span data-slate-object="text" data-key="15162"><span data-slate-leaf="true" data-offset-key="15162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy_process</span></span></span></span><span data-slate-object="text" data-key="15163"><span data-slate-leaf="true" data-offset-key="15163:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15164"><span data-slate-leaf="true" data-offset-key="15164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="15165"><span data-slate-leaf="true" data-offset-key="15165:0" data-first-offset="true"><span data-slate-string="true">, trace, NUMA_NO_NODE, args);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15166"><span data-slate-object="text" data-key="15167"><span data-slate-leaf="true" data-offset-key="15167:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15168"><span data-slate-leaf="true" data-offset-key="15168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15169"><span data-slate-object="text" data-key="15170"><span data-slate-leaf="true" data-offset-key="15170:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15171"><span data-slate-leaf="true" data-offset-key="15171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15172"><span data-slate-leaf="true" data-offset-key="15172:0" data-first-offset="true"><span data-slate-string="true"> nr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15173"><span data-slate-object="text" data-key="15174"><span data-slate-leaf="true" data-offset-key="15174:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15175"><span data-slate-object="text" data-key="15176"><span data-slate-leaf="true" data-offset-key="15176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立进程接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15177"><span data-slate-object="text" data-key="15178"><span data-slate-leaf="true" data-offset-key="15178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SYSCALL_DEFINE0</span></span></span></span><span data-slate-object="text" data-key="15179"><span data-slate-leaf="true" data-offset-key="15179:0" data-first-offset="true"><span data-slate-string="true">(fork)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15180"><span data-slate-object="text" data-key="15181"><span data-slate-leaf="true" data-offset-key="15181:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15182"><span data-slate-object="text" data-key="15183"><span data-slate-leaf="true" data-offset-key="15183:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15184"><span data-slate-leaf="true" data-offset-key="15184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15185"><span data-slate-leaf="true" data-offset-key="15185:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15186"><span data-slate-leaf="true" data-offset-key="15186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kernel_clone_args</span></span></span></span><span data-slate-object="text" data-key="15187"><span data-slate-leaf="true" data-offset-key="15187:0" data-first-offset="true"><span data-slate-string="true"> args = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15188"><span data-slate-object="text" data-key="15189"><span data-slate-leaf="true" data-offset-key="15189:0" data-first-offset="true"><span data-slate-string="true">        .exit_signal = SIGCHLD,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15190"><span data-slate-object="text" data-key="15191"><span data-slate-leaf="true" data-offset-key="15191:0" data-first-offset="true"><span data-slate-string="true">    };</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15192"><span data-slate-object="text" data-key="15193"><span data-slate-leaf="true" data-offset-key="15193:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15194"><span data-slate-leaf="true" data-offset-key="15194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15195"><span data-slate-leaf="true" data-offset-key="15195:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15196"><span data-slate-leaf="true" data-offset-key="15196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kernel_clone</span></span></span></span><span data-slate-object="text" data-key="15197"><span data-slate-leaf="true" data-offset-key="15197:0" data-first-offset="true"><span data-slate-string="true">(&amp;args);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15198"><span data-slate-object="text" data-key="15199"><span data-slate-leaf="true" data-offset-key="15199:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15200"><span data-slate-object="text" data-key="15201"><span data-slate-leaf="true" data-offset-key="15201:0" data-first-offset="true"><span data-slate-string="true">为了直击重点，我们不会讨论 Linux 的 fork 函数，你只要知道，它负责建立一个与父进程相同的进程，也就是复制了父进程的一系列数据，这就够了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15202"><span data-slate-object="text" data-key="15203"><span data-slate-leaf="true" data-offset-key="15203:0" data-first-offset="true"><span data-slate-string="true">要复制父进程的数据必须要分配内存，</span></span></span><span data-slate-object="text" data-key="15204"><span data-slate-leaf="true" data-offset-key="15204:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">上面代码的流程完整展示了从 SLAB 中分配 task_struct 结构，以及从伙伴内存系统分配内核栈的过程，整个过程是怎么回事儿，才是你要领会的重点。</span></span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15205" id="sr-toc-4"><span data-slate-object="text" data-key="15206"><span data-slate-leaf="true" data-offset-key="15206:0" data-first-offset="true"><span data-slate-string="true">Linux 进程地址空间</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15207"><span data-slate-object="text" data-key="15208"><span data-slate-leaf="true" data-offset-key="15208:0" data-first-offset="true"><span data-slate-string="true">Linux 也是支持虚拟内存的操作系统内核，现在我们来看看 Linux 用于描述一个进程的地址空间的数据结构，它就是 </span></span></span><span data-slate-object="text" data-key="15209"><span data-slate-leaf="true" data-offset-key="15209:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">mm_struct 结构</span></span></span></span><span data-slate-object="text" data-key="15210"><span data-slate-leaf="true" data-offset-key="15210:0" data-first-offset="true"><span data-slate-string="true">，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15211"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15212"><span data-slate-object="text" data-key="15213"><span data-slate-leaf="true" data-offset-key="15213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15214"><span data-slate-leaf="true" data-offset-key="15214:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15215"><span data-slate-leaf="true" data-offset-key="15215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="15216"><span data-slate-leaf="true" data-offset-key="15216:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15217"><span data-slate-object="text" data-key="15218"><span data-slate-leaf="true" data-offset-key="15218:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15219"><span data-slate-leaf="true" data-offset-key="15219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15220"><span data-slate-leaf="true" data-offset-key="15220:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15221"><span data-slate-leaf="true" data-offset-key="15221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">vm_area_struct</span></span></span></span><span data-slate-object="text" data-key="15222"><span data-slate-leaf="true" data-offset-key="15222:0" data-first-offset="true"><span data-slate-string="true"> *mmap; </span></span></span><span data-slate-object="text" data-key="15223"><span data-slate-leaf="true" data-offset-key="15223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 虚拟地址区间链表 VMAs</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15224"><span data-slate-object="text" data-key="15225"><span data-slate-leaf="true" data-offset-key="15225:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15226"><span data-slate-leaf="true" data-offset-key="15226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15227"><span data-slate-leaf="true" data-offset-key="15227:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15228"><span data-slate-leaf="true" data-offset-key="15228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_root</span></span></span></span><span data-slate-object="text" data-key="15229"><span data-slate-leaf="true" data-offset-key="15229:0" data-first-offset="true"><span data-slate-string="true"> mm_rb;   </span></span></span><span data-slate-object="text" data-key="15230"><span data-slate-leaf="true" data-offset-key="15230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 组织 vm_area_struct 结构的红黑树的根</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15231"><span data-slate-object="text" data-key="15232"><span data-slate-leaf="true" data-offset-key="15232:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15233"><span data-slate-leaf="true" data-offset-key="15233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15234"><span data-slate-leaf="true" data-offset-key="15234:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15235"><span data-slate-leaf="true" data-offset-key="15235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15236"><span data-slate-leaf="true" data-offset-key="15236:0" data-first-offset="true"><span data-slate-string="true"> task_size;    </span></span></span><span data-slate-object="text" data-key="15237"><span data-slate-leaf="true" data-offset-key="15237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程虚拟地址空间大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15238"><span data-slate-object="text" data-key="15239"><span data-slate-leaf="true" data-offset-key="15239:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15240"><span data-slate-leaf="true" data-offset-key="15240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pgd_t</span></span></span></span><span data-slate-object="text" data-key="15241"><span data-slate-leaf="true" data-offset-key="15241:0" data-first-offset="true"><span data-slate-string="true"> * pgd;        </span></span></span><span data-slate-object="text" data-key="15242"><span data-slate-leaf="true" data-offset-key="15242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向 MMU 页表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15243"><span data-slate-object="text" data-key="15244"><span data-slate-leaf="true" data-offset-key="15244:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15245"><span data-slate-leaf="true" data-offset-key="15245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span><span data-slate-object="text" data-key="15246"><span data-slate-leaf="true" data-offset-key="15246:0" data-first-offset="true"><span data-slate-string="true"> mm_users; </span></span></span><span data-slate-object="text" data-key="15247"><span data-slate-leaf="true" data-offset-key="15247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 多个进程共享这个 mm_struct</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15248"><span data-slate-object="text" data-key="15249"><span data-slate-leaf="true" data-offset-key="15249:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15250"><span data-slate-leaf="true" data-offset-key="15250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span><span data-slate-object="text" data-key="15251"><span data-slate-leaf="true" data-offset-key="15251:0" data-first-offset="true"><span data-slate-string="true"> mm_count; </span></span></span><span data-slate-object="text" data-key="15252"><span data-slate-leaf="true" data-offset-key="15252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//mm_struct 结构本身计数 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15253"><span data-slate-object="text" data-key="15254"><span data-slate-leaf="true" data-offset-key="15254:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15255"><span data-slate-leaf="true" data-offset-key="15255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_long_t</span></span></span></span><span data-slate-object="text" data-key="15256"><span data-slate-leaf="true" data-offset-key="15256:0" data-first-offset="true"><span data-slate-string="true"> pgtables_bytes;</span></span></span><span data-slate-object="text" data-key="15257"><span data-slate-leaf="true" data-offset-key="15257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 页表占用了多个页</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15258"><span data-slate-object="text" data-key="15259"><span data-slate-leaf="true" data-offset-key="15259:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15260"><span data-slate-leaf="true" data-offset-key="15260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15261"><span data-slate-leaf="true" data-offset-key="15261:0" data-first-offset="true"><span data-slate-string="true"> map_count;      </span></span></span><span data-slate-object="text" data-key="15262"><span data-slate-leaf="true" data-offset-key="15262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 多少个 VMA</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15263"><span data-slate-object="text" data-key="15264"><span data-slate-leaf="true" data-offset-key="15264:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15265"><span data-slate-leaf="true" data-offset-key="15265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="15266"><span data-slate-leaf="true" data-offset-key="15266:0" data-first-offset="true"><span data-slate-string="true"> page_table_lock; </span></span></span><span data-slate-object="text" data-key="15267"><span data-slate-leaf="true" data-offset-key="15267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保护页表的自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15268"><span data-slate-object="text" data-key="15269"><span data-slate-leaf="true" data-offset-key="15269:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15270"><span data-slate-leaf="true" data-offset-key="15270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15271"><span data-slate-leaf="true" data-offset-key="15271:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15272"><span data-slate-leaf="true" data-offset-key="15272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_head</span></span></span></span><span data-slate-object="text" data-key="15273"><span data-slate-leaf="true" data-offset-key="15273:0" data-first-offset="true"><span data-slate-string="true"> mmlist; </span></span></span><span data-slate-object="text" data-key="15274"><span data-slate-leaf="true" data-offset-key="15274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 挂入 mm_struct 结构的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15275"><span data-slate-object="text" data-key="15276"><span data-slate-leaf="true" data-offset-key="15276:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15277"><span data-slate-leaf="true" data-offset-key="15277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程应用程序代码开始、结束地址，应用程序数据的开始、结束地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15278"><span data-slate-object="text" data-key="15279"><span data-slate-leaf="true" data-offset-key="15279:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15280"><span data-slate-leaf="true" data-offset-key="15280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15281"><span data-slate-leaf="true" data-offset-key="15281:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15282"><span data-slate-leaf="true" data-offset-key="15282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15283"><span data-slate-leaf="true" data-offset-key="15283:0" data-first-offset="true"><span data-slate-string="true"> start_code, end_code, start_data, end_data;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15284"><span data-slate-object="text" data-key="15285"><span data-slate-leaf="true" data-offset-key="15285:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15286"><span data-slate-leaf="true" data-offset-key="15286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程应用程序堆区的开始、当前地址、栈开始地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15287"><span data-slate-object="text" data-key="15288"><span data-slate-leaf="true" data-offset-key="15288:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15289"><span data-slate-leaf="true" data-offset-key="15289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15290"><span data-slate-leaf="true" data-offset-key="15290:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15291"><span data-slate-leaf="true" data-offset-key="15291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15292"><span data-slate-leaf="true" data-offset-key="15292:0" data-first-offset="true"><span data-slate-string="true"> start_brk, brk, start_stack;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15293"><span data-slate-object="text" data-key="15294"><span data-slate-leaf="true" data-offset-key="15294:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15295"><span data-slate-leaf="true" data-offset-key="15295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程应用程序参数区开始、结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15296"><span data-slate-object="text" data-key="15297"><span data-slate-leaf="true" data-offset-key="15297:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15298"><span data-slate-leaf="true" data-offset-key="15298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15299"><span data-slate-leaf="true" data-offset-key="15299:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15300"><span data-slate-leaf="true" data-offset-key="15300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15301"><span data-slate-leaf="true" data-offset-key="15301:0" data-first-offset="true"><span data-slate-string="true"> arg_start, arg_end, env_start, env_end;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15302"><span data-slate-object="text" data-key="15303"><span data-slate-leaf="true" data-offset-key="15303:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15304"><span data-slate-object="text" data-key="15305"><span data-slate-leaf="true" data-offset-key="15305:0" data-first-offset="true"><span data-slate-string="true">同样的，mm_struct 结构，我也精减了很多内容。其中的 vm_area_struct 结构，相当于我们之前 Cosmos 的 kmvarsdsc_t 结构（可以回看</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15306"><span data-slate-object="text" data-key="15307"><span data-slate-leaf="true" data-offset-key="15307:0" data-first-offset="true"><span data-slate-string="true">第 20 节课</span></span></span></a><span data-slate-object="text" data-key="15308"><span data-slate-leaf="true" data-offset-key="15308:0" data-first-offset="true"><span data-slate-string="true">），是用来描述一段虚拟地址空间的。mm_struct 结构中也包含了 MMU 页表相关的信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15309"><span data-slate-object="text" data-key="15310"><span data-slate-leaf="true" data-offset-key="15310:0" data-first-offset="true"><span data-slate-string="true">下面我们一起来看看，mm_struct 结构是如何建立对应的实例变量呢？代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15311"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15312"><span data-slate-object="text" data-key="15313"><span data-slate-leaf="true" data-offset-key="15313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 mm_cachep 内存对象中分配一个 mm_struct 结构休对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15314"><span data-slate-object="text" data-key="15315"><span data-slate-leaf="true" data-offset-key="15315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="15316"><span data-slate-leaf="true" data-offset-key="15316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="15317"><span data-slate-leaf="true" data-offset-key="15317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> allocate_mm()   (kmem_cache_alloc(mm_cachep, GFP_KERNEL))</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15318"><span data-slate-object="text" data-key="15319"><span data-slate-leaf="true" data-offset-key="15319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="15320"><span data-slate-leaf="true" data-offset-key="15320:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15321"><span data-slate-leaf="true" data-offset-key="15321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15322"><span data-slate-leaf="true" data-offset-key="15322:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15323"><span data-slate-leaf="true" data-offset-key="15323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="15324"><span data-slate-leaf="true" data-offset-key="15324:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="15325"><span data-slate-leaf="true" data-offset-key="15325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dup_mm</span></span></span></span><span data-slate-object="text" data-key="15326"><span data-slate-leaf="true" data-offset-key="15326:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15327"><span data-slate-leaf="true" data-offset-key="15327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15328"><span data-slate-leaf="true" data-offset-key="15328:0" data-first-offset="true"><span data-slate-string="true"> task_struct *tsk,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15329"><span data-slate-object="text" data-key="15330"><span data-slate-leaf="true" data-offset-key="15330:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="15331"><span data-slate-leaf="true" data-offset-key="15331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15332"><span data-slate-leaf="true" data-offset-key="15332:0" data-first-offset="true"><span data-slate-string="true"> mm_struct *oldmm)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15333"><span data-slate-object="text" data-key="15334"><span data-slate-leaf="true" data-offset-key="15334:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15335"><span data-slate-object="text" data-key="15336"><span data-slate-leaf="true" data-offset-key="15336:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15337"><span data-slate-leaf="true" data-offset-key="15337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15338"><span data-slate-leaf="true" data-offset-key="15338:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15339"><span data-slate-leaf="true" data-offset-key="15339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="15340"><span data-slate-leaf="true" data-offset-key="15340:0" data-first-offset="true"><span data-slate-string="true"> *mm;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15341"><span data-slate-object="text" data-key="15342"><span data-slate-leaf="true" data-offset-key="15342:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15343"><span data-slate-leaf="true" data-offset-key="15343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 mm_struct 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15344"><span data-slate-object="text" data-key="15345"><span data-slate-leaf="true" data-offset-key="15345:0" data-first-offset="true"><span data-slate-string="true">    mm = </span></span></span><span data-slate-object="text" data-key="15346"><span data-slate-leaf="true" data-offset-key="15346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">allocate_mm</span></span></span></span><span data-slate-object="text" data-key="15347"><span data-slate-leaf="true" data-offset-key="15347:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15348"><span data-slate-object="text" data-key="15349"><span data-slate-leaf="true" data-offset-key="15349:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15350"><span data-slate-leaf="true" data-offset-key="15350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15351"><span data-slate-leaf="true" data-offset-key="15351:0" data-first-offset="true"><span data-slate-string="true"> (!mm)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15352"><span data-slate-object="text" data-key="15353"><span data-slate-leaf="true" data-offset-key="15353:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15354"><span data-slate-leaf="true" data-offset-key="15354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="15355"><span data-slate-leaf="true" data-offset-key="15355:0" data-first-offset="true"><span data-slate-string="true"> fail_nomem;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15356"><span data-slate-object="text" data-key="15357"><span data-slate-leaf="true" data-offset-key="15357:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15358"><span data-slate-leaf="true" data-offset-key="15358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 复制 mm_struct 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15359"><span data-slate-object="text" data-key="15360"><span data-slate-leaf="true" data-offset-key="15360:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15361"><span data-slate-leaf="true" data-offset-key="15361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">memcpy</span></span></span></span><span data-slate-object="text" data-key="15362"><span data-slate-leaf="true" data-offset-key="15362:0" data-first-offset="true"><span data-slate-string="true">(mm, oldmm, </span></span></span><span data-slate-object="text" data-key="15363"><span data-slate-leaf="true" data-offset-key="15363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="15364"><span data-slate-leaf="true" data-offset-key="15364:0" data-first-offset="true"><span data-slate-string="true">(*mm));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15365"><span data-slate-object="text" data-key="15366"><span data-slate-leaf="true" data-offset-key="15366:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15367"><span data-slate-leaf="true" data-offset-key="15367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15368"><span data-slate-object="text" data-key="15369"><span data-slate-leaf="true" data-offset-key="15369:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15370"><span data-slate-leaf="true" data-offset-key="15370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15371"><span data-slate-leaf="true" data-offset-key="15371:0" data-first-offset="true"><span data-slate-string="true"> mm;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15372"><span data-slate-object="text" data-key="15373"><span data-slate-leaf="true" data-offset-key="15373:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15374"><span data-slate-object="text" data-key="15375"><span data-slate-leaf="true" data-offset-key="15375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="15376"><span data-slate-leaf="true" data-offset-key="15376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15377"><span data-slate-leaf="true" data-offset-key="15377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="15378"><span data-slate-leaf="true" data-offset-key="15378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15379"><span data-slate-leaf="true" data-offset-key="15379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy_mm</span></span></span></span></span><span data-slate-object="text" data-key="15380"><span data-slate-leaf="true" data-offset-key="15380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="15381"><span data-slate-leaf="true" data-offset-key="15381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="15382"><span data-slate-leaf="true" data-offset-key="15382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="15383"><span data-slate-leaf="true" data-offset-key="15383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="15384"><span data-slate-leaf="true" data-offset-key="15384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> clone_flags, </span></span></span></span></span><span data-slate-object="text" data-key="15385"><span data-slate-leaf="true" data-offset-key="15385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="15386"><span data-slate-leaf="true" data-offset-key="15386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> task_struct *tsk)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15387"><span data-slate-object="text" data-key="15388"><span data-slate-leaf="true" data-offset-key="15388:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15389"><span data-slate-object="text" data-key="15390"><span data-slate-leaf="true" data-offset-key="15390:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15391"><span data-slate-leaf="true" data-offset-key="15391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15392"><span data-slate-leaf="true" data-offset-key="15392:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15393"><span data-slate-leaf="true" data-offset-key="15393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="15394"><span data-slate-leaf="true" data-offset-key="15394:0" data-first-offset="true"><span data-slate-string="true"> *mm, *oldmm;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15395"><span data-slate-object="text" data-key="15396"><span data-slate-leaf="true" data-offset-key="15396:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15397"><span data-slate-leaf="true" data-offset-key="15397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15398"><span data-slate-leaf="true" data-offset-key="15398:0" data-first-offset="true"><span data-slate-string="true"> retval;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15399"><span data-slate-object="text" data-key="15400"><span data-slate-leaf="true" data-offset-key="15400:0" data-first-offset="true"><span data-slate-string="true">    tsk-&gt;min_flt = tsk-&gt;maj_flt = </span></span></span><span data-slate-object="text" data-key="15401"><span data-slate-leaf="true" data-offset-key="15401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15402"><span data-slate-leaf="true" data-offset-key="15402:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15403"><span data-slate-object="text" data-key="15404"><span data-slate-leaf="true" data-offset-key="15404:0" data-first-offset="true"><span data-slate-string="true">    tsk-&gt;nvcsw = tsk-&gt;nivcsw = </span></span></span><span data-slate-object="text" data-key="15405"><span data-slate-leaf="true" data-offset-key="15405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15406"><span data-slate-leaf="true" data-offset-key="15406:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15407"><span data-slate-object="text" data-key="15408"><span data-slate-leaf="true" data-offset-key="15408:0" data-first-offset="true"><span data-slate-string="true">    retval = -ENOMEM;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15409"><span data-slate-object="text" data-key="15410"><span data-slate-leaf="true" data-offset-key="15410:0" data-first-offset="true"><span data-slate-string="true">    mm = </span></span></span><span data-slate-object="text" data-key="15411"><span data-slate-leaf="true" data-offset-key="15411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dup_mm</span></span></span></span><span data-slate-object="text" data-key="15412"><span data-slate-leaf="true" data-offset-key="15412:0" data-first-offset="true"><span data-slate-string="true">(tsk, current-&gt;mm);</span></span></span><span data-slate-object="text" data-key="15413"><span data-slate-leaf="true" data-offset-key="15413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 mm_struct 结构的实例变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15414"><span data-slate-object="text" data-key="15415"><span data-slate-leaf="true" data-offset-key="15415:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15416"><span data-slate-leaf="true" data-offset-key="15416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15417"><span data-slate-leaf="true" data-offset-key="15417:0" data-first-offset="true"><span data-slate-string="true"> (!mm)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15418"><span data-slate-object="text" data-key="15419"><span data-slate-leaf="true" data-offset-key="15419:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15420"><span data-slate-leaf="true" data-offset-key="15420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="15421"><span data-slate-leaf="true" data-offset-key="15421:0" data-first-offset="true"><span data-slate-string="true"> fail_nomem;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15422"><span data-slate-object="text" data-key="15423"><span data-slate-leaf="true" data-offset-key="15423:0" data-first-offset="true"><span data-slate-string="true">good_mm:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15424"><span data-slate-object="text" data-key="15425"><span data-slate-leaf="true" data-offset-key="15425:0" data-first-offset="true"><span data-slate-string="true">    tsk-&gt;mm = mm;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15426"><span data-slate-object="text" data-key="15427"><span data-slate-leaf="true" data-offset-key="15427:0" data-first-offset="true"><span data-slate-string="true">    tsk-&gt;active_mm = mm;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15428"><span data-slate-object="text" data-key="15429"><span data-slate-leaf="true" data-offset-key="15429:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15430"><span data-slate-leaf="true" data-offset-key="15430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15431"><span data-slate-leaf="true" data-offset-key="15431:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15432"><span data-slate-leaf="true" data-offset-key="15432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15433"><span data-slate-leaf="true" data-offset-key="15433:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15434"><span data-slate-object="text" data-key="15435"><span data-slate-leaf="true" data-offset-key="15435:0" data-first-offset="true"><span data-slate-string="true">fail_nomem:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15436"><span data-slate-object="text" data-key="15437"><span data-slate-leaf="true" data-offset-key="15437:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15438"><span data-slate-leaf="true" data-offset-key="15438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15439"><span data-slate-leaf="true" data-offset-key="15439:0" data-first-offset="true"><span data-slate-string="true"> retval;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15440"><span data-slate-object="text" data-key="15441"><span data-slate-leaf="true" data-offset-key="15441:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15442"><span data-slate-object="text" data-key="15443"><span data-slate-leaf="true" data-offset-key="15443:0" data-first-offset="true"><span data-slate-string="true">上述代码的 copy_mm 函数正是在 copy_process 函数中被调用的， copy_mm 函数调用 dup_mm 函数，把当前进程的 mm_struct 结构复制到 allocate_mm 宏分配的一个 mm_struct 结构中。这样，一个新进程的 mm_struct 结构就建立了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15444" id="sr-toc-5"><span data-slate-object="text" data-key="15445"><span data-slate-leaf="true" data-offset-key="15445:0" data-first-offset="true"><span data-slate-string="true">Linux 进程文件表</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15446"><span data-slate-object="text" data-key="15447"><span data-slate-leaf="true" data-offset-key="15447:0" data-first-offset="true"><span data-slate-string="true">在 Linux 系统中，可以说万物皆为文件，比如文件、设备文件、管道文件等。一个进程对一个文件进行读写操作之前，必须先打开文件，这个打开的文件就记录在进程的文件表中，它由 task_struct 结构中的 files 字段指向。这里指向的其实是个 </span></span></span><span data-slate-object="text" data-key="15448"><span data-slate-leaf="true" data-offset-key="15448:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">files_struct 结构</span></span></span></span><span data-slate-object="text" data-key="15449"><span data-slate-leaf="true" data-offset-key="15449:0" data-first-offset="true"><span data-slate-string="true">，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15450"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15451"><span data-slate-object="text" data-key="15452"><span data-slate-leaf="true" data-offset-key="15452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15453"><span data-slate-leaf="true" data-offset-key="15453:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15454"><span data-slate-leaf="true" data-offset-key="15454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">files_struct</span></span></span></span><span data-slate-object="text" data-key="15455"><span data-slate-leaf="true" data-offset-key="15455:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15456"><span data-slate-object="text" data-key="15457"><span data-slate-leaf="true" data-offset-key="15457:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15458"><span data-slate-object="text" data-key="15459"><span data-slate-leaf="true" data-offset-key="15459:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15460"><span data-slate-leaf="true" data-offset-key="15460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span><span data-slate-object="text" data-key="15461"><span data-slate-leaf="true" data-offset-key="15461:0" data-first-offset="true"><span data-slate-string="true"> count;</span></span></span><span data-slate-object="text" data-key="15462"><span data-slate-leaf="true" data-offset-key="15462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自动计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15463"><span data-slate-object="text" data-key="15464"><span data-slate-leaf="true" data-offset-key="15464:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15465"><span data-slate-leaf="true" data-offset-key="15465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15466"><span data-slate-leaf="true" data-offset-key="15466:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15467"><span data-slate-leaf="true" data-offset-key="15467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fdtable</span></span></span></span><span data-slate-object="text" data-key="15468"><span data-slate-leaf="true" data-offset-key="15468:0" data-first-offset="true"><span data-slate-string="true"> __rcu *fdt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15469"><span data-slate-object="text" data-key="15470"><span data-slate-leaf="true" data-offset-key="15470:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15471"><span data-slate-leaf="true" data-offset-key="15471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15472"><span data-slate-leaf="true" data-offset-key="15472:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15473"><span data-slate-leaf="true" data-offset-key="15473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fdtable</span></span></span></span><span data-slate-object="text" data-key="15474"><span data-slate-leaf="true" data-offset-key="15474:0" data-first-offset="true"><span data-slate-string="true"> fdtab;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15475"><span data-slate-object="text" data-key="15476"><span data-slate-leaf="true" data-offset-key="15476:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15477"><span data-slate-leaf="true" data-offset-key="15477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="15478"><span data-slate-leaf="true" data-offset-key="15478:0" data-first-offset="true"><span data-slate-string="true"> file_lock; </span></span></span><span data-slate-object="text" data-key="15479"><span data-slate-leaf="true" data-offset-key="15479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15480"><span data-slate-object="text" data-key="15481"><span data-slate-leaf="true" data-offset-key="15481:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15482"><span data-slate-leaf="true" data-offset-key="15482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15483"><span data-slate-leaf="true" data-offset-key="15483:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15484"><span data-slate-leaf="true" data-offset-key="15484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15485"><span data-slate-leaf="true" data-offset-key="15485:0" data-first-offset="true"><span data-slate-string="true"> next_fd;</span></span></span><span data-slate-object="text" data-key="15486"><span data-slate-leaf="true" data-offset-key="15486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 下一个文件句柄</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15487"><span data-slate-object="text" data-key="15488"><span data-slate-leaf="true" data-offset-key="15488:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15489"><span data-slate-leaf="true" data-offset-key="15489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15490"><span data-slate-leaf="true" data-offset-key="15490:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15491"><span data-slate-leaf="true" data-offset-key="15491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15492"><span data-slate-leaf="true" data-offset-key="15492:0" data-first-offset="true"><span data-slate-string="true"> close_on_exec_init[</span></span></span><span data-slate-object="text" data-key="15493"><span data-slate-leaf="true" data-offset-key="15493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15494"><span data-slate-leaf="true" data-offset-key="15494:0" data-first-offset="true"><span data-slate-string="true">];</span></span></span><span data-slate-object="text" data-key="15495"><span data-slate-leaf="true" data-offset-key="15495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行 exec () 时要关闭的文件句柄</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15496"><span data-slate-object="text" data-key="15497"><span data-slate-leaf="true" data-offset-key="15497:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15498"><span data-slate-leaf="true" data-offset-key="15498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15499"><span data-slate-leaf="true" data-offset-key="15499:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15500"><span data-slate-leaf="true" data-offset-key="15500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15501"><span data-slate-leaf="true" data-offset-key="15501:0" data-first-offset="true"><span data-slate-string="true"> open_fds_init[</span></span></span><span data-slate-object="text" data-key="15502"><span data-slate-leaf="true" data-offset-key="15502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15503"><span data-slate-leaf="true" data-offset-key="15503:0" data-first-offset="true"><span data-slate-string="true">];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15504"><span data-slate-object="text" data-key="15505"><span data-slate-leaf="true" data-offset-key="15505:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15506"><span data-slate-leaf="true" data-offset-key="15506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15507"><span data-slate-leaf="true" data-offset-key="15507:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15508"><span data-slate-leaf="true" data-offset-key="15508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15509"><span data-slate-leaf="true" data-offset-key="15509:0" data-first-offset="true"><span data-slate-string="true"> full_fds_bits_init[</span></span></span><span data-slate-object="text" data-key="15510"><span data-slate-leaf="true" data-offset-key="15510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15511"><span data-slate-leaf="true" data-offset-key="15511:0" data-first-offset="true"><span data-slate-string="true">];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15512"><span data-slate-object="text" data-key="15513"><span data-slate-leaf="true" data-offset-key="15513:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15514"><span data-slate-leaf="true" data-offset-key="15514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15515"><span data-slate-leaf="true" data-offset-key="15515:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15516"><span data-slate-leaf="true" data-offset-key="15516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">file</span></span></span></span><span data-slate-object="text" data-key="15517"><span data-slate-leaf="true" data-offset-key="15517:0" data-first-offset="true"><span data-slate-string="true"> __rcu * fd_array[NR_OPEN_DEFAULT];</span></span></span><span data-slate-object="text" data-key="15518"><span data-slate-leaf="true" data-offset-key="15518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 默认情况下打开文件的指针数组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15519"><span data-slate-object="text" data-key="15520"><span data-slate-leaf="true" data-offset-key="15520:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15521"><span data-slate-object="text" data-key="15522"><span data-slate-leaf="true" data-offset-key="15522:0" data-first-offset="true"><span data-slate-string="true">从上述代码中，可以推想出我们在应用软件中调用：int fd = open ("/tmp/test.txt"); 实际 Linux 会建立一个 struct file 结构体实例变量与文件对应，然后把 struct file 结构体实例变量的指针放入 fd_array 数组中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15523"><span data-slate-object="text" data-key="15524"><span data-slate-leaf="true" data-offset-key="15524:0" data-first-offset="true"><span data-slate-string="true">那么 Linux 在建立一个新进程时，怎样给新进程建立一个 files_struct 结构呢？其实很简单，也是复制当前进程的 files_struct 结构，代码如下所示。</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="15525"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15526"><span data-slate-object="text" data-key="15527"><span data-slate-leaf="true" data-offset-key="15527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="15528"><span data-slate-leaf="true" data-offset-key="15528:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15529"><span data-slate-leaf="true" data-offset-key="15529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15530"><span data-slate-leaf="true" data-offset-key="15530:0" data-first-offset="true"><span data-slate-string="true"> copy_files(</span></span></span><span data-slate-object="text" data-key="15531"><span data-slate-leaf="true" data-offset-key="15531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15532"><span data-slate-leaf="true" data-offset-key="15532:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15533"><span data-slate-leaf="true" data-offset-key="15533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="15534"><span data-slate-leaf="true" data-offset-key="15534:0" data-first-offset="true"><span data-slate-string="true"> clone_flags, </span></span></span><span data-slate-object="text" data-key="15535"><span data-slate-leaf="true" data-offset-key="15535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15536"><span data-slate-leaf="true" data-offset-key="15536:0" data-first-offset="true"><span data-slate-string="true"> task_struct *tsk)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15537"><span data-slate-object="text" data-key="15538"><span data-slate-leaf="true" data-offset-key="15538:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15539"><span data-slate-object="text" data-key="15540"><span data-slate-leaf="true" data-offset-key="15540:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15541"><span data-slate-leaf="true" data-offset-key="15541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15542"><span data-slate-leaf="true" data-offset-key="15542:0" data-first-offset="true"><span data-slate-string="true"> files_struct *oldf, *newf;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15543"><span data-slate-object="text" data-key="15544"><span data-slate-leaf="true" data-offset-key="15544:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15545"><span data-slate-leaf="true" data-offset-key="15545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15546"><span data-slate-leaf="true" data-offset-key="15546:0" data-first-offset="true"><span data-slate-string="true"> error = </span></span></span><span data-slate-object="text" data-key="15547"><span data-slate-leaf="true" data-offset-key="15547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15548"><span data-slate-leaf="true" data-offset-key="15548:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15549"><span data-slate-object="text" data-key="15550"><span data-slate-leaf="true" data-offset-key="15550:0" data-first-offset="true"><span data-slate-string="true">    oldf = current-&gt;files;</span></span></span><span data-slate-object="text" data-key="15551"><span data-slate-leaf="true" data-offset-key="15551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前进程的 files_struct 的指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15552"><span data-slate-object="text" data-key="15553"><span data-slate-leaf="true" data-offset-key="15553:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15554"><span data-slate-leaf="true" data-offset-key="15554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15555"><span data-slate-leaf="true" data-offset-key="15555:0" data-first-offset="true"><span data-slate-string="true"> (!oldf)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15556"><span data-slate-object="text" data-key="15557"><span data-slate-leaf="true" data-offset-key="15557:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15558"><span data-slate-leaf="true" data-offset-key="15558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="15559"><span data-slate-leaf="true" data-offset-key="15559:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15560"><span data-slate-leaf="true" data-offset-key="15560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="15561"><span data-slate-leaf="true" data-offset-key="15561:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15562"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15563"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15564"><span data-slate-object="text" data-key="15565"><span data-slate-leaf="true" data-offset-key="15565:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15566"><span data-slate-leaf="true" data-offset-key="15566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15567"><span data-slate-leaf="true" data-offset-key="15567:0" data-first-offset="true"><span data-slate-string="true"> (clone_flags &amp; </span></span></span><span data-slate-object="text" data-key="15568"><span data-slate-leaf="true" data-offset-key="15568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLONE_FILES</span></span></span></span><span data-slate-object="text" data-key="15569"><span data-slate-leaf="true" data-offset-key="15569:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15570"><span data-slate-object="text" data-key="15571"><span data-slate-leaf="true" data-offset-key="15571:0" data-first-offset="true"><span data-slate-string="true">        atomic_inc(&amp;oldf-&gt;count);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15572"><span data-slate-object="text" data-key="15573"><span data-slate-leaf="true" data-offset-key="15573:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15574"><span data-slate-leaf="true" data-offset-key="15574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="15575"><span data-slate-leaf="true" data-offset-key="15575:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15576"><span data-slate-leaf="true" data-offset-key="15576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="15577"><span data-slate-leaf="true" data-offset-key="15577:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15578"><span data-slate-object="text" data-key="15579"><span data-slate-leaf="true" data-offset-key="15579:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15580"><span data-slate-object="text" data-key="15581"><span data-slate-leaf="true" data-offset-key="15581:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15582"><span data-slate-leaf="true" data-offset-key="15582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配新 files_struct 结构的实例变量，并复制当前的 files_struct 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15583"><span data-slate-object="text" data-key="15584"><span data-slate-leaf="true" data-offset-key="15584:0" data-first-offset="true"><span data-slate-string="true">    newf = dup_fd(oldf, NR_OPEN_MAX, &amp;error);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15585"><span data-slate-object="text" data-key="15586"><span data-slate-leaf="true" data-offset-key="15586:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15587"><span data-slate-leaf="true" data-offset-key="15587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15588"><span data-slate-leaf="true" data-offset-key="15588:0" data-first-offset="true"><span data-slate-string="true"> (!newf)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15589"><span data-slate-object="text" data-key="15590"><span data-slate-leaf="true" data-offset-key="15590:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15591"><span data-slate-leaf="true" data-offset-key="15591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="15592"><span data-slate-leaf="true" data-offset-key="15592:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15593"><span data-slate-leaf="true" data-offset-key="15593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="15594"><span data-slate-leaf="true" data-offset-key="15594:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15595"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15596"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15597"><span data-slate-object="text" data-key="15598"><span data-slate-leaf="true" data-offset-key="15598:0" data-first-offset="true"><span data-slate-string="true">    tsk-&gt;files = newf;</span></span></span><span data-slate-object="text" data-key="15599"><span data-slate-leaf="true" data-offset-key="15599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 新进程的 files_struct 结构指针指向新的 files_struct 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15600"><span data-slate-object="text" data-key="15601"><span data-slate-leaf="true" data-offset-key="15601:0" data-first-offset="true"><span data-slate-string="true">    error = </span></span></span><span data-slate-object="text" data-key="15602"><span data-slate-leaf="true" data-offset-key="15602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15603"><span data-slate-leaf="true" data-offset-key="15603:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15604"><span data-slate-object="text" data-key="15605"><span data-slate-leaf="true" data-offset-key="15605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="15606"><span data-slate-leaf="true" data-offset-key="15606:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15607"><span data-slate-object="text" data-key="15608"><span data-slate-leaf="true" data-offset-key="15608:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15609"><span data-slate-leaf="true" data-offset-key="15609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15610"><span data-slate-leaf="true" data-offset-key="15610:0" data-first-offset="true"><span data-slate-string="true"> error;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15611"><span data-slate-object="text" data-key="15612"><span data-slate-leaf="true" data-offset-key="15612:0" data-first-offset="true"><span data-slate-string="true">同样的，copy_files 函数由 copy_process 函数调用，copy_files 最终会复制当前进程的 files_struct 结构到一个新的 files_struct 结构实例变量中，并让新进程的 files 指针指向这个新的 files_struct 结构实例变量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15613"><span data-slate-object="text" data-key="15614"><span data-slate-leaf="true" data-offset-key="15614:0" data-first-offset="true"><span data-slate-string="true">好了，关于进程的一些数据结构，我们就了解这么多，因为现在你还无需知道 Linux 进程的所有细节，对于一个庞大的系统，</span></span></span><span data-slate-object="text" data-key="15615"><span data-slate-leaf="true" data-offset-key="15615:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最大的误区是陷入细节而不知全貌</span></span></span></span><span data-slate-object="text" data-key="15616"><span data-slate-leaf="true" data-offset-key="15616:0" data-first-offset="true"><span data-slate-string="true">。这里，我们只需要知道 Linux 用什么代表一个进程就行了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15617" id="sr-toc-6"><span data-slate-object="text" data-key="15618"><span data-slate-leaf="true" data-offset-key="15618:0" data-first-offset="true"><span data-slate-string="true">Linux 进程调度</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15619"><span data-slate-object="text" data-key="15620"><span data-slate-leaf="true" data-offset-key="15620:0" data-first-offset="true"><span data-slate-string="true">Linux 支持多 CPU 上运行多进程，这就要说到多进程调度了。Linux 进程调度支持多种调度算法，有基于优先级的调度算法，有实时调度算法，有完全公平调度算法（CFQ）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15621"><span data-slate-object="text" data-key="15622"><span data-slate-leaf="true" data-offset-key="15622:0" data-first-offset="true"><span data-slate-string="true">下面我们以 CFQ 为例进行探讨，我们先了解一下 CFQ 相关的数据结构，随后探讨 CFQ 算法要怎样实现。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15623" id="sr-toc-7"><span data-slate-object="text" data-key="15624"><span data-slate-leaf="true" data-offset-key="15624:0" data-first-offset="true"><span data-slate-string="true">进程调度实体</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15625"><span data-slate-object="text" data-key="15626"><span data-slate-leaf="true" data-offset-key="15626:0" data-first-offset="true"><span data-slate-string="true">我们先来看看什么是进程调度实体，它是干什么的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15627"><span data-slate-object="text" data-key="15628"><span data-slate-leaf="true" data-offset-key="15628:0" data-first-offset="true"><span data-slate-string="true">它其实是 Linux 进程调度系统的一部分，被嵌入到了 Linux 进程数据结构中，与调度器进行关联，能间接地访问进程，</span></span></span><span data-slate-object="text" data-key="15629"><span data-slate-leaf="true" data-offset-key="15629:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这种高内聚低耦合的方式，保证了进程数据结构和调度数据结构相互独立</span></span></span></span><span data-slate-object="text" data-key="15630"><span data-slate-leaf="true" data-offset-key="15630:0" data-first-offset="true"><span data-slate-string="true">，我们后面可以分别做改进、优化，这是一种高明的软件设计思想。我们来看看这个结构，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15631"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15632"><span data-slate-object="text" data-key="15633"><span data-slate-leaf="true" data-offset-key="15633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15634"><span data-slate-leaf="true" data-offset-key="15634:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15635"><span data-slate-leaf="true" data-offset-key="15635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="15636"><span data-slate-leaf="true" data-offset-key="15636:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15637"><span data-slate-object="text" data-key="15638"><span data-slate-leaf="true" data-offset-key="15638:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15639"><span data-slate-leaf="true" data-offset-key="15639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15640"><span data-slate-leaf="true" data-offset-key="15640:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15641"><span data-slate-leaf="true" data-offset-key="15641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">load_weight</span></span></span></span><span data-slate-object="text" data-key="15642"><span data-slate-leaf="true" data-offset-key="15642:0" data-first-offset="true"><span data-slate-string="true"> load;</span></span></span><span data-slate-object="text" data-key="15643"><span data-slate-leaf="true" data-offset-key="15643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 表示当前调度实体的权重</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15644"><span data-slate-object="text" data-key="15645"><span data-slate-leaf="true" data-offset-key="15645:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15646"><span data-slate-leaf="true" data-offset-key="15646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15647"><span data-slate-leaf="true" data-offset-key="15647:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15648"><span data-slate-leaf="true" data-offset-key="15648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_node</span></span></span></span><span data-slate-object="text" data-key="15649"><span data-slate-leaf="true" data-offset-key="15649:0" data-first-offset="true"><span data-slate-string="true"> run_node;</span></span></span><span data-slate-object="text" data-key="15650"><span data-slate-leaf="true" data-offset-key="15650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 红黑树的数据节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15651"><span data-slate-object="text" data-key="15652"><span data-slate-leaf="true" data-offset-key="15652:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15653"><span data-slate-leaf="true" data-offset-key="15653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15654"><span data-slate-leaf="true" data-offset-key="15654:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15655"><span data-slate-leaf="true" data-offset-key="15655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_head</span></span></span></span><span data-slate-object="text" data-key="15656"><span data-slate-leaf="true" data-offset-key="15656:0" data-first-offset="true"><span data-slate-string="true"> group_node;</span></span></span><span data-slate-object="text" data-key="15657"><span data-slate-leaf="true" data-offset-key="15657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 链表节点，被链接到 percpu 的 rq-&gt;cfs_tasks</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15658"><span data-slate-object="text" data-key="15659"><span data-slate-leaf="true" data-offset-key="15659:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15660"><span data-slate-leaf="true" data-offset-key="15660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15661"><span data-slate-leaf="true" data-offset-key="15661:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15662"><span data-slate-leaf="true" data-offset-key="15662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15663"><span data-slate-leaf="true" data-offset-key="15663:0" data-first-offset="true"><span data-slate-string="true"> on_rq; </span></span></span><span data-slate-object="text" data-key="15664"><span data-slate-leaf="true" data-offset-key="15664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前调度实体是否在就绪队列上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15665"><span data-slate-object="text" data-key="15666"><span data-slate-leaf="true" data-offset-key="15666:0" data-first-offset="true"><span data-slate-string="true">    u64 exec_start;</span></span></span><span data-slate-object="text" data-key="15667"><span data-slate-leaf="true" data-offset-key="15667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前实体上次被调度执行的时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15668"><span data-slate-object="text" data-key="15669"><span data-slate-leaf="true" data-offset-key="15669:0" data-first-offset="true"><span data-slate-string="true">    u64 sum_exec_runtime;</span></span></span><span data-slate-object="text" data-key="15670"><span data-slate-leaf="true" data-offset-key="15670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前实体总执行时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15671"><span data-slate-object="text" data-key="15672"><span data-slate-leaf="true" data-offset-key="15672:0" data-first-offset="true"><span data-slate-string="true">    u64 prev_sum_exec_runtime;</span></span></span><span data-slate-object="text" data-key="15673"><span data-slate-leaf="true" data-offset-key="15673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 截止到上次统计，进程执行的时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15674"><span data-slate-object="text" data-key="15675"><span data-slate-leaf="true" data-offset-key="15675:0" data-first-offset="true"><span data-slate-string="true">    u64 vruntime;</span></span></span><span data-slate-object="text" data-key="15676"><span data-slate-leaf="true" data-offset-key="15676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前实体的虚拟时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15677"><span data-slate-object="text" data-key="15678"><span data-slate-leaf="true" data-offset-key="15678:0" data-first-offset="true"><span data-slate-string="true">    u64 nr_migrations;</span></span></span><span data-slate-object="text" data-key="15679"><span data-slate-leaf="true" data-offset-key="15679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实体执行迁移的次数 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15680"><span data-slate-object="text" data-key="15681"><span data-slate-leaf="true" data-offset-key="15681:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15682"><span data-slate-leaf="true" data-offset-key="15682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15683"><span data-slate-leaf="true" data-offset-key="15683:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15684"><span data-slate-leaf="true" data-offset-key="15684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_statistics</span></span></span></span><span data-slate-object="text" data-key="15685"><span data-slate-leaf="true" data-offset-key="15685:0" data-first-offset="true"><span data-slate-string="true"> statistics;</span></span></span><span data-slate-object="text" data-key="15686"><span data-slate-leaf="true" data-offset-key="15686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 统计信息包含进程的睡眠统计、等待延迟统计、CPU 迁移统计、唤醒统计等。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15687"><span data-slate-object="text" data-key="15688"><span data-slate-leaf="true" data-offset-key="15688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="15689"><span data-slate-leaf="true" data-offset-key="15689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ifdef</span></span></span></span></span><span data-slate-object="text" data-key="15690"><span data-slate-leaf="true" data-offset-key="15690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> CONFIG_FAIR_GROUP_SCHED</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15691"><span data-slate-object="text" data-key="15692"><span data-slate-leaf="true" data-offset-key="15692:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15693"><span data-slate-leaf="true" data-offset-key="15693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15694"><span data-slate-leaf="true" data-offset-key="15694:0" data-first-offset="true"><span data-slate-string="true"> depth;</span></span></span><span data-slate-object="text" data-key="15695"><span data-slate-leaf="true" data-offset-key="15695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 表示当前实体处于调度组中的深度</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15696"><span data-slate-object="text" data-key="15697"><span data-slate-leaf="true" data-offset-key="15697:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15698"><span data-slate-leaf="true" data-offset-key="15698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15699"><span data-slate-leaf="true" data-offset-key="15699:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15700"><span data-slate-leaf="true" data-offset-key="15700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="15701"><span data-slate-leaf="true" data-offset-key="15701:0" data-first-offset="true"><span data-slate-string="true"> *parent;</span></span></span><span data-slate-object="text" data-key="15702"><span data-slate-leaf="true" data-offset-key="15702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向父级调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15703"><span data-slate-object="text" data-key="15704"><span data-slate-leaf="true" data-offset-key="15704:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15705"><span data-slate-leaf="true" data-offset-key="15705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15706"><span data-slate-leaf="true" data-offset-key="15706:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15707"><span data-slate-leaf="true" data-offset-key="15707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="15708"><span data-slate-leaf="true" data-offset-key="15708:0" data-first-offset="true"><span data-slate-string="true"> *cfs_rq;</span></span></span><span data-slate-object="text" data-key="15709"><span data-slate-leaf="true" data-offset-key="15709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前调度实体属于的 cfs_rq.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15710"><span data-slate-object="text" data-key="15711"><span data-slate-leaf="true" data-offset-key="15711:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15712"><span data-slate-leaf="true" data-offset-key="15712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15713"><span data-slate-leaf="true" data-offset-key="15713:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15714"><span data-slate-leaf="true" data-offset-key="15714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="15715"><span data-slate-leaf="true" data-offset-key="15715:0" data-first-offset="true"><span data-slate-string="true"> *my_q;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15716"><span data-slate-object="text" data-key="15717"><span data-slate-leaf="true" data-offset-key="15717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="15718"><span data-slate-leaf="true" data-offset-key="15718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15719"><span data-slate-object="text" data-key="15720"><span data-slate-leaf="true" data-offset-key="15720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="15721"><span data-slate-leaf="true" data-offset-key="15721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ifdef</span></span></span></span></span><span data-slate-object="text" data-key="15722"><span data-slate-leaf="true" data-offset-key="15722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> CONFIG_SMP</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15723"><span data-slate-object="text" data-key="15724"><span data-slate-leaf="true" data-offset-key="15724:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15725"><span data-slate-leaf="true" data-offset-key="15725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15726"><span data-slate-leaf="true" data-offset-key="15726:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15727"><span data-slate-leaf="true" data-offset-key="15727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_avg</span></span></span></span><span data-slate-object="text" data-key="15728"><span data-slate-leaf="true" data-offset-key="15728:0" data-first-offset="true"><span data-slate-string="true"> avg ;</span></span></span><span data-slate-object="text" data-key="15729"><span data-slate-leaf="true" data-offset-key="15729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 记录当前实体对于 CPU 的负载</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15730"><span data-slate-object="text" data-key="15731"><span data-slate-leaf="true" data-offset-key="15731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="15732"><span data-slate-leaf="true" data-offset-key="15732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15733"><span data-slate-object="text" data-key="15734"><span data-slate-leaf="true" data-offset-key="15734:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15735"><span data-slate-object="text" data-key="15736"><span data-slate-leaf="true" data-offset-key="15736:0" data-first-offset="true"><span data-slate-string="true">上述代码的信息量很多，但是我们现在不急于搞清楚所有的信息，我们现在需要知道的是</span></span></span><span data-slate-object="text" data-key="15737"><span data-slate-leaf="true" data-offset-key="15737:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 task_struct 结构中，会包含至少一个 sched_entity 结构的变量</span></span></span></span><span data-slate-object="text" data-key="15738"><span data-slate-leaf="true" data-offset-key="15738:0" data-first-offset="true"><span data-slate-string="true">，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15739"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/00/91/00de9da1b13f6f3e975050a393782891.jpg?wh=2405x1574"></div><div>调度实体在进程结构中的位置</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15740"><span data-slate-object="text" data-key="15741"><span data-slate-leaf="true" data-offset-key="15741:0" data-first-offset="true"><span data-slate-string="true">结合图示，我们只要通过 sched_entity 结构变量的地址，减去它在 task_struct 结构中的偏移（由编译器自动计算），就能获取到 task_struct 结构的地址。这样就能达到通过 sched_entity 结构，访问 task_struct 结构的目的了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15742" id="sr-toc-8"><span data-slate-object="text" data-key="15743"><span data-slate-leaf="true" data-offset-key="15743:0" data-first-offset="true"><span data-slate-string="true">进程运行队列</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15744"><span data-slate-object="text" data-key="15745"><span data-slate-leaf="true" data-offset-key="15745:0" data-first-offset="true"><span data-slate-string="true">那么，在 Linux 中，又是怎样组织众多调度实体，进而组织众多进程，方便进程调度器找到调度实体呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15746"><span data-slate-object="text" data-key="15747"><span data-slate-leaf="true" data-offset-key="15747:0" data-first-offset="true"><span data-slate-string="true">首先，Linux 定义了一个进程运行队列结构，每个 CPU 分配一个这样的进程运行队列结构实例变量，进程运行队列结构的代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15748"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15749"><span data-slate-object="text" data-key="15750"><span data-slate-leaf="true" data-offset-key="15750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15751"><span data-slate-leaf="true" data-offset-key="15751:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15752"><span data-slate-leaf="true" data-offset-key="15752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq</span></span></span></span><span data-slate-object="text" data-key="15753"><span data-slate-leaf="true" data-offset-key="15753:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15754"><span data-slate-object="text" data-key="15755"><span data-slate-leaf="true" data-offset-key="15755:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15756"><span data-slate-leaf="true" data-offset-key="15756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="15757"><span data-slate-leaf="true" data-offset-key="15757:0" data-first-offset="true"><span data-slate-string="true">      lock;</span></span></span><span data-slate-object="text" data-key="15758"><span data-slate-leaf="true" data-offset-key="15758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15759"><span data-slate-object="text" data-key="15760"><span data-slate-leaf="true" data-offset-key="15760:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15761"><span data-slate-leaf="true" data-offset-key="15761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15762"><span data-slate-leaf="true" data-offset-key="15762:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15763"><span data-slate-leaf="true" data-offset-key="15763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15764"><span data-slate-leaf="true" data-offset-key="15764:0" data-first-offset="true"><span data-slate-string="true">        nr_running;</span></span></span><span data-slate-object="text" data-key="15765"><span data-slate-leaf="true" data-offset-key="15765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 多个就绪运行进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15766"><span data-slate-object="text" data-key="15767"><span data-slate-leaf="true" data-offset-key="15767:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15768"><span data-slate-leaf="true" data-offset-key="15768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15769"><span data-slate-leaf="true" data-offset-key="15769:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15770"><span data-slate-leaf="true" data-offset-key="15770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="15771"><span data-slate-leaf="true" data-offset-key="15771:0" data-first-offset="true"><span data-slate-string="true">       cfs; </span></span></span><span data-slate-object="text" data-key="15772"><span data-slate-leaf="true" data-offset-key="15772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 作用于完全公平调度算法的运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15773"><span data-slate-object="text" data-key="15774"><span data-slate-leaf="true" data-offset-key="15774:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15775"><span data-slate-leaf="true" data-offset-key="15775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15776"><span data-slate-leaf="true" data-offset-key="15776:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15777"><span data-slate-leaf="true" data-offset-key="15777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rt_rq</span></span></span></span><span data-slate-object="text" data-key="15778"><span data-slate-leaf="true" data-offset-key="15778:0" data-first-offset="true"><span data-slate-string="true">        rt;</span></span></span><span data-slate-object="text" data-key="15779"><span data-slate-leaf="true" data-offset-key="15779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 作用于实时调度算法的运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15780"><span data-slate-object="text" data-key="15781"><span data-slate-leaf="true" data-offset-key="15781:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15782"><span data-slate-leaf="true" data-offset-key="15782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15783"><span data-slate-leaf="true" data-offset-key="15783:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15784"><span data-slate-leaf="true" data-offset-key="15784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dl_rq</span></span></span></span><span data-slate-object="text" data-key="15785"><span data-slate-leaf="true" data-offset-key="15785:0" data-first-offset="true"><span data-slate-string="true">        dl;</span></span></span><span data-slate-object="text" data-key="15786"><span data-slate-leaf="true" data-offset-key="15786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 作用于 EDF 调度算法的运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15787"><span data-slate-object="text" data-key="15788"><span data-slate-leaf="true" data-offset-key="15788:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15789"><span data-slate-leaf="true" data-offset-key="15789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15790"><span data-slate-leaf="true" data-offset-key="15790:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15791"><span data-slate-leaf="true" data-offset-key="15791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15792"><span data-slate-leaf="true" data-offset-key="15792:0" data-first-offset="true"><span data-slate-string="true"> __rcu    *curr;</span></span></span><span data-slate-object="text" data-key="15793"><span data-slate-leaf="true" data-offset-key="15793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个运行队列当前正在运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15794"><span data-slate-object="text" data-key="15795"><span data-slate-leaf="true" data-offset-key="15795:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15796"><span data-slate-leaf="true" data-offset-key="15796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15797"><span data-slate-leaf="true" data-offset-key="15797:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15798"><span data-slate-leaf="true" data-offset-key="15798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15799"><span data-slate-leaf="true" data-offset-key="15799:0" data-first-offset="true"><span data-slate-string="true">  *idle;</span></span></span><span data-slate-object="text" data-key="15800"><span data-slate-leaf="true" data-offset-key="15800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个运行队列的空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15801"><span data-slate-object="text" data-key="15802"><span data-slate-leaf="true" data-offset-key="15802:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15803"><span data-slate-leaf="true" data-offset-key="15803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15804"><span data-slate-leaf="true" data-offset-key="15804:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15805"><span data-slate-leaf="true" data-offset-key="15805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="15806"><span data-slate-leaf="true" data-offset-key="15806:0" data-first-offset="true"><span data-slate-string="true">  *stop;</span></span></span><span data-slate-object="text" data-key="15807"><span data-slate-leaf="true" data-offset-key="15807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个运行队列的停止进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15808"><span data-slate-object="text" data-key="15809"><span data-slate-leaf="true" data-offset-key="15809:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15810"><span data-slate-leaf="true" data-offset-key="15810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15811"><span data-slate-leaf="true" data-offset-key="15811:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15812"><span data-slate-leaf="true" data-offset-key="15812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mm_struct</span></span></span></span><span data-slate-object="text" data-key="15813"><span data-slate-leaf="true" data-offset-key="15813:0" data-first-offset="true"><span data-slate-string="true">    *prev_mm;</span></span></span><span data-slate-object="text" data-key="15814"><span data-slate-leaf="true" data-offset-key="15814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个运行队列上一次运行进程的 mm_struct</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15815"><span data-slate-object="text" data-key="15816"><span data-slate-leaf="true" data-offset-key="15816:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15817"><span data-slate-leaf="true" data-offset-key="15817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15818"><span data-slate-leaf="true" data-offset-key="15818:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15819"><span data-slate-leaf="true" data-offset-key="15819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15820"><span data-slate-leaf="true" data-offset-key="15820:0" data-first-offset="true"><span data-slate-string="true">        clock_update_flags;</span></span></span><span data-slate-object="text" data-key="15821"><span data-slate-leaf="true" data-offset-key="15821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 时钟更新标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15822"><span data-slate-object="text" data-key="15823"><span data-slate-leaf="true" data-offset-key="15823:0" data-first-offset="true"><span data-slate-string="true">    u64         clock; </span></span></span><span data-slate-object="text" data-key="15824"><span data-slate-leaf="true" data-offset-key="15824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行队列的时间 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15825"><span data-slate-object="text" data-key="15826"><span data-slate-leaf="true" data-offset-key="15826:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15827"><span data-slate-leaf="true" data-offset-key="15827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 后面的代码省略</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15828"><span data-slate-object="text" data-key="15829"><span data-slate-leaf="true" data-offset-key="15829:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15830"><span data-slate-object="text" data-key="15831"><span data-slate-leaf="true" data-offset-key="15831:0" data-first-offset="true"><span data-slate-string="true">以上这个 rq 结构结构中，很多我们不需要关注的字段我已经省略了。你要重点理解的是，其中 task_struct 结构指针是为了快速访问特殊进程，而 rq 结构并不直接关联调度实体，而是包含了 cfs_rq、rt_rq、dl_rq，通过它们来关联调度实体。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15832"><span data-slate-object="text" data-key="15833"><span data-slate-leaf="true" data-offset-key="15833:0" data-first-offset="true"><span data-slate-string="true">有三个不同的运行队列，是因为作用于三种不同的调度算法。我们这里只需要关注 cfs_rq，代码我列在了后面。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15834"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15835"><span data-slate-object="text" data-key="15836"><span data-slate-leaf="true" data-offset-key="15836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15837"><span data-slate-leaf="true" data-offset-key="15837:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15838"><span data-slate-leaf="true" data-offset-key="15838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_root_cached</span></span></span></span><span data-slate-object="text" data-key="15839"><span data-slate-leaf="true" data-offset-key="15839:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15840"><span data-slate-object="text" data-key="15841"><span data-slate-leaf="true" data-offset-key="15841:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15842"><span data-slate-leaf="true" data-offset-key="15842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15843"><span data-slate-leaf="true" data-offset-key="15843:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15844"><span data-slate-leaf="true" data-offset-key="15844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_root</span></span></span></span><span data-slate-object="text" data-key="15845"><span data-slate-leaf="true" data-offset-key="15845:0" data-first-offset="true"><span data-slate-string="true"> rb_root;   </span></span></span><span data-slate-object="text" data-key="15846"><span data-slate-leaf="true" data-offset-key="15846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 红黑树的根</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15847"><span data-slate-object="text" data-key="15848"><span data-slate-leaf="true" data-offset-key="15848:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15849"><span data-slate-leaf="true" data-offset-key="15849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15850"><span data-slate-leaf="true" data-offset-key="15850:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15851"><span data-slate-leaf="true" data-offset-key="15851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_node</span></span></span></span><span data-slate-object="text" data-key="15852"><span data-slate-leaf="true" data-offset-key="15852:0" data-first-offset="true"><span data-slate-string="true"> *rb_leftmost;</span></span></span><span data-slate-object="text" data-key="15853"><span data-slate-leaf="true" data-offset-key="15853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 红黑树最左子节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15854"><span data-slate-object="text" data-key="15855"><span data-slate-leaf="true" data-offset-key="15855:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15856"><span data-slate-object="text" data-key="15857"><span data-slate-leaf="true" data-offset-key="15857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15858"><span data-slate-leaf="true" data-offset-key="15858:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15859"><span data-slate-leaf="true" data-offset-key="15859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="15860"><span data-slate-leaf="true" data-offset-key="15860:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15861"><span data-slate-object="text" data-key="15862"><span data-slate-leaf="true" data-offset-key="15862:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15863"><span data-slate-leaf="true" data-offset-key="15863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15864"><span data-slate-leaf="true" data-offset-key="15864:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15865"><span data-slate-leaf="true" data-offset-key="15865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">load_weight</span></span></span></span><span data-slate-object="text" data-key="15866"><span data-slate-leaf="true" data-offset-key="15866:0" data-first-offset="true"><span data-slate-string="true">  load;</span></span></span><span data-slate-object="text" data-key="15867"><span data-slate-leaf="true" data-offset-key="15867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cfs_rq 上所有调度实体的负载总和</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15868"><span data-slate-object="text" data-key="15869"><span data-slate-leaf="true" data-offset-key="15869:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15870"><span data-slate-leaf="true" data-offset-key="15870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15871"><span data-slate-leaf="true" data-offset-key="15871:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15872"><span data-slate-leaf="true" data-offset-key="15872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15873"><span data-slate-leaf="true" data-offset-key="15873:0" data-first-offset="true"><span data-slate-string="true"> nr_running;</span></span></span><span data-slate-object="text" data-key="15874"><span data-slate-leaf="true" data-offset-key="15874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cfs_rq 上所有的调度实体不含调度组中的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15875"><span data-slate-object="text" data-key="15876"><span data-slate-leaf="true" data-offset-key="15876:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15877"><span data-slate-leaf="true" data-offset-key="15877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="15878"><span data-slate-leaf="true" data-offset-key="15878:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15879"><span data-slate-leaf="true" data-offset-key="15879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15880"><span data-slate-leaf="true" data-offset-key="15880:0" data-first-offset="true"><span data-slate-string="true"> h_nr_running;</span></span></span><span data-slate-object="text" data-key="15881"><span data-slate-leaf="true" data-offset-key="15881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cfs_rq 上所有的调度实体包含调度组中所有调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15882"><span data-slate-object="text" data-key="15883"><span data-slate-leaf="true" data-offset-key="15883:0" data-first-offset="true"><span data-slate-string="true">    u64         exec_clock;</span></span></span><span data-slate-object="text" data-key="15884"><span data-slate-leaf="true" data-offset-key="15884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前 cfs_rq 上执行的时间 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15885"><span data-slate-object="text" data-key="15886"><span data-slate-leaf="true" data-offset-key="15886:0" data-first-offset="true"><span data-slate-string="true">    u64         min_vruntime;</span></span></span><span data-slate-object="text" data-key="15887"><span data-slate-leaf="true" data-offset-key="15887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最小虚拟运行时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15888"><span data-slate-object="text" data-key="15889"><span data-slate-leaf="true" data-offset-key="15889:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15890"><span data-slate-leaf="true" data-offset-key="15890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15891"><span data-slate-leaf="true" data-offset-key="15891:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15892"><span data-slate-leaf="true" data-offset-key="15892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_root_cached</span></span></span></span><span data-slate-object="text" data-key="15893"><span data-slate-leaf="true" data-offset-key="15893:0" data-first-offset="true"><span data-slate-string="true">   tasks_timeline;</span></span></span><span data-slate-object="text" data-key="15894"><span data-slate-leaf="true" data-offset-key="15894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 所有调度实体的根</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15895"><span data-slate-object="text" data-key="15896"><span data-slate-leaf="true" data-offset-key="15896:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15897"><span data-slate-leaf="true" data-offset-key="15897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15898"><span data-slate-leaf="true" data-offset-key="15898:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15899"><span data-slate-leaf="true" data-offset-key="15899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="15900"><span data-slate-leaf="true" data-offset-key="15900:0" data-first-offset="true"><span data-slate-string="true"> *curr;</span></span></span><span data-slate-object="text" data-key="15901"><span data-slate-leaf="true" data-offset-key="15901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15902"><span data-slate-object="text" data-key="15903"><span data-slate-leaf="true" data-offset-key="15903:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15904"><span data-slate-leaf="true" data-offset-key="15904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15905"><span data-slate-leaf="true" data-offset-key="15905:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15906"><span data-slate-leaf="true" data-offset-key="15906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="15907"><span data-slate-leaf="true" data-offset-key="15907:0" data-first-offset="true"><span data-slate-string="true"> *next;</span></span></span><span data-slate-object="text" data-key="15908"><span data-slate-leaf="true" data-offset-key="15908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 下一个调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15909"><span data-slate-object="text" data-key="15910"><span data-slate-leaf="true" data-offset-key="15910:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15911"><span data-slate-leaf="true" data-offset-key="15911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15912"><span data-slate-leaf="true" data-offset-key="15912:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15913"><span data-slate-leaf="true" data-offset-key="15913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="15914"><span data-slate-leaf="true" data-offset-key="15914:0" data-first-offset="true"><span data-slate-string="true"> *last;</span></span></span><span data-slate-object="text" data-key="15915"><span data-slate-leaf="true" data-offset-key="15915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 上次执行过的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15916"><span data-slate-object="text" data-key="15917"><span data-slate-leaf="true" data-offset-key="15917:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15918"><span data-slate-leaf="true" data-offset-key="15918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 省略不关注的代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15919"><span data-slate-object="text" data-key="15920"><span data-slate-leaf="true" data-offset-key="15920:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15921"><span data-slate-object="text" data-key="15922"><span data-slate-leaf="true" data-offset-key="15922:0" data-first-offset="true"><span data-slate-string="true">为了简化问题，上述代码中我省略了调度组和负载相关的内容。你也许已经看出来了，其中 </span></span></span><span data-slate-object="text" data-key="15923"><span data-slate-leaf="true" data-offset-key="15923:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">load、exec_clock、min_vruntime、tasks_timeline 字段是 CFS 调度算法得以实现的关键</span></span></span></span><span data-slate-object="text" data-key="15924"><span data-slate-leaf="true" data-offset-key="15924:0" data-first-offset="true"><span data-slate-string="true">，你甚至可以猜出所有的调度实体，都是通过红黑树组织起来的，即 cfs_rq 结构中的 tasks_timeline 字段。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15925" id="sr-toc-9"><span data-slate-object="text" data-key="15926"><span data-slate-leaf="true" data-offset-key="15926:0" data-first-offset="true"><span data-slate-string="true">调度实体和运行队列的关系</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15927"><span data-slate-object="text" data-key="15928"><span data-slate-leaf="true" data-offset-key="15928:0" data-first-offset="true"><span data-slate-string="true">相信我，作为初学者，</span></span></span><span data-slate-object="text" data-key="15929"><span data-slate-leaf="true" data-offset-key="15929:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">了解数据结构之间的组织关系，这远比了解一个数据结构所有字段的作用和细节重要得多。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15930"><span data-slate-object="text" data-key="15931"><span data-slate-leaf="true" data-offset-key="15931:0" data-first-offset="true"><span data-slate-string="true">通过前面的学习，我们已经了解了 rq、cfs_rq、rb_root_cached、sched_entity、task_struct 等数据结构，下面我们来看看它的组织关系，我特意为你准备了后面这幅图。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15932"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/bb/d0/bb9f817b5db40106cb324b71b04ebed0.jpg?wh=6497x4010"></div><div>运行队列框架示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15933"><span data-slate-object="text" data-key="15934"><span data-slate-leaf="true" data-offset-key="15934:0" data-first-offset="true"><span data-slate-string="true">结合图片我们发现，task_struct 结构中包含了 sched_entity 结构。sched_entity 结构是通过红黑树组织起来的，红黑树的根在 cfs_rq 结构中，cfs_rq 结构又被包含在 rq 结构，每个 CPU 对应一个 rq 结构。这样，我们就把所有运行的进程组织起来了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15935" id="sr-toc-10"><span data-slate-object="text" data-key="15936"><span data-slate-leaf="true" data-offset-key="15936:0" data-first-offset="true"><span data-slate-string="true">调度器类</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15937"><span data-slate-object="text" data-key="15938"><span data-slate-leaf="true" data-offset-key="15938:0" data-first-offset="true"><span data-slate-string="true">从前面的 rq 数据结构中，你已经发现了，Linux 是同时支持多个进程调度器的，不同的进程挂载到不同的运行队列中，如 rq 结构中的 cfs、rt、dl，然后针对它们这些结构，使用不同的调度器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15939"><span data-slate-object="text" data-key="15940"><span data-slate-leaf="true" data-offset-key="15940:0" data-first-offset="true"><span data-slate-string="true">为了支持不同的调度器，Linux 定义了调度器类数据结构，它定义了一个调度器要实现哪些函数，代码如下所示。</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="15941"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15942"><span data-slate-object="text" data-key="15943"><span data-slate-leaf="true" data-offset-key="15943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15944"><span data-slate-leaf="true" data-offset-key="15944:0" data-first-offset="true"><span data-slate-string="true"> sched_class {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15945"><span data-slate-object="text" data-key="15946"><span data-slate-leaf="true" data-offset-key="15946:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15947"><span data-slate-leaf="true" data-offset-key="15947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向运行队列中添加一个进程，入队</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15948"><span data-slate-object="text" data-key="15949"><span data-slate-leaf="true" data-offset-key="15949:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15950"><span data-slate-leaf="true" data-offset-key="15950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="15951"><span data-slate-leaf="true" data-offset-key="15951:0" data-first-offset="true"><span data-slate-string="true"> (*enqueue_task) (</span></span></span><span data-slate-object="text" data-key="15952"><span data-slate-leaf="true" data-offset-key="15952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15953"><span data-slate-leaf="true" data-offset-key="15953:0" data-first-offset="true"><span data-slate-string="true"> rq *rq, </span></span></span><span data-slate-object="text" data-key="15954"><span data-slate-leaf="true" data-offset-key="15954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15955"><span data-slate-leaf="true" data-offset-key="15955:0" data-first-offset="true"><span data-slate-string="true"> task_struct *p, </span></span></span><span data-slate-object="text" data-key="15956"><span data-slate-leaf="true" data-offset-key="15956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15957"><span data-slate-leaf="true" data-offset-key="15957:0" data-first-offset="true"><span data-slate-string="true"> flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15958"><span data-slate-object="text" data-key="15959"><span data-slate-leaf="true" data-offset-key="15959:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15960"><span data-slate-leaf="true" data-offset-key="15960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向运行队列中删除一个进程，出队</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15961"><span data-slate-object="text" data-key="15962"><span data-slate-leaf="true" data-offset-key="15962:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15963"><span data-slate-leaf="true" data-offset-key="15963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="15964"><span data-slate-leaf="true" data-offset-key="15964:0" data-first-offset="true"><span data-slate-string="true"> (*dequeue_task) (</span></span></span><span data-slate-object="text" data-key="15965"><span data-slate-leaf="true" data-offset-key="15965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15966"><span data-slate-leaf="true" data-offset-key="15966:0" data-first-offset="true"><span data-slate-string="true"> rq *rq, </span></span></span><span data-slate-object="text" data-key="15967"><span data-slate-leaf="true" data-offset-key="15967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15968"><span data-slate-leaf="true" data-offset-key="15968:0" data-first-offset="true"><span data-slate-string="true"> task_struct *p, </span></span></span><span data-slate-object="text" data-key="15969"><span data-slate-leaf="true" data-offset-key="15969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15970"><span data-slate-leaf="true" data-offset-key="15970:0" data-first-offset="true"><span data-slate-string="true"> flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15971"><span data-slate-object="text" data-key="15972"><span data-slate-leaf="true" data-offset-key="15972:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15973"><span data-slate-leaf="true" data-offset-key="15973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查当前进程是否可抢占</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15974"><span data-slate-object="text" data-key="15975"><span data-slate-leaf="true" data-offset-key="15975:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15976"><span data-slate-leaf="true" data-offset-key="15976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="15977"><span data-slate-leaf="true" data-offset-key="15977:0" data-first-offset="true"><span data-slate-string="true"> (*check_preempt_curr)(</span></span></span><span data-slate-object="text" data-key="15978"><span data-slate-leaf="true" data-offset-key="15978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15979"><span data-slate-leaf="true" data-offset-key="15979:0" data-first-offset="true"><span data-slate-string="true"> rq *rq, </span></span></span><span data-slate-object="text" data-key="15980"><span data-slate-leaf="true" data-offset-key="15980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15981"><span data-slate-leaf="true" data-offset-key="15981:0" data-first-offset="true"><span data-slate-string="true"> task_struct *p, </span></span></span><span data-slate-object="text" data-key="15982"><span data-slate-leaf="true" data-offset-key="15982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15983"><span data-slate-leaf="true" data-offset-key="15983:0" data-first-offset="true"><span data-slate-string="true"> flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15984"><span data-slate-object="text" data-key="15985"><span data-slate-leaf="true" data-offset-key="15985:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15986"><span data-slate-leaf="true" data-offset-key="15986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从运行队列中返回可以投入运行的一个进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15987"><span data-slate-object="text" data-key="15988"><span data-slate-leaf="true" data-offset-key="15988:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15989"><span data-slate-leaf="true" data-offset-key="15989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15990"><span data-slate-leaf="true" data-offset-key="15990:0" data-first-offset="true"><span data-slate-string="true"> task_struct *(*pick_next_task)(</span></span></span><span data-slate-object="text" data-key="15991"><span data-slate-leaf="true" data-offset-key="15991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15992"><span data-slate-leaf="true" data-offset-key="15992:0" data-first-offset="true"><span data-slate-string="true"> rq *rq);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15993"><span data-slate-object="text" data-key="15994"><span data-slate-leaf="true" data-offset-key="15994:0" data-first-offset="true"><span data-slate-string="true">} ;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15995"><span data-slate-object="text" data-key="15996"><span data-slate-leaf="true" data-offset-key="15996:0" data-first-offset="true"><span data-slate-string="true">这个 sched_class 结构定义了一组函数指针，为了让你抓住重点，这里我删除了调度组和负载均衡相关的函数指针。Linux 系统一共定义了五个 sched_class 结构的实例变量，这五个 sched_class 结构紧靠在一起，形成了 sched_class 结构数组。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15997"><span data-slate-object="text" data-key="15998"><span data-slate-leaf="true" data-offset-key="15998:0" data-first-offset="true"><span data-slate-string="true">为了找到相应的 sched_class 结构实例，可以用以下代码遍历所有的 sched_class 结构实例变量。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15999"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16000"><span data-slate-object="text" data-key="16001"><span data-slate-leaf="true" data-offset-key="16001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义在链接脚本文件中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16002"><span data-slate-object="text" data-key="16003"><span data-slate-leaf="true" data-offset-key="16003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16004"><span data-slate-leaf="true" data-offset-key="16004:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16005"><span data-slate-leaf="true" data-offset-key="16005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16006"><span data-slate-leaf="true" data-offset-key="16006:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16007"><span data-slate-leaf="true" data-offset-key="16007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16008"><span data-slate-leaf="true" data-offset-key="16008:0" data-first-offset="true"><span data-slate-string="true"> __begin_sched_classes[];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16009"><span data-slate-object="text" data-key="16010"><span data-slate-leaf="true" data-offset-key="16010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16011"><span data-slate-leaf="true" data-offset-key="16011:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16012"><span data-slate-leaf="true" data-offset-key="16012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16013"><span data-slate-leaf="true" data-offset-key="16013:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16014"><span data-slate-leaf="true" data-offset-key="16014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16015"><span data-slate-leaf="true" data-offset-key="16015:0" data-first-offset="true"><span data-slate-string="true"> __end_sched_classes[];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16016"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16017"><span data-slate-object="text" data-key="16018"><span data-slate-leaf="true" data-offset-key="16018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="16019"><span data-slate-leaf="true" data-offset-key="16019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="16020"><span data-slate-leaf="true" data-offset-key="16020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sched_class_highest (__end_sched_classes - 1)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16021"><span data-slate-object="text" data-key="16022"><span data-slate-leaf="true" data-offset-key="16022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="16023"><span data-slate-leaf="true" data-offset-key="16023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="16024"><span data-slate-leaf="true" data-offset-key="16024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sched_class_lowest  (__begin_sched_classes - 1)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16025"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16026"><span data-slate-object="text" data-key="16027"><span data-slate-leaf="true" data-offset-key="16027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="16028"><span data-slate-leaf="true" data-offset-key="16028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="16029"><span data-slate-leaf="true" data-offset-key="16029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for_class_range(class, _from, _to) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16030"><span data-slate-object="text" data-key="16031"><span data-slate-leaf="true" data-offset-key="16031:0" data-first-offset="true"><span data-slate-string="true">    for (class = (_from); class != (_to); class--)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16032"><span data-slate-object="text" data-key="16033"><span data-slate-leaf="true" data-offset-key="16033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历每个调度类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16034"><span data-slate-object="text" data-key="16035"><span data-slate-leaf="true" data-offset-key="16035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="16036"><span data-slate-leaf="true" data-offset-key="16036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="16037"><span data-slate-leaf="true" data-offset-key="16037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for_each_class(class) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16038"><span data-slate-object="text" data-key="16039"><span data-slate-leaf="true" data-offset-key="16039:0" data-first-offset="true"><span data-slate-string="true">    for_class_range(class, sched_class_highest, sched_class_lowest)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16040"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16041"><span data-slate-object="text" data-key="16042"><span data-slate-leaf="true" data-offset-key="16042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16043"><span data-slate-leaf="true" data-offset-key="16043:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16044"><span data-slate-leaf="true" data-offset-key="16044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16045"><span data-slate-leaf="true" data-offset-key="16045:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16046"><span data-slate-leaf="true" data-offset-key="16046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16047"><span data-slate-leaf="true" data-offset-key="16047:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16048"><span data-slate-leaf="true" data-offset-key="16048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16049"><span data-slate-leaf="true" data-offset-key="16049:0" data-first-offset="true"><span data-slate-string="true"> stop_sched_class;</span></span></span><span data-slate-object="text" data-key="16050"><span data-slate-leaf="true" data-offset-key="16050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 停止调度类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16051"><span data-slate-object="text" data-key="16052"><span data-slate-leaf="true" data-offset-key="16052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16053"><span data-slate-leaf="true" data-offset-key="16053:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16054"><span data-slate-leaf="true" data-offset-key="16054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16055"><span data-slate-leaf="true" data-offset-key="16055:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16056"><span data-slate-leaf="true" data-offset-key="16056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16057"><span data-slate-leaf="true" data-offset-key="16057:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16058"><span data-slate-leaf="true" data-offset-key="16058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16059"><span data-slate-leaf="true" data-offset-key="16059:0" data-first-offset="true"><span data-slate-string="true"> dl_sched_class;</span></span></span><span data-slate-object="text" data-key="16060"><span data-slate-leaf="true" data-offset-key="16060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Deadline 调度类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16061"><span data-slate-object="text" data-key="16062"><span data-slate-leaf="true" data-offset-key="16062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16063"><span data-slate-leaf="true" data-offset-key="16063:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16064"><span data-slate-leaf="true" data-offset-key="16064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16065"><span data-slate-leaf="true" data-offset-key="16065:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16066"><span data-slate-leaf="true" data-offset-key="16066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16067"><span data-slate-leaf="true" data-offset-key="16067:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16068"><span data-slate-leaf="true" data-offset-key="16068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16069"><span data-slate-leaf="true" data-offset-key="16069:0" data-first-offset="true"><span data-slate-string="true"> rt_sched_class;</span></span></span><span data-slate-object="text" data-key="16070"><span data-slate-leaf="true" data-offset-key="16070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实时调度类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16071"><span data-slate-object="text" data-key="16072"><span data-slate-leaf="true" data-offset-key="16072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16073"><span data-slate-leaf="true" data-offset-key="16073:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16074"><span data-slate-leaf="true" data-offset-key="16074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16075"><span data-slate-leaf="true" data-offset-key="16075:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16076"><span data-slate-leaf="true" data-offset-key="16076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16077"><span data-slate-leaf="true" data-offset-key="16077:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16078"><span data-slate-leaf="true" data-offset-key="16078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16079"><span data-slate-leaf="true" data-offset-key="16079:0" data-first-offset="true"><span data-slate-string="true"> fair_sched_class;</span></span></span><span data-slate-object="text" data-key="16080"><span data-slate-leaf="true" data-offset-key="16080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//CFS 调度类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16081"><span data-slate-object="text" data-key="16082"><span data-slate-leaf="true" data-offset-key="16082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span><span data-slate-object="text" data-key="16083"><span data-slate-leaf="true" data-offset-key="16083:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16084"><span data-slate-leaf="true" data-offset-key="16084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16085"><span data-slate-leaf="true" data-offset-key="16085:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16086"><span data-slate-leaf="true" data-offset-key="16086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16087"><span data-slate-leaf="true" data-offset-key="16087:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16088"><span data-slate-leaf="true" data-offset-key="16088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16089"><span data-slate-leaf="true" data-offset-key="16089:0" data-first-offset="true"><span data-slate-string="true"> idle_sched_class;</span></span></span><span data-slate-object="text" data-key="16090"><span data-slate-leaf="true" data-offset-key="16090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 空转调度类</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16091"><span data-slate-object="text" data-key="16092"><span data-slate-leaf="true" data-offset-key="16092:0" data-first-offset="true"><span data-slate-string="true">这些类是有优先级的，它们的优先级是：stop_sched_class &gt; dl_sched_class &gt; rt_sched_class &gt; fair_sched_class &gt; idle_sched_class。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16093"><span data-slate-object="text" data-key="16094"><span data-slate-leaf="true" data-offset-key="16094:0" data-first-offset="true"><span data-slate-string="true">下面我们观察一下，CFS 调度器（这个调度器我们稍后讨论）所需要的 fair_sched_class，代码如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="16095"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16096"><span data-slate-object="text" data-key="16097"><span data-slate-leaf="true" data-offset-key="16097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16098"><span data-slate-leaf="true" data-offset-key="16098:0" data-first-offset="true"><span data-slate-string="true"> struct sched_</span></span></span><span data-slate-object="text" data-key="16099"><span data-slate-leaf="true" data-offset-key="16099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="16100"><span data-slate-leaf="true" data-offset-key="16100:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16101"><span data-slate-leaf="true" data-offset-key="16101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fair_sched_class</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16102"><span data-slate-object="text" data-key="16103"><span data-slate-leaf="true" data-offset-key="16103:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16104"><span data-slate-leaf="true" data-offset-key="16104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">__section</span></span></span></span><span data-slate-object="text" data-key="16105"><span data-slate-leaf="true" data-offset-key="16105:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16106"><span data-slate-leaf="true" data-offset-key="16106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"__fair_sched_class"</span></span></span></span><span data-slate-object="text" data-key="16107"><span data-slate-leaf="true" data-offset-key="16107:0" data-first-offset="true"><span data-slate-string="true">) = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16108"><span data-slate-object="text" data-key="16109"><span data-slate-leaf="true" data-offset-key="16109:0" data-first-offset="true"><span data-slate-string="true">    .</span></span></span><span data-slate-object="text" data-key="16110"><span data-slate-leaf="true" data-offset-key="16110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">enqueue_task</span></span></span></span><span data-slate-object="text" data-key="16111"><span data-slate-leaf="true" data-offset-key="16111:0" data-first-offset="true"><span data-slate-string="true">       = enqueue_task_fair,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16112"><span data-slate-object="text" data-key="16113"><span data-slate-leaf="true" data-offset-key="16113:0" data-first-offset="true"><span data-slate-string="true">    .</span></span></span><span data-slate-object="text" data-key="16114"><span data-slate-leaf="true" data-offset-key="16114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dequeue_task</span></span></span></span><span data-slate-object="text" data-key="16115"><span data-slate-leaf="true" data-offset-key="16115:0" data-first-offset="true"><span data-slate-string="true">       = dequeue_task_fair,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16116"><span data-slate-object="text" data-key="16117"><span data-slate-leaf="true" data-offset-key="16117:0" data-first-offset="true"><span data-slate-string="true">    .</span></span></span><span data-slate-object="text" data-key="16118"><span data-slate-leaf="true" data-offset-key="16118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">check_preempt_curr</span></span></span></span><span data-slate-object="text" data-key="16119"><span data-slate-leaf="true" data-offset-key="16119:0" data-first-offset="true"><span data-slate-string="true"> = check_preempt_wakeup,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16120"><span data-slate-object="text" data-key="16121"><span data-slate-leaf="true" data-offset-key="16121:0" data-first-offset="true"><span data-slate-string="true">    .</span></span></span><span data-slate-object="text" data-key="16122"><span data-slate-leaf="true" data-offset-key="16122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task</span></span></span></span><span data-slate-object="text" data-key="16123"><span data-slate-leaf="true" data-offset-key="16123:0" data-first-offset="true"><span data-slate-string="true">     = __pick_next_task_fair,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16124"><span data-slate-object="text" data-key="16125"><span data-slate-leaf="true" data-offset-key="16125:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16126"><span data-slate-object="text" data-key="16127"><span data-slate-leaf="true" data-offset-key="16127:0" data-first-offset="true"><span data-slate-string="true">我们看到这些函数指针字段都对应到了具体的函数。其实，实现一个新的调度器，就是实现这些对应的函数。好了，我们清楚了调度器类，它就是一组函数指针，不知道你发现没有，这难道不是 C 语言下的面向对象吗？下面，我们接着研究 CFS 调度器。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16128" id="sr-toc-11"><span data-slate-object="text" data-key="16129"><span data-slate-leaf="true" data-offset-key="16129:0" data-first-offset="true"><span data-slate-string="true">Linux 的 CFS 调度器</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16130"><span data-slate-object="text" data-key="16131"><span data-slate-leaf="true" data-offset-key="16131:0" data-first-offset="true"><span data-slate-string="true">Linux 支持多种不同的进程调度器，比如 RT 调度器、Deadline 调度器、CFS 调度器以及 Idle 调度器。不过，这里我们仅仅讨论一下 CFS 调度器，也就是完全公平调度器，CFS 的设计理念是在有限的真实硬件平台上模拟实现理想的、精确的多任务 CPU。现在你不懂也不要紧，我们后面会讨论的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16132"><span data-slate-object="text" data-key="16133"><span data-slate-leaf="true" data-offset-key="16133:0" data-first-offset="true"><span data-slate-string="true">在了解 CFS 核心算法之前，你需要先掌握几个核心概念。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16134" id="sr-toc-12"><span data-slate-object="text" data-key="16135"><span data-slate-leaf="true" data-offset-key="16135:0" data-first-offset="true"><span data-slate-string="true">普通进程的权重</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16136"><span data-slate-object="text" data-key="16137"><span data-slate-leaf="true" data-offset-key="16137:0" data-first-offset="true"><span data-slate-string="true">Linux 会使用 CFS 调度器调度普通进程，CFS 调度器与其它进程调度器的不同之处在于没有时间片的概念，它是分配 CPU 使用时间的比例。比如，4 个相同优先级的进程在一个 CPU 上运行，那么每个进程都将会分配 25% 的 CPU 运行时间。这就是进程要的公平。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16138"><span data-slate-object="text" data-key="16139"><span data-slate-leaf="true" data-offset-key="16139:0" data-first-offset="true"><span data-slate-string="true">然而事有轻重缓急，对进程来说也是一样，有些进程的优先级就需要很高。那么 CFS 调度器是如何在公平之下，实现 “不公平” 的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16140"><span data-slate-object="text" data-key="16141"><span data-slate-leaf="true" data-offset-key="16141:0" data-first-offset="true"><span data-slate-string="true">首先，CFS 调度器下不叫优先级，而是叫</span></span></span><span data-slate-object="text" data-key="16142"><span data-slate-leaf="true" data-offset-key="16142:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">权重</span></span></span></span><span data-slate-object="text" data-key="16143"><span data-slate-leaf="true" data-offset-key="16143:0" data-first-offset="true"><span data-slate-string="true">，权重表示进程的优先级，各个进程按权重的比例分配 CPU 时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16144"><span data-slate-object="text" data-key="16145"><span data-slate-leaf="true" data-offset-key="16145:0" data-first-offset="true"><span data-slate-string="true">举个例子，现在有 A、B 两个进程。进程 A 的权重是 1024，进程 B 的权重是 2048。那么进程 A 获得 CPU 的时间比例是 1024/(1024+2048) = 33.3%。进程 B 获得的 CPU 时间比例是 2048/(1024+2048)=66.7%。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16146"><span data-slate-object="text" data-key="16147"><span data-slate-leaf="true" data-offset-key="16147:0" data-first-offset="true"><span data-slate-string="true">因此，权重越大，分配的时间比例越大，就相当于进程的优先级越高。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16148"><span data-slate-object="text" data-key="16149"><span data-slate-leaf="true" data-offset-key="16149:0" data-first-offset="true"><span data-slate-string="true">有了权重之后，分配给进程的时间计算公式如下：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16150"><span data-slate-object="text" data-key="16151"><span data-slate-leaf="true" data-offset-key="16151:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">进程的时间 = CPU 总时间 * 进程的权重 / 就绪队列所有进程权重之和</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16152"><span data-slate-object="text" data-key="16153"><span data-slate-leaf="true" data-offset-key="16153:0" data-first-offset="true"><span data-slate-string="true">但是进程对外的编程接口中使用的是一个 </span></span></span><span data-slate-object="text" data-key="16154"><span data-slate-leaf="true" data-offset-key="16154:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">nice 值</span></span></span></span><span data-slate-object="text" data-key="16155"><span data-slate-leaf="true" data-offset-key="16155:0" data-first-offset="true"><span data-slate-string="true">，大小范围是（-20～19），数值越小优先级越大，意味着权重值越大，nice 值和权重之间可以转换的。Linux 提供了后面这个数组，用于转换 nice 值和权重。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16156"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16157"><span data-slate-object="text" data-key="16158"><span data-slate-leaf="true" data-offset-key="16158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16159"><span data-slate-leaf="true" data-offset-key="16159:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16160"><span data-slate-leaf="true" data-offset-key="16160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16161"><span data-slate-leaf="true" data-offset-key="16161:0" data-first-offset="true"><span data-slate-string="true"> sched_prio_to_weight[</span></span></span><span data-slate-object="text" data-key="16162"><span data-slate-leaf="true" data-offset-key="16162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">40</span></span></span></span><span data-slate-object="text" data-key="16163"><span data-slate-leaf="true" data-offset-key="16163:0" data-first-offset="true"><span data-slate-string="true">] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16164"><span data-slate-object="text" data-key="16165"><span data-slate-leaf="true" data-offset-key="16165:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16166"><span data-slate-leaf="true" data-offset-key="16166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* -20 */</span></span></span></span><span data-slate-object="text" data-key="16167"><span data-slate-leaf="true" data-offset-key="16167:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="16168"><span data-slate-leaf="true" data-offset-key="16168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">88761</span></span></span></span><span data-slate-object="text" data-key="16169"><span data-slate-leaf="true" data-offset-key="16169:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16170"><span data-slate-leaf="true" data-offset-key="16170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">71755</span></span></span></span><span data-slate-object="text" data-key="16171"><span data-slate-leaf="true" data-offset-key="16171:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16172"><span data-slate-leaf="true" data-offset-key="16172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">56483</span></span></span></span><span data-slate-object="text" data-key="16173"><span data-slate-leaf="true" data-offset-key="16173:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16174"><span data-slate-leaf="true" data-offset-key="16174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">46273</span></span></span></span><span data-slate-object="text" data-key="16175"><span data-slate-leaf="true" data-offset-key="16175:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16176"><span data-slate-leaf="true" data-offset-key="16176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">36291</span></span></span></span><span data-slate-object="text" data-key="16177"><span data-slate-leaf="true" data-offset-key="16177:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16178"><span data-slate-object="text" data-key="16179"><span data-slate-leaf="true" data-offset-key="16179:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16180"><span data-slate-leaf="true" data-offset-key="16180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* -15 */</span></span></span></span><span data-slate-object="text" data-key="16181"><span data-slate-leaf="true" data-offset-key="16181:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="16182"><span data-slate-leaf="true" data-offset-key="16182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29154</span></span></span></span><span data-slate-object="text" data-key="16183"><span data-slate-leaf="true" data-offset-key="16183:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16184"><span data-slate-leaf="true" data-offset-key="16184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">23254</span></span></span></span><span data-slate-object="text" data-key="16185"><span data-slate-leaf="true" data-offset-key="16185:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16186"><span data-slate-leaf="true" data-offset-key="16186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">18705</span></span></span></span><span data-slate-object="text" data-key="16187"><span data-slate-leaf="true" data-offset-key="16187:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16188"><span data-slate-leaf="true" data-offset-key="16188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">14949</span></span></span></span><span data-slate-object="text" data-key="16189"><span data-slate-leaf="true" data-offset-key="16189:0" data-first-offset="true"><span data-slate-string="true">,     </span></span></span><span data-slate-object="text" data-key="16190"><span data-slate-leaf="true" data-offset-key="16190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11916</span></span></span></span><span data-slate-object="text" data-key="16191"><span data-slate-leaf="true" data-offset-key="16191:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16192"><span data-slate-object="text" data-key="16193"><span data-slate-leaf="true" data-offset-key="16193:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16194"><span data-slate-leaf="true" data-offset-key="16194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* -10 */</span></span></span></span><span data-slate-object="text" data-key="16195"><span data-slate-leaf="true" data-offset-key="16195:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16196"><span data-slate-leaf="true" data-offset-key="16196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">9548</span></span></span></span><span data-slate-object="text" data-key="16197"><span data-slate-leaf="true" data-offset-key="16197:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16198"><span data-slate-leaf="true" data-offset-key="16198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7620</span></span></span></span><span data-slate-object="text" data-key="16199"><span data-slate-leaf="true" data-offset-key="16199:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16200"><span data-slate-leaf="true" data-offset-key="16200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6100</span></span></span></span><span data-slate-object="text" data-key="16201"><span data-slate-leaf="true" data-offset-key="16201:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16202"><span data-slate-leaf="true" data-offset-key="16202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4904</span></span></span></span><span data-slate-object="text" data-key="16203"><span data-slate-leaf="true" data-offset-key="16203:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16204"><span data-slate-leaf="true" data-offset-key="16204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3906</span></span></span></span><span data-slate-object="text" data-key="16205"><span data-slate-leaf="true" data-offset-key="16205:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16206"><span data-slate-object="text" data-key="16207"><span data-slate-leaf="true" data-offset-key="16207:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16208"><span data-slate-leaf="true" data-offset-key="16208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*  -5 */</span></span></span></span><span data-slate-object="text" data-key="16209"><span data-slate-leaf="true" data-offset-key="16209:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16210"><span data-slate-leaf="true" data-offset-key="16210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3121</span></span></span></span><span data-slate-object="text" data-key="16211"><span data-slate-leaf="true" data-offset-key="16211:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16212"><span data-slate-leaf="true" data-offset-key="16212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2501</span></span></span></span><span data-slate-object="text" data-key="16213"><span data-slate-leaf="true" data-offset-key="16213:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16214"><span data-slate-leaf="true" data-offset-key="16214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1991</span></span></span></span><span data-slate-object="text" data-key="16215"><span data-slate-leaf="true" data-offset-key="16215:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16216"><span data-slate-leaf="true" data-offset-key="16216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1586</span></span></span></span><span data-slate-object="text" data-key="16217"><span data-slate-leaf="true" data-offset-key="16217:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="16218"><span data-slate-leaf="true" data-offset-key="16218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1277</span></span></span></span><span data-slate-object="text" data-key="16219"><span data-slate-leaf="true" data-offset-key="16219:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16220"><span data-slate-object="text" data-key="16221"><span data-slate-leaf="true" data-offset-key="16221:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16222"><span data-slate-leaf="true" data-offset-key="16222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*   0 */</span></span></span></span><span data-slate-object="text" data-key="16223"><span data-slate-leaf="true" data-offset-key="16223:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16224"><span data-slate-leaf="true" data-offset-key="16224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1024</span></span></span></span><span data-slate-object="text" data-key="16225"><span data-slate-leaf="true" data-offset-key="16225:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16226"><span data-slate-leaf="true" data-offset-key="16226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">820</span></span></span></span><span data-slate-object="text" data-key="16227"><span data-slate-leaf="true" data-offset-key="16227:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16228"><span data-slate-leaf="true" data-offset-key="16228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">655</span></span></span></span><span data-slate-object="text" data-key="16229"><span data-slate-leaf="true" data-offset-key="16229:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16230"><span data-slate-leaf="true" data-offset-key="16230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">526</span></span></span></span><span data-slate-object="text" data-key="16231"><span data-slate-leaf="true" data-offset-key="16231:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16232"><span data-slate-leaf="true" data-offset-key="16232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">423</span></span></span></span><span data-slate-object="text" data-key="16233"><span data-slate-leaf="true" data-offset-key="16233:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16234"><span data-slate-object="text" data-key="16235"><span data-slate-leaf="true" data-offset-key="16235:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16236"><span data-slate-leaf="true" data-offset-key="16236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*   5 */</span></span></span></span><span data-slate-object="text" data-key="16237"><span data-slate-leaf="true" data-offset-key="16237:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="16238"><span data-slate-leaf="true" data-offset-key="16238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">335</span></span></span></span><span data-slate-object="text" data-key="16239"><span data-slate-leaf="true" data-offset-key="16239:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16240"><span data-slate-leaf="true" data-offset-key="16240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">272</span></span></span></span><span data-slate-object="text" data-key="16241"><span data-slate-leaf="true" data-offset-key="16241:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16242"><span data-slate-leaf="true" data-offset-key="16242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">215</span></span></span></span><span data-slate-object="text" data-key="16243"><span data-slate-leaf="true" data-offset-key="16243:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16244"><span data-slate-leaf="true" data-offset-key="16244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">172</span></span></span></span><span data-slate-object="text" data-key="16245"><span data-slate-leaf="true" data-offset-key="16245:0" data-first-offset="true"><span data-slate-string="true">,       </span></span></span><span data-slate-object="text" data-key="16246"><span data-slate-leaf="true" data-offset-key="16246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">137</span></span></span></span><span data-slate-object="text" data-key="16247"><span data-slate-leaf="true" data-offset-key="16247:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16248"><span data-slate-object="text" data-key="16249"><span data-slate-leaf="true" data-offset-key="16249:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16250"><span data-slate-leaf="true" data-offset-key="16250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*  10 */</span></span></span></span><span data-slate-object="text" data-key="16251"><span data-slate-leaf="true" data-offset-key="16251:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="16252"><span data-slate-leaf="true" data-offset-key="16252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">110</span></span></span></span><span data-slate-object="text" data-key="16253"><span data-slate-leaf="true" data-offset-key="16253:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16254"><span data-slate-leaf="true" data-offset-key="16254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">87</span></span></span></span><span data-slate-object="text" data-key="16255"><span data-slate-leaf="true" data-offset-key="16255:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16256"><span data-slate-leaf="true" data-offset-key="16256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">70</span></span></span></span><span data-slate-object="text" data-key="16257"><span data-slate-leaf="true" data-offset-key="16257:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16258"><span data-slate-leaf="true" data-offset-key="16258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">56</span></span></span></span><span data-slate-object="text" data-key="16259"><span data-slate-leaf="true" data-offset-key="16259:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16260"><span data-slate-leaf="true" data-offset-key="16260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">45</span></span></span></span><span data-slate-object="text" data-key="16261"><span data-slate-leaf="true" data-offset-key="16261:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16262"><span data-slate-object="text" data-key="16263"><span data-slate-leaf="true" data-offset-key="16263:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16264"><span data-slate-leaf="true" data-offset-key="16264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*  15 */</span></span></span></span><span data-slate-object="text" data-key="16265"><span data-slate-leaf="true" data-offset-key="16265:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16266"><span data-slate-leaf="true" data-offset-key="16266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">36</span></span></span></span><span data-slate-object="text" data-key="16267"><span data-slate-leaf="true" data-offset-key="16267:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16268"><span data-slate-leaf="true" data-offset-key="16268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29</span></span></span></span><span data-slate-object="text" data-key="16269"><span data-slate-leaf="true" data-offset-key="16269:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16270"><span data-slate-leaf="true" data-offset-key="16270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">23</span></span></span></span><span data-slate-object="text" data-key="16271"><span data-slate-leaf="true" data-offset-key="16271:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16272"><span data-slate-leaf="true" data-offset-key="16272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">18</span></span></span></span><span data-slate-object="text" data-key="16273"><span data-slate-leaf="true" data-offset-key="16273:0" data-first-offset="true"><span data-slate-string="true">,        </span></span></span><span data-slate-object="text" data-key="16274"><span data-slate-leaf="true" data-offset-key="16274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">15</span></span></span></span><span data-slate-object="text" data-key="16275"><span data-slate-leaf="true" data-offset-key="16275:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16276"><span data-slate-object="text" data-key="16277"><span data-slate-leaf="true" data-offset-key="16277:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16278"><span data-slate-object="text" data-key="16279"><span data-slate-leaf="true" data-offset-key="16279:0" data-first-offset="true"><span data-slate-string="true">一个进程每降低一个 nice 值，就能多获得 10% 的 CPU 时间。1024 权重对应 nice 值为 0，被称为 NICE_0_LOAD。默认情况下，大多数进程的权重都是 NICE_0_LOAD。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16280" id="sr-toc-13"><span data-slate-object="text" data-key="16281"><span data-slate-leaf="true" data-offset-key="16281:0" data-first-offset="true"><span data-slate-string="true">进程调度延迟</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16282"><span data-slate-object="text" data-key="16283"><span data-slate-leaf="true" data-offset-key="16283:0" data-first-offset="true"><span data-slate-string="true">了解了进程权重，现在我们看看进程调度延迟，什么是调度延迟？其实就是保证每一个可运行的进程，都至少运行一次的</span></span></span><span data-slate-object="text" data-key="16284"><span data-slate-leaf="true" data-offset-key="16284:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">时间间隔</span></span></span></span><span data-slate-object="text" data-key="16285"><span data-slate-leaf="true" data-offset-key="16285:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16286"><span data-slate-object="text" data-key="16287"><span data-slate-leaf="true" data-offset-key="16287:0" data-first-offset="true"><span data-slate-string="true">我们结合实例理解，系统中有 3 个可运行进程，每个进程都运行 10ms，那么调度延迟就是 30ms；如果有 10 个进程，那么调度延迟就是 100ms；如果现在保证调度延迟不变，固定是 30ms；如果系统中有 3 个进程，则每个进程可运行 10ms；如果有 10 个进程，则每个进程可运行 3ms。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16288"><span data-slate-object="text" data-key="16289"><span data-slate-leaf="true" data-offset-key="16289:0" data-first-offset="true"><span data-slate-string="true">随着进程的增加，每个进程分配的时间在减少，进程调度次数会增加，调度器占用的时间就会增加。因此，CFS 调度器的调度延迟时间的设定</span></span></span><span data-slate-object="text" data-key="16290"><span data-slate-leaf="true" data-offset-key="16290:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">并不是固定的</span></span></span></span><span data-slate-object="text" data-key="16291"><span data-slate-leaf="true" data-offset-key="16291:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16292"><span data-slate-object="text" data-key="16293"><span data-slate-leaf="true" data-offset-key="16293:0" data-first-offset="true"><span data-slate-string="true">当运行进程少于 8 个的时候，调度延迟是固定的 6ms 不变。当运行进程个数超过 8 个时，就要保证每个进程至少运行一段时间，才被调度。这个 “至少一段时间” 叫作</span></span></span><span data-slate-object="text" data-key="16294"><span data-slate-leaf="true" data-offset-key="16294:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最小调度粒度时间</span></span></span></span><span data-slate-object="text" data-key="16295"><span data-slate-leaf="true" data-offset-key="16295:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16296"><span data-slate-object="text" data-key="16297"><span data-slate-leaf="true" data-offset-key="16297:0" data-first-offset="true"><span data-slate-string="true">在 CFS 默认设置中，最小调度粒度时间是 0.75ms，用变量 sysctl_sched_min_granularity 记录。由 __sched_period 函数负责计算，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16298"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16299"><span data-slate-object="text" data-key="16300"><span data-slate-leaf="true" data-offset-key="16300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16301"><span data-slate-leaf="true" data-offset-key="16301:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16302"><span data-slate-leaf="true" data-offset-key="16302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16303"><span data-slate-leaf="true" data-offset-key="16303:0" data-first-offset="true"><span data-slate-string="true"> sysctl_sched_min_granularity           = </span></span></span><span data-slate-object="text" data-key="16304"><span data-slate-leaf="true" data-offset-key="16304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">750000ULL</span></span></span></span><span data-slate-object="text" data-key="16305"><span data-slate-leaf="true" data-offset-key="16305:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16306"><span data-slate-object="text" data-key="16307"><span data-slate-leaf="true" data-offset-key="16307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16308"><span data-slate-leaf="true" data-offset-key="16308:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16309"><span data-slate-leaf="true" data-offset-key="16309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16310"><span data-slate-leaf="true" data-offset-key="16310:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16311"><span data-slate-leaf="true" data-offset-key="16311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16312"><span data-slate-leaf="true" data-offset-key="16312:0" data-first-offset="true"><span data-slate-string="true"> normalized_sysctl_sched_min_granularity = </span></span></span><span data-slate-object="text" data-key="16313"><span data-slate-leaf="true" data-offset-key="16313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">750000ULL</span></span></span></span><span data-slate-object="text" data-key="16314"><span data-slate-leaf="true" data-offset-key="16314:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16315"><span data-slate-object="text" data-key="16316"><span data-slate-leaf="true" data-offset-key="16316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16317"><span data-slate-leaf="true" data-offset-key="16317:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16318"><span data-slate-leaf="true" data-offset-key="16318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16319"><span data-slate-leaf="true" data-offset-key="16319:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16320"><span data-slate-leaf="true" data-offset-key="16320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16321"><span data-slate-leaf="true" data-offset-key="16321:0" data-first-offset="true"><span data-slate-string="true"> sched_nr_latency = </span></span></span><span data-slate-object="text" data-key="16322"><span data-slate-leaf="true" data-offset-key="16322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span><span data-slate-object="text" data-key="16323"><span data-slate-leaf="true" data-offset-key="16323:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16324"><span data-slate-object="text" data-key="16325"><span data-slate-leaf="true" data-offset-key="16325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16326"><span data-slate-leaf="true" data-offset-key="16326:0" data-first-offset="true"><span data-slate-string="true"> u64 __sched_period(</span></span></span><span data-slate-object="text" data-key="16327"><span data-slate-leaf="true" data-offset-key="16327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16328"><span data-slate-leaf="true" data-offset-key="16328:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16329"><span data-slate-leaf="true" data-offset-key="16329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="16330"><span data-slate-leaf="true" data-offset-key="16330:0" data-first-offset="true"><span data-slate-string="true"> nr_running)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16331"><span data-slate-object="text" data-key="16332"><span data-slate-leaf="true" data-offset-key="16332:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16333"><span data-slate-object="text" data-key="16334"><span data-slate-leaf="true" data-offset-key="16334:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16335"><span data-slate-leaf="true" data-offset-key="16335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16336"><span data-slate-leaf="true" data-offset-key="16336:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="16337"><span data-slate-leaf="true" data-offset-key="16337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlikely</span></span></span></span><span data-slate-object="text" data-key="16338"><span data-slate-leaf="true" data-offset-key="16338:0" data-first-offset="true"><span data-slate-string="true">(nr_running&gt; sched_nr_latency))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16339"><span data-slate-object="text" data-key="16340"><span data-slate-leaf="true" data-offset-key="16340:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16341"><span data-slate-leaf="true" data-offset-key="16341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16342"><span data-slate-leaf="true" data-offset-key="16342:0" data-first-offset="true"><span data-slate-string="true"> nr_running * sysctl_sched_min_granularity;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16343"><span data-slate-object="text" data-key="16344"><span data-slate-leaf="true" data-offset-key="16344:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16345"><span data-slate-leaf="true" data-offset-key="16345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16346"><span data-slate-object="text" data-key="16347"><span data-slate-leaf="true" data-offset-key="16347:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16348"><span data-slate-leaf="true" data-offset-key="16348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16349"><span data-slate-leaf="true" data-offset-key="16349:0" data-first-offset="true"><span data-slate-string="true"> sysctl_sched_latency;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16350"><span data-slate-object="text" data-key="16351"><span data-slate-leaf="true" data-offset-key="16351:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16352"><span data-slate-object="text" data-key="16353"><span data-slate-leaf="true" data-offset-key="16353:0" data-first-offset="true"><span data-slate-string="true">上述代码中，参数 nr_running 是 Linux 系统中可运行的进程数量，当超过 sched_nr_latency 时，我们无法保证调度延迟，因此转为保证最小调度粒度。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16354" id="sr-toc-14"><span data-slate-object="text" data-key="16355"><span data-slate-leaf="true" data-offset-key="16355:0" data-first-offset="true"><span data-slate-string="true">虚拟时间</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16356"><span data-slate-object="text" data-key="16357"><span data-slate-leaf="true" data-offset-key="16357:0" data-first-offset="true"><span data-slate-string="true">你是否还记得调度实体中的 vruntime 么？它就是用来表示虚拟时间的，我们先按下不表，来看一个例子。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16358"><span data-slate-object="text" data-key="16359"><span data-slate-leaf="true" data-offset-key="16359:0" data-first-offset="true"><span data-slate-string="true">假设幼儿园只有一个秋千，所有孩子都想玩，身为老师的你该怎么处理呢？你一定会想每个孩子玩一段时间，然后就让给别的孩子，依次类推。CFS 调度器也是这样做的，它记录了每个进程的执行时间，为保证每个进程运行时间的公平，哪个进程运行的时间最少，就会让哪个进程运行。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16360"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/81/f1/818313e87a4e1129470fb87bacee59f1.jpg?wh=2284x1619"></div><div>CFS 调度器原理</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16361"><span data-slate-object="text" data-key="16362"><span data-slate-leaf="true" data-offset-key="16362:0" data-first-offset="true"><span data-slate-string="true">例如，调度延迟是 10ms，系统一共 2 个相同优先级的进程，那么各进程都将在 10ms 的时间内各运行 5ms。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16363"><span data-slate-object="text" data-key="16364"><span data-slate-leaf="true" data-offset-key="16364:0" data-first-offset="true"><span data-slate-string="true">现在进程 A 和进程 B 他们的权重分别是 1024 和 820（nice 值分别是 0 和 1）。进程 A 获得的运行时间是 10x1024/(1024+820)=5.6ms，进程 B 获得的执行时间是 10x820/(1024+820)=4.4ms。进程 A 的 cpu 使用比例是 5.6/10x100%=56%，进程 B 的 cpu 使用比例是 4.4/10x100%=44%。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16365"><span data-slate-object="text" data-key="16366"><span data-slate-leaf="true" data-offset-key="16366:0" data-first-offset="true"><span data-slate-string="true">很明显，这两个进程的实际执行时间是不等的，但 CFS 调度器想保证每个进程的运行时间相等。因此 CFS 调度器引入了虚拟时间，也就是说，上面的 5.6ms 和 4.4ms 经过一个公式，转换成相同的值，这个转换后的值就叫虚拟时间。这样的话，CFS 只需要保证每个进程运行的虚拟时间是相等的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16367"><span data-slate-object="text" data-key="16368"><span data-slate-leaf="true" data-offset-key="16368:0" data-first-offset="true"><span data-slate-string="true">虚拟时间 vruntime 和实际时间（wtime）转换公式如下：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16369"><span data-slate-object="text" data-key="16370"><span data-slate-leaf="true" data-offset-key="16370:0" data-first-offset="true"><span data-slate-type="primary" data-slate-object="mark"><span data-slate-string="true">vruntime = wtime*(NICE_0_LOAD/weight)</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16371"><span data-slate-object="text" data-key="16372"><span data-slate-leaf="true" data-offset-key="16372:0" data-first-offset="true"><span data-slate-string="true">根据上面的公式，可以发现 nice 值为 0 的进程，这种进程的虚拟时间和实际时间是相等的，那么进程 A 的虚拟时间为：5.6*(1024/1024)=5.6，进程 B 的虚拟时间为：4.4*(1024/820)=5.6。虽然进程 A 和进程 B 的权重不一样，但是计算得到的虚拟时间是一样的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16373"><span data-slate-object="text" data-key="16374"><span data-slate-leaf="true" data-offset-key="16374:0" data-first-offset="true"><span data-slate-string="true">所以，CFS 调度主要保证每个进程运行的虚拟时间一致即可。在选择下一个即将运行的进程时，只需要找到虚拟时间最小的进程就行了。这个计算过程由 calc_delta_fair 函数完成，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="16375"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16376"><span data-slate-object="text" data-key="16377"><span data-slate-leaf="true" data-offset-key="16377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16378"><span data-slate-leaf="true" data-offset-key="16378:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16379"><span data-slate-leaf="true" data-offset-key="16379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64</span></span></span></span><span data-slate-object="text" data-key="16380"><span data-slate-leaf="true" data-offset-key="16380:0" data-first-offset="true"><span data-slate-string="true"> __calc_delta(</span></span></span><span data-slate-object="text" data-key="16381"><span data-slate-leaf="true" data-offset-key="16381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64</span></span></span></span><span data-slate-object="text" data-key="16382"><span data-slate-leaf="true" data-offset-key="16382:0" data-first-offset="true"><span data-slate-string="true"> delta_exec, unsigned long weight, </span></span></span><span data-slate-object="text" data-key="16383"><span data-slate-leaf="true" data-offset-key="16383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16384"><span data-slate-leaf="true" data-offset-key="16384:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16385"><span data-slate-leaf="true" data-offset-key="16385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">load_weight</span></span></span></span><span data-slate-object="text" data-key="16386"><span data-slate-leaf="true" data-offset-key="16386:0" data-first-offset="true"><span data-slate-string="true"> *lw)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16387"><span data-slate-object="text" data-key="16388"><span data-slate-leaf="true" data-offset-key="16388:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16389"><span data-slate-object="text" data-key="16390"><span data-slate-leaf="true" data-offset-key="16390:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16391"><span data-slate-leaf="true" data-offset-key="16391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64</span></span></span></span><span data-slate-object="text" data-key="16392"><span data-slate-leaf="true" data-offset-key="16392:0" data-first-offset="true"><span data-slate-string="true"> fact = </span></span></span><span data-slate-object="text" data-key="16393"><span data-slate-leaf="true" data-offset-key="16393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">scale_load_down</span></span></span></span><span data-slate-object="text" data-key="16394"><span data-slate-leaf="true" data-offset-key="16394:0" data-first-offset="true"><span data-slate-string="true">(weight);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16395"><span data-slate-object="text" data-key="16396"><span data-slate-leaf="true" data-offset-key="16396:0" data-first-offset="true"><span data-slate-string="true">    int shift = WMULT_SHIFT;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16397"><span data-slate-object="text" data-key="16398"><span data-slate-leaf="true" data-offset-key="16398:0" data-first-offset="true"><span data-slate-string="true">    __update_inv_weight(lw);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16399"><span data-slate-object="text" data-key="16400"><span data-slate-leaf="true" data-offset-key="16400:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16401"><span data-slate-leaf="true" data-offset-key="16401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16402"><span data-slate-leaf="true" data-offset-key="16402:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="16403"><span data-slate-leaf="true" data-offset-key="16403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlikely</span></span></span></span><span data-slate-object="text" data-key="16404"><span data-slate-leaf="true" data-offset-key="16404:0" data-first-offset="true"><span data-slate-string="true">(fact&gt;&gt; </span></span></span><span data-slate-object="text" data-key="16405"><span data-slate-leaf="true" data-offset-key="16405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="16406"><span data-slate-leaf="true" data-offset-key="16406:0" data-first-offset="true"><span data-slate-string="true">)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16407"><span data-slate-object="text" data-key="16408"><span data-slate-leaf="true" data-offset-key="16408:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16409"><span data-slate-leaf="true" data-offset-key="16409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="16410"><span data-slate-leaf="true" data-offset-key="16410:0" data-first-offset="true"><span data-slate-string="true"> (fact&gt;&gt; </span></span></span><span data-slate-object="text" data-key="16411"><span data-slate-leaf="true" data-offset-key="16411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="16412"><span data-slate-leaf="true" data-offset-key="16412:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16413"><span data-slate-object="text" data-key="16414"><span data-slate-leaf="true" data-offset-key="16414:0" data-first-offset="true"><span data-slate-string="true">            fact &gt;&gt;= </span></span></span><span data-slate-object="text" data-key="16415"><span data-slate-leaf="true" data-offset-key="16415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16416"><span data-slate-leaf="true" data-offset-key="16416:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16417"><span data-slate-object="text" data-key="16418"><span data-slate-leaf="true" data-offset-key="16418:0" data-first-offset="true"><span data-slate-string="true">            shift--;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16419"><span data-slate-object="text" data-key="16420"><span data-slate-leaf="true" data-offset-key="16420:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16421"><span data-slate-object="text" data-key="16422"><span data-slate-leaf="true" data-offset-key="16422:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16423"><span data-slate-object="text" data-key="16424"><span data-slate-leaf="true" data-offset-key="16424:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16425"><span data-slate-leaf="true" data-offset-key="16425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为了避免使用浮点计算</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16426"><span data-slate-object="text" data-key="16427"><span data-slate-leaf="true" data-offset-key="16427:0" data-first-offset="true"><span data-slate-string="true">    fact = </span></span></span><span data-slate-object="text" data-key="16428"><span data-slate-leaf="true" data-offset-key="16428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mul_u32_u32</span></span></span></span><span data-slate-object="text" data-key="16429"><span data-slate-leaf="true" data-offset-key="16429:0" data-first-offset="true"><span data-slate-string="true">(fact, lw</span></span></span><span data-slate-object="text" data-key="16430"><span data-slate-leaf="true" data-offset-key="16430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="16431"><span data-slate-leaf="true" data-offset-key="16431:0" data-first-offset="true"><span data-slate-string="true">inv_weight);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16432"><span data-slate-object="text" data-key="16433"><span data-slate-leaf="true" data-offset-key="16433:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16434"><span data-slate-leaf="true" data-offset-key="16434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="16435"><span data-slate-leaf="true" data-offset-key="16435:0" data-first-offset="true"><span data-slate-string="true"> (fact&gt;&gt; </span></span></span><span data-slate-object="text" data-key="16436"><span data-slate-leaf="true" data-offset-key="16436:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="16437"><span data-slate-leaf="true" data-offset-key="16437:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16438"><span data-slate-object="text" data-key="16439"><span data-slate-leaf="true" data-offset-key="16439:0" data-first-offset="true"><span data-slate-string="true">        fact &gt;&gt;= </span></span></span><span data-slate-object="text" data-key="16440"><span data-slate-leaf="true" data-offset-key="16440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16441"><span data-slate-leaf="true" data-offset-key="16441:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16442"><span data-slate-object="text" data-key="16443"><span data-slate-leaf="true" data-offset-key="16443:0" data-first-offset="true"><span data-slate-string="true">        shift--;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16444"><span data-slate-object="text" data-key="16445"><span data-slate-leaf="true" data-offset-key="16445:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16446"><span data-slate-object="text" data-key="16447"><span data-slate-leaf="true" data-offset-key="16447:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16448"><span data-slate-leaf="true" data-offset-key="16448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16449"><span data-slate-leaf="true" data-offset-key="16449:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16450"><span data-slate-leaf="true" data-offset-key="16450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mul_u64_u32_shr</span></span></span></span><span data-slate-object="text" data-key="16451"><span data-slate-leaf="true" data-offset-key="16451:0" data-first-offset="true"><span data-slate-string="true">(delta_exec, fact, shift);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16452"><span data-slate-object="text" data-key="16453"><span data-slate-leaf="true" data-offset-key="16453:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16454"><span data-slate-object="text" data-key="16455"><span data-slate-leaf="true" data-offset-key="16455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16456"><span data-slate-leaf="true" data-offset-key="16456:0" data-first-offset="true"><span data-slate-string="true"> inline </span></span></span><span data-slate-object="text" data-key="16457"><span data-slate-leaf="true" data-offset-key="16457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64</span></span></span></span><span data-slate-object="text" data-key="16458"><span data-slate-leaf="true" data-offset-key="16458:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16459"><span data-slate-leaf="true" data-offset-key="16459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">calc_delta_fair</span></span></span></span><span data-slate-object="text" data-key="16460"><span data-slate-leaf="true" data-offset-key="16460:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16461"><span data-slate-leaf="true" data-offset-key="16461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64</span></span></span></span><span data-slate-object="text" data-key="16462"><span data-slate-leaf="true" data-offset-key="16462:0" data-first-offset="true"><span data-slate-string="true"> delta, </span></span></span><span data-slate-object="text" data-key="16463"><span data-slate-leaf="true" data-offset-key="16463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16464"><span data-slate-leaf="true" data-offset-key="16464:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16465"><span data-slate-leaf="true" data-offset-key="16465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="16466"><span data-slate-leaf="true" data-offset-key="16466:0" data-first-offset="true"><span data-slate-string="true"> *se)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16467"><span data-slate-object="text" data-key="16468"><span data-slate-leaf="true" data-offset-key="16468:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16469"><span data-slate-object="text" data-key="16470"><span data-slate-leaf="true" data-offset-key="16470:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16471"><span data-slate-leaf="true" data-offset-key="16471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16472"><span data-slate-leaf="true" data-offset-key="16472:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="16473"><span data-slate-leaf="true" data-offset-key="16473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlikely</span></span></span></span><span data-slate-object="text" data-key="16474"><span data-slate-leaf="true" data-offset-key="16474:0" data-first-offset="true"><span data-slate-string="true">(se</span></span></span><span data-slate-object="text" data-key="16475"><span data-slate-leaf="true" data-offset-key="16475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="16476"><span data-slate-leaf="true" data-offset-key="16476:0" data-first-offset="true"><span data-slate-string="true">load.weight != NICE_0_LOAD))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16477"><span data-slate-object="text" data-key="16478"><span data-slate-leaf="true" data-offset-key="16478:0" data-first-offset="true"><span data-slate-string="true">        delta = __calc_delta(delta, NICE_0_LOAD, &amp;se</span></span></span><span data-slate-object="text" data-key="16479"><span data-slate-leaf="true" data-offset-key="16479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="16480"><span data-slate-leaf="true" data-offset-key="16480:0" data-first-offset="true"><span data-slate-string="true">load);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16481"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16482"><span data-slate-object="text" data-key="16483"><span data-slate-leaf="true" data-offset-key="16483:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16484"><span data-slate-leaf="true" data-offset-key="16484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16485"><span data-slate-leaf="true" data-offset-key="16485:0" data-first-offset="true"><span data-slate-string="true"> delta;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16486"><span data-slate-object="text" data-key="16487"><span data-slate-leaf="true" data-offset-key="16487:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16488"><span data-slate-object="text" data-key="16489"><span data-slate-leaf="true" data-offset-key="16489:0" data-first-offset="true"><span data-slate-string="true">按照上面的理论，调用 __calc_delta 函数的时候，传递的 weight 参数是 NICE_0_LOAD，lw 参数正是调度实体中的 load_weight 结构体。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16490"><span data-slate-object="text" data-key="16491"><span data-slate-leaf="true" data-offset-key="16491:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">到这里，我要公开一个问题，在运行队列中用红黑树结构组织进程的调度实体，这里进程虚拟时间正是红黑树的 key，这样进程就以进程的虚拟时间被红黑树组织起来了。红黑树的最左子节点，就是虚拟时间最小的进程，随着时间的推移进程会从红黑树的左边跑到右，然后从右边跑到左边，就像舞蹈一样优美。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16492" id="sr-toc-15"><span data-slate-object="text" data-key="16493"><span data-slate-leaf="true" data-offset-key="16493:0" data-first-offset="true"><span data-slate-string="true">CFS 调度进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16494"><span data-slate-object="text" data-key="16495"><span data-slate-leaf="true" data-offset-key="16495:0" data-first-offset="true"><span data-slate-string="true">根据前面的内容，我们得知 CFS 调度器就是要维持各个可运行进程的虚拟时间相等，不相等就需要被调度运行。如果一个进程比其它进程的虚拟时间小，它就应该运行达到和其它进程的虚拟时间持平，直到它的虚拟时间超过其它进程，这时就要停下来，这样其它进程才能被调度运行。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16496" id="sr-toc-16"><span data-slate-object="text" data-key="16497"><span data-slate-leaf="true" data-offset-key="16497:0" data-first-offset="true"><span data-slate-string="true">定时周期调度</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16498"><span data-slate-object="text" data-key="16499"><span data-slate-leaf="true" data-offset-key="16499:0" data-first-offset="true"><span data-slate-string="true">前面虚拟时间的方案还存在问题，你发现了么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16500"><span data-slate-object="text" data-key="16501"><span data-slate-leaf="true" data-offset-key="16501:0" data-first-offset="true"><span data-slate-string="true">没错，虚拟时间就是一个数据，如果没有任何机制对它进行更新，就会导致一个进程永远运行下去，因为那个进程的虚拟时间没有更新，虚拟时间永远最小，这当然不行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16502"><span data-slate-object="text" data-key="16503"><span data-slate-leaf="true" data-offset-key="16503:0" data-first-offset="true"><span data-slate-string="true">因此定时周期调度机制应运而生。Linux 启动会启动定时器，这个定时器每 1/1000、1/250、1/100 秒（根据配置不同选取其一），产生一个时钟中断，在中断处理函数中最终会调用一个 scheduler_tick 函数，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16504"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16505"><span data-slate-object="text" data-key="16506"><span data-slate-leaf="true" data-offset-key="16506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="16507"><span data-slate-leaf="true" data-offset-key="16507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16508"><span data-slate-leaf="true" data-offset-key="16508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="16509"><span data-slate-leaf="true" data-offset-key="16509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16510"><span data-slate-leaf="true" data-offset-key="16510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">update_curr</span></span></span></span></span><span data-slate-object="text" data-key="16511"><span data-slate-leaf="true" data-offset-key="16511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="16512"><span data-slate-leaf="true" data-offset-key="16512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16513"><span data-slate-leaf="true" data-offset-key="16513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> cfs_rq *cfs_rq)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16514"><span data-slate-object="text" data-key="16515"><span data-slate-leaf="true" data-offset-key="16515:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16516"><span data-slate-object="text" data-key="16517"><span data-slate-leaf="true" data-offset-key="16517:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16518"><span data-slate-leaf="true" data-offset-key="16518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16519"><span data-slate-leaf="true" data-offset-key="16519:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16520"><span data-slate-leaf="true" data-offset-key="16520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="16521"><span data-slate-leaf="true" data-offset-key="16521:0" data-first-offset="true"><span data-slate-string="true"> *curr = cfs_rq-&gt;curr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16522"><span data-slate-object="text" data-key="16523"><span data-slate-leaf="true" data-offset-key="16523:0" data-first-offset="true"><span data-slate-string="true">    u64 now = </span></span></span><span data-slate-object="text" data-key="16524"><span data-slate-leaf="true" data-offset-key="16524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq_clock_task</span></span></span></span><span data-slate-object="text" data-key="16525"><span data-slate-leaf="true" data-offset-key="16525:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16526"><span data-slate-leaf="true" data-offset-key="16526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq_of</span></span></span></span><span data-slate-object="text" data-key="16527"><span data-slate-leaf="true" data-offset-key="16527:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq));</span></span></span><span data-slate-object="text" data-key="16528"><span data-slate-leaf="true" data-offset-key="16528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前时间 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16529"><span data-slate-object="text" data-key="16530"><span data-slate-leaf="true" data-offset-key="16530:0" data-first-offset="true"><span data-slate-string="true">    u64 delta_exec;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16531"><span data-slate-object="text" data-key="16532"><span data-slate-leaf="true" data-offset-key="16532:0" data-first-offset="true"><span data-slate-string="true">    delta_exec = now - curr-&gt;exec_start;</span></span></span><span data-slate-object="text" data-key="16533"><span data-slate-leaf="true" data-offset-key="16533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 间隔时间 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16534"><span data-slate-object="text" data-key="16535"><span data-slate-leaf="true" data-offset-key="16535:0" data-first-offset="true"><span data-slate-string="true">    curr-&gt;exec_start = now;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16536"><span data-slate-object="text" data-key="16537"><span data-slate-leaf="true" data-offset-key="16537:0" data-first-offset="true"><span data-slate-string="true">    curr-&gt;sum_exec_runtime += delta_exec;</span></span></span><span data-slate-object="text" data-key="16538"><span data-slate-leaf="true" data-offset-key="16538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 累计运行时间 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16539"><span data-slate-object="text" data-key="16540"><span data-slate-leaf="true" data-offset-key="16540:0" data-first-offset="true"><span data-slate-string="true">    curr-&gt;vruntime += </span></span></span><span data-slate-object="text" data-key="16541"><span data-slate-leaf="true" data-offset-key="16541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">calc_delta_fair</span></span></span></span><span data-slate-object="text" data-key="16542"><span data-slate-leaf="true" data-offset-key="16542:0" data-first-offset="true"><span data-slate-string="true">(delta_exec, curr);</span></span></span><span data-slate-object="text" data-key="16543"><span data-slate-leaf="true" data-offset-key="16543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 计算进程的虚拟时间 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16544"><span data-slate-object="text" data-key="16545"><span data-slate-leaf="true" data-offset-key="16545:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16546"><span data-slate-leaf="true" data-offset-key="16546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">update_min_vruntime</span></span></span></span><span data-slate-object="text" data-key="16547"><span data-slate-leaf="true" data-offset-key="16547:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq);</span></span></span><span data-slate-object="text" data-key="16548"><span data-slate-leaf="true" data-offset-key="16548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新运行队列中的最小虚拟时间，这是新建进程的虚拟时间，避免一个新建进程因为虚拟时间太小而长时间占用 CPU</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16549"><span data-slate-object="text" data-key="16550"><span data-slate-leaf="true" data-offset-key="16550:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16551"><span data-slate-object="text" data-key="16552"><span data-slate-leaf="true" data-offset-key="16552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="16553"><span data-slate-leaf="true" data-offset-key="16553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16554"><span data-slate-leaf="true" data-offset-key="16554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="16555"><span data-slate-leaf="true" data-offset-key="16555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16556"><span data-slate-leaf="true" data-offset-key="16556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">entity_tick</span></span></span></span></span><span data-slate-object="text" data-key="16557"><span data-slate-leaf="true" data-offset-key="16557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="16558"><span data-slate-leaf="true" data-offset-key="16558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16559"><span data-slate-leaf="true" data-offset-key="16559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> cfs_rq *cfs_rq, </span></span></span></span></span><span data-slate-object="text" data-key="16560"><span data-slate-leaf="true" data-offset-key="16560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16561"><span data-slate-leaf="true" data-offset-key="16561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sched_entity *curr, </span></span></span></span></span><span data-slate-object="text" data-key="16562"><span data-slate-leaf="true" data-offset-key="16562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16563"><span data-slate-leaf="true" data-offset-key="16563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> queued)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16564"><span data-slate-object="text" data-key="16565"><span data-slate-leaf="true" data-offset-key="16565:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16566"><span data-slate-object="text" data-key="16567"><span data-slate-leaf="true" data-offset-key="16567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16568"><span data-slate-leaf="true" data-offset-key="16568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">update_curr</span></span></span></span><span data-slate-object="text" data-key="16569"><span data-slate-leaf="true" data-offset-key="16569:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq);</span></span></span><span data-slate-object="text" data-key="16570"><span data-slate-leaf="true" data-offset-key="16570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新当前运行进程和运行队列相关的时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16571"><span data-slate-object="text" data-key="16572"><span data-slate-leaf="true" data-offset-key="16572:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16573"><span data-slate-leaf="true" data-offset-key="16573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16574"><span data-slate-leaf="true" data-offset-key="16574:0" data-first-offset="true"><span data-slate-string="true"> (cfs_rq-&gt;nr_running &gt; </span></span></span><span data-slate-object="text" data-key="16575"><span data-slate-leaf="true" data-offset-key="16575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16576"><span data-slate-leaf="true" data-offset-key="16576:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span><span data-slate-object="text" data-key="16577"><span data-slate-leaf="true" data-offset-key="16577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当运行进程数量大于 1 就检查是否可抢占</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16578"><span data-slate-object="text" data-key="16579"><span data-slate-leaf="true" data-offset-key="16579:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16580"><span data-slate-leaf="true" data-offset-key="16580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">check_preempt_tick</span></span></span></span><span data-slate-object="text" data-key="16581"><span data-slate-leaf="true" data-offset-key="16581:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq, curr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16582"><span data-slate-object="text" data-key="16583"><span data-slate-leaf="true" data-offset-key="16583:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16584"><span data-slate-object="text" data-key="16585"><span data-slate-leaf="true" data-offset-key="16585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="16586"><span data-slate-leaf="true" data-offset-key="16586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="16587"><span data-slate-leaf="true" data-offset-key="16587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for_each_sched_entity(se) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16588"><span data-slate-object="text" data-key="16589"><span data-slate-leaf="true" data-offset-key="16589:0" data-first-offset="true"><span data-slate-string="true">        for (; se; se = NULL)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16590"><span data-slate-object="text" data-key="16591"><span data-slate-leaf="true" data-offset-key="16591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="16592"><span data-slate-leaf="true" data-offset-key="16592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16593"><span data-slate-leaf="true" data-offset-key="16593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="16594"><span data-slate-leaf="true" data-offset-key="16594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16595"><span data-slate-leaf="true" data-offset-key="16595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_tick_fair</span></span></span></span></span><span data-slate-object="text" data-key="16596"><span data-slate-leaf="true" data-offset-key="16596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="16597"><span data-slate-leaf="true" data-offset-key="16597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16598"><span data-slate-leaf="true" data-offset-key="16598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> rq *rq, </span></span></span></span></span><span data-slate-object="text" data-key="16599"><span data-slate-leaf="true" data-offset-key="16599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16600"><span data-slate-leaf="true" data-offset-key="16600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> task_struct *curr, </span></span></span></span></span><span data-slate-object="text" data-key="16601"><span data-slate-leaf="true" data-offset-key="16601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16602"><span data-slate-leaf="true" data-offset-key="16602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> queued)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16603"><span data-slate-object="text" data-key="16604"><span data-slate-leaf="true" data-offset-key="16604:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16605"><span data-slate-object="text" data-key="16606"><span data-slate-leaf="true" data-offset-key="16606:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16607"><span data-slate-leaf="true" data-offset-key="16607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16608"><span data-slate-leaf="true" data-offset-key="16608:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16609"><span data-slate-leaf="true" data-offset-key="16609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="16610"><span data-slate-leaf="true" data-offset-key="16610:0" data-first-offset="true"><span data-slate-string="true"> *cfs_rq;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16611"><span data-slate-object="text" data-key="16612"><span data-slate-leaf="true" data-offset-key="16612:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16613"><span data-slate-leaf="true" data-offset-key="16613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16614"><span data-slate-leaf="true" data-offset-key="16614:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16615"><span data-slate-leaf="true" data-offset-key="16615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="16616"><span data-slate-leaf="true" data-offset-key="16616:0" data-first-offset="true"><span data-slate-string="true"> *se = &amp;curr-&gt;se;</span></span></span><span data-slate-object="text" data-key="16617"><span data-slate-leaf="true" data-offset-key="16617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前进程的调度实体 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16618"><span data-slate-object="text" data-key="16619"><span data-slate-leaf="true" data-offset-key="16619:0" data-first-offset="true"><span data-slate-string="true">    for_each_sched_entity(se) {</span></span></span><span data-slate-object="text" data-key="16620"><span data-slate-leaf="true" data-offset-key="16620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 仅对当前进程的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16621"><span data-slate-object="text" data-key="16622"><span data-slate-leaf="true" data-offset-key="16622:0" data-first-offset="true"><span data-slate-string="true">        cfs_rq = </span></span></span><span data-slate-object="text" data-key="16623"><span data-slate-leaf="true" data-offset-key="16623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq_of</span></span></span></span><span data-slate-object="text" data-key="16624"><span data-slate-leaf="true" data-offset-key="16624:0" data-first-offset="true"><span data-slate-string="true">(se);</span></span></span><span data-slate-object="text" data-key="16625"><span data-slate-leaf="true" data-offset-key="16625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前进程的调度实体对应运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16626"><span data-slate-object="text" data-key="16627"><span data-slate-leaf="true" data-offset-key="16627:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16628"><span data-slate-leaf="true" data-offset-key="16628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">entity_tick</span></span></span></span><span data-slate-object="text" data-key="16629"><span data-slate-leaf="true" data-offset-key="16629:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq, se, queued);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16630"><span data-slate-object="text" data-key="16631"><span data-slate-leaf="true" data-offset-key="16631:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16632"><span data-slate-object="text" data-key="16633"><span data-slate-leaf="true" data-offset-key="16633:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16634"><span data-slate-object="text" data-key="16635"><span data-slate-leaf="true" data-offset-key="16635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="16636"><span data-slate-leaf="true" data-offset-key="16636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16637"><span data-slate-leaf="true" data-offset-key="16637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">scheduler_tick</span></span></span></span></span><span data-slate-object="text" data-key="16638"><span data-slate-leaf="true" data-offset-key="16638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="16639"><span data-slate-leaf="true" data-offset-key="16639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="16640"><span data-slate-leaf="true" data-offset-key="16640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16641"><span data-slate-object="text" data-key="16642"><span data-slate-leaf="true" data-offset-key="16642:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16643"><span data-slate-object="text" data-key="16644"><span data-slate-leaf="true" data-offset-key="16644:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16645"><span data-slate-leaf="true" data-offset-key="16645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16646"><span data-slate-leaf="true" data-offset-key="16646:0" data-first-offset="true"><span data-slate-string="true"> cpu = </span></span></span><span data-slate-object="text" data-key="16647"><span data-slate-leaf="true" data-offset-key="16647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">smp_processor_id</span></span></span></span><span data-slate-object="text" data-key="16648"><span data-slate-leaf="true" data-offset-key="16648:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16649"><span data-slate-object="text" data-key="16650"><span data-slate-leaf="true" data-offset-key="16650:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16651"><span data-slate-leaf="true" data-offset-key="16651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16652"><span data-slate-leaf="true" data-offset-key="16652:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16653"><span data-slate-leaf="true" data-offset-key="16653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq</span></span></span></span><span data-slate-object="text" data-key="16654"><span data-slate-leaf="true" data-offset-key="16654:0" data-first-offset="true"><span data-slate-string="true"> *rq = </span></span></span><span data-slate-object="text" data-key="16655"><span data-slate-leaf="true" data-offset-key="16655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpu_rq</span></span></span></span><span data-slate-object="text" data-key="16656"><span data-slate-leaf="true" data-offset-key="16656:0" data-first-offset="true"><span data-slate-string="true">(cpu);</span></span></span><span data-slate-object="text" data-key="16657"><span data-slate-leaf="true" data-offset-key="16657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取运行 CPU 运行进程队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16658"><span data-slate-object="text" data-key="16659"><span data-slate-leaf="true" data-offset-key="16659:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16660"><span data-slate-leaf="true" data-offset-key="16660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16661"><span data-slate-leaf="true" data-offset-key="16661:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16662"><span data-slate-leaf="true" data-offset-key="16662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="16663"><span data-slate-leaf="true" data-offset-key="16663:0" data-first-offset="true"><span data-slate-string="true"> *curr = rq-&gt;curr;</span></span></span><span data-slate-object="text" data-key="16664"><span data-slate-leaf="true" data-offset-key="16664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16665"><span data-slate-object="text" data-key="16666"><span data-slate-leaf="true" data-offset-key="16666:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16667"><span data-slate-leaf="true" data-offset-key="16667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">update_rq_clock</span></span></span></span><span data-slate-object="text" data-key="16668"><span data-slate-leaf="true" data-offset-key="16668:0" data-first-offset="true"><span data-slate-string="true">(rq);</span></span></span><span data-slate-object="text" data-key="16669"><span data-slate-leaf="true" data-offset-key="16669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新运行队列的时间等数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16670"><span data-slate-object="text" data-key="16671"><span data-slate-leaf="true" data-offset-key="16671:0" data-first-offset="true"><span data-slate-string="true">    curr-&gt;sched_class-&gt;</span></span></span><span data-slate-object="text" data-key="16672"><span data-slate-leaf="true" data-offset-key="16672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_tick</span></span></span></span><span data-slate-object="text" data-key="16673"><span data-slate-leaf="true" data-offset-key="16673:0" data-first-offset="true"><span data-slate-string="true">(rq, curr, </span></span></span><span data-slate-object="text" data-key="16674"><span data-slate-leaf="true" data-offset-key="16674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16675"><span data-slate-leaf="true" data-offset-key="16675:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span><span data-slate-object="text" data-key="16676"><span data-slate-leaf="true" data-offset-key="16676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新当前时间的虚拟时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16677"><span data-slate-object="text" data-key="16678"><span data-slate-leaf="true" data-offset-key="16678:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16679"><span data-slate-object="text" data-key="16680"><span data-slate-leaf="true" data-offset-key="16680:0" data-first-offset="true"><span data-slate-string="true">上述代码中，scheduler_tick 函数会调用进程调度类的 task_tick 函数，对于 CFS 调度器就是 task_tick_fair 函数。但是真正做事的是 </span></span></span><span data-slate-object="text" data-key="16681"><span data-slate-leaf="true" data-offset-key="16681:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">entity_tick 函数</span></span></span></span><span data-slate-object="text" data-key="16682"><span data-slate-leaf="true" data-offset-key="16682:0" data-first-offset="true"><span data-slate-string="true">，entity_tick 函数中调用了 update_curr 函数更新当前进程虚拟时间，这个函数我们在之前讨论过了，还更新了运行队列的相关数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16683"><span data-slate-object="text" data-key="16684"><span data-slate-leaf="true" data-offset-key="16684:0" data-first-offset="true"><span data-slate-string="true">entity_tick 函数的最后，调用了 check_preempt_tick 函数，用来检查是否可以抢占调度，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16685"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16686"><span data-slate-object="text" data-key="16687"><span data-slate-leaf="true" data-offset-key="16687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="16688"><span data-slate-leaf="true" data-offset-key="16688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16689"><span data-slate-leaf="true" data-offset-key="16689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="16690"><span data-slate-leaf="true" data-offset-key="16690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16691"><span data-slate-leaf="true" data-offset-key="16691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">check_preempt_tick</span></span></span></span></span><span data-slate-object="text" data-key="16692"><span data-slate-leaf="true" data-offset-key="16692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="16693"><span data-slate-leaf="true" data-offset-key="16693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16694"><span data-slate-leaf="true" data-offset-key="16694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> cfs_rq *cfs_rq, </span></span></span></span></span><span data-slate-object="text" data-key="16695"><span data-slate-leaf="true" data-offset-key="16695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="16696"><span data-slate-leaf="true" data-offset-key="16696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sched_entity *curr)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16697"><span data-slate-object="text" data-key="16698"><span data-slate-leaf="true" data-offset-key="16698:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16699"><span data-slate-object="text" data-key="16700"><span data-slate-leaf="true" data-offset-key="16700:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16701"><span data-slate-leaf="true" data-offset-key="16701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16702"><span data-slate-leaf="true" data-offset-key="16702:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16703"><span data-slate-leaf="true" data-offset-key="16703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="16704"><span data-slate-leaf="true" data-offset-key="16704:0" data-first-offset="true"><span data-slate-string="true"> ideal_runtime, delta_exec;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16705"><span data-slate-object="text" data-key="16706"><span data-slate-leaf="true" data-offset-key="16706:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16707"><span data-slate-leaf="true" data-offset-key="16707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16708"><span data-slate-leaf="true" data-offset-key="16708:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16709"><span data-slate-leaf="true" data-offset-key="16709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="16710"><span data-slate-leaf="true" data-offset-key="16710:0" data-first-offset="true"><span data-slate-string="true"> *se;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16711"><span data-slate-object="text" data-key="16712"><span data-slate-leaf="true" data-offset-key="16712:0" data-first-offset="true"><span data-slate-string="true">    s64 delta;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16713"><span data-slate-object="text" data-key="16714"><span data-slate-leaf="true" data-offset-key="16714:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16715"><span data-slate-leaf="true" data-offset-key="16715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 计算当前进程在本次调度中分配的运行时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16716"><span data-slate-object="text" data-key="16717"><span data-slate-leaf="true" data-offset-key="16717:0" data-first-offset="true"><span data-slate-string="true">    ideal_runtime = </span></span></span><span data-slate-object="text" data-key="16718"><span data-slate-leaf="true" data-offset-key="16718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_slice</span></span></span></span><span data-slate-object="text" data-key="16719"><span data-slate-leaf="true" data-offset-key="16719:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq, curr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16720"><span data-slate-object="text" data-key="16721"><span data-slate-leaf="true" data-offset-key="16721:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16722"><span data-slate-leaf="true" data-offset-key="16722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前进程已经运行的实际时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16723"><span data-slate-object="text" data-key="16724"><span data-slate-leaf="true" data-offset-key="16724:0" data-first-offset="true"><span data-slate-string="true">    delta_exec = curr-&gt;sum_exec_runtime - curr-&gt;prev_sum_exec_runtime;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16725"><span data-slate-object="text" data-key="16726"><span data-slate-leaf="true" data-offset-key="16726:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16727"><span data-slate-leaf="true" data-offset-key="16727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果实际运行时间已经超过分配给进程的运行时间，就需要抢占当前进程。设置进程的 TIF_NEED_RESCHED 抢占标志。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16728"><span data-slate-object="text" data-key="16729"><span data-slate-leaf="true" data-offset-key="16729:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16730"><span data-slate-leaf="true" data-offset-key="16730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16731"><span data-slate-leaf="true" data-offset-key="16731:0" data-first-offset="true"><span data-slate-string="true"> (delta_exec&gt; ideal_runtime) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16732"><span data-slate-object="text" data-key="16733"><span data-slate-leaf="true" data-offset-key="16733:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16734"><span data-slate-leaf="true" data-offset-key="16734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">resched_curr</span></span></span></span><span data-slate-object="text" data-key="16735"><span data-slate-leaf="true" data-offset-key="16735:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16736"><span data-slate-leaf="true" data-offset-key="16736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq_of</span></span></span></span><span data-slate-object="text" data-key="16737"><span data-slate-leaf="true" data-offset-key="16737:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16738"><span data-slate-object="text" data-key="16739"><span data-slate-leaf="true" data-offset-key="16739:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16740"><span data-slate-leaf="true" data-offset-key="16740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16741"><span data-slate-leaf="true" data-offset-key="16741:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16742"><span data-slate-object="text" data-key="16743"><span data-slate-leaf="true" data-offset-key="16743:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16744"><span data-slate-object="text" data-key="16745"><span data-slate-leaf="true" data-offset-key="16745:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16746"><span data-slate-leaf="true" data-offset-key="16746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 因此如果进程运行时间小于最小调度粒度时间，不应该抢占</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16747"><span data-slate-object="text" data-key="16748"><span data-slate-leaf="true" data-offset-key="16748:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16749"><span data-slate-leaf="true" data-offset-key="16749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16750"><span data-slate-leaf="true" data-offset-key="16750:0" data-first-offset="true"><span data-slate-string="true"> (delta_exec &lt; sysctl_sched_min_granularity)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16751"><span data-slate-object="text" data-key="16752"><span data-slate-leaf="true" data-offset-key="16752:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16753"><span data-slate-leaf="true" data-offset-key="16753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16754"><span data-slate-leaf="true" data-offset-key="16754:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16755"><span data-slate-object="text" data-key="16756"><span data-slate-leaf="true" data-offset-key="16756:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16757"><span data-slate-leaf="true" data-offset-key="16757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从红黑树中找到虚拟时间最小的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16758"><span data-slate-object="text" data-key="16759"><span data-slate-leaf="true" data-offset-key="16759:0" data-first-offset="true"><span data-slate-string="true">    se = __pick_first_entity(cfs_rq);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16760"><span data-slate-object="text" data-key="16761"><span data-slate-leaf="true" data-offset-key="16761:0" data-first-offset="true"><span data-slate-string="true">    delta = curr-&gt;vruntime - se-&gt;vruntime;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16762"><span data-slate-object="text" data-key="16763"><span data-slate-leaf="true" data-offset-key="16763:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16764"><span data-slate-leaf="true" data-offset-key="16764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前进程的虚拟时间仍然比红黑树中最左边调度实体虚拟时间小，也不应该发生调度</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16765"><span data-slate-object="text" data-key="16766"><span data-slate-leaf="true" data-offset-key="16766:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16767"><span data-slate-leaf="true" data-offset-key="16767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16768"><span data-slate-leaf="true" data-offset-key="16768:0" data-first-offset="true"><span data-slate-string="true"> (delta &lt; </span></span></span><span data-slate-object="text" data-key="16769"><span data-slate-leaf="true" data-offset-key="16769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16770"><span data-slate-leaf="true" data-offset-key="16770:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16771"><span data-slate-object="text" data-key="16772"><span data-slate-leaf="true" data-offset-key="16772:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16773"><span data-slate-leaf="true" data-offset-key="16773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16774"><span data-slate-leaf="true" data-offset-key="16774:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16775"><span data-slate-object="text" data-key="16776"><span data-slate-leaf="true" data-offset-key="16776:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16777"><span data-slate-object="text" data-key="16778"><span data-slate-leaf="true" data-offset-key="16778:0" data-first-offset="true"><span data-slate-string="true">刚才的代码你可以这样理解，如果需要抢占就会调用 resched_curr 函数设置进程的抢占标志，但是这个函数本身不会调用进程调度器函数，而是在进程从中断或者系统调用返回到用户态空间时，检查当前进程的调度标志，然后根据需要调用进程调度器函数。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16779" id="sr-toc-17"><span data-slate-object="text" data-key="16780"><span data-slate-leaf="true" data-offset-key="16780:0" data-first-offset="true"><span data-slate-string="true">调度器入口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16781"><span data-slate-object="text" data-key="16782"><span data-slate-leaf="true" data-offset-key="16782:0" data-first-offset="true"><span data-slate-string="true">如果设计需要进行进程抢占调度，Linux 就会在适当的时机进行进程调度，进程调度就是调用进程调度器入口函数，该函数会选择一个最合适投入运行的进程，然后切换到该进程上运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16783"><span data-slate-object="text" data-key="16784"><span data-slate-leaf="true" data-offset-key="16784:0" data-first-offset="true"><span data-slate-string="true">我们先来看看，进程调度器入口函数的代码长什么样。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16785"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16786"><span data-slate-object="text" data-key="16787"><span data-slate-leaf="true" data-offset-key="16787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16788"><span data-slate-leaf="true" data-offset-key="16788:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16789"><span data-slate-leaf="true" data-offset-key="16789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="16790"><span data-slate-leaf="true" data-offset-key="16790:0" data-first-offset="true"><span data-slate-string="true"> __sched notrace __schedule(</span></span></span><span data-slate-object="text" data-key="16791"><span data-slate-leaf="true" data-offset-key="16791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="16792"><span data-slate-leaf="true" data-offset-key="16792:0" data-first-offset="true"><span data-slate-string="true"> preempt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16793"><span data-slate-object="text" data-key="16794"><span data-slate-leaf="true" data-offset-key="16794:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16795"><span data-slate-object="text" data-key="16796"><span data-slate-leaf="true" data-offset-key="16796:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16797"><span data-slate-leaf="true" data-offset-key="16797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16798"><span data-slate-leaf="true" data-offset-key="16798:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16799"><span data-slate-leaf="true" data-offset-key="16799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="16800"><span data-slate-leaf="true" data-offset-key="16800:0" data-first-offset="true"><span data-slate-string="true"> *prev, *next;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16801"><span data-slate-object="text" data-key="16802"><span data-slate-leaf="true" data-offset-key="16802:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16803"><span data-slate-leaf="true" data-offset-key="16803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16804"><span data-slate-leaf="true" data-offset-key="16804:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16805"><span data-slate-leaf="true" data-offset-key="16805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="16806"><span data-slate-leaf="true" data-offset-key="16806:0" data-first-offset="true"><span data-slate-string="true"> *switch_count;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16807"><span data-slate-object="text" data-key="16808"><span data-slate-leaf="true" data-offset-key="16808:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16809"><span data-slate-leaf="true" data-offset-key="16809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="16810"><span data-slate-leaf="true" data-offset-key="16810:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16811"><span data-slate-leaf="true" data-offset-key="16811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="16812"><span data-slate-leaf="true" data-offset-key="16812:0" data-first-offset="true"><span data-slate-string="true"> prev_state;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16813"><span data-slate-object="text" data-key="16814"><span data-slate-leaf="true" data-offset-key="16814:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16815"><span data-slate-leaf="true" data-offset-key="16815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16816"><span data-slate-leaf="true" data-offset-key="16816:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16817"><span data-slate-leaf="true" data-offset-key="16817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq_flags</span></span></span></span><span data-slate-object="text" data-key="16818"><span data-slate-leaf="true" data-offset-key="16818:0" data-first-offset="true"><span data-slate-string="true"> rf;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16819"><span data-slate-object="text" data-key="16820"><span data-slate-leaf="true" data-offset-key="16820:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16821"><span data-slate-leaf="true" data-offset-key="16821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16822"><span data-slate-leaf="true" data-offset-key="16822:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16823"><span data-slate-leaf="true" data-offset-key="16823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq</span></span></span></span><span data-slate-object="text" data-key="16824"><span data-slate-leaf="true" data-offset-key="16824:0" data-first-offset="true"><span data-slate-string="true"> *rq;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16825"><span data-slate-object="text" data-key="16826"><span data-slate-leaf="true" data-offset-key="16826:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16827"><span data-slate-leaf="true" data-offset-key="16827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16828"><span data-slate-leaf="true" data-offset-key="16828:0" data-first-offset="true"><span data-slate-string="true"> cpu;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16829"><span data-slate-object="text" data-key="16830"><span data-slate-leaf="true" data-offset-key="16830:0" data-first-offset="true"><span data-slate-string="true">    cpu = </span></span></span><span data-slate-object="text" data-key="16831"><span data-slate-leaf="true" data-offset-key="16831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">smp_processor_id</span></span></span></span><span data-slate-object="text" data-key="16832"><span data-slate-leaf="true" data-offset-key="16832:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16833"><span data-slate-object="text" data-key="16834"><span data-slate-leaf="true" data-offset-key="16834:0" data-first-offset="true"><span data-slate-string="true">    rq = </span></span></span><span data-slate-object="text" data-key="16835"><span data-slate-leaf="true" data-offset-key="16835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpu_rq</span></span></span></span><span data-slate-object="text" data-key="16836"><span data-slate-leaf="true" data-offset-key="16836:0" data-first-offset="true"><span data-slate-string="true">(cpu);</span></span></span><span data-slate-object="text" data-key="16837"><span data-slate-leaf="true" data-offset-key="16837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前 CPU 的运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16838"><span data-slate-object="text" data-key="16839"><span data-slate-leaf="true" data-offset-key="16839:0" data-first-offset="true"><span data-slate-string="true">    prev = rq-&gt;curr; </span></span></span><span data-slate-object="text" data-key="16840"><span data-slate-leaf="true" data-offset-key="16840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前进程 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16841"><span data-slate-object="text" data-key="16842"><span data-slate-leaf="true" data-offset-key="16842:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16843"><span data-slate-leaf="true" data-offset-key="16843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq_lock</span></span></span></span><span data-slate-object="text" data-key="16844"><span data-slate-leaf="true" data-offset-key="16844:0" data-first-offset="true"><span data-slate-string="true">(rq, &amp;rf);</span></span></span><span data-slate-object="text" data-key="16845"><span data-slate-leaf="true" data-offset-key="16845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行队列加锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16846"><span data-slate-object="text" data-key="16847"><span data-slate-leaf="true" data-offset-key="16847:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16848"><span data-slate-leaf="true" data-offset-key="16848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">update_rq_clock</span></span></span></span><span data-slate-object="text" data-key="16849"><span data-slate-leaf="true" data-offset-key="16849:0" data-first-offset="true"><span data-slate-string="true">(rq);</span></span></span><span data-slate-object="text" data-key="16850"><span data-slate-leaf="true" data-offset-key="16850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新运行队列时钟</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16851"><span data-slate-object="text" data-key="16852"><span data-slate-leaf="true" data-offset-key="16852:0" data-first-offset="true"><span data-slate-string="true">    switch_count = &amp;prev-&gt;nivcsw;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16853"><span data-slate-object="text" data-key="16854"><span data-slate-leaf="true" data-offset-key="16854:0" data-first-offset="true"><span data-slate-string="true">    next = </span></span></span><span data-slate-object="text" data-key="16855"><span data-slate-leaf="true" data-offset-key="16855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task</span></span></span></span><span data-slate-object="text" data-key="16856"><span data-slate-leaf="true" data-offset-key="16856:0" data-first-offset="true"><span data-slate-string="true">(rq, prev, &amp;rf);</span></span></span><span data-slate-object="text" data-key="16857"><span data-slate-leaf="true" data-offset-key="16857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取下一个投入运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16858"><span data-slate-object="text" data-key="16859"><span data-slate-leaf="true" data-offset-key="16859:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16860"><span data-slate-leaf="true" data-offset-key="16860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clear_tsk_need_resched</span></span></span></span><span data-slate-object="text" data-key="16861"><span data-slate-leaf="true" data-offset-key="16861:0" data-first-offset="true"><span data-slate-string="true">(prev); </span></span></span><span data-slate-object="text" data-key="16862"><span data-slate-leaf="true" data-offset-key="16862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清除抢占标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16863"><span data-slate-object="text" data-key="16864"><span data-slate-leaf="true" data-offset-key="16864:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16865"><span data-slate-leaf="true" data-offset-key="16865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clear_preempt_need_resched</span></span></span></span><span data-slate-object="text" data-key="16866"><span data-slate-leaf="true" data-offset-key="16866:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16867"><span data-slate-object="text" data-key="16868"><span data-slate-leaf="true" data-offset-key="16868:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16869"><span data-slate-leaf="true" data-offset-key="16869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16870"><span data-slate-leaf="true" data-offset-key="16870:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="16871"><span data-slate-leaf="true" data-offset-key="16871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">likely</span></span></span></span><span data-slate-object="text" data-key="16872"><span data-slate-leaf="true" data-offset-key="16872:0" data-first-offset="true"><span data-slate-string="true">(prev != next)) {</span></span></span><span data-slate-object="text" data-key="16873"><span data-slate-leaf="true" data-offset-key="16873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前运行进程和下一个运行进程不同，就要进程切换</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16874"><span data-slate-object="text" data-key="16875"><span data-slate-leaf="true" data-offset-key="16875:0" data-first-offset="true"><span data-slate-string="true">        rq-&gt;nr_switches++; </span></span></span><span data-slate-object="text" data-key="16876"><span data-slate-leaf="true" data-offset-key="16876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 切换计数统计</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16877"><span data-slate-object="text" data-key="16878"><span data-slate-leaf="true" data-offset-key="16878:0" data-first-offset="true"><span data-slate-string="true">        ++*switch_count;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16879"><span data-slate-object="text" data-key="16880"><span data-slate-leaf="true" data-offset-key="16880:0" data-first-offset="true"><span data-slate-string="true">        rq = </span></span></span><span data-slate-object="text" data-key="16881"><span data-slate-leaf="true" data-offset-key="16881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context_switch</span></span></span></span><span data-slate-object="text" data-key="16882"><span data-slate-leaf="true" data-offset-key="16882:0" data-first-offset="true"><span data-slate-string="true">(rq, prev, next, &amp;rf);</span></span></span><span data-slate-object="text" data-key="16883"><span data-slate-leaf="true" data-offset-key="16883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程机器上下文切换</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16884"><span data-slate-object="text" data-key="16885"><span data-slate-leaf="true" data-offset-key="16885:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="16886"><span data-slate-leaf="true" data-offset-key="16886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="16887"><span data-slate-leaf="true" data-offset-key="16887:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16888"><span data-slate-object="text" data-key="16889"><span data-slate-leaf="true" data-offset-key="16889:0" data-first-offset="true"><span data-slate-string="true">        rq-&gt;clock_update_flags &amp;= ~(RQCF_ACT_SKIP|RQCF_REQ_SKIP);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16890"><span data-slate-object="text" data-key="16891"><span data-slate-leaf="true" data-offset-key="16891:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16892"><span data-slate-leaf="true" data-offset-key="16892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rq_unlock_irq</span></span></span></span><span data-slate-object="text" data-key="16893"><span data-slate-leaf="true" data-offset-key="16893:0" data-first-offset="true"><span data-slate-string="true">(rq, &amp;rf);</span></span></span><span data-slate-object="text" data-key="16894"><span data-slate-leaf="true" data-offset-key="16894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16895"><span data-slate-object="text" data-key="16896"><span data-slate-leaf="true" data-offset-key="16896:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16897"><span data-slate-object="text" data-key="16898"><span data-slate-leaf="true" data-offset-key="16898:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16899"><span data-slate-object="text" data-key="16900"><span data-slate-leaf="true" data-offset-key="16900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="16901"><span data-slate-leaf="true" data-offset-key="16901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16902"><span data-slate-leaf="true" data-offset-key="16902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schedule</span></span></span></span></span><span data-slate-object="text" data-key="16903"><span data-slate-leaf="true" data-offset-key="16903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="16904"><span data-slate-leaf="true" data-offset-key="16904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="16905"><span data-slate-leaf="true" data-offset-key="16905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16906"><span data-slate-object="text" data-key="16907"><span data-slate-leaf="true" data-offset-key="16907:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16908"><span data-slate-object="text" data-key="16909"><span data-slate-leaf="true" data-offset-key="16909:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16910"><span data-slate-leaf="true" data-offset-key="16910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16911"><span data-slate-leaf="true" data-offset-key="16911:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16912"><span data-slate-leaf="true" data-offset-key="16912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="16913"><span data-slate-leaf="true" data-offset-key="16913:0" data-first-offset="true"><span data-slate-string="true"> *tsk = current;</span></span></span><span data-slate-object="text" data-key="16914"><span data-slate-leaf="true" data-offset-key="16914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16915"><span data-slate-object="text" data-key="16916"><span data-slate-leaf="true" data-offset-key="16916:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16917"><span data-slate-leaf="true" data-offset-key="16917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">do</span></span></span></span><span data-slate-object="text" data-key="16918"><span data-slate-leaf="true" data-offset-key="16918:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16919"><span data-slate-object="text" data-key="16920"><span data-slate-leaf="true" data-offset-key="16920:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16921"><span data-slate-leaf="true" data-offset-key="16921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">preempt_disable</span></span></span></span><span data-slate-object="text" data-key="16922"><span data-slate-leaf="true" data-offset-key="16922:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="16923"><span data-slate-leaf="true" data-offset-key="16923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭内核抢占</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16924"><span data-slate-object="text" data-key="16925"><span data-slate-leaf="true" data-offset-key="16925:0" data-first-offset="true"><span data-slate-string="true">        __schedule(</span></span></span><span data-slate-object="text" data-key="16926"><span data-slate-leaf="true" data-offset-key="16926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="16927"><span data-slate-leaf="true" data-offset-key="16927:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span><span data-slate-object="text" data-key="16928"><span data-slate-leaf="true" data-offset-key="16928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程调用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16929"><span data-slate-object="text" data-key="16930"><span data-slate-leaf="true" data-offset-key="16930:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16931"><span data-slate-leaf="true" data-offset-key="16931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_preempt_enable_no_resched</span></span></span></span><span data-slate-object="text" data-key="16932"><span data-slate-leaf="true" data-offset-key="16932:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="16933"><span data-slate-leaf="true" data-offset-key="16933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开启内核抢占</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16934"><span data-slate-object="text" data-key="16935"><span data-slate-leaf="true" data-offset-key="16935:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="16936"><span data-slate-leaf="true" data-offset-key="16936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="16937"><span data-slate-leaf="true" data-offset-key="16937:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="16938"><span data-slate-leaf="true" data-offset-key="16938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">need_resched</span></span></span></span><span data-slate-object="text" data-key="16939"><span data-slate-leaf="true" data-offset-key="16939:0" data-first-offset="true"><span data-slate-string="true">());</span></span></span><span data-slate-object="text" data-key="16940"><span data-slate-leaf="true" data-offset-key="16940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否需要再次重新调用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16941"><span data-slate-object="text" data-key="16942"><span data-slate-leaf="true" data-offset-key="16942:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16943"><span data-slate-object="text" data-key="16944"><span data-slate-leaf="true" data-offset-key="16944:0" data-first-offset="true"><span data-slate-string="true">之所以在循环中调用 __schedule 函数执行真正的进程调度，是因为在执行调度的过程中，有些更高优先级的进程进入了可运行状态，因此它就要抢占当前进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16945"><span data-slate-object="text" data-key="16946"><span data-slate-leaf="true" data-offset-key="16946:0" data-first-offset="true"><span data-slate-string="true">__schedule 函数中会更新一些统计数据，然后调用 pick_next_task 函数挑选出下一个进程投入运行。最后，如果当前进程和下一个要运行的进程不同，就要进行进程机器上下文切换，其中会切换地址空间和 CPU 寄存器。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16947" id="sr-toc-18"><span data-slate-object="text" data-key="16948"><span data-slate-leaf="true" data-offset-key="16948:0" data-first-offset="true"><span data-slate-string="true">挑选下一个进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16949"><span data-slate-object="text" data-key="16950"><span data-slate-leaf="true" data-offset-key="16950:0" data-first-offset="true"><span data-slate-string="true">在 __schedule 函数中，获取了正在运行的进程，更新了运行队列的时钟，下面就要挑选出下一个投入运行的进程。显然，不是随便挑选一个，我们这就来看看调度器是如何挑选的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16951"><span data-slate-object="text" data-key="16952"><span data-slate-leaf="true" data-offset-key="16952:0" data-first-offset="true"><span data-slate-string="true">挑选下一个运行进程这个过程，是在 pick_next_task 函数中完成的，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16953"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16954"><span data-slate-object="text" data-key="16955"><span data-slate-leaf="true" data-offset-key="16955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="16956"><span data-slate-leaf="true" data-offset-key="16956:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16957"><span data-slate-leaf="true" data-offset-key="16957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="16958"><span data-slate-leaf="true" data-offset-key="16958:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16959"><span data-slate-leaf="true" data-offset-key="16959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16960"><span data-slate-leaf="true" data-offset-key="16960:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16961"><span data-slate-leaf="true" data-offset-key="16961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="16962"><span data-slate-leaf="true" data-offset-key="16962:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="16963"><span data-slate-leaf="true" data-offset-key="16963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task</span></span></span></span><span data-slate-object="text" data-key="16964"><span data-slate-leaf="true" data-offset-key="16964:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16965"><span data-slate-leaf="true" data-offset-key="16965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16966"><span data-slate-leaf="true" data-offset-key="16966:0" data-first-offset="true"><span data-slate-string="true"> rq *rq, </span></span></span><span data-slate-object="text" data-key="16967"><span data-slate-leaf="true" data-offset-key="16967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16968"><span data-slate-leaf="true" data-offset-key="16968:0" data-first-offset="true"><span data-slate-string="true"> task_struct *prev, </span></span></span><span data-slate-object="text" data-key="16969"><span data-slate-leaf="true" data-offset-key="16969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16970"><span data-slate-leaf="true" data-offset-key="16970:0" data-first-offset="true"><span data-slate-string="true"> rq_flags *rf)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16971"><span data-slate-object="text" data-key="16972"><span data-slate-leaf="true" data-offset-key="16972:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16973"><span data-slate-object="text" data-key="16974"><span data-slate-leaf="true" data-offset-key="16974:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16975"><span data-slate-leaf="true" data-offset-key="16975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="16976"><span data-slate-leaf="true" data-offset-key="16976:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16977"><span data-slate-leaf="true" data-offset-key="16977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16978"><span data-slate-leaf="true" data-offset-key="16978:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16979"><span data-slate-leaf="true" data-offset-key="16979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_class</span></span></span></span><span data-slate-object="text" data-key="16980"><span data-slate-leaf="true" data-offset-key="16980:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="16981"><span data-slate-leaf="true" data-offset-key="16981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="16982"><span data-slate-leaf="true" data-offset-key="16982:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16983"><span data-slate-object="text" data-key="16984"><span data-slate-leaf="true" data-offset-key="16984:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16985"><span data-slate-leaf="true" data-offset-key="16985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16986"><span data-slate-leaf="true" data-offset-key="16986:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16987"><span data-slate-leaf="true" data-offset-key="16987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="16988"><span data-slate-leaf="true" data-offset-key="16988:0" data-first-offset="true"><span data-slate-string="true"> *p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16989"><span data-slate-object="text" data-key="16990"><span data-slate-leaf="true" data-offset-key="16990:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16991"><span data-slate-leaf="true" data-offset-key="16991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这是对 CFS 的一种优化处理，因为大部分进程属于 CFS 管理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16992"><span data-slate-object="text" data-key="16993"><span data-slate-leaf="true" data-offset-key="16993:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16994"><span data-slate-leaf="true" data-offset-key="16994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16995"><span data-slate-leaf="true" data-offset-key="16995:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="16996"><span data-slate-leaf="true" data-offset-key="16996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">likely</span></span></span></span><span data-slate-object="text" data-key="16997"><span data-slate-leaf="true" data-offset-key="16997:0" data-first-offset="true"><span data-slate-string="true">(prev-&gt;sched_class &lt;= &amp;fair_sched_class &amp;&amp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16998"><span data-slate-object="text" data-key="16999"><span data-slate-leaf="true" data-offset-key="16999:0" data-first-offset="true"><span data-slate-string="true">           rq-&gt;nr_running == rq-&gt;cfs.h_nr_running)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17000"><span data-slate-object="text" data-key="17001"><span data-slate-leaf="true" data-offset-key="17001:0" data-first-offset="true"><span data-slate-string="true">        p = </span></span></span><span data-slate-object="text" data-key="17002"><span data-slate-leaf="true" data-offset-key="17002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task_fair</span></span></span></span><span data-slate-object="text" data-key="17003"><span data-slate-leaf="true" data-offset-key="17003:0" data-first-offset="true"><span data-slate-string="true">(rq, prev, rf);</span></span></span><span data-slate-object="text" data-key="17004"><span data-slate-leaf="true" data-offset-key="17004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 CFS 的对应的函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17005"><span data-slate-object="text" data-key="17006"><span data-slate-leaf="true" data-offset-key="17006:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17007"><span data-slate-leaf="true" data-offset-key="17007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17008"><span data-slate-leaf="true" data-offset-key="17008:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="17009"><span data-slate-leaf="true" data-offset-key="17009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlikely</span></span></span></span><span data-slate-object="text" data-key="17010"><span data-slate-leaf="true" data-offset-key="17010:0" data-first-offset="true"><span data-slate-string="true">(p == RETRY_TASK))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17011"><span data-slate-object="text" data-key="17012"><span data-slate-leaf="true" data-offset-key="17012:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17013"><span data-slate-leaf="true" data-offset-key="17013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="17014"><span data-slate-leaf="true" data-offset-key="17014:0" data-first-offset="true"><span data-slate-string="true"> restart;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17015"><span data-slate-object="text" data-key="17016"><span data-slate-leaf="true" data-offset-key="17016:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17017"><span data-slate-leaf="true" data-offset-key="17017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17018"><span data-slate-leaf="true" data-offset-key="17018:0" data-first-offset="true"><span data-slate-string="true"> (!p) {</span></span></span><span data-slate-object="text" data-key="17019"><span data-slate-leaf="true" data-offset-key="17019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果没有获取到运行进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17020"><span data-slate-object="text" data-key="17021"><span data-slate-leaf="true" data-offset-key="17021:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17022"><span data-slate-leaf="true" data-offset-key="17022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put_prev_task</span></span></span></span><span data-slate-object="text" data-key="17023"><span data-slate-leaf="true" data-offset-key="17023:0" data-first-offset="true"><span data-slate-string="true">(rq, prev);</span></span></span><span data-slate-object="text" data-key="17024"><span data-slate-leaf="true" data-offset-key="17024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将上一个进程放回运行队列中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17025"><span data-slate-object="text" data-key="17026"><span data-slate-leaf="true" data-offset-key="17026:0" data-first-offset="true"><span data-slate-string="true">            p = </span></span></span><span data-slate-object="text" data-key="17027"><span data-slate-leaf="true" data-offset-key="17027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task_idle</span></span></span></span><span data-slate-object="text" data-key="17028"><span data-slate-leaf="true" data-offset-key="17028:0" data-first-offset="true"><span data-slate-string="true">(rq);</span></span></span><span data-slate-object="text" data-key="17029"><span data-slate-leaf="true" data-offset-key="17029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17030"><span data-slate-object="text" data-key="17031"><span data-slate-leaf="true" data-offset-key="17031:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17032"><span data-slate-object="text" data-key="17033"><span data-slate-leaf="true" data-offset-key="17033:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17034"><span data-slate-leaf="true" data-offset-key="17034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17035"><span data-slate-leaf="true" data-offset-key="17035:0" data-first-offset="true"><span data-slate-string="true"> p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17036"><span data-slate-object="text" data-key="17037"><span data-slate-leaf="true" data-offset-key="17037:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17038"><span data-slate-object="text" data-key="17039"><span data-slate-leaf="true" data-offset-key="17039:0" data-first-offset="true"><span data-slate-string="true">restart:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17040"><span data-slate-object="text" data-key="17041"><span data-slate-leaf="true" data-offset-key="17041:0" data-first-offset="true"><span data-slate-string="true">    for_each_class(</span></span></span><span data-slate-object="text" data-key="17042"><span data-slate-leaf="true" data-offset-key="17042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="17043"><span data-slate-leaf="true" data-offset-key="17043:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span><span data-slate-object="text" data-key="17044"><span data-slate-leaf="true" data-offset-key="17044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 依次从最高优先级的调度类开始遍历</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17045"><span data-slate-object="text" data-key="17046"><span data-slate-leaf="true" data-offset-key="17046:0" data-first-offset="true"><span data-slate-string="true">        p = </span></span></span><span data-slate-object="text" data-key="17047"><span data-slate-leaf="true" data-offset-key="17047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="17048"><span data-slate-leaf="true" data-offset-key="17048:0" data-first-offset="true"><span data-slate-string="true">-&gt;</span></span></span><span data-slate-object="text" data-key="17049"><span data-slate-leaf="true" data-offset-key="17049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task</span></span></span></span><span data-slate-object="text" data-key="17050"><span data-slate-leaf="true" data-offset-key="17050:0" data-first-offset="true"><span data-slate-string="true">(rq);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17051"><span data-slate-object="text" data-key="17052"><span data-slate-leaf="true" data-offset-key="17052:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17053"><span data-slate-leaf="true" data-offset-key="17053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17054"><span data-slate-leaf="true" data-offset-key="17054:0" data-first-offset="true"><span data-slate-string="true"> (p)</span></span></span><span data-slate-object="text" data-key="17055"><span data-slate-leaf="true" data-offset-key="17055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果在一个调度类所管理的运行队列中挑选到一个进程，立即返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17056"><span data-slate-object="text" data-key="17057"><span data-slate-leaf="true" data-offset-key="17057:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17058"><span data-slate-leaf="true" data-offset-key="17058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17059"><span data-slate-leaf="true" data-offset-key="17059:0" data-first-offset="true"><span data-slate-string="true"> p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17060"><span data-slate-object="text" data-key="17061"><span data-slate-leaf="true" data-offset-key="17061:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17062"><span data-slate-object="text" data-key="17063"><span data-slate-leaf="true" data-offset-key="17063:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17064"><span data-slate-leaf="true" data-offset-key="17064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BUG</span></span></span></span><span data-slate-object="text" data-key="17065"><span data-slate-leaf="true" data-offset-key="17065:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="17066"><span data-slate-leaf="true" data-offset-key="17066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 出错</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17067"><span data-slate-object="text" data-key="17068"><span data-slate-leaf="true" data-offset-key="17068:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17069"><span data-slate-object="text" data-key="17070"><span data-slate-leaf="true" data-offset-key="17070:0" data-first-offset="true"><span data-slate-string="true">你看，pick_next_task 函数只是个框架函数，它的逻辑也很清楚，会依照优先级调用具体调度器类的函数完成工作，对于 CFS 则会调用 pick_next_task_fair 函数，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="17071"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17072"><span data-slate-object="text" data-key="17073"><span data-slate-leaf="true" data-offset-key="17073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17074"><span data-slate-leaf="true" data-offset-key="17074:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17075"><span data-slate-leaf="true" data-offset-key="17075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="17076"><span data-slate-leaf="true" data-offset-key="17076:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="17077"><span data-slate-leaf="true" data-offset-key="17077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_task_fair</span></span></span></span><span data-slate-object="text" data-key="17078"><span data-slate-leaf="true" data-offset-key="17078:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17079"><span data-slate-leaf="true" data-offset-key="17079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17080"><span data-slate-leaf="true" data-offset-key="17080:0" data-first-offset="true"><span data-slate-string="true"> rq *rq, </span></span></span><span data-slate-object="text" data-key="17081"><span data-slate-leaf="true" data-offset-key="17081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17082"><span data-slate-leaf="true" data-offset-key="17082:0" data-first-offset="true"><span data-slate-string="true"> task_struct *prev, </span></span></span><span data-slate-object="text" data-key="17083"><span data-slate-leaf="true" data-offset-key="17083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17084"><span data-slate-leaf="true" data-offset-key="17084:0" data-first-offset="true"><span data-slate-string="true"> rq_flags *rf)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17085"><span data-slate-object="text" data-key="17086"><span data-slate-leaf="true" data-offset-key="17086:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17087"><span data-slate-object="text" data-key="17088"><span data-slate-leaf="true" data-offset-key="17088:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17089"><span data-slate-leaf="true" data-offset-key="17089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17090"><span data-slate-leaf="true" data-offset-key="17090:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17091"><span data-slate-leaf="true" data-offset-key="17091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="17092"><span data-slate-leaf="true" data-offset-key="17092:0" data-first-offset="true"><span data-slate-string="true"> *cfs_rq = &amp;rq-&gt;cfs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17093"><span data-slate-object="text" data-key="17094"><span data-slate-leaf="true" data-offset-key="17094:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17095"><span data-slate-leaf="true" data-offset-key="17095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17096"><span data-slate-leaf="true" data-offset-key="17096:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17097"><span data-slate-leaf="true" data-offset-key="17097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17098"><span data-slate-leaf="true" data-offset-key="17098:0" data-first-offset="true"><span data-slate-string="true"> *se;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17099"><span data-slate-object="text" data-key="17100"><span data-slate-leaf="true" data-offset-key="17100:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17101"><span data-slate-leaf="true" data-offset-key="17101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17102"><span data-slate-leaf="true" data-offset-key="17102:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17103"><span data-slate-leaf="true" data-offset-key="17103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_struct</span></span></span></span><span data-slate-object="text" data-key="17104"><span data-slate-leaf="true" data-offset-key="17104:0" data-first-offset="true"><span data-slate-string="true"> *p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17105"><span data-slate-object="text" data-key="17106"><span data-slate-leaf="true" data-offset-key="17106:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17107"><span data-slate-leaf="true" data-offset-key="17107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17108"><span data-slate-leaf="true" data-offset-key="17108:0" data-first-offset="true"><span data-slate-string="true"> (prev)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17109"><span data-slate-object="text" data-key="17110"><span data-slate-leaf="true" data-offset-key="17110:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17111"><span data-slate-leaf="true" data-offset-key="17111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put_prev_task</span></span></span></span><span data-slate-object="text" data-key="17112"><span data-slate-leaf="true" data-offset-key="17112:0" data-first-offset="true"><span data-slate-string="true">(rq, prev);</span></span></span><span data-slate-object="text" data-key="17113"><span data-slate-leaf="true" data-offset-key="17113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把上一个进程放回运行队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17114"><span data-slate-object="text" data-key="17115"><span data-slate-leaf="true" data-offset-key="17115:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17116"><span data-slate-leaf="true" data-offset-key="17116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">do</span></span></span></span><span data-slate-object="text" data-key="17117"><span data-slate-leaf="true" data-offset-key="17117:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17118"><span data-slate-object="text" data-key="17119"><span data-slate-leaf="true" data-offset-key="17119:0" data-first-offset="true"><span data-slate-string="true">        se = </span></span></span><span data-slate-object="text" data-key="17120"><span data-slate-leaf="true" data-offset-key="17120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_entity</span></span></span></span><span data-slate-object="text" data-key="17121"><span data-slate-leaf="true" data-offset-key="17121:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq, </span></span></span><span data-slate-object="text" data-key="17122"><span data-slate-leaf="true" data-offset-key="17122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="17123"><span data-slate-leaf="true" data-offset-key="17123:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span><span data-slate-object="text" data-key="17124"><span data-slate-leaf="true" data-offset-key="17124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 选择最适合运行的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17125"><span data-slate-object="text" data-key="17126"><span data-slate-leaf="true" data-offset-key="17126:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17127"><span data-slate-leaf="true" data-offset-key="17127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_next_entity</span></span></span></span><span data-slate-object="text" data-key="17128"><span data-slate-leaf="true" data-offset-key="17128:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq, se);</span></span></span><span data-slate-object="text" data-key="17129"><span data-slate-leaf="true" data-offset-key="17129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对选择的调度实体进行一些处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17130"><span data-slate-object="text" data-key="17131"><span data-slate-leaf="true" data-offset-key="17131:0" data-first-offset="true"><span data-slate-string="true">        cfs_rq = </span></span></span><span data-slate-object="text" data-key="17132"><span data-slate-leaf="true" data-offset-key="17132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group_cfs_rq</span></span></span></span><span data-slate-object="text" data-key="17133"><span data-slate-leaf="true" data-offset-key="17133:0" data-first-offset="true"><span data-slate-string="true">(se);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17134"><span data-slate-object="text" data-key="17135"><span data-slate-leaf="true" data-offset-key="17135:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="17136"><span data-slate-leaf="true" data-offset-key="17136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="17137"><span data-slate-leaf="true" data-offset-key="17137:0" data-first-offset="true"><span data-slate-string="true"> (cfs_rq);</span></span></span><span data-slate-object="text" data-key="17138"><span data-slate-leaf="true" data-offset-key="17138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在没有调度组的情况下，循环一次就结束了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17139"><span data-slate-object="text" data-key="17140"><span data-slate-leaf="true" data-offset-key="17140:0" data-first-offset="true"><span data-slate-string="true">    p = </span></span></span><span data-slate-object="text" data-key="17141"><span data-slate-leaf="true" data-offset-key="17141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">task_of</span></span></span></span><span data-slate-object="text" data-key="17142"><span data-slate-leaf="true" data-offset-key="17142:0" data-first-offset="true"><span data-slate-string="true">(se);</span></span></span><span data-slate-object="text" data-key="17143"><span data-slate-leaf="true" data-offset-key="17143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过 se 获取包含 se 的进程 task_struct</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17144"><span data-slate-object="text" data-key="17145"><span data-slate-leaf="true" data-offset-key="17145:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17146"><span data-slate-leaf="true" data-offset-key="17146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17147"><span data-slate-leaf="true" data-offset-key="17147:0" data-first-offset="true"><span data-slate-string="true"> p;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17148"><span data-slate-object="text" data-key="17149"><span data-slate-leaf="true" data-offset-key="17149:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17150"><span data-slate-object="text" data-key="17151"><span data-slate-leaf="true" data-offset-key="17151:0" data-first-offset="true"><span data-slate-string="true">上述代码中调用 pick_next_entity 函数选择虚拟时间最小的调度实体，然后调用 set_next_entity 函数，对选择的调度实体进行一些必要的处理，主要是将这调度实体从运行队列中拿出来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17152"><span data-slate-object="text" data-key="17153"><span data-slate-leaf="true" data-offset-key="17153:0" data-first-offset="true"><span data-slate-string="true">pick_next_entity 函数具体要怎么工作呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17154"><span data-slate-object="text" data-key="17155"><span data-slate-leaf="true" data-offset-key="17155:0" data-first-offset="true"><span data-slate-string="true">首先，它调用了相关函数，从运行队列上的红黑树中查找虚拟时间最少的调度实体，然后处理要跳过调度的情况，最后决定挑选的调度实体是否可以抢占并返回它。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="17156"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17157"><span data-slate-object="text" data-key="17158"><span data-slate-leaf="true" data-offset-key="17158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17159"><span data-slate-leaf="true" data-offset-key="17159:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17160"><span data-slate-leaf="true" data-offset-key="17160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17161"><span data-slate-leaf="true" data-offset-key="17161:0" data-first-offset="true"><span data-slate-string="true"> *__pick_first_entity(</span></span></span><span data-slate-object="text" data-key="17162"><span data-slate-leaf="true" data-offset-key="17162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17163"><span data-slate-leaf="true" data-offset-key="17163:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17164"><span data-slate-leaf="true" data-offset-key="17164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="17165"><span data-slate-leaf="true" data-offset-key="17165:0" data-first-offset="true"><span data-slate-string="true"> *cfs_rq)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17166"><span data-slate-object="text" data-key="17167"><span data-slate-leaf="true" data-offset-key="17167:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17168"><span data-slate-object="text" data-key="17169"><span data-slate-leaf="true" data-offset-key="17169:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17170"><span data-slate-leaf="true" data-offset-key="17170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17171"><span data-slate-leaf="true" data-offset-key="17171:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17172"><span data-slate-leaf="true" data-offset-key="17172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_node</span></span></span></span><span data-slate-object="text" data-key="17173"><span data-slate-leaf="true" data-offset-key="17173:0" data-first-offset="true"><span data-slate-string="true"> *left = </span></span></span><span data-slate-object="text" data-key="17174"><span data-slate-leaf="true" data-offset-key="17174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_first_cached</span></span></span></span><span data-slate-object="text" data-key="17175"><span data-slate-leaf="true" data-offset-key="17175:0" data-first-offset="true"><span data-slate-string="true">(&amp;cfs_rq</span></span></span><span data-slate-object="text" data-key="17176"><span data-slate-leaf="true" data-offset-key="17176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17177"><span data-slate-leaf="true" data-offset-key="17177:0" data-first-offset="true"><span data-slate-string="true">tasks_timeline);</span></span></span><span data-slate-object="text" data-key="17178"><span data-slate-leaf="true" data-offset-key="17178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 先读取在 tasks_timeline 中 rb_node 指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17179"><span data-slate-object="text" data-key="17180"><span data-slate-leaf="true" data-offset-key="17180:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17181"><span data-slate-leaf="true" data-offset-key="17181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17182"><span data-slate-leaf="true" data-offset-key="17182:0" data-first-offset="true"><span data-slate-string="true"> (!left)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17183"><span data-slate-object="text" data-key="17184"><span data-slate-leaf="true" data-offset-key="17184:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17185"><span data-slate-leaf="true" data-offset-key="17185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17186"><span data-slate-leaf="true" data-offset-key="17186:0" data-first-offset="true"><span data-slate-string="true"> NULL;</span></span></span><span data-slate-object="text" data-key="17187"><span data-slate-leaf="true" data-offset-key="17187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果为空直接返回 NULL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17188"><span data-slate-object="text" data-key="17189"><span data-slate-leaf="true" data-offset-key="17189:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17190"><span data-slate-leaf="true" data-offset-key="17190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过红黑树结点指针取得包含它的调度实体结构地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17191"><span data-slate-object="text" data-key="17192"><span data-slate-leaf="true" data-offset-key="17192:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17193"><span data-slate-leaf="true" data-offset-key="17193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17194"><span data-slate-leaf="true" data-offset-key="17194:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17195"><span data-slate-leaf="true" data-offset-key="17195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_entry</span></span></span></span><span data-slate-object="text" data-key="17196"><span data-slate-leaf="true" data-offset-key="17196:0" data-first-offset="true"><span data-slate-string="true">(left, </span></span></span><span data-slate-object="text" data-key="17197"><span data-slate-leaf="true" data-offset-key="17197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17198"><span data-slate-leaf="true" data-offset-key="17198:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17199"><span data-slate-leaf="true" data-offset-key="17199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17200"><span data-slate-leaf="true" data-offset-key="17200:0" data-first-offset="true"><span data-slate-string="true">, run_node);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17201"><span data-slate-object="text" data-key="17202"><span data-slate-leaf="true" data-offset-key="17202:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17203"><span data-slate-object="text" data-key="17204"><span data-slate-leaf="true" data-offset-key="17204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="17205"><span data-slate-leaf="true" data-offset-key="17205:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17206"><span data-slate-leaf="true" data-offset-key="17206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17207"><span data-slate-leaf="true" data-offset-key="17207:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17208"><span data-slate-leaf="true" data-offset-key="17208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17209"><span data-slate-leaf="true" data-offset-key="17209:0" data-first-offset="true"><span data-slate-string="true"> *__pick_next_entity(</span></span></span><span data-slate-object="text" data-key="17210"><span data-slate-leaf="true" data-offset-key="17210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17211"><span data-slate-leaf="true" data-offset-key="17211:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17212"><span data-slate-leaf="true" data-offset-key="17212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17213"><span data-slate-leaf="true" data-offset-key="17213:0" data-first-offset="true"><span data-slate-string="true"> *se)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17214"><span data-slate-object="text" data-key="17215"><span data-slate-leaf="true" data-offset-key="17215:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span><span data-slate-object="text" data-key="17216"><span data-slate-leaf="true" data-offset-key="17216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前红黑树节点的下一个结点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17217"><span data-slate-object="text" data-key="17218"><span data-slate-leaf="true" data-offset-key="17218:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17219"><span data-slate-leaf="true" data-offset-key="17219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17220"><span data-slate-leaf="true" data-offset-key="17220:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17221"><span data-slate-leaf="true" data-offset-key="17221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_node</span></span></span></span><span data-slate-object="text" data-key="17222"><span data-slate-leaf="true" data-offset-key="17222:0" data-first-offset="true"><span data-slate-string="true"> *next = </span></span></span><span data-slate-object="text" data-key="17223"><span data-slate-leaf="true" data-offset-key="17223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_next</span></span></span></span><span data-slate-object="text" data-key="17224"><span data-slate-leaf="true" data-offset-key="17224:0" data-first-offset="true"><span data-slate-string="true">(&amp;se</span></span></span><span data-slate-object="text" data-key="17225"><span data-slate-leaf="true" data-offset-key="17225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17226"><span data-slate-leaf="true" data-offset-key="17226:0" data-first-offset="true"><span data-slate-string="true">run_node);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17227"><span data-slate-object="text" data-key="17228"><span data-slate-leaf="true" data-offset-key="17228:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17229"><span data-slate-leaf="true" data-offset-key="17229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17230"><span data-slate-leaf="true" data-offset-key="17230:0" data-first-offset="true"><span data-slate-string="true"> (!next)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17231"><span data-slate-object="text" data-key="17232"><span data-slate-leaf="true" data-offset-key="17232:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17233"><span data-slate-leaf="true" data-offset-key="17233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17234"><span data-slate-leaf="true" data-offset-key="17234:0" data-first-offset="true"><span data-slate-string="true"> NULL;</span></span></span><span data-slate-object="text" data-key="17235"><span data-slate-leaf="true" data-offset-key="17235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果为空直接返回 NULL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17236"><span data-slate-object="text" data-key="17237"><span data-slate-leaf="true" data-offset-key="17237:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17238"><span data-slate-leaf="true" data-offset-key="17238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17239"><span data-slate-leaf="true" data-offset-key="17239:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17240"><span data-slate-leaf="true" data-offset-key="17240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rb_entry</span></span></span></span><span data-slate-object="text" data-key="17241"><span data-slate-leaf="true" data-offset-key="17241:0" data-first-offset="true"><span data-slate-string="true">(next, </span></span></span><span data-slate-object="text" data-key="17242"><span data-slate-leaf="true" data-offset-key="17242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17243"><span data-slate-leaf="true" data-offset-key="17243:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17244"><span data-slate-leaf="true" data-offset-key="17244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17245"><span data-slate-leaf="true" data-offset-key="17245:0" data-first-offset="true"><span data-slate-string="true">, run_node);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17246"><span data-slate-object="text" data-key="17247"><span data-slate-leaf="true" data-offset-key="17247:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17248"><span data-slate-object="text" data-key="17249"><span data-slate-leaf="true" data-offset-key="17249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="17250"><span data-slate-leaf="true" data-offset-key="17250:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17251"><span data-slate-leaf="true" data-offset-key="17251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17252"><span data-slate-leaf="true" data-offset-key="17252:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17253"><span data-slate-leaf="true" data-offset-key="17253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17254"><span data-slate-leaf="true" data-offset-key="17254:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="17255"><span data-slate-leaf="true" data-offset-key="17255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pick_next_entity</span></span></span></span><span data-slate-object="text" data-key="17256"><span data-slate-leaf="true" data-offset-key="17256:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17257"><span data-slate-leaf="true" data-offset-key="17257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17258"><span data-slate-leaf="true" data-offset-key="17258:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17259"><span data-slate-leaf="true" data-offset-key="17259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cfs_rq</span></span></span></span><span data-slate-object="text" data-key="17260"><span data-slate-leaf="true" data-offset-key="17260:0" data-first-offset="true"><span data-slate-string="true"> *cfs_rq, </span></span></span><span data-slate-object="text" data-key="17261"><span data-slate-leaf="true" data-offset-key="17261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17262"><span data-slate-leaf="true" data-offset-key="17262:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17263"><span data-slate-leaf="true" data-offset-key="17263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17264"><span data-slate-leaf="true" data-offset-key="17264:0" data-first-offset="true"><span data-slate-string="true"> *curr)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17265"><span data-slate-object="text" data-key="17266"><span data-slate-leaf="true" data-offset-key="17266:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17267"><span data-slate-object="text" data-key="17268"><span data-slate-leaf="true" data-offset-key="17268:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17269"><span data-slate-leaf="true" data-offset-key="17269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 Cfs_rq 中的红黑树上最左节点上调度实体，虚拟时间最小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17270"><span data-slate-object="text" data-key="17271"><span data-slate-leaf="true" data-offset-key="17271:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17272"><span data-slate-leaf="true" data-offset-key="17272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17273"><span data-slate-leaf="true" data-offset-key="17273:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17274"><span data-slate-leaf="true" data-offset-key="17274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17275"><span data-slate-leaf="true" data-offset-key="17275:0" data-first-offset="true"><span data-slate-string="true"> *left = __pick_first_entity(cfs_rq);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17276"><span data-slate-object="text" data-key="17277"><span data-slate-leaf="true" data-offset-key="17277:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17278"><span data-slate-leaf="true" data-offset-key="17278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17279"><span data-slate-leaf="true" data-offset-key="17279:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17280"><span data-slate-leaf="true" data-offset-key="17280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17281"><span data-slate-leaf="true" data-offset-key="17281:0" data-first-offset="true"><span data-slate-string="true"> *se;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17282"><span data-slate-object="text" data-key="17283"><span data-slate-leaf="true" data-offset-key="17283:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17284"><span data-slate-leaf="true" data-offset-key="17284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17285"><span data-slate-leaf="true" data-offset-key="17285:0" data-first-offset="true"><span data-slate-string="true"> (!left || (curr &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17286"><span data-slate-leaf="true" data-offset-key="17286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">entity_before</span></span></span></span><span data-slate-object="text" data-key="17287"><span data-slate-leaf="true" data-offset-key="17287:0" data-first-offset="true"><span data-slate-string="true">(curr, left)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17288"><span data-slate-object="text" data-key="17289"><span data-slate-leaf="true" data-offset-key="17289:0" data-first-offset="true"><span data-slate-string="true">        left = curr;</span></span></span><span data-slate-object="text" data-key="17290"><span data-slate-leaf="true" data-offset-key="17290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 可能当前进程主动放弃 CPU，它的虚拟时间比红黑树上的还小，所以 left 指向当前进程调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17291"><span data-slate-object="text" data-key="17292"><span data-slate-leaf="true" data-offset-key="17292:0" data-first-offset="true"><span data-slate-string="true">    se = left; </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17293"><span data-slate-object="text" data-key="17294"><span data-slate-leaf="true" data-offset-key="17294:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17295"><span data-slate-leaf="true" data-offset-key="17295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17296"><span data-slate-leaf="true" data-offset-key="17296:0" data-first-offset="true"><span data-slate-string="true"> (cfs_rq</span></span></span><span data-slate-object="text" data-key="17297"><span data-slate-leaf="true" data-offset-key="17297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17298"><span data-slate-leaf="true" data-offset-key="17298:0" data-first-offset="true"><span data-slate-string="true">skip == se) { </span></span></span><span data-slate-object="text" data-key="17299"><span data-slate-leaf="true" data-offset-key="17299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果选择的调度实体是要跳过的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17300"><span data-slate-object="text" data-key="17301"><span data-slate-leaf="true" data-offset-key="17301:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17302"><span data-slate-leaf="true" data-offset-key="17302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17303"><span data-slate-leaf="true" data-offset-key="17303:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17304"><span data-slate-leaf="true" data-offset-key="17304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_entity</span></span></span></span><span data-slate-object="text" data-key="17305"><span data-slate-leaf="true" data-offset-key="17305:0" data-first-offset="true"><span data-slate-string="true"> *second;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17306"><span data-slate-object="text" data-key="17307"><span data-slate-leaf="true" data-offset-key="17307:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17308"><span data-slate-leaf="true" data-offset-key="17308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17309"><span data-slate-leaf="true" data-offset-key="17309:0" data-first-offset="true"><span data-slate-string="true"> (se == curr) {</span></span></span><span data-slate-object="text" data-key="17310"><span data-slate-leaf="true" data-offset-key="17310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是当前调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17311"><span data-slate-object="text" data-key="17312"><span data-slate-leaf="true" data-offset-key="17312:0" data-first-offset="true"><span data-slate-string="true">            second = __pick_first_entity(cfs_rq);</span></span></span><span data-slate-object="text" data-key="17313"><span data-slate-leaf="true" data-offset-key="17313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 选择运行队列中虚拟时间最小的调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17314"><span data-slate-object="text" data-key="17315"><span data-slate-leaf="true" data-offset-key="17315:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="17316"><span data-slate-leaf="true" data-offset-key="17316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17317"><span data-slate-leaf="true" data-offset-key="17317:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span><span data-slate-object="text" data-key="17318"><span data-slate-leaf="true" data-offset-key="17318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则选择红黑树上第二左的进程节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17319"><span data-slate-object="text" data-key="17320"><span data-slate-leaf="true" data-offset-key="17320:0" data-first-offset="true"><span data-slate-string="true">            second = __pick_next_entity(se);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17321"><span data-slate-object="text" data-key="17322"><span data-slate-leaf="true" data-offset-key="17322:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17323"><span data-slate-leaf="true" data-offset-key="17323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果次优的调度实体的虚拟时间，还是比当前的调度实体的虚拟时间大</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17324"><span data-slate-object="text" data-key="17325"><span data-slate-leaf="true" data-offset-key="17325:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17326"><span data-slate-leaf="true" data-offset-key="17326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17327"><span data-slate-leaf="true" data-offset-key="17327:0" data-first-offset="true"><span data-slate-string="true"> (!second || (curr &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17328"><span data-slate-leaf="true" data-offset-key="17328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">entity_before</span></span></span></span><span data-slate-object="text" data-key="17329"><span data-slate-leaf="true" data-offset-key="17329:0" data-first-offset="true"><span data-slate-string="true">(curr, second)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17330"><span data-slate-object="text" data-key="17331"><span data-slate-leaf="true" data-offset-key="17331:0" data-first-offset="true"><span data-slate-string="true">                second = curr;</span></span></span><span data-slate-object="text" data-key="17332"><span data-slate-leaf="true" data-offset-key="17332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 让次优的调度实体也指向当前调度实体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17333"><span data-slate-object="text" data-key="17334"><span data-slate-leaf="true" data-offset-key="17334:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17335"><span data-slate-object="text" data-key="17336"><span data-slate-leaf="true" data-offset-key="17336:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17337"><span data-slate-leaf="true" data-offset-key="17337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断 left 和 second 的虚拟时间的差距是否小于 sysctl_sched_wakeup_granularity</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17338"><span data-slate-object="text" data-key="17339"><span data-slate-leaf="true" data-offset-key="17339:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17340"><span data-slate-leaf="true" data-offset-key="17340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17341"><span data-slate-leaf="true" data-offset-key="17341:0" data-first-offset="true"><span data-slate-string="true"> (second &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17342"><span data-slate-leaf="true" data-offset-key="17342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">wakeup_preempt_entity</span></span></span></span><span data-slate-object="text" data-key="17343"><span data-slate-leaf="true" data-offset-key="17343:0" data-first-offset="true"><span data-slate-string="true">(second, left) &lt; </span></span></span><span data-slate-object="text" data-key="17344"><span data-slate-leaf="true" data-offset-key="17344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17345"><span data-slate-leaf="true" data-offset-key="17345:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17346"><span data-slate-object="text" data-key="17347"><span data-slate-leaf="true" data-offset-key="17347:0" data-first-offset="true"><span data-slate-string="true">            se = second;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17348"><span data-slate-object="text" data-key="17349"><span data-slate-leaf="true" data-offset-key="17349:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17350"><span data-slate-object="text" data-key="17351"><span data-slate-leaf="true" data-offset-key="17351:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17352"><span data-slate-leaf="true" data-offset-key="17352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17353"><span data-slate-leaf="true" data-offset-key="17353:0" data-first-offset="true"><span data-slate-string="true"> (cfs_rq</span></span></span><span data-slate-object="text" data-key="17354"><span data-slate-leaf="true" data-offset-key="17354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17355"><span data-slate-leaf="true" data-offset-key="17355:0" data-first-offset="true"><span data-slate-string="true">next &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17356"><span data-slate-leaf="true" data-offset-key="17356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">wakeup_preempt_entity</span></span></span></span><span data-slate-object="text" data-key="17357"><span data-slate-leaf="true" data-offset-key="17357:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq</span></span></span><span data-slate-object="text" data-key="17358"><span data-slate-leaf="true" data-offset-key="17358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17359"><span data-slate-leaf="true" data-offset-key="17359:0" data-first-offset="true"><span data-slate-string="true">next, left) &lt; </span></span></span><span data-slate-object="text" data-key="17360"><span data-slate-leaf="true" data-offset-key="17360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17361"><span data-slate-leaf="true" data-offset-key="17361:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17362"><span data-slate-object="text" data-key="17363"><span data-slate-leaf="true" data-offset-key="17363:0" data-first-offset="true"><span data-slate-string="true">        se = cfs_rq</span></span></span><span data-slate-object="text" data-key="17364"><span data-slate-leaf="true" data-offset-key="17364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17365"><span data-slate-leaf="true" data-offset-key="17365:0" data-first-offset="true"><span data-slate-string="true">next;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17366"><span data-slate-object="text" data-key="17367"><span data-slate-leaf="true" data-offset-key="17367:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="17368"><span data-slate-leaf="true" data-offset-key="17368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17369"><span data-slate-leaf="true" data-offset-key="17369:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17370"><span data-slate-leaf="true" data-offset-key="17370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17371"><span data-slate-leaf="true" data-offset-key="17371:0" data-first-offset="true"><span data-slate-string="true"> (cfs_rq</span></span></span><span data-slate-object="text" data-key="17372"><span data-slate-leaf="true" data-offset-key="17372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17373"><span data-slate-leaf="true" data-offset-key="17373:0" data-first-offset="true"><span data-slate-string="true">last &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17374"><span data-slate-leaf="true" data-offset-key="17374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">wakeup_preempt_entity</span></span></span></span><span data-slate-object="text" data-key="17375"><span data-slate-leaf="true" data-offset-key="17375:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq</span></span></span><span data-slate-object="text" data-key="17376"><span data-slate-leaf="true" data-offset-key="17376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17377"><span data-slate-leaf="true" data-offset-key="17377:0" data-first-offset="true"><span data-slate-string="true">last, left) &lt; </span></span></span><span data-slate-object="text" data-key="17378"><span data-slate-leaf="true" data-offset-key="17378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17379"><span data-slate-leaf="true" data-offset-key="17379:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17380"><span data-slate-object="text" data-key="17381"><span data-slate-leaf="true" data-offset-key="17381:0" data-first-offset="true"><span data-slate-string="true">             se = cfs_rq</span></span></span><span data-slate-object="text" data-key="17382"><span data-slate-leaf="true" data-offset-key="17382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="17383"><span data-slate-leaf="true" data-offset-key="17383:0" data-first-offset="true"><span data-slate-string="true">last;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17384"><span data-slate-object="text" data-key="17385"><span data-slate-leaf="true" data-offset-key="17385:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17386"><span data-slate-object="text" data-key="17387"><span data-slate-leaf="true" data-offset-key="17387:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17388"><span data-slate-leaf="true" data-offset-key="17388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clear_buddies</span></span></span></span><span data-slate-object="text" data-key="17389"><span data-slate-leaf="true" data-offset-key="17389:0" data-first-offset="true"><span data-slate-string="true">(cfs_rq, se);</span></span></span><span data-slate-object="text" data-key="17390"><span data-slate-leaf="true" data-offset-key="17390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 需要清除掉 last、next、skip 指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17391"><span data-slate-object="text" data-key="17392"><span data-slate-leaf="true" data-offset-key="17392:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17393"><span data-slate-leaf="true" data-offset-key="17393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17394"><span data-slate-leaf="true" data-offset-key="17394:0" data-first-offset="true"><span data-slate-string="true"> se;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17395"><span data-slate-object="text" data-key="17396"><span data-slate-leaf="true" data-offset-key="17396:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17397"><span data-slate-object="text" data-key="17398"><span data-slate-leaf="true" data-offset-key="17398:0" data-first-offset="true"><span data-slate-string="true">代码的调用路径最终会返回到 __schedule 函数中，这个函数中就是上一个运行的进程和将要投入运行的下一个进程，最后调用 context_switch 函数，完成两个进程的地址空间和机器上下文的切换，一次进程调度工作结束。这个机制和我们的 Cosmos 的 </span></span></span><span data-slate-object="text" data-key="17399"><span data-slate-leaf="true" data-offset-key="17399:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">save_to_new_context 函数</span></span></span></span><span data-slate-object="text" data-key="17400"><span data-slate-leaf="true" data-offset-key="17400:0" data-first-offset="true"><span data-slate-string="true">类似，不再赘述。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17401"><span data-slate-object="text" data-key="17402"><span data-slate-leaf="true" data-offset-key="17402:0" data-first-offset="true"><span data-slate-string="true">至此 CFS 调度器的基本概念与数据结构，还有算法实现，我们就搞清楚了，核心就是</span></span></span><span data-slate-object="text" data-key="17403"><span data-slate-leaf="true" data-offset-key="17403:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">让虚拟时间最小的进程最先运行， 一旦进程运行虚拟时间就会增加，最后尽量保证所有进程的虚拟时间相等，谁小了就要多运行，谁大了就要暂停运行。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17404" id="sr-toc-19"><span data-slate-object="text" data-key="17405"><span data-slate-leaf="true" data-offset-key="17405:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17406"><span data-slate-object="text" data-key="17407"><span data-slate-leaf="true" data-offset-key="17407:0" data-first-offset="true"><span data-slate-string="true">Linux 如何表示一个进程以及如何进行多个进程调度，我们已经搞清楚了。我们来总结一下。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17408"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/bd/50/bd82db725228db2b69cbbceef088a950.jpg?wh=3366x2139"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17409"><span data-slate-object="text" data-key="17410"><span data-slate-leaf="true" data-offset-key="17410:0" data-first-offset="true"><span data-slate-string="true">你可能在想。为什么要用红黑树来组织调度实体？这是因为要维护虚拟时间的顺序，又要从中频繁的删除和插入调度实体，这种情况下红黑树这种结构无疑是非常好，如果你有更好的选择，可以向 Linux 社区提交补丁。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17411" id="sr-toc-20"><span data-slate-object="text" data-key="17412"><span data-slate-leaf="true" data-offset-key="17412:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17413"><span data-slate-object="text" data-key="17414"><span data-slate-leaf="true" data-offset-key="17414:0" data-first-offset="true"><span data-slate-string="true">想一想，Linux 进程的优先级和 Linux 调度类的优先级是一回事儿吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17415"><span data-slate-object="text" data-key="17416"><span data-slate-leaf="true" data-offset-key="17416:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区记录你的学习经验或者个我交流讨论，也欢迎你把这节课转发给需要的朋友。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17417"><span data-slate-object="text" data-key="17418"><span data-slate-leaf="true" data-offset-key="17418:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-21">精选留言 (11)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>一、进程数据结构
每个 CPU 有一个 rq 结构，描述进程运行队列，其中：
A、cfs_rq、rt_rq、dl_rq，分别包含了公平调度、实时调度、最早截至时间调度算法相关的队列
B、记录了当前 CPU 的，正在运行的进程、空转进程、停止进程等；
C、每个进程用一个 task_struct 结构描述；

task_struct 结构包括：
sched_entity 结构，描述调度实体；
files_struct 结构，描述进程打开的文件；
mm_struct 结构，描述一个进程的地址空间的数据结构；其中包括，vm_area_struct 结构，描述一段虚拟地址空间

二、fork 创建一个进程
调用 fork
-&gt;_do_fork
-&gt;-&gt;_do_fork 首先调用复制进程 copy_process
-&gt;-&gt;-&gt; 调用了一系列的 copy 和初始化函数：dup_task_struct、copy_creds、copy_semundo、copy_files、copy_fs、copy_sighand、copy_signal、copy_mm、copy_namespaces、copy_io、copy_thread、copy_seccomp
-&gt;-&gt;_do_fork 然后调用 wake_up_new_task，初始化并准备好第一次启动，进入 runqueue

其中，_do_fork-&gt;copy_process-&gt;dup_task_struct
A、alloc_task_struct_node，分配结构体
alloc_task_struct_node-&gt;kmem_cache_alloc_node-&gt;kmem_cache_alloc-&gt;slab_alloc-&gt; 接上了之前的内容
B、alloc_thread_stack_node，分配内核栈
alloc_thread_stack_node-&gt;alloc_pages_node-&gt;__alloc_pages_node-&gt;__alloc_pages-&gt;__alloc_pages_nodemask-&gt; 接上了之前的内容
C、arch_dup_task_struct 复制 task_struct
D、setup_thread_stack 设置内核栈

其中，_do_fork-&gt;copy_process-&gt;copy_mm-&gt;dup_mm
A、allocate_mm，分配内存
B、memcpy，结构拷贝
C、mm_init，mm 初始化
D、dup_mmap，mmap 拷贝

其中，_do_fork-&gt;copy_files-&gt;dup_fd
kmem_cache_alloc，分配内存
copy_fd_bitmaps，拷贝 fd 位图数据</div><div><p>作者回复：是的 是的 哈哈</p></div><div><div>2021-08-05</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>三、调度器数据结构
sched_class 结构，通过一组函数指针描述了调度器；
__end_sched_classes，优先级最高
stop_sched_class，停止调度类
dl_sched_class，最早截至时间调度类
rt_sched_class，实时调度类
fair_sched_class，公平调度调度类
idle_sched_class，空转调度类
__begin_sched_classes，优先级最低

调度器的优先级，是编译时指定的，通过__begin_sched_classes 和__end_sched_classes 进行定位；

四、CFS 调度
cfs 调度算法，调度队列为 cfs_rq，其整体是一个红黑树，树根记录在 tasks_timeline 中；
cfs 调度器，根据一个进程权重占总体权重的比例，确定每个进程的 CPU 时间分配比例；而这个权重，开放给程序员的是一个 nice 值，数值越小，权重越大；

同时，即不能让进程切换过于频繁，也不能让进程长期饥饿，需要保证调度时间：
当进程数小于 8 个时，进程调度延迟为 6ms，也就是每 6ms 保证每个进程至少运行一次；
当进程数大于 8 个时，进程延迟无法保证，需要确保程序至少运行一段时间才被调度，这个时间称为最小调度粒度时间，默认为 0.75ms；

cfs 中，由于每个进程的权重不同，所以无法单纯的通过进程运行时间来对进程优先级进行排序。所以将进程运行时间，通过权重换算，得到了一个进程运行的虚拟时间，然后通过虚拟时间，来对进程优先级进行排序。此时，红黑树的排序特性就充分发挥了，哪个进程的虚拟时间最小，就会来到红黑树的最左子节点，进行调度时，从左到右进行判断就好了。

这个时间又是如何刷新呢：
Linux 会有一个 scheduler_tick 定时器，给调度器提供机会，刷新 CFS 队列虚拟时间
scheduler_tick-&gt;rq.curr.sched_class.task_tick，对应到 CFS 调度器，就是 task_tick_fair
task_tick_fair-&gt;entity_tick
-&gt;update_curr，更新当前进程调度时间
-&gt;check_preempt_tick，根据实际运行时间、最小调度时间、虚拟时间是否最小等，判断是否要进行调度，如果需要调度则打标记

Linux 进行进程调度时，调用 schedule-&gt;__schedule
-&gt;pick_next_task
A、首先尝试 pick_next_task_fair，获取下一个进程
B、如果获取失败，就按调取器优先级，依次尝试获取下一个进程
C、如果全部获取失败，就返回 idel 进程
-&gt;context_switch，如果获取到了新的进程，进行进程切换

其中，pick_next_task_fair-&gt;pick_next_entity，其实就是按红黑树从左到右尝试反馈优先级最高的进程；
然后，当前进程被切换时，也会更新虚拟时间，会在 CFS 红黑数中比较右侧的地方找到自己的位置，然后一直向左，向左，直到再次被调度。</div><div><p>作者回复：老铁总结到位</p></div><div><div>2021-08-05</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>不是一回事。进程优先级由 nice 值表示，nice 值越好，优先级越小，只会导致该进程占用 CPU 的时间越少，而调度优先级则表示该进程获得调度机会的多寡。

这篇 linux 进程调度文章写的实在是太好了，一篇值回票价！</div><div><p>作者回复：哈哈 是的</p></div><div><div>2021-07-09</div><div><div><i></i></div><div><i></i><span>12</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/d3/08/ffd93029.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 太阳</span></div></div><div>linux 只有进程没有线程吗？那我们在代码创建线程底层如何实现的？全局变量可以多线程共享。</div><div><p>作者回复: Linux 的线程就是共享内存（多个 task_struct 指向 同一个 mm_struct）的进程 </p></div><div><div>2021-09-04</div><div><div><i></i></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 青玉白露</span></div></div><div>这俩可不是一个概念：
进程优先级越高，占用 CPU 时间越长；
调度优先级越高，调度系统选中它的概率就越大。</div><div><p>作者回复：是的 正确 </p></div><div><div>2021-07-09</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/ef/fa/5e9f3dc9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 驰往</span></div></div><div>进程优先级以 cfs 为例，nice 值越低，优先级越高，vruntime 就走的越慢，从而导致实际占用 cpu 的时间越长；调度器类优先级越高，则调度的时候优先选择优先级高的调度器执行该调度算法找下一个要切换的进程，如果没有找到，就遍历下一个的调度算法。第一次留言写这么多字，不知道这样理解对不对。还望指出不对之处～</div><div><p>作者回复：对的对的</p></div><div><div>2021-08-28</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 艾恩凝</span></div></div><div>看的书也没这篇文章讲的好， 老师出一本 linux 相关的书吧</div><div><p>作者回复：哈哈 谢谢夸赞</p></div><div><div>2022-05-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/82/0c/cc106ab1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Samaritan.</span></div></div><div>老师你好，我有关于这么几个关于进程切换的疑问：
一、在 linux 中，task_struct 应该是在进程的内核地址空间中。那么在进程切换的时候，每个进程的 task_struct 对应的物理页面应该都不一样，所以在内核地址空间中，关于 task_struct 的页表项也会被切换对吗？但是很多书上都有一个说法：所有进程的内核地址空间的映射都是一样的，这样存在矛盾吗？
二、每个进程的 task_struct，都是在内核线性映射对应的物理内存中分配对吗？还是可以在物理内存的任何位置？</div><div><p>作者回复: 1. 会切换页表 但是内核地址空间的页表对所有进程都一样的
2. 都是在内核线性映射对应的物理内存中分配</p></div><div><div>2021-12-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/ia5olchDzerJDeAzoY4XZrEOmqhjDJrO6ZfQU8CjWmkxwhtM6fwc16nq7Jpqr4t9ILlDSQjKHcogBpXiaIuW4IIA/132"></div></div><div><div><div><span>一君</span></div></div><div>彭老师，文章中提到 “Linux 是同时支持多个进程调度器的，不同的进程挂载到不同的运行队列中”，那么是由谁决定进程挂载到哪一个运行队列了？</div><div><p>作者回复：调用 fork 函数 的时候 </p></div><div><div>2021-07-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/24/d3/a9/2b84cc97.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Linux C·Core Api</span></div></div><div>彭工，学习了王爽的汇编再学 c 语言基础 能否学习你这门课</div><div><p>作者回复：能的</p></div><div><div>2021-07-10</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>进程的运行时间和调度时间居然是长达微秒级别，我一直以为是比纳秒级更小的时间单位</div><div><p>作者回复：不同的平台下不同的 </p></div><div><div>2021-07-09</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".s"><outline class="toc-level-h1" data-reactid=".s.0" style="width: 175px;"><active data-reactid=".s.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".s.0.1"><span data-reactid=".s.0.1.0">27 | 瞧一瞧 Linux：Linux 如何实现进程与进程调度？</span></a></outline><outline class="toc-level-h2" data-reactid=".s.1" style="width: 165px;"><active data-reactid=".s.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".s.1.1"><span data-reactid=".s.1.1.0">Linux 如何表示进程</span></a></outline><outline class="toc-level-h3" data-reactid=".s.2" style="width: 155px;"><active data-reactid=".s.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".s.2.1"><span data-reactid=".s.2.1.0">Linux 进程的数据结构</span></a></outline><outline class="toc-level-h3" data-reactid=".s.3" style="width: 155px;"><active data-reactid=".s.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".s.3.1"><span data-reactid=".s.3.1.0">创建 task_struct 结构</span></a></outline><outline class="toc-level-h3" data-reactid=".s.4" style="width: 155px;"><active data-reactid=".s.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".s.4.1"><span data-reactid=".s.4.1.0">Linux 进程地址空间</span></a></outline><outline class="toc-level-h3" data-reactid=".s.5" style="width: 155px;"><active data-reactid=".s.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".s.5.1"><span data-reactid=".s.5.1.0">Linux 进程文件表</span></a></outline><outline class="toc-level-h2" data-reactid=".s.6" style="width: 165px;"><active data-reactid=".s.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".s.6.1"><span data-reactid=".s.6.1.0">Linux 进程调度</span></a></outline><outline class="toc-level-h3" data-reactid=".s.7" style="width: 155px;"><active data-reactid=".s.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".s.7.1"><span data-reactid=".s.7.1.0">进程调度实体</span></a></outline><outline class="toc-level-h3" data-reactid=".s.8" style="width: 155px;"><active data-reactid=".s.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".s.8.1"><span data-reactid=".s.8.1.0">进程运行队列</span></a></outline><outline class="toc-level-h3" data-reactid=".s.9" style="width: 155px;"><active data-reactid=".s.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".s.9.1"><span data-reactid=".s.9.1.0">调度实体和运行队列的关系</span></a></outline><outline class="toc-level-h3" data-reactid=".s.a" style="width: 155px;"><active data-reactid=".s.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".s.a.1"><span data-reactid=".s.a.1.0">调度器类</span></a></outline><outline class="toc-level-h2" data-reactid=".s.b" style="width: 165px;"><active data-reactid=".s.b.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".s.b.1"><span data-reactid=".s.b.1.0">Linux 的 CFS 调度器</span></a></outline><outline class="toc-level-h3" data-reactid=".s.c" style="width: 155px;"><active data-reactid=".s.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".s.c.1"><span data-reactid=".s.c.1.0">普通进程的权重</span></a></outline><outline class="toc-level-h3" data-reactid=".s.d" style="width: 155px;"><active data-reactid=".s.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".s.d.1"><span data-reactid=".s.d.1.0">进程调度延迟</span></a></outline><outline class="toc-level-h3" data-reactid=".s.e" style="width: 155px;"><active data-reactid=".s.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".s.e.1"><span data-reactid=".s.e.1.0">虚拟时间</span></a></outline><outline class="toc-level-h2" data-reactid=".s.f" style="width: 165px;"><active data-reactid=".s.f.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".s.f.1"><span data-reactid=".s.f.1.0">CFS 调度进程</span></a></outline><outline class="toc-level-h3" data-reactid=".s.g" style="width: 155px;"><active data-reactid=".s.g.0"></active><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".s.g.1"><span data-reactid=".s.g.1.0">定时周期调度</span></a></outline><outline class="toc-level-h3" data-reactid=".s.h" style="width: 155px;"><active data-reactid=".s.h.0"></active><a class="toc-outline-theme-github" href="#sr-toc-17" data-reactid=".s.h.1"><span data-reactid=".s.h.1.0">调度器入口</span></a></outline><outline class="toc-level-h3" data-reactid=".s.i" style="width: 155px;"><active data-reactid=".s.i.0"></active><a class="toc-outline-theme-github" href="#sr-toc-18" data-reactid=".s.i.1"><span data-reactid=".s.i.1.0">挑选下一个进程</span></a></outline><outline class="toc-level-h2" data-reactid=".s.j" style="width: 165px;"><active data-reactid=".s.j.0"></active><a class="toc-outline-theme-github" href="#sr-toc-19" data-reactid=".s.j.1"><span data-reactid=".s.j.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".s.k" style="width: 165px;"><active data-reactid=".s.k.0"></active><a class="toc-outline-theme-github" href="#sr-toc-20" data-reactid=".s.k.1"><span data-reactid=".s.k.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".s.l" style="width: 165px;"><active data-reactid=".s.l.0"></active><a class="toc-outline-theme-github" href="#sr-toc-21" data-reactid=".s.l.1"><span data-reactid=".s.l.1.0">精选留言 (11)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/393350" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>