
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 26 | 多个活动要安排（下）：如何实现进程的等待与唤醒机制？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>26 | 多个活动要安排（下）：如何实现进程的等待与唤醒机制？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我会带你实现分配和释放内存页面，达到内存管理的目的。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">26 | 多个活动要安排（下）：如何实现进程的等待与唤醒机制？</h1><div><span>LMOS</span> <span>2021-07-07</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/04/64/0407625c3c17458edb245ae24bd61164.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：7.80M</span><span> 时长：08:32</span></div></div><audio title="26 | 多个活动要安排（下）：如何实现进程的等待与唤醒机制？" src="https://res001.geekbang.org/media/audio/7d/e0/7d36e96cd8b1d349110a310932849ce0/ld/ld.m3u8" __idm_id__="950281"></audio></div><div><div><div><div data-slate-editor="true" data-key="13932" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="13933"><span data-slate-object="text" data-key="13934"><span data-slate-leaf="true" data-offset-key="13934:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13935"><span data-slate-object="text" data-key="13936"><span data-slate-leaf="true" data-offset-key="13936:0" data-first-offset="true"><span data-slate-string="true">上节课，我带你一起设计了我们 Cosmos 的进程调度器，但有了进程调度器还不够，因为调度器它始终只是让一个进程让出 CPU，切换到它选择的下一个进程上去运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13937"><span data-slate-object="text" data-key="13938"><span data-slate-leaf="true" data-offset-key="13938:0" data-first-offset="true"><span data-slate-string="true">结合前面我们对进程生命周期的讲解，估计你已经反应过来了。没错，多进程调度方面，我们还要实现进程的等待与唤醒机制，今天我们就来搞定它。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13939"><span data-slate-object="text" data-key="13940"><span data-slate-leaf="true" data-offset-key="13940:0" data-first-offset="true"><span data-slate-string="true">这节课的配套代码，你可以从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13941"><span data-slate-object="text" data-key="13942"><span data-slate-leaf="true" data-offset-key="13942:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="13943"><span data-slate-leaf="true" data-offset-key="13943:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13944" id="sr-toc-1"><span data-slate-object="text" data-key="13945"><span data-slate-leaf="true" data-offset-key="13945:0" data-first-offset="true"><span data-slate-string="true">进程的等待与唤醒</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13946"><span data-slate-object="text" data-key="13947"><span data-slate-leaf="true" data-offset-key="13947:0" data-first-offset="true"><span data-slate-string="true">我们已经知道，进程得不到所需的某个资源时就会进入等待状态，直到这种资源可用时，才会被唤醒。那么进程的等待与唤醒机制到底应该这样设计呢，请听我慢慢为你梳理。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13948" id="sr-toc-2"><span data-slate-object="text" data-key="13949"><span data-slate-leaf="true" data-offset-key="13949:0" data-first-offset="true"><span data-slate-string="true">进程等待结构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13950"><span data-slate-object="text" data-key="13951"><span data-slate-leaf="true" data-offset-key="13951:0" data-first-offset="true"><span data-slate-string="true">很显然，在实现进程的等待与唤醒的机制之前，我们需要设计一种数据结构，用于挂载等待的进程，在唤醒的时候才可以找到那些等待的进程 ，这段代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13952"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13953"><span data-slate-object="text" data-key="13954"><span data-slate-leaf="true" data-offset-key="13954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="13955"><span data-slate-leaf="true" data-offset-key="13955:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13956"><span data-slate-leaf="true" data-offset-key="13956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="13957"><span data-slate-leaf="true" data-offset-key="13957:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13958"><span data-slate-leaf="true" data-offset-key="13958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_KWLST</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13959"><span data-slate-object="text" data-key="13960"><span data-slate-leaf="true" data-offset-key="13960:0" data-first-offset="true"><span data-slate-string="true">{   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13961"><span data-slate-object="text" data-key="13962"><span data-slate-leaf="true" data-offset-key="13962:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13963"><span data-slate-leaf="true" data-offset-key="13963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="13964"><span data-slate-leaf="true" data-offset-key="13964:0" data-first-offset="true"><span data-slate-string="true"> wl_lock;  </span></span></span><span data-slate-object="text" data-key="13965"><span data-slate-leaf="true" data-offset-key="13965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13966"><span data-slate-object="text" data-key="13967"><span data-slate-leaf="true" data-offset-key="13967:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13968"><span data-slate-leaf="true" data-offset-key="13968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="13969"><span data-slate-leaf="true" data-offset-key="13969:0" data-first-offset="true"><span data-slate-string="true">   wl_tdnr;    </span></span></span><span data-slate-object="text" data-key="13970"><span data-slate-leaf="true" data-offset-key="13970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待进程的个数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13971"><span data-slate-object="text" data-key="13972"><span data-slate-leaf="true" data-offset-key="13972:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13973"><span data-slate-leaf="true" data-offset-key="13973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="13974"><span data-slate-leaf="true" data-offset-key="13974:0" data-first-offset="true"><span data-slate-string="true"> wl_list;    </span></span></span><span data-slate-object="text" data-key="13975"><span data-slate-leaf="true" data-offset-key="13975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 挂载等待进程的链表头</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13976"><span data-slate-object="text" data-key="13977"><span data-slate-leaf="true" data-offset-key="13977:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="13978"><span data-slate-leaf="true" data-offset-key="13978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kwlst_t</span></span></span></span><span data-slate-object="text" data-key="13979"><span data-slate-leaf="true" data-offset-key="13979:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13980"><span data-slate-object="text" data-key="13981"><span data-slate-leaf="true" data-offset-key="13981:0" data-first-offset="true"><span data-slate-string="true">其实，这个结构在前面讲</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13982"><span data-slate-object="text" data-key="13983"><span data-slate-leaf="true" data-offset-key="13983:0" data-first-offset="true"><span data-slate-string="true">信号量</span></span></span></a><span data-slate-object="text" data-key="13984"><span data-slate-leaf="true" data-offset-key="13984:0" data-first-offset="true"><span data-slate-string="true">的时候，我们已经见过了。这是因为它经常被包含在信号量等上层数据结构中，而信号量结构，通常用于保护访问受限的共享资源。这个结构非常简单，我们不用多说。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13985" id="sr-toc-3"><span data-slate-object="text" data-key="13986"><span data-slate-leaf="true" data-offset-key="13986:0" data-first-offset="true"><span data-slate-string="true">进程等待</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13987"><span data-slate-object="text" data-key="13988"><span data-slate-leaf="true" data-offset-key="13988:0" data-first-offset="true"><span data-slate-string="true">现在我们来实现让进程进入等待状态的机制，它也是一个函数。这个函数会设置进程状态为等待状态，让进程从调度系统数据结构中脱离，最后让进程加入到 kwlst_t 等待结构中，代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="13989"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13990"><span data-slate-object="text" data-key="13991"><span data-slate-leaf="true" data-offset-key="13991:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="13992"><span data-slate-leaf="true" data-offset-key="13992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_wait</span></span></span></span><span data-slate-object="text" data-key="13993"><span data-slate-leaf="true" data-offset-key="13993:0" data-first-offset="true"><span data-slate-string="true">(kwlst_t *wlst)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13994"><span data-slate-object="text" data-key="13995"><span data-slate-leaf="true" data-offset-key="13995:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13996"><span data-slate-object="text" data-key="13997"><span data-slate-leaf="true" data-offset-key="13997:0" data-first-offset="true"><span data-slate-string="true">    cpuflg_t cufg, tcufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13998"><span data-slate-object="text" data-key="13999"><span data-slate-leaf="true" data-offset-key="13999:0" data-first-offset="true"><span data-slate-string="true">    uint_t cpuid = </span></span></span><span data-slate-object="text" data-key="14000"><span data-slate-leaf="true" data-offset-key="14000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="14001"><span data-slate-leaf="true" data-offset-key="14001:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14002"><span data-slate-object="text" data-key="14003"><span data-slate-leaf="true" data-offset-key="14003:0" data-first-offset="true"><span data-slate-string="true">    schdata_t *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14004"><span data-slate-object="text" data-key="14005"><span data-slate-leaf="true" data-offset-key="14005:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14006"><span data-slate-leaf="true" data-offset-key="14006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前正在运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14007"><span data-slate-object="text" data-key="14008"><span data-slate-leaf="true" data-offset-key="14008:0" data-first-offset="true"><span data-slate-string="true">    thread_t *tdp = </span></span></span><span data-slate-object="text" data-key="14009"><span data-slate-leaf="true" data-offset-key="14009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_retn_currthread</span></span></span></span><span data-slate-object="text" data-key="14010"><span data-slate-leaf="true" data-offset-key="14010:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14011"><span data-slate-object="text" data-key="14012"><span data-slate-leaf="true" data-offset-key="14012:0" data-first-offset="true"><span data-slate-string="true">    uint_t pity = tdp</span></span></span><span data-slate-object="text" data-key="14013"><span data-slate-leaf="true" data-offset-key="14013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14014"><span data-slate-leaf="true" data-offset-key="14014:0" data-first-offset="true"><span data-slate-string="true">td_priority;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14015"><span data-slate-object="text" data-key="14016"><span data-slate-leaf="true" data-offset-key="14016:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14017"><span data-slate-leaf="true" data-offset-key="14017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="14018"><span data-slate-leaf="true" data-offset-key="14018:0" data-first-offset="true"><span data-slate-string="true">(&amp;schdap</span></span></span><span data-slate-object="text" data-key="14019"><span data-slate-leaf="true" data-offset-key="14019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14020"><span data-slate-leaf="true" data-offset-key="14020:0" data-first-offset="true"><span data-slate-string="true">sda_lock, &amp;cufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14021"><span data-slate-object="text" data-key="14022"><span data-slate-leaf="true" data-offset-key="14022:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14023"><span data-slate-leaf="true" data-offset-key="14023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="14024"><span data-slate-leaf="true" data-offset-key="14024:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdp</span></span></span><span data-slate-object="text" data-key="14025"><span data-slate-leaf="true" data-offset-key="14025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14026"><span data-slate-leaf="true" data-offset-key="14026:0" data-first-offset="true"><span data-slate-string="true">td_lock, &amp;tcufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14027"><span data-slate-object="text" data-key="14028"><span data-slate-leaf="true" data-offset-key="14028:0" data-first-offset="true"><span data-slate-string="true">    tdp</span></span></span><span data-slate-object="text" data-key="14029"><span data-slate-leaf="true" data-offset-key="14029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14030"><span data-slate-leaf="true" data-offset-key="14030:0" data-first-offset="true"><span data-slate-string="true">td_stus = TDSTUS_WAIT;</span></span></span><span data-slate-object="text" data-key="14031"><span data-slate-leaf="true" data-offset-key="14031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程状态为等待状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14032"><span data-slate-object="text" data-key="14033"><span data-slate-leaf="true" data-offset-key="14033:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14034"><span data-slate-leaf="true" data-offset-key="14034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_del</span></span></span></span><span data-slate-object="text" data-key="14035"><span data-slate-leaf="true" data-offset-key="14035:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdp</span></span></span><span data-slate-object="text" data-key="14036"><span data-slate-leaf="true" data-offset-key="14036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14037"><span data-slate-leaf="true" data-offset-key="14037:0" data-first-offset="true"><span data-slate-string="true">td_list);</span></span></span><span data-slate-object="text" data-key="14038"><span data-slate-leaf="true" data-offset-key="14038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 脱链</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14039"><span data-slate-object="text" data-key="14040"><span data-slate-leaf="true" data-offset-key="14040:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14041"><span data-slate-leaf="true" data-offset-key="14041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="14042"><span data-slate-leaf="true" data-offset-key="14042:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdp</span></span></span><span data-slate-object="text" data-key="14043"><span data-slate-leaf="true" data-offset-key="14043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14044"><span data-slate-leaf="true" data-offset-key="14044:0" data-first-offset="true"><span data-slate-string="true">td_lock, &amp;tcufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14045"><span data-slate-object="text" data-key="14046"><span data-slate-leaf="true" data-offset-key="14046:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14047"><span data-slate-leaf="true" data-offset-key="14047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14048"><span data-slate-leaf="true" data-offset-key="14048:0" data-first-offset="true"><span data-slate-string="true"> (schdap</span></span></span><span data-slate-object="text" data-key="14049"><span data-slate-leaf="true" data-offset-key="14049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14050"><span data-slate-leaf="true" data-offset-key="14050:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd == tdp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14051"><span data-slate-object="text" data-key="14052"><span data-slate-leaf="true" data-offset-key="14052:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14053"><span data-slate-object="text" data-key="14054"><span data-slate-leaf="true" data-offset-key="14054:0" data-first-offset="true"><span data-slate-string="true">        schdap</span></span></span><span data-slate-object="text" data-key="14055"><span data-slate-leaf="true" data-offset-key="14055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14056"><span data-slate-leaf="true" data-offset-key="14056:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd = NULL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14057"><span data-slate-object="text" data-key="14058"><span data-slate-leaf="true" data-offset-key="14058:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14059"><span data-slate-object="text" data-key="14060"><span data-slate-leaf="true" data-offset-key="14060:0" data-first-offset="true"><span data-slate-string="true">    schdap</span></span></span><span data-slate-object="text" data-key="14061"><span data-slate-leaf="true" data-offset-key="14061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14062"><span data-slate-leaf="true" data-offset-key="14062:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_nr--;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14063"><span data-slate-object="text" data-key="14064"><span data-slate-leaf="true" data-offset-key="14064:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14065"><span data-slate-leaf="true" data-offset-key="14065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="14066"><span data-slate-leaf="true" data-offset-key="14066:0" data-first-offset="true"><span data-slate-string="true">(&amp;schdap</span></span></span><span data-slate-object="text" data-key="14067"><span data-slate-leaf="true" data-offset-key="14067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14068"><span data-slate-leaf="true" data-offset-key="14068:0" data-first-offset="true"><span data-slate-string="true">sda_lock, &amp;cufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14069"><span data-slate-object="text" data-key="14070"><span data-slate-leaf="true" data-offset-key="14070:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14071"><span data-slate-leaf="true" data-offset-key="14071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlwlst_add_thread</span></span></span></span><span data-slate-object="text" data-key="14072"><span data-slate-leaf="true" data-offset-key="14072:0" data-first-offset="true"><span data-slate-string="true">(wlst, tdp);</span></span></span><span data-slate-object="text" data-key="14073"><span data-slate-leaf="true" data-offset-key="14073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将进程加入等待结构中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14074"><span data-slate-object="text" data-key="14075"><span data-slate-leaf="true" data-offset-key="14075:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14076"><span data-slate-leaf="true" data-offset-key="14076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14077"><span data-slate-leaf="true" data-offset-key="14077:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14078"><span data-slate-object="text" data-key="14079"><span data-slate-leaf="true" data-offset-key="14079:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14080"><span data-slate-object="text" data-key="14081"><span data-slate-leaf="true" data-offset-key="14081:0" data-first-offset="true"><span data-slate-string="true">上述代码也不难，你结合注释就能理解。有一点需要注意，这个函数使进程进入等待状态，而这个</span></span></span><span data-slate-object="text" data-key="14082"><span data-slate-leaf="true" data-offset-key="14082:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">进程是当前正在运行的进程，而当前正在运行的进程正是调用这个函数的进程</span></span></span></span><span data-slate-object="text" data-key="14083"><span data-slate-leaf="true" data-offset-key="14083:0" data-first-offset="true"><span data-slate-string="true">，所以一个进程想要进入等待状态，只要调用这个函数就好了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14084" id="sr-toc-4"><span data-slate-object="text" data-key="14085"><span data-slate-leaf="true" data-offset-key="14085:0" data-first-offset="true"><span data-slate-string="true">进程唤醒</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14086"><span data-slate-object="text" data-key="14087"><span data-slate-leaf="true" data-offset-key="14087:0" data-first-offset="true"><span data-slate-string="true">进程的唤醒则是进程等待的反向操作行为，即从等待数据结构中获取进程，然后设置进程的状态为运行状态，最后将这个进程加入到进程调度系统数据结构中。这个函数的代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="14088"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14089"><span data-slate-object="text" data-key="14090"><span data-slate-leaf="true" data-offset-key="14090:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="14091"><span data-slate-leaf="true" data-offset-key="14091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_up</span></span></span></span><span data-slate-object="text" data-key="14092"><span data-slate-leaf="true" data-offset-key="14092:0" data-first-offset="true"><span data-slate-string="true">(kwlst_t *wlst)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14093"><span data-slate-object="text" data-key="14094"><span data-slate-leaf="true" data-offset-key="14094:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14095"><span data-slate-object="text" data-key="14096"><span data-slate-leaf="true" data-offset-key="14096:0" data-first-offset="true"><span data-slate-string="true">    cpuflg_t cufg, tcufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14097"><span data-slate-object="text" data-key="14098"><span data-slate-leaf="true" data-offset-key="14098:0" data-first-offset="true"><span data-slate-string="true">    uint_t cpuid = </span></span></span><span data-slate-object="text" data-key="14099"><span data-slate-leaf="true" data-offset-key="14099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="14100"><span data-slate-leaf="true" data-offset-key="14100:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14101"><span data-slate-object="text" data-key="14102"><span data-slate-leaf="true" data-offset-key="14102:0" data-first-offset="true"><span data-slate-string="true">    schdata_t *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14103"><span data-slate-object="text" data-key="14104"><span data-slate-leaf="true" data-offset-key="14104:0" data-first-offset="true"><span data-slate-string="true">    thread_t *tdp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14105"><span data-slate-object="text" data-key="14106"><span data-slate-leaf="true" data-offset-key="14106:0" data-first-offset="true"><span data-slate-string="true">    uint_t pity;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14107"><span data-slate-object="text" data-key="14108"><span data-slate-leaf="true" data-offset-key="14108:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14109"><span data-slate-leaf="true" data-offset-key="14109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取出等待数据结构第一个进程并从等待数据结构中删除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14110"><span data-slate-object="text" data-key="14111"><span data-slate-leaf="true" data-offset-key="14111:0" data-first-offset="true"><span data-slate-string="true">    tdp = </span></span></span><span data-slate-object="text" data-key="14112"><span data-slate-leaf="true" data-offset-key="14112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlwlst_del_thread</span></span></span></span><span data-slate-object="text" data-key="14113"><span data-slate-leaf="true" data-offset-key="14113:0" data-first-offset="true"><span data-slate-string="true">(wlst);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14114"><span data-slate-object="text" data-key="14115"><span data-slate-leaf="true" data-offset-key="14115:0" data-first-offset="true"><span data-slate-string="true">    pity = tdp</span></span></span><span data-slate-object="text" data-key="14116"><span data-slate-leaf="true" data-offset-key="14116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14117"><span data-slate-leaf="true" data-offset-key="14117:0" data-first-offset="true"><span data-slate-string="true">td_priority;</span></span></span><span data-slate-object="text" data-key="14118"><span data-slate-leaf="true" data-offset-key="14118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取进程的优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14119"><span data-slate-object="text" data-key="14120"><span data-slate-leaf="true" data-offset-key="14120:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14121"><span data-slate-leaf="true" data-offset-key="14121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="14122"><span data-slate-leaf="true" data-offset-key="14122:0" data-first-offset="true"><span data-slate-string="true">(&amp;schdap</span></span></span><span data-slate-object="text" data-key="14123"><span data-slate-leaf="true" data-offset-key="14123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14124"><span data-slate-leaf="true" data-offset-key="14124:0" data-first-offset="true"><span data-slate-string="true">sda_lock, &amp;cufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14125"><span data-slate-object="text" data-key="14126"><span data-slate-leaf="true" data-offset-key="14126:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14127"><span data-slate-leaf="true" data-offset-key="14127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="14128"><span data-slate-leaf="true" data-offset-key="14128:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdp</span></span></span><span data-slate-object="text" data-key="14129"><span data-slate-leaf="true" data-offset-key="14129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14130"><span data-slate-leaf="true" data-offset-key="14130:0" data-first-offset="true"><span data-slate-string="true">td_lock, &amp;tcufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14131"><span data-slate-object="text" data-key="14132"><span data-slate-leaf="true" data-offset-key="14132:0" data-first-offset="true"><span data-slate-string="true">    tdp</span></span></span><span data-slate-object="text" data-key="14133"><span data-slate-leaf="true" data-offset-key="14133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14134"><span data-slate-leaf="true" data-offset-key="14134:0" data-first-offset="true"><span data-slate-string="true">td_stus = TDSTUS_RUN;</span></span></span><span data-slate-object="text" data-key="14135"><span data-slate-leaf="true" data-offset-key="14135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程的状态为运行状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14136"><span data-slate-object="text" data-key="14137"><span data-slate-leaf="true" data-offset-key="14137:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14138"><span data-slate-leaf="true" data-offset-key="14138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="14139"><span data-slate-leaf="true" data-offset-key="14139:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdp</span></span></span><span data-slate-object="text" data-key="14140"><span data-slate-leaf="true" data-offset-key="14140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14141"><span data-slate-leaf="true" data-offset-key="14141:0" data-first-offset="true"><span data-slate-string="true">td_lock, &amp;tcufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14142"><span data-slate-object="text" data-key="14143"><span data-slate-leaf="true" data-offset-key="14143:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14144"><span data-slate-leaf="true" data-offset-key="14144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add_tail</span></span></span></span><span data-slate-object="text" data-key="14145"><span data-slate-leaf="true" data-offset-key="14145:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdp</span></span></span><span data-slate-object="text" data-key="14146"><span data-slate-leaf="true" data-offset-key="14146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14147"><span data-slate-leaf="true" data-offset-key="14147:0" data-first-offset="true"><span data-slate-string="true">td_list, &amp;(schdap</span></span></span><span data-slate-object="text" data-key="14148"><span data-slate-leaf="true" data-offset-key="14148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14149"><span data-slate-leaf="true" data-offset-key="14149:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_lsth));</span></span></span><span data-slate-object="text" data-key="14150"><span data-slate-leaf="true" data-offset-key="14150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入进程优先级链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14151"><span data-slate-object="text" data-key="14152"><span data-slate-leaf="true" data-offset-key="14152:0" data-first-offset="true"><span data-slate-string="true">    schdap</span></span></span><span data-slate-object="text" data-key="14153"><span data-slate-leaf="true" data-offset-key="14153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14154"><span data-slate-leaf="true" data-offset-key="14154:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_nr++;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14155"><span data-slate-object="text" data-key="14156"><span data-slate-leaf="true" data-offset-key="14156:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14157"><span data-slate-leaf="true" data-offset-key="14157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="14158"><span data-slate-leaf="true" data-offset-key="14158:0" data-first-offset="true"><span data-slate-string="true">(&amp;schdap</span></span></span><span data-slate-object="text" data-key="14159"><span data-slate-leaf="true" data-offset-key="14159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14160"><span data-slate-leaf="true" data-offset-key="14160:0" data-first-offset="true"><span data-slate-string="true">sda_lock, &amp;cufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14161"><span data-slate-object="text" data-key="14162"><span data-slate-leaf="true" data-offset-key="14162:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14163"><span data-slate-leaf="true" data-offset-key="14163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14164"><span data-slate-leaf="true" data-offset-key="14164:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14165"><span data-slate-object="text" data-key="14166"><span data-slate-leaf="true" data-offset-key="14166:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14167"><span data-slate-object="text" data-key="14168"><span data-slate-leaf="true" data-offset-key="14168:0" data-first-offset="true"><span data-slate-string="true">上面的代码相对简单，我想以你的能力，还能写出比以上更好的代码。好了，到这里，我们进程的等待与唤醒的机制已经实现了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14169" id="sr-toc-5"><span data-slate-object="text" data-key="14170"><span data-slate-leaf="true" data-offset-key="14170:0" data-first-offset="true"><span data-slate-string="true">空转进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14171"><span data-slate-object="text" data-key="14172"><span data-slate-leaf="true" data-offset-key="14172:0" data-first-offset="true"><span data-slate-string="true">下面我们一起来建立空转进程 ，它也是我们系统下的第一个进程。空转进程是操作系统在没任何进程可以调度运行的时候，就选择调度空转进程来运行，可以说</span></span></span><span data-slate-object="text" data-key="14173"><span data-slate-leaf="true" data-offset-key="14173:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">空转进程是进程调度器最后的选择。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14174"><span data-slate-object="text" data-key="14175"><span data-slate-leaf="true" data-offset-key="14175:0" data-first-offset="true"><span data-slate-string="true">请注意，这个最后的选择一定要有，现在几乎所有的操作系统，都有一个或者几个空转进程（多 CPU 的情况下，每个 CPU 一个空转进程）。我们的 Cosmos 虽然是简单了些，但也必须要有空转进程，而且这是我们 Cosmos 上的第一个进程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14176" id="sr-toc-6"><span data-slate-object="text" data-key="14177"><span data-slate-leaf="true" data-offset-key="14177:0" data-first-offset="true"><span data-slate-string="true">建立空转进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14178"><span data-slate-object="text" data-key="14179"><span data-slate-leaf="true" data-offset-key="14179:0" data-first-offset="true"><span data-slate-string="true">我们 Cosmos 的空转进程是个内核进程，按照常理，我们只要调用上节课实现的建立进程的接口，创建一个内核进程就好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14180"><span data-slate-object="text" data-key="14181"><span data-slate-leaf="true" data-offset-key="14181:0" data-first-offset="true"><span data-slate-string="true">但是我们的空转进程有点特殊，它是内核进程没错，但它不加入调度系统，而是一个专用的指针指向它的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14182"><span data-slate-object="text" data-key="14183"><span data-slate-leaf="true" data-offset-key="14183:0" data-first-offset="true"><span data-slate-string="true">下面我们来建立一个空转进程。由于空转进程是个独立的模块，我们建立一个新的 C 语言文件 Cosmos/kernel/krlcpuidle.c，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="14184"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14185"><span data-slate-object="text" data-key="14186"><span data-slate-leaf="true" data-offset-key="14186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="14187"><span data-slate-leaf="true" data-offset-key="14187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="14188"><span data-slate-leaf="true" data-offset-key="14188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_cpuidle_thread</span></span></span></span></span><span data-slate-object="text" data-key="14189"><span data-slate-leaf="true" data-offset-key="14189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14190"><span data-slate-object="text" data-key="14191"><span data-slate-leaf="true" data-offset-key="14191:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14192"></div><div data-slate-type="code-line" data-slate-object="block" data-key="14193"><span data-slate-object="text" data-key="14194"><span data-slate-leaf="true" data-offset-key="14194:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14195"><span data-slate-leaf="true" data-offset-key="14195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="14196"><span data-slate-leaf="true" data-offset-key="14196:0" data-first-offset="true"><span data-slate-string="true"> *ret_td = </span></span></span><span data-slate-object="text" data-key="14197"><span data-slate-leaf="true" data-offset-key="14197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14198"><span data-slate-leaf="true" data-offset-key="14198:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14199"><span data-slate-object="text" data-key="14200"><span data-slate-leaf="true" data-offset-key="14200:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14201"><span data-slate-leaf="true" data-offset-key="14201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool_t</span></span></span></span><span data-slate-object="text" data-key="14202"><span data-slate-leaf="true" data-offset-key="14202:0" data-first-offset="true"><span data-slate-string="true"> acs = FALSE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14203"><span data-slate-object="text" data-key="14204"><span data-slate-leaf="true" data-offset-key="14204:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14205"><span data-slate-leaf="true" data-offset-key="14205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="14206"><span data-slate-leaf="true" data-offset-key="14206:0" data-first-offset="true"><span data-slate-string="true"> krlstkadr = </span></span></span><span data-slate-object="text" data-key="14207"><span data-slate-leaf="true" data-offset-key="14207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14208"><span data-slate-leaf="true" data-offset-key="14208:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14209"><span data-slate-object="text" data-key="14210"><span data-slate-leaf="true" data-offset-key="14210:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14211"><span data-slate-leaf="true" data-offset-key="14211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="14212"><span data-slate-leaf="true" data-offset-key="14212:0" data-first-offset="true"><span data-slate-string="true"> cpuid = </span></span></span><span data-slate-object="text" data-key="14213"><span data-slate-leaf="true" data-offset-key="14213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="14214"><span data-slate-leaf="true" data-offset-key="14214:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14215"><span data-slate-object="text" data-key="14216"><span data-slate-leaf="true" data-offset-key="14216:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14217"><span data-slate-leaf="true" data-offset-key="14217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t</span></span></span></span><span data-slate-object="text" data-key="14218"><span data-slate-leaf="true" data-offset-key="14218:0" data-first-offset="true"><span data-slate-string="true"> *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14219"><span data-slate-object="text" data-key="14220"><span data-slate-leaf="true" data-offset-key="14220:0" data-first-offset="true"><span data-slate-string="true">    krlstkadr = </span></span></span><span data-slate-object="text" data-key="14221"><span data-slate-leaf="true" data-offset-key="14221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="14222"><span data-slate-leaf="true" data-offset-key="14222:0" data-first-offset="true"><span data-slate-string="true">(DAFT_TDKRLSTKSZ);</span></span></span><span data-slate-object="text" data-key="14223"><span data-slate-leaf="true" data-offset-key="14223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配进程的内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14224"><span data-slate-object="text" data-key="14225"><span data-slate-leaf="true" data-offset-key="14225:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14226"><span data-slate-leaf="true" data-offset-key="14226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14227"><span data-slate-leaf="true" data-offset-key="14227:0" data-first-offset="true"><span data-slate-string="true"> (krlstkadr == </span></span></span><span data-slate-object="text" data-key="14228"><span data-slate-leaf="true" data-offset-key="14228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14229"><span data-slate-leaf="true" data-offset-key="14229:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14230"><span data-slate-object="text" data-key="14231"><span data-slate-leaf="true" data-offset-key="14231:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14232"><span data-slate-object="text" data-key="14233"><span data-slate-leaf="true" data-offset-key="14233:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14234"><span data-slate-leaf="true" data-offset-key="14234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14235"><span data-slate-leaf="true" data-offset-key="14235:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14236"><span data-slate-leaf="true" data-offset-key="14236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14237"><span data-slate-leaf="true" data-offset-key="14237:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14238"><span data-slate-object="text" data-key="14239"><span data-slate-leaf="true" data-offset-key="14239:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14240"><span data-slate-object="text" data-key="14241"><span data-slate-leaf="true" data-offset-key="14241:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14242"><span data-slate-leaf="true" data-offset-key="14242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 thread_t 结构体变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14243"><span data-slate-object="text" data-key="14244"><span data-slate-leaf="true" data-offset-key="14244:0" data-first-offset="true"><span data-slate-string="true">    ret_td = </span></span></span><span data-slate-object="text" data-key="14245"><span data-slate-leaf="true" data-offset-key="14245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_thread_dsc</span></span></span></span><span data-slate-object="text" data-key="14246"><span data-slate-leaf="true" data-offset-key="14246:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14247"><span data-slate-object="text" data-key="14248"><span data-slate-leaf="true" data-offset-key="14248:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14249"><span data-slate-leaf="true" data-offset-key="14249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14250"><span data-slate-leaf="true" data-offset-key="14250:0" data-first-offset="true"><span data-slate-string="true"> (ret_td == </span></span></span><span data-slate-object="text" data-key="14251"><span data-slate-leaf="true" data-offset-key="14251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14252"><span data-slate-leaf="true" data-offset-key="14252:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14253"><span data-slate-object="text" data-key="14254"><span data-slate-leaf="true" data-offset-key="14254:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14255"><span data-slate-object="text" data-key="14256"><span data-slate-leaf="true" data-offset-key="14256:0" data-first-offset="true"><span data-slate-string="true">        acs = </span></span></span><span data-slate-object="text" data-key="14257"><span data-slate-leaf="true" data-offset-key="14257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="14258"><span data-slate-leaf="true" data-offset-key="14258:0" data-first-offset="true"><span data-slate-string="true">(krlstkadr, DAFT_TDKRLSTKSZ);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14259"><span data-slate-object="text" data-key="14260"><span data-slate-leaf="true" data-offset-key="14260:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14261"><span data-slate-leaf="true" data-offset-key="14261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14262"><span data-slate-leaf="true" data-offset-key="14262:0" data-first-offset="true"><span data-slate-string="true"> (acs == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14263"><span data-slate-object="text" data-key="14264"><span data-slate-leaf="true" data-offset-key="14264:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14265"><span data-slate-object="text" data-key="14266"><span data-slate-leaf="true" data-offset-key="14266:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="14267"><span data-slate-leaf="true" data-offset-key="14267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14268"><span data-slate-leaf="true" data-offset-key="14268:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14269"><span data-slate-leaf="true" data-offset-key="14269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14270"><span data-slate-leaf="true" data-offset-key="14270:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14271"><span data-slate-object="text" data-key="14272"><span data-slate-leaf="true" data-offset-key="14272:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14273"><span data-slate-object="text" data-key="14274"><span data-slate-leaf="true" data-offset-key="14274:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14275"><span data-slate-leaf="true" data-offset-key="14275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14276"><span data-slate-leaf="true" data-offset-key="14276:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14277"><span data-slate-leaf="true" data-offset-key="14277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14278"><span data-slate-leaf="true" data-offset-key="14278:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14279"><span data-slate-object="text" data-key="14280"><span data-slate-leaf="true" data-offset-key="14280:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14281"><span data-slate-object="text" data-key="14282"><span data-slate-leaf="true" data-offset-key="14282:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14283"><span data-slate-leaf="true" data-offset-key="14283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程具有系统权限</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14284"><span data-slate-object="text" data-key="14285"><span data-slate-leaf="true" data-offset-key="14285:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_privilege = PRILG_SYS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14286"><span data-slate-object="text" data-key="14287"><span data-slate-leaf="true" data-offset-key="14287:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_priority = PRITY_MIN;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14288"><span data-slate-object="text" data-key="14289"><span data-slate-leaf="true" data-offset-key="14289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14290"><span data-slate-leaf="true" data-offset-key="14290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程的内核栈顶和内核栈开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14291"><span data-slate-object="text" data-key="14292"><span data-slate-leaf="true" data-offset-key="14292:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_krlstktop = krlstkadr + (</span></span></span><span data-slate-object="text" data-key="14293"><span data-slate-leaf="true" data-offset-key="14293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="14294"><span data-slate-leaf="true" data-offset-key="14294:0" data-first-offset="true"><span data-slate-string="true">)(DAFT_TDKRLSTKSZ - </span></span></span><span data-slate-object="text" data-key="14295"><span data-slate-leaf="true" data-offset-key="14295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="14296"><span data-slate-leaf="true" data-offset-key="14296:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14297"><span data-slate-object="text" data-key="14298"><span data-slate-leaf="true" data-offset-key="14298:0" data-first-offset="true"><span data-slate-string="true">    ret_td-&gt;td_krlstkstart = krlstkadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14299"><span data-slate-object="text" data-key="14300"><span data-slate-leaf="true" data-offset-key="14300:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14301"><span data-slate-leaf="true" data-offset-key="14301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化进程的内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14302"><span data-slate-object="text" data-key="14303"><span data-slate-leaf="true" data-offset-key="14303:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14304"><span data-slate-leaf="true" data-offset-key="14304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlthread_kernstack_init</span></span></span></span><span data-slate-object="text" data-key="14305"><span data-slate-leaf="true" data-offset-key="14305:0" data-first-offset="true"><span data-slate-string="true">(ret_td, (</span></span></span><span data-slate-object="text" data-key="14306"><span data-slate-leaf="true" data-offset-key="14306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14307"><span data-slate-leaf="true" data-offset-key="14307:0" data-first-offset="true"><span data-slate-string="true"> *)krlcpuidle_main, KMOD_EFLAGS);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14308"><span data-slate-object="text" data-key="14309"><span data-slate-leaf="true" data-offset-key="14309:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14310"><span data-slate-leaf="true" data-offset-key="14310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置调度系统数据结构的空转进程和当前进程为 ret_td</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14311"><span data-slate-object="text" data-key="14312"><span data-slate-leaf="true" data-offset-key="14312:0" data-first-offset="true"><span data-slate-string="true">    schdap-&gt;sda_cpuidle = ret_td;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14313"><span data-slate-object="text" data-key="14314"><span data-slate-leaf="true" data-offset-key="14314:0" data-first-offset="true"><span data-slate-string="true">    schdap-&gt;sda_currtd = ret_td;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14315"><span data-slate-object="text" data-key="14316"><span data-slate-leaf="true" data-offset-key="14316:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14317"><span data-slate-leaf="true" data-offset-key="14317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14318"><span data-slate-leaf="true" data-offset-key="14318:0" data-first-offset="true"><span data-slate-string="true"> ret_td;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14319"><span data-slate-object="text" data-key="14320"><span data-slate-leaf="true" data-offset-key="14320:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14321"><span data-slate-object="text" data-key="14322"><span data-slate-leaf="true" data-offset-key="14322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 新建空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14323"><span data-slate-object="text" data-key="14324"><span data-slate-leaf="true" data-offset-key="14324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="14325"><span data-slate-leaf="true" data-offset-key="14325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="14326"><span data-slate-leaf="true" data-offset-key="14326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_cpuidle</span></span></span></span></span><span data-slate-object="text" data-key="14327"><span data-slate-leaf="true" data-offset-key="14327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14328"><span data-slate-object="text" data-key="14329"><span data-slate-leaf="true" data-offset-key="14329:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14330"><span data-slate-object="text" data-key="14331"><span data-slate-leaf="true" data-offset-key="14331:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14332"><span data-slate-leaf="true" data-offset-key="14332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="14333"><span data-slate-leaf="true" data-offset-key="14333:0" data-first-offset="true"><span data-slate-string="true"> *thp = </span></span></span><span data-slate-object="text" data-key="14334"><span data-slate-leaf="true" data-offset-key="14334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_cpuidle_thread</span></span></span></span><span data-slate-object="text" data-key="14335"><span data-slate-leaf="true" data-offset-key="14335:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="14336"><span data-slate-leaf="true" data-offset-key="14336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14337"><span data-slate-object="text" data-key="14338"><span data-slate-leaf="true" data-offset-key="14338:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14339"><span data-slate-leaf="true" data-offset-key="14339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14340"><span data-slate-leaf="true" data-offset-key="14340:0" data-first-offset="true"><span data-slate-string="true"> (thp == </span></span></span><span data-slate-object="text" data-key="14341"><span data-slate-leaf="true" data-offset-key="14341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="14342"><span data-slate-leaf="true" data-offset-key="14342:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14343"><span data-slate-object="text" data-key="14344"><span data-slate-leaf="true" data-offset-key="14344:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="14345"><span data-slate-leaf="true" data-offset-key="14345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 失败则主动死机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14346"><span data-slate-object="text" data-key="14347"><span data-slate-leaf="true" data-offset-key="14347:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14348"><span data-slate-leaf="true" data-offset-key="14348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_sysdie</span></span></span></span><span data-slate-object="text" data-key="14349"><span data-slate-leaf="true" data-offset-key="14349:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14350"><span data-slate-leaf="true" data-offset-key="14350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"newcpuilde err"</span></span></span></span><span data-slate-object="text" data-key="14351"><span data-slate-leaf="true" data-offset-key="14351:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14352"><span data-slate-object="text" data-key="14353"><span data-slate-leaf="true" data-offset-key="14353:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14354"><span data-slate-object="text" data-key="14355"><span data-slate-leaf="true" data-offset-key="14355:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14356"><span data-slate-leaf="true" data-offset-key="14356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kprint</span></span></span></span><span data-slate-object="text" data-key="14357"><span data-slate-leaf="true" data-offset-key="14357:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14358"><span data-slate-leaf="true" data-offset-key="14358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"CPUIDLETASK: %x\n"</span></span></span></span><span data-slate-object="text" data-key="14359"><span data-slate-leaf="true" data-offset-key="14359:0" data-first-offset="true"><span data-slate-string="true">, (</span></span></span><span data-slate-object="text" data-key="14360"><span data-slate-leaf="true" data-offset-key="14360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="14361"><span data-slate-leaf="true" data-offset-key="14361:0" data-first-offset="true"><span data-slate-string="true">)thp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14362"><span data-slate-object="text" data-key="14363"><span data-slate-leaf="true" data-offset-key="14363:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14364"><span data-slate-leaf="true" data-offset-key="14364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14365"><span data-slate-leaf="true" data-offset-key="14365:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14366"><span data-slate-object="text" data-key="14367"><span data-slate-leaf="true" data-offset-key="14367:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14368"><span data-slate-object="text" data-key="14369"><span data-slate-leaf="true" data-offset-key="14369:0" data-first-offset="true"><span data-slate-string="true">上述代码中，建立空转进程由 new_cpuidle 函数调用 new_cpuidle_thread 函数完成，new_cpuidle_thread 函数的操作和前面建立内核进程差不多，只不过在函数的最后，让调度系统数据结构的空转进程和当前进程的指针，指向了刚刚建立的进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14370"><span data-slate-object="text" data-key="14371"><span data-slate-leaf="true" data-offset-key="14371:0" data-first-offset="true"><span data-slate-string="true">但是你要注意，上述代码中调用初始内核栈函数时，将 krlcpuidle_main 函数传了进去，这就是空转进程的主函数，下面我们来写好。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="14372"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14373"><span data-slate-object="text" data-key="14374"><span data-slate-leaf="true" data-offset-key="14374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14375"><span data-slate-leaf="true" data-offset-key="14375:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14376"><span data-slate-leaf="true" data-offset-key="14376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlcpuidle_main</span></span></span></span><span data-slate-object="text" data-key="14377"><span data-slate-leaf="true" data-offset-key="14377:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14378"><span data-slate-leaf="true" data-offset-key="14378:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14379"><span data-slate-object="text" data-key="14380"><span data-slate-leaf="true" data-offset-key="14380:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14381"><span data-slate-object="text" data-key="14382"><span data-slate-leaf="true" data-offset-key="14382:0" data-first-offset="true"><span data-slate-string="true">    uint_t i = </span></span></span><span data-slate-object="text" data-key="14383"><span data-slate-leaf="true" data-offset-key="14383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14384"><span data-slate-leaf="true" data-offset-key="14384:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14385"><span data-slate-object="text" data-key="14386"><span data-slate-leaf="true" data-offset-key="14386:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14387"><span data-slate-leaf="true" data-offset-key="14387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="14388"><span data-slate-leaf="true" data-offset-key="14388:0" data-first-offset="true"><span data-slate-string="true"> (;; i++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14389"><span data-slate-object="text" data-key="14390"><span data-slate-leaf="true" data-offset-key="14390:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14391"><span data-slate-object="text" data-key="14392"><span data-slate-leaf="true" data-offset-key="14392:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14393"><span data-slate-leaf="true" data-offset-key="14393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kprint</span></span></span></span><span data-slate-object="text" data-key="14394"><span data-slate-leaf="true" data-offset-key="14394:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14395"><span data-slate-leaf="true" data-offset-key="14395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"空转进程运行:% x\n"</span></span></span></span><span data-slate-object="text" data-key="14396"><span data-slate-leaf="true" data-offset-key="14396:0" data-first-offset="true"><span data-slate-string="true">, i);</span></span></span><span data-slate-object="text" data-key="14397"><span data-slate-leaf="true" data-offset-key="14397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打印</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14398"><span data-slate-object="text" data-key="14399"><span data-slate-leaf="true" data-offset-key="14399:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14400"><span data-slate-leaf="true" data-offset-key="14400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlschedul</span></span></span></span><span data-slate-object="text" data-key="14401"><span data-slate-leaf="true" data-offset-key="14401:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="14402"><span data-slate-leaf="true" data-offset-key="14402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调度进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14403"><span data-slate-object="text" data-key="14404"><span data-slate-leaf="true" data-offset-key="14404:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14405"><span data-slate-object="text" data-key="14406"><span data-slate-leaf="true" data-offset-key="14406:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14407"><span data-slate-leaf="true" data-offset-key="14407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14408"><span data-slate-leaf="true" data-offset-key="14408:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14409"><span data-slate-object="text" data-key="14410"><span data-slate-leaf="true" data-offset-key="14410:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14411"><span data-slate-object="text" data-key="14412"><span data-slate-leaf="true" data-offset-key="14412:0" data-first-offset="true"><span data-slate-string="true">我给你解释一下，空转进程的主函数本质就是个死循环，在死循环中打印一行信息，然后进行进程调度，这个函数就是永无休止地执行这两个步骤。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14413" id="sr-toc-7"><span data-slate-object="text" data-key="14414"><span data-slate-leaf="true" data-offset-key="14414:0" data-first-offset="true"><span data-slate-string="true">空转进程运行</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14415"><span data-slate-object="text" data-key="14416"><span data-slate-leaf="true" data-offset-key="14416:0" data-first-offset="true"><span data-slate-string="true">我们已经建立了空转进程，下面就要去运行它了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14417"><span data-slate-object="text" data-key="14418"><span data-slate-leaf="true" data-offset-key="14418:0" data-first-offset="true"><span data-slate-string="true">由于是第一进程，所以没法用调度器来调度它，我们得手动启动它，才可以运行。其实</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="14419"><span data-slate-object="text" data-key="14420"><span data-slate-leaf="true" data-offset-key="14420:0" data-first-offset="true"><span data-slate-string="true">上节课</span></span></span></a><span data-slate-object="text" data-key="14421"><span data-slate-leaf="true" data-offset-key="14421:0" data-first-offset="true"><span data-slate-string="true">我们已经写了启动一个新建进程运行的函数，我们现在只要调用它就好了，代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="14422"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14423"><span data-slate-object="text" data-key="14424"><span data-slate-leaf="true" data-offset-key="14424:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="14425"><span data-slate-leaf="true" data-offset-key="14425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlcpuidle_start</span></span></span></span><span data-slate-object="text" data-key="14426"><span data-slate-leaf="true" data-offset-key="14426:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14427"><span data-slate-object="text" data-key="14428"><span data-slate-leaf="true" data-offset-key="14428:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14429"><span data-slate-object="text" data-key="14430"><span data-slate-leaf="true" data-offset-key="14430:0" data-first-offset="true"><span data-slate-string="true">    uint_t cpuid = </span></span></span><span data-slate-object="text" data-key="14431"><span data-slate-leaf="true" data-offset-key="14431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="14432"><span data-slate-leaf="true" data-offset-key="14432:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14433"><span data-slate-object="text" data-key="14434"><span data-slate-leaf="true" data-offset-key="14434:0" data-first-offset="true"><span data-slate-string="true">    schdata_t *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14435"><span data-slate-object="text" data-key="14436"><span data-slate-leaf="true" data-offset-key="14436:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14437"><span data-slate-leaf="true" data-offset-key="14437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取得空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14438"><span data-slate-object="text" data-key="14439"><span data-slate-leaf="true" data-offset-key="14439:0" data-first-offset="true"><span data-slate-string="true">    thread_t *tdp = schdap</span></span></span><span data-slate-object="text" data-key="14440"><span data-slate-leaf="true" data-offset-key="14440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14441"><span data-slate-leaf="true" data-offset-key="14441:0" data-first-offset="true"><span data-slate-string="true">sda_cpuidle;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14442"><span data-slate-object="text" data-key="14443"><span data-slate-leaf="true" data-offset-key="14443:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14444"><span data-slate-leaf="true" data-offset-key="14444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置空转进程的 tss 和 R0 特权级的栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14445"><span data-slate-object="text" data-key="14446"><span data-slate-leaf="true" data-offset-key="14446:0" data-first-offset="true"><span data-slate-string="true">    tdp</span></span></span><span data-slate-object="text" data-key="14447"><span data-slate-leaf="true" data-offset-key="14447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14448"><span data-slate-leaf="true" data-offset-key="14448:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nexttss = &amp;x64tss[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14449"><span data-slate-object="text" data-key="14450"><span data-slate-leaf="true" data-offset-key="14450:0" data-first-offset="true"><span data-slate-string="true">    tdp</span></span></span><span data-slate-object="text" data-key="14451"><span data-slate-leaf="true" data-offset-key="14451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14452"><span data-slate-leaf="true" data-offset-key="14452:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nexttss</span></span></span><span data-slate-object="text" data-key="14453"><span data-slate-leaf="true" data-offset-key="14453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14454"><span data-slate-leaf="true" data-offset-key="14454:0" data-first-offset="true"><span data-slate-string="true">rsp0 = tdp</span></span></span><span data-slate-object="text" data-key="14455"><span data-slate-leaf="true" data-offset-key="14455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14456"><span data-slate-leaf="true" data-offset-key="14456:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14457"><span data-slate-object="text" data-key="14458"><span data-slate-leaf="true" data-offset-key="14458:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14459"><span data-slate-leaf="true" data-offset-key="14459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置空转进程的状态为运行状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14460"><span data-slate-object="text" data-key="14461"><span data-slate-leaf="true" data-offset-key="14461:0" data-first-offset="true"><span data-slate-string="true">    tdp</span></span></span><span data-slate-object="text" data-key="14462"><span data-slate-leaf="true" data-offset-key="14462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="14463"><span data-slate-leaf="true" data-offset-key="14463:0" data-first-offset="true"><span data-slate-string="true">td_stus = TDSTUS_RUN;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14464"><span data-slate-object="text" data-key="14465"><span data-slate-leaf="true" data-offset-key="14465:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14466"><span data-slate-leaf="true" data-offset-key="14466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动进程运行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14467"><span data-slate-object="text" data-key="14468"><span data-slate-leaf="true" data-offset-key="14468:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14469"><span data-slate-leaf="true" data-offset-key="14469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">retnfrom_first_sched</span></span></span></span><span data-slate-object="text" data-key="14470"><span data-slate-leaf="true" data-offset-key="14470:0" data-first-offset="true"><span data-slate-string="true">(tdp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14471"><span data-slate-object="text" data-key="14472"><span data-slate-leaf="true" data-offset-key="14472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14473"><span data-slate-leaf="true" data-offset-key="14473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14474"><span data-slate-leaf="true" data-offset-key="14474:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14475"><span data-slate-object="text" data-key="14476"><span data-slate-leaf="true" data-offset-key="14476:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14477"><span data-slate-object="text" data-key="14478"><span data-slate-leaf="true" data-offset-key="14478:0" data-first-offset="true"><span data-slate-string="true">上述代码的逻辑也很容易理解，我为你梳理一下。首先就是取出空转进程，然后设置一下机器上下文结构和运行状态，最后调用 retnfrom_first_sched 函数，恢复进程内核栈中的内容，让进程启动运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14479"><span data-slate-object="text" data-key="14480"><span data-slate-leaf="true" data-offset-key="14480:0" data-first-offset="true"><span data-slate-string="true">不过这还没完，我们应该把建立空转进程和启动空转进程运行函数封装起来，放在一个初始化空转进程的函数中，并在内核层初始化 init_krl 函数的最后调用，代码如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="14481"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14482"><span data-slate-object="text" data-key="14483"><span data-slate-leaf="true" data-offset-key="14483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14484"><span data-slate-leaf="true" data-offset-key="14484:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14485"><span data-slate-leaf="true" data-offset-key="14485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krl</span></span></span></span><span data-slate-object="text" data-key="14486"><span data-slate-leaf="true" data-offset-key="14486:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14487"><span data-slate-leaf="true" data-offset-key="14487:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14488"><span data-slate-object="text" data-key="14489"><span data-slate-leaf="true" data-offset-key="14489:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14490"><span data-slate-object="text" data-key="14491"><span data-slate-leaf="true" data-offset-key="14491:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14492"><span data-slate-leaf="true" data-offset-key="14492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlsched</span></span></span></span><span data-slate-object="text" data-key="14493"><span data-slate-leaf="true" data-offset-key="14493:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="14494"><span data-slate-leaf="true" data-offset-key="14494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化进程调度器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14495"><span data-slate-object="text" data-key="14496"><span data-slate-leaf="true" data-offset-key="14496:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14497"><span data-slate-leaf="true" data-offset-key="14497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlcpuidle</span></span></span></span><span data-slate-object="text" data-key="14498"><span data-slate-leaf="true" data-offset-key="14498:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="14499"><span data-slate-leaf="true" data-offset-key="14499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14500"><span data-slate-object="text" data-key="14501"><span data-slate-leaf="true" data-offset-key="14501:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14502"><span data-slate-leaf="true" data-offset-key="14502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">die</span></span></span></span><span data-slate-object="text" data-key="14503"><span data-slate-leaf="true" data-offset-key="14503:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14504"><span data-slate-leaf="true" data-offset-key="14504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14505"><span data-slate-leaf="true" data-offset-key="14505:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span><span data-slate-object="text" data-key="14506"><span data-slate-leaf="true" data-offset-key="14506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 防止 init_krl 函数返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14507"><span data-slate-object="text" data-key="14508"><span data-slate-leaf="true" data-offset-key="14508:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14509"><span data-slate-leaf="true" data-offset-key="14509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14510"><span data-slate-leaf="true" data-offset-key="14510:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14511"><span data-slate-object="text" data-key="14512"><span data-slate-leaf="true" data-offset-key="14512:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14513"><span data-slate-object="text" data-key="14514"><span data-slate-leaf="true" data-offset-key="14514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14515"><span data-slate-object="text" data-key="14516"><span data-slate-leaf="true" data-offset-key="14516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14517"><span data-slate-leaf="true" data-offset-key="14517:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14518"><span data-slate-leaf="true" data-offset-key="14518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlcpuidle</span></span></span></span><span data-slate-object="text" data-key="14519"><span data-slate-leaf="true" data-offset-key="14519:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="14520"><span data-slate-leaf="true" data-offset-key="14520:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14521"><span data-slate-object="text" data-key="14522"><span data-slate-leaf="true" data-offset-key="14522:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14523"><span data-slate-object="text" data-key="14524"><span data-slate-leaf="true" data-offset-key="14524:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14525"><span data-slate-leaf="true" data-offset-key="14525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_cpuidle</span></span></span></span><span data-slate-object="text" data-key="14526"><span data-slate-leaf="true" data-offset-key="14526:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="14527"><span data-slate-leaf="true" data-offset-key="14527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14528"><span data-slate-object="text" data-key="14529"><span data-slate-leaf="true" data-offset-key="14529:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14530"><span data-slate-leaf="true" data-offset-key="14530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlcpuidle_start</span></span></span></span><span data-slate-object="text" data-key="14531"><span data-slate-leaf="true" data-offset-key="14531:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="14532"><span data-slate-leaf="true" data-offset-key="14532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动空转进程运行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14533"><span data-slate-object="text" data-key="14534"><span data-slate-leaf="true" data-offset-key="14534:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14535"><span data-slate-leaf="true" data-offset-key="14535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14536"><span data-slate-leaf="true" data-offset-key="14536:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14537"><span data-slate-object="text" data-key="14538"><span data-slate-leaf="true" data-offset-key="14538:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14539"><span data-slate-object="text" data-key="14540"><span data-slate-leaf="true" data-offset-key="14540:0" data-first-offset="true"><span data-slate-string="true">好了，所有的代码都已备好，终于到我们检验学习成果的时候了，我切换到这节课程的 cosmos 目录下执行 make vboxtest 命令，就会出现如下图的结果，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14541"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/ef/24/efcf95c11732273ace5329152c782924.jpg?wh=1064x921"></div><div>空转进程运行</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14542"><span data-slate-object="text" data-key="14543"><span data-slate-leaf="true" data-offset-key="14543:0" data-first-offset="true"><span data-slate-string="true">可以看到，现在空转进程和调度器输出的信息在屏幕上交替滚动出现，这说明我们的空转进程和进程调度器都已经正常工作了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14544" id="sr-toc-8"><span data-slate-object="text" data-key="14545"><span data-slate-leaf="true" data-offset-key="14545:0" data-first-offset="true"><span data-slate-string="true">多进程运行</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14546"><span data-slate-object="text" data-key="14547"><span data-slate-leaf="true" data-offset-key="14547:0" data-first-offset="true"><span data-slate-string="true">虽然我们的空转进程和调度器已经正常工作了，但你可能心里会有疑问，我们系统中就一个空转进程，那怎么证明我们进程调度器是正常工作的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14548"><span data-slate-object="text" data-key="14549"><span data-slate-leaf="true" data-offset-key="14549:0" data-first-offset="true"><span data-slate-string="true">其实我们在空转进程中调用了调度器函数，然后进程调度器会发现系统中没有进程，又不得不调度空转进程，所以最后结果就是：空转进程调用进程调度器，而调度器又选择了空转进程，导致形成了一个闭环。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14550"><span data-slate-object="text" data-key="14551"><span data-slate-leaf="true" data-offset-key="14551:0" data-first-offset="true"><span data-slate-string="true">但是我们现在想要看看多个进程会是什么情况，就需要建立多个进程。下面我们马上就来实现这个想法，代码如下。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="14552"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14553"><span data-slate-object="text" data-key="14554"><span data-slate-leaf="true" data-offset-key="14554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14555"><span data-slate-leaf="true" data-offset-key="14555:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14556"><span data-slate-leaf="true" data-offset-key="14556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_a_main</span></span></span></span><span data-slate-object="text" data-key="14557"><span data-slate-leaf="true" data-offset-key="14557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="14558"><span data-slate-leaf="true" data-offset-key="14558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程 A 主函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14559"><span data-slate-object="text" data-key="14560"><span data-slate-leaf="true" data-offset-key="14560:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14561"><span data-slate-object="text" data-key="14562"><span data-slate-leaf="true" data-offset-key="14562:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14563"><span data-slate-leaf="true" data-offset-key="14563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="14564"><span data-slate-leaf="true" data-offset-key="14564:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14565"><span data-slate-leaf="true" data-offset-key="14565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i</span></span></span></span><span data-slate-object="text" data-key="14566"><span data-slate-leaf="true" data-offset-key="14566:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14567"><span data-slate-leaf="true" data-offset-key="14567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14568"><span data-slate-leaf="true" data-offset-key="14568:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14569"><span data-slate-leaf="true" data-offset-key="14569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14570"><span data-slate-leaf="true" data-offset-key="14570:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14571"><span data-slate-object="text" data-key="14572"><span data-slate-leaf="true" data-offset-key="14572:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14573"><span data-slate-leaf="true" data-offset-key="14573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="14574"><span data-slate-leaf="true" data-offset-key="14574:0" data-first-offset="true"><span data-slate-string="true"> (;; i++) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14575"><span data-slate-object="text" data-key="14576"><span data-slate-leaf="true" data-offset-key="14576:0" data-first-offset="true"><span data-slate-string="true">        kprint(</span></span></span><span data-slate-object="text" data-key="14577"><span data-slate-leaf="true" data-offset-key="14577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"进程 A 运行:% x\n"</span></span></span></span><span data-slate-object="text" data-key="14578"><span data-slate-leaf="true" data-offset-key="14578:0" data-first-offset="true"><span data-slate-string="true">, i);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14579"><span data-slate-object="text" data-key="14580"><span data-slate-leaf="true" data-offset-key="14580:0" data-first-offset="true"><span data-slate-string="true">        krlschedul();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14581"><span data-slate-object="text" data-key="14582"><span data-slate-leaf="true" data-offset-key="14582:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14583"><span data-slate-object="text" data-key="14584"><span data-slate-leaf="true" data-offset-key="14584:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14585"><span data-slate-leaf="true" data-offset-key="14585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14586"><span data-slate-leaf="true" data-offset-key="14586:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14587"><span data-slate-object="text" data-key="14588"><span data-slate-leaf="true" data-offset-key="14588:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14589"><span data-slate-object="text" data-key="14590"><span data-slate-leaf="true" data-offset-key="14590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14591"><span data-slate-leaf="true" data-offset-key="14591:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14592"><span data-slate-leaf="true" data-offset-key="14592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_b_main</span></span></span></span><span data-slate-object="text" data-key="14593"><span data-slate-leaf="true" data-offset-key="14593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="14594"><span data-slate-leaf="true" data-offset-key="14594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程 B 主函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14595"><span data-slate-object="text" data-key="14596"><span data-slate-leaf="true" data-offset-key="14596:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14597"><span data-slate-object="text" data-key="14598"><span data-slate-leaf="true" data-offset-key="14598:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14599"><span data-slate-leaf="true" data-offset-key="14599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="14600"><span data-slate-leaf="true" data-offset-key="14600:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14601"><span data-slate-leaf="true" data-offset-key="14601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">i</span></span></span></span><span data-slate-object="text" data-key="14602"><span data-slate-leaf="true" data-offset-key="14602:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14603"><span data-slate-leaf="true" data-offset-key="14603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14604"><span data-slate-leaf="true" data-offset-key="14604:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14605"><span data-slate-leaf="true" data-offset-key="14605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14606"><span data-slate-leaf="true" data-offset-key="14606:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14607"><span data-slate-object="text" data-key="14608"><span data-slate-leaf="true" data-offset-key="14608:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14609"><span data-slate-leaf="true" data-offset-key="14609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="14610"><span data-slate-leaf="true" data-offset-key="14610:0" data-first-offset="true"><span data-slate-string="true"> (;; i++) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14611"><span data-slate-object="text" data-key="14612"><span data-slate-leaf="true" data-offset-key="14612:0" data-first-offset="true"><span data-slate-string="true">        kprint(</span></span></span><span data-slate-object="text" data-key="14613"><span data-slate-leaf="true" data-offset-key="14613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"进程 B 运行:% x\n"</span></span></span></span><span data-slate-object="text" data-key="14614"><span data-slate-leaf="true" data-offset-key="14614:0" data-first-offset="true"><span data-slate-string="true">, i);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14615"><span data-slate-object="text" data-key="14616"><span data-slate-leaf="true" data-offset-key="14616:0" data-first-offset="true"><span data-slate-string="true">        krlschedul();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14617"><span data-slate-object="text" data-key="14618"><span data-slate-leaf="true" data-offset-key="14618:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14619"><span data-slate-object="text" data-key="14620"><span data-slate-leaf="true" data-offset-key="14620:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14621"><span data-slate-leaf="true" data-offset-key="14621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14622"><span data-slate-leaf="true" data-offset-key="14622:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14623"><span data-slate-object="text" data-key="14624"><span data-slate-leaf="true" data-offset-key="14624:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14625"><span data-slate-object="text" data-key="14626"><span data-slate-leaf="true" data-offset-key="14626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14627"><span data-slate-leaf="true" data-offset-key="14627:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14628"><span data-slate-leaf="true" data-offset-key="14628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_ab_thread</span></span></span></span><span data-slate-object="text" data-key="14629"><span data-slate-leaf="true" data-offset-key="14629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14630"><span data-slate-object="text" data-key="14631"><span data-slate-leaf="true" data-offset-key="14631:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14632"><span data-slate-object="text" data-key="14633"><span data-slate-leaf="true" data-offset-key="14633:0" data-first-offset="true"><span data-slate-string="true">    krlnew_thread((</span></span></span><span data-slate-object="text" data-key="14634"><span data-slate-leaf="true" data-offset-key="14634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14635"><span data-slate-leaf="true" data-offset-key="14635:0" data-first-offset="true"><span data-slate-string="true">*)thread_a_main, KERNTHREAD_FLG, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14636"><span data-slate-object="text" data-key="14637"><span data-slate-leaf="true" data-offset-key="14637:0" data-first-offset="true"><span data-slate-string="true">                PRILG_SYS, PRITY_MIN, DAFT_TDUSRSTKSZ, DAFT_TDKRLSTKSZ);</span></span></span><span data-slate-object="text" data-key="14638"><span data-slate-leaf="true" data-offset-key="14638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立进程 A</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14639"><span data-slate-object="text" data-key="14640"><span data-slate-leaf="true" data-offset-key="14640:0" data-first-offset="true"><span data-slate-string="true">    krlnew_thread((</span></span></span><span data-slate-object="text" data-key="14641"><span data-slate-leaf="true" data-offset-key="14641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14642"><span data-slate-leaf="true" data-offset-key="14642:0" data-first-offset="true"><span data-slate-string="true">*)thread_b_main, KERNTHREAD_FLG, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14643"><span data-slate-object="text" data-key="14644"><span data-slate-leaf="true" data-offset-key="14644:0" data-first-offset="true"><span data-slate-string="true">                PRILG_SYS, PRITY_MIN, DAFT_TDUSRSTKSZ, DAFT_TDKRLSTKSZ);</span></span></span><span data-slate-object="text" data-key="14645"><span data-slate-leaf="true" data-offset-key="14645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立进程 B</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14646"><span data-slate-object="text" data-key="14647"><span data-slate-leaf="true" data-offset-key="14647:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14648"><span data-slate-leaf="true" data-offset-key="14648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14649"><span data-slate-leaf="true" data-offset-key="14649:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14650"><span data-slate-object="text" data-key="14651"><span data-slate-leaf="true" data-offset-key="14651:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14652"><span data-slate-object="text" data-key="14653"><span data-slate-leaf="true" data-offset-key="14653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="14654"><span data-slate-leaf="true" data-offset-key="14654:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14655"><span data-slate-leaf="true" data-offset-key="14655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlcpuidle</span></span></span></span><span data-slate-object="text" data-key="14656"><span data-slate-leaf="true" data-offset-key="14656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14657"><span data-slate-object="text" data-key="14658"><span data-slate-leaf="true" data-offset-key="14658:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14659"><span data-slate-object="text" data-key="14660"><span data-slate-leaf="true" data-offset-key="14660:0" data-first-offset="true"><span data-slate-string="true">    new_cpuidle();</span></span></span><span data-slate-object="text" data-key="14661"><span data-slate-leaf="true" data-offset-key="14661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14662"><span data-slate-object="text" data-key="14663"><span data-slate-leaf="true" data-offset-key="14663:0" data-first-offset="true"><span data-slate-string="true">    init_ab_thread();</span></span></span><span data-slate-object="text" data-key="14664"><span data-slate-leaf="true" data-offset-key="14664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化建立 A、B 进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14665"><span data-slate-object="text" data-key="14666"><span data-slate-leaf="true" data-offset-key="14666:0" data-first-offset="true"><span data-slate-string="true">    krlcpuidle_start();</span></span></span><span data-slate-object="text" data-key="14667"><span data-slate-leaf="true" data-offset-key="14667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开始运行空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14668"><span data-slate-object="text" data-key="14669"><span data-slate-leaf="true" data-offset-key="14669:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14670"><span data-slate-leaf="true" data-offset-key="14670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="14671"><span data-slate-leaf="true" data-offset-key="14671:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14672"><span data-slate-object="text" data-key="14673"><span data-slate-leaf="true" data-offset-key="14673:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14674"><span data-slate-object="text" data-key="14675"><span data-slate-leaf="true" data-offset-key="14675:0" data-first-offset="true"><span data-slate-string="true">上述代码中，我们在 init_ab_thread 函数中建立两个内核进程，分别运行两个函数，这两个函数会打印信息，init_ab_thread 函数由 init_krlcpuidle 函数调用。这样在初始化空转进程的时候，就建立了进程 A 和进程 B。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14676"><span data-slate-object="text" data-key="14677"><span data-slate-leaf="true" data-offset-key="14677:0" data-first-offset="true"><span data-slate-string="true">好了，现在我们在 Linux 终端下进入 cosmos 目录，在目录下输入 make vboxtest 运行一下，结果如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14678"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f9/b1/f986251428c419f5b2000308236466b1.jpg?wh=1064x921"></div><div>两个进程结果截图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14679"><span data-slate-object="text" data-key="14680"><span data-slate-leaf="true" data-offset-key="14680:0" data-first-offset="true"><span data-slate-string="true">上图中，进程 A 和进程 B 在调度器的调度下交替运行，而空转进程不再运行，这表明我们的多进程机制完全正确。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14681" id="sr-toc-9"><span data-slate-object="text" data-key="14682"><span data-slate-leaf="true" data-offset-key="14682:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14683"><span data-slate-object="text" data-key="14684"><span data-slate-leaf="true" data-offset-key="14684:0" data-first-offset="true"><span data-slate-string="true">这节课我们接着上一节课，实现了进程的等待与唤醒机制，然后建立了空转进程，最后对进程调度进行了测试。下面我来为你梳理一下要点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14685"><span data-slate-object="text" data-key="14686"><span data-slate-leaf="true" data-offset-key="14686:0" data-first-offset="true"><span data-slate-string="true">1.</span></span></span><span data-slate-object="text" data-key="14687"><span data-slate-leaf="true" data-offset-key="14687:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 等待和唤醒机制。</span></span></span></span><span data-slate-object="text" data-key="14688"><span data-slate-leaf="true" data-offset-key="14688:0" data-first-offset="true"><span data-slate-string="true">为了让进程能进入等待状态随后又能在其它条件满足的情况下被唤醒，我们实现了进程等待和唤醒机制。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14689"><span data-slate-object="text" data-key="14690"><span data-slate-leaf="true" data-offset-key="14690:0" data-first-offset="true"><span data-slate-string="true">2.</span></span></span><span data-slate-object="text" data-key="14691"><span data-slate-leaf="true" data-offset-key="14691:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 空转进程。</span></span></span></span><span data-slate-object="text" data-key="14692"><span data-slate-leaf="true" data-offset-key="14692:0" data-first-offset="true"><span data-slate-string="true">是我们 Cosmos 系统下的第一个进程，它只干一件事情就是调用调度器函数调度进程，在系统中没有其它可以运行进程时，调度器又会调度空转进程，形成了一个闭环。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14693"><span data-slate-object="text" data-key="14694"><span data-slate-leaf="true" data-offset-key="14694:0" data-first-offset="true"><span data-slate-string="true">3.</span></span></span><span data-slate-object="text" data-key="14695"><span data-slate-leaf="true" data-offset-key="14695:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 测试。</span></span></span></span><span data-slate-object="text" data-key="14696"><span data-slate-leaf="true" data-offset-key="14696:0" data-first-offset="true"><span data-slate-string="true">为了验证我们的进程调度器是否是正常工作的，我们建立了两个进程，让它们运行，结果在屏幕上出现了它们交替输出的信息。这证明了我们的进程调度器是功能正常的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14697"><span data-slate-object="text" data-key="14698"><span data-slate-leaf="true" data-offset-key="14698:0" data-first-offset="true"><span data-slate-string="true">你也许发现了，我们的进程中都调用了 krlschedul 函数，不调用它就是始终只有一个进程运行了，你在开发应用程序中，需要调用调度器主动让出 CPU 吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14699"><span data-slate-object="text" data-key="14700"><span data-slate-leaf="true" data-offset-key="14700:0" data-first-offset="true"><span data-slate-string="true">这是什么原因呢？这是因为我们的 Cosmos 没有定时器驱动，系统的 TICK 机制无法工作，一旦我们系统 TICK 机开始工作，就能控制进程运行了多长时间，然后强制调度进程。系统 TICK 设备我们等到驱动与设备相关的模块，再给你展开讲解。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14701" id="sr-toc-10"><span data-slate-object="text" data-key="14702"><span data-slate-leaf="true" data-offset-key="14702:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14703"><span data-slate-object="text" data-key="14704"><span data-slate-leaf="true" data-offset-key="14704:0" data-first-offset="true"><span data-slate-string="true">请问，我们让进程进入等待状态后，这进程会立马停止运行吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14705"><span data-slate-object="text" data-key="14706"><span data-slate-leaf="true" data-offset-key="14706:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区和我交流，相信通过积极参与，你将更好地理解这节课的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14707"><span data-slate-object="text" data-key="14708"><span data-slate-leaf="true" data-offset-key="14708:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-11">精选留言 (12)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div><span>置顶</span></div><div>并不会，进程进入等待只是进程状态发生了改变，进程还未让出当前 CPU 的执行权，待调度后，即 krlschedul ()，会寻找已经准备好的其它进程，切换 CPU 上下文，让出 CPU，此时该进程才会真正的停止。

所以调度函数至关重要！</div><div><p>作者回复: 66666  对的 </p></div><div><div>2021-07-07</div><div><div><i></i><span>2</span></div><div><i></i><span>11</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>一、数据结构
全局有一个 osschedcls 变量，其数据结构为 schedclass_t，用于管理所有 cpu 的所有进程。

schedclass_t 包括一个 schdata_t 数组，每个 cpu 对应一个。
schedclass_t.schdata_t [i]，用于管理第 i 个 cpu 的全部进程。

schedclass_t.schdata_t [i] 包括一个 thrdlst_t 数组，每个进程优先级对应一个。
schedclass_t.schdata_t [i].thrdlst_t [j] 中，管理了第 i 个 cpu 的，优先级为 j 的全部进程。

二、idel 进程
idel 进程初始化及启动：
init_krl-&gt;init_krlcpuidle-&gt;new_cpuidle-&gt;new_cpuidle_thread-&gt;krlthread_kernstack_init【krlcpuidle_main 传参】-&gt;krlschedul-&gt;krlcpuidle_start-&gt;retnfrom_first_sched 启动 idel 进程

idel 进程调度：
idel 进程启动后，会不停的在 krlcpuidle_main 函数中循环调用 krlschedul，只要有其他进程可以运行，就让渡 CPU 使用权给到其他进程；
其他进程调用 krlschedul 让渡 CPU 使用权时，如果找不到” 下一进程 “，会将 CPU 使用权给回到 idel 进程；

三、进程的等待与唤醒【信号量为例】
信号量 sem_t，有一个等待进程列表 kwlst_t，保存了等待获取信号量的全部进程列表

获取信号量：
进程调用 krlsem_down-&gt; 当信号量不足时 krlwlst_wait-&gt; 主动调用 krlsched_wait 让渡 CPU 使用权，让其他进程优先运行
即使其他进程把 CPU 使用权又还回来，也会继续循环，不断尝试获取信号量

释放信号量：
进程调用 krlsem_up-&gt;krlwlst_allup-&gt; 对 kwlst_t 中全部等待进程，依次调用 krlsched_up-&gt; 被给与 CPU 使用权的进程，会立即唤醒并尝试获取信号量

最后，有一个问题没想清楚，还请老师帮忙解答一下：
系统的 idel 进程只有一个，如果多个 cpu 同时空闲，会不会有问题啊？空闲进程不用 per_cpu 吗？</div><div><p>作者回复：不会有问题的 因 SMP 下每个 CPU 会对应一个 idle 进程  运行同一份代码  </p></div><div><div>2021-07-07</div><div><div><i></i></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div></div><div><div><div><span>geek2020</span></div></div><div>好奇很多资料说 java 执行了 Thread.sleep () 后，会主动让出 CPU 的使用权，是怎么做到的？</div><div><p>作者回复: sleep 会设置定时器 然后 主动 调用调度器 </p></div><div><div>2021-07-15</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/60/81/38b00111.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Feen</span></div></div><div> 进程进入等待状态后，进程本身处于等待状态，进程被剥夺 CPU 使用权是通过 krlschedul () 函数剥夺的，而进程本身并没有调用 krlschedul () 函数，所以不会立即停止运行，而剥夺 CPU 使用权是由 krlschedul () 函数控制的，当保存当前进程寄存器和栈，并且准备好下一个进程的运行函数后，才会让当前进程退出 CPU 而停止运行了。</div><div><p>作者回复：对的 </p></div><div><div>2021-07-13</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 青玉白露</span></div></div><div>进程不会马上停止运行，调用 krlschedul () 之后，会调度新的进程。</div><div><p>作者回复：是的 正确</p></div><div><div>2021-07-07</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/c5/a2/4ece341b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Ivan.Qi</span></div></div><div>遇到一个问题，暂时没什么头绪
1. 通过 krlnew_thread 初始化一个进程
   krlnew_thread ("kernelthread-a", (void*) thread_a_main, KERNTHREAD_FLG, PRILG_SYS, PRITY_MIN, DAFT_TDUSRSTKSZ, DAFT_TDKRLSTKSZ);

2. 进程自定义函数
  void thread_a_main (){ uint_t i = 0;  kprint ("进程 A 运行:% x\n", i); }

3. 然后程序执行
   1. new_cpuidle 2. init_a_thread 3. krlcpuidle_start -&gt; retnfrom_first_sched

4. 最后提示
   当前进程: kernelthread-a, 犯了不该犯的错误：13, 所以要杀</div><div><p>作者回复：你修改代码 了吗  </p></div><div><div>2022-08-24</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/icD3j8Uhe4xML3HTdgd93YrenCZEuX4UwYZcYG9y3o4gRyWJCKS2vXBQmq0vnKhUIP8vPpg8F2Iicw68Tvg60elg/132"></div></div><div><div><div><span>我是新手 ABC</span></div></div><div>有个疑问：如果空转函数一直运行的话，也就是 CPU 不是在运行用户代码就是在运行空转函数，那 CPU 的使用率会不会一直是 100% 呢？</div><div><p>作者回复：是的 但系统中不只有空转进程</p></div><div><div>2022-05-23</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>艾恩凝</span></div></div><div>自己建的工程，怎么新建空转进程的时候 运行到 krlthread_kernstack_init 函数中，就会报 14 号异常，这是怎么回事，就是初始化内核栈的时候，按道理说这都是物理地址，怎么还是会进入 14 异常</div><div><p>作者回复：是不是  地址 映射 的问题</p></div><div><div>2022-05-05</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2b/5f/3c/a54e8838.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡涂涂</span></div></div><div>这个调度机制很像嵌入式中实时操作系统的多任务调度，空转进程对标空闲任务。空转任务中，可以做一些维护性的任务，不能让 cpu 闲下来，哈哈哈</div><div><p>作者回复：是的</p></div><div><div>2022-04-26</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/be/87/fc7d259a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>阿顺</span></div></div><div>想咨询下进程如何决策何时要等待，并让出 cpu？</div><div><p>作者回复：当然是资源 不满足时</p></div><div><div>2021-08-28</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>好奇，这个空转进程是我们平时所说的 0 号进程吗，1 号进程的创建是 fork 它吗</div><div><p>作者回复：这不一定，我们也不用 fork</p></div><div><div>2021-07-07</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/21/7e/fb725950.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>罗 乾 林</span></div></div><div>进程进入等待状态后，这进程不会立马停止运行，要等到调用 krlschedul 函数后</div><div><p>作者回复：对的 </p></div><div><div>2021-07-07</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".p"><outline class="toc-level-h1" data-reactid=".p.0" style="width: 175px;"><active data-reactid=".p.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".p.0.1"><span data-reactid=".p.0.1.0">26 | 多个活动要安排（下）：如何实现进程的等待与唤醒机制？</span></a></outline><outline class="toc-level-h2" data-reactid=".p.1" style="width: 165px;"><active data-reactid=".p.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".p.1.1"><span data-reactid=".p.1.1.0">进程的等待与唤醒</span></a></outline><outline class="toc-level-h3" data-reactid=".p.2" style="width: 155px;"><active data-reactid=".p.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".p.2.1"><span data-reactid=".p.2.1.0">进程等待结构</span></a></outline><outline class="toc-level-h3" data-reactid=".p.3" style="width: 155px;"><active data-reactid=".p.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".p.3.1"><span data-reactid=".p.3.1.0">进程等待</span></a></outline><outline class="toc-level-h3" data-reactid=".p.4" style="width: 155px;"><active data-reactid=".p.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".p.4.1"><span data-reactid=".p.4.1.0">进程唤醒</span></a></outline><outline class="toc-level-h2" data-reactid=".p.5" style="width: 165px;"><active data-reactid=".p.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".p.5.1"><span data-reactid=".p.5.1.0">空转进程</span></a></outline><outline class="toc-level-h3" data-reactid=".p.6" style="width: 155px;"><active data-reactid=".p.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".p.6.1"><span data-reactid=".p.6.1.0">建立空转进程</span></a></outline><outline class="toc-level-h3" data-reactid=".p.7" style="width: 155px;"><active data-reactid=".p.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".p.7.1"><span data-reactid=".p.7.1.0">空转进程运行</span></a></outline><outline class="toc-level-h2" data-reactid=".p.8" style="width: 165px;"><active data-reactid=".p.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".p.8.1"><span data-reactid=".p.8.1.0">多进程运行</span></a></outline><outline class="toc-level-h2" data-reactid=".p.9" style="width: 165px;"><active data-reactid=".p.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".p.9.1"><span data-reactid=".p.9.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".p.a" style="width: 165px;"><active data-reactid=".p.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".p.a.1"><span data-reactid=".p.a.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".p.b" style="width: 165px;"><active data-reactid=".p.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".p.b.1"><span data-reactid=".p.b.1.0">精选留言 (12)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/392198" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>