
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 21 | 分布式锁：为什么基于 etcd 实现分布式锁比 Redis 锁更安全？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>21 | 分布式锁：为什么基于 etcd 实现分布式锁比 Redis 锁更安全？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">我希望你能够用最低的学习成本，掌握 etcd 核心原理和最佳实践，让 etcd 为你所用。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">21 | 分布式锁：为什么基于 etcd 实现分布式锁比 Redis 锁更安全？</h1><div><span>唐聪</span> <span> 2021-03-10</span></div><div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/08/c6/0832c50cc79ba44eb82f0a16655714c6.jpg" style="width: auto;"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：王超凡</span><span>大小：15.13M</span><span> 时长：16:34</span></div></div><audio title="21 | 分布式锁：为什么基于etcd实现分布式锁比Redis锁更安全？" src="https://res001.geekbang.org/media/audio/09/b4/09366811dbe46c29964612d885f6d6b4/ld/ld.m3u8" __idm_id__="925717"></audio></div><div><div><div><div data-slate-editor="true" data-key="9107" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="9108"><span data-slate-object="text" data-key="9109"><span data-slate-leaf="true" data-offset-key="9109:0" data-first-offset="true"><span data-slate-string="true">你好，我是唐聪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9110"><span data-slate-object="text" data-key="9111"><span data-slate-leaf="true" data-offset-key="9111:0" data-first-offset="true"><span data-slate-string="true">在软件开发过程中，我们经常会遇到各种场景要求对共享资源进行互斥操作，否则整个系统的数据一致性就会出现问题。典型场景如商品库存操作、Kubernertes 调度器为 Pod 分配运行的 Node。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9112"><span data-slate-object="text" data-key="9113"><span data-slate-leaf="true" data-offset-key="9113:0" data-first-offset="true"><span data-slate-string="true">那要如何实现对共享资源进行互斥操作呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9114"><span data-slate-object="text" data-key="9115"><span data-slate-leaf="true" data-offset-key="9115:0" data-first-offset="true"><span data-slate-string="true">锁就是其中一个非常通用的解决方案。在单节点多线程环境，你使用本地的互斥锁就可以完成资源的互斥操作。然而单节点存在单点故障，为了保证服务高可用，你需要多节点部署。在多节点部署的分布式架构中，你就需要使用分布式锁来解决资源互斥操作了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9116"><span data-slate-object="text" data-key="9117"><span data-slate-leaf="true" data-offset-key="9117:0" data-first-offset="true"><span data-slate-string="true">但是为什么有的业务使用了分布式锁还会出现各种严重超卖事故呢？分布式锁的实现和使用过程需要注意什么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9118"><span data-slate-object="text" data-key="9119"><span data-slate-leaf="true" data-offset-key="9119:0" data-first-offset="true"><span data-slate-string="true">今天，我就和你聊聊分布式锁背后的故事，我将通过一个茅台超卖的案例，为你介绍基于 Redis 实现的分布锁优缺点，引出分布式锁的核心要素，对比分布式锁的几种业界典型实现方案，深入剖析 etcd 分布式锁的实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9120"><span data-slate-object="text" data-key="9121"><span data-slate-leaf="true" data-offset-key="9121:0" data-first-offset="true"><span data-slate-string="true">希望通过这节课，让你了解 etcd 分布式锁的应用场景、核心原理，在业务开发过程中，优雅、合理的使用分布式锁去解决各类资源互斥、并发操作问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9122" id="sr-toc-1"><span data-slate-object="text" data-key="9123"><span data-slate-leaf="true" data-offset-key="9123:0" data-first-offset="true"><span data-slate-string="true">从茅台超卖案例看分布式锁要素</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9124"><span data-slate-object="text" data-key="9125"><span data-slate-leaf="true" data-offset-key="9125:0" data-first-offset="true"><span data-slate-string="true">首先我们从去年一个因 Redis 分布式锁实现问题导致</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9126"><span data-slate-object="text" data-key="9127"><span data-slate-leaf="true" data-offset-key="9127:0" data-first-offset="true"><span data-slate-string="true">茅台超卖案例</span></span></span></a><span data-slate-object="text" data-key="9128"><span data-slate-leaf="true" data-offset-key="9128:0" data-first-offset="true"><span data-slate-string="true">说起，在这个网友分享的真实案例中，因茅台的稀缺性，事件最终定级为 P0 级生产事故，后果影响严重。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9129"><span data-slate-object="text" data-key="9130"><span data-slate-leaf="true" data-offset-key="9130:0" data-first-offset="true"><span data-slate-string="true">那么它是如何导致超卖的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9131"><span data-slate-object="text" data-key="9132"><span data-slate-leaf="true" data-offset-key="9132:0" data-first-offset="true"><span data-slate-string="true">首先和你简单介绍下此案例中的 Redis 简易分布式锁实现方案，它使用了 Redis SET 命令来实现。</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="9133"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9134"><span data-slate-object="text" data-key="9135"><span data-slate-leaf="true" data-offset-key="9135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SET</span></span></span></span><span data-slate-object="text" data-key="9136"><span data-slate-leaf="true" data-offset-key="9136:0" data-first-offset="true"><span data-slate-string="true"> key </span></span></span><span data-slate-object="text" data-key="9137"><span data-slate-leaf="true" data-offset-key="9137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">value</span></span></span></span><span data-slate-object="text" data-key="9138"><span data-slate-leaf="true" data-offset-key="9138:0" data-first-offset="true"><span data-slate-string="true"> [EX seconds</span></span></span><span data-slate-object="text" data-key="9139"><span data-slate-leaf="true" data-offset-key="9139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|</span></span></span></span><span data-slate-object="text" data-key="9140"><span data-slate-leaf="true" data-offset-key="9140:0" data-first-offset="true"><span data-slate-string="true">PX milliseconds</span></span></span><span data-slate-object="text" data-key="9141"><span data-slate-leaf="true" data-offset-key="9141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|</span></span></span></span><span data-slate-object="text" data-key="9142"><span data-slate-leaf="true" data-offset-key="9142:0" data-first-offset="true"><span data-slate-string="true">EXAT </span></span></span><span data-slate-object="text" data-key="9143"><span data-slate-leaf="true" data-offset-key="9143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">timestamp</span></span></span></span><span data-slate-object="text" data-key="9144"><span data-slate-leaf="true" data-offset-key="9144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|</span></span></span></span><span data-slate-object="text" data-key="9145"><span data-slate-leaf="true" data-offset-key="9145:0" data-first-offset="true"><span data-slate-string="true">PXAT milliseconds</span></span></span><span data-slate-object="text" data-key="9146"><span data-slate-leaf="true" data-offset-key="9146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="9147"><span data-slate-leaf="true" data-offset-key="9147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">timestamp</span></span></span></span><span data-slate-object="text" data-key="9148"><span data-slate-leaf="true" data-offset-key="9148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|</span></span></span></span><span data-slate-object="text" data-key="9149"><span data-slate-leaf="true" data-offset-key="9149:0" data-first-offset="true"><span data-slate-string="true">KEEPTTL] [NX</span></span></span><span data-slate-object="text" data-key="9150"><span data-slate-leaf="true" data-offset-key="9150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|</span></span></span></span><span data-slate-object="text" data-key="9151"><span data-slate-leaf="true" data-offset-key="9151:0" data-first-offset="true"><span data-slate-string="true">XX] </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9152"><span data-slate-object="text" data-key="9153"><span data-slate-leaf="true" data-offset-key="9153:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="9154"><span data-slate-leaf="true" data-offset-key="9154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">GET</span></span></span></span><span data-slate-object="text" data-key="9155"><span data-slate-leaf="true" data-offset-key="9155:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9156"><span data-slate-object="text" data-key="9157"><span data-slate-leaf="true" data-offset-key="9157:0" data-first-offset="true"><span data-slate-string="true">简单给你介绍下 SET 命令重点参数含义：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9158"><div data-slate-type="list-line" data-slate-object="block" data-key="9159"><span data-slate-type="code" data-slate-object="inline" data-key="9160"><span data-slate-object="text" data-key="9161"><span data-slate-leaf="true" data-offset-key="9161:0" data-first-offset="true"><span data-slate-string="true">EX</span></span></span></span><span data-slate-object="text" data-key="9162"><span data-slate-leaf="true" data-offset-key="9162:0" data-first-offset="true"><span data-slate-string="true">  设置过期时间，单位秒；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9163"><span data-slate-type="code" data-slate-object="inline" data-key="9164"><span data-slate-object="text" data-key="9165"><span data-slate-leaf="true" data-offset-key="9165:0" data-first-offset="true"><span data-slate-string="true">NX</span></span></span></span><span data-slate-object="text" data-key="9166"><span data-slate-leaf="true" data-offset-key="9166:0" data-first-offset="true"><span data-slate-string="true"> 当 key 不存在的时候，才设置 key；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9167"><span data-slate-type="code" data-slate-object="inline" data-key="9168"><span data-slate-object="text" data-key="9169"><span data-slate-leaf="true" data-offset-key="9169:0" data-first-offset="true"><span data-slate-string="true">XX</span></span></span></span><span data-slate-object="text" data-key="9170"><span data-slate-leaf="true" data-offset-key="9170:0" data-first-offset="true"><span data-slate-string="true"> 当 key 存在的时候，才设置 key。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9171"><span data-slate-object="text" data-key="9172"><span data-slate-leaf="true" data-offset-key="9172:0" data-first-offset="true"><span data-slate-string="true">此业务就是基于 Set key value EX 10 NX 命令来实现的分布式锁，并通过 JAVA 的 try-finally 语句，执行 Del key 语句来释放锁，简易流程如下：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="9173"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9174"><span data-slate-object="text" data-key="9175"><span data-slate-leaf="true" data-offset-key="9175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 对资源 key 加锁，key 不存在时创建，并且设置，10 秒自动过期</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9176"><span data-slate-object="text" data-key="9177"><span data-slate-leaf="true" data-offset-key="9177:0" data-first-offset="true"><span data-slate-string="true">SET key value EX </span></span></span><span data-slate-object="text" data-key="9178"><span data-slate-leaf="true" data-offset-key="9178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="9179"><span data-slate-leaf="true" data-offset-key="9179:0" data-first-offset="true"><span data-slate-string="true"> NX</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9180"><span data-slate-object="text" data-key="9181"><span data-slate-leaf="true" data-offset-key="9181:0" data-first-offset="true"><span data-slate-string="true">业务逻辑流程</span></span></span><span data-slate-object="text" data-key="9182"><span data-slate-leaf="true" data-offset-key="9182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 1</span></span></span></span><span data-slate-object="text" data-key="9183"><span data-slate-leaf="true" data-offset-key="9183:0" data-first-offset="true"><span data-slate-string="true">，校验用户身份</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9184"><span data-slate-object="text" data-key="9185"><span data-slate-leaf="true" data-offset-key="9185:0" data-first-offset="true"><span data-slate-string="true">业务逻辑流程</span></span></span><span data-slate-object="text" data-key="9186"><span data-slate-leaf="true" data-offset-key="9186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 2</span></span></span></span><span data-slate-object="text" data-key="9187"><span data-slate-leaf="true" data-offset-key="9187:0" data-first-offset="true"><span data-slate-string="true">，查询并校验库存 (get </span></span></span><span data-slate-object="text" data-key="9188"><span data-slate-leaf="true" data-offset-key="9188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">and</span></span></span></span><span data-slate-object="text" data-key="9189"><span data-slate-leaf="true" data-offset-key="9189:0" data-first-offset="true"><span data-slate-string="true"> compare)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9190"><span data-slate-object="text" data-key="9191"><span data-slate-leaf="true" data-offset-key="9191:0" data-first-offset="true"><span data-slate-string="true">业务逻辑流程</span></span></span><span data-slate-object="text" data-key="9192"><span data-slate-leaf="true" data-offset-key="9192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 3</span></span></span></span><span data-slate-object="text" data-key="9193"><span data-slate-leaf="true" data-offset-key="9193:0" data-first-offset="true"><span data-slate-string="true">，库存 &gt;</span></span></span><span data-slate-object="text" data-key="9194"><span data-slate-leaf="true" data-offset-key="9194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9195"><span data-slate-leaf="true" data-offset-key="9195:0" data-first-offset="true"><span data-slate-string="true">，扣减库存 (Decr stock)，生成秒杀茅台订单</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9196"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9197"><span data-slate-object="text" data-key="9198"><span data-slate-leaf="true" data-offset-key="9198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 释放锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9199"><span data-slate-object="text" data-key="9200"><span data-slate-leaf="true" data-offset-key="9200:0" data-first-offset="true"><span data-slate-string="true">Del key</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9201"><span data-slate-object="text" data-key="9202"><span data-slate-leaf="true" data-offset-key="9202:0" data-first-offset="true"><span data-slate-string="true">以上流程中其实存在以下思考点:</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9203"><div data-slate-type="list-line" data-slate-object="block" data-key="9204"><span data-slate-object="text" data-key="9205"><span data-slate-leaf="true" data-offset-key="9205:0" data-first-offset="true"><span data-slate-string="true">NX 参数有什么作用？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9206"><span data-slate-object="text" data-key="9207"><span data-slate-leaf="true" data-offset-key="9207:0" data-first-offset="true"><span data-slate-string="true">为什么需要原子的设置 key 及过期时间？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9208"><span data-slate-object="text" data-key="9209"><span data-slate-leaf="true" data-offset-key="9209:0" data-first-offset="true"><span data-slate-string="true">为什么基于 Set key value EX 10 NX 命令还出现了超卖呢？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9210"><span data-slate-object="text" data-key="9211"><span data-slate-leaf="true" data-offset-key="9211:0" data-first-offset="true"><span data-slate-string="true">为什么大家都比较喜欢使用 Redis 作为分布式锁实现？</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9212"><span data-slate-object="text" data-key="9213"><span data-slate-leaf="true" data-offset-key="9213:0" data-first-offset="true"><span data-slate-string="true">首先来看第一个问题，NX 参数的作用。NX 参数是为了保证当分布式锁不存在时，只有一个 client 能写入此 key 成功，获取到此锁。我们使用分布式锁的目的就是希望在高并发系统中，有一种互斥机制来防止彼此相互干扰，保证数据的一致性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9214"><span data-slate-object="text" data-key="9215"><span data-slate-leaf="true" data-offset-key="9215:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_18d77a7a" data-attr-id="43277" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">因此分布式锁的第一核心要素就是互斥性、安全性。在同一时间内，不允许多个 client 同时获得锁。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9216"><span data-slate-object="text" data-key="9217"><span data-slate-leaf="true" data-offset-key="9217:0" data-first-offset="true"><span data-slate-string="true">再看第二个问题，假设我们未设置 key 自动过期时间，在 Set key value NX 后，如果程序 crash 或者发生网络分区后无法与 Redis 节点通信，毫无疑问其他 client 将永远无法获得锁。这将导致死锁，服务出现中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9218"><span data-slate-object="text" data-key="9219"><span data-slate-leaf="true" data-offset-key="9219:0" data-first-offset="true"><span data-slate-string="true">有的同学意识到这个问题后，使用如下 SETNX 和 EXPIRE 命令去设置 key 和过期时间，这也是不正确的，因为你无法保证 SETNX 和 EXPIRE 命令的原子性。</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="9220"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9221"><span data-slate-object="text" data-key="9222"><span data-slate-leaf="true" data-offset-key="9222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 对资源 key 加锁，key 不存在时创建</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9223"><span data-slate-object="text" data-key="9224"><span data-slate-leaf="true" data-offset-key="9224:0" data-first-offset="true"><span data-slate-string="true">SETNX key value</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9225"><span data-slate-object="text" data-key="9226"><span data-slate-leaf="true" data-offset-key="9226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 设置 KEY 过期时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9227"><span data-slate-object="text" data-key="9228"><span data-slate-leaf="true" data-offset-key="9228:0" data-first-offset="true"><span data-slate-string="true">EXPIRE key </span></span></span><span data-slate-object="text" data-key="9229"><span data-slate-leaf="true" data-offset-key="9229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9230"><span data-slate-object="text" data-key="9231"><span data-slate-leaf="true" data-offset-key="9231:0" data-first-offset="true"><span data-slate-string="true">业务逻辑流程</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9232"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9233"><span data-slate-object="text" data-key="9234"><span data-slate-leaf="true" data-offset-key="9234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 释放锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9235"><span data-slate-object="text" data-key="9236"><span data-slate-leaf="true" data-offset-key="9236:0" data-first-offset="true"><span data-slate-string="true">Del key</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9237"><span data-slate-object="text" data-key="9238"><span data-slate-leaf="true" data-offset-key="9238:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这就是分布式锁第二个核心要素，活性。在实现分布式锁的过程中要考虑到 client 可能会出现 crash 或者网络分区，你需要原子申请分布式锁及设置锁的自动过期时间，通过过期、超时等机制自动释放锁，避免出现死锁，导致业务中断。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9239"><span data-slate-object="text" data-key="9240"><span data-slate-leaf="true" data-offset-key="9240:0" data-first-offset="true"><span data-slate-string="true">再看第三个问题，为什么使用了 Set key value EX 10 NX 命令，还出现了超卖呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9241"><span data-slate-object="text" data-key="9242"><span data-slate-leaf="true" data-offset-key="9242:0" data-first-offset="true"><span data-slate-string="true">原来是抢购活动开始后，加锁逻辑中的业务流程 1 访问的用户身份服务出现了高负载，导致阻塞在校验用户身份流程中 (超时 30 秒)，然而锁 10 秒后就自动过期了，因此其他 client 能获取到锁。关键是阻塞的请求执行完后，它又把其他 client 的锁释放掉了，导致进入一个恶性循环。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9243"><span data-slate-object="text" data-key="9244"><span data-slate-leaf="true" data-offset-key="9244:0" data-first-offset="true"><span data-slate-string="true">因此申请锁时，写入的 value 应确保唯一性（随机值等）。client 在释放锁时，应通过 Lua 脚本原子校验此锁的 value 与自己写入的 value 一致，若一致才能执行释放工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9245"><span data-slate-object="text" data-key="9246"><span data-slate-leaf="true" data-offset-key="9246:0" data-first-offset="true"><span data-slate-string="true">更关键的是库存校验是通过 get and compare 方式，它压根就无法防止超卖。正确的解决方案应该是通过 LUA 脚本实现 Redis 比较库存、扣减库存操作的原子性（或者在每次只能抢购一个的情况下，通过判断 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9247"><span data-slate-object="text" data-key="9248"><span data-slate-leaf="true" data-offset-key="9248:0" data-first-offset="true"><span data-slate-string="true">Redis Decr 命令</span></span></span></a><span data-slate-object="text" data-key="9249"><span data-slate-leaf="true" data-offset-key="9249:0" data-first-offset="true"><span data-slate-string="true">的返回值即可。此命令会返回扣减后的最新库存，若小于 0 则表示超卖）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9250"><span data-slate-object="text" data-key="9251"><span data-slate-leaf="true" data-offset-key="9251:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">从这个问题中我们可以看到，分布式锁实现具备一定的复杂度，它不仅依赖存储服务提供的核心机制，同时依赖业务领域的实现。无论是遭遇高负载、还是宕机、网络分区等故障，都需确保锁的互斥性、安全性，否则就会出现严重的超卖生产事故。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9252"><span data-slate-object="text" data-key="9253"><span data-slate-leaf="true" data-offset-key="9253:0" data-first-offset="true"><span data-slate-string="true">再看最后一个问题，为什么大家都比较喜欢使用 Redis 做分布式锁的实现呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9254"><span data-slate-object="text" data-key="9255"><span data-slate-leaf="true" data-offset-key="9255:0" data-first-offset="true"><span data-slate-string="true">考虑到在秒杀等业务场景上存在大量的瞬间、高并发请求，加锁与释放锁的过程应是高性能、高可用的。而 Redis 核心优点就是快、简单，是随处可见的基础设施，部署、使用也及其方便，因此广受开发者欢迎。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9256"><span data-slate-object="text" data-key="9257"><span data-slate-leaf="true" data-offset-key="9257:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这就是分布式锁第三个核心要素，高性能、高可用。加锁、释放锁的过程性能开销要尽量低，同时要保证高可用，确保业务不会出现中断。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9258"><span data-slate-object="text" data-key="9259"><span data-slate-leaf="true" data-offset-key="9259:0" data-first-offset="true"><span data-slate-string="true">那么除了以上案例中人为实现问题导致的锁不安全因素外，基于 Redis 实现的以上分布式锁还有哪些安全性问题呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9260" id="sr-toc-2"><span data-slate-object="text" data-key="9261"><span data-slate-leaf="true" data-offset-key="9261:0" data-first-offset="true"><span data-slate-string="true">Redis 分布式锁问题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9262"><span data-slate-object="text" data-key="9263"><span data-slate-leaf="true" data-offset-key="9263:0" data-first-offset="true"><span data-slate-string="true">我们从茅台超卖案例中为你总结出的分布式核心要素（互斥性、安全性、活性、高可用、高性能）说起。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9264"><span data-slate-object="text" data-key="9265"><span data-slate-leaf="true" data-offset-key="9265:0" data-first-offset="true"><span data-slate-string="true">首先，如果我们的分布式锁跑在单节点的 Redis Master 节点上，那么它就存在单点故障，无法保证分布式锁的高可用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9266"><span data-slate-object="text" data-key="9267"><span data-slate-leaf="true" data-offset-key="9267:0" data-first-offset="true"><span data-slate-string="true">于是我们需要一个主备版的 Redis 服务，至少具备一个 Slave 节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9268"><span data-slate-object="text" data-key="9269"><span data-slate-leaf="true" data-offset-key="9269:0" data-first-offset="true"><span data-slate-string="true">我们又知道 Redis 是基于主备异步复制协议实现的 Master-Slave 数据同步，如下图所示，若 client A 执行 SET key value EX 10 NX 命令，redis-server 返回给 client A 成功后，Redis Master 节点突然出现 crash 等异常，这时候 Redis Slave 节点还未收到此命令的同步。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9270"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/cd/45/cd3d4ab1af45c6eb76e7dccd9c666245.png?wh=1920*994"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9271"><span data-slate-object="text" data-key="9272"><span data-slate-leaf="true" data-offset-key="9272:0" data-first-offset="true"><span data-slate-string="true">若你部署了 Redis Sentinel 等主备切换服务，那么它就会以 Slave 节点提升为主，此时 Slave 节点因并未执行 SET key value EX 10 NX 命令，因此它收到 client B 发起的加锁的此命令后，它也会返回成功给 client。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9273"><span data-slate-object="text" data-key="9274"><span data-slate-leaf="true" data-offset-key="9274:0" data-first-offset="true"><span data-slate-string="true">那么在同一时刻，集群就出现了两个 client 同时获得锁，分布式锁的互斥性、安全性就被破坏了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9275"><span data-slate-object="text" data-key="9276"><span data-slate-leaf="true" data-offset-key="9276:0" data-first-offset="true"><span data-slate-string="true">除了主备切换可能会导致基于 Redis 实现的分布式锁出现安全性问题，在发生网络分区等场景下也可能会导致出现脑裂，Redis 集群出现多个 Master，进而也会导致多个 client 同时获得锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9277"><span data-slate-object="text" data-key="9278"><span data-slate-leaf="true" data-offset-key="9278:0" data-first-offset="true"><span data-slate-string="true">如下图所示，Master 节点在可用区 1，Slave 节点在可用区 2，当可用区 1 和可用区 2 发生网络分区后，部署在可用区 2 的 Redis Sentinel 服务就会将可用区 2 的 Slave 提升为 Master，而此时可用区 1 的 Master 也在对外提供服务。因此集群就出现了脑裂，出现了两个 Master，都可对外提供分布式锁申请与释放服务，分布式锁的互斥性被严重破坏。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9279"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/cb/b1/cb4cb52cf2244d2000884ef5f5ff3db1.png?wh=1920*1026"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9280"><span data-slate-object="text" data-key="9281"><span data-slate-leaf="true" data-offset-key="9281:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">主备切换、脑裂是 Redis 分布式锁的两个典型不安全的因素，本质原因是 Redis 为了满足高性能，采用了主备异步复制协议，同时也与负责主备切换的 Redis Sentinel 服务是否合理部署有关。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9282"><span data-slate-object="text" data-key="9283"><span data-slate-leaf="true" data-offset-key="9283:0" data-first-offset="true"><span data-slate-string="true">有没有其他方案解决呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9284"><span data-slate-object="text" data-key="9285"><span data-slate-leaf="true" data-offset-key="9285:0" data-first-offset="true"><span data-slate-string="true">当然有，Redis 作者为了解决 SET key value [EX] 10 [NX] 命令实现分布式锁不安全的问题，提出了 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9286"><span data-slate-object="text" data-key="9287"><span data-slate-leaf="true" data-offset-key="9287:0" data-first-offset="true"><span data-slate-string="true">RedLock 算法</span></span></span></a><span data-slate-object="text" data-key="9288"><span data-slate-leaf="true" data-offset-key="9288:0" data-first-offset="true"><span data-slate-string="true">。它是基于多个独立的 Redis Master 节点的一种实现（一般为 5）。</span></span><span data-slate-leaf="true" data-offset-key="9288:1"><span data-slate-object="annotation" data-annotation-key="gkann_8992f05c" data-attr-id="43120" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">client 依次向各个节点申请锁，若能从多数个节点中申请锁成功并满足一些条件限制，那么 client 就能获取锁成功。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9289"><span data-slate-object="text" data-key="9290"><span data-slate-leaf="true" data-offset-key="9290:0" data-first-offset="true"><span data-slate-string="true">它通过独立的 N 个 Master 节点，避免了使用主备异步复制协议的缺陷，只要多数 Redis 节点正常就能正常工作，显著提升了分布式锁的安全性、可用性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9291"><span data-slate-object="text" data-key="9292"><span data-slate-leaf="true" data-offset-key="9292:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_86b3e804" data-attr-id="36969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">但是，它的实现建立在一个不安全的系统模型上的，它依赖系统时间，当时钟发生跳跃时，也可能会出现安全性问题。你要有兴趣的话，可以详细阅读下分布式存储专家 Martin 对 </span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9293"><span data-slate-object="text" data-key="9294"><span data-slate-leaf="true" data-offset-key="9294:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_86b3e804" data-attr-id="36969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">RedLock 的分析文章</span></span></span></span></a><span data-slate-object="text" data-key="9295"><span data-slate-leaf="true" data-offset-key="9295:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_86b3e804" data-attr-id="36969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，Redis 作者的也专门写了</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9296"><span data-slate-object="text" data-key="9297"><span data-slate-leaf="true" data-offset-key="9297:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_86b3e804" data-attr-id="36969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一篇文章进行了反驳</span></span></span></span></a><span data-slate-object="text" data-key="9298"><span data-slate-leaf="true" data-offset-key="9298:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_86b3e804" data-attr-id="36969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9299" id="sr-toc-3"><span data-slate-object="text" data-key="9300"><span data-slate-leaf="true" data-offset-key="9300:0" data-first-offset="true"><span data-slate-string="true">分布式锁常见实现方案</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9301"><span data-slate-object="text" data-key="9302"><span data-slate-leaf="true" data-offset-key="9302:0" data-first-offset="true"><span data-slate-string="true">了解完 Redis 分布式锁的一系列问题和实现方案后，我们再看看还有哪些典型的分布式锁实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9303"><span data-slate-object="text" data-key="9304"><span data-slate-leaf="true" data-offset-key="9304:0" data-first-offset="true"><span data-slate-string="true">除了 Redis 分布式锁，其他使用最广的应该是 ZooKeeper 分布式锁和 etcd 分布式锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9305"><span data-slate-object="text" data-key="9306"><span data-slate-leaf="true" data-offset-key="9306:0" data-first-offset="true"><span data-slate-string="true">ZooKeeper 也是一个典型的分布式元数据存储服务，它的分布式锁实现基于 ZooKeeper 的临时节点和顺序特性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9307"><span data-slate-object="text" data-key="9308"><span data-slate-leaf="true" data-offset-key="9308:0" data-first-offset="true"><span data-slate-string="true">首先什么是临时节点呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9309"><span data-slate-object="text" data-key="9310"><span data-slate-leaf="true" data-offset-key="9310:0" data-first-offset="true"><span data-slate-string="true">临时节点具备数据自动删除的功能。当 client 与 ZooKeeper 连接和 session 断掉时，相应的临时节点就会被删除。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9311"><span data-slate-object="text" data-key="9312"><span data-slate-leaf="true" data-offset-key="9312:0" data-first-offset="true"><span data-slate-string="true">其次 ZooKeeper 也提供了 Watch 特性可监听 key 的数据变化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9313"><a data-slate-type="link" data-slate-object="inline" data-key="9314"><span data-slate-object="text" data-key="9315"><span data-slate-leaf="true" data-offset-key="9315:0" data-first-offset="true"><span data-slate-string="true">使用 Zookeeper 加锁的伪代码如下</span></span></span></a><span data-slate-object="text" data-key="9316"><span data-slate-leaf="true" data-offset-key="9316:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="9317"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9318"><span data-slate-object="text" data-key="9319"><span data-slate-leaf="true" data-offset-key="9319:0" data-first-offset="true"><span data-slate-string="true">Lock</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9320"><span data-slate-object="text" data-key="9321"><span data-slate-leaf="true" data-offset-key="9321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9322"><span data-slate-leaf="true" data-offset-key="9322:0" data-first-offset="true"><span data-slate-string="true"> n </span></span></span><span data-slate-object="text" data-key="9323"><span data-slate-leaf="true" data-offset-key="9323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="9324"><span data-slate-leaf="true" data-offset-key="9324:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9325"><span data-slate-leaf="true" data-offset-key="9325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">create</span></span></span></span><span data-slate-object="text" data-key="9326"><span data-slate-leaf="true" data-offset-key="9326:0" data-first-offset="true"><span data-slate-string="true">(l </span></span></span><span data-slate-object="text" data-key="9327"><span data-slate-leaf="true" data-offset-key="9327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">+</span></span></span></span><span data-slate-object="text" data-key="9328"><span data-slate-leaf="true" data-offset-key="9328:0" data-first-offset="true"><span data-slate-string="true"> “</span></span></span><span data-slate-object="text" data-key="9329"><span data-slate-leaf="true" data-offset-key="9329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/</span></span></span></span><span data-slate-object="text" data-key="9330"><span data-slate-leaf="true" data-offset-key="9330:0" data-first-offset="true"><span data-slate-string="true">lock</span></span></span><span data-slate-object="text" data-key="9331"><span data-slate-leaf="true" data-offset-key="9331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="9332"><span data-slate-leaf="true" data-offset-key="9332:0" data-first-offset="true"><span data-slate-string="true">”, EPHEMERAL</span></span></span><span data-slate-object="text" data-key="9333"><span data-slate-leaf="true" data-offset-key="9333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|</span></span></span></span><span data-slate-object="text" data-key="9334"><span data-slate-leaf="true" data-offset-key="9334:0" data-first-offset="true"><span data-slate-string="true">SEQUENTIAL)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9335"><span data-slate-object="text" data-key="9336"><span data-slate-leaf="true" data-offset-key="9336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="9337"><span data-slate-leaf="true" data-offset-key="9337:0" data-first-offset="true"><span data-slate-string="true"> C </span></span></span><span data-slate-object="text" data-key="9338"><span data-slate-leaf="true" data-offset-key="9338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="9339"><span data-slate-leaf="true" data-offset-key="9339:0" data-first-offset="true"><span data-slate-string="true"> getChildren(l, </span></span></span><span data-slate-object="text" data-key="9340"><span data-slate-leaf="true" data-offset-key="9340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="9341"><span data-slate-leaf="true" data-offset-key="9341:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9342"><span data-slate-object="text" data-key="9343"><span data-slate-leaf="true" data-offset-key="9343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="9344"><span data-slate-leaf="true" data-offset-key="9344:0" data-first-offset="true"><span data-slate-string="true"> if n </span></span></span><span data-slate-object="text" data-key="9345"><span data-slate-leaf="true" data-offset-key="9345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="9346"><span data-slate-leaf="true" data-offset-key="9346:0" data-first-offset="true"><span data-slate-string="true"> lowest znode </span></span></span><span data-slate-object="text" data-key="9347"><span data-slate-leaf="true" data-offset-key="9347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="9348"><span data-slate-leaf="true" data-offset-key="9348:0" data-first-offset="true"><span data-slate-string="true"> C, exit</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9349"><span data-slate-object="text" data-key="9350"><span data-slate-leaf="true" data-offset-key="9350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="9351"><span data-slate-leaf="true" data-offset-key="9351:0" data-first-offset="true"><span data-slate-string="true"> p </span></span></span><span data-slate-object="text" data-key="9352"><span data-slate-leaf="true" data-offset-key="9352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="9353"><span data-slate-leaf="true" data-offset-key="9353:0" data-first-offset="true"><span data-slate-string="true"> znode </span></span></span><span data-slate-object="text" data-key="9354"><span data-slate-leaf="true" data-offset-key="9354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="9355"><span data-slate-leaf="true" data-offset-key="9355:0" data-first-offset="true"><span data-slate-string="true"> C ordered just before n</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9356"><span data-slate-object="text" data-key="9357"><span data-slate-leaf="true" data-offset-key="9357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="9358"><span data-slate-leaf="true" data-offset-key="9358:0" data-first-offset="true"><span data-slate-string="true"> if </span></span></span><span data-slate-object="text" data-key="9359"><span data-slate-leaf="true" data-offset-key="9359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exists</span></span></span></span><span data-slate-object="text" data-key="9360"><span data-slate-leaf="true" data-offset-key="9360:0" data-first-offset="true"><span data-slate-string="true">(p, </span></span></span><span data-slate-object="text" data-key="9361"><span data-slate-leaf="true" data-offset-key="9361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="9362"><span data-slate-leaf="true" data-offset-key="9362:0" data-first-offset="true"><span data-slate-string="true">) wait </span></span></span><span data-slate-object="text" data-key="9363"><span data-slate-leaf="true" data-offset-key="9363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9364"><span data-slate-leaf="true" data-offset-key="9364:0" data-first-offset="true"><span data-slate-string="true"> watch event</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9365"><span data-slate-object="text" data-key="9366"><span data-slate-leaf="true" data-offset-key="9366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span><span data-slate-object="text" data-key="9367"><span data-slate-leaf="true" data-offset-key="9367:0" data-first-offset="true"><span data-slate-string="true"> goto </span></span></span><span data-slate-object="text" data-key="9368"><span data-slate-leaf="true" data-offset-key="9368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9369"><span data-slate-object="text" data-key="9370"><span data-slate-leaf="true" data-offset-key="9370:0" data-first-offset="true"><span data-slate-string="true">Unlock</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9371"><span data-slate-object="text" data-key="9372"><span data-slate-leaf="true" data-offset-key="9372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9373"><span data-slate-leaf="true" data-offset-key="9373:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9374"><span data-slate-leaf="true" data-offset-key="9374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">delete</span></span></span></span><span data-slate-object="text" data-key="9375"><span data-slate-leaf="true" data-offset-key="9375:0" data-first-offset="true"><span data-slate-string="true">(n)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9376"><span data-slate-object="text" data-key="9377"><span data-slate-leaf="true" data-offset-key="9377:0" data-first-offset="true"><span data-slate-string="true">接下来我重点给你介绍一下基于 etcd 的分布式锁实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9378" id="sr-toc-4"><span data-slate-object="text" data-key="9379"><span data-slate-leaf="true" data-offset-key="9379:0" data-first-offset="true"><span data-slate-string="true">etcd 分布式锁实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9380"><span data-slate-object="text" data-key="9381"><span data-slate-leaf="true" data-offset-key="9381:0" data-first-offset="true"><span data-slate-string="true">那么基于 etcd 实现的分布式锁是如何确保安全性、互斥性、活性的呢？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9382" id="sr-toc-5"><span data-slate-object="text" data-key="9383"><span data-slate-leaf="true" data-offset-key="9383:0" data-first-offset="true"><span data-slate-string="true">事务与锁的安全性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9384"><span data-slate-object="text" data-key="9385"><span data-slate-leaf="true" data-offset-key="9385:0" data-first-offset="true"><span data-slate-string="true">从 Redis 案例中我们可以看到，加锁的过程需要确保安全性、互斥性。比如，当 key 不存在时才能创建，否则查询相关 key 信息，而 etcd 提供的事务能力正好可以满足我们的诉求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9386"><span data-slate-object="text" data-key="9387"><span data-slate-leaf="true" data-offset-key="9387:0" data-first-offset="true"><span data-slate-string="true">正如我在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9388"><span data-slate-object="text" data-key="9389"><span data-slate-leaf="true" data-offset-key="9389:0" data-first-offset="true"><span data-slate-string="true">09</span></span></span></a><span data-slate-object="text" data-key="9390"><span data-slate-leaf="true" data-offset-key="9390:0" data-first-offset="true"><span data-slate-string="true"> 中给你介绍的事务特性，它由 IF 语句、Then 语句、Else 语句组成。其中在 IF 语句中，支持比较 key 的是修改版本号 mod_revision 和创建版本号 create_revision。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9391"><span data-slate-object="text" data-key="9392"><span data-slate-leaf="true" data-offset-key="9392:0" data-first-offset="true"><span data-slate-string="true">在分布式锁场景，你就可以通过 key 的创建版本号 create_revision 来检查 key 是否已存在，因为一个 key 不存在的话，它的 create_revision 版本号就是 0。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9393"><span data-slate-object="text" data-key="9394"><span data-slate-leaf="true" data-offset-key="9394:0" data-first-offset="true"><span data-slate-string="true">若 create_revision 是 0，你就可发起 put 操作创建相关 key，具体代码如下:</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="9395"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9396"><span data-slate-object="text" data-key="9397"><span data-slate-leaf="true" data-offset-key="9397:0" data-first-offset="true"><span data-slate-string="true">txn := client.</span></span></span><span data-slate-object="text" data-key="9398"><span data-slate-leaf="true" data-offset-key="9398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Txn</span></span></span></span><span data-slate-object="text" data-key="9399"><span data-slate-leaf="true" data-offset-key="9399:0" data-first-offset="true"><span data-slate-string="true">(ctx).</span></span></span><span data-slate-object="text" data-key="9400"><span data-slate-leaf="true" data-offset-key="9400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">If</span></span></span></span><span data-slate-object="text" data-key="9401"><span data-slate-leaf="true" data-offset-key="9401:0" data-first-offset="true"><span data-slate-string="true">(v3.</span></span></span><span data-slate-object="text" data-key="9402"><span data-slate-leaf="true" data-offset-key="9402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Compare</span></span></span></span><span data-slate-object="text" data-key="9403"><span data-slate-leaf="true" data-offset-key="9403:0" data-first-offset="true"><span data-slate-string="true">(v3.</span></span></span><span data-slate-object="text" data-key="9404"><span data-slate-leaf="true" data-offset-key="9404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CreateRevision</span></span></span></span><span data-slate-object="text" data-key="9405"><span data-slate-leaf="true" data-offset-key="9405:0" data-first-offset="true"><span data-slate-string="true">(k), </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9406"><span data-slate-object="text" data-key="9407"><span data-slate-leaf="true" data-offset-key="9407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"="</span></span></span></span><span data-slate-object="text" data-key="9408"><span data-slate-leaf="true" data-offset-key="9408:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9409"><span data-slate-leaf="true" data-offset-key="9409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9410"><span data-slate-leaf="true" data-offset-key="9410:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9411"><span data-slate-object="text" data-key="9412"><span data-slate-leaf="true" data-offset-key="9412:0" data-first-offset="true"><span data-slate-string="true">你要注意的是，实现分布式锁的方案有多种，比如你可以通过 client 是否成功创建一个固定的 key，来判断此 client 是否获得锁，你也可以通过多个 client 创建 prefix 相同，名称不一样的 key，哪个 key 的 revision 最小，最终就是它获得锁。至于谁优谁劣，我作为思考题的一部分，留给大家一起讨论。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9413"><span data-slate-object="text" data-key="9414"><span data-slate-leaf="true" data-offset-key="9414:0" data-first-offset="true"><span data-slate-string="true">相比 Redis 基于主备异步复制导致锁的安全性问题，etcd 是基于 Raft 共识算法实现的，一个写请求需要经过集群多数节点确认。因此一旦分布式锁申请返回给 client 成功后，它一定是持久化到了集群多数节点上，不会出现 Redis 主备异步复制可能导致丢数据的问题，具备更高的安全性。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9415" id="sr-toc-6"><span data-slate-object="text" data-key="9416"><span data-slate-leaf="true" data-offset-key="9416:0" data-first-offset="true"><span data-slate-string="true">Lease 与锁的活性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9417"><span data-slate-object="text" data-key="9418"><span data-slate-leaf="true" data-offset-key="9418:0" data-first-offset="true"><span data-slate-string="true">通过事务实现原子的检查 key 是否存在、创建 key 后，我们确保了分布式锁的安全性、互斥性。那么 etcd 是如何确保锁的活性呢？也就是发生任何故障，都可避免出现死锁呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9419"><span data-slate-object="text" data-key="9420"><span data-slate-leaf="true" data-offset-key="9420:0" data-first-offset="true"><span data-slate-string="true">正如在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9421"><span data-slate-object="text" data-key="9422"><span data-slate-leaf="true" data-offset-key="9422:0" data-first-offset="true"><span data-slate-string="true">06</span></span></span></a><span data-slate-object="text" data-key="9423"><span data-slate-leaf="true" data-offset-key="9423:0" data-first-offset="true"><span data-slate-string="true"> 租约特性中和你介绍的，Lease 就是一种活性检测机制，它提供了检测各个客户端存活的能力。你的业务 client 需定期向 etcd 服务发送 "特殊心跳" 汇报健康状态，若你未正常发送心跳，并超过和 etcd 服务约定的最大存活时间后，就会被 etcd 服务移除此 Lease 和其关联的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9424"><span data-slate-object="text" data-key="9425"><span data-slate-leaf="true" data-offset-key="9425:0" data-first-offset="true"><span data-slate-string="true">通过 Lease 机制就优雅地解决了 client 出现 crash 故障、client 与 etcd 集群网络出现隔离等各类故障场景下的死锁问题。一旦超过 Lease TTL，它就能自动被释放，确保了其他 client 在 TTL 过期后能正常申请锁，保障了业务的可用性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9426"><span data-slate-object="text" data-key="9427"><span data-slate-leaf="true" data-offset-key="9427:0" data-first-offset="true"><span data-slate-string="true">具体代码如下:</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="9428"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9429"><span data-slate-object="text" data-key="9430"><span data-slate-leaf="true" data-offset-key="9430:0" data-first-offset="true"><span data-slate-string="true">txn := client.</span></span></span><span data-slate-object="text" data-key="9431"><span data-slate-leaf="true" data-offset-key="9431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Txn</span></span></span></span><span data-slate-object="text" data-key="9432"><span data-slate-leaf="true" data-offset-key="9432:0" data-first-offset="true"><span data-slate-string="true">(ctx).</span></span></span><span data-slate-object="text" data-key="9433"><span data-slate-leaf="true" data-offset-key="9433:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">If</span></span></span></span><span data-slate-object="text" data-key="9434"><span data-slate-leaf="true" data-offset-key="9434:0" data-first-offset="true"><span data-slate-string="true">(v3.</span></span></span><span data-slate-object="text" data-key="9435"><span data-slate-leaf="true" data-offset-key="9435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Compare</span></span></span></span><span data-slate-object="text" data-key="9436"><span data-slate-leaf="true" data-offset-key="9436:0" data-first-offset="true"><span data-slate-string="true">(v3.</span></span></span><span data-slate-object="text" data-key="9437"><span data-slate-leaf="true" data-offset-key="9437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CreateRevision</span></span></span></span><span data-slate-object="text" data-key="9438"><span data-slate-leaf="true" data-offset-key="9438:0" data-first-offset="true"><span data-slate-string="true">(k), </span></span></span><span data-slate-object="text" data-key="9439"><span data-slate-leaf="true" data-offset-key="9439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"="</span></span></span></span><span data-slate-object="text" data-key="9440"><span data-slate-leaf="true" data-offset-key="9440:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9441"><span data-slate-leaf="true" data-offset-key="9441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9442"><span data-slate-leaf="true" data-offset-key="9442:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9443"><span data-slate-object="text" data-key="9444"><span data-slate-leaf="true" data-offset-key="9444:0" data-first-offset="true"><span data-slate-string="true">txn = txn.</span></span></span><span data-slate-object="text" data-key="9445"><span data-slate-leaf="true" data-offset-key="9445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Then</span></span></span></span><span data-slate-object="text" data-key="9446"><span data-slate-leaf="true" data-offset-key="9446:0" data-first-offset="true"><span data-slate-string="true">(v3.</span></span></span><span data-slate-object="text" data-key="9447"><span data-slate-leaf="true" data-offset-key="9447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OpPut</span></span></span></span><span data-slate-object="text" data-key="9448"><span data-slate-leaf="true" data-offset-key="9448:0" data-first-offset="true"><span data-slate-string="true">(k, val, v3.</span></span></span><span data-slate-object="text" data-key="9449"><span data-slate-leaf="true" data-offset-key="9449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WithLease</span></span></span></span><span data-slate-object="text" data-key="9450"><span data-slate-leaf="true" data-offset-key="9450:0" data-first-offset="true"><span data-slate-string="true">(s.</span></span></span><span data-slate-object="text" data-key="9451"><span data-slate-leaf="true" data-offset-key="9451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Lease</span></span></span></span><span data-slate-object="text" data-key="9452"><span data-slate-leaf="true" data-offset-key="9452:0" data-first-offset="true"><span data-slate-string="true">())))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9453"><span data-slate-object="text" data-key="9454"><span data-slate-leaf="true" data-offset-key="9454:0" data-first-offset="true"><span data-slate-string="true">txn = txn.</span></span></span><span data-slate-object="text" data-key="9455"><span data-slate-leaf="true" data-offset-key="9455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Else</span></span></span></span><span data-slate-object="text" data-key="9456"><span data-slate-leaf="true" data-offset-key="9456:0" data-first-offset="true"><span data-slate-string="true">(v3.</span></span></span><span data-slate-object="text" data-key="9457"><span data-slate-leaf="true" data-offset-key="9457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OpGet</span></span></span></span><span data-slate-object="text" data-key="9458"><span data-slate-leaf="true" data-offset-key="9458:0" data-first-offset="true"><span data-slate-string="true">(k))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9459"><span data-slate-object="text" data-key="9460"><span data-slate-leaf="true" data-offset-key="9460:0" data-first-offset="true"><span data-slate-string="true">resp, err := txn.</span></span></span><span data-slate-object="text" data-key="9461"><span data-slate-leaf="true" data-offset-key="9461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Commit</span></span></span></span><span data-slate-object="text" data-key="9462"><span data-slate-leaf="true" data-offset-key="9462:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9463"><span data-slate-object="text" data-key="9464"><span data-slate-leaf="true" data-offset-key="9464:0" data-first-offset="true"><span data-slate-string="true">if err != nil {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9465"><span data-slate-object="text" data-key="9466"><span data-slate-leaf="true" data-offset-key="9466:0" data-first-offset="true"><span data-slate-string="true">    return err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9467"><span data-slate-object="text" data-key="9468"><span data-slate-leaf="true" data-offset-key="9468:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9469" id="sr-toc-7"><span data-slate-object="text" data-key="9470"><span data-slate-leaf="true" data-offset-key="9470:0" data-first-offset="true"><span data-slate-string="true">Watch 与锁的可用性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9471"><span data-slate-object="text" data-key="9472"><span data-slate-leaf="true" data-offset-key="9472:0" data-first-offset="true"><span data-slate-string="true">当一个持有锁的 client crash 故障后，其他 client 如何快速感知到此锁失效了，快速获得锁呢，最大程度降低锁的不可用时间呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9473"><span data-slate-object="text" data-key="9474"><span data-slate-leaf="true" data-offset-key="9474:0" data-first-offset="true"><span data-slate-string="true">答案是 Watch 特性。正如在 08 Watch 特性中和你介绍的，Watch 提供了高效的数据监听能力。当其他 client 收到 Watch Delete 事件后，就可快速判断自己是否有资格获得锁，极大减少了锁的不可用时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9475"><span data-slate-object="text" data-key="9476"><span data-slate-leaf="true" data-offset-key="9476:0" data-first-offset="true"><span data-slate-string="true">具体代码如下所示：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9477"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9478"><span data-slate-object="text" data-key="9479"><span data-slate-leaf="true" data-offset-key="9479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9480"><span data-slate-leaf="true" data-offset-key="9480:0" data-first-offset="true"><span data-slate-string="true"> wr v3.WatchResponse</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9481"><span data-slate-object="text" data-key="9482"><span data-slate-leaf="true" data-offset-key="9482:0" data-first-offset="true"><span data-slate-string="true">wch := client.Watch(cctx, key, v3.WithRev(rev))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9483"><span data-slate-object="text" data-key="9484"><span data-slate-leaf="true" data-offset-key="9484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9485"><span data-slate-leaf="true" data-offset-key="9485:0" data-first-offset="true"><span data-slate-string="true"> wr = </span></span></span><span data-slate-object="text" data-key="9486"><span data-slate-leaf="true" data-offset-key="9486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="9487"><span data-slate-leaf="true" data-offset-key="9487:0" data-first-offset="true"><span data-slate-string="true"> wch {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9488"><span data-slate-object="text" data-key="9489"><span data-slate-leaf="true" data-offset-key="9489:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="9490"><span data-slate-leaf="true" data-offset-key="9490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9491"><span data-slate-leaf="true" data-offset-key="9491:0" data-first-offset="true"><span data-slate-string="true"> _, ev := </span></span></span><span data-slate-object="text" data-key="9492"><span data-slate-leaf="true" data-offset-key="9492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="9493"><span data-slate-leaf="true" data-offset-key="9493:0" data-first-offset="true"><span data-slate-string="true"> wr.Events {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9494"><span data-slate-object="text" data-key="9495"><span data-slate-leaf="true" data-offset-key="9495:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="9496"><span data-slate-leaf="true" data-offset-key="9496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9497"><span data-slate-leaf="true" data-offset-key="9497:0" data-first-offset="true"><span data-slate-string="true"> ev.Type == mvccpb.DELETE {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9498"><span data-slate-object="text" data-key="9499"><span data-slate-leaf="true" data-offset-key="9499:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="9500"><span data-slate-leaf="true" data-offset-key="9500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9501"><span data-slate-leaf="true" data-offset-key="9501:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9502"><span data-slate-leaf="true" data-offset-key="9502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9503"><span data-slate-object="text" data-key="9504"><span data-slate-leaf="true" data-offset-key="9504:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9505"><span data-slate-object="text" data-key="9506"><span data-slate-leaf="true" data-offset-key="9506:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9507"><span data-slate-object="text" data-key="9508"><span data-slate-leaf="true" data-offset-key="9508:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9509" id="sr-toc-8"><span data-slate-object="text" data-key="9510"><span data-slate-leaf="true" data-offset-key="9510:0" data-first-offset="true"><span data-slate-string="true">etcd 自带的 concurrency 包</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9511"><span data-slate-object="text" data-key="9512"><span data-slate-leaf="true" data-offset-key="9512:0" data-first-offset="true"><span data-slate-string="true">为了帮助你简化分布式锁、分布式选举、分布式事务的实现，etcd 社区提供了一个名为 concurrency 包帮助你更简单、正确地使用分布式锁、分布式选举。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9513"><span data-slate-object="text" data-key="9514"><span data-slate-leaf="true" data-offset-key="9514:0" data-first-offset="true"><span data-slate-string="true">下面我简单为你介绍下分布式锁 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9515"><span data-slate-object="text" data-key="9516"><span data-slate-leaf="true" data-offset-key="9516:0" data-first-offset="true"><span data-slate-string="true">concurrency</span></span></span></a><span data-slate-object="text" data-key="9517"><span data-slate-leaf="true" data-offset-key="9517:0" data-first-offset="true"><span data-slate-string="true"> 包的使用和实现，它的使用非常简单，如下代码所示，核心流程如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9518"><div data-slate-type="list-line" data-slate-object="block" data-key="9519"><span data-slate-object="text" data-key="9520"><span data-slate-leaf="true" data-offset-key="9520:0" data-first-offset="true"><span data-slate-string="true">首先通过 concurrency.NewSession 方法创建 Session，本质是创建了一个 TTL 为 10 的 Lease。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9521"><span data-slate-object="text" data-key="9522"><span data-slate-leaf="true" data-offset-key="9522:0" data-first-offset="true"><span data-slate-string="true">其次得到 session 对象后，通过 concurrency.NewMutex 创建了一个 mutex 对象，包含 Lease、key prefix 等信息。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9523"><span data-slate-object="text" data-key="9524"><span data-slate-leaf="true" data-offset-key="9524:0" data-first-offset="true"><span data-slate-string="true">然后通过 mutex 对象的 Lock 方法尝试获取锁。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9525"><span data-slate-object="text" data-key="9526"><span data-slate-leaf="true" data-offset-key="9526:0" data-first-offset="true"><span data-slate-string="true">最后使用结束，可通过 mutex 对象的 Unlock 方法释放锁。</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9527"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9528"><span data-slate-object="text" data-key="9529"><span data-slate-leaf="true" data-offset-key="9529:0" data-first-offset="true"><span data-slate-string="true">cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9530"><span data-slate-object="text" data-key="9531"><span data-slate-leaf="true" data-offset-key="9531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9532"><span data-slate-leaf="true" data-offset-key="9532:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="9533"><span data-slate-leaf="true" data-offset-key="9533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9534"><span data-slate-leaf="true" data-offset-key="9534:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9535"><span data-slate-object="text" data-key="9536"><span data-slate-leaf="true" data-offset-key="9536:0" data-first-offset="true"><span data-slate-string="true">   log.Fatal(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9537"><span data-slate-object="text" data-key="9538"><span data-slate-leaf="true" data-offset-key="9538:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9539"><span data-slate-object="text" data-key="9540"><span data-slate-leaf="true" data-offset-key="9540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9541"><span data-slate-leaf="true" data-offset-key="9541:0" data-first-offset="true"><span data-slate-string="true"> cli.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9542"><span data-slate-object="text" data-key="9543"><span data-slate-leaf="true" data-offset-key="9543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// create two separate sessions for lock competition</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9544"><span data-slate-object="text" data-key="9545"><span data-slate-leaf="true" data-offset-key="9545:0" data-first-offset="true"><span data-slate-string="true">s1, err := concurrency.NewSession(cli, concurrency.WithTTL(</span></span></span><span data-slate-object="text" data-key="9546"><span data-slate-leaf="true" data-offset-key="9546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="9547"><span data-slate-leaf="true" data-offset-key="9547:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9548"><span data-slate-object="text" data-key="9549"><span data-slate-leaf="true" data-offset-key="9549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9550"><span data-slate-leaf="true" data-offset-key="9550:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="9551"><span data-slate-leaf="true" data-offset-key="9551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9552"><span data-slate-leaf="true" data-offset-key="9552:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9553"><span data-slate-object="text" data-key="9554"><span data-slate-leaf="true" data-offset-key="9554:0" data-first-offset="true"><span data-slate-string="true">   log.Fatal(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9555"><span data-slate-object="text" data-key="9556"><span data-slate-leaf="true" data-offset-key="9556:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9557"><span data-slate-object="text" data-key="9558"><span data-slate-leaf="true" data-offset-key="9558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9559"><span data-slate-leaf="true" data-offset-key="9559:0" data-first-offset="true"><span data-slate-string="true"> s1.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9560"><span data-slate-object="text" data-key="9561"><span data-slate-leaf="true" data-offset-key="9561:0" data-first-offset="true"><span data-slate-string="true">m1 := concurrency.NewMutex(s1, </span></span></span><span data-slate-object="text" data-key="9562"><span data-slate-leaf="true" data-offset-key="9562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/my-lock/"</span></span></span></span><span data-slate-object="text" data-key="9563"><span data-slate-leaf="true" data-offset-key="9563:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9564"><span data-slate-object="text" data-key="9565"><span data-slate-leaf="true" data-offset-key="9565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// acquire lock for s1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9566"><span data-slate-object="text" data-key="9567"><span data-slate-leaf="true" data-offset-key="9567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9568"><span data-slate-leaf="true" data-offset-key="9568:0" data-first-offset="true"><span data-slate-string="true"> err := m1.Lock(context.TODO()); err != </span></span></span><span data-slate-object="text" data-key="9569"><span data-slate-leaf="true" data-offset-key="9569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9570"><span data-slate-leaf="true" data-offset-key="9570:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9571"><span data-slate-object="text" data-key="9572"><span data-slate-leaf="true" data-offset-key="9572:0" data-first-offset="true"><span data-slate-string="true">   log.Fatal(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9573"><span data-slate-object="text" data-key="9574"><span data-slate-leaf="true" data-offset-key="9574:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9575"><span data-slate-object="text" data-key="9576"><span data-slate-leaf="true" data-offset-key="9576:0" data-first-offset="true"><span data-slate-string="true">fmt.Println(</span></span></span><span data-slate-object="text" data-key="9577"><span data-slate-leaf="true" data-offset-key="9577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"acquired lock for s1"</span></span></span></span><span data-slate-object="text" data-key="9578"><span data-slate-leaf="true" data-offset-key="9578:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9579"><span data-slate-object="text" data-key="9580"><span data-slate-leaf="true" data-offset-key="9580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9581"><span data-slate-leaf="true" data-offset-key="9581:0" data-first-offset="true"><span data-slate-string="true"> err := m1.Unlock(context.TODO()); err != </span></span></span><span data-slate-object="text" data-key="9582"><span data-slate-leaf="true" data-offset-key="9582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9583"><span data-slate-leaf="true" data-offset-key="9583:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9584"><span data-slate-object="text" data-key="9585"><span data-slate-leaf="true" data-offset-key="9585:0" data-first-offset="true"><span data-slate-string="true">   log.Fatal(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9586"><span data-slate-object="text" data-key="9587"><span data-slate-leaf="true" data-offset-key="9587:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9588"><span data-slate-object="text" data-key="9589"><span data-slate-leaf="true" data-offset-key="9589:0" data-first-offset="true"><span data-slate-string="true">fmt.Println(</span></span></span><span data-slate-object="text" data-key="9590"><span data-slate-leaf="true" data-offset-key="9590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"released lock for s1"</span></span></span></span><span data-slate-object="text" data-key="9591"><span data-slate-leaf="true" data-offset-key="9591:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9592"><span data-slate-object="text" data-key="9593"><span data-slate-leaf="true" data-offset-key="9593:0" data-first-offset="true"><span data-slate-string="true">那么 mutex 对象的 Lock 方法是如何加锁的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9594"><span data-slate-object="text" data-key="9595"><span data-slate-leaf="true" data-offset-key="9595:0" data-first-offset="true"><span data-slate-string="true">核心还是使用了我们上面介绍的事务和 Lease 特性，当 CreateRevision 为 0 时，它会创建一个 prefix 为 /my-lock 的 key（ /my-lock + LeaseID)，并获取到 /my-lock prefix 下面最早创建的一个 key（revision 最小），分布式锁最终是由写入此 key 的 client 获得，其他 client 则进入等待模式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9596"><span data-slate-object="text" data-key="9597"><span data-slate-leaf="true" data-offset-key="9597:0" data-first-offset="true"><span data-slate-string="true">详细代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9598"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9599"><span data-slate-object="text" data-key="9600"><span data-slate-leaf="true" data-offset-key="9600:0" data-first-offset="true"><span data-slate-string="true">m.myKey = fmt.Sprintf(</span></span></span><span data-slate-object="text" data-key="9601"><span data-slate-leaf="true" data-offset-key="9601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"%s%x"</span></span></span></span><span data-slate-object="text" data-key="9602"><span data-slate-leaf="true" data-offset-key="9602:0" data-first-offset="true"><span data-slate-string="true">, m.pfx, s.Lease())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9603"><span data-slate-object="text" data-key="9604"><span data-slate-leaf="true" data-offset-key="9604:0" data-first-offset="true"><span data-slate-string="true">cmp := v3.Compare(v3.CreateRevision(m.myKey), </span></span></span><span data-slate-object="text" data-key="9605"><span data-slate-leaf="true" data-offset-key="9605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"="</span></span></span></span><span data-slate-object="text" data-key="9606"><span data-slate-leaf="true" data-offset-key="9606:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9607"><span data-slate-leaf="true" data-offset-key="9607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9608"><span data-slate-leaf="true" data-offset-key="9608:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9609"><span data-slate-object="text" data-key="9610"><span data-slate-leaf="true" data-offset-key="9610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// put self in lock waiters via myKey; oldest waiter holds lock</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9611"><span data-slate-object="text" data-key="9612"><span data-slate-leaf="true" data-offset-key="9612:0" data-first-offset="true"><span data-slate-string="true">put := v3.OpPut(m.myKey, </span></span></span><span data-slate-object="text" data-key="9613"><span data-slate-leaf="true" data-offset-key="9613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="9614"><span data-slate-leaf="true" data-offset-key="9614:0" data-first-offset="true"><span data-slate-string="true">, v3.WithLease(s.Lease()))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9615"><span data-slate-object="text" data-key="9616"><span data-slate-leaf="true" data-offset-key="9616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// reuse key in case this session already holds the lock</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9617"><span data-slate-object="text" data-key="9618"><span data-slate-leaf="true" data-offset-key="9618:0" data-first-offset="true"><span data-slate-string="true">get := v3.OpGet(m.myKey)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9619"><span data-slate-object="text" data-key="9620"><span data-slate-leaf="true" data-offset-key="9620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// fetch current holder to complete uncontended path with only one RPC</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9621"><span data-slate-object="text" data-key="9622"><span data-slate-leaf="true" data-offset-key="9622:0" data-first-offset="true"><span data-slate-string="true">getOwner := v3.OpGet(m.pfx, v3.WithFirstCreate()...)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9623"><span data-slate-object="text" data-key="9624"><span data-slate-leaf="true" data-offset-key="9624:0" data-first-offset="true"><span data-slate-string="true">resp, err := client.Txn(ctx).If(cmp).Then(put, getOwner).Else(get, getOwner).Commit()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9625"><span data-slate-object="text" data-key="9626"><span data-slate-leaf="true" data-offset-key="9626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9627"><span data-slate-leaf="true" data-offset-key="9627:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="9628"><span data-slate-leaf="true" data-offset-key="9628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9629"><span data-slate-leaf="true" data-offset-key="9629:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9630"><span data-slate-object="text" data-key="9631"><span data-slate-leaf="true" data-offset-key="9631:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="9632"><span data-slate-leaf="true" data-offset-key="9632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9633"><span data-slate-leaf="true" data-offset-key="9633:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9634"><span data-slate-object="text" data-key="9635"><span data-slate-leaf="true" data-offset-key="9635:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9636"><span data-slate-object="text" data-key="9637"><span data-slate-leaf="true" data-offset-key="9637:0" data-first-offset="true"><span data-slate-string="true">那未获得锁的 client 是如何等待的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9638"><span data-slate-object="text" data-key="9639"><span data-slate-leaf="true" data-offset-key="9639:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1ba77913" data-attr-id="37362" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">答案是通过 Watch 机制各自监听 prefix 相同，revision 比自己小的 key，因为只有 revision 比自己小的 key 释放锁，我才能有机会，获得锁，</span></span></span><span data-slate-leaf="true" data-offset-key="9639:1"><span data-slate-string="true">如下代码所示，其中 waitDelete 会使用我们上面的介绍的 Watch 去监听比自己小的 key，详细代码可参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9640"><span data-slate-object="text" data-key="9641"><span data-slate-leaf="true" data-offset-key="9641:0" data-first-offset="true"><span data-slate-string="true">concurrency mutex</span></span></span></a><span data-slate-object="text" data-key="9642"><span data-slate-leaf="true" data-offset-key="9642:0" data-first-offset="true"><span data-slate-string="true"> 的实现。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9643"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9644"><span data-slate-object="text" data-key="9645"><span data-slate-leaf="true" data-offset-key="9645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// wait for deletion revisions prior to myKey</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9646"><span data-slate-object="text" data-key="9647"><span data-slate-leaf="true" data-offset-key="9647:0" data-first-offset="true"><span data-slate-string="true">hdr, werr := waitDeletes(ctx, client, m.pfx, m.myRev</span></span></span><span data-slate-object="text" data-key="9648"><span data-slate-leaf="true" data-offset-key="9648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="9649"><span data-slate-leaf="true" data-offset-key="9649:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9650"><span data-slate-object="text" data-key="9651"><span data-slate-leaf="true" data-offset-key="9651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// release lock key if wait failed</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9652"><span data-slate-object="text" data-key="9653"><span data-slate-leaf="true" data-offset-key="9653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9654"><span data-slate-leaf="true" data-offset-key="9654:0" data-first-offset="true"><span data-slate-string="true"> werr != </span></span></span><span data-slate-object="text" data-key="9655"><span data-slate-leaf="true" data-offset-key="9655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9656"><span data-slate-leaf="true" data-offset-key="9656:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9657"><span data-slate-object="text" data-key="9658"><span data-slate-leaf="true" data-offset-key="9658:0" data-first-offset="true"><span data-slate-string="true">   m.Unlock(client.Ctx())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9659"><span data-slate-object="text" data-key="9660"><span data-slate-leaf="true" data-offset-key="9660:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="9661"><span data-slate-leaf="true" data-offset-key="9661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="9662"><span data-slate-leaf="true" data-offset-key="9662:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9663"><span data-slate-object="text" data-key="9664"><span data-slate-leaf="true" data-offset-key="9664:0" data-first-offset="true"><span data-slate-string="true">   m.hdr = hdr</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9665"><span data-slate-object="text" data-key="9666"><span data-slate-leaf="true" data-offset-key="9666:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9667" id="sr-toc-9"><span data-slate-object="text" data-key="9668"><span data-slate-leaf="true" data-offset-key="9668:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9669"><span data-slate-object="text" data-key="9670"><span data-slate-leaf="true" data-offset-key="9670:0" data-first-offset="true"><span data-slate-string="true">最后我们来小结下今天的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9671"><span data-slate-object="text" data-key="9672"><span data-slate-leaf="true" data-offset-key="9672:0" data-first-offset="true"><span data-slate-string="true">今天我通过一个 Redis 分布式锁实现问题 —— 茅台超卖案例，给你介绍了分布式锁的三个主要核心要素，它们分别如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9673"><div data-slate-type="list-line" data-slate-object="block" data-key="9674"><span data-slate-object="text" data-key="9675"><span data-slate-leaf="true" data-offset-key="9675:0" data-first-offset="true"><span data-slate-string="true">安全性、互斥性。在同一时间内，不允许多个 client 同时获得锁。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9676"><span data-slate-object="text" data-key="9677"><span data-slate-leaf="true" data-offset-key="9677:0" data-first-offset="true"><span data-slate-string="true">活性。无论 client 出现 crash 还是遭遇网络分区，你都需要确保任意故障场景下，都不会出现死锁，常用的解决方案是超时和自动过期机制。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9678"><span data-slate-object="text" data-key="9679"><span data-slate-leaf="true" data-offset-key="9679:0" data-first-offset="true"><span data-slate-string="true">高可用、高性能。加锁、释放锁的过程性能开销要尽量低，同时要保证高可用，避免单点故障。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9680"><span data-slate-object="text" data-key="9681"><span data-slate-leaf="true" data-offset-key="9681:0" data-first-offset="true"><span data-slate-string="true">随后我通过这个案例，继续和你分析了 Redis SET 命令创建分布式锁的安全性问题。单 Redis Master 节点存在单点故障，一主多备 Redis 实例又因为 Redis 主备异步复制，当 Master 节点发生 crash 时，可能会导致同时多个 client 持有分布式锁，违反了锁的安全性问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9682"><span data-slate-object="text" data-key="9683"><span data-slate-leaf="true" data-offset-key="9683:0" data-first-offset="true"><span data-slate-string="true">为了优化以上问题，Redis 作者提出了 RedLock 分布式锁，它基于多个独立的 Redis Master 节点工作，只要一半以上节点存活就能正常工作，同时不依赖 Redis 主备异步复制，具有良好的安全性、高可用性。然而它的实现依赖于系统时间，当发生时钟跳变的时候，也会出现安全性问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9684"><span data-slate-object="text" data-key="9685"><span data-slate-leaf="true" data-offset-key="9685:0" data-first-offset="true"><span data-slate-string="true">最后我和你重点介绍了 etcd 的分布式锁实现过程中的一些技术点。它通过 etcd 事务机制，校验 CreateRevision 为 0 才能写入相关 key。若多个 client 同时申请锁，则 client 通过比较各个 key 的 revision 大小，判断是否获得锁，确保了锁的安全性、互斥性。通过 Lease 机制确保了锁的活性，无论 client 发生 crash 还是网络分区，都能保证不会出现死锁。通过 Watch 机制使其他 client 能快速感知到原 client 持有的锁已释放，提升了锁的可用性。最重要的是 etcd 是基于 Raft 协议实现的高可靠、强一致存储，正常情况下，不存在 Redis 主备异步复制协议导致的数据丢失问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9686" id="sr-toc-10"><span data-slate-object="text" data-key="9687"><span data-slate-leaf="true" data-offset-key="9687:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9688"><span data-slate-object="text" data-key="9689"><span data-slate-leaf="true" data-offset-key="9689:0" data-first-offset="true"><span data-slate-string="true">这节课到这里也就结束了，最后我给你留了两个思考题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9690"><span data-slate-object="text" data-key="9691"><span data-slate-leaf="true" data-offset-key="9691:0" data-first-offset="true"><span data-slate-string="true">第一，死锁、脑裂、惊群效应是分布式锁的核心问题，你知道它们各自是怎么一回事吗？ZooKeeper 和 etcd 是如何应对这些问题的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9692"><span data-slate-object="text" data-key="9693"><span data-slate-leaf="true" data-offset-key="9693:0" data-first-offset="true"><span data-slate-string="true">第二，若你锁设置的 10 秒，如果你的某业务进程抢锁成功后，执行可能会超过 10 秒才成功，在这过程中如何避免锁被自动释放而出现的安全性问题呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9694"><span data-slate-object="text" data-key="9695"><span data-slate-leaf="true" data-offset-key="9695:0" data-first-offset="true"><span data-slate-string="true">感谢你的阅读，也欢迎你把这篇文章分享给更多的朋友一起阅读。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>10</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-11">精选留言 (14)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/9d/84/171b2221.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>jeffery</span></div></div><div>老师太厉害了👍etcd 和 redis 分析的太太透彻了！终于明白了 etcd 和 redis 锁的区别了……. 专栏快接近尾声了…… 真有点不舍！</div><div><p>作者回复：赞 jeffery 一直坚持不懈的学习，感谢认可，专栏虽即将结束，但学习与探索未知领域从未有终点，后面有什么有趣的案例、新的体会，我也会通过专栏、微信公众号、博客等各种渠道与大家一起分享交流！</p></div><div><div>2021-03-10</div><div><div><i></i></div><div><i></i><span>21</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 那时刻</span></div></div><div>老师文中提到的思考题，多个 client 抢同一把锁与多个 client 各自抢自己的锁。我的想法是多个 client 抢同一把锁，在 client 数目多的时候，同一把锁的竞争比较激烈。而多个 client 各自抢各自的锁，会有锁饥饿问题，比如新的 client 因其 version 比较小，更容易获得锁。

</div><div><p>作者回复：赞，我补充一点，多个 client 通过写同 key 抢同把锁，主要有惊群效应，同时获取锁性能也低点，毕竟是需要实时写入相关 key 的，而后者，revision 是按时间全局递增的，因此新的 client 写入的 key revision 会比较大，拿锁的顺序可以理解为按时间顺序排队。 </p></div><div><div>2021-03-10</div><div><div><i></i></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/ib3Rzem884S5MOS96THy0gQXcF26PNsnRBpyr3pM5rVibZdYvAibpVvAGfibF1ddpgrteg9fQUsq4vce9EM95Jj97Q/132"></div></div><div><div><div><span>Geek_604077</span></div></div><div>死锁、脑裂、惊群效应是分布式锁的核心问题，你知道它们各自是怎么一回事吗？ZooKeeper 和 etcd 是如何应对这些问题的呢？
死锁：加锁后由于没有添加锁的过期时间或者锁的时间设置过长，服务异常 crash 或者服务执行后漏执行释放锁操作，导致锁长时间没有释放

脑裂：分布式体系结构中的集中式结构（也称为 Master/Slave 架构），一个 Master 节点多个 Slave 节点，所有的请求数据处理必须先经过 Master 中央服务器，由 Master 统一进行资源和任务调度，中央服务器根据这些信息，将任务下达给节点服务器，节点服务器执行任务，并将结果反馈给中央服务器。脑裂是在某些特殊条件下，如主备切换，Slave 在与 Master 的网络出现故障的时候，Slave 会认为 Master 已经故障，从而成为新的 master，而原来的 master 也没有卸任，从而导致存在两个 Master 在对外服务，存在多 master 会导致共享资源的互斥性遭到破坏，出现资源争抢，数据不一致等问题

惊群效应：指多进程（多线程）在同时阻塞等待同一个事件的时候（休眠状态），如果等待的这个事件发生，那么他就会唤醒等待的所有进程（或者线程），但是最终却只能有一个进程（线程）获得这个时间的 “控制权”，对该事件进行处理，而其他进程（线程）获取 “控制权” 失败，只能重新进入休眠状态，这种现象和性能浪费就叫做惊群效应。（当你往一群鸽子中间扔一块食物，虽然最终只有一个鸽子抢到食物，但所有鸽子都会被惊动来争夺，没有抢到食物的鸽子只好回去继续睡觉， 等待下一块食物到来。这样，每扔一块食物，都会惊动所有的鸽子，即为惊群。）

etcd 如何避免死锁：利用 Lease 的活性检测机制，它提供了检测各个客户端存活的能力。你的业务 client 需定期向 etcd 服务发送 "特殊心跳" 汇报健康状态，若你未正常发送心跳，并超过和 etcd 服务约定的最大存活时间后，就会被 etcd 服务移除此 Lease 和其关联的数据。通过 Lease 机制就优雅地解决了 client 出现 crash 故障、client 与 etcd 集群网络出现隔离等各类故障场景下的死锁问题。一旦超过 Lease TTL，它就能自动被释放，确保了其他 client 在 TTL 过期后能正常申请锁，保障了业务的可用性。

etcd 如何避免集群脑裂：在 leader 选举上采用了过半机制，即得到一半以上的 follow 才能成为 leader，且新 leader 就任后旧 leader 必须卸任，所以 etcd 不存在脑裂问题

etcd 如何避免惊群效应：mutex，通过 Watch 机制各自监听 prefix 相同，revision 比自己小的 key，因为只有 revision 比自己小的 key 释放锁，才能有机会，获得锁</div><div><div>2022-02-16</div><div><div><i></i><span></span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/30/85/14c2f16c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 石小</span></div></div><div>唐老师好，etcd 有像 innodb 那样能能控制持久化程度的配置 (主要指多久 fsync 一次磁盘) 吗？或者说，etcd 可能出现持久化失败 (写入磁盘缓存，没 fsync) 吗？如果持久化失败会有哪些影响？</div><div><p>作者回复：有的，etcd 提供了如下两个参数可以控制事务提交的行为。
--backend-batch-interval ''
    BackendBatchInterval is the maximum time before commit the backend transaction.
  --backend-batch-limit '0'
    BackendBatchLimit is the maximum operations before commit the backend transaction.
在 etcd v3.4.9 中，backend-batch-interval 如果你没指定，默认是 100ms，对应的异步 goroutine 将批量、每隔 100ms，将 boltdb 事务进行提交。
backend-batch-limit 默认是 10000，当堆积的 put/del 等操作若超过 10000 个，则会同步触发 boltdb 事务提交
，若 boltdb 事务持久化失败，则会异常退出，重启时会重放最新 WAL 日志中已提交的日志条目，再次执行。</p></div><div><div>2021-03-17</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132"></div></div><div><div><div><span>types</span></div></div><div>你要注意的是，实现分布式锁的方案有多种，比如你可以通过 client 是否成功创建一个固定的 key，来判断此 client 是否获得锁，你也可以通过多个 client 创建 prefix 相同，名称不一样的 key，哪个 key 的 revision 最小，最终就是它获得锁。至于谁优谁劣，我作为思考题的一部分，留给大家一起讨论。
1. 按照文中介绍 concurrency 包中用的是 prefix
2. 如果使用相同的 key，我能够想到存在的问题，在释放锁后，会导致获取锁的事务同时发生，事务数量变得很大
</div><div><p>作者回复：嗯，最主要是惊群效应，所有 client 都会收到相应 key 被删除消息，都会尝试发起事务，写入 key，性能会比较差</p></div><div><div>2021-03-11</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/ib3Rzem884S5MOS96THy0gQXcF26PNsnRBpyr3pM5rVibZdYvAibpVvAGfibF1ddpgrteg9fQUsq4vce9EM95Jj97Q/132"></div></div><div><div><div><span>Geek_604077</span></div></div><div>若你锁设置的 10 秒，如果你的某业务进程抢锁成功后，执行可能会超过 10 秒才成功，在这过程中如何避免锁被自动释放而出现的安全性问题呢？
加锁时，先设置一个过期时间，然后我们开启一个「守护线程」，定时去检测这个锁的失效时间，如果锁快要过期了，操作共享资源还未完成，那么就自动对锁进行「续期」，重新设置过期时间。

幸运的是，已经有一个库把这些工作都封装好了：Redisson。

Redisson 是一个 Java 语言实现的 Redis SDK 客户端，在使用分布式锁时，它就采用了「自动续期」的方案来避免锁过期，这个守护线程我们一般也把它叫做「看门狗」线程。</div><div><div>2022-02-16</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1c/dc/b0/5b652423.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Yang</span></div></div><div>etcd 实现的分布式所能保证高性能不</div><div><div>2021-12-02</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/59/31/3820fbb7.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 星星</span></div></div><div>强行吹 
Redisson 或者你自己写个 watchdog 都可以解决续期问题 
本质上 zk 的心跳维持就是 client 在自动续期

为什么这么多人使用 redis 还是因为 redis 读写性能远超 zk etcd</div><div><div>2022-08-17</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/46/12/965a6cc9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>菠萝 power</span></div></div><div>这个和 lock API 有什么区别吗 server/etcdserver/api/v3lock/v3lockpb/v3lock.proto</div><div><div>2022-07-08</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/e2/c0/e7a59706.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>chongsheng</span></div></div><div>如果用 etcd，能指定锁的自动释放时间吗？我看 NewSession 方法里对 lease 做了 keepalive，只要不 unlock 或者崩溃，是不是一直持有锁呢？</div><div><div>2022-03-28</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/21/b8/aca814dd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>江山如画</span></div></div><div>我最近在做的工作中遇到了分布式锁，这篇文章解决了工作中的很多疑惑，忍不住想要分享给同事们，逻辑合理，切中要害，写的太赞了。</div><div><p>作者回复：感谢分享，最近我在极客时间直播中也分享了更多 k8s 最佳实践案例，后面也将整理到专栏中。</p></div><div><div>2021-09-11</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/07/d2/0d7ee298.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>惘 闻</span></div></div><div>如果获取锁的 client crash 了。  其他的 client 监听到 delete 后获取到了锁，但是第一个 client 其实只是因为网络原因没有发送 lease，但是它恢复后继续执行代码。就相当于一个资源被两个 client 操作了啊。</div><div><div>2021-08-11</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/0a/7d/ac715471.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>独孤九剑</span></div></div><div>面试不怕分布式锁问题了</div><div><div>2021-07-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/13/45/16c60da2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>@% 初 %@</span></div></div><div>我理解多个客户端写一个 key，与多个客户端写多个 key，可以理解为非公平锁与公平锁。主要还是要看业务场景处理。</div><div><p>作者回复：嗯，性能也要考虑下</p></div><div><div>2021-04-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1s"><outline class="toc-level-h1" data-reactid=".1s.0" style="width: 175px;"><active data-reactid=".1s.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1s.0.1"><span data-reactid=".1s.0.1.0">21 | 分布式锁：为什么基于 etcd 实现分布式锁比 Redis 锁更安全？</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.1" style="width: 165px;"><active data-reactid=".1s.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1s.1.1"><span data-reactid=".1s.1.1.0">从茅台超卖案例看分布式锁要素</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.2" style="width: 165px;"><active data-reactid=".1s.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1s.2.1"><span data-reactid=".1s.2.1.0">Redis 分布式锁问题</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.3" style="width: 165px;"><active data-reactid=".1s.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1s.3.1"><span data-reactid=".1s.3.1.0">分布式锁常见实现方案</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.4" style="width: 165px;"><active data-reactid=".1s.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1s.4.1"><span data-reactid=".1s.4.1.0">etcd 分布式锁实现</span></a></outline><outline class="toc-level-h3" data-reactid=".1s.5" style="width: 155px;"><active data-reactid=".1s.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1s.5.1"><span data-reactid=".1s.5.1.0">事务与锁的安全性</span></a></outline><outline class="toc-level-h3" data-reactid=".1s.6" style="width: 155px;"><active data-reactid=".1s.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1s.6.1"><span data-reactid=".1s.6.1.0">Lease 与锁的活性</span></a></outline><outline class="toc-level-h3" data-reactid=".1s.7" style="width: 155px;"><active data-reactid=".1s.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1s.7.1"><span data-reactid=".1s.7.1.0">Watch 与锁的可用性</span></a></outline><outline class="toc-level-h3" data-reactid=".1s.8" style="width: 155px;"><active data-reactid=".1s.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1s.8.1"><span data-reactid=".1s.8.1.0">etcd 自带的 concurrency 包</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.9" style="width: 165px;"><active data-reactid=".1s.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1s.9.1"><span data-reactid=".1s.9.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.a" style="width: 165px;"><active data-reactid=".1s.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1s.a.1"><span data-reactid=".1s.a.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1s.b" style="width: 165px;"><active data-reactid=".1s.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1s.b.1"><span data-reactid=".1s.b.1.0">精选留言 (14)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/350285" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>