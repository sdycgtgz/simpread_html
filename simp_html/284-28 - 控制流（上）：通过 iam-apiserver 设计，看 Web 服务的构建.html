
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 28 | 控制流（上）：通过 iam-apiserver 设计，看 Web 服务的构建</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>28 | 控制流（上）：通过 iam-apiserver 设计，看 Web 服务的构建</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这一讲我们来了解目前业界有哪些优秀的开源日志包，以及手把手教你从 0 编写一个日志包</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 28 | 控制流（上）：通过 iam-apiserver 设计，看 Web 服务的构建</h1><div><span>孔令飞</span> <span> 2021-07-29</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f8/70/f8d1bebd28da85c08bcafd3de2dfcc70.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：孔令飞</span><span>大小：23.15M</span><span> 时长：25:20</span></div></div><audio title="28 | 控制流（上）：通过iam-apiserver设计，看Web服务的构建" src="https://res001.geekbang.org/media/audio/8d/26/8d0c5e17a5a7a007842d1fc8cae28c26/ld/ld.m3u8" __idm_id__="319496"></audio></div><div><div><div><div data-slate-editor="true" data-key="9794" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="9795"><span data-slate-object="text" data-key="9796"><span data-slate-leaf="true" data-offset-key="9796:0" data-first-offset="true"><span data-slate-string="true">你好，我是孔令飞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9797"><span data-slate-object="text" data-key="9798"><span data-slate-leaf="true" data-offset-key="9798:0" data-first-offset="true"><span data-slate-string="true">前面我们讲了很多关于应用构建的内容，你一定迫不及待地想看下 IAM 项目的应用是如何构建的。那么接下来，我就讲解下 IAM 应用的源码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9799"><span data-slate-object="text" data-key="9800"><span data-slate-leaf="true" data-offset-key="9800:0" data-first-offset="true"><span data-slate-string="true">在讲解过程中，我不会去讲解具体如何 Code，但会讲解一些构建过程中的重点、难点，以及 Code 背后的设计思路、想法。我相信这是对你更有帮助的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9801"><span data-slate-object="text" data-key="9802"><span data-slate-leaf="true" data-offset-key="9802:0" data-first-offset="true"><span data-slate-string="true">IAM 项目有很多组件，这一讲，我先来介绍下 IAM 项目的门面服务：iam-apiserver（管理流服务）。我会先给你介绍下 iam-apiserver 的功能和使用方法，再介绍下 iam-apiserver 的代码实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9803" id="sr-toc-1"><span data-slate-object="text" data-key="9804"><span data-slate-leaf="true" data-offset-key="9804:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 服务介绍</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9805"><span data-slate-object="text" data-key="9806"><span data-slate-leaf="true" data-offset-key="9806:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 是一个 Web 服务，通过一个名为 iam-apiserver 的进程，对外提供 RESTful API 接口，完成用户、密钥、策略三种 REST 资源的增删改查。接下来，我从功能和使用方法两个方面来具体介绍下。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9807" id="sr-toc-2"><span data-slate-object="text" data-key="9808"><span data-slate-leaf="true" data-offset-key="9808:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 功能介绍</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9809"><span data-slate-object="text" data-key="9810"><span data-slate-leaf="true" data-offset-key="9810:0" data-first-offset="true"><span data-slate-string="true">这里，我们可以通过 iam-apiserver 提供的 RESTful API 接口，来看下 iam-apiserver 具体提供的功能。iam-apiserver 提供的 RESTful API 接口可以分为四类，具体如下：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9811"><span data-slate-object="text" data-key="9812"><span data-slate-leaf="true" data-offset-key="9812:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">认证相关接口</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9813"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/43/6d/43ec9261ccdb165c56e9c25b45e6af6d.jpg?wh=1920x1062"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9814"><span data-slate-object="text" data-key="9815"><span data-slate-leaf="true" data-offset-key="9815:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">用户相关接口</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9816"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/24/60f8a05f4cb43cbac84c0fb12c40c824.jpg?wh=1920x1314"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9817"><span data-slate-object="text" data-key="9818"><span data-slate-leaf="true" data-offset-key="9818:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">密钥相关接口</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9819"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e8/95/e8f6aee66a29ff2a5aefeb00c5045c95.jpg?wh=1920x1326"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9820"><span data-slate-object="text" data-key="9821"><span data-slate-leaf="true" data-offset-key="9821:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">策略相关接口</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9822"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/0f/9e/0f3fcaa80020c3f72229fbab2f014a9e.jpg?wh=1920x1275"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9823" id="sr-toc-3"><span data-slate-object="text" data-key="9824"><span data-slate-leaf="true" data-offset-key="9824:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 使用方法介绍</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9825"><span data-slate-object="text" data-key="9826"><span data-slate-leaf="true" data-offset-key="9826:0" data-first-offset="true"><span data-slate-string="true">上面我介绍了 iam-apiserver 的功能，接下来就介绍下如何使用这些功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9827"><span data-slate-object="text" data-key="9828"><span data-slate-leaf="true" data-offset-key="9828:0" data-first-offset="true"><span data-slate-string="true">我们可以通过不同的客户端来访问 iam-apiserver，例如前端、API 调用、SDK、iamctl 等。这些客户端最终都会执行 HTTP 请求，调用 iam-apiserver 提供的 RESTful API 接口。所以，我们首先需要有一个顺手的 REST API 客户端工具来执行 HTTP 请求，完成开发测试。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9829"><span data-slate-object="text" data-key="9830"><span data-slate-leaf="true" data-offset-key="9830:0" data-first-offset="true"><span data-slate-string="true">因为不同的开发者执行 HTTP 请求的方式、习惯不同，为了方便讲解，这里我统一通过 cURL 工具来执行 HTTP 请求。</span></span><span data-slate-leaf="true" data-offset-key="9830:1"><span data-slate-object="annotation" data-annotation-key="gkann_fb6f7d71" data-attr-id="43710" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">接下来先介绍下 cURL 工具。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9831"><span data-slate-object="text" data-key="9832"><span data-slate-leaf="true" data-offset-key="9832:0" data-first-offset="true"><span data-slate-string="true">标准的 Linux 发行版都安装了 cURL 工具。cURL 可以很方便地完成 RESTful API 的调用场景，比如设置 Header、指定 HTTP 请求方法、指定 HTTP 消息体、指定权限认证信息等。通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9833"><span data-slate-object="text" data-key="9834"><span data-slate-leaf="true" data-offset-key="9834:0" data-first-offset="true"><span data-slate-string="true"> -v</span></span></span></span><span data-slate-object="text" data-key="9835"><span data-slate-leaf="true" data-offset-key="9835:0" data-first-offset="true"><span data-slate-string="true"> 选项，也能输出 REST 请求的所有返回信息。cURL 功能很强大，有很多参数，这里列出 cURL 工具常用的参数：</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="9836"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9837"><span data-slate-object="text" data-key="9838"><span data-slate-leaf="true" data-offset-key="9838:0" data-first-offset="true"><span data-slate-string="true">-X/</span></span></span><span data-slate-object="text" data-key="9839"><span data-slate-leaf="true" data-offset-key="9839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--request</span></span></span></span><span data-slate-object="text" data-key="9840"><span data-slate-leaf="true" data-offset-key="9840:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9841"><span data-slate-leaf="true" data-offset-key="9841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">[GET|POST|PUT|DELETE|…]</span></span></span></span><span data-slate-object="text" data-key="9842"><span data-slate-leaf="true" data-offset-key="9842:0" data-first-offset="true"><span data-slate-string="true">  指定请求的 HTTP 方法</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9843"><span data-slate-object="text" data-key="9844"><span data-slate-leaf="true" data-offset-key="9844:0" data-first-offset="true"><span data-slate-string="true">-H/</span></span></span><span data-slate-object="text" data-key="9845"><span data-slate-leaf="true" data-offset-key="9845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--header</span></span></span></span><span data-slate-object="text" data-key="9846"><span data-slate-leaf="true" data-offset-key="9846:0" data-first-offset="true"><span data-slate-string="true">                           指定请求的 HTTP </span></span></span><span data-slate-object="text" data-key="9847"><span data-slate-leaf="true" data-offset-key="9847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Header</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9848"><span data-slate-object="text" data-key="9849"><span data-slate-leaf="true" data-offset-key="9849:0" data-first-offset="true"><span data-slate-string="true">-d/</span></span></span><span data-slate-object="text" data-key="9850"><span data-slate-leaf="true" data-offset-key="9850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--data</span></span></span></span><span data-slate-object="text" data-key="9851"><span data-slate-leaf="true" data-offset-key="9851:0" data-first-offset="true"><span data-slate-string="true">                             指定请求的 HTTP 消息体（</span></span></span><span data-slate-object="text" data-key="9852"><span data-slate-leaf="true" data-offset-key="9852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Body</span></span></span></span><span data-slate-object="text" data-key="9853"><span data-slate-leaf="true" data-offset-key="9853:0" data-first-offset="true"><span data-slate-string="true">）</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9854"><span data-slate-object="text" data-key="9855"><span data-slate-leaf="true" data-offset-key="9855:0" data-first-offset="true"><span data-slate-string="true">-v/</span></span></span><span data-slate-object="text" data-key="9856"><span data-slate-leaf="true" data-offset-key="9856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--verbose</span></span></span></span><span data-slate-object="text" data-key="9857"><span data-slate-leaf="true" data-offset-key="9857:0" data-first-offset="true"><span data-slate-string="true">                          输出详细的返回信息</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9858"><span data-slate-object="text" data-key="9859"><span data-slate-leaf="true" data-offset-key="9859:0" data-first-offset="true"><span data-slate-string="true">-u/</span></span></span><span data-slate-object="text" data-key="9860"><span data-slate-leaf="true" data-offset-key="9860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--user</span></span></span></span><span data-slate-object="text" data-key="9861"><span data-slate-leaf="true" data-offset-key="9861:0" data-first-offset="true"><span data-slate-string="true">                             指定账号、密码</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9862"><span data-slate-object="text" data-key="9863"><span data-slate-leaf="true" data-offset-key="9863:0" data-first-offset="true"><span data-slate-string="true">-</span></span></span><span data-slate-object="text" data-key="9864"><span data-slate-leaf="true" data-offset-key="9864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">b</span></span></span></span><span data-slate-object="text" data-key="9865"><span data-slate-leaf="true" data-offset-key="9865:0" data-first-offset="true"><span data-slate-string="true">/</span></span></span><span data-slate-object="text" data-key="9866"><span data-slate-leaf="true" data-offset-key="9866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--cookie</span></span></span></span><span data-slate-object="text" data-key="9867"><span data-slate-leaf="true" data-offset-key="9867:0" data-first-offset="true"><span data-slate-string="true">                           读取 cookie</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9868"><span data-slate-object="text" data-key="9869"><span data-slate-leaf="true" data-offset-key="9869:0" data-first-offset="true"><span data-slate-string="true">此外，如果你想使用带 UI 界面的工具，这里我推荐你使用 Insomnia 。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9870"><span data-slate-object="text" data-key="9871"><span data-slate-leaf="true" data-offset-key="9871:0" data-first-offset="true"><span data-slate-string="true">Insomnia 是一个跨平台的 REST API 客户端，与 Postman、Apifox 是一类工具，用于接口管理、测试。Insomnia 功能强大，支持以下功能：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9872"><div data-slate-type="list-line" data-slate-object="block" data-key="9873"><span data-slate-object="text" data-key="9874"><span data-slate-leaf="true" data-offset-key="9874:0" data-first-offset="true"><span data-slate-string="true">发送 HTTP 请求；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9875"><span data-slate-object="text" data-key="9876"><span data-slate-leaf="true" data-offset-key="9876:0" data-first-offset="true"><span data-slate-string="true">创建工作区或文件夹；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9877"><span data-slate-object="text" data-key="9878"><span data-slate-leaf="true" data-offset-key="9878:0" data-first-offset="true"><span data-slate-string="true">导入和导出数据；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9879"><span data-slate-object="text" data-key="9880"><span data-slate-leaf="true" data-offset-key="9880:0" data-first-offset="true"><span data-slate-string="true">导出 cURL 格式的 HTTP 请求命令；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9881"><span data-slate-object="text" data-key="9882"><span data-slate-leaf="true" data-offset-key="9882:0" data-first-offset="true"><span data-slate-string="true">支持编写 swagger 文档；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9883"><span data-slate-object="text" data-key="9884"><span data-slate-leaf="true" data-offset-key="9884:0" data-first-offset="true"><span data-slate-string="true">快速切换请求；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9885"><span data-slate-object="text" data-key="9886"><span data-slate-leaf="true" data-offset-key="9886:0" data-first-offset="true"><span data-slate-string="true">URL 编码和解码。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9887"><span data-slate-object="text" data-key="9888"><span data-slate-leaf="true" data-offset-key="9888:0" data-first-offset="true"><span data-slate-string="true">…</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9889"><span data-slate-object="text" data-key="9890"><span data-slate-leaf="true" data-offset-key="9890:0" data-first-offset="true"><span data-slate-string="true">Insomnia 界面如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9891"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/63/e0/635aa6f3374af05ec2bff7e193314ae0.png?wh=1920x749"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9892"><span data-slate-object="text" data-key="9893"><span data-slate-leaf="true" data-offset-key="9893:0" data-first-offset="true"><span data-slate-string="true">当然了，也有很多其他优秀的带 UI 界面的 REST API 客户端，例如 Postman、Apifox 等，你可以根据需要自行选择。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9894"><span data-slate-object="text" data-key="9895"><span data-slate-leaf="true" data-offset-key="9895:0" data-first-offset="true"><span data-slate-string="true">接下来，我用对 secret 资源的 CURD 操作，来给你演示下</span></span></span><span data-slate-object="text" data-key="9896"><span data-slate-leaf="true" data-offset-key="9896:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如何使用 iam-apiserver 的功能</span></span></span></span><span data-slate-object="text" data-key="9897"><span data-slate-leaf="true" data-offset-key="9897:0" data-first-offset="true"><span data-slate-string="true">。你需要执行 6 步操作。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9898"><div data-slate-type="list-line" data-slate-object="block" data-key="9899"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="9900"><span data-slate-leaf="true" data-offset-key="9900:0" data-first-offset="true"><span data-slate-string="true">登录 iam-apiserver，获取 token。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9901"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="9902"><span data-slate-leaf="true" data-offset-key="9902:0" data-first-offset="true"><span data-slate-string="true">创建一个名为 secret0 的 secret。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9903"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="9904"><span data-slate-leaf="true" data-offset-key="9904:0" data-first-offset="true"><span data-slate-string="true">获取 secret0 的详细信息。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9905"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="9906"><span data-slate-leaf="true" data-offset-key="9906:0" data-first-offset="true"><span data-slate-string="true">更新 secret0 的描述。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9907"><div data-code-line-number="5"></div><div><span data-slate-object="text" data-key="9908"><span data-slate-leaf="true" data-offset-key="9908:0" data-first-offset="true"><span data-slate-string="true">获取 secret 列表。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9909"><div data-code-line-number="6"></div><div><span data-slate-object="text" data-key="9910"><span data-slate-leaf="true" data-offset-key="9910:0" data-first-offset="true"><span data-slate-string="true">删除 secret0。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9911"><span data-slate-object="text" data-key="9912"><span data-slate-leaf="true" data-offset-key="9912:0" data-first-offset="true"><span data-slate-string="true">具体操作如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9913"><div data-slate-type="list-line" data-slate-object="block" data-key="9914"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="9915"><span data-slate-leaf="true" data-offset-key="9915:0" data-first-offset="true"><span data-slate-string="true">登录 iam-apiserver，获取 token：</span></span></span></div></div></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="9916"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9917"><span data-slate-object="text" data-key="9918"><span data-slate-leaf="true" data-offset-key="9918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="9919"><span data-slate-leaf="true" data-offset-key="9919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -s -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="9920"><span data-slate-leaf="true" data-offset-key="9920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Basic `echo -n'admin:Admin@2021'|base64`"</span></span></span></span></span><span data-slate-object="text" data-key="9921"><span data-slate-leaf="true" data-offset-key="9921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/login | jq -r .token</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9922"><span data-slate-object="text" data-key="9923"><span data-slate-leaf="true" data-offset-key="9923:0" data-first-offset="true"><span data-slate-string="true">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9924"><span data-slate-object="text" data-key="9925"><span data-slate-leaf="true" data-offset-key="9925:0" data-first-offset="true"><span data-slate-string="true">这里，为了便于使用，我们将 token 设置为环境变量：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="9926"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9927"><span data-slate-object="text" data-key="9928"><span data-slate-leaf="true" data-offset-key="9928:0" data-first-offset="true"><span data-slate-string="true">TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="9929"><div data-slate-type="list-line" data-slate-object="block" data-key="9930"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="9931"><span data-slate-leaf="true" data-offset-key="9931:0" data-first-offset="true"><span data-slate-string="true">创建一个名为 secret0 的 secret：</span></span></span></div></div></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9932"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9933"><span data-slate-object="text" data-key="9934"><span data-slate-leaf="true" data-offset-key="9934:0" data-first-offset="true"><span data-slate-string="true">$ curl -v -XPOST -H </span></span></span><span data-slate-object="text" data-key="9935"><span data-slate-leaf="true" data-offset-key="9935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Content-Type: application/json"</span></span></span></span><span data-slate-object="text" data-key="9936"><span data-slate-leaf="true" data-offset-key="9936:0" data-first-offset="true"><span data-slate-string="true"> -H</span></span></span><span data-slate-object="text" data-key="9937"><span data-slate-leaf="true" data-offset-key="9937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer </span></span></span></span><span data-slate-object="text" data-key="9938"><span data-slate-leaf="true" data-offset-key="9938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${TOKEN}</span></span></span></span></span><span data-slate-object="text" data-key="9939"><span data-slate-leaf="true" data-offset-key="9939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="9940"><span data-slate-leaf="true" data-offset-key="9940:0" data-first-offset="true"><span data-slate-string="true"> -d</span></span></span><span data-slate-object="text" data-key="9941"><span data-slate-leaf="true" data-offset-key="9941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'{"metadata":{"name":"secret0"},"expires":0,"description":"admin secret"}'</span></span></span></span><span data-slate-object="text" data-key="9942"><span data-slate-leaf="true" data-offset-key="9942:0" data-first-offset="true"><span data-slate-string="true"> http://iam.api.marmotedu.com:8080/v1/secrets</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9943"><span data-slate-object="text" data-key="9944"><span data-slate-leaf="true" data-offset-key="9944:0" data-first-offset="true"><span data-slate-string="true">* About to connect() to iam.api.marmotedu.com port 8080 (</span></span></span><span data-slate-object="text" data-key="9945"><span data-slate-leaf="true" data-offset-key="9945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#0)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9946"><span data-slate-object="text" data-key="9947"><span data-slate-leaf="true" data-offset-key="9947:0" data-first-offset="true"><span data-slate-string="true">*   Trying 127.0.0.1...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9948"><span data-slate-object="text" data-key="9949"><span data-slate-leaf="true" data-offset-key="9949:0" data-first-offset="true"><span data-slate-string="true">* Connected to iam.api.marmotedu.com (127.0.0.1) port 8080 (</span></span></span><span data-slate-object="text" data-key="9950"><span data-slate-leaf="true" data-offset-key="9950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#0)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9951"><span data-slate-object="text" data-key="9952"><span data-slate-leaf="true" data-offset-key="9952:0" data-first-offset="true"><span data-slate-string="true">&gt; POST /v1/secrets HTTP/1.1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9953"><span data-slate-object="text" data-key="9954"><span data-slate-leaf="true" data-offset-key="9954:0" data-first-offset="true"><span data-slate-string="true">&gt; User-Agent: curl/7.29.0</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9955"><span data-slate-object="text" data-key="9956"><span data-slate-leaf="true" data-offset-key="9956:0" data-first-offset="true"><span data-slate-string="true">&gt; Host: iam.api.marmotedu.com:8080</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9957"><span data-slate-object="text" data-key="9958"><span data-slate-leaf="true" data-offset-key="9958:0" data-first-offset="true"><span data-slate-string="true">&gt; Accept: */*</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9959"><span data-slate-object="text" data-key="9960"><span data-slate-leaf="true" data-offset-key="9960:0" data-first-offset="true"><span data-slate-string="true">&gt; Content-Type: application/json</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9961"><span data-slate-object="text" data-key="9962"><span data-slate-leaf="true" data-offset-key="9962:0" data-first-offset="true"><span data-slate-string="true">&gt; Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9963"><span data-slate-object="text" data-key="9964"><span data-slate-leaf="true" data-offset-key="9964:0" data-first-offset="true"><span data-slate-string="true">&gt; Content-Length: 72</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9965"><span data-slate-object="text" data-key="9966"><span data-slate-leaf="true" data-offset-key="9966:0" data-first-offset="true"><span data-slate-string="true">&gt; </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9967"><span data-slate-object="text" data-key="9968"><span data-slate-leaf="true" data-offset-key="9968:0" data-first-offset="true"><span data-slate-string="true">* upload completely sent off: 72 out of 72 bytes</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9969"><span data-slate-object="text" data-key="9970"><span data-slate-leaf="true" data-offset-key="9970:0" data-first-offset="true"><span data-slate-string="true">&lt; HTTP/1.1 200 OK</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9971"><span data-slate-object="text" data-key="9972"><span data-slate-leaf="true" data-offset-key="9972:0" data-first-offset="true"><span data-slate-string="true">&lt; Content-Type: application/json; charset=utf-8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9973"><span data-slate-object="text" data-key="9974"><span data-slate-leaf="true" data-offset-key="9974:0" data-first-offset="true"><span data-slate-string="true">&lt; X-Request-Id: ff825bea-53de-4020-8e68-4e87574bd1ba</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9975"><span data-slate-object="text" data-key="9976"><span data-slate-leaf="true" data-offset-key="9976:0" data-first-offset="true"><span data-slate-string="true">&lt; Date: Mon, 26 Jul 2021 07:20:26 GMT</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9977"><span data-slate-object="text" data-key="9978"><span data-slate-leaf="true" data-offset-key="9978:0" data-first-offset="true"><span data-slate-string="true">&lt; Content-Length: 313</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9979"><span data-slate-object="text" data-key="9980"><span data-slate-leaf="true" data-offset-key="9980:0" data-first-offset="true"><span data-slate-string="true">&lt; </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9981"><span data-slate-object="text" data-key="9982"><span data-slate-leaf="true" data-offset-key="9982:0" data-first-offset="true"><span data-slate-string="true">* Connection </span></span></span><span data-slate-object="text" data-key="9983"><span data-slate-leaf="true" data-offset-key="9983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#0 to host iam.api.marmotedu.com left intact</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9984"><span data-slate-object="text" data-key="9985"><span data-slate-leaf="true" data-offset-key="9985:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="9986"><span data-slate-leaf="true" data-offset-key="9986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"metadata"</span></span></span></span><span data-slate-object="text" data-key="9987"><span data-slate-leaf="true" data-offset-key="9987:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="9988"><span data-slate-leaf="true" data-offset-key="9988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="9989"><span data-slate-leaf="true" data-offset-key="9989:0" data-first-offset="true"><span data-slate-string="true">:60,</span></span></span><span data-slate-object="text" data-key="9990"><span data-slate-leaf="true" data-offset-key="9990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"instanceID"</span></span></span></span><span data-slate-object="text" data-key="9991"><span data-slate-leaf="true" data-offset-key="9991:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9992"><span data-slate-leaf="true" data-offset-key="9992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret-jedr3e"</span></span></span></span><span data-slate-object="text" data-key="9993"><span data-slate-leaf="true" data-offset-key="9993:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9994"><span data-slate-leaf="true" data-offset-key="9994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"name"</span></span></span></span><span data-slate-object="text" data-key="9995"><span data-slate-leaf="true" data-offset-key="9995:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9996"><span data-slate-leaf="true" data-offset-key="9996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret0"</span></span></span></span><span data-slate-object="text" data-key="9997"><span data-slate-leaf="true" data-offset-key="9997:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9998"><span data-slate-leaf="true" data-offset-key="9998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"createdAt"</span></span></span></span><span data-slate-object="text" data-key="9999"><span data-slate-leaf="true" data-offset-key="9999:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10000"><span data-slate-leaf="true" data-offset-key="10000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:20:26.885+08:00"</span></span></span></span><span data-slate-object="text" data-key="10001"><span data-slate-leaf="true" data-offset-key="10001:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10002"><span data-slate-leaf="true" data-offset-key="10002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"updatedAt"</span></span></span></span><span data-slate-object="text" data-key="10003"><span data-slate-leaf="true" data-offset-key="10003:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10004"><span data-slate-leaf="true" data-offset-key="10004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:20:26.907+08:00"</span></span></span></span><span data-slate-object="text" data-key="10005"><span data-slate-leaf="true" data-offset-key="10005:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="10006"><span data-slate-leaf="true" data-offset-key="10006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="10007"><span data-slate-leaf="true" data-offset-key="10007:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10008"><span data-slate-leaf="true" data-offset-key="10008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin"</span></span></span></span><span data-slate-object="text" data-key="10009"><span data-slate-leaf="true" data-offset-key="10009:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10010"><span data-slate-leaf="true" data-offset-key="10010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretID"</span></span></span></span><span data-slate-object="text" data-key="10011"><span data-slate-leaf="true" data-offset-key="10011:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10012"><span data-slate-leaf="true" data-offset-key="10012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span></span></span></span><span data-slate-object="text" data-key="10013"><span data-slate-leaf="true" data-offset-key="10013:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10014"><span data-slate-leaf="true" data-offset-key="10014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretKey"</span></span></span></span><span data-slate-object="text" data-key="10015"><span data-slate-leaf="true" data-offset-key="10015:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10016"><span data-slate-leaf="true" data-offset-key="10016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span></span></span></span><span data-slate-object="text" data-key="10017"><span data-slate-leaf="true" data-offset-key="10017:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10018"><span data-slate-leaf="true" data-offset-key="10018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expires"</span></span></span></span><span data-slate-object="text" data-key="10019"><span data-slate-leaf="true" data-offset-key="10019:0" data-first-offset="true"><span data-slate-string="true">:0,</span></span></span><span data-slate-object="text" data-key="10020"><span data-slate-leaf="true" data-offset-key="10020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10021"><span data-slate-leaf="true" data-offset-key="10021:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10022"><span data-slate-leaf="true" data-offset-key="10022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin secret"</span></span></span></span><span data-slate-object="text" data-key="10023"><span data-slate-leaf="true" data-offset-key="10023:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10024"><span data-slate-object="text" data-key="10025"><span data-slate-leaf="true" data-offset-key="10025:0" data-first-offset="true"><span data-slate-string="true">可以看到，请求返回头中返回了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10026"><span data-slate-object="text" data-key="10027"><span data-slate-leaf="true" data-offset-key="10027:0" data-first-offset="true"><span data-slate-string="true"> X-Request-Id</span></span></span></span><span data-slate-object="text" data-key="10028"><span data-slate-leaf="true" data-offset-key="10028:0" data-first-offset="true"><span data-slate-string="true"> Header，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10029"><span data-slate-object="text" data-key="10030"><span data-slate-leaf="true" data-offset-key="10030:0" data-first-offset="true"><span data-slate-string="true">X-Request-Id</span></span></span></span><span data-slate-object="text" data-key="10031"><span data-slate-leaf="true" data-offset-key="10031:0" data-first-offset="true"><span data-slate-string="true"> 唯一标识这次请求。如果这次请求失败，就可以将</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10032"><span data-slate-object="text" data-key="10033"><span data-slate-leaf="true" data-offset-key="10033:0" data-first-offset="true"><span data-slate-string="true"> X-Request-Id</span></span></span></span><span data-slate-object="text" data-key="10034"><span data-slate-leaf="true" data-offset-key="10034:0" data-first-offset="true"><span data-slate-string="true"> 提供给运维或者开发，通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10035"><span data-slate-object="text" data-key="10036"><span data-slate-leaf="true" data-offset-key="10036:0" data-first-offset="true"><span data-slate-string="true"> X-Request-Id</span></span></span></span><span data-slate-object="text" data-key="10037"><span data-slate-leaf="true" data-offset-key="10037:0" data-first-offset="true"><span data-slate-string="true"> 定位出失败的请求，进行排障。另外</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10038"><span data-slate-object="text" data-key="10039"><span data-slate-leaf="true" data-offset-key="10039:0" data-first-offset="true"><span data-slate-string="true"> X-Request-Id</span></span></span></span><span data-slate-object="text" data-key="10040"><span data-slate-leaf="true" data-offset-key="10040:0" data-first-offset="true"><span data-slate-string="true"> 在微服务场景中，也可以透传给其他服务，从而实现请求调用链。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10041"><div data-slate-type="list-line" data-slate-object="block" data-key="10042"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="10043"><span data-slate-leaf="true" data-offset-key="10043:0" data-first-offset="true"><span data-slate-string="true">获取 secret0 的详细信息：</span></span></span></div></div></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="10044"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10045"><span data-slate-object="text" data-key="10046"><span data-slate-leaf="true" data-offset-key="10046:0" data-first-offset="true"><span data-slate-string="true">$ curl -XGET -H</span></span></span><span data-slate-object="text" data-key="10047"><span data-slate-leaf="true" data-offset-key="10047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer </span></span></span></span><span data-slate-object="text" data-key="10048"><span data-slate-leaf="true" data-offset-key="10048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${TOKEN}</span></span></span></span></span><span data-slate-object="text" data-key="10049"><span data-slate-leaf="true" data-offset-key="10049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="10050"><span data-slate-leaf="true" data-offset-key="10050:0" data-first-offset="true"><span data-slate-string="true"> http://iam.api.marmotedu.com:8080/v1/secrets/secret0</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10051"><span data-slate-object="text" data-key="10052"><span data-slate-leaf="true" data-offset-key="10052:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="10053"><span data-slate-leaf="true" data-offset-key="10053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"metadata"</span></span></span></span><span data-slate-object="text" data-key="10054"><span data-slate-leaf="true" data-offset-key="10054:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="10055"><span data-slate-leaf="true" data-offset-key="10055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="10056"><span data-slate-leaf="true" data-offset-key="10056:0" data-first-offset="true"><span data-slate-string="true">:60,</span></span></span><span data-slate-object="text" data-key="10057"><span data-slate-leaf="true" data-offset-key="10057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"instanceID"</span></span></span></span><span data-slate-object="text" data-key="10058"><span data-slate-leaf="true" data-offset-key="10058:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10059"><span data-slate-leaf="true" data-offset-key="10059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret-jedr3e"</span></span></span></span><span data-slate-object="text" data-key="10060"><span data-slate-leaf="true" data-offset-key="10060:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10061"><span data-slate-leaf="true" data-offset-key="10061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"name"</span></span></span></span><span data-slate-object="text" data-key="10062"><span data-slate-leaf="true" data-offset-key="10062:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10063"><span data-slate-leaf="true" data-offset-key="10063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret0"</span></span></span></span><span data-slate-object="text" data-key="10064"><span data-slate-leaf="true" data-offset-key="10064:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10065"><span data-slate-leaf="true" data-offset-key="10065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"createdAt"</span></span></span></span><span data-slate-object="text" data-key="10066"><span data-slate-leaf="true" data-offset-key="10066:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10067"><span data-slate-leaf="true" data-offset-key="10067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:20:26+08:00"</span></span></span></span><span data-slate-object="text" data-key="10068"><span data-slate-leaf="true" data-offset-key="10068:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10069"><span data-slate-leaf="true" data-offset-key="10069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"updatedAt"</span></span></span></span><span data-slate-object="text" data-key="10070"><span data-slate-leaf="true" data-offset-key="10070:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10071"><span data-slate-leaf="true" data-offset-key="10071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:20:26+08:00"</span></span></span></span><span data-slate-object="text" data-key="10072"><span data-slate-leaf="true" data-offset-key="10072:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="10073"><span data-slate-leaf="true" data-offset-key="10073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="10074"><span data-slate-leaf="true" data-offset-key="10074:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10075"><span data-slate-leaf="true" data-offset-key="10075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin"</span></span></span></span><span data-slate-object="text" data-key="10076"><span data-slate-leaf="true" data-offset-key="10076:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10077"><span data-slate-leaf="true" data-offset-key="10077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretID"</span></span></span></span><span data-slate-object="text" data-key="10078"><span data-slate-leaf="true" data-offset-key="10078:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10079"><span data-slate-leaf="true" data-offset-key="10079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span></span></span></span><span data-slate-object="text" data-key="10080"><span data-slate-leaf="true" data-offset-key="10080:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10081"><span data-slate-leaf="true" data-offset-key="10081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretKey"</span></span></span></span><span data-slate-object="text" data-key="10082"><span data-slate-leaf="true" data-offset-key="10082:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10083"><span data-slate-leaf="true" data-offset-key="10083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span></span></span></span><span data-slate-object="text" data-key="10084"><span data-slate-leaf="true" data-offset-key="10084:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10085"><span data-slate-leaf="true" data-offset-key="10085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expires"</span></span></span></span><span data-slate-object="text" data-key="10086"><span data-slate-leaf="true" data-offset-key="10086:0" data-first-offset="true"><span data-slate-string="true">:0,</span></span></span><span data-slate-object="text" data-key="10087"><span data-slate-leaf="true" data-offset-key="10087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10088"><span data-slate-leaf="true" data-offset-key="10088:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10089"><span data-slate-leaf="true" data-offset-key="10089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin secret"</span></span></span></span><span data-slate-object="text" data-key="10090"><span data-slate-leaf="true" data-offset-key="10090:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="10091"><div data-slate-type="list-line" data-slate-object="block" data-key="10092"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="10093"><span data-slate-leaf="true" data-offset-key="10093:0" data-first-offset="true"><span data-slate-string="true">更新 secret0 的描述：</span></span></span></div></div></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="10094"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10095"><span data-slate-object="text" data-key="10096"><span data-slate-leaf="true" data-offset-key="10096:0" data-first-offset="true"><span data-slate-string="true">$ curl -XPUT -H</span></span></span><span data-slate-object="text" data-key="10097"><span data-slate-leaf="true" data-offset-key="10097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer ${TOKEN}"</span></span></span></span><span data-slate-object="text" data-key="10098"><span data-slate-leaf="true" data-offset-key="10098:0" data-first-offset="true"><span data-slate-string="true"> -d'{</span></span></span><span data-slate-object="text" data-key="10099"><span data-slate-leaf="true" data-offset-key="10099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"metadata"</span></span></span></span><span data-slate-object="text" data-key="10100"><span data-slate-leaf="true" data-offset-key="10100:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="10101"><span data-slate-leaf="true" data-offset-key="10101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"name"</span></span></span></span><span data-slate-object="text" data-key="10102"><span data-slate-leaf="true" data-offset-key="10102:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10103"><span data-slate-leaf="true" data-offset-key="10103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret"</span></span></span></span><span data-slate-object="text" data-key="10104"><span data-slate-leaf="true" data-offset-key="10104:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="10105"><span data-slate-leaf="true" data-offset-key="10105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expires"</span></span></span></span><span data-slate-object="text" data-key="10106"><span data-slate-leaf="true" data-offset-key="10106:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10107"><span data-slate-leaf="true" data-offset-key="10107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10108"><span data-slate-leaf="true" data-offset-key="10108:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10109"><span data-slate-leaf="true" data-offset-key="10109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10110"><span data-slate-leaf="true" data-offset-key="10110:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10111"><span data-slate-leaf="true" data-offset-key="10111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin secret(modify)"</span></span></span></span><span data-slate-object="text" data-key="10112"><span data-slate-leaf="true" data-offset-key="10112:0" data-first-offset="true"><span data-slate-string="true">}' http:</span></span></span><span data-slate-object="text" data-key="10113"><span data-slate-leaf="true" data-offset-key="10113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//iam.api.marmotedu.com:8080/v1/secrets/secret0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10114"><span data-slate-object="text" data-key="10115"><span data-slate-leaf="true" data-offset-key="10115:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="10116"><span data-slate-leaf="true" data-offset-key="10116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"metadata"</span></span></span></span><span data-slate-object="text" data-key="10117"><span data-slate-leaf="true" data-offset-key="10117:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="10118"><span data-slate-leaf="true" data-offset-key="10118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="10119"><span data-slate-leaf="true" data-offset-key="10119:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10120"><span data-slate-leaf="true" data-offset-key="10120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">60</span></span></span></span><span data-slate-object="text" data-key="10121"><span data-slate-leaf="true" data-offset-key="10121:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10122"><span data-slate-leaf="true" data-offset-key="10122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"instanceID"</span></span></span></span><span data-slate-object="text" data-key="10123"><span data-slate-leaf="true" data-offset-key="10123:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10124"><span data-slate-leaf="true" data-offset-key="10124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret-jedr3e"</span></span></span></span><span data-slate-object="text" data-key="10125"><span data-slate-leaf="true" data-offset-key="10125:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10126"><span data-slate-leaf="true" data-offset-key="10126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"name"</span></span></span></span><span data-slate-object="text" data-key="10127"><span data-slate-leaf="true" data-offset-key="10127:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10128"><span data-slate-leaf="true" data-offset-key="10128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret0"</span></span></span></span><span data-slate-object="text" data-key="10129"><span data-slate-leaf="true" data-offset-key="10129:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10130"><span data-slate-leaf="true" data-offset-key="10130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"createdAt"</span></span></span></span><span data-slate-object="text" data-key="10131"><span data-slate-leaf="true" data-offset-key="10131:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10132"><span data-slate-leaf="true" data-offset-key="10132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:20:26+08:00"</span></span></span></span><span data-slate-object="text" data-key="10133"><span data-slate-leaf="true" data-offset-key="10133:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10134"><span data-slate-leaf="true" data-offset-key="10134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"updatedAt"</span></span></span></span><span data-slate-object="text" data-key="10135"><span data-slate-leaf="true" data-offset-key="10135:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10136"><span data-slate-leaf="true" data-offset-key="10136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:23:35.878+08:00"</span></span></span></span><span data-slate-object="text" data-key="10137"><span data-slate-leaf="true" data-offset-key="10137:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="10138"><span data-slate-leaf="true" data-offset-key="10138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="10139"><span data-slate-leaf="true" data-offset-key="10139:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10140"><span data-slate-leaf="true" data-offset-key="10140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin"</span></span></span></span><span data-slate-object="text" data-key="10141"><span data-slate-leaf="true" data-offset-key="10141:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10142"><span data-slate-leaf="true" data-offset-key="10142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretID"</span></span></span></span><span data-slate-object="text" data-key="10143"><span data-slate-leaf="true" data-offset-key="10143:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10144"><span data-slate-leaf="true" data-offset-key="10144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span></span></span></span><span data-slate-object="text" data-key="10145"><span data-slate-leaf="true" data-offset-key="10145:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10146"><span data-slate-leaf="true" data-offset-key="10146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretKey"</span></span></span></span><span data-slate-object="text" data-key="10147"><span data-slate-leaf="true" data-offset-key="10147:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10148"><span data-slate-leaf="true" data-offset-key="10148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span></span></span></span><span data-slate-object="text" data-key="10149"><span data-slate-leaf="true" data-offset-key="10149:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10150"><span data-slate-leaf="true" data-offset-key="10150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expires"</span></span></span></span><span data-slate-object="text" data-key="10151"><span data-slate-leaf="true" data-offset-key="10151:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10152"><span data-slate-leaf="true" data-offset-key="10152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10153"><span data-slate-leaf="true" data-offset-key="10153:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10154"><span data-slate-leaf="true" data-offset-key="10154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10155"><span data-slate-leaf="true" data-offset-key="10155:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10156"><span data-slate-leaf="true" data-offset-key="10156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin secret(modify)"</span></span></span></span><span data-slate-object="text" data-key="10157"><span data-slate-leaf="true" data-offset-key="10157:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="10158"><div data-slate-type="list-line" data-slate-object="block" data-key="10159"><div data-code-line-number="5"></div><div><span data-slate-object="text" data-key="10160"><span data-slate-leaf="true" data-offset-key="10160:0" data-first-offset="true"><span data-slate-string="true">获取 secret 列表：</span></span></span></div></div></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="10161"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10162"><span data-slate-object="text" data-key="10163"><span data-slate-leaf="true" data-offset-key="10163:0" data-first-offset="true"><span data-slate-string="true">$ curl -XGET -H</span></span></span><span data-slate-object="text" data-key="10164"><span data-slate-leaf="true" data-offset-key="10164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer </span></span></span></span><span data-slate-object="text" data-key="10165"><span data-slate-leaf="true" data-offset-key="10165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${TOKEN}</span></span></span></span></span><span data-slate-object="text" data-key="10166"><span data-slate-leaf="true" data-offset-key="10166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="10167"><span data-slate-leaf="true" data-offset-key="10167:0" data-first-offset="true"><span data-slate-string="true"> http://iam.api.marmotedu.com:8080/v1/secrets</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10168"><span data-slate-object="text" data-key="10169"><span data-slate-leaf="true" data-offset-key="10169:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="10170"><span data-slate-leaf="true" data-offset-key="10170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"totalCount"</span></span></span></span><span data-slate-object="text" data-key="10171"><span data-slate-leaf="true" data-offset-key="10171:0" data-first-offset="true"><span data-slate-string="true">:1,</span></span></span><span data-slate-object="text" data-key="10172"><span data-slate-leaf="true" data-offset-key="10172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"items"</span></span></span></span><span data-slate-object="text" data-key="10173"><span data-slate-leaf="true" data-offset-key="10173:0" data-first-offset="true"><span data-slate-string="true">:[{</span></span></span><span data-slate-object="text" data-key="10174"><span data-slate-leaf="true" data-offset-key="10174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"metadata"</span></span></span></span><span data-slate-object="text" data-key="10175"><span data-slate-leaf="true" data-offset-key="10175:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="10176"><span data-slate-leaf="true" data-offset-key="10176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="10177"><span data-slate-leaf="true" data-offset-key="10177:0" data-first-offset="true"><span data-slate-string="true">:60,</span></span></span><span data-slate-object="text" data-key="10178"><span data-slate-leaf="true" data-offset-key="10178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"instanceID"</span></span></span></span><span data-slate-object="text" data-key="10179"><span data-slate-leaf="true" data-offset-key="10179:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10180"><span data-slate-leaf="true" data-offset-key="10180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret-jedr3e"</span></span></span></span><span data-slate-object="text" data-key="10181"><span data-slate-leaf="true" data-offset-key="10181:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10182"><span data-slate-leaf="true" data-offset-key="10182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"name"</span></span></span></span><span data-slate-object="text" data-key="10183"><span data-slate-leaf="true" data-offset-key="10183:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10184"><span data-slate-leaf="true" data-offset-key="10184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret0"</span></span></span></span><span data-slate-object="text" data-key="10185"><span data-slate-leaf="true" data-offset-key="10185:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10186"><span data-slate-leaf="true" data-offset-key="10186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"createdAt"</span></span></span></span><span data-slate-object="text" data-key="10187"><span data-slate-leaf="true" data-offset-key="10187:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10188"><span data-slate-leaf="true" data-offset-key="10188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:20:26+08:00"</span></span></span></span><span data-slate-object="text" data-key="10189"><span data-slate-leaf="true" data-offset-key="10189:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10190"><span data-slate-leaf="true" data-offset-key="10190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"updatedAt"</span></span></span></span><span data-slate-object="text" data-key="10191"><span data-slate-leaf="true" data-offset-key="10191:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10192"><span data-slate-leaf="true" data-offset-key="10192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-07-26T15:23:35+08:00"</span></span></span></span><span data-slate-object="text" data-key="10193"><span data-slate-leaf="true" data-offset-key="10193:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="10194"><span data-slate-leaf="true" data-offset-key="10194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="10195"><span data-slate-leaf="true" data-offset-key="10195:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10196"><span data-slate-leaf="true" data-offset-key="10196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin"</span></span></span></span><span data-slate-object="text" data-key="10197"><span data-slate-leaf="true" data-offset-key="10197:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10198"><span data-slate-leaf="true" data-offset-key="10198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretID"</span></span></span></span><span data-slate-object="text" data-key="10199"><span data-slate-leaf="true" data-offset-key="10199:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10200"><span data-slate-leaf="true" data-offset-key="10200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD"</span></span></span></span><span data-slate-object="text" data-key="10201"><span data-slate-leaf="true" data-offset-key="10201:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10202"><span data-slate-leaf="true" data-offset-key="10202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretKey"</span></span></span></span><span data-slate-object="text" data-key="10203"><span data-slate-leaf="true" data-offset-key="10203:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10204"><span data-slate-leaf="true" data-offset-key="10204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf"</span></span></span></span><span data-slate-object="text" data-key="10205"><span data-slate-leaf="true" data-offset-key="10205:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="10206"><span data-slate-leaf="true" data-offset-key="10206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expires"</span></span></span></span><span data-slate-object="text" data-key="10207"><span data-slate-leaf="true" data-offset-key="10207:0" data-first-offset="true"><span data-slate-string="true">:0,</span></span></span><span data-slate-object="text" data-key="10208"><span data-slate-leaf="true" data-offset-key="10208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10209"><span data-slate-leaf="true" data-offset-key="10209:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10210"><span data-slate-leaf="true" data-offset-key="10210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"admin secret(modify)"</span></span></span></span><span data-slate-object="text" data-key="10211"><span data-slate-leaf="true" data-offset-key="10211:0" data-first-offset="true"><span data-slate-string="true">}]}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="10212"><div data-slate-type="list-line" data-slate-object="block" data-key="10213"><div data-code-line-number="6"></div><div><span data-slate-object="text" data-key="10214"><span data-slate-leaf="true" data-offset-key="10214:0" data-first-offset="true"><span data-slate-string="true">删除 secret0：</span></span></span></div></div></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="10215"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10216"><span data-slate-object="text" data-key="10217"><span data-slate-leaf="true" data-offset-key="10217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10218"><span data-slate-leaf="true" data-offset-key="10218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -XDELETE -H</span></span></span></span><span data-slate-object="text" data-key="10219"><span data-slate-leaf="true" data-offset-key="10219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer </span></span></span></span></span><span data-slate-object="text" data-key="10220"><span data-slate-leaf="true" data-offset-key="10220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${TOKEN}</span></span></span></span></span></span><span data-slate-object="text" data-key="10221"><span data-slate-leaf="true" data-offset-key="10221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span></span><span data-slate-object="text" data-key="10222"><span data-slate-leaf="true" data-offset-key="10222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://iam.api.marmotedu.com:8080/v1/secrets/secret0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10223"><span data-slate-object="text" data-key="10224"><span data-slate-leaf="true" data-offset-key="10224:0" data-first-offset="true"><span data-slate-string="true">null</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10225"><span data-slate-object="text" data-key="10226"><span data-slate-leaf="true" data-offset-key="10226:0" data-first-offset="true"><span data-slate-string="true">上面，我给你演示了密钥的使用方法。用户和策略资源类型的使用方法跟密钥类似。详细的使用方法你可以参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10227"><span data-slate-object="text" data-key="10228"><span data-slate-leaf="true" data-offset-key="10228:0" data-first-offset="true"><span data-slate-string="true">test.sh</span></span></span></a><span data-slate-object="text" data-key="10229"><span data-slate-leaf="true" data-offset-key="10229:0" data-first-offset="true"><span data-slate-string="true"> 脚本，该脚本是用来测试 IAM 应用的，里面包含了各个接口的请求方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10230"><span data-slate-object="text" data-key="10231"><span data-slate-leaf="true" data-offset-key="10231:0" data-first-offset="true"><span data-slate-string="true">这里，我还想顺便介绍下</span></span></span><span data-slate-object="text" data-key="10232"><span data-slate-leaf="true" data-offset-key="10232:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如何测试 IAM 应用中的各个部分</span></span></span></span><span data-slate-object="text" data-key="10233"><span data-slate-leaf="true" data-offset-key="10233:0" data-first-offset="true"><span data-slate-string="true">。确保 iam-apiserver、iam-authz-server、iam-pump 等服务正常运行后，进入到 IAM 项目的根目录，执行以下命令：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="10234"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10235"><span data-slate-object="text" data-key="10236"><span data-slate-leaf="true" data-offset-key="10236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10237"><span data-slate-leaf="true" data-offset-key="10237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10238"><span data-slate-leaf="true" data-offset-key="10238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10239"><span data-slate-leaf="true" data-offset-key="10239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::</span></span></span></span><span data-slate-object="text" data-key="10240"><span data-slate-leaf="true" data-offset-key="10240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10241"><span data-slate-leaf="true" data-offset-key="10241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10242"><span data-slate-leaf="true" data-offset-key="10242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试整个 IAM 应用是否正常运行</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10243"><span data-slate-object="text" data-key="10244"><span data-slate-leaf="true" data-offset-key="10244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10245"><span data-slate-leaf="true" data-offset-key="10245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10246"><span data-slate-leaf="true" data-offset-key="10246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10247"><span data-slate-leaf="true" data-offset-key="10247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::login </span></span></span></span><span data-slate-object="text" data-key="10248"><span data-slate-leaf="true" data-offset-key="10248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试登陆接口是否可以正常访问</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10249"><span data-slate-object="text" data-key="10250"><span data-slate-leaf="true" data-offset-key="10250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10251"><span data-slate-leaf="true" data-offset-key="10251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10252"><span data-slate-leaf="true" data-offset-key="10252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10253"><span data-slate-leaf="true" data-offset-key="10253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::user </span></span></span></span><span data-slate-object="text" data-key="10254"><span data-slate-leaf="true" data-offset-key="10254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试用户接口是否可以正常访问</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10255"><span data-slate-object="text" data-key="10256"><span data-slate-leaf="true" data-offset-key="10256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10257"><span data-slate-leaf="true" data-offset-key="10257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10258"><span data-slate-leaf="true" data-offset-key="10258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10259"><span data-slate-leaf="true" data-offset-key="10259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::secret </span></span></span></span><span data-slate-object="text" data-key="10260"><span data-slate-leaf="true" data-offset-key="10260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试密钥接口是否可以正常访问</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10261"><span data-slate-object="text" data-key="10262"><span data-slate-leaf="true" data-offset-key="10262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10263"><span data-slate-leaf="true" data-offset-key="10263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10264"><span data-slate-leaf="true" data-offset-key="10264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10265"><span data-slate-leaf="true" data-offset-key="10265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::policy </span></span></span></span><span data-slate-object="text" data-key="10266"><span data-slate-leaf="true" data-offset-key="10266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试策略接口是否可以正常访问</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10267"><span data-slate-object="text" data-key="10268"><span data-slate-leaf="true" data-offset-key="10268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10269"><span data-slate-leaf="true" data-offset-key="10269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10270"><span data-slate-leaf="true" data-offset-key="10270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10271"><span data-slate-leaf="true" data-offset-key="10271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::apiserver </span></span></span></span><span data-slate-object="text" data-key="10272"><span data-slate-leaf="true" data-offset-key="10272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试 iam-apiserver 服务是否正常运行</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10273"><span data-slate-object="text" data-key="10274"><span data-slate-leaf="true" data-offset-key="10274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10275"><span data-slate-leaf="true" data-offset-key="10275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10276"><span data-slate-leaf="true" data-offset-key="10276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10277"><span data-slate-leaf="true" data-offset-key="10277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::authz </span></span></span></span><span data-slate-object="text" data-key="10278"><span data-slate-leaf="true" data-offset-key="10278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试 authz 接口是否可以正常访问</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10279"><span data-slate-object="text" data-key="10280"><span data-slate-leaf="true" data-offset-key="10280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10281"><span data-slate-leaf="true" data-offset-key="10281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10282"><span data-slate-leaf="true" data-offset-key="10282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10283"><span data-slate-leaf="true" data-offset-key="10283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::authzserver </span></span></span></span><span data-slate-object="text" data-key="10284"><span data-slate-leaf="true" data-offset-key="10284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试 iam-authz-server 服务是否正常运行</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10285"><span data-slate-object="text" data-key="10286"><span data-slate-leaf="true" data-offset-key="10286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10287"><span data-slate-leaf="true" data-offset-key="10287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10288"><span data-slate-leaf="true" data-offset-key="10288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10289"><span data-slate-leaf="true" data-offset-key="10289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::pump </span></span></span></span><span data-slate-object="text" data-key="10290"><span data-slate-leaf="true" data-offset-key="10290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试 iam-pump 是否正常运行</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10291"><span data-slate-object="text" data-key="10292"><span data-slate-leaf="true" data-offset-key="10292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10293"><span data-slate-leaf="true" data-offset-key="10293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10294"><span data-slate-leaf="true" data-offset-key="10294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10295"><span data-slate-leaf="true" data-offset-key="10295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::iamctl </span></span></span></span><span data-slate-object="text" data-key="10296"><span data-slate-leaf="true" data-offset-key="10296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试 iamctl 工具是否可以正常使用</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10297"><span data-slate-object="text" data-key="10298"><span data-slate-leaf="true" data-offset-key="10298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10299"><span data-slate-leaf="true" data-offset-key="10299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10300"><span data-slate-leaf="true" data-offset-key="10300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10301"><span data-slate-leaf="true" data-offset-key="10301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::man </span></span></span></span><span data-slate-object="text" data-key="10302"><span data-slate-leaf="true" data-offset-key="10302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 测试 man 文件是否正确安装</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10303"><span data-slate-object="text" data-key="10304"><span data-slate-leaf="true" data-offset-key="10304:0" data-first-offset="true"><span data-slate-string="true">所以，每次发布完 iam-apiserver 后，你可以执行以下命令来完成 iam-apiserver 的冒烟测试：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="10305"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10306"><span data-slate-object="text" data-key="10307"><span data-slate-leaf="true" data-offset-key="10307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10308"><span data-slate-leaf="true" data-offset-key="10308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">export</span></span></span></span></span><span data-slate-object="text" data-key="10309"><span data-slate-leaf="true" data-offset-key="10309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> IAM_APISERVER_HOST=127.0.0.1 </span></span></span></span><span data-slate-object="text" data-key="10310"><span data-slate-leaf="true" data-offset-key="10310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># iam-apiserver 部署服务器的 IP 地址</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10311"><span data-slate-object="text" data-key="10312"><span data-slate-leaf="true" data-offset-key="10312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10313"><span data-slate-leaf="true" data-offset-key="10313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">export</span></span></span></span></span><span data-slate-object="text" data-key="10314"><span data-slate-leaf="true" data-offset-key="10314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> IAM_APISERVER_INSECURE_BIND_PORT=8080 </span></span></span></span><span data-slate-object="text" data-key="10315"><span data-slate-leaf="true" data-offset-key="10315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># iam-apiserver HTTP 服务的监听端口</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10316"><span data-slate-object="text" data-key="10317"><span data-slate-leaf="true" data-offset-key="10317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="10318"><span data-slate-leaf="true" data-offset-key="10318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">./scripts/install/test.sh iam::</span></span></span></span><span data-slate-object="text" data-key="10319"><span data-slate-leaf="true" data-offset-key="10319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span></span><span data-slate-object="text" data-key="10320"><span data-slate-leaf="true" data-offset-key="10320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::apiserver</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10321" id="sr-toc-4"><span data-slate-object="text" data-key="10322"><span data-slate-leaf="true" data-offset-key="10322:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 代码实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10323"><span data-slate-object="text" data-key="10324"><span data-slate-leaf="true" data-offset-key="10324:0" data-first-offset="true"><span data-slate-string="true">上面，我介绍了 iam-apiserver 的功能和使用方法，这里我们再来看下 iam-apiserver 具体的代码实现。我会从配置处理、启动流程、请求处理流程、代码架构 4 个方面来讲解。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10325" id="sr-toc-5"><span data-slate-object="text" data-key="10326"><span data-slate-leaf="true" data-offset-key="10326:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 配置处理</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10327"><span data-slate-object="text" data-key="10328"><span data-slate-leaf="true" data-offset-key="10328:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 服务的 main 函数位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10329"><span data-slate-object="text" data-key="10330"><span data-slate-leaf="true" data-offset-key="10330:0" data-first-offset="true"><span data-slate-string="true">apiserver.go</span></span></span></a><span data-slate-object="text" data-key="10331"><span data-slate-leaf="true" data-offset-key="10331:0" data-first-offset="true"><span data-slate-string="true"> 文件中，你可以跟读代码，了解 iam-apiserver 的代码实现。这里，我来介绍下 iam-apiserver 服务的一些设计思想。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10332"><span data-slate-object="text" data-key="10333"><span data-slate-leaf="true" data-offset-key="10333:0" data-first-offset="true"><span data-slate-string="true">首先，来看下 iam-apiserver 中的 3 种配置：Options 配置、应用配置和 HTTP/GRPC 服务配置。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10334"><div data-slate-type="list-line" data-slate-object="block" data-key="10335"><span data-slate-object="text" data-key="10336"><span data-slate-leaf="true" data-offset-key="10336:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Options 配置：</span></span></span></span><span data-slate-object="text" data-key="10337"><span data-slate-leaf="true" data-offset-key="10337:0" data-first-offset="true"><span data-slate-string="true">用来构建命令行参数，它的值来自于命令行选项或者配置文件（也可能是二者 Merge 后的配置）。Options 可以用来构建应用框架，Options 配置也是应用配置的输入。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10338"><span data-slate-object="text" data-key="10339"><span data-slate-leaf="true" data-offset-key="10339:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">应用</span></span></span></span><span data-slate-object="text" data-key="10340"><span data-slate-leaf="true" data-offset-key="10340:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">配置：</span></span></span></span><span data-slate-object="text" data-key="10341"><span data-slate-leaf="true" data-offset-key="10341:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 组件中需要的一切配置。有很多地方需要配置，例如，启动 HTTP/GRPC 需要配置监听地址和端口，初始化数据库需要配置数据库地址、用户名、密码等。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10342"><span data-slate-object="text" data-key="10343"><span data-slate-leaf="true" data-offset-key="10343:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">HTTP/GRPC 服务配置：</span></span></span></span><span data-slate-object="text" data-key="10344"><span data-slate-leaf="true" data-offset-key="10344:0" data-first-offset="true"><span data-slate-string="true">启动 HTTP 服务或者 GRPC 服务需要的配置。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10345"><span data-slate-object="text" data-key="10346"><span data-slate-leaf="true" data-offset-key="10346:0" data-first-offset="true"><span data-slate-string="true">这三种配置的关系如下图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10347"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/8c/b5/8ca8d9fa1efaab21e012471874e89cb5.jpg?wh=1346x727"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10348"><span data-slate-object="text" data-key="10349"><span data-slate-leaf="true" data-offset-key="10349:0" data-first-offset="true"><span data-slate-string="true">Options 配置接管命令行选项，应用配置接管整个应用的配置，HTTP/GRPC 服务配置接管跟 HTTP/GRPC 服务相关的配置。这 3 种配置独立开来，可以解耦命令行选项、应用和应用内的服务，使得这 3 个部分可以独立扩展，又不相互影响。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10350"><span data-slate-object="text" data-key="10351"><span data-slate-leaf="true" data-offset-key="10351:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 根据 Options 配置来构建命令行参数和应用配置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10352"><span data-slate-object="text" data-key="10353"><span data-slate-leaf="true" data-offset-key="10353:0" data-first-offset="true"><span data-slate-string="true">我们通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10354"><span data-slate-object="text" data-key="10355"><span data-slate-leaf="true" data-offset-key="10355:0" data-first-offset="true"><span data-slate-string="true"> github.com/marmotedu/iam/pkg/app</span></span></span></span><span data-slate-object="text" data-key="10356"><span data-slate-leaf="true" data-offset-key="10356:0" data-first-offset="true"><span data-slate-string="true"> 包的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10357"><span data-slate-object="text" data-key="10358"><span data-slate-leaf="true" data-offset-key="10358:0" data-first-offset="true"><span data-slate-string="true">buildCommand</span></span></span></a><span data-slate-object="text" data-key="10359"><span data-slate-leaf="true" data-offset-key="10359:0" data-first-offset="true"><span data-slate-string="true"> 方法来构建命令行参数。这里的核心是，通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10360"><span data-slate-object="text" data-key="10361"><span data-slate-leaf="true" data-offset-key="10361:0" data-first-offset="true"><span data-slate-string="true">NewApp</span></span></span></a><span data-slate-object="text" data-key="10362"><span data-slate-leaf="true" data-offset-key="10362:0" data-first-offset="true"><span data-slate-string="true"> 函数构建 Application 实例时，传入的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10363"><span data-slate-object="text" data-key="10364"><span data-slate-leaf="true" data-offset-key="10364:0" data-first-offset="true"><span data-slate-string="true">Options</span></span></span></a><span data-slate-object="text" data-key="10365"><span data-slate-leaf="true" data-offset-key="10365:0" data-first-offset="true"><span data-slate-string="true"> 实现了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10366"><span data-slate-object="text" data-key="10367"><span data-slate-leaf="true" data-offset-key="10367:0" data-first-offset="true"><span data-slate-string="true"> Flags() (fss cliflag.NamedFlagSets)</span></span></span></span><span data-slate-object="text" data-key="10368"><span data-slate-leaf="true" data-offset-key="10368:0" data-first-offset="true"><span data-slate-string="true"> 方法，通过 buildCommand 方法中的以下代码，将 option 的 Flag 添加到 cobra 实例的 FlagSet 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10369"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10370"><span data-slate-object="text" data-key="10371"><span data-slate-leaf="true" data-offset-key="10371:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10372"><span data-slate-leaf="true" data-offset-key="10372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10373"><span data-slate-leaf="true" data-offset-key="10373:0" data-first-offset="true"><span data-slate-string="true"> a.options != </span></span></span><span data-slate-object="text" data-key="10374"><span data-slate-leaf="true" data-offset-key="10374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10375"><span data-slate-leaf="true" data-offset-key="10375:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10376"><span data-slate-object="text" data-key="10377"><span data-slate-leaf="true" data-offset-key="10377:0" data-first-offset="true"><span data-slate-string="true">      namedFlagSets = a.options.Flags()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10378"><span data-slate-object="text" data-key="10379"><span data-slate-leaf="true" data-offset-key="10379:0" data-first-offset="true"><span data-slate-string="true">      fs := cmd.Flags()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10380"><span data-slate-object="text" data-key="10381"><span data-slate-leaf="true" data-offset-key="10381:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10382"><span data-slate-leaf="true" data-offset-key="10382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10383"><span data-slate-leaf="true" data-offset-key="10383:0" data-first-offset="true"><span data-slate-string="true"> _, f := </span></span></span><span data-slate-object="text" data-key="10384"><span data-slate-leaf="true" data-offset-key="10384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="10385"><span data-slate-leaf="true" data-offset-key="10385:0" data-first-offset="true"><span data-slate-string="true"> namedFlagSets.FlagSets {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10386"><span data-slate-object="text" data-key="10387"><span data-slate-leaf="true" data-offset-key="10387:0" data-first-offset="true"><span data-slate-string="true">        fs.AddFlagSet(f)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10388"><span data-slate-object="text" data-key="10389"><span data-slate-leaf="true" data-offset-key="10389:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10390"><span data-slate-object="text" data-key="10391"><span data-slate-leaf="true" data-offset-key="10391:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10392"><span data-slate-object="text" data-key="10393"><span data-slate-leaf="true" data-offset-key="10393:0" data-first-offset="true"><span data-slate-string="true">            ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10394"><span data-slate-object="text" data-key="10395"><span data-slate-leaf="true" data-offset-key="10395:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10396"><span data-slate-object="text" data-key="10397"><span data-slate-leaf="true" data-offset-key="10397:0" data-first-offset="true"><span data-slate-string="true">通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10398"><span data-slate-object="text" data-key="10399"><span data-slate-leaf="true" data-offset-key="10399:0" data-first-offset="true"><span data-slate-string="true">CreateConfigFromOptions</span></span></span></a><span data-slate-object="text" data-key="10400"><span data-slate-leaf="true" data-offset-key="10400:0" data-first-offset="true"><span data-slate-string="true"> 函数来构建应用配置：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10401"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10402"><span data-slate-object="text" data-key="10403"><span data-slate-leaf="true" data-offset-key="10403:0" data-first-offset="true"><span data-slate-string="true">        cfg, err := config.CreateConfigFromOptions(opts)                      </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10404"><span data-slate-object="text" data-key="10405"><span data-slate-leaf="true" data-offset-key="10405:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10406"><span data-slate-leaf="true" data-offset-key="10406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10407"><span data-slate-leaf="true" data-offset-key="10407:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="10408"><span data-slate-leaf="true" data-offset-key="10408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10409"><span data-slate-leaf="true" data-offset-key="10409:0" data-first-offset="true"><span data-slate-string="true"> {                                               </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10410"><span data-slate-object="text" data-key="10411"><span data-slate-leaf="true" data-offset-key="10411:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10412"><span data-slate-leaf="true" data-offset-key="10412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10413"><span data-slate-leaf="true" data-offset-key="10413:0" data-first-offset="true"><span data-slate-string="true"> err                                                </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10414"><span data-slate-object="text" data-key="10415"><span data-slate-leaf="true" data-offset-key="10415:0" data-first-offset="true"><span data-slate-string="true">        }  </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10416"><span data-slate-object="text" data-key="10417"><span data-slate-leaf="true" data-offset-key="10417:0" data-first-offset="true"><span data-slate-string="true">根据应用配置来构建 HTTP/GRPC 服务配置。例如，以下代码根据应用配置，构建了 HTTP 服务器的 Address 参数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10418"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10419"><span data-slate-object="text" data-key="10420"><span data-slate-leaf="true" data-offset-key="10420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10421"><span data-slate-leaf="true" data-offset-key="10421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10422"><span data-slate-leaf="true" data-offset-key="10422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *InsecureServingOptions)</span></span></span></span></span><span data-slate-object="text" data-key="10423"><span data-slate-leaf="true" data-offset-key="10423:0" data-first-offset="true"><span data-slate-string="true"> ApplyTo(c *server.Config) </span></span></span><span data-slate-object="text" data-key="10424"><span data-slate-leaf="true" data-offset-key="10424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="10425"><span data-slate-leaf="true" data-offset-key="10425:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10426"><span data-slate-object="text" data-key="10427"><span data-slate-leaf="true" data-offset-key="10427:0" data-first-offset="true"><span data-slate-string="true">    c.InsecureServing = &amp;server.InsecureServingInfo{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10428"><span data-slate-object="text" data-key="10429"><span data-slate-leaf="true" data-offset-key="10429:0" data-first-offset="true"><span data-slate-string="true">        Address: net.JoinHostPort(s.BindAddress, strconv.Itoa(s.BindPort)),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10430"><span data-slate-object="text" data-key="10431"><span data-slate-leaf="true" data-offset-key="10431:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10432"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10433"><span data-slate-object="text" data-key="10434"><span data-slate-leaf="true" data-offset-key="10434:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10435"><span data-slate-leaf="true" data-offset-key="10435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10436"><span data-slate-leaf="true" data-offset-key="10436:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10437"><span data-slate-leaf="true" data-offset-key="10437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10438"><span data-slate-object="text" data-key="10439"><span data-slate-leaf="true" data-offset-key="10439:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10440"><span data-slate-object="text" data-key="10441"><span data-slate-leaf="true" data-offset-key="10441:0" data-first-offset="true"><span data-slate-string="true">其中，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10442"><span data-slate-object="text" data-key="10443"><span data-slate-leaf="true" data-offset-key="10443:0" data-first-offset="true"><span data-slate-string="true">c *server.Config</span></span></span></span><span data-slate-object="text" data-key="10444"><span data-slate-leaf="true" data-offset-key="10444:0" data-first-offset="true"><span data-slate-string="true"> 是 HTTP 服务器的配置，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10445"><span data-slate-object="text" data-key="10446"><span data-slate-leaf="true" data-offset-key="10446:0" data-first-offset="true"><span data-slate-string="true">s *InsecureServingOptions</span></span></span></span><span data-slate-object="text" data-key="10447"><span data-slate-leaf="true" data-offset-key="10447:0" data-first-offset="true"><span data-slate-string="true"> 是应用配置。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10448" id="sr-toc-6"><span data-slate-object="text" data-key="10449"><span data-slate-leaf="true" data-offset-key="10449:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 启动流程设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10450"><span data-slate-object="text" data-key="10451"><span data-slate-leaf="true" data-offset-key="10451:0" data-first-offset="true"><span data-slate-string="true">接下来，我们来详细看下 iam-apiserver 的启动流程设计。启动流程如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10452"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/8a/c7/8a94938bc087ed96d0ec87261db292c7.jpg?wh=4770x1487"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10453"><span data-slate-object="text" data-key="10454"><span data-slate-leaf="true" data-offset-key="10454:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先，</span></span></span></span><span data-slate-object="text" data-key="10455"><span data-slate-leaf="true" data-offset-key="10455:0" data-first-offset="true"><span data-slate-string="true">通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10456"><span data-slate-object="text" data-key="10457"><span data-slate-leaf="true" data-offset-key="10457:0" data-first-offset="true"><span data-slate-string="true"> opts := options.NewOptions()</span></span></span></span><span data-slate-object="text" data-key="10458"><span data-slate-leaf="true" data-offset-key="10458:0" data-first-offset="true"><span data-slate-string="true"> 创建带有默认值的 Options 类型变量 opts。opts 变量作为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10459"><span data-slate-object="text" data-key="10460"><span data-slate-leaf="true" data-offset-key="10460:0" data-first-offset="true"><span data-slate-string="true"> github.com/marmotedu/iam/pkg/app</span></span></span></span><span data-slate-object="text" data-key="10461"><span data-slate-leaf="true" data-offset-key="10461:0" data-first-offset="true"><span data-slate-string="true"> 包的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10462"><span data-slate-object="text" data-key="10463"><span data-slate-leaf="true" data-offset-key="10463:0" data-first-offset="true"><span data-slate-string="true"> NewApp</span></span></span></span><span data-slate-object="text" data-key="10464"><span data-slate-leaf="true" data-offset-key="10464:0" data-first-offset="true"><span data-slate-string="true"> 函数的输入参数，最终在 App 框架中，被来自于命令行参数或配置文件的配置（也可能是二者 Merge 后的配置）所填充，opts 变量中各个字段的值会用来创建应用配置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10465"><span data-slate-object="text" data-key="10466"><span data-slate-leaf="true" data-offset-key="10466:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">接着，</span></span></span></span><span data-slate-object="text" data-key="10467"><span data-slate-leaf="true" data-offset-key="10467:0" data-first-offset="true"><span data-slate-string="true">会注册 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10468"><span data-slate-object="text" data-key="10469"><span data-slate-leaf="true" data-offset-key="10469:0" data-first-offset="true"><span data-slate-string="true">run</span></span></span></a><span data-slate-object="text" data-key="10470"><span data-slate-leaf="true" data-offset-key="10470:0" data-first-offset="true"><span data-slate-string="true"> 函数到 App 框架中。run 函数是 iam-apiserver 的启动函数，里面封装了我们自定义的启动逻辑。run 函数中，首先会初始化日志包，这样我们就可以根据需要，在后面的代码中随时记录日志了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10471"><span data-slate-object="text" data-key="10472"><span data-slate-leaf="true" data-offset-key="10472:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">然后，</span></span></span></span><span data-slate-object="text" data-key="10473"><span data-slate-leaf="true" data-offset-key="10473:0" data-first-offset="true"><span data-slate-string="true">会创建应用配置。应用配置和 Options 配置其实是完全独立的，二者可能完全不同，但在 iam-apiserver 中，二者配置项是相同的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10474"><span data-slate-object="text" data-key="10475"><span data-slate-leaf="true" data-offset-key="10475:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">之后，</span></span></span></span><span data-slate-object="text" data-key="10476"><span data-slate-leaf="true" data-offset-key="10476:0" data-first-offset="true"><span data-slate-string="true">根据应用配置，创建 HTTP/GRPC 服务器所使用的配置。在创建配置后，会先分别进行配置补全，再使用补全后的配置创建 Web 服务实例，例如：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10477"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10478"><span data-slate-object="text" data-key="10479"><span data-slate-leaf="true" data-offset-key="10479:0" data-first-offset="true"><span data-slate-string="true">genericServer, err := genericConfig.Complete().New()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10480"><span data-slate-object="text" data-key="10481"><span data-slate-leaf="true" data-offset-key="10481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10482"><span data-slate-leaf="true" data-offset-key="10482:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="10483"><span data-slate-leaf="true" data-offset-key="10483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10484"><span data-slate-leaf="true" data-offset-key="10484:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10485"><span data-slate-object="text" data-key="10486"><span data-slate-leaf="true" data-offset-key="10486:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10487"><span data-slate-leaf="true" data-offset-key="10487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10488"><span data-slate-leaf="true" data-offset-key="10488:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10489"><span data-slate-leaf="true" data-offset-key="10489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10490"><span data-slate-leaf="true" data-offset-key="10490:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10491"><span data-slate-object="text" data-key="10492"><span data-slate-leaf="true" data-offset-key="10492:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10493"><span data-slate-object="text" data-key="10494"><span data-slate-leaf="true" data-offset-key="10494:0" data-first-offset="true"><span data-slate-string="true">extraServer, err := extraConfig.complete().New()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10495"><span data-slate-object="text" data-key="10496"><span data-slate-leaf="true" data-offset-key="10496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10497"><span data-slate-leaf="true" data-offset-key="10497:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="10498"><span data-slate-leaf="true" data-offset-key="10498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10499"><span data-slate-leaf="true" data-offset-key="10499:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10500"><span data-slate-object="text" data-key="10501"><span data-slate-leaf="true" data-offset-key="10501:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10502"><span data-slate-leaf="true" data-offset-key="10502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10503"><span data-slate-leaf="true" data-offset-key="10503:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10504"><span data-slate-leaf="true" data-offset-key="10504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10505"><span data-slate-leaf="true" data-offset-key="10505:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10506"><span data-slate-object="text" data-key="10507"><span data-slate-leaf="true" data-offset-key="10507:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10508"><span data-slate-object="text" data-key="10509"><span data-slate-leaf="true" data-offset-key="10509:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10510"><span data-slate-object="text" data-key="10511"><span data-slate-leaf="true" data-offset-key="10511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10512"><span data-slate-leaf="true" data-offset-key="10512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10513"><span data-slate-leaf="true" data-offset-key="10513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *ExtraConfig)</span></span></span></span></span><span data-slate-object="text" data-key="10514"><span data-slate-leaf="true" data-offset-key="10514:0" data-first-offset="true"><span data-slate-string="true"> complete() *completedExtraConfig {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10515"><span data-slate-object="text" data-key="10516"><span data-slate-leaf="true" data-offset-key="10516:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10517"><span data-slate-leaf="true" data-offset-key="10517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10518"><span data-slate-leaf="true" data-offset-key="10518:0" data-first-offset="true"><span data-slate-string="true"> c.Addr == </span></span></span><span data-slate-object="text" data-key="10519"><span data-slate-leaf="true" data-offset-key="10519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="10520"><span data-slate-leaf="true" data-offset-key="10520:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10521"><span data-slate-object="text" data-key="10522"><span data-slate-leaf="true" data-offset-key="10522:0" data-first-offset="true"><span data-slate-string="true">        c.Addr = </span></span></span><span data-slate-object="text" data-key="10523"><span data-slate-leaf="true" data-offset-key="10523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"127.0.0.1:8081"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10524"><span data-slate-object="text" data-key="10525"><span data-slate-leaf="true" data-offset-key="10525:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10526"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10527"><span data-slate-object="text" data-key="10528"><span data-slate-leaf="true" data-offset-key="10528:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10529"><span data-slate-leaf="true" data-offset-key="10529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10530"><span data-slate-leaf="true" data-offset-key="10530:0" data-first-offset="true"><span data-slate-string="true"> &amp;completedExtraConfig{c}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10531"><span data-slate-object="text" data-key="10532"><span data-slate-leaf="true" data-offset-key="10532:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10533"><span data-slate-object="text" data-key="10534"><span data-slate-leaf="true" data-offset-key="10534:0" data-first-offset="true"><span data-slate-string="true">上面的代码中，首先调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10535"><span data-slate-object="text" data-key="10536"><span data-slate-leaf="true" data-offset-key="10536:0" data-first-offset="true"><span data-slate-string="true"> Complete</span></span></span></span><span data-slate-object="text" data-key="10537"><span data-slate-leaf="true" data-offset-key="10537:0" data-first-offset="true"><span data-slate-string="true">/</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10538"><span data-slate-object="text" data-key="10539"><span data-slate-leaf="true" data-offset-key="10539:0" data-first-offset="true"><span data-slate-string="true">complete</span></span></span></span><span data-slate-object="text" data-key="10540"><span data-slate-leaf="true" data-offset-key="10540:0" data-first-offset="true"><span data-slate-string="true"> 函数补全配置，再基于补全后的配置，New 一个 HTTP/GRPC 服务实例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10541"><span data-slate-object="text" data-key="10542"><span data-slate-leaf="true" data-offset-key="10542:0" data-first-offset="true"><span data-slate-string="true">这里有个设计技巧：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10543"><span data-slate-object="text" data-key="10544"><span data-slate-leaf="true" data-offset-key="10544:0" data-first-offset="true"><span data-slate-string="true">complete</span></span></span></span><span data-slate-object="text" data-key="10545"><span data-slate-leaf="true" data-offset-key="10545:0" data-first-offset="true"><span data-slate-string="true"> 函数返回的是一个</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10546"><span data-slate-object="text" data-key="10547"><span data-slate-leaf="true" data-offset-key="10547:0" data-first-offset="true"><span data-slate-string="true"> *completedExtraConfig</span></span></span></span><span data-slate-object="text" data-key="10548"><span data-slate-leaf="true" data-offset-key="10548:0" data-first-offset="true"><span data-slate-string="true"> 类型的实例，在创建 GRPC 实例时，是调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10549"><span data-slate-object="text" data-key="10550"><span data-slate-leaf="true" data-offset-key="10550:0" data-first-offset="true"><span data-slate-string="true"> completedExtraConfig</span></span></span></span><span data-slate-object="text" data-key="10551"><span data-slate-leaf="true" data-offset-key="10551:0" data-first-offset="true"><span data-slate-string="true"> 结构体提供的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10552"><span data-slate-object="text" data-key="10553"><span data-slate-leaf="true" data-offset-key="10553:0" data-first-offset="true"><span data-slate-string="true"> New</span></span></span></span><span data-slate-object="text" data-key="10554"><span data-slate-leaf="true" data-offset-key="10554:0" data-first-offset="true"><span data-slate-string="true"> 方法，这种设计方法可以确保我们创建的 GRPC 实例一定是基于 complete 之后的配置（completed）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10555"><span data-slate-object="text" data-key="10556"><span data-slate-leaf="true" data-offset-key="10556:0" data-first-offset="true"><span data-slate-string="true">在实际的 Go 项目开发中，我们需要提供一种机制来处理或补全配置，这在 Go 项目开发中是一个非常有用的步骤。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10557"><span data-slate-object="text" data-key="10558"><span data-slate-leaf="true" data-offset-key="10558:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最后，</span></span></span></span><span data-slate-object="text" data-key="10559"><span data-slate-leaf="true" data-offset-key="10559:0" data-first-offset="true"><span data-slate-string="true">调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10560"><span data-slate-object="text" data-key="10561"><span data-slate-leaf="true" data-offset-key="10561:0" data-first-offset="true"><span data-slate-string="true"> PrepareRun</span></span></span></span><span data-slate-object="text" data-key="10562"><span data-slate-leaf="true" data-offset-key="10562:0" data-first-offset="true"><span data-slate-string="true"> 方法，进行 HTTP/GRPC 服务器启动前的准备。在准备函数中，我们可以做各种初始化操作，例如初始化数据库，安装业务相关的 Gin 中间件、RESTful API 路由等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10563"><span data-slate-object="text" data-key="10564"><span data-slate-leaf="true" data-offset-key="10564:0" data-first-offset="true"><span data-slate-string="true">完成 HTTP/GRPC 服务器启动前的准备之后，调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10565"><span data-slate-object="text" data-key="10566"><span data-slate-leaf="true" data-offset-key="10566:0" data-first-offset="true"><span data-slate-string="true"> Run</span></span></span></span><span data-slate-object="text" data-key="10567"><span data-slate-leaf="true" data-offset-key="10567:0" data-first-offset="true"><span data-slate-string="true"> 方法启动 HTTP/GRPC 服务。在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10568"><span data-slate-object="text" data-key="10569"><span data-slate-leaf="true" data-offset-key="10569:0" data-first-offset="true"><span data-slate-string="true"> Run</span></span></span></span><span data-slate-object="text" data-key="10570"><span data-slate-leaf="true" data-offset-key="10570:0" data-first-offset="true"><span data-slate-string="true"> 方法中，分别启动了 GRPC 和 HTTP 服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10571"><span data-slate-object="text" data-key="10572"><span data-slate-leaf="true" data-offset-key="10572:0" data-first-offset="true"><span data-slate-string="true">可以看到，整个 iam-apiserver 的软件框架是比较清晰的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10573"><span data-slate-object="text" data-key="10574"><span data-slate-leaf="true" data-offset-key="10574:0" data-first-offset="true"><span data-slate-string="true">服务启动后，就可以处理请求了。所以接下来，我们再来看下 iam-apiserver 的 RESTAPI 请求处理流程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10575" id="sr-toc-7"><span data-slate-object="text" data-key="10576"><span data-slate-leaf="true" data-offset-key="10576:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 的 REST API 请求处理流程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10577"><span data-slate-object="text" data-key="10578"><span data-slate-leaf="true" data-offset-key="10578:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 的请求处理流程也是清晰、规范的，具体流程如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10579"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/94/76/9400e9855b10yyac47871a7af87e9776.jpg?wh=5771x1691"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10580"><span data-slate-object="text" data-key="10581"><span data-slate-leaf="true" data-offset-key="10581:0" data-first-offset="true"><span data-slate-string="true">结合上面这张图，我们来看下 iam-apiserver 的 REST API 请求处理流程，来帮你更好地理解 iam-apiserver 是如何处理 HTTP 请求的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10582"><span data-slate-object="text" data-key="10583"><span data-slate-leaf="true" data-offset-key="10583:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先，</span></span></span></span><span data-slate-object="text" data-key="10584"><span data-slate-leaf="true" data-offset-key="10584:0" data-first-offset="true"><span data-slate-string="true">我们通过 API 调用（</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10585"><span data-slate-object="text" data-key="10586"><span data-slate-leaf="true" data-offset-key="10586:0" data-first-offset="true"><span data-slate-string="true">&lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</span></span></span></span><span data-slate-object="text" data-key="10587"><span data-slate-leaf="true" data-offset-key="10587:0" data-first-offset="true"><span data-slate-string="true">）请求 iam-apiserver 提供的 RESTful API 接口。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10588"><span data-slate-object="text" data-key="10589"><span data-slate-leaf="true" data-offset-key="10589:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">接着，</span></span></span></span><span data-slate-object="text" data-key="10590"><span data-slate-leaf="true" data-offset-key="10590:0" data-first-offset="true"><span data-slate-string="true">Gin Web 框架接收到 HTTP 请求之后，会通过认证中间件完成请求的认证，iam-apiserver 提供了 Basic 认证和 Bearer 认证两种认证方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10591"><span data-slate-object="text" data-key="10592"><span data-slate-leaf="true" data-offset-key="10592:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">认证</span></span></span></span><span data-slate-object="text" data-key="10593"><span data-slate-leaf="true" data-offset-key="10593:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">通过后，</span></span></span></span><span data-slate-object="text" data-key="10594"><span data-slate-leaf="true" data-offset-key="10594:0" data-first-offset="true"><span data-slate-string="true">请求会被我们加载的一系列中间件所处理，例如跨域、RequestID、Dump 等中间件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10595"><span data-slate-object="text" data-key="10596"><span data-slate-leaf="true" data-offset-key="10596:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最后，</span></span></span></span><span data-slate-object="text" data-key="10597"><span data-slate-leaf="true" data-offset-key="10597:0" data-first-offset="true"><span data-slate-string="true">根据</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10598"><span data-slate-object="text" data-key="10599"><span data-slate-leaf="true" data-offset-key="10599:0" data-first-offset="true"><span data-slate-string="true"> &lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</span></span></span></span><span data-slate-object="text" data-key="10600"><span data-slate-leaf="true" data-offset-key="10600:0" data-first-offset="true"><span data-slate-string="true"> 进行路由匹配。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10601"><span data-slate-object="text" data-key="10602"><span data-slate-leaf="true" data-offset-key="10602:0" data-first-offset="true"><span data-slate-string="true">举个例子，假设我们请求的 RESTful API 是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10603"><span data-slate-object="text" data-key="10604"><span data-slate-leaf="true" data-offset-key="10604:0" data-first-offset="true"><span data-slate-string="true"> POST + /v1/secrets</span></span></span></span><span data-slate-object="text" data-key="10605"><span data-slate-leaf="true" data-offset-key="10605:0" data-first-offset="true"><span data-slate-string="true">，Gin Web 框架会根据 HTTP Method 和 HTTP Request Path，查找注册的 Controllers，最终匹配到 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10606"><span data-slate-object="text" data-key="10607"><span data-slate-leaf="true" data-offset-key="10607:0" data-first-offset="true"><span data-slate-string="true">secretController.Create</span></span></span></a><span data-slate-object="text" data-key="10608"><span data-slate-leaf="true" data-offset-key="10608:0" data-first-offset="true"><span data-slate-string="true">Controller。在 Create Controller 中，我们会依次执行请求参数解析、请求参数校验、调用业务层的方法创建 Secret、处理业务层的返回结果，最后返回最终的 HTTP 请求结果。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10609" id="sr-toc-8"><span data-slate-object="text" data-key="10610"><span data-slate-leaf="true" data-offset-key="10610:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 代码架构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10611"><span data-slate-object="text" data-key="10612"><span data-slate-leaf="true" data-offset-key="10612:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 代码设计遵循简洁架构设计，一个简洁架构具有以下 5 个特性：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10613"><div data-slate-type="list-line" data-slate-object="block" data-key="10614"><span data-slate-object="text" data-key="10615"><span data-slate-leaf="true" data-offset-key="10615:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">独立于框架：</span></span></span></span><span data-slate-object="text" data-key="10616"><span data-slate-leaf="true" data-offset-key="10616:0" data-first-offset="true"><span data-slate-string="true">该架构不会依赖于某些功能强大的软件库存在。这可以让你使用这样的框架作为工具，而不是让你的系统陷入到框架的约束中。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10617"><span data-slate-object="text" data-key="10618"><span data-slate-leaf="true" data-offset-key="10618:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">可测试性：</span></span></span></span><span data-slate-object="text" data-key="10619"><span data-slate-leaf="true" data-offset-key="10619:0" data-first-offset="true"><span data-slate-string="true">业务规则可以在没有 UI、数据库、Web 服务或其他外部元素的情况下进行测试，在实际的开发中，我们通过 Mock 来解耦这些依赖。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10620"><span data-slate-object="text" data-key="10621"><span data-slate-leaf="true" data-offset-key="10621:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">独立于 UI ：</span></span></span></span><span data-slate-object="text" data-key="10622"><span data-slate-leaf="true" data-offset-key="10622:0" data-first-offset="true"><span data-slate-string="true">在无需改变系统其他部分的情况下，UI 可以轻松地改变。例如，在没有改变业务规则的情况下，Web UI 可以替换为控制台 UI。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10623"><span data-slate-object="text" data-key="10624"><span data-slate-leaf="true" data-offset-key="10624:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">独立于数据库：</span></span></span></span><span data-slate-object="text" data-key="10625"><span data-slate-leaf="true" data-offset-key="10625:0" data-first-offset="true"><span data-slate-string="true">你可以用 Mongo、Oracle、Etcd 或者其他数据库来替换 MariaDB，你的业务规则不要绑定到数据库。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10626"><span data-slate-object="text" data-key="10627"><span data-slate-leaf="true" data-offset-key="10627:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">独立于外部媒介：</span></span></span></span><span data-slate-object="text" data-key="10628"><span data-slate-leaf="true" data-offset-key="10628:0" data-first-offset="true"><span data-slate-string="true">实际上，你的业务规则可以简单到根本不去了解外部世界。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10629"><span data-slate-object="text" data-key="10630"><span data-slate-leaf="true" data-offset-key="10630:0" data-first-offset="true"><span data-slate-string="true">所以，基于这些约束，每一层都必须是独立的和可测试的。iam-apiserver 代码架构分为 4 层：模型层（Models）、控制层（Controller）、业务层 （Service）、仓库层（Repository）。从控制层、业务层到仓库层，从左到右层级依次加深。模型层独立于其他层，可供其他层引用。如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10631"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f2/f0/f2fffd84dfbc1a6643887db3d5d541f0.jpg?wh=2498x747"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10632"><span data-slate-object="text" data-key="10633"><span data-slate-leaf="true" data-offset-key="10633:0" data-first-offset="true"><span data-slate-string="true">层与层之间导入包时，都有严格的导入关系，这可以防止包的循环导入问题。导入关系如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10634"><div data-slate-type="list-line" data-slate-object="block" data-key="10635"><span data-slate-object="text" data-key="10636"><span data-slate-leaf="true" data-offset-key="10636:0" data-first-offset="true"><span data-slate-string="true">模型层的包可以被仓库层、业务层和控制层导入；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10637"><span data-slate-object="text" data-key="10638"><span data-slate-leaf="true" data-offset-key="10638:0" data-first-offset="true"><span data-slate-string="true">控制层能够导入业务层和仓库层的包。这里需要注意，如果没有特殊需求，控制层要避免导入仓库层的包，控制层需要完成的业务功能都通过业务层来完成。这样可以使代码逻辑更加清晰、规范。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10639"><span data-slate-object="text" data-key="10640"><span data-slate-leaf="true" data-offset-key="10640:0" data-first-offset="true"><span data-slate-string="true">业务层能够导入仓库层的包。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10641"><span data-slate-object="text" data-key="10642"><span data-slate-leaf="true" data-offset-key="10642:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就来详细看下每一层所完成的功能，以及其中的一些注意点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10643"><div data-slate-type="list-line" data-slate-object="block" data-key="10644"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="10645"><span data-slate-leaf="true" data-offset-key="10645:0" data-first-offset="true"><span data-slate-string="true">模型层（Models）</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10646"><span data-slate-object="text" data-key="10647"><span data-slate-leaf="true" data-offset-key="10647:0" data-first-offset="true"><span data-slate-string="true">模型层在有些软件架构中也叫做实体层（Entities），模型会在每一层中使用，在这一层中存储对象的结构和它的方法。IAM 项目模型层中的模型存放在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10648"><span data-slate-object="text" data-key="10649"><span data-slate-leaf="true" data-offset-key="10649:0" data-first-offset="true"><span data-slate-string="true">github.com/marmotedu/api/apiserver/v1</span></span></span></a><span data-slate-object="text" data-key="10650"><span data-slate-leaf="true" data-offset-key="10650:0" data-first-offset="true"><span data-slate-string="true"> 目录下，定义了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10651"><span data-slate-object="text" data-key="10652"><span data-slate-leaf="true" data-offset-key="10652:0" data-first-offset="true"><span data-slate-string="true"> User</span></span></span></span><span data-slate-object="text" data-key="10653"><span data-slate-leaf="true" data-offset-key="10653:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10654"><span data-slate-object="text" data-key="10655"><span data-slate-leaf="true" data-offset-key="10655:0" data-first-offset="true"><span data-slate-string="true">UserList</span></span></span></span><span data-slate-object="text" data-key="10656"><span data-slate-leaf="true" data-offset-key="10656:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10657"><span data-slate-object="text" data-key="10658"><span data-slate-leaf="true" data-offset-key="10658:0" data-first-offset="true"><span data-slate-string="true">Secret</span></span></span></span><span data-slate-object="text" data-key="10659"><span data-slate-leaf="true" data-offset-key="10659:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10660"><span data-slate-object="text" data-key="10661"><span data-slate-leaf="true" data-offset-key="10661:0" data-first-offset="true"><span data-slate-string="true">SecretList</span></span></span></span><span data-slate-object="text" data-key="10662"><span data-slate-leaf="true" data-offset-key="10662:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10663"><span data-slate-object="text" data-key="10664"><span data-slate-leaf="true" data-offset-key="10664:0" data-first-offset="true"><span data-slate-string="true">Policy</span></span></span></span><span data-slate-object="text" data-key="10665"><span data-slate-leaf="true" data-offset-key="10665:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10666"><span data-slate-object="text" data-key="10667"><span data-slate-leaf="true" data-offset-key="10667:0" data-first-offset="true"><span data-slate-string="true">PolicyList</span></span></span></span><span data-slate-object="text" data-key="10668"><span data-slate-leaf="true" data-offset-key="10668:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10669"><span data-slate-object="text" data-key="10670"><span data-slate-leaf="true" data-offset-key="10670:0" data-first-offset="true"><span data-slate-string="true">AuthzPolicy</span></span></span></span><span data-slate-object="text" data-key="10671"><span data-slate-leaf="true" data-offset-key="10671:0" data-first-offset="true"><span data-slate-string="true"> 模型及其方法。例如：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="10672"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10673"><span data-slate-object="text" data-key="10674"><span data-slate-leaf="true" data-offset-key="10674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="10675"><span data-slate-leaf="true" data-offset-key="10675:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10676"><span data-slate-leaf="true" data-offset-key="10676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Secret</span></span></span></span><span data-slate-object="text" data-key="10677"><span data-slate-leaf="true" data-offset-key="10677:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10678"><span data-slate-leaf="true" data-offset-key="10678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="10679"><span data-slate-leaf="true" data-offset-key="10679:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10680"><span data-slate-object="text" data-key="10681"><span data-slate-leaf="true" data-offset-key="10681:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10682"><span data-slate-leaf="true" data-offset-key="10682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// May add TypeMeta in the future.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10683"><span data-slate-object="text" data-key="10684"><span data-slate-leaf="true" data-offset-key="10684:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10685"><span data-slate-leaf="true" data-offset-key="10685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// metav1.TypeMeta `json:",inline"`</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10686"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10687"><span data-slate-object="text" data-key="10688"><span data-slate-leaf="true" data-offset-key="10688:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10689"><span data-slate-leaf="true" data-offset-key="10689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Standard object's metadata.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10690"><span data-slate-object="text" data-key="10691"><span data-slate-leaf="true" data-offset-key="10691:0" data-first-offset="true"><span data-slate-string="true">  metav1.ObjectMeta `       json:</span></span></span><span data-slate-object="text" data-key="10692"><span data-slate-leaf="true" data-offset-key="10692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"metadata,omitempty"</span></span></span></span><span data-slate-object="text" data-key="10693"><span data-slate-leaf="true" data-offset-key="10693:0" data-first-offset="true"><span data-slate-string="true">`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10694"><span data-slate-object="text" data-key="10695"><span data-slate-leaf="true" data-offset-key="10695:0" data-first-offset="true"><span data-slate-string="true">  Username          string `json:</span></span></span><span data-slate-object="text" data-key="10696"><span data-slate-leaf="true" data-offset-key="10696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="10697"><span data-slate-leaf="true" data-offset-key="10697:0" data-first-offset="true"><span data-slate-string="true">           gorm:</span></span></span><span data-slate-object="text" data-key="10698"><span data-slate-leaf="true" data-offset-key="10698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"column:username"</span></span></span></span><span data-slate-object="text" data-key="10699"><span data-slate-leaf="true" data-offset-key="10699:0" data-first-offset="true"><span data-slate-string="true">  validate:</span></span></span><span data-slate-object="text" data-key="10700"><span data-slate-leaf="true" data-offset-key="10700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"omitempty"</span></span></span></span><span data-slate-object="text" data-key="10701"><span data-slate-leaf="true" data-offset-key="10701:0" data-first-offset="true"><span data-slate-string="true">`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10702"><span data-slate-object="text" data-key="10703"><span data-slate-leaf="true" data-offset-key="10703:0" data-first-offset="true"><span data-slate-string="true">  SecretID          string `json:</span></span></span><span data-slate-object="text" data-key="10704"><span data-slate-leaf="true" data-offset-key="10704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretID"</span></span></span></span><span data-slate-object="text" data-key="10705"><span data-slate-leaf="true" data-offset-key="10705:0" data-first-offset="true"><span data-slate-string="true">           gorm:</span></span></span><span data-slate-object="text" data-key="10706"><span data-slate-leaf="true" data-offset-key="10706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"column:secretID"</span></span></span></span><span data-slate-object="text" data-key="10707"><span data-slate-leaf="true" data-offset-key="10707:0" data-first-offset="true"><span data-slate-string="true">  validate:</span></span></span><span data-slate-object="text" data-key="10708"><span data-slate-leaf="true" data-offset-key="10708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"omitempty"</span></span></span></span><span data-slate-object="text" data-key="10709"><span data-slate-leaf="true" data-offset-key="10709:0" data-first-offset="true"><span data-slate-string="true">`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10710"><span data-slate-object="text" data-key="10711"><span data-slate-leaf="true" data-offset-key="10711:0" data-first-offset="true"><span data-slate-string="true">  SecretKey         string `json:</span></span></span><span data-slate-object="text" data-key="10712"><span data-slate-leaf="true" data-offset-key="10712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secretKey"</span></span></span></span><span data-slate-object="text" data-key="10713"><span data-slate-leaf="true" data-offset-key="10713:0" data-first-offset="true"><span data-slate-string="true">          gorm:</span></span></span><span data-slate-object="text" data-key="10714"><span data-slate-leaf="true" data-offset-key="10714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"column:secretKey"</span></span></span></span><span data-slate-object="text" data-key="10715"><span data-slate-leaf="true" data-offset-key="10715:0" data-first-offset="true"><span data-slate-string="true"> validate:</span></span></span><span data-slate-object="text" data-key="10716"><span data-slate-leaf="true" data-offset-key="10716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"omitempty"</span></span></span></span><span data-slate-object="text" data-key="10717"><span data-slate-leaf="true" data-offset-key="10717:0" data-first-offset="true"><span data-slate-string="true">`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10718"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10719"><span data-slate-object="text" data-key="10720"><span data-slate-leaf="true" data-offset-key="10720:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10721"><span data-slate-leaf="true" data-offset-key="10721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Required: true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10722"><span data-slate-object="text" data-key="10723"><span data-slate-leaf="true" data-offset-key="10723:0" data-first-offset="true"><span data-slate-string="true">  Expires     int64  `json:</span></span></span><span data-slate-object="text" data-key="10724"><span data-slate-leaf="true" data-offset-key="10724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expires"</span></span></span></span><span data-slate-object="text" data-key="10725"><span data-slate-leaf="true" data-offset-key="10725:0" data-first-offset="true"><span data-slate-string="true">     gorm:</span></span></span><span data-slate-object="text" data-key="10726"><span data-slate-leaf="true" data-offset-key="10726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"column:expires"</span></span></span></span><span data-slate-object="text" data-key="10727"><span data-slate-leaf="true" data-offset-key="10727:0" data-first-offset="true"><span data-slate-string="true">     validate:</span></span></span><span data-slate-object="text" data-key="10728"><span data-slate-leaf="true" data-offset-key="10728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"omitempty"</span></span></span></span><span data-slate-object="text" data-key="10729"><span data-slate-leaf="true" data-offset-key="10729:0" data-first-offset="true"><span data-slate-string="true">`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10730"><span data-slate-object="text" data-key="10731"><span data-slate-leaf="true" data-offset-key="10731:0" data-first-offset="true"><span data-slate-string="true">  Description string `json:</span></span></span><span data-slate-object="text" data-key="10732"><span data-slate-leaf="true" data-offset-key="10732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10733"><span data-slate-leaf="true" data-offset-key="10733:0" data-first-offset="true"><span data-slate-string="true"> gorm:</span></span></span><span data-slate-object="text" data-key="10734"><span data-slate-leaf="true" data-offset-key="10734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"column:description"</span></span></span></span><span data-slate-object="text" data-key="10735"><span data-slate-leaf="true" data-offset-key="10735:0" data-first-offset="true"><span data-slate-string="true"> validate:</span></span></span><span data-slate-object="text" data-key="10736"><span data-slate-leaf="true" data-offset-key="10736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="10737"><span data-slate-leaf="true" data-offset-key="10737:0" data-first-offset="true"><span data-slate-string="true">`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10738"><span data-slate-object="text" data-key="10739"><span data-slate-leaf="true" data-offset-key="10739:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10740"><span data-slate-object="text" data-key="10741"><span data-slate-leaf="true" data-offset-key="10741:0" data-first-offset="true"><span data-slate-string="true">之所以将模型层的模型存放在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10742"><span data-slate-object="text" data-key="10743"><span data-slate-leaf="true" data-offset-key="10743:0" data-first-offset="true"><span data-slate-string="true"> github.com/marmotedu/api</span></span></span></span><span data-slate-object="text" data-key="10744"><span data-slate-leaf="true" data-offset-key="10744:0" data-first-offset="true"><span data-slate-string="true"> 项目中，而不是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10745"><span data-slate-object="text" data-key="10746"><span data-slate-leaf="true" data-offset-key="10746:0" data-first-offset="true"><span data-slate-string="true"> github.com/marmotedu/iam</span></span></span></span><span data-slate-object="text" data-key="10747"><span data-slate-leaf="true" data-offset-key="10747:0" data-first-offset="true"><span data-slate-string="true"> 项目中，是为了让这些模型能够被其他项目使用。例如，iam 的模型可以被</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10748"><span data-slate-object="text" data-key="10749"><span data-slate-leaf="true" data-offset-key="10749:0" data-first-offset="true"><span data-slate-string="true"> github.com/marmotedu/shippy</span></span></span></span><span data-slate-object="text" data-key="10750"><span data-slate-leaf="true" data-offset-key="10750:0" data-first-offset="true"><span data-slate-string="true"> 应用导入。同样，shippy 应用的模型也可以被 iam 项目导入，导入关系如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10751"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/13/c9/1307e374f4193ecc3d5b73a987cdd0c9.jpg?wh=3896x1433"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10752"><span data-slate-object="text" data-key="10753"><span data-slate-leaf="true" data-offset-key="10753:0" data-first-offset="true"><span data-slate-string="true">上面的依赖关系都是单向的，依赖关系清晰，不存在循环依赖的情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10754"><span data-slate-object="text" data-key="10755"><span data-slate-leaf="true" data-offset-key="10755:0" data-first-offset="true"><span data-slate-string="true">要增加 shippy 的模型定义，只需要在 api 目录下创建新的目录即可。例如，shippy 应用中有一个 vessel 服务，其模型所在的包可以为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10756"><span data-slate-object="text" data-key="10757"><span data-slate-leaf="true" data-offset-key="10757:0" data-first-offset="true"><span data-slate-string="true"> github.com/marmotedu/api/vessel</span></span></span></span><span data-slate-object="text" data-key="10758"><span data-slate-leaf="true" data-offset-key="10758:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10759"><span data-slate-object="text" data-key="10760"><span data-slate-leaf="true" data-offset-key="10760:0" data-first-offset="true"><span data-slate-string="true">另外，这里的模型既可以作为数据库模型，又可以作为 API 接口的请求模型（入参、出参）。如果我们能够确保</span></span></span><span data-slate-object="text" data-key="10761"><span data-slate-leaf="true" data-offset-key="10761:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">创建资源时的属性</span></span></span></span><span data-slate-object="text" data-key="10762"><span data-slate-leaf="true" data-offset-key="10762:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-object="text" data-key="10763"><span data-slate-leaf="true" data-offset-key="10763:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">资源保存在数据库中的属性</span></span></span></span><span data-slate-object="text" data-key="10764"><span data-slate-leaf="true" data-offset-key="10764:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-object="text" data-key="10765"><span data-slate-leaf="true" data-offset-key="10765:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">返回资源的属性</span></span></span></span><span data-slate-object="text" data-key="10766"><span data-slate-leaf="true" data-offset-key="10766:0" data-first-offset="true"><span data-slate-string="true">三者一致，就可以使用同一个模型。通过使用同一个模型，可以使我们的代码更加简洁、易维护，并能提高开发效率。如果这三个属性有差异，你可以另外新建模型来适配。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10767"><div data-slate-type="list-line" data-slate-object="block" data-key="10768"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="10769"><span data-slate-leaf="true" data-offset-key="10769:0" data-first-offset="true"><span data-slate-string="true">仓库层（Repository)</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10770"><span data-slate-object="text" data-key="10771"><span data-slate-leaf="true" data-offset-key="10771:0" data-first-offset="true"><span data-slate-string="true">仓库层用来跟数据库 / 第三方服务进行 CURD 交互，作为应用程序的数据引擎进行应用数据的输入和输出。这里需要注意，仓库层仅对数据库 / 第三方服务执行 CRUD 操作，不封装任何业务逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10772"><span data-slate-object="text" data-key="10773"><span data-slate-leaf="true" data-offset-key="10773:0" data-first-offset="true"><span data-slate-string="true">仓库层也负责选择应用中将要使用什么样的数据库，可以是 MySQL、MongoDB、MariaDB、Etcd 等。无论使用哪种数据库，都要在这层决定。仓库层依赖于连接数据库或其他第三方服务（如果存在的话）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10774"><span data-slate-object="text" data-key="10775"><span data-slate-leaf="true" data-offset-key="10775:0" data-first-offset="true"><span data-slate-string="true">这一层也会起到数据转换的作用：将从数据库 / 微服务中获取的数据转换为控制层、业务层能识别的数据结构，将控制层、业务层的数据格式转换为数据库或微服务能识别的数据格式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10776"><span data-slate-object="text" data-key="10777"><span data-slate-leaf="true" data-offset-key="10777:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 的仓库层位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10778"><span data-slate-object="text" data-key="10779"><span data-slate-leaf="true" data-offset-key="10779:0" data-first-offset="true"><span data-slate-string="true">internal/apiserver/store/mysql</span></span></span></a><span data-slate-object="text" data-key="10780"><span data-slate-leaf="true" data-offset-key="10780:0" data-first-offset="true"><span data-slate-string="true"> 目录下，里面的方法用来跟 MariaDB 进行交互，完成 CURD 操作，例如，从数据库中获取密钥：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10781"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10782"><span data-slate-object="text" data-key="10783"><span data-slate-leaf="true" data-offset-key="10783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10784"><span data-slate-leaf="true" data-offset-key="10784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10785"><span data-slate-leaf="true" data-offset-key="10785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *secrets)</span></span></span></span></span><span data-slate-object="text" data-key="10786"><span data-slate-leaf="true" data-offset-key="10786:0" data-first-offset="true"><span data-slate-string="true"> Get(ctx context.Context, username, name </span></span></span><span data-slate-object="text" data-key="10787"><span data-slate-leaf="true" data-offset-key="10787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="10788"><span data-slate-leaf="true" data-offset-key="10788:0" data-first-offset="true"><span data-slate-string="true">, opts metav1.GetOptions) (*v1.Secret, </span></span></span><span data-slate-object="text" data-key="10789"><span data-slate-leaf="true" data-offset-key="10789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="10790"><span data-slate-leaf="true" data-offset-key="10790:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10791"><span data-slate-object="text" data-key="10792"><span data-slate-leaf="true" data-offset-key="10792:0" data-first-offset="true"><span data-slate-string="true">    secret := &amp;v1.Secret{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10793"><span data-slate-object="text" data-key="10794"><span data-slate-leaf="true" data-offset-key="10794:0" data-first-offset="true"><span data-slate-string="true">    err := s.db.Where(</span></span></span><span data-slate-object="text" data-key="10795"><span data-slate-leaf="true" data-offset-key="10795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username = ? and name= ?"</span></span></span></span><span data-slate-object="text" data-key="10796"><span data-slate-leaf="true" data-offset-key="10796:0" data-first-offset="true"><span data-slate-string="true">, username, name).First(&amp;secret).Error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10797"><span data-slate-object="text" data-key="10798"><span data-slate-leaf="true" data-offset-key="10798:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10799"><span data-slate-leaf="true" data-offset-key="10799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10800"><span data-slate-leaf="true" data-offset-key="10800:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="10801"><span data-slate-leaf="true" data-offset-key="10801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10802"><span data-slate-leaf="true" data-offset-key="10802:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10803"><span data-slate-object="text" data-key="10804"><span data-slate-leaf="true" data-offset-key="10804:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10805"><span data-slate-leaf="true" data-offset-key="10805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10806"><span data-slate-leaf="true" data-offset-key="10806:0" data-first-offset="true"><span data-slate-string="true"> errors.Is(err, gorm.ErrRecordNotFound) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10807"><span data-slate-object="text" data-key="10808"><span data-slate-leaf="true" data-offset-key="10808:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10809"><span data-slate-leaf="true" data-offset-key="10809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10810"><span data-slate-leaf="true" data-offset-key="10810:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10811"><span data-slate-leaf="true" data-offset-key="10811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10812"><span data-slate-leaf="true" data-offset-key="10812:0" data-first-offset="true"><span data-slate-string="true">, errors.WithCode(code.ErrSecretNotFound, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10813"><span data-slate-object="text" data-key="10814"><span data-slate-leaf="true" data-offset-key="10814:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10815"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10816"><span data-slate-object="text" data-key="10817"><span data-slate-leaf="true" data-offset-key="10817:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10818"><span data-slate-leaf="true" data-offset-key="10818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10819"><span data-slate-leaf="true" data-offset-key="10819:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10820"><span data-slate-leaf="true" data-offset-key="10820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10821"><span data-slate-leaf="true" data-offset-key="10821:0" data-first-offset="true"><span data-slate-string="true">, errors.WithCode(code.ErrDatabase, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10822"><span data-slate-object="text" data-key="10823"><span data-slate-leaf="true" data-offset-key="10823:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10824"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10825"><span data-slate-object="text" data-key="10826"><span data-slate-leaf="true" data-offset-key="10826:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10827"><span data-slate-leaf="true" data-offset-key="10827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10828"><span data-slate-leaf="true" data-offset-key="10828:0" data-first-offset="true"><span data-slate-string="true"> secret, </span></span></span><span data-slate-object="text" data-key="10829"><span data-slate-leaf="true" data-offset-key="10829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10830"><span data-slate-object="text" data-key="10831"><span data-slate-leaf="true" data-offset-key="10831:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="10832"><div data-slate-type="list-line" data-slate-object="block" data-key="10833"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="10834"><span data-slate-leaf="true" data-offset-key="10834:0" data-first-offset="true"><span data-slate-string="true">业务层 (Service)</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10835"><span data-slate-object="text" data-key="10836"><span data-slate-leaf="true" data-offset-key="10836:0" data-first-offset="true"><span data-slate-string="true">业务层主要用来完成业务逻辑处理，我们可以把所有的业务逻辑处理代码放在业务层。业务层会处理来自控制层的请求，并根据需要请求仓库层完成数据的 CURD 操作。业务层功能如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10837"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/61/b6/6103c58d837fd81769977bc3c947ffb6.jpg?wh=1796x1236"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10838"><span data-slate-object="text" data-key="10839"><span data-slate-leaf="true" data-offset-key="10839:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 的业务层位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10840"><span data-slate-object="text" data-key="10841"><span data-slate-leaf="true" data-offset-key="10841:0" data-first-offset="true"><span data-slate-string="true">internal/apiserver/service</span></span></span></a><span data-slate-object="text" data-key="10842"><span data-slate-leaf="true" data-offset-key="10842:0" data-first-offset="true"><span data-slate-string="true"> 目录下。下面是 iam-apiserver 业务层中，用来创建密钥的函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10843"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10844"><span data-slate-object="text" data-key="10845"><span data-slate-leaf="true" data-offset-key="10845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10846"><span data-slate-leaf="true" data-offset-key="10846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10847"><span data-slate-leaf="true" data-offset-key="10847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *secretService)</span></span></span></span></span><span data-slate-object="text" data-key="10848"><span data-slate-leaf="true" data-offset-key="10848:0" data-first-offset="true"><span data-slate-string="true"> Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) </span></span></span><span data-slate-object="text" data-key="10849"><span data-slate-leaf="true" data-offset-key="10849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="10850"><span data-slate-leaf="true" data-offset-key="10850:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10851"><span data-slate-object="text" data-key="10852"><span data-slate-leaf="true" data-offset-key="10852:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10853"><span data-slate-leaf="true" data-offset-key="10853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10854"><span data-slate-leaf="true" data-offset-key="10854:0" data-first-offset="true"><span data-slate-string="true"> err := s.store.Secrets().Create(ctx, secret, opts); err != </span></span></span><span data-slate-object="text" data-key="10855"><span data-slate-leaf="true" data-offset-key="10855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10856"><span data-slate-leaf="true" data-offset-key="10856:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10857"><span data-slate-object="text" data-key="10858"><span data-slate-leaf="true" data-offset-key="10858:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10859"><span data-slate-leaf="true" data-offset-key="10859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10860"><span data-slate-leaf="true" data-offset-key="10860:0" data-first-offset="true"><span data-slate-string="true"> errors.WithCode(code.ErrDatabase, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10861"><span data-slate-object="text" data-key="10862"><span data-slate-leaf="true" data-offset-key="10862:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10863"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10864"><span data-slate-object="text" data-key="10865"><span data-slate-leaf="true" data-offset-key="10865:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10866"><span data-slate-leaf="true" data-offset-key="10866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10867"><span data-slate-leaf="true" data-offset-key="10867:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10868"><span data-slate-leaf="true" data-offset-key="10868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10869"><span data-slate-object="text" data-key="10870"><span data-slate-leaf="true" data-offset-key="10870:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10871"><span data-slate-object="text" data-key="10872"><span data-slate-leaf="true" data-offset-key="10872:0" data-first-offset="true"><span data-slate-string="true">可以看到，业务层最终请求仓库层的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10873"><span data-slate-object="text" data-key="10874"><span data-slate-leaf="true" data-offset-key="10874:0" data-first-offset="true"><span data-slate-string="true"> s.store</span></span></span></span><span data-slate-object="text" data-key="10875"><span data-slate-leaf="true" data-offset-key="10875:0" data-first-offset="true"><span data-slate-string="true"> 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="10876"><span data-slate-object="text" data-key="10877"><span data-slate-leaf="true" data-offset-key="10877:0" data-first-offset="true"><span data-slate-string="true"> Create</span></span></span></span><span data-slate-object="text" data-key="10878"><span data-slate-leaf="true" data-offset-key="10878:0" data-first-offset="true"><span data-slate-string="true"> 方法，将密钥信息保存在 MariaDB 数据库中。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10879"><div data-slate-type="list-line" data-slate-object="block" data-key="10880"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="10881"><span data-slate-leaf="true" data-offset-key="10881:0" data-first-offset="true"><span data-slate-string="true">控制层（Controller）</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10882"><span data-slate-object="text" data-key="10883"><span data-slate-leaf="true" data-offset-key="10883:0" data-first-offset="true"><span data-slate-string="true">控制层接收 HTTP 请求，并进行参数解析、参数校验、逻辑分发处理、请求返回这些操作。控制层会将逻辑分发给业务层，业务层处理后返回，返回数据在控制层中被整合再加工，最终返回给请求方。控制层相当于实现了业务路由的功能。具体流程如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10884"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/12/08/120137fc2749aa12a013099ec11e1b08.jpg?wh=960x1029"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10885"><span data-slate-object="text" data-key="10886"><span data-slate-leaf="true" data-offset-key="10886:0" data-first-offset="true"><span data-slate-string="true">这里我有个建议，不要在控制层写复杂的代码，如果需要，请将这些代码分发到业务层或其他包中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10887"><span data-slate-object="text" data-key="10888"><span data-slate-leaf="true" data-offset-key="10888:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 的控制层位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10889"><span data-slate-object="text" data-key="10890"><span data-slate-leaf="true" data-offset-key="10890:0" data-first-offset="true"><span data-slate-string="true">internal/apiserver/controller</span></span></span></a><span data-slate-object="text" data-key="10891"><span data-slate-leaf="true" data-offset-key="10891:0" data-first-offset="true"><span data-slate-string="true"> 目录下。下面是 iam-apiserver 控制层中创建密钥的代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10892"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10893"><span data-slate-object="text" data-key="10894"><span data-slate-leaf="true" data-offset-key="10894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10895"><span data-slate-leaf="true" data-offset-key="10895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10896"><span data-slate-leaf="true" data-offset-key="10896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *SecretHandler)</span></span></span></span></span><span data-slate-object="text" data-key="10897"><span data-slate-leaf="true" data-offset-key="10897:0" data-first-offset="true"><span data-slate-string="true"> Create(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10898"><span data-slate-object="text" data-key="10899"><span data-slate-leaf="true" data-offset-key="10899:0" data-first-offset="true"><span data-slate-string="true">  log.L(c).Info(</span></span></span><span data-slate-object="text" data-key="10900"><span data-slate-leaf="true" data-offset-key="10900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"create secret function called."</span></span></span></span><span data-slate-object="text" data-key="10901"><span data-slate-leaf="true" data-offset-key="10901:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10902"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10903"><span data-slate-object="text" data-key="10904"><span data-slate-leaf="true" data-offset-key="10904:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10905"><span data-slate-leaf="true" data-offset-key="10905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="10906"><span data-slate-leaf="true" data-offset-key="10906:0" data-first-offset="true"><span data-slate-string="true"> r v1.Secret</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10907"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10908"><span data-slate-object="text" data-key="10909"><span data-slate-leaf="true" data-offset-key="10909:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10910"><span data-slate-leaf="true" data-offset-key="10910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10911"><span data-slate-leaf="true" data-offset-key="10911:0" data-first-offset="true"><span data-slate-string="true"> err := c.ShouldBindJSON(&amp;r); err != </span></span></span><span data-slate-object="text" data-key="10912"><span data-slate-leaf="true" data-offset-key="10912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10913"><span data-slate-leaf="true" data-offset-key="10913:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10914"><span data-slate-object="text" data-key="10915"><span data-slate-leaf="true" data-offset-key="10915:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, errors.WithCode(code.ErrBind, err.Error()), </span></span></span><span data-slate-object="text" data-key="10916"><span data-slate-leaf="true" data-offset-key="10916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10917"><span data-slate-leaf="true" data-offset-key="10917:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10918"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10919"><span data-slate-object="text" data-key="10920"><span data-slate-leaf="true" data-offset-key="10920:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10921"><span data-slate-leaf="true" data-offset-key="10921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10922"><span data-slate-object="text" data-key="10923"><span data-slate-leaf="true" data-offset-key="10923:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10924"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10925"><span data-slate-object="text" data-key="10926"><span data-slate-leaf="true" data-offset-key="10926:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10927"><span data-slate-leaf="true" data-offset-key="10927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10928"><span data-slate-leaf="true" data-offset-key="10928:0" data-first-offset="true"><span data-slate-string="true"> errs := r.Validate(); </span></span></span><span data-slate-object="text" data-key="10929"><span data-slate-leaf="true" data-offset-key="10929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="10930"><span data-slate-leaf="true" data-offset-key="10930:0" data-first-offset="true"><span data-slate-string="true">(errs) != </span></span></span><span data-slate-object="text" data-key="10931"><span data-slate-leaf="true" data-offset-key="10931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10932"><span data-slate-leaf="true" data-offset-key="10932:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10933"><span data-slate-object="text" data-key="10934"><span data-slate-leaf="true" data-offset-key="10934:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, errors.WithCode(code.ErrValidation, errs.ToAggregate().Error()), </span></span></span><span data-slate-object="text" data-key="10935"><span data-slate-leaf="true" data-offset-key="10935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10936"><span data-slate-leaf="true" data-offset-key="10936:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10937"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10938"><span data-slate-object="text" data-key="10939"><span data-slate-leaf="true" data-offset-key="10939:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10940"><span data-slate-leaf="true" data-offset-key="10940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10941"><span data-slate-object="text" data-key="10942"><span data-slate-leaf="true" data-offset-key="10942:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10943"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10944"><span data-slate-object="text" data-key="10945"><span data-slate-leaf="true" data-offset-key="10945:0" data-first-offset="true"><span data-slate-string="true">  username := c.GetString(middleware.UsernameKey)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10946"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10947"><span data-slate-object="text" data-key="10948"><span data-slate-leaf="true" data-offset-key="10948:0" data-first-offset="true"><span data-slate-string="true">  secrets, err := s.srv.Secrets().List(c, username, metav1.ListOptions{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10949"><span data-slate-object="text" data-key="10950"><span data-slate-leaf="true" data-offset-key="10950:0" data-first-offset="true"><span data-slate-string="true">    Offset: pointer.ToInt64(</span></span></span><span data-slate-object="text" data-key="10951"><span data-slate-leaf="true" data-offset-key="10951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10952"><span data-slate-leaf="true" data-offset-key="10952:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10953"><span data-slate-object="text" data-key="10954"><span data-slate-leaf="true" data-offset-key="10954:0" data-first-offset="true"><span data-slate-string="true">    Limit:  pointer.ToInt64(</span></span></span><span data-slate-object="text" data-key="10955"><span data-slate-leaf="true" data-offset-key="10955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="10956"><span data-slate-leaf="true" data-offset-key="10956:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10957"><span data-slate-object="text" data-key="10958"><span data-slate-leaf="true" data-offset-key="10958:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10959"><span data-slate-object="text" data-key="10960"><span data-slate-leaf="true" data-offset-key="10960:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10961"><span data-slate-leaf="true" data-offset-key="10961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10962"><span data-slate-leaf="true" data-offset-key="10962:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="10963"><span data-slate-leaf="true" data-offset-key="10963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10964"><span data-slate-leaf="true" data-offset-key="10964:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10965"><span data-slate-object="text" data-key="10966"><span data-slate-leaf="true" data-offset-key="10966:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, errors.WithCode(code.ErrDatabase, err.Error()), </span></span></span><span data-slate-object="text" data-key="10967"><span data-slate-leaf="true" data-offset-key="10967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10968"><span data-slate-leaf="true" data-offset-key="10968:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10969"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10970"><span data-slate-object="text" data-key="10971"><span data-slate-leaf="true" data-offset-key="10971:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10972"><span data-slate-leaf="true" data-offset-key="10972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10973"><span data-slate-object="text" data-key="10974"><span data-slate-leaf="true" data-offset-key="10974:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10975"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10976"><span data-slate-object="text" data-key="10977"><span data-slate-leaf="true" data-offset-key="10977:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10978"><span data-slate-leaf="true" data-offset-key="10978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10979"><span data-slate-leaf="true" data-offset-key="10979:0" data-first-offset="true"><span data-slate-string="true"> secrets.TotalCount &gt;= maxSecretCount {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10980"><span data-slate-object="text" data-key="10981"><span data-slate-leaf="true" data-offset-key="10981:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, errors.WithCode(code.ErrReachMaxCount, </span></span></span><span data-slate-object="text" data-key="10982"><span data-slate-leaf="true" data-offset-key="10982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"secret count: %d"</span></span></span></span><span data-slate-object="text" data-key="10983"><span data-slate-leaf="true" data-offset-key="10983:0" data-first-offset="true"><span data-slate-string="true">, secrets.TotalCount), </span></span></span><span data-slate-object="text" data-key="10984"><span data-slate-leaf="true" data-offset-key="10984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="10985"><span data-slate-leaf="true" data-offset-key="10985:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10986"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10987"><span data-slate-object="text" data-key="10988"><span data-slate-leaf="true" data-offset-key="10988:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10989"><span data-slate-leaf="true" data-offset-key="10989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10990"><span data-slate-object="text" data-key="10991"><span data-slate-leaf="true" data-offset-key="10991:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10992"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10993"><span data-slate-object="text" data-key="10994"><span data-slate-leaf="true" data-offset-key="10994:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10995"><span data-slate-leaf="true" data-offset-key="10995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// must reassign username</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10996"><span data-slate-object="text" data-key="10997"><span data-slate-leaf="true" data-offset-key="10997:0" data-first-offset="true"><span data-slate-string="true">  r.Username = username</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10998"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10999"><span data-slate-object="text" data-key="11000"><span data-slate-leaf="true" data-offset-key="11000:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11001"><span data-slate-leaf="true" data-offset-key="11001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11002"><span data-slate-leaf="true" data-offset-key="11002:0" data-first-offset="true"><span data-slate-string="true"> err := s.srv.Secrets().Create(c, &amp;r, metav1.CreateOptions{}); err != </span></span></span><span data-slate-object="text" data-key="11003"><span data-slate-leaf="true" data-offset-key="11003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11004"><span data-slate-leaf="true" data-offset-key="11004:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11005"><span data-slate-object="text" data-key="11006"><span data-slate-leaf="true" data-offset-key="11006:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, err, </span></span></span><span data-slate-object="text" data-key="11007"><span data-slate-leaf="true" data-offset-key="11007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11008"><span data-slate-leaf="true" data-offset-key="11008:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11009"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11010"><span data-slate-object="text" data-key="11011"><span data-slate-leaf="true" data-offset-key="11011:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11012"><span data-slate-leaf="true" data-offset-key="11012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11013"><span data-slate-object="text" data-key="11014"><span data-slate-leaf="true" data-offset-key="11014:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11015"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11016"><span data-slate-object="text" data-key="11017"><span data-slate-leaf="true" data-offset-key="11017:0" data-first-offset="true"><span data-slate-string="true">  core.WriteResponse(c, </span></span></span><span data-slate-object="text" data-key="11018"><span data-slate-leaf="true" data-offset-key="11018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11019"><span data-slate-leaf="true" data-offset-key="11019:0" data-first-offset="true"><span data-slate-string="true">, r)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11020"><span data-slate-object="text" data-key="11021"><span data-slate-leaf="true" data-offset-key="11021:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11022"><span data-slate-object="text" data-key="11023"><span data-slate-leaf="true" data-offset-key="11023:0" data-first-offset="true"><span data-slate-string="true">上面的代码完成了以下操作：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11024"><div data-slate-type="list-line" data-slate-object="block" data-key="11025"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="11026"><span data-slate-leaf="true" data-offset-key="11026:0" data-first-offset="true"><span data-slate-string="true">解析 HTTP 请求参数。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11027"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="11028"><span data-slate-leaf="true" data-offset-key="11028:0" data-first-offset="true"><span data-slate-string="true">进行参数验证，这里可以添加一些业务性质的参数校验，例如：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11029"><span data-slate-object="text" data-key="11030"><span data-slate-leaf="true" data-offset-key="11030:0" data-first-offset="true"><span data-slate-string="true">secrets.TotalCount &gt;= maxSecretCount</span></span></span></span><span data-slate-object="text" data-key="11031"><span data-slate-leaf="true" data-offset-key="11031:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11032"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="11033"><span data-slate-leaf="true" data-offset-key="11033:0" data-first-offset="true"><span data-slate-string="true">调用业务层</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11034"><span data-slate-object="text" data-key="11035"><span data-slate-leaf="true" data-offset-key="11035:0" data-first-offset="true"><span data-slate-string="true"> s.srv</span></span></span></span><span data-slate-object="text" data-key="11036"><span data-slate-leaf="true" data-offset-key="11036:0" data-first-offset="true"><span data-slate-string="true"> 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11037"><span data-slate-object="text" data-key="11038"><span data-slate-leaf="true" data-offset-key="11038:0" data-first-offset="true"><span data-slate-string="true"> Create</span></span></span></span><span data-slate-object="text" data-key="11039"><span data-slate-leaf="true" data-offset-key="11039:0" data-first-offset="true"><span data-slate-string="true"> 方法，完成密钥的创建。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11040"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="11041"><span data-slate-leaf="true" data-offset-key="11041:0" data-first-offset="true"><span data-slate-string="true">返回 HTTP 请求参数。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11042"><span data-slate-object="text" data-key="11043"><span data-slate-leaf="true" data-offset-key="11043:0" data-first-offset="true"><span data-slate-string="true">上面，我们介绍了 iam-apiserver 采用的 4 层结构，接下来我们再看看</span></span></span><span data-slate-object="text" data-key="11044"><span data-slate-leaf="true" data-offset-key="11044:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">每一层之间是如何通信的</span></span></span></span><span data-slate-object="text" data-key="11045"><span data-slate-leaf="true" data-offset-key="11045:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11046"><span data-slate-object="text" data-key="11047"><span data-slate-leaf="true" data-offset-key="11047:0" data-first-offset="true"><span data-slate-string="true">除了模型层，控制层、业务层、仓库层之间都是通过接口进行通信的。通过接口通信，一方面可以使相同的功能支持不同的实现（也就是说具有插件化能力），另一方面也使得每一层的代码变得可测试。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11048"><span data-slate-object="text" data-key="11049"><span data-slate-leaf="true" data-offset-key="11049:0" data-first-offset="true"><span data-slate-string="true">这里，我用创建密钥 API 请求的例子，来给你讲解下层与层之间是如何进行通信的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11050"><span data-slate-object="text" data-key="11051"><span data-slate-leaf="true" data-offset-key="11051:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先，来看下控制层如何跟业务层进行通信。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11052"><span data-slate-object="text" data-key="11053"><span data-slate-leaf="true" data-offset-key="11053:0" data-first-offset="true"><span data-slate-string="true">对密钥的请求处理都是通过 SecretController 提供的方法来处理的，创建密钥调用的是它的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11054"><span data-slate-object="text" data-key="11055"><span data-slate-leaf="true" data-offset-key="11055:0" data-first-offset="true"><span data-slate-string="true"> Create</span></span></span></span><span data-slate-object="text" data-key="11056"><span data-slate-leaf="true" data-offset-key="11056:0" data-first-offset="true"><span data-slate-string="true"> 方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="11057"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11058"><span data-slate-object="text" data-key="11059"><span data-slate-leaf="true" data-offset-key="11059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="11060"><span data-slate-leaf="true" data-offset-key="11060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11061"><span data-slate-leaf="true" data-offset-key="11061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *SecretController)</span></span></span></span></span><span data-slate-object="text" data-key="11062"><span data-slate-leaf="true" data-offset-key="11062:0" data-first-offset="true"><span data-slate-string="true"> Create(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11063"><span data-slate-object="text" data-key="11064"><span data-slate-leaf="true" data-offset-key="11064:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11065"><span data-slate-object="text" data-key="11066"><span data-slate-leaf="true" data-offset-key="11066:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11067"><span data-slate-leaf="true" data-offset-key="11067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11068"><span data-slate-leaf="true" data-offset-key="11068:0" data-first-offset="true"><span data-slate-string="true"> err := s.srv.Secrets().Create(c, &amp;r, metav1.CreateOptions{}); err != </span></span></span><span data-slate-object="text" data-key="11069"><span data-slate-leaf="true" data-offset-key="11069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11070"><span data-slate-leaf="true" data-offset-key="11070:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11071"><span data-slate-object="text" data-key="11072"><span data-slate-leaf="true" data-offset-key="11072:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, err, </span></span></span><span data-slate-object="text" data-key="11073"><span data-slate-leaf="true" data-offset-key="11073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11074"><span data-slate-leaf="true" data-offset-key="11074:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11075"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11076"><span data-slate-object="text" data-key="11077"><span data-slate-leaf="true" data-offset-key="11077:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11078"><span data-slate-leaf="true" data-offset-key="11078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11079"><span data-slate-object="text" data-key="11080"><span data-slate-leaf="true" data-offset-key="11080:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11081"><span data-slate-object="text" data-key="11082"><span data-slate-leaf="true" data-offset-key="11082:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11083"><span data-slate-object="text" data-key="11084"><span data-slate-leaf="true" data-offset-key="11084:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11085"><span data-slate-object="text" data-key="11086"><span data-slate-leaf="true" data-offset-key="11086:0" data-first-offset="true"><span data-slate-string="true">在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11087"><span data-slate-object="text" data-key="11088"><span data-slate-leaf="true" data-offset-key="11088:0" data-first-offset="true"><span data-slate-string="true"> Create</span></span></span></span><span data-slate-object="text" data-key="11089"><span data-slate-leaf="true" data-offset-key="11089:0" data-first-offset="true"><span data-slate-string="true"> 方法中，调用了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11090"><span data-slate-object="text" data-key="11091"><span data-slate-leaf="true" data-offset-key="11091:0" data-first-offset="true"><span data-slate-string="true"> s.srv.Secrets().Create()</span></span></span></span><span data-slate-object="text" data-key="11092"><span data-slate-leaf="true" data-offset-key="11092:0" data-first-offset="true"><span data-slate-string="true"> 来创建密钥，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11093"><span data-slate-object="text" data-key="11094"><span data-slate-leaf="true" data-offset-key="11094:0" data-first-offset="true"><span data-slate-string="true">s.srv</span></span></span></span><span data-slate-object="text" data-key="11095"><span data-slate-leaf="true" data-offset-key="11095:0" data-first-offset="true"><span data-slate-string="true"> 是一个接口类型，定义如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="11096"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11097"><span data-slate-object="text" data-key="11098"><span data-slate-leaf="true" data-offset-key="11098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11099"><span data-slate-leaf="true" data-offset-key="11099:0" data-first-offset="true"><span data-slate-string="true"> Service </span></span></span><span data-slate-object="text" data-key="11100"><span data-slate-leaf="true" data-offset-key="11100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="11101"><span data-slate-leaf="true" data-offset-key="11101:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11102"><span data-slate-object="text" data-key="11103"><span data-slate-leaf="true" data-offset-key="11103:0" data-first-offset="true"><span data-slate-string="true">    Users() UserSrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11104"><span data-slate-object="text" data-key="11105"><span data-slate-leaf="true" data-offset-key="11105:0" data-first-offset="true"><span data-slate-string="true">    Secrets() SecretSrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11106"><span data-slate-object="text" data-key="11107"><span data-slate-leaf="true" data-offset-key="11107:0" data-first-offset="true"><span data-slate-string="true">    Policies() PolicySrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11108"><span data-slate-object="text" data-key="11109"><span data-slate-leaf="true" data-offset-key="11109:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11110"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11111"><span data-slate-object="text" data-key="11112"><span data-slate-leaf="true" data-offset-key="11112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11113"><span data-slate-leaf="true" data-offset-key="11113:0" data-first-offset="true"><span data-slate-string="true"> SecretSrv </span></span></span><span data-slate-object="text" data-key="11114"><span data-slate-leaf="true" data-offset-key="11114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="11115"><span data-slate-leaf="true" data-offset-key="11115:0" data-first-offset="true"><span data-slate-string="true"> {                                                             </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11116"><span data-slate-object="text" data-key="11117"><span data-slate-leaf="true" data-offset-key="11117:0" data-first-offset="true"><span data-slate-string="true">    Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) </span></span></span><span data-slate-object="text" data-key="11118"><span data-slate-leaf="true" data-offset-key="11118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11119"><span data-slate-leaf="true" data-offset-key="11119:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11120"><span data-slate-object="text" data-key="11121"><span data-slate-leaf="true" data-offset-key="11121:0" data-first-offset="true"><span data-slate-string="true">    Update(ctx context.Context, secret *v1.Secret, opts metav1.UpdateOptions) </span></span></span><span data-slate-object="text" data-key="11122"><span data-slate-leaf="true" data-offset-key="11122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11123"><span data-slate-leaf="true" data-offset-key="11123:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11124"><span data-slate-object="text" data-key="11125"><span data-slate-leaf="true" data-offset-key="11125:0" data-first-offset="true"><span data-slate-string="true">    Delete(ctx context.Context, username, secretID </span></span></span><span data-slate-object="text" data-key="11126"><span data-slate-leaf="true" data-offset-key="11126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="11127"><span data-slate-leaf="true" data-offset-key="11127:0" data-first-offset="true"><span data-slate-string="true">, opts metav1.DeleteOptions) </span></span></span><span data-slate-object="text" data-key="11128"><span data-slate-leaf="true" data-offset-key="11128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11129"><span data-slate-leaf="true" data-offset-key="11129:0" data-first-offset="true"><span data-slate-string="true">                        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11130"><span data-slate-object="text" data-key="11131"><span data-slate-leaf="true" data-offset-key="11131:0" data-first-offset="true"><span data-slate-string="true">    DeleteCollection(ctx context.Context, username </span></span></span><span data-slate-object="text" data-key="11132"><span data-slate-leaf="true" data-offset-key="11132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="11133"><span data-slate-leaf="true" data-offset-key="11133:0" data-first-offset="true"><span data-slate-string="true">, secretIDs []</span></span></span><span data-slate-object="text" data-key="11134"><span data-slate-leaf="true" data-offset-key="11134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="11135"><span data-slate-leaf="true" data-offset-key="11135:0" data-first-offset="true"><span data-slate-string="true">, opts metav1.DeleteOptions) </span></span></span><span data-slate-object="text" data-key="11136"><span data-slate-leaf="true" data-offset-key="11136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11137"><span data-slate-leaf="true" data-offset-key="11137:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11138"><span data-slate-object="text" data-key="11139"><span data-slate-leaf="true" data-offset-key="11139:0" data-first-offset="true"><span data-slate-string="true">    Get(ctx context.Context, username, secretID </span></span></span><span data-slate-object="text" data-key="11140"><span data-slate-leaf="true" data-offset-key="11140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="11141"><span data-slate-leaf="true" data-offset-key="11141:0" data-first-offset="true"><span data-slate-string="true">, opts metav1.GetOptions) (*v1.Secret, </span></span></span><span data-slate-object="text" data-key="11142"><span data-slate-leaf="true" data-offset-key="11142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11143"><span data-slate-leaf="true" data-offset-key="11143:0" data-first-offset="true"><span data-slate-string="true">)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11144"><span data-slate-object="text" data-key="11145"><span data-slate-leaf="true" data-offset-key="11145:0" data-first-offset="true"><span data-slate-string="true">    List(ctx context.Context, username </span></span></span><span data-slate-object="text" data-key="11146"><span data-slate-leaf="true" data-offset-key="11146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="11147"><span data-slate-leaf="true" data-offset-key="11147:0" data-first-offset="true"><span data-slate-string="true">, opts metav1.ListOptions) (*v1.SecretList, </span></span></span><span data-slate-object="text" data-key="11148"><span data-slate-leaf="true" data-offset-key="11148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11149"><span data-slate-leaf="true" data-offset-key="11149:0" data-first-offset="true"><span data-slate-string="true">)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11150"><span data-slate-object="text" data-key="11151"><span data-slate-leaf="true" data-offset-key="11151:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11152"><span data-slate-object="text" data-key="11153"><span data-slate-leaf="true" data-offset-key="11153:0" data-first-offset="true"><span data-slate-string="true">可以看到，控制层通过业务层提供的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11154"><span data-slate-object="text" data-key="11155"><span data-slate-leaf="true" data-offset-key="11155:0" data-first-offset="true"><span data-slate-string="true"> Service</span></span></span></span><span data-slate-object="text" data-key="11156"><span data-slate-leaf="true" data-offset-key="11156:0" data-first-offset="true"><span data-slate-string="true"> 接口类型，剥离了业务层的具体实现。业务层的 Service 接口类型提供了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11157"><span data-slate-object="text" data-key="11158"><span data-slate-leaf="true" data-offset-key="11158:0" data-first-offset="true"><span data-slate-string="true"> Secrets()</span></span></span></span><span data-slate-object="text" data-key="11159"><span data-slate-leaf="true" data-offset-key="11159:0" data-first-offset="true"><span data-slate-string="true"> 方法，该方法返回了一个实现了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11160"><span data-slate-object="text" data-key="11161"><span data-slate-leaf="true" data-offset-key="11161:0" data-first-offset="true"><span data-slate-string="true"> SecretSrv</span></span></span></span><span data-slate-object="text" data-key="11162"><span data-slate-leaf="true" data-offset-key="11162:0" data-first-offset="true"><span data-slate-string="true"> 接口的实例。在控制层中，通过调用该实例的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11163"><span data-slate-object="text" data-key="11164"><span data-slate-leaf="true" data-offset-key="11164:0" data-first-offset="true"><span data-slate-string="true"> Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error</span></span></span></span><span data-slate-object="text" data-key="11165"><span data-slate-leaf="true" data-offset-key="11165:0" data-first-offset="true"><span data-slate-string="true"> 方法来完成密钥的创建。至于业务层是如何创建密钥的，控制层不需要知道，也就是说创建密钥可以有多种实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11166"><span data-slate-object="text" data-key="11167"><span data-slate-leaf="true" data-offset-key="11167:0" data-first-offset="true"><span data-slate-string="true">这里使用到了设计模式中的</span></span></span><span data-slate-object="text" data-key="11168"><span data-slate-leaf="true" data-offset-key="11168:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">工厂方法模式</span></span></span></span><span data-slate-object="text" data-key="11169"><span data-slate-leaf="true" data-offset-key="11169:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11170"><span data-slate-object="text" data-key="11171"><span data-slate-leaf="true" data-offset-key="11171:0" data-first-offset="true"><span data-slate-string="true">Service</span></span></span></span><span data-slate-object="text" data-key="11172"><span data-slate-leaf="true" data-offset-key="11172:0" data-first-offset="true"><span data-slate-string="true"> 是工厂接口，里面包含了一系列创建具体业务层对象的工厂函数：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11173"><span data-slate-object="text" data-key="11174"><span data-slate-leaf="true" data-offset-key="11174:0" data-first-offset="true"><span data-slate-string="true">Users()</span></span></span></span><span data-slate-object="text" data-key="11175"><span data-slate-leaf="true" data-offset-key="11175:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11176"><span data-slate-object="text" data-key="11177"><span data-slate-leaf="true" data-offset-key="11177:0" data-first-offset="true"><span data-slate-string="true">Secrets()</span></span></span></span><span data-slate-object="text" data-key="11178"><span data-slate-leaf="true" data-offset-key="11178:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11179"><span data-slate-object="text" data-key="11180"><span data-slate-leaf="true" data-offset-key="11180:0" data-first-offset="true"><span data-slate-string="true">Policies()</span></span></span></span><span data-slate-object="text" data-key="11181"><span data-slate-leaf="true" data-offset-key="11181:0" data-first-offset="true"><span data-slate-string="true">。通过工厂方法模式，不仅隐藏了业务层对象的创建细节，而且还可以很方便地在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11182"><span data-slate-object="text" data-key="11183"><span data-slate-leaf="true" data-offset-key="11183:0" data-first-offset="true"><span data-slate-string="true"> Service</span></span></span></span><span data-slate-object="text" data-key="11184"><span data-slate-leaf="true" data-offset-key="11184:0" data-first-offset="true"><span data-slate-string="true"> 工厂接口实现方法中添加新的业务层对象。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11185"><span data-slate-object="text" data-key="11186"><span data-slate-leaf="true" data-offset-key="11186:0" data-first-offset="true"><span data-slate-string="true">例如，我们想新增一个</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11187"><span data-slate-object="text" data-key="11188"><span data-slate-leaf="true" data-offset-key="11188:0" data-first-offset="true"><span data-slate-string="true"> Template</span></span></span></span><span data-slate-object="text" data-key="11189"><span data-slate-leaf="true" data-offset-key="11189:0" data-first-offset="true"><span data-slate-string="true"> 业务层对象，用来在 iam-apiserver 中预置一些策略模板，可以这么来加：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="11190"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11191"><span data-slate-object="text" data-key="11192"><span data-slate-leaf="true" data-offset-key="11192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11193"><span data-slate-leaf="true" data-offset-key="11193:0" data-first-offset="true"><span data-slate-string="true"> Service </span></span></span><span data-slate-object="text" data-key="11194"><span data-slate-leaf="true" data-offset-key="11194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="11195"><span data-slate-leaf="true" data-offset-key="11195:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11196"><span data-slate-object="text" data-key="11197"><span data-slate-leaf="true" data-offset-key="11197:0" data-first-offset="true"><span data-slate-string="true">    Users() UserSrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11198"><span data-slate-object="text" data-key="11199"><span data-slate-leaf="true" data-offset-key="11199:0" data-first-offset="true"><span data-slate-string="true">    Secrets() SecretSrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11200"><span data-slate-object="text" data-key="11201"><span data-slate-leaf="true" data-offset-key="11201:0" data-first-offset="true"><span data-slate-string="true">    Policies() PolicySrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11202"><span data-slate-object="text" data-key="11203"><span data-slate-leaf="true" data-offset-key="11203:0" data-first-offset="true"><span data-slate-string="true">    Templates() TemplateSrv</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11204"><span data-slate-object="text" data-key="11205"><span data-slate-leaf="true" data-offset-key="11205:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11206"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11207"><span data-slate-object="text" data-key="11208"><span data-slate-leaf="true" data-offset-key="11208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="11209"><span data-slate-leaf="true" data-offset-key="11209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11210"><span data-slate-leaf="true" data-offset-key="11210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *service)</span></span></span></span></span><span data-slate-object="text" data-key="11211"><span data-slate-leaf="true" data-offset-key="11211:0" data-first-offset="true"><span data-slate-string="true"> Templates() TemplateSrv {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11212"><span data-slate-object="text" data-key="11213"><span data-slate-leaf="true" data-offset-key="11213:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11214"><span data-slate-leaf="true" data-offset-key="11214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11215"><span data-slate-leaf="true" data-offset-key="11215:0" data-first-offset="true"><span data-slate-string="true"> newTemplates(s)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11216"><span data-slate-object="text" data-key="11217"><span data-slate-leaf="true" data-offset-key="11217:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11218"><span data-slate-object="text" data-key="11219"><span data-slate-leaf="true" data-offset-key="11219:0" data-first-offset="true"><span data-slate-string="true">接下来，新建一个</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11220"><span data-slate-object="text" data-key="11221"><span data-slate-leaf="true" data-offset-key="11221:0" data-first-offset="true"><span data-slate-string="true"> template.go</span></span></span></span><span data-slate-object="text" data-key="11222"><span data-slate-leaf="true" data-offset-key="11222:0" data-first-offset="true"><span data-slate-string="true"> 文件：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="11223"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11224"><span data-slate-object="text" data-key="11225"><span data-slate-leaf="true" data-offset-key="11225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11226"><span data-slate-leaf="true" data-offset-key="11226:0" data-first-offset="true"><span data-slate-string="true"> TemplateSrv </span></span></span><span data-slate-object="text" data-key="11227"><span data-slate-leaf="true" data-offset-key="11227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="11228"><span data-slate-leaf="true" data-offset-key="11228:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11229"><span data-slate-object="text" data-key="11230"><span data-slate-leaf="true" data-offset-key="11230:0" data-first-offset="true"><span data-slate-string="true">    Create(ctx context.Context, template *v1.Template, opts metav1.CreateOptions) </span></span></span><span data-slate-object="text" data-key="11231"><span data-slate-leaf="true" data-offset-key="11231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11232"><span data-slate-object="text" data-key="11233"><span data-slate-leaf="true" data-offset-key="11233:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11234"><span data-slate-leaf="true" data-offset-key="11234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Other methods</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11235"><span data-slate-object="text" data-key="11236"><span data-slate-leaf="true" data-offset-key="11236:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11237"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11238"><span data-slate-object="text" data-key="11239"><span data-slate-leaf="true" data-offset-key="11239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11240"><span data-slate-leaf="true" data-offset-key="11240:0" data-first-offset="true"><span data-slate-string="true"> templateService </span></span></span><span data-slate-object="text" data-key="11241"><span data-slate-leaf="true" data-offset-key="11241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11242"><span data-slate-leaf="true" data-offset-key="11242:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11243"><span data-slate-object="text" data-key="11244"><span data-slate-leaf="true" data-offset-key="11244:0" data-first-offset="true"><span data-slate-string="true">    store store.Factory</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11245"><span data-slate-object="text" data-key="11246"><span data-slate-leaf="true" data-offset-key="11246:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11247"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11248"><span data-slate-object="text" data-key="11249"><span data-slate-leaf="true" data-offset-key="11249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="11250"><span data-slate-leaf="true" data-offset-key="11250:0" data-first-offset="true"><span data-slate-string="true"> _ TemplateSrv = (*templateService)(</span></span></span><span data-slate-object="text" data-key="11251"><span data-slate-leaf="true" data-offset-key="11251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11252"><span data-slate-leaf="true" data-offset-key="11252:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11253"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11254"><span data-slate-object="text" data-key="11255"><span data-slate-leaf="true" data-offset-key="11255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="11256"><span data-slate-leaf="true" data-offset-key="11256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11257"><span data-slate-leaf="true" data-offset-key="11257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newTemplates</span></span></span></span></span><span data-slate-object="text" data-key="11258"><span data-slate-leaf="true" data-offset-key="11258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(srv *service)</span></span></span></span></span><span data-slate-object="text" data-key="11259"><span data-slate-leaf="true" data-offset-key="11259:0" data-first-offset="true"><span data-slate-string="true"> *TemplateService {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11260"><span data-slate-object="text" data-key="11261"><span data-slate-leaf="true" data-offset-key="11261:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11262"><span data-slate-leaf="true" data-offset-key="11262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// more create logic</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11263"><span data-slate-object="text" data-key="11264"><span data-slate-leaf="true" data-offset-key="11264:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11265"><span data-slate-leaf="true" data-offset-key="11265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11266"><span data-slate-leaf="true" data-offset-key="11266:0" data-first-offset="true"><span data-slate-string="true"> &amp;templateService{store: srv.store}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11267"><span data-slate-object="text" data-key="11268"><span data-slate-leaf="true" data-offset-key="11268:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11269"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11270"><span data-slate-object="text" data-key="11271"><span data-slate-leaf="true" data-offset-key="11271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="11272"><span data-slate-leaf="true" data-offset-key="11272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11273"><span data-slate-leaf="true" data-offset-key="11273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(u *templateService)</span></span></span></span></span><span data-slate-object="text" data-key="11274"><span data-slate-leaf="true" data-offset-key="11274:0" data-first-offset="true"><span data-slate-string="true"> Create(ctx context.Context, template *v1.Template, opts metav1.CreateOptions) </span></span></span><span data-slate-object="text" data-key="11275"><span data-slate-leaf="true" data-offset-key="11275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11276"><span data-slate-leaf="true" data-offset-key="11276:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11277"><span data-slate-object="text" data-key="11278"><span data-slate-leaf="true" data-offset-key="11278:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11279"><span data-slate-leaf="true" data-offset-key="11279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// normal code</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11280"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11281"><span data-slate-object="text" data-key="11282"><span data-slate-leaf="true" data-offset-key="11282:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11283"><span data-slate-leaf="true" data-offset-key="11283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11284"><span data-slate-leaf="true" data-offset-key="11284:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11285"><span data-slate-leaf="true" data-offset-key="11285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11286"><span data-slate-object="text" data-key="11287"><span data-slate-leaf="true" data-offset-key="11287:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11288"><span data-slate-object="text" data-key="11289"><span data-slate-leaf="true" data-offset-key="11289:0" data-first-offset="true"><span data-slate-string="true">可以看到，我们通过以下三步新增了一个业务层对象：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11290"><div data-slate-type="list-line" data-slate-object="block" data-key="11291"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="11292"><span data-slate-leaf="true" data-offset-key="11292:0" data-first-offset="true"><span data-slate-string="true">在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11293"><span data-slate-object="text" data-key="11294"><span data-slate-leaf="true" data-offset-key="11294:0" data-first-offset="true"><span data-slate-string="true"> Service</span></span></span></span><span data-slate-object="text" data-key="11295"><span data-slate-leaf="true" data-offset-key="11295:0" data-first-offset="true"><span data-slate-string="true"> 接口定义中，新增了一个入口：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11296"><span data-slate-object="text" data-key="11297"><span data-slate-leaf="true" data-offset-key="11297:0" data-first-offset="true"><span data-slate-string="true">Templates() TemplateSrv</span></span></span></span><span data-slate-object="text" data-key="11298"><span data-slate-leaf="true" data-offset-key="11298:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11299"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="11300"><span data-slate-leaf="true" data-offset-key="11300:0" data-first-offset="true"><span data-slate-string="true">在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11301"><span data-slate-object="text" data-key="11302"><span data-slate-leaf="true" data-offset-key="11302:0" data-first-offset="true"><span data-slate-string="true"> service.go</span></span></span></span><span data-slate-object="text" data-key="11303"><span data-slate-leaf="true" data-offset-key="11303:0" data-first-offset="true"><span data-slate-string="true"> 文件中，新增了一个函数：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11304"><span data-slate-object="text" data-key="11305"><span data-slate-leaf="true" data-offset-key="11305:0" data-first-offset="true"><span data-slate-string="true">Templates()</span></span></span></span><span data-slate-object="text" data-key="11306"><span data-slate-leaf="true" data-offset-key="11306:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11307"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="11308"><span data-slate-leaf="true" data-offset-key="11308:0" data-first-offset="true"><span data-slate-string="true">新建了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11309"><span data-slate-object="text" data-key="11310"><span data-slate-leaf="true" data-offset-key="11310:0" data-first-offset="true"><span data-slate-string="true"> template.go</span></span></span></span><span data-slate-object="text" data-key="11311"><span data-slate-leaf="true" data-offset-key="11311:0" data-first-offset="true"><span data-slate-string="true"> 文件，在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11312"><span data-slate-object="text" data-key="11313"><span data-slate-leaf="true" data-offset-key="11313:0" data-first-offset="true"><span data-slate-string="true"> template.go</span></span></span></span><span data-slate-object="text" data-key="11314"><span data-slate-leaf="true" data-offset-key="11314:0" data-first-offset="true"><span data-slate-string="true"> 中定义了 templateService 结构体，并为它实现了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11315"><span data-slate-object="text" data-key="11316"><span data-slate-leaf="true" data-offset-key="11316:0" data-first-offset="true"><span data-slate-string="true"> TemplateSrv</span></span></span></span><span data-slate-object="text" data-key="11317"><span data-slate-leaf="true" data-offset-key="11317:0" data-first-offset="true"><span data-slate-string="true"> 接口。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11318"><span data-slate-object="text" data-key="11319"><span data-slate-leaf="true" data-offset-key="11319:0" data-first-offset="true"><span data-slate-string="true">可以看到，我们新增的 Template 业务对象的代码几乎都闭环在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11320"><span data-slate-object="text" data-key="11321"><span data-slate-leaf="true" data-offset-key="11321:0" data-first-offset="true"><span data-slate-string="true"> template.go</span></span></span></span><span data-slate-object="text" data-key="11322"><span data-slate-leaf="true" data-offset-key="11322:0" data-first-offset="true"><span data-slate-string="true"> 文件中。对已有的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11323"><span data-slate-object="text" data-key="11324"><span data-slate-leaf="true" data-offset-key="11324:0" data-first-offset="true"><span data-slate-string="true"> Service</span></span></span></span><span data-slate-object="text" data-key="11325"><span data-slate-leaf="true" data-offset-key="11325:0" data-first-offset="true"><span data-slate-string="true"> 工厂接口的创建方法，除了新增一个工厂方法</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11326"><span data-slate-object="text" data-key="11327"><span data-slate-leaf="true" data-offset-key="11327:0" data-first-offset="true"><span data-slate-string="true"> Templates() TemplateSrv</span></span></span></span><span data-slate-object="text" data-key="11328"><span data-slate-leaf="true" data-offset-key="11328:0" data-first-offset="true"><span data-slate-string="true"> 外，没有其他任何入侵。这样做可以避免影响已有业务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11329"><span data-slate-object="text" data-key="11330"><span data-slate-leaf="true" data-offset-key="11330:0" data-first-offset="true"><span data-slate-string="true">在实际项目开发中，你也有可能会想到下面这种错误的创建方式：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="11331"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11332"><span data-slate-object="text" data-key="11333"><span data-slate-leaf="true" data-offset-key="11333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 错误方法一</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11334"><span data-slate-object="text" data-key="11335"><span data-slate-leaf="true" data-offset-key="11335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11336"><span data-slate-leaf="true" data-offset-key="11336:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11337"><span data-slate-leaf="true" data-offset-key="11337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Service</span></span></span></span><span data-slate-object="text" data-key="11338"><span data-slate-leaf="true" data-offset-key="11338:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11339"><span data-slate-leaf="true" data-offset-key="11339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="11340"><span data-slate-leaf="true" data-offset-key="11340:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11341"><span data-slate-object="text" data-key="11342"><span data-slate-leaf="true" data-offset-key="11342:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11343"><span data-slate-leaf="true" data-offset-key="11343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">UserSrv</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11344"><span data-slate-object="text" data-key="11345"><span data-slate-leaf="true" data-offset-key="11345:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11346"><span data-slate-leaf="true" data-offset-key="11346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SecretSrv</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11347"><span data-slate-object="text" data-key="11348"><span data-slate-leaf="true" data-offset-key="11348:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11349"><span data-slate-leaf="true" data-offset-key="11349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">PolicySrv</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11350"><span data-slate-object="text" data-key="11351"><span data-slate-leaf="true" data-offset-key="11351:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11352"><span data-slate-leaf="true" data-offset-key="11352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TemplateSrv</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11353"><span data-slate-object="text" data-key="11354"><span data-slate-leaf="true" data-offset-key="11354:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11355"><span data-slate-object="text" data-key="11356"><span data-slate-leaf="true" data-offset-key="11356:0" data-first-offset="true"><span data-slate-string="true">上面的创建方式中，我们如果想创建 User 和 Secret，那只能定义两个不同的方法：CreateUser 和 CreateSecret，远没有在 User 和 Secret 各自的域中提供同名的 Create 方法来得优雅。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11357"><span data-slate-object="text" data-key="11358"><span data-slate-leaf="true" data-offset-key="11358:0" data-first-offset="true"><span data-slate-string="true">IAM 项目中还有其他地方也使用了工厂方法模式，例如 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11359"><span data-slate-object="text" data-key="11360"><span data-slate-leaf="true" data-offset-key="11360:0" data-first-offset="true"><span data-slate-string="true">Factory</span></span></span></a><span data-slate-object="text" data-key="11361"><span data-slate-leaf="true" data-offset-key="11361:0" data-first-offset="true"><span data-slate-string="true"> 工厂接口。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11362"><span data-slate-object="text" data-key="11363"><span data-slate-leaf="true" data-offset-key="11363:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">再来看下业务层和仓库层是如何通信的。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11364"><span data-slate-object="text" data-key="11365"><span data-slate-leaf="true" data-offset-key="11365:0" data-first-offset="true"><span data-slate-string="true">业务层和仓库层也是通过接口来通信的。例如，在业务层中创建密钥的代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="11366"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11367"><span data-slate-object="text" data-key="11368"><span data-slate-leaf="true" data-offset-key="11368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="11369"><span data-slate-leaf="true" data-offset-key="11369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11370"><span data-slate-leaf="true" data-offset-key="11370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *secretService)</span></span></span></span></span><span data-slate-object="text" data-key="11371"><span data-slate-leaf="true" data-offset-key="11371:0" data-first-offset="true"><span data-slate-string="true"> Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) </span></span></span><span data-slate-object="text" data-key="11372"><span data-slate-leaf="true" data-offset-key="11372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="11373"><span data-slate-leaf="true" data-offset-key="11373:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11374"><span data-slate-object="text" data-key="11375"><span data-slate-leaf="true" data-offset-key="11375:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11376"><span data-slate-leaf="true" data-offset-key="11376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11377"><span data-slate-leaf="true" data-offset-key="11377:0" data-first-offset="true"><span data-slate-string="true"> err := s.store.Secrets().Create(ctx, secret, opts); err != </span></span></span><span data-slate-object="text" data-key="11378"><span data-slate-leaf="true" data-offset-key="11378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="11379"><span data-slate-leaf="true" data-offset-key="11379:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11380"><span data-slate-object="text" data-key="11381"><span data-slate-leaf="true" data-offset-key="11381:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11382"><span data-slate-leaf="true" data-offset-key="11382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11383"><span data-slate-leaf="true" data-offset-key="11383:0" data-first-offset="true"><span data-slate-string="true"> errors.WithCode(code.ErrDatabase, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11384"><span data-slate-object="text" data-key="11385"><span data-slate-leaf="true" data-offset-key="11385:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11386"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11387"><span data-slate-object="text" data-key="11388"><span data-slate-leaf="true" data-offset-key="11388:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11389"><span data-slate-leaf="true" data-offset-key="11389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11390"><span data-slate-leaf="true" data-offset-key="11390:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11391"><span data-slate-leaf="true" data-offset-key="11391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11392"><span data-slate-object="text" data-key="11393"><span data-slate-leaf="true" data-offset-key="11393:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11394"><span data-slate-type="code" data-slate-object="inline" data-key="11395"><span data-slate-object="text" data-key="11396"><span data-slate-leaf="true" data-offset-key="11396:0" data-first-offset="true"><span data-slate-string="true">Create</span></span></span></span><span data-slate-object="text" data-key="11397"><span data-slate-leaf="true" data-offset-key="11397:0" data-first-offset="true"><span data-slate-string="true"> 方法中调用了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11398"><span data-slate-object="text" data-key="11399"><span data-slate-leaf="true" data-offset-key="11399:0" data-first-offset="true"><span data-slate-string="true"> s.store.Secrets().Create()</span></span></span></span><span data-slate-object="text" data-key="11400"><span data-slate-leaf="true" data-offset-key="11400:0" data-first-offset="true"><span data-slate-string="true"> 方法来将密钥保存到数据库中。</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11401"><span data-slate-object="text" data-key="11402"><span data-slate-leaf="true" data-offset-key="11402:0" data-first-offset="true"><span data-slate-string="true">s.store</span></span></span></span><span data-slate-object="text" data-key="11403"><span data-slate-leaf="true" data-offset-key="11403:0" data-first-offset="true"><span data-slate-string="true"> 是一个接口类型，定义如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="11404"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11405"><span data-slate-object="text" data-key="11406"><span data-slate-leaf="true" data-offset-key="11406:0" data-first-offset="true"><span data-slate-string="true">type Factory interface {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11407"><span data-slate-object="text" data-key="11408"><span data-slate-leaf="true" data-offset-key="11408:0" data-first-offset="true"><span data-slate-string="true">    Users() UserStore</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11409"><span data-slate-object="text" data-key="11410"><span data-slate-leaf="true" data-offset-key="11410:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11411"><span data-slate-leaf="true" data-offset-key="11411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Secrets</span></span></span></span><span data-slate-object="text" data-key="11412"><span data-slate-leaf="true" data-offset-key="11412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="11413"><span data-slate-leaf="true" data-offset-key="11413:0" data-first-offset="true"><span data-slate-string="true"> SecretStore</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11414"><span data-slate-object="text" data-key="11415"><span data-slate-leaf="true" data-offset-key="11415:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11416"><span data-slate-leaf="true" data-offset-key="11416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Policies</span></span></span></span><span data-slate-object="text" data-key="11417"><span data-slate-leaf="true" data-offset-key="11417:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="11418"><span data-slate-leaf="true" data-offset-key="11418:0" data-first-offset="true"><span data-slate-string="true"> PolicyStore</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11419"><span data-slate-object="text" data-key="11420"><span data-slate-leaf="true" data-offset-key="11420:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11421"><span data-slate-leaf="true" data-offset-key="11421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Close</span></span></span></span><span data-slate-object="text" data-key="11422"><span data-slate-leaf="true" data-offset-key="11422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="11423"><span data-slate-leaf="true" data-offset-key="11423:0" data-first-offset="true"><span data-slate-string="true"> error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11424"><span data-slate-object="text" data-key="11425"><span data-slate-leaf="true" data-offset-key="11425:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11426"><span data-slate-object="text" data-key="11427"><span data-slate-leaf="true" data-offset-key="11427:0" data-first-offset="true"><span data-slate-string="true">业务层与仓库层的通信实现，和控制层与业务层的通信实现类似，所以这里不再详细介绍。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11428"><span data-slate-object="text" data-key="11429"><span data-slate-leaf="true" data-offset-key="11429:0" data-first-offset="true"><span data-slate-string="true">到这里我们知道了，控制层、业务层和仓库层之间是通过接口来通信的。通过接口通信有一个好处，就是可以让各层变得可测。那接下来，我们就来看下</span></span></span><span data-slate-object="text" data-key="11430"><span data-slate-leaf="true" data-offset-key="11430:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如何测试各层的代码</span></span></span></span><span data-slate-object="text" data-key="11431"><span data-slate-leaf="true" data-offset-key="11431:0" data-first-offset="true"><span data-slate-string="true">。因为</span></span></span><span data-slate-object="text" data-key="11432"><span data-slate-leaf="true" data-offset-key="11432:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 38 讲</span></span></span></span><span data-slate-object="text" data-key="11433"><span data-slate-leaf="true" data-offset-key="11433:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><span data-slate-object="text" data-key="11434"><span data-slate-leaf="true" data-offset-key="11434:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 39 讲</span></span></span></span><span data-slate-object="text" data-key="11435"><span data-slate-leaf="true" data-offset-key="11435:0" data-first-offset="true"><span data-slate-string="true">会详细介绍如何测试 Go 代码，所以这里只介绍下测试思路。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11436"><div data-slate-type="list-line" data-slate-object="block" data-key="11437"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="11438"><span data-slate-leaf="true" data-offset-key="11438:0" data-first-offset="true"><span data-slate-string="true">模型层</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11439"><span data-slate-object="text" data-key="11440"><span data-slate-leaf="true" data-offset-key="11440:0" data-first-offset="true"><span data-slate-string="true">因为模型层不依赖其他任何层，我们只需要测试其中定义的结构及其函数和方法即可。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11441"><div data-slate-type="list-line" data-slate-object="block" data-key="11442"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="11443"><span data-slate-leaf="true" data-offset-key="11443:0" data-first-offset="true"><span data-slate-string="true">控制层</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11444"><span data-slate-object="text" data-key="11445"><span data-slate-leaf="true" data-offset-key="11445:0" data-first-offset="true"><span data-slate-string="true">控制层依赖于业务层，意味着该层需要业务层来支持测试。你可以通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11446"><span data-slate-object="text" data-key="11447"><span data-slate-leaf="true" data-offset-key="11447:0" data-first-offset="true"><span data-slate-string="true">golang/mock</span></span></span></a><span data-slate-object="text" data-key="11448"><span data-slate-leaf="true" data-offset-key="11448:0" data-first-offset="true"><span data-slate-string="true"> 来 mock 业务层，测试用例可参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11449"><span data-slate-object="text" data-key="11450"><span data-slate-leaf="true" data-offset-key="11450:0" data-first-offset="true"><span data-slate-string="true">TestUserController_Create</span></span></span></a><span data-slate-object="text" data-key="11451"><span data-slate-leaf="true" data-offset-key="11451:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11452"><div data-slate-type="list-line" data-slate-object="block" data-key="11453"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="11454"><span data-slate-leaf="true" data-offset-key="11454:0" data-first-offset="true"><span data-slate-string="true">业务层</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11455"><span data-slate-object="text" data-key="11456"><span data-slate-leaf="true" data-offset-key="11456:0" data-first-offset="true"><span data-slate-string="true">因为该层依赖于仓库层，意味着该层需要仓库层来支持测试。我们有两种方法来模拟仓库层：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11457"><div data-slate-type="list-line" data-slate-object="block" data-key="11458"><span data-slate-object="text" data-key="11459"><span data-slate-leaf="true" data-offset-key="11459:0" data-first-offset="true"><span data-slate-string="true">通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11460"><span data-slate-object="text" data-key="11461"><span data-slate-leaf="true" data-offset-key="11461:0" data-first-offset="true"><span data-slate-string="true"> golang/mock</span></span></span></span><span data-slate-object="text" data-key="11462"><span data-slate-leaf="true" data-offset-key="11462:0" data-first-offset="true"><span data-slate-string="true"> 来 mock 仓库层。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="11463"><span data-slate-object="text" data-key="11464"><span data-slate-leaf="true" data-offset-key="11464:0" data-first-offset="true"><span data-slate-string="true">自己开发一个 fake 仓库层。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11465"><span data-slate-object="text" data-key="11466"><span data-slate-leaf="true" data-offset-key="11466:0" data-first-offset="true"><span data-slate-string="true">使用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11467"><span data-slate-object="text" data-key="11468"><span data-slate-leaf="true" data-offset-key="11468:0" data-first-offset="true"><span data-slate-string="true"> golang/mock</span></span></span></span><span data-slate-object="text" data-key="11469"><span data-slate-leaf="true" data-offset-key="11469:0" data-first-offset="true"><span data-slate-string="true"> 的测试用例，你可以参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11470"><span data-slate-object="text" data-key="11471"><span data-slate-leaf="true" data-offset-key="11471:0" data-first-offset="true"><span data-slate-string="true">Test_secretService_Create</span></span></span></a><span data-slate-object="text" data-key="11472"><span data-slate-leaf="true" data-offset-key="11472:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11473"><span data-slate-object="text" data-key="11474"><span data-slate-leaf="true" data-offset-key="11474:0" data-first-offset="true"><span data-slate-string="true">fake 的仓库层可以参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11475"><span data-slate-object="text" data-key="11476"><span data-slate-leaf="true" data-offset-key="11476:0" data-first-offset="true"><span data-slate-string="true">fake</span></span></span></a><span data-slate-object="text" data-key="11477"><span data-slate-leaf="true" data-offset-key="11477:0" data-first-offset="true"><span data-slate-string="true">，使用该 fake 仓库层进行测试的测试用例为</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11478"><span data-slate-object="text" data-key="11479"><span data-slate-leaf="true" data-offset-key="11479:0" data-first-offset="true"><span data-slate-string="true"> Test_userService_List</span></span></span></a><span data-slate-object="text" data-key="11480"><span data-slate-leaf="true" data-offset-key="11480:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11481"><div data-slate-type="list-line" data-slate-object="block" data-key="11482"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="11483"><span data-slate-leaf="true" data-offset-key="11483:0" data-first-offset="true"><span data-slate-string="true">仓库层</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11484"><span data-slate-object="text" data-key="11485"><span data-slate-leaf="true" data-offset-key="11485:0" data-first-offset="true"><span data-slate-string="true">仓库层依赖于数据库，如果调用了其他微服务，那还会依赖第三方服务。我们可以通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11486"><span data-slate-object="text" data-key="11487"><span data-slate-leaf="true" data-offset-key="11487:0" data-first-offset="true"><span data-slate-string="true">sqlmock</span></span></span></a><span data-slate-object="text" data-key="11488"><span data-slate-leaf="true" data-offset-key="11488:0" data-first-offset="true"><span data-slate-string="true"> 来模拟数据库连接，通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11489"><span data-slate-object="text" data-key="11490"><span data-slate-leaf="true" data-offset-key="11490:0" data-first-offset="true"><span data-slate-string="true">httpmock</span></span></span></a><span data-slate-object="text" data-key="11491"><span data-slate-leaf="true" data-offset-key="11491:0" data-first-offset="true"><span data-slate-string="true"> 来模拟 HTTP 请求。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11492" id="sr-toc-9"><span data-slate-object="text" data-key="11493"><span data-slate-leaf="true" data-offset-key="11493:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11494"><span data-slate-object="text" data-key="11495"><span data-slate-leaf="true" data-offset-key="11495:0" data-first-offset="true"><span data-slate-string="true">这一讲，我主要介绍了 iam-apiserver 的功能和使用方法，以及它的代码实现。iam-apiserver 是一个 Web 服务，提供了 REST API 来完成用户、密钥、策略三种 REST 资源的增删改查。我们可以通过 cURL、Insomnia 等工具，来完成 REST API 请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11496"><span data-slate-object="text" data-key="11497"><span data-slate-leaf="true" data-offset-key="11497:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 包含了 3 种配置：Options 配置、应用配置、HTTP/GRPC 服务配置。这三种配置分别用来构建命令行参数、应用和 HTTP/GRPC 服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11498"><span data-slate-object="text" data-key="11499"><span data-slate-leaf="true" data-offset-key="11499:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 在启动时，会先构建应用框架，接着会设置应用选项，然后对应用进行初始化，最后创建 HTTP/GRPC 服务的配置和实例，最终启动 HTTP/GRPC 服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11500"><span data-slate-object="text" data-key="11501"><span data-slate-leaf="true" data-offset-key="11501:0" data-first-offset="true"><span data-slate-string="true">服务启动之后，就可以接收 HTTP 请求了。一个 HTTP 请求会先进行认证，接着会被注册的中间件处理，然后，会根据</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="11502"><span data-slate-object="text" data-key="11503"><span data-slate-leaf="true" data-offset-key="11503:0" data-first-offset="true"><span data-slate-string="true"> (HTTP Method, HTTP Request Path)</span></span></span></span><span data-slate-object="text" data-key="11504"><span data-slate-leaf="true" data-offset-key="11504:0" data-first-offset="true"><span data-slate-string="true"> 匹配到处理函数。在处理函数中，会解析请求参数、校验参数、调用业务逻辑处理函数，最终返回请求结果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11505"><span data-slate-object="text" data-key="11506"><span data-slate-leaf="true" data-offset-key="11506:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 采用了简洁架构，整个应用分为 4 层：模型层、控制层、业务层和仓库层。模型层存储对象的结构和它的方法；仓库层用来跟数据库 / 第三方服务进行 CURD 交互；业务层主要用来完成业务逻辑处理；控制层接收 HTTP 请求，并进行参数解析、参数校验、逻辑分发处理、请求返回操作。控制层、业务层、仓库层之间通过接口通信，通过接口通信可以使相同的功能支持不同的实现，并使每一层的代码变得可测试。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11507" id="sr-toc-10"><span data-slate-object="text" data-key="11508"><span data-slate-leaf="true" data-offset-key="11508:0" data-first-offset="true"><span data-slate-string="true">课后练习</span></span></span></h2><div data-slate-type="list" data-slate-object="block" data-key="11509"><div data-slate-type="list-line" data-slate-object="block" data-key="11510"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="11511"><span data-slate-leaf="true" data-offset-key="11511:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 和 iam-authz-server 都提供了 REST API 服务，阅读它们的源码，看看 iam-apiserver 和 iam-authz-server 是如何共享 REST API 相关代码的。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11512"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="11513"><span data-slate-leaf="true" data-offset-key="11513:0" data-first-offset="true"><span data-slate-string="true">思考一下，iam-apiserver 的服务构建方式，能够再次抽象成一个模板（Go 包）吗？如果能，该如何抽象？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11514"><span data-slate-object="text" data-key="11515"><span data-slate-leaf="true" data-offset-key="11515:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区与我交流讨论，我们下一讲见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-11">精选留言 (28)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yandongxiao</span></div></div><div>总结：
介绍了 internal/pkg/apiserver 内部的组织结构
1. 最外层的 Go 文件主要完成：
   1. 构建应用框架（app.go）
   2. 提供应用框架执行时，需要的 Run 函数（run.go）
   3. 创建 apiServer 服务实例（server.go 和 grpc.go）
   4. 创建路由规则，安装中间件等（auth.go, router.go）
2. config 对应 ** 应用配置 **
3. options 对应命令行参数和配置文件。
4. controller、service、store 三个层次，controller 负责参数解析、校验；service 层负责业务逻辑；store 负责数据库操作。

4 层模型，模型层、控制层、业务层、存储层。层级之间如何解耦？
1. 通过 interface 实现解耦；
2. service 层和 store 层的实例，是在请求执行过程中动态创建，它们都依赖一个工厂对象，作为实例化的输入。
3. 工厂对象 store store.Factory 不与具体的表、具体的操作绑定，通过 store 对象，你可以执行数据库的任何操作。类似的，srv srvv1.Service 工厂也不与具体的业务绑定，通过 srv 对象，你可以执行任何业务逻辑。

服务启动流程分为三个阶段：配置阶段、PreRun 阶段、Run 阶段。配置相关的对象有：Options、Config、HTTP/GRPC 相关的配置对象。</div><div><p>作者回复：强！</p></div><div><div>2021-12-02</div><div><div><i></i></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/14/b9/47377590.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Jasper</span></div></div><div>var _ UserSrv = (*userService)(nil)  我是 go 初学者，这种语法表示没看明白</div><div><p>作者回复：这段代码的意思是：强制确保 userService 实现了 UserSrv 接口。</p></div><div><div>2021-08-23</div><div><div><i></i><span>3</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Sch0ng</span></div></div><div>结合前面章节的铺垫，介绍 iam-apiserver 的使用方法、架构和代码实现，前后连贯，逻辑清晰，简洁易懂。
顺便一提，跟郑晔老师的《软件设计之美》中讲到的：快速了解一个项目时，要了解项目的模型、接口、实现，核心思想如出一辙。软件设计的路上，殊途同归。</div><div><p>作者回复：是的，项目源码结合背后的设计思路，学习效果会翻倍的。学习一次，职业生涯中会一直受益</p></div><div><div>2021-08-15</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/75/00/618b20da.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 徐海浪</span></div></div><div>练习 1：通过 component-base 共享 REST API 相关代码</div><div><p>作者回复：对的</p></div><div><div>2021-08-27</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/5f/f8/1d16434b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 陈麒文</span></div></div><div>似懂非懂，还得多看几遍😭</div><div><div>2021-08-20</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/6b/9a/786b1ed8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 果粒橙</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>学习学习 MVC 模式，第一次接触</div><div><div>2021-12-31</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/37/92/961ba560.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 庖丁解牛</span></div></div><div>iam-apiserver 代码架构中「控制层能够导入业务层和仓库层的包」，是不是应该修改为：控制层能够导入业务层和模型层的包。</div><div><p>作者回复：这里是：控制层能够导入业务层和仓库层的包

上面有提到：模型层的包可以被仓库层、业务层和控制层导入；</p></div><div><div>2021-10-18</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/47/e0/1ff26e99.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>gecko</span></div></div><div>app 包中的 如下类型 
type Command struct {
	usage    string
	desc     string
	options  CliOptions
	commands []*Command
	runFunc  RunCommandFunc
}


如果 commands 字段 有很多层的话  那么如下实现中

func (c *Command) cobraCommand () *cobra.Command {
	cmd := &amp;cobra.Command {
		Use:   c.usage,
		Short: c.desc,
	}
	cmd.SetOutput (os.Stdout)
	cmd.Flags ().SortFlags = false
	if len (c.commands) &gt; 0 { //c 的类型为 *Command，为 c 的 commands 字段赋值  通过 ddCommand 方法装填
		for _, command := range c.commands {
			cmd.AddCommand (command.cobraCommand ()) // 迭代 直到 commands 切片的 长度为 0 
		}
	}
	if c.runFunc != nil {
		cmd.Run = c.runCommand
	}
	if c.options != nil {
		for _, f := range c.options.Flags ().FlagSets {
			cmd.Flags ().AddFlagSet (f)
		}
		//c.options.AddFlags (cmd.Flags ())
	}
	addHelpCommandFlag (c.usage, cmd.Flags ())

	return cmd
}

func (c *Command) AddCommand (cmd *Command) {
	c.commands = append (c.commands, cmd)
}


每层的 *cobra.Command  在调用方那里  cobra.Command.AddCommand 是被绑定到同一个层级的 cobra.Command 吗</div><div><p>作者回复：是的</p></div><div><div>2021-09-30</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/5a/d0/7e58f993.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 梓荣</span></div></div><div>老师你好。如果出现业务逻辑相互调用，这种情况如何处理较妥？是否有一些业务逻辑的上层不是 controller？这部分代码应该放在哪个目录。谢谢。</div><div><p>作者回复：可以试试拆包，将依赖的代码独立一个包，另外 2 个包 import 这个包。
这种情况很可能说明包设计不合理，需要根据实际情况重新设计包。

会有的。这部分代码仍然可以放在 service 目录下
</p></div><div><div>2021-09-18</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/67/3a/0dd9ea02.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Summer  空城</span></div></div><div>老师，您好，在 app/app.go 中 func NewApp (name string, basename string, opts ...Option) *App 内部执行 Option 的方法，其实就是给 App 设置参数。为什么不来个 set 方法直接设置，现在这种设置方法感觉绕了一圈。。。。。</div><div><p>作者回复：这里使用的是选项模式，好处是，新加参数选项时，不用修改 NewApp 代码</p></div><div><div>2021-09-02</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>helloworld</span></div></div><div>“独立于 UI ：在无需改变系统其他部分的情况下，UI 可以轻松地改变。例如，在没有改变业务规则的情况下，Web UI 可以替换为控制台 UI。”, 这里的 Web UI 和控制台 UI 有什么区别啊，这俩不是一回事吗</div><div><p>作者回复: UI 内容不一样，可能表述有点问题</p></div><div><div>2021-08-10</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_b797c1</span></div></div><div>大佬，router.go 里面：
storeIns, _ := mysql.GetMySQLFactoryOr (nil)
userController := user.NewUserController (storeIns)
这个写法感觉好怪呀。感觉没必要，在这边初始化一个 nil 的 store.Factory。是否可以优化一下

但，我也还没想好如何修改😂</div><div><p>作者回复：老哥可以改下，等着你的 PR，哈哈</p></div><div><div>2021-08-03</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2c/82/ec/99b480e8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>hiDaLao</span></div></div><div>老师，请问下 context 作为参数一直传下去的目的是什么呢</div><div><div>2022-08-30</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/34/09/898d084e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>呆呆</span></div></div><div>func initRouter (g *gin.Engine) {
	installMiddleware (g)
	installController (g)
}
如上 apiserver/router.go 的函数参数都为 gin.Engine，是不是不太对？apiserver 应该只与 genericapiserver 有关系，genericapiserver 中集成了 gin.Engine， genericapiserver 中提供路由注册接口会不会更好些。
</div><div><div>2022-08-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/7b/c5/35f92dad.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Jone_乔泓恺</span></div></div><div>请教：在仓库层如果不在想使用 mysql ，而是换成 etcd ，应该如何修改代码呢？</div><div><div>2022-08-10</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1c/63/72/a85661ee.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>船长</span></div></div><div>大佬，在模型层中依赖 gorm，这种设计好吗？个人感觉模型层中是尽量不要依赖第三方跟某种实现强相关的东西，不知道大佬这么设计是出于什么样的考虑。
func (u *User) AfterCreate (tx *gorm.DB) error {
	u.InstanceID = idutil.GetInstanceID (u.ID, "user-")

	return tx.Save (u).Error
}</div><div><p>作者回复：对，这里可以优化。

当时这么设计，是为了便捷吧，不用再另外搞一套 model 定义</p></div><div><div>2022-04-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/f7/76/16c52796.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>逆行 * 乱世</span></div></div><div>➜  iam git:(f9fd52f) go mod vendor
go: github.com/marmotedu/errors@v1.0.2: stream error: stream ID 1; INTERNAL_ERROR 请问一下这个啥情况？</div><div><p>作者回复：可能是网络不稳定吧</p></div><div><div>2022-03-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>左耳朵东</span></div></div><div>业务层和仓库层那里都做了两层抽象，比如仓库层有 Factory 和 SecretStore 两类接口，业务层调用的时候要这样写 s.store.Secrets ().Create ()。我的疑问是 Factory 这层抽象是不是可以省掉，业务层调用直接这样写 store.Secrets (dbIns).Create () 貌似也可以，这样有什么缺点吗？</div><div><p>作者回复：这样写是不行的吧，dbIns 作为参数传入 Secrets 没啥意义。因为仓库层的 db 都是固定的，所以如果这么搞整个仓库调用都要加入固定的 dbIns。

store.Secrets (username).List 这种到是可以，Secrets 传入的 username 类似于 k8s 的 namespace</p></div><div><div>2022-03-08</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/0c/dd/1b12d77d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Dragon Frog</span></div></div><div>老师好，有个问题，想麻烦老师解惑一下。

在前面的课程谈到 “go 的设计哲学是模块划分而不鼓励 mvc 分层结构”，但是实际上我们这个项目的模型仍然是 MVC 划分的，想问问老师为什么最后决定这么设计。

另外我也大概搜索了一些 Go 的 web 项目，发现大家其实受 MVC 风格影响还是很深的，基本都采用这种设计风格去设计自己的代码架构而不是按功能划分。我目前没有找到一些按功能划分的 Go web 项目，想问问老师有没有知道类似的项目并能推荐一二供大家学习</div><div><p>作者回复: iam 就是按功能划分的。

比如：如果你要新加一个功能，你首先想到的是在 pkg 目录创建一个 Go 包。而不是思考下在那一层来创建 Go 包。

其实你说的也多，在代码分层上确实有 MVC 的设计思路，但是在代码在组织上不是的。</p></div><div><div>2022-01-30</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKXjfJWVQGDHmDEI73VQO4dgTzaK5LLz2ax9XUF4FCPy1Oib8aQLibFzpcsiavVVbAQlG4pbrfibdwaYA/132"></div></div><div><div><div><span>Geek_63505f</span></div></div><div>老师你好！ 我看很多接口都是 /v1/users/:name 这样的用 name 去定位话会不会不太好，name 如果相同的话是不是就有问题了？</div><div><p>作者回复: name 是平台的登录账号，是需要唯一的</p></div><div><div>2022-01-12</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".m"><outline class="toc-level-h1" data-reactid=".m.0" style="width: 175px;"><active data-reactid=".m.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".m.0.1"><span data-reactid=".m.0.1.0"> 28 | 控制流（上）：通过 iam-apiserver 设计，看 Web 服务的构建</span></a></outline><outline class="toc-level-h2" data-reactid=".m.1" style="width: 165px;"><active data-reactid=".m.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".m.1.1"><span data-reactid=".m.1.1.0">iam-apiserver 服务介绍</span></a></outline><outline class="toc-level-h3" data-reactid=".m.2" style="width: 155px;"><active data-reactid=".m.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".m.2.1"><span data-reactid=".m.2.1.0">iam-apiserver 功能介绍</span></a></outline><outline class="toc-level-h3" data-reactid=".m.3" style="width: 155px;"><active data-reactid=".m.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".m.3.1"><span data-reactid=".m.3.1.0">iam-apiserver 使用方法介绍</span></a></outline><outline class="toc-level-h2" data-reactid=".m.4" style="width: 165px;"><active data-reactid=".m.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".m.4.1"><span data-reactid=".m.4.1.0">iam-apiserver 代码实现</span></a></outline><outline class="toc-level-h3" data-reactid=".m.5" style="width: 155px;"><active data-reactid=".m.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".m.5.1"><span data-reactid=".m.5.1.0">iam-apiserver 配置处理</span></a></outline><outline class="toc-level-h3" data-reactid=".m.6" style="width: 155px;"><active data-reactid=".m.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".m.6.1"><span data-reactid=".m.6.1.0">iam-apiserver 启动流程设计</span></a></outline><outline class="toc-level-h3" data-reactid=".m.7" style="width: 155px;"><active data-reactid=".m.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".m.7.1"><span data-reactid=".m.7.1.0">iam-apiserver 的 REST API 请求处理流程</span></a></outline><outline class="toc-level-h3" data-reactid=".m.8" style="width: 155px;"><active data-reactid=".m.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".m.8.1"><span data-reactid=".m.8.1.0">iam-apiserver 代码架构</span></a></outline><outline class="toc-level-h2" data-reactid=".m.9" style="width: 165px;"><active data-reactid=".m.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".m.9.1"><span data-reactid=".m.9.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".m.a" style="width: 165px;"><active data-reactid=".m.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".m.a.1"><span data-reactid=".m.a.1.0">课后练习</span></a></outline><outline class="toc-level-h2" data-reactid=".m.b" style="width: 165px;"><active data-reactid=".m.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".m.b.1"><span data-reactid=".m.b.1.0">精选留言 (28)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/401190" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>