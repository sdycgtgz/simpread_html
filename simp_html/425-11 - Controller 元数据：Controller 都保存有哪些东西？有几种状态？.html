
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 11 | Controller 元数据：Controller 都保存有哪些东西？有几种状态？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>11 | Controller 元数据：Controller 都保存有哪些东西？有几种状态？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">11 | Controller 元数据：Controller 都保存有哪些东西？有几种状态？</h1><div><span>胡夕</span> <span> 2020-05-14</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/d1/4a/d1b07327c32e0e96bb393fe2dafab64a.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：17.35M</span><span> 时长：18:57</span></div></div><audio title="11 | Controller元数据：Controller都保存有哪些东西？有几种状态？" src="https://res001.geekbang.org//media/audio/5f/8b/5f0417c8727827798cb3225eba50f98b/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="12524" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="12525"><span data-slate-object="text" data-key="12526"><span data-slate-leaf="true" data-offset-key="12526:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。从今天开始，我们正式进入到第三大模块的学习：控制器（Controller）模块 。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12527"><span data-slate-object="text" data-key="12528"><span data-slate-leaf="true" data-offset-key="12528:0" data-first-offset="true"><span data-slate-string="true">提起 Kafka 中的 Controller 组件，我相信你一定不陌生。从某种意义上说，它是 Kafka 最核心的组件。一方面，它要为集群中的所有主题分区选举领导者副本；另一方面，它还承载着集群的全部元数据信息，并负责将这些元数据信息同步到其他 Broker 上。既然我们是 Kafka 源码解读课，那就绝对不能错过这么重量级的组件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12529"><span data-slate-object="text" data-key="12530"><span data-slate-leaf="true" data-offset-key="12530:0" data-first-offset="true"><span data-slate-string="true">我画了一张图片，希望借助它帮你建立起对这个模块的整体认知。今天，我们先学习下 Controller 元数据。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12531"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/13/5f/13c0d8b3f52c295c70c71a154dae185f.jpg?wh=2447*1412"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12532" id="sr-toc-1"><span data-slate-object="text" data-key="12533"><span data-slate-leaf="true" data-offset-key="12533:0" data-first-offset="true"><span data-slate-string="true">案例分享</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12534"><span data-slate-object="text" data-key="12535"><span data-slate-leaf="true" data-offset-key="12535:0" data-first-offset="true"><span data-slate-string="true">在正式学习源码之前，我想向你分享一个真实的案例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12536"><span data-slate-object="text" data-key="12537"><span data-slate-leaf="true" data-offset-key="12537:0" data-first-offset="true"><span data-slate-string="true">在我们公司的 Kafka 集群环境上，曾经出现了一个比较 “诡异” 的问题：某些核心业务的主题分区一直处于 “不可用” 状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12538"><span data-slate-object="text" data-key="12539"><span data-slate-leaf="true" data-offset-key="12539:0" data-first-offset="true"><span data-slate-string="true">通过使用 “kafka-topics” 命令查询，我们发现，这些分区的 Leader 显示是 -1。之前，这些 Leader 所在的 Broker 机器因为负载高宕机了，当 Broker 重启回来后，Controller 竟然无法成功地为这些分区选举 Leader，因此，它们一直处于 “不可用” 状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12540"><span data-slate-object="text" data-key="12541"><span data-slate-leaf="true" data-offset-key="12541:0" data-first-offset="true"><span data-slate-string="true">由于是生产环境，我们的当务之急是马上恢复受损分区，然后才能调研问题的原因。有人提出，重启这些分区旧 Leader 所在的所有 Broker 机器 —— 这很容易想到，毕竟 “重启大法” 一直很好用。但是，这一次竟然没有任何作用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12542"><span data-slate-object="text" data-key="12543"><span data-slate-leaf="true" data-offset-key="12543:0" data-first-offset="true"><span data-slate-string="true">之后，有人建议升级重启大法，即重启集群的所有 Broker—— 这在当时是不能接受的。且不说有很多业务依然在运行着，单是重启 Kafka 集群本身，就是一件非常缺乏计划性的事情。毕竟，生产环境怎么能随意重启呢？！</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12544"><span data-slate-object="text" data-key="12545"><span data-slate-leaf="true" data-offset-key="12545:0" data-first-offset="true"><span data-slate-string="true">后来，我突然想到了 Controller 组件中重新选举 Controller 的代码。一旦 Controller 被选举出来，它就会向所有 Broker 更新集群元数据，也就是说，会 “重刷” 这些分区的状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12546"><span data-slate-object="text" data-key="12547"><span data-slate-leaf="true" data-offset-key="12547:0" data-first-offset="true"><span data-slate-string="true">那么问题来了，我们如何在避免重启集群的情况下，干掉已有 Controller 并执行新的 Controller 选举呢？答案就在源码中的 </span></span></span><span data-slate-object="text" data-key="12548"><span data-slate-leaf="true" data-offset-key="12548:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ControllerZNode.path</span></span></span></span><span data-slate-object="text" data-key="12549"><span data-slate-leaf="true" data-offset-key="12549:0" data-first-offset="true"><span data-slate-string="true"> 上，也就是 ZooKeeper 的 /controller 节点。倘若我们手动删除了 /controller 节点，Kafka 集群就会触发 Controller 选举。于是，我们马上实施了这个方案，效果出奇得好：之前的受损分区全部恢复正常，业务数据得以正常生产和消费。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12550"><span data-slate-object="text" data-key="12551"><span data-slate-leaf="true" data-offset-key="12551:0" data-first-offset="true"><span data-slate-string="true">当然，给你分享这个案例的目的，并不是让你记住可以随意干掉 /controller 节点 —— 这个操作其实是有一点危险的。事实上，我只是想通过这个真实的例子，向你说明，很多打开 “精通 Kafka 之门” 的钥匙是隐藏在源码中的。那么，接下来，我们就开始找 “钥匙” 吧。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12552" id="sr-toc-2"><span data-slate-object="text" data-key="12553"><span data-slate-leaf="true" data-offset-key="12553:0" data-first-offset="true"><span data-slate-string="true">集群元数据</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12554"><span data-slate-object="text" data-key="12555"><span data-slate-leaf="true" data-offset-key="12555:0" data-first-offset="true"><span data-slate-string="true">想要完整地了解 Controller 的工作原理，我们首先就要学习它管理了哪些数据。毕竟，Controller 的很多代码仅仅是做数据的管理操作而已。今天，我们就来重点学习 Kafka 集群元数据都有哪些。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12556"><span data-slate-object="text" data-key="12557"><span data-slate-leaf="true" data-offset-key="12557:0" data-first-offset="true"><span data-slate-string="true">如果说 ZooKeeper 是整个 Kafka 集群元数据的 “真理之源（Source of Truth）”，那么 Controller 可以说是集群元数据的 “真理之源副本（Backup Source of Truth）”。好吧，后面这个词是我自己发明的。你只需要理解，Controller 承载了 ZooKeeper 上的所有元数据即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12558"><span data-slate-object="text" data-key="12559"><span data-slate-leaf="true" data-offset-key="12559:0" data-first-offset="true"><span data-slate-string="true">事实上，集群 Broker 是不会与 ZooKeeper 直接交互去获取元数据的。相反地，它们总是与 Controller 进行通信，获取和更新最新的集群数据。而且社区已经打算把 ZooKeeper “干掉” 了（我会在之后的 “特别放送” 里具体给你解释社区干掉 ZooKeeper 的操作），以后 Controller 将成为新的 “真理之源”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12560"><span data-slate-object="text" data-key="12561"><span data-slate-leaf="true" data-offset-key="12561:0" data-first-offset="true"><span data-slate-string="true">我们总说元数据，那么，到底什么是集群的元数据，或者说，Kafka 集群的元数据都定义了哪些内容呢？我用一张图给你完整地展示一下，当前 Kafka 定义的所有集群元数据信息。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12562"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/f1/54/f146aceb78a5da31d887618303b5ff54.jpg?wh=2284*2069"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12563"><span data-slate-object="text" data-key="12564"><span data-slate-leaf="true" data-offset-key="12564:0" data-first-offset="true"><span data-slate-string="true">可以看到，目前，Controller 定义的元数据有 17 项之多。不过，并非所有的元数据都同等重要，你也不用完整地记住它们，我们只需要重点关注那些最重要的元数据，并结合源代码来了解下这些元数据都是用来做什么的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12565"><span data-slate-object="text" data-key="12566"><span data-slate-leaf="true" data-offset-key="12566:0" data-first-offset="true"><span data-slate-string="true">在了解具体的元数据之前，我要先介绍下 ControllerContext 类。刚刚我们提到的这些元数据信息全部封装在这个类里。应该这么说，</span></span></span><span data-slate-object="text" data-key="12567"><span data-slate-leaf="true" data-offset-key="12567:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这个类是 Controller 组件的数据容器类</span></span></span></span><span data-slate-object="text" data-key="12568"><span data-slate-leaf="true" data-offset-key="12568:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12569" id="sr-toc-3"><span data-slate-object="text" data-key="12570"><span data-slate-leaf="true" data-offset-key="12570:0" data-first-offset="true"><span data-slate-string="true">ControllerContext</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12571"><span data-slate-object="text" data-key="12572"><span data-slate-leaf="true" data-offset-key="12572:0" data-first-offset="true"><span data-slate-string="true">Controller 组件的源代码位于 core 包的 src/main/scala/kafka/controller 路径下，这里面有很多 Scala 源文件，</span></span></span><span data-slate-object="text" data-key="12573"><span data-slate-leaf="true" data-offset-key="12573:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ControllerContext 类就位于这个路径下的 ControllerContext.scala 文件中。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12574"><span data-slate-object="text" data-key="12575"><span data-slate-leaf="true" data-offset-key="12575:0" data-first-offset="true"><span data-slate-string="true">该文件只有几百行代码，其中，最重要的数据结构就是 ControllerContext 类。前面说过，</span></span></span><span data-slate-object="text" data-key="12576"><span data-slate-leaf="true" data-offset-key="12576:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">它定义了前面提到的所有元数据信息，以及许多实用的工具方法</span></span></span></span><span data-slate-object="text" data-key="12577"><span data-slate-leaf="true" data-offset-key="12577:0" data-first-offset="true"><span data-slate-string="true">。比如，获取集群上所有主题分区对象的 allPartitions 方法、获取某主题分区副本列表的 partitionReplicaAssignment 方法，等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12578"><span data-slate-object="text" data-key="12579"><span data-slate-leaf="true" data-offset-key="12579:0" data-first-offset="true"><span data-slate-string="true">首先，我们来看下 ControllerContext 类的定义，如下所示：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="12580"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12581"><span data-slate-object="text" data-key="12582"><span data-slate-leaf="true" data-offset-key="12582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="12583"><span data-slate-leaf="true" data-offset-key="12583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12584"><span data-slate-leaf="true" data-offset-key="12584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerContext</span></span></span></span></span><span data-slate-object="text" data-key="12585"><span data-slate-leaf="true" data-offset-key="12585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12586"><span data-slate-leaf="true" data-offset-key="12586:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12587"><span data-slate-object="text" data-key="12588"><span data-slate-leaf="true" data-offset-key="12588:0" data-first-offset="true"><span data-slate-string="true">  val stats = </span></span></span><span data-slate-object="text" data-key="12589"><span data-slate-leaf="true" data-offset-key="12589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="12590"><span data-slate-leaf="true" data-offset-key="12590:0" data-first-offset="true"><span data-slate-string="true"> ControllerStats </span></span></span><span data-slate-object="text" data-key="12591"><span data-slate-leaf="true" data-offset-key="12591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 统计信息类 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12592"><span data-slate-object="text" data-key="12593"><span data-slate-leaf="true" data-offset-key="12593:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12594"><span data-slate-leaf="true" data-offset-key="12594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="12595"><span data-slate-leaf="true" data-offset-key="12595:0" data-first-offset="true"><span data-slate-string="true"> offlinePartitionCount = </span></span></span><span data-slate-object="text" data-key="12596"><span data-slate-leaf="true" data-offset-key="12596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12597"><span data-slate-leaf="true" data-offset-key="12597:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="12598"><span data-slate-leaf="true" data-offset-key="12598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 离线分区计数器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12599"><span data-slate-object="text" data-key="12600"><span data-slate-leaf="true" data-offset-key="12600:0" data-first-offset="true"><span data-slate-string="true">  val shuttingDownBrokerIds = mutable.</span></span></span><span data-slate-object="text" data-key="12601"><span data-slate-leaf="true" data-offset-key="12601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12602"><span data-slate-leaf="true" data-offset-key="12602:0" data-first-offset="true"><span data-slate-string="true">.empty[Int]  </span></span></span><span data-slate-object="text" data-key="12603"><span data-slate-leaf="true" data-offset-key="12603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭中 Broker 的 Id 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12604"><span data-slate-object="text" data-key="12605"><span data-slate-leaf="true" data-offset-key="12605:0" data-first-offset="true"><span data-slate-string="true">  private val liveBrokers = mutable.</span></span></span><span data-slate-object="text" data-key="12606"><span data-slate-leaf="true" data-offset-key="12606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12607"><span data-slate-leaf="true" data-offset-key="12607:0" data-first-offset="true"><span data-slate-string="true">.empty[Broker] </span></span></span><span data-slate-object="text" data-key="12608"><span data-slate-leaf="true" data-offset-key="12608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前运行中 Broker 对象列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12609"><span data-slate-object="text" data-key="12610"><span data-slate-leaf="true" data-offset-key="12610:0" data-first-offset="true"><span data-slate-string="true">  private val liveBrokerEpochs = mutable.</span></span></span><span data-slate-object="text" data-key="12611"><span data-slate-leaf="true" data-offset-key="12611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12612"><span data-slate-leaf="true" data-offset-key="12612:0" data-first-offset="true"><span data-slate-string="true">.empty[Int, Long]   </span></span></span><span data-slate-object="text" data-key="12613"><span data-slate-leaf="true" data-offset-key="12613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行中 Broker Epoch 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12614"><span data-slate-object="text" data-key="12615"><span data-slate-leaf="true" data-offset-key="12615:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12616"><span data-slate-leaf="true" data-offset-key="12616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="12617"><span data-slate-leaf="true" data-offset-key="12617:0" data-first-offset="true"><span data-slate-string="true"> epoch: Int = KafkaController.InitialControllerEpoch   </span></span></span><span data-slate-object="text" data-key="12618"><span data-slate-leaf="true" data-offset-key="12618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 当前 Epoch 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12619"><span data-slate-object="text" data-key="12620"><span data-slate-leaf="true" data-offset-key="12620:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12621"><span data-slate-leaf="true" data-offset-key="12621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="12622"><span data-slate-leaf="true" data-offset-key="12622:0" data-first-offset="true"><span data-slate-string="true"> epochZkVersion: Int = KafkaController.InitialControllerEpochZkVersion  </span></span></span><span data-slate-object="text" data-key="12623"><span data-slate-leaf="true" data-offset-key="12623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 对应 ZooKeeper 节点的 Epoch 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12624"><span data-slate-object="text" data-key="12625"><span data-slate-leaf="true" data-offset-key="12625:0" data-first-offset="true"><span data-slate-string="true">  val allTopics = mutable.</span></span></span><span data-slate-object="text" data-key="12626"><span data-slate-leaf="true" data-offset-key="12626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12627"><span data-slate-leaf="true" data-offset-key="12627:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="12628"><span data-slate-leaf="true" data-offset-key="12628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="12629"><span data-slate-leaf="true" data-offset-key="12629:0" data-first-offset="true"><span data-slate-string="true">]  </span></span></span><span data-slate-object="text" data-key="12630"><span data-slate-leaf="true" data-offset-key="12630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 集群主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12631"><span data-slate-object="text" data-key="12632"><span data-slate-leaf="true" data-offset-key="12632:0" data-first-offset="true"><span data-slate-string="true">  val partitionAssignments = mutable.</span></span></span><span data-slate-object="text" data-key="12633"><span data-slate-leaf="true" data-offset-key="12633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12634"><span data-slate-leaf="true" data-offset-key="12634:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="12635"><span data-slate-leaf="true" data-offset-key="12635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="12636"><span data-slate-leaf="true" data-offset-key="12636:0" data-first-offset="true"><span data-slate-string="true">, mutable.</span></span></span><span data-slate-object="text" data-key="12637"><span data-slate-leaf="true" data-offset-key="12637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12638"><span data-slate-leaf="true" data-offset-key="12638:0" data-first-offset="true"><span data-slate-string="true">[Int, ReplicaAssignment]]  </span></span></span><span data-slate-object="text" data-key="12639"><span data-slate-leaf="true" data-offset-key="12639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题分区的副本列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12640"><span data-slate-object="text" data-key="12641"><span data-slate-leaf="true" data-offset-key="12641:0" data-first-offset="true"><span data-slate-string="true">  val partitionLeadershipInfo = mutable.</span></span></span><span data-slate-object="text" data-key="12642"><span data-slate-leaf="true" data-offset-key="12642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12643"><span data-slate-leaf="true" data-offset-key="12643:0" data-first-offset="true"><span data-slate-string="true">.empty[TopicPartition, LeaderIsrAndControllerEpoch]  </span></span></span><span data-slate-object="text" data-key="12644"><span data-slate-leaf="true" data-offset-key="12644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题分区的 Leader/ISR 副本信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12645"><span data-slate-object="text" data-key="12646"><span data-slate-leaf="true" data-offset-key="12646:0" data-first-offset="true"><span data-slate-string="true">  val partitionsBeingReassigned = mutable.</span></span></span><span data-slate-object="text" data-key="12647"><span data-slate-leaf="true" data-offset-key="12647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12648"><span data-slate-leaf="true" data-offset-key="12648:0" data-first-offset="true"><span data-slate-string="true">.empty[TopicPartition]  </span></span></span><span data-slate-object="text" data-key="12649"><span data-slate-leaf="true" data-offset-key="12649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 正处于副本重分配过程的主题分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12650"><span data-slate-object="text" data-key="12651"><span data-slate-leaf="true" data-offset-key="12651:0" data-first-offset="true"><span data-slate-string="true">  val partitionStates = mutable.</span></span></span><span data-slate-object="text" data-key="12652"><span data-slate-leaf="true" data-offset-key="12652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12653"><span data-slate-leaf="true" data-offset-key="12653:0" data-first-offset="true"><span data-slate-string="true">.empty[TopicPartition, PartitionState] </span></span></span><span data-slate-object="text" data-key="12654"><span data-slate-leaf="true" data-offset-key="12654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题分区状态列表 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12655"><span data-slate-object="text" data-key="12656"><span data-slate-leaf="true" data-offset-key="12656:0" data-first-offset="true"><span data-slate-string="true">  val replicaStates = mutable.</span></span></span><span data-slate-object="text" data-key="12657"><span data-slate-leaf="true" data-offset-key="12657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12658"><span data-slate-leaf="true" data-offset-key="12658:0" data-first-offset="true"><span data-slate-string="true">.empty[PartitionAndReplica, ReplicaState]  </span></span></span><span data-slate-object="text" data-key="12659"><span data-slate-leaf="true" data-offset-key="12659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题分区的副本状态列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12660"><span data-slate-object="text" data-key="12661"><span data-slate-leaf="true" data-offset-key="12661:0" data-first-offset="true"><span data-slate-string="true">  val replicasOnOfflineDirs = mutable.</span></span></span><span data-slate-object="text" data-key="12662"><span data-slate-leaf="true" data-offset-key="12662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12663"><span data-slate-leaf="true" data-offset-key="12663:0" data-first-offset="true"><span data-slate-string="true">.empty[Int, </span></span></span><span data-slate-object="text" data-key="12664"><span data-slate-leaf="true" data-offset-key="12664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12665"><span data-slate-leaf="true" data-offset-key="12665:0" data-first-offset="true"><span data-slate-string="true">[TopicPartition]]  </span></span></span><span data-slate-object="text" data-key="12666"><span data-slate-leaf="true" data-offset-key="12666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不可用磁盘路径上的副本列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12667"><span data-slate-object="text" data-key="12668"><span data-slate-leaf="true" data-offset-key="12668:0" data-first-offset="true"><span data-slate-string="true">  val topicsToBeDeleted = mutable.</span></span></span><span data-slate-object="text" data-key="12669"><span data-slate-leaf="true" data-offset-key="12669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12670"><span data-slate-leaf="true" data-offset-key="12670:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="12671"><span data-slate-leaf="true" data-offset-key="12671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="12672"><span data-slate-leaf="true" data-offset-key="12672:0" data-first-offset="true"><span data-slate-string="true">]  </span></span></span><span data-slate-object="text" data-key="12673"><span data-slate-leaf="true" data-offset-key="12673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 待删除主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12674"><span data-slate-object="text" data-key="12675"><span data-slate-leaf="true" data-offset-key="12675:0" data-first-offset="true"><span data-slate-string="true">  val topicsWithDeletionStarted = mutable.</span></span></span><span data-slate-object="text" data-key="12676"><span data-slate-leaf="true" data-offset-key="12676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12677"><span data-slate-leaf="true" data-offset-key="12677:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="12678"><span data-slate-leaf="true" data-offset-key="12678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="12679"><span data-slate-leaf="true" data-offset-key="12679:0" data-first-offset="true"><span data-slate-string="true">]  </span></span></span><span data-slate-object="text" data-key="12680"><span data-slate-leaf="true" data-offset-key="12680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 已开启删除的主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12681"><span data-slate-object="text" data-key="12682"><span data-slate-leaf="true" data-offset-key="12682:0" data-first-offset="true"><span data-slate-string="true">  val topicsIneligibleForDeletion = mutable.</span></span></span><span data-slate-object="text" data-key="12683"><span data-slate-leaf="true" data-offset-key="12683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12684"><span data-slate-leaf="true" data-offset-key="12684:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="12685"><span data-slate-leaf="true" data-offset-key="12685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="12686"><span data-slate-leaf="true" data-offset-key="12686:0" data-first-offset="true"><span data-slate-string="true">]  </span></span></span><span data-slate-object="text" data-key="12687"><span data-slate-leaf="true" data-offset-key="12687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 暂时无法执行删除的主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12688"><span data-slate-object="text" data-key="12689"><span data-slate-leaf="true" data-offset-key="12689:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12690"><span data-slate-object="text" data-key="12691"><span data-slate-leaf="true" data-offset-key="12691:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12692"><span data-slate-object="text" data-key="12693"><span data-slate-leaf="true" data-offset-key="12693:0" data-first-offset="true"><span data-slate-string="true">不多不少，这段代码中定义的字段正好 17 个，它们一一对应着上图中的那些元数据信息。下面，我选取一些重要的元数据，来详细解释下它们的含义。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12694"><span data-slate-object="text" data-key="12695"><span data-slate-leaf="true" data-offset-key="12695:0" data-first-offset="true"><span data-slate-string="true">这些元数据理解起来还是比较简单的，掌握了它们之后，你在理解 MetadataCache，也就是元数据缓存的时候，就容易得多了。比如，接下来我要讲到的 liveBrokers 信息，就是 Controller 通过 UpdateMetadataRequest 请求同步给其他 Broker 的 MetadataCache 的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12696" id="sr-toc-4"><span data-slate-object="text" data-key="12697"><span data-slate-leaf="true" data-offset-key="12697:0" data-first-offset="true"><span data-slate-string="true">ControllerStats</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12698"><span data-slate-object="text" data-key="12699"><span data-slate-leaf="true" data-offset-key="12699:0" data-first-offset="true"><span data-slate-string="true">第一个是 ControllerStats 类的变量。它的完整代码如下：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="12700"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12701"><span data-slate-object="text" data-key="12702"><span data-slate-leaf="true" data-offset-key="12702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="12703"><span data-slate-leaf="true" data-offset-key="12703:0" data-first-offset="true"><span data-slate-string="true">[controller] </span></span></span><span data-slate-object="text" data-key="12704"><span data-slate-leaf="true" data-offset-key="12704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="12705"><span data-slate-leaf="true" data-offset-key="12705:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12706"><span data-slate-leaf="true" data-offset-key="12706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerStats</span></span></span></span><span data-slate-object="text" data-key="12707"><span data-slate-leaf="true" data-offset-key="12707:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12708"><span data-slate-leaf="true" data-offset-key="12708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="12709"><span data-slate-leaf="true" data-offset-key="12709:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12710"><span data-slate-leaf="true" data-offset-key="12710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaMetricsGroup</span></span></span></span><span data-slate-object="text" data-key="12711"><span data-slate-leaf="true" data-offset-key="12711:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12712"><span data-slate-object="text" data-key="12713"><span data-slate-leaf="true" data-offset-key="12713:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12714"><span data-slate-leaf="true" data-offset-key="12714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 统计每秒发生的 Unclean Leader 选举次数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12715"><span data-slate-object="text" data-key="12716"><span data-slate-leaf="true" data-offset-key="12716:0" data-first-offset="true"><span data-slate-string="true">  val uncleanLeaderElectionRate = </span></span></span><span data-slate-object="text" data-key="12717"><span data-slate-leaf="true" data-offset-key="12717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newMeter</span></span></span></span><span data-slate-object="text" data-key="12718"><span data-slate-leaf="true" data-offset-key="12718:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12719"><span data-slate-leaf="true" data-offset-key="12719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"UncleanLeaderElectionsPerSec"</span></span></span></span><span data-slate-object="text" data-key="12720"><span data-slate-leaf="true" data-offset-key="12720:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12721"><span data-slate-leaf="true" data-offset-key="12721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"elections"</span></span></span></span><span data-slate-object="text" data-key="12722"><span data-slate-leaf="true" data-offset-key="12722:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12723"><span data-slate-leaf="true" data-offset-key="12723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimeUnit</span></span></span></span><span data-slate-object="text" data-key="12724"><span data-slate-leaf="true" data-offset-key="12724:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12725"><span data-slate-leaf="true" data-offset-key="12725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SECONDS</span></span></span></span><span data-slate-object="text" data-key="12726"><span data-slate-leaf="true" data-offset-key="12726:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12727"><span data-slate-object="text" data-key="12728"><span data-slate-leaf="true" data-offset-key="12728:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12729"><span data-slate-leaf="true" data-offset-key="12729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 事件通用的统计速率指标的方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12730"><span data-slate-object="text" data-key="12731"><span data-slate-leaf="true" data-offset-key="12731:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="12732"><span data-slate-leaf="true" data-offset-key="12732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rateAndTimeMetrics</span></span></span></span><span data-slate-object="text" data-key="12733"><span data-slate-leaf="true" data-offset-key="12733:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="12734"><span data-slate-leaf="true" data-offset-key="12734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="12735"><span data-slate-leaf="true" data-offset-key="12735:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="12736"><span data-slate-leaf="true" data-offset-key="12736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerState</span></span></span></span><span data-slate-object="text" data-key="12737"><span data-slate-leaf="true" data-offset-key="12737:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12738"><span data-slate-leaf="true" data-offset-key="12738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaTimer</span></span></span></span><span data-slate-object="text" data-key="12739"><span data-slate-leaf="true" data-offset-key="12739:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="12740"><span data-slate-leaf="true" data-offset-key="12740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerState</span></span></span></span><span data-slate-object="text" data-key="12741"><span data-slate-leaf="true" data-offset-key="12741:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12742"><span data-slate-leaf="true" data-offset-key="12742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">values</span></span></span></span><span data-slate-object="text" data-key="12743"><span data-slate-leaf="true" data-offset-key="12743:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12744"><span data-slate-leaf="true" data-offset-key="12744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flatMap</span></span></span></span><span data-slate-object="text" data-key="12745"><span data-slate-leaf="true" data-offset-key="12745:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="12746"><span data-slate-leaf="true" data-offset-key="12746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">state</span></span></span></span></span><span data-slate-object="text" data-key="12747"><span data-slate-leaf="true" data-offset-key="12747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12748"><span data-slate-object="text" data-key="12749"><span data-slate-leaf="true" data-offset-key="12749:0" data-first-offset="true"><span data-slate-string="true">    state.</span></span></span><span data-slate-object="text" data-key="12750"><span data-slate-leaf="true" data-offset-key="12750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rateAndTimeMetricName</span></span></span></span><span data-slate-object="text" data-key="12751"><span data-slate-leaf="true" data-offset-key="12751:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12752"><span data-slate-leaf="true" data-offset-key="12752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="12753"><span data-slate-leaf="true" data-offset-key="12753:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="12754"><span data-slate-leaf="true" data-offset-key="12754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">metricName</span></span></span></span></span><span data-slate-object="text" data-key="12755"><span data-slate-leaf="true" data-offset-key="12755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12756"><span data-slate-object="text" data-key="12757"><span data-slate-leaf="true" data-offset-key="12757:0" data-first-offset="true"><span data-slate-string="true">      state -&gt; </span></span></span><span data-slate-object="text" data-key="12758"><span data-slate-leaf="true" data-offset-key="12758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="12759"><span data-slate-leaf="true" data-offset-key="12759:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12760"><span data-slate-leaf="true" data-offset-key="12760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaTimer</span></span></span></span><span data-slate-object="text" data-key="12761"><span data-slate-leaf="true" data-offset-key="12761:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12762"><span data-slate-leaf="true" data-offset-key="12762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newTimer</span></span></span></span><span data-slate-object="text" data-key="12763"><span data-slate-leaf="true" data-offset-key="12763:0" data-first-offset="true"><span data-slate-string="true">(metricName, </span></span></span><span data-slate-object="text" data-key="12764"><span data-slate-leaf="true" data-offset-key="12764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimeUnit</span></span></span></span><span data-slate-object="text" data-key="12765"><span data-slate-leaf="true" data-offset-key="12765:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12766"><span data-slate-leaf="true" data-offset-key="12766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">MILLISECONDS</span></span></span></span><span data-slate-object="text" data-key="12767"><span data-slate-leaf="true" data-offset-key="12767:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12768"><span data-slate-leaf="true" data-offset-key="12768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimeUnit</span></span></span></span><span data-slate-object="text" data-key="12769"><span data-slate-leaf="true" data-offset-key="12769:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="12770"><span data-slate-leaf="true" data-offset-key="12770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SECONDS</span></span></span></span><span data-slate-object="text" data-key="12771"><span data-slate-leaf="true" data-offset-key="12771:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12772"><span data-slate-object="text" data-key="12773"><span data-slate-leaf="true" data-offset-key="12773:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12774"><span data-slate-object="text" data-key="12775"><span data-slate-leaf="true" data-offset-key="12775:0" data-first-offset="true"><span data-slate-string="true">  }.</span></span></span><span data-slate-object="text" data-key="12776"><span data-slate-leaf="true" data-offset-key="12776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">toMap</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12777"><span data-slate-object="text" data-key="12778"><span data-slate-leaf="true" data-offset-key="12778:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12779"><span data-slate-object="text" data-key="12780"><span data-slate-leaf="true" data-offset-key="12780:0" data-first-offset="true"><span data-slate-string="true">顾名思义，它表征的是 Controller 的一些统计信息。目前，源码中定义了两大类统计指标：</span></span></span><span data-slate-object="text" data-key="12781"><span data-slate-leaf="true" data-offset-key="12781:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">UncleanLeaderElectionsPerSec 和所有 Controller 事件状态的执行速率与时间</span></span></span></span><span data-slate-object="text" data-key="12782"><span data-slate-leaf="true" data-offset-key="12782:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12783"><span data-slate-object="text" data-key="12784"><span data-slate-leaf="true" data-offset-key="12784:0" data-first-offset="true"><span data-slate-string="true">其中，</span></span></span><span data-slate-object="text" data-key="12785"><span data-slate-leaf="true" data-offset-key="12785:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">前者是计算 Controller 每秒执行的 Unclean Leader 选举数量，通常情况下，执行 Unclean Leader 选举可能造成数据丢失，一般不建议开启它</span></span></span></span><span data-slate-object="text" data-key="12786"><span data-slate-leaf="true" data-offset-key="12786:0" data-first-offset="true"><span data-slate-string="true">。一旦开启，你就需要时刻关注这个监控指标的值，确保 Unclean Leader 选举的速率维持在一个很低的水平，否则会出现很多数据丢失的情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12787"><span data-slate-object="text" data-key="12788"><span data-slate-leaf="true" data-offset-key="12788:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">后者是统计所有 Controller 状态的速率和时间信息</span></span></span></span><span data-slate-object="text" data-key="12789"><span data-slate-leaf="true" data-offset-key="12789:0" data-first-offset="true"><span data-slate-string="true">，单位是毫秒。当前，Controller 定义了很多事件，比如，TopicDeletion 是执行主题删除的 Controller 事件、ControllerChange 是执行 Controller 重选举的事件。ControllerStats 的这个指标通过在每个事件名后拼接字符串 RateAndTimeMs 的方式，为每类 Controller 事件都创建了对应的速率监控指标。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12790"><span data-slate-object="text" data-key="12791"><span data-slate-leaf="true" data-offset-key="12791:0" data-first-offset="true"><span data-slate-string="true">由于 Controller 事件有很多种，对应的速率监控指标也有很多，有一些 Controller 事件是需要你额外关注的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12792"><span data-slate-object="text" data-key="12793"><span data-slate-leaf="true" data-offset-key="12793:0" data-first-offset="true"><span data-slate-string="true">举个例子，IsrChangeNotification 事件是标志 ISR 列表变更的事件，如果这个事件经常出现，说明副本的 ISR 列表经常发生变化，而这通常被认为是非正常情况，因此，你最好关注下这个事件的速率监控指标。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12794" id="sr-toc-5"><span data-slate-object="text" data-key="12795"><span data-slate-leaf="true" data-offset-key="12795:0" data-first-offset="true"><span data-slate-string="true">offlinePartitionCount</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12796"><span data-slate-object="text" data-key="12797"><span data-slate-leaf="true" data-offset-key="12797:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该字段统计集群中所有离线或处于不可用状态的主题分区数量</span></span></span></span><span data-slate-object="text" data-key="12798"><span data-slate-leaf="true" data-offset-key="12798:0" data-first-offset="true"><span data-slate-string="true">。所谓的不可用状态，就是我最开始举的例子中 “Leader=-1” 的情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12799"><span data-slate-object="text" data-key="12800"><span data-slate-leaf="true" data-offset-key="12800:0" data-first-offset="true"><span data-slate-string="true">ControllerContext 中的 updatePartitionStateMetrics 方法根据</span></span></span><span data-slate-object="text" data-key="12801"><span data-slate-leaf="true" data-offset-key="12801:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">给定主题分区的当前状态和目标状态</span></span></span></span><span data-slate-object="text" data-key="12802"><span data-slate-leaf="true" data-offset-key="12802:0" data-first-offset="true"><span data-slate-string="true">，来判断该分区是否是离线状态的分区。如果是，则累加 offlinePartitionCount 字段的值，否则递减该值。方法代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12803"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12804"><span data-slate-object="text" data-key="12805"><span data-slate-leaf="true" data-offset-key="12805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 offlinePartitionCount 元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12806"><span data-slate-object="text" data-key="12807"><span data-slate-leaf="true" data-offset-key="12807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="12808"><span data-slate-leaf="true" data-offset-key="12808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="12809"><span data-slate-leaf="true" data-offset-key="12809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">updatePartitionStateMetrics</span></span></span></span></span><span data-slate-object="text" data-key="12810"><span data-slate-leaf="true" data-offset-key="12810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12811"><span data-slate-object="text" data-key="12812"><span data-slate-leaf="true" data-offset-key="12812:0" data-first-offset="true"><span data-slate-string="true">  partition: TopicPartition, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12813"><span data-slate-object="text" data-key="12814"><span data-slate-leaf="true" data-offset-key="12814:0" data-first-offset="true"><span data-slate-string="true">  currentState: PartitionState,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12815"><span data-slate-object="text" data-key="12816"><span data-slate-leaf="true" data-offset-key="12816:0" data-first-offset="true"><span data-slate-string="true">  targetState: PartitionState): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12817"><span data-slate-object="text" data-key="12818"><span data-slate-leaf="true" data-offset-key="12818:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12819"><span data-slate-leaf="true" data-offset-key="12819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该主题当前并未处于删除中状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12820"><span data-slate-object="text" data-key="12821"><span data-slate-leaf="true" data-offset-key="12821:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12822"><span data-slate-leaf="true" data-offset-key="12822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12823"><span data-slate-leaf="true" data-offset-key="12823:0" data-first-offset="true"><span data-slate-string="true"> (!</span></span></span><span data-slate-object="text" data-key="12824"><span data-slate-leaf="true" data-offset-key="12824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">isTopicDeletionInProgress</span></span></span></span><span data-slate-object="text" data-key="12825"><span data-slate-leaf="true" data-offset-key="12825:0" data-first-offset="true"><span data-slate-string="true">(partition.topic)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12826"><span data-slate-object="text" data-key="12827"><span data-slate-leaf="true" data-offset-key="12827:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12828"><span data-slate-leaf="true" data-offset-key="12828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//targetState 表示该分区要变更到的状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12829"><span data-slate-object="text" data-key="12830"><span data-slate-leaf="true" data-offset-key="12830:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12831"><span data-slate-leaf="true" data-offset-key="12831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前状态不是 OfflinePartition，即离线状态并且目标状态是离线状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12832"><span data-slate-object="text" data-key="12833"><span data-slate-leaf="true" data-offset-key="12833:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12834"><span data-slate-leaf="true" data-offset-key="12834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个 if 语句判断是否要将该主题分区状态转换到离线状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12835"><span data-slate-object="text" data-key="12836"><span data-slate-leaf="true" data-offset-key="12836:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12837"><span data-slate-leaf="true" data-offset-key="12837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12838"><span data-slate-leaf="true" data-offset-key="12838:0" data-first-offset="true"><span data-slate-string="true"> (currentState != OfflinePartition &amp;&amp; targetState == OfflinePartition) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12839"><span data-slate-object="text" data-key="12840"><span data-slate-leaf="true" data-offset-key="12840:0" data-first-offset="true"><span data-slate-string="true">      offlinePartitionCount = offlinePartitionCount + </span></span></span><span data-slate-object="text" data-key="12841"><span data-slate-leaf="true" data-offset-key="12841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12842"><span data-slate-object="text" data-key="12843"><span data-slate-leaf="true" data-offset-key="12843:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12844"><span data-slate-leaf="true" data-offset-key="12844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前状态已经是离线状态，但 targetState 不是</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12845"><span data-slate-object="text" data-key="12846"><span data-slate-leaf="true" data-offset-key="12846:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12847"><span data-slate-leaf="true" data-offset-key="12847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个 else if 语句判断是否要将该主题分区状态转换到非离线状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12848"><span data-slate-object="text" data-key="12849"><span data-slate-leaf="true" data-offset-key="12849:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="12850"><span data-slate-leaf="true" data-offset-key="12850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="12851"><span data-slate-leaf="true" data-offset-key="12851:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12852"><span data-slate-leaf="true" data-offset-key="12852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12853"><span data-slate-leaf="true" data-offset-key="12853:0" data-first-offset="true"><span data-slate-string="true"> (currentState == OfflinePartition &amp;&amp; targetState != OfflinePartition) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12854"><span data-slate-object="text" data-key="12855"><span data-slate-leaf="true" data-offset-key="12855:0" data-first-offset="true"><span data-slate-string="true">      offlinePartitionCount = offlinePartitionCount - </span></span></span><span data-slate-object="text" data-key="12856"><span data-slate-leaf="true" data-offset-key="12856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12857"><span data-slate-object="text" data-key="12858"><span data-slate-leaf="true" data-offset-key="12858:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12859"><span data-slate-object="text" data-key="12860"><span data-slate-leaf="true" data-offset-key="12860:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12861"><span data-slate-object="text" data-key="12862"><span data-slate-leaf="true" data-offset-key="12862:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12863"><span data-slate-object="text" data-key="12864"><span data-slate-leaf="true" data-offset-key="12864:0" data-first-offset="true"><span data-slate-string="true">该方法首先要判断，此分区所属的主题当前是否处于删除操作的过程中。如果是的话，Kafka 就不能修改这个分区的状态，那么代码什么都不做，直接返回。否则，代码会判断该分区是否要转换到离线状态。如果 targetState 是 OfflinePartition，那么就将 offlinePartitionCount 值加 1，毕竟多了一个离线状态的分区。相反地，如果 currentState 是 offlinePartition，而 targetState 反而不是，那么就将 offlinePartitionCount 值减 1。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12865" id="sr-toc-6"><span data-slate-object="text" data-key="12866"><span data-slate-leaf="true" data-offset-key="12866:0" data-first-offset="true"><span data-slate-string="true">shuttingDownBrokerIds</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12867"><span data-slate-object="text" data-key="12868"><span data-slate-leaf="true" data-offset-key="12868:0" data-first-offset="true"><span data-slate-string="true">顾名思义，</span></span></span><span data-slate-object="text" data-key="12869"><span data-slate-leaf="true" data-offset-key="12869:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该字段保存所有正在关闭中的 Broker ID 列表</span></span></span></span><span data-slate-object="text" data-key="12870"><span data-slate-leaf="true" data-offset-key="12870:0" data-first-offset="true"><span data-slate-string="true">。当 Controller 在管理集群 Broker 时，它要依靠这个字段来甄别 Broker 当前是否已关闭，因为处于关闭状态的 Broker 是不适合执行某些操作的，如分区重分配（Reassignment）以及主题删除等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12871"><span data-slate-object="text" data-key="12872"><span data-slate-leaf="true" data-offset-key="12872:0" data-first-offset="true"><span data-slate-string="true">另外，Kafka 必须要为这些关闭中的 Broker 执行很多清扫工作，Controller 定义了一个 onBrokerFailure 方法，它就是用来做这个的。代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="12873"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12874"><span data-slate-object="text" data-key="12875"><span data-slate-leaf="true" data-offset-key="12875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="12876"><span data-slate-leaf="true" data-offset-key="12876:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="12877"><span data-slate-leaf="true" data-offset-key="12877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">onBrokerFailure</span></span></span></span><span data-slate-object="text" data-key="12878"><span data-slate-leaf="true" data-offset-key="12878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(deadBrokers: Seq[Int])</span></span></span></span><span data-slate-object="text" data-key="12879"><span data-slate-leaf="true" data-offset-key="12879:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12880"><span data-slate-object="text" data-key="12881"><span data-slate-leaf="true" data-offset-key="12881:0" data-first-offset="true"><span data-slate-string="true">  info(s</span></span></span><span data-slate-object="text" data-key="12882"><span data-slate-leaf="true" data-offset-key="12882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Broker failure callback for ${deadBrokers.mkString("</span></span></span></span><span data-slate-object="text" data-key="12883"><span data-slate-leaf="true" data-offset-key="12883:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12884"><span data-slate-leaf="true" data-offset-key="12884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")}"</span></span></span></span><span data-slate-object="text" data-key="12885"><span data-slate-leaf="true" data-offset-key="12885:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12886"><span data-slate-object="text" data-key="12887"><span data-slate-leaf="true" data-offset-key="12887:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12888"><span data-slate-leaf="true" data-offset-key="12888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//deadBrokers：给定的一组已终止运行的 Broker Id 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12889"><span data-slate-object="text" data-key="12890"><span data-slate-leaf="true" data-offset-key="12890:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12891"><span data-slate-leaf="true" data-offset-key="12891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 Controller 元数据信息，将给定 Broker 从元数据的 replicasOnOfflineDirs 中移除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12892"><span data-slate-object="text" data-key="12893"><span data-slate-leaf="true" data-offset-key="12893:0" data-first-offset="true"><span data-slate-string="true">  deadBrokers.foreach(controllerContext.replicasOnOfflineDirs.remove)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12894"><span data-slate-object="text" data-key="12895"><span data-slate-leaf="true" data-offset-key="12895:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12896"><span data-slate-leaf="true" data-offset-key="12896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找出这些 Broker 上的所有副本对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12897"><span data-slate-object="text" data-key="12898"><span data-slate-leaf="true" data-offset-key="12898:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12899"><span data-slate-leaf="true" data-offset-key="12899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12900"><span data-slate-leaf="true" data-offset-key="12900:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12901"><span data-slate-leaf="true" data-offset-key="12901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deadBrokersThatWereShuttingDown</span></span></span></span><span data-slate-object="text" data-key="12902"><span data-slate-leaf="true" data-offset-key="12902:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12903"><span data-slate-leaf="true" data-offset-key="12903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12904"><span data-slate-object="text" data-key="12905"><span data-slate-leaf="true" data-offset-key="12905:0" data-first-offset="true"><span data-slate-string="true">    deadBrokers.filter(id =&gt; controllerContext.shuttingDownBrokerIds.remove(id))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12906"><span data-slate-object="text" data-key="12907"><span data-slate-leaf="true" data-offset-key="12907:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12908"><span data-slate-leaf="true" data-offset-key="12908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12909"><span data-slate-leaf="true" data-offset-key="12909:0" data-first-offset="true"><span data-slate-string="true"> (deadBrokersThatWereShuttingDown.nonEmpty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12910"><span data-slate-object="text" data-key="12911"><span data-slate-leaf="true" data-offset-key="12911:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="12912"><span data-slate-leaf="true" data-offset-key="12912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Removed ${deadBrokersThatWereShuttingDown.mkString("</span></span></span></span><span data-slate-object="text" data-key="12913"><span data-slate-leaf="true" data-offset-key="12913:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12914"><span data-slate-leaf="true" data-offset-key="12914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")} from list of shutting down brokers."</span></span></span></span><span data-slate-object="text" data-key="12915"><span data-slate-leaf="true" data-offset-key="12915:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12916"><span data-slate-object="text" data-key="12917"><span data-slate-leaf="true" data-offset-key="12917:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12918"><span data-slate-leaf="true" data-offset-key="12918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行副本清扫工作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12919"><span data-slate-object="text" data-key="12920"><span data-slate-leaf="true" data-offset-key="12920:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12921"><span data-slate-leaf="true" data-offset-key="12921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12922"><span data-slate-leaf="true" data-offset-key="12922:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12923"><span data-slate-leaf="true" data-offset-key="12923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">allReplicasOnDeadBrokers</span></span></span></span><span data-slate-object="text" data-key="12924"><span data-slate-leaf="true" data-offset-key="12924:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12925"><span data-slate-leaf="true" data-offset-key="12925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12926"><span data-slate-leaf="true" data-offset-key="12926:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.replicasOnBrokers(deadBrokers.toSet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12927"><span data-slate-object="text" data-key="12928"><span data-slate-leaf="true" data-offset-key="12928:0" data-first-offset="true"><span data-slate-string="true">  onReplicasBecomeOffline(allReplicasOnDeadBrokers)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12929"><span data-slate-object="text" data-key="12930"><span data-slate-leaf="true" data-offset-key="12930:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12931"><span data-slate-leaf="true" data-offset-key="12931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消这些 Broker 上注册的 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12932"><span data-slate-object="text" data-key="12933"><span data-slate-leaf="true" data-offset-key="12933:0" data-first-offset="true"><span data-slate-string="true">  unregisterBrokerModificationsHandler(deadBrokers)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12934"><span data-slate-object="text" data-key="12935"><span data-slate-leaf="true" data-offset-key="12935:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12936"><span data-slate-object="text" data-key="12937"><span data-slate-leaf="true" data-offset-key="12937:0" data-first-offset="true"><span data-slate-string="true">该方法接收一组已终止运行的 Broker ID 列表，首先是更新 Controller 元数据信息，将给定 Broker 从元数据的 replicasOnOfflineDirs 和 shuttingDownBrokerIds 中移除，然后为这组 Broker 执行必要的副本清扫工作，也就是 onReplicasBecomeOffline 方法做的事情。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12938"><span data-slate-object="text" data-key="12939"><span data-slate-leaf="true" data-offset-key="12939:0" data-first-offset="true"><span data-slate-string="true">该方法主要依赖于分区状态机和副本状态机来完成对应的工作。在后面的课程中，我们会专门讨论副本状态机和分区状态机，这里你只要简单了解下它要做的事情就行了。后面等我们学完了这两个状态机之后，你可以再看下这个方法的具体实现原理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12940"><span data-slate-object="text" data-key="12941"><span data-slate-leaf="true" data-offset-key="12941:0" data-first-offset="true"><span data-slate-string="true">这个方法的主要目的是把给定的副本标记成 Offline 状态，即不可用状态。具体分为以下这几个步骤：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="12942"><div data-slate-type="list-line" data-slate-object="block" data-key="12943"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="12944"><span data-slate-leaf="true" data-offset-key="12944:0" data-first-offset="true"><span data-slate-string="true">利用分区状态机将给定副本所在的分区标记为 Offline 状态；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="12945"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="12946"><span data-slate-leaf="true" data-offset-key="12946:0" data-first-offset="true"><span data-slate-string="true">将集群上所有新分区和 Offline 分区状态变更为 Online 状态；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="12947"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="12948"><span data-slate-leaf="true" data-offset-key="12948:0" data-first-offset="true"><span data-slate-string="true">将相应的副本对象状态变更为 Offline。</span></span></span></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12949" id="sr-toc-7"><span data-slate-object="text" data-key="12950"><span data-slate-leaf="true" data-offset-key="12950:0" data-first-offset="true"><span data-slate-string="true">liveBrokers</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12951"><span data-slate-object="text" data-key="12952"><span data-slate-leaf="true" data-offset-key="12952:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该字段保存当前所有运行中的 Broker 对象</span></span></span></span><span data-slate-object="text" data-key="12953"><span data-slate-leaf="true" data-offset-key="12953:0" data-first-offset="true"><span data-slate-string="true">。每个 Broker 对象就是一个 &lt;Id，EndPoint，机架信息&gt; 的三元组。ControllerContext 中定义了很多方法来管理该字段，如 addLiveBrokersAndEpochs、removeLiveBrokers 和 updateBrokerMetadata 等。我拿 updateBrokerMetadata 方法进行说明，以下是源码：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="12954"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12955"><span data-slate-object="text" data-key="12956"><span data-slate-leaf="true" data-offset-key="12956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def</span></span></span></span><span data-slate-object="text" data-key="12957"><span data-slate-leaf="true" data-offset-key="12957:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12958"><span data-slate-leaf="true" data-offset-key="12958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">updateBrokerMetadata</span></span></span></span><span data-slate-object="text" data-key="12959"><span data-slate-leaf="true" data-offset-key="12959:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12960"><span data-slate-leaf="true" data-offset-key="12960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">oldMetadata: Broker, newMetadata: Broker</span></span></span></span><span data-slate-object="text" data-key="12961"><span data-slate-leaf="true" data-offset-key="12961:0" data-first-offset="true"><span data-slate-string="true">): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12962"><span data-slate-object="text" data-key="12963"><span data-slate-leaf="true" data-offset-key="12963:0" data-first-offset="true"><span data-slate-string="true">    liveBrokers -= oldMetadata</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12964"><span data-slate-object="text" data-key="12965"><span data-slate-leaf="true" data-offset-key="12965:0" data-first-offset="true"><span data-slate-string="true">    liveBrokers += newMetadata</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12966"><span data-slate-object="text" data-key="12967"><span data-slate-leaf="true" data-offset-key="12967:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12968"><span data-slate-object="text" data-key="12969"><span data-slate-leaf="true" data-offset-key="12969:0" data-first-offset="true"><span data-slate-string="true">每当新增或移除已有 Broker 时，ZooKeeper 就会更新其保存的 Broker 数据，从而引发 Controller 修改元数据，也就是会调用 updateBrokerMetadata 方法来增减 Broker 列表中的对象。怎么样，超简单吧？！</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12970" id="sr-toc-8"><span data-slate-object="text" data-key="12971"><span data-slate-leaf="true" data-offset-key="12971:0" data-first-offset="true"><span data-slate-string="true">liveBrokerEpochs</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12972"><span data-slate-object="text" data-key="12973"><span data-slate-leaf="true" data-offset-key="12973:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该字段保存所有运行中 Broker 的 Epoch 信息</span></span></span></span><span data-slate-object="text" data-key="12974"><span data-slate-leaf="true" data-offset-key="12974:0" data-first-offset="true"><span data-slate-string="true">。Kafka 使用 Epoch 数据防止 Zombie Broker，即一个非常老的 Broker 被选举成为 Controller。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12975"><span data-slate-object="text" data-key="12976"><span data-slate-leaf="true" data-offset-key="12976:0" data-first-offset="true"><span data-slate-string="true">另外，源码大多使用这个字段来获取所有运行中 Broker 的 ID 序号，如下面这个方法定义的那样：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="12977"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12978"><span data-slate-object="text" data-key="12979"><span data-slate-leaf="true" data-offset-key="12979:0" data-first-offset="true"><span data-slate-string="true">def liveBrokerIds: </span></span></span><span data-slate-object="text" data-key="12980"><span data-slate-leaf="true" data-offset-key="12980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="12981"><span data-slate-leaf="true" data-offset-key="12981:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="12982"><span data-slate-leaf="true" data-offset-key="12982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="12983"><span data-slate-leaf="true" data-offset-key="12983:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="12984"><span data-slate-leaf="true" data-offset-key="12984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12985"><span data-slate-leaf="true" data-offset-key="12985:0" data-first-offset="true"><span data-slate-string="true"> liveBrokerEpochs.keySet </span></span></span><span data-slate-object="text" data-key="12986"><span data-slate-leaf="true" data-offset-key="12986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-- shuttingDownBrokerIds</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12987"><span data-slate-object="text" data-key="12988"><span data-slate-leaf="true" data-offset-key="12988:0" data-first-offset="true"><span data-slate-string="true">liveBrokerEpochs 的 keySet 方法返回 Broker 序号列表，然后从中移除关闭中的 Broker 序号，剩下的自然就是处于运行中的 Broker 序号列表了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12989" id="sr-toc-9"><span data-slate-object="text" data-key="12990"><span data-slate-leaf="true" data-offset-key="12990:0" data-first-offset="true"><span data-slate-string="true">epoch &amp; epochZkVersion</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12991"><span data-slate-object="text" data-key="12992"><span data-slate-leaf="true" data-offset-key="12992:0" data-first-offset="true"><span data-slate-string="true">这两个字段一起说，因为它们都有 “epoch” 字眼，放在一起说，可以帮助你更好地理解两者的区别。epoch 实际上就是 ZooKeeper 中 /controller_epoch 节点的值，你可以认为它就是 Controller 在整个 Kafka 集群的版本号，而 epochZkVersion 实际上是 /controller_epoch 节点的 dataVersion 值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12993"><span data-slate-object="text" data-key="12994"><span data-slate-leaf="true" data-offset-key="12994:0" data-first-offset="true"><span data-slate-string="true">Kafka 使用 epochZkVersion 来判断和防止 Zombie Controller。这也就是说，原先在老 Controller 任期内的 Controller 操作在新 Controller 不能成功执行，因为新 Controller 的 epochZkVersion 要比老 Controller 的大。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12995"><span data-slate-object="text" data-key="12996"><span data-slate-leaf="true" data-offset-key="12996:0" data-first-offset="true"><span data-slate-string="true">另外，你可能会问：“这里的两个 Epoch 和上面的 liveBrokerEpochs 有啥区别呢？” 实际上，这里的两个 Epoch 值都是属于 Controller 侧的数据，而 liveBrokerEpochs 是每个 Broker 自己的 Epoch 值。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12997" id="sr-toc-10"><span data-slate-object="text" data-key="12998"><span data-slate-leaf="true" data-offset-key="12998:0" data-first-offset="true"><span data-slate-string="true">allTopics</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12999"><span data-slate-object="text" data-key="13000"><span data-slate-leaf="true" data-offset-key="13000:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该字段保存集群上所有的主题名称</span></span></span></span><span data-slate-object="text" data-key="13001"><span data-slate-leaf="true" data-offset-key="13001:0" data-first-offset="true"><span data-slate-string="true">。每当有主题的增减，Controller 就要更新该字段的值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13002"><span data-slate-object="text" data-key="13003"><span data-slate-leaf="true" data-offset-key="13003:0" data-first-offset="true"><span data-slate-string="true">比如 Controller 有个 processTopicChange 方法，从名字上来看，它就是处理主题变更的。我们来看下它的代码实现，我把主要逻辑以注释的方式标注了出来：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13004"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13005"><span data-slate-object="text" data-key="13006"><span data-slate-leaf="true" data-offset-key="13006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="13007"><span data-slate-leaf="true" data-offset-key="13007:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="13008"><span data-slate-leaf="true" data-offset-key="13008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processTopicChange</span></span></span></span><span data-slate-object="text" data-key="13009"><span data-slate-leaf="true" data-offset-key="13009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="13010"><span data-slate-leaf="true" data-offset-key="13010:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13011"><span data-slate-object="text" data-key="13012"><span data-slate-leaf="true" data-offset-key="13012:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13013"><span data-slate-leaf="true" data-offset-key="13013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13014"><span data-slate-leaf="true" data-offset-key="13014:0" data-first-offset="true"><span data-slate-string="true"> (!isActive) </span></span></span><span data-slate-object="text" data-key="13015"><span data-slate-leaf="true" data-offset-key="13015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13016"><span data-slate-leaf="true" data-offset-key="13016:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13017"><span data-slate-leaf="true" data-offset-key="13017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果 Contorller 已经关闭，直接返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13018"><span data-slate-object="text" data-key="13019"><span data-slate-leaf="true" data-offset-key="13019:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13020"><span data-slate-leaf="true" data-offset-key="13020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13021"><span data-slate-leaf="true" data-offset-key="13021:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13022"><span data-slate-leaf="true" data-offset-key="13022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topics</span></span></span></span><span data-slate-object="text" data-key="13023"><span data-slate-leaf="true" data-offset-key="13023:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13024"><span data-slate-leaf="true" data-offset-key="13024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13025"><span data-slate-leaf="true" data-offset-key="13025:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getAllTopicsInCluster(</span></span></span><span data-slate-object="text" data-key="13026"><span data-slate-leaf="true" data-offset-key="13026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="13027"><span data-slate-leaf="true" data-offset-key="13027:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="13028"><span data-slate-leaf="true" data-offset-key="13028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 ZooKeeper 中获取当前所有主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13029"><span data-slate-object="text" data-key="13030"><span data-slate-leaf="true" data-offset-key="13030:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13031"><span data-slate-leaf="true" data-offset-key="13031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13032"><span data-slate-leaf="true" data-offset-key="13032:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13033"><span data-slate-leaf="true" data-offset-key="13033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newTopics</span></span></span></span><span data-slate-object="text" data-key="13034"><span data-slate-leaf="true" data-offset-key="13034:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13035"><span data-slate-leaf="true" data-offset-key="13035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13036"><span data-slate-leaf="true" data-offset-key="13036:0" data-first-offset="true"><span data-slate-string="true"> topics -- controllerContext.allTopics </span></span></span><span data-slate-object="text" data-key="13037"><span data-slate-leaf="true" data-offset-key="13037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找出当前元数据中不存在、ZooKeeper 中存在的主题，视为新增主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13038"><span data-slate-object="text" data-key="13039"><span data-slate-leaf="true" data-offset-key="13039:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13040"><span data-slate-leaf="true" data-offset-key="13040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13041"><span data-slate-leaf="true" data-offset-key="13041:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13042"><span data-slate-leaf="true" data-offset-key="13042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deletedTopics</span></span></span></span><span data-slate-object="text" data-key="13043"><span data-slate-leaf="true" data-offset-key="13043:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13044"><span data-slate-leaf="true" data-offset-key="13044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13045"><span data-slate-leaf="true" data-offset-key="13045:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.allTopics -- topics </span></span></span><span data-slate-object="text" data-key="13046"><span data-slate-leaf="true" data-offset-key="13046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找出当前元数据中存在、ZooKeeper 中不存在的主题，视为已删除主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13047"><span data-slate-object="text" data-key="13048"><span data-slate-leaf="true" data-offset-key="13048:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.allTopics = topics </span></span></span><span data-slate-object="text" data-key="13049"><span data-slate-leaf="true" data-offset-key="13049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 Controller 元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13050"><span data-slate-object="text" data-key="13051"><span data-slate-leaf="true" data-offset-key="13051:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13052"><span data-slate-leaf="true" data-offset-key="13052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为新增主题和已删除主题执行后续处理操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13053"><span data-slate-object="text" data-key="13054"><span data-slate-leaf="true" data-offset-key="13054:0" data-first-offset="true"><span data-slate-string="true">    registerPartitionModificationsHandlers(newTopics.toSeq)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13055"><span data-slate-object="text" data-key="13056"><span data-slate-leaf="true" data-offset-key="13056:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13057"><span data-slate-leaf="true" data-offset-key="13057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13058"><span data-slate-leaf="true" data-offset-key="13058:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13059"><span data-slate-leaf="true" data-offset-key="13059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addedPartitionReplicaAssignment</span></span></span></span><span data-slate-object="text" data-key="13060"><span data-slate-leaf="true" data-offset-key="13060:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13061"><span data-slate-leaf="true" data-offset-key="13061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13062"><span data-slate-leaf="true" data-offset-key="13062:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getFullReplicaAssignmentForTopics(newTopics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13063"><span data-slate-object="text" data-key="13064"><span data-slate-leaf="true" data-offset-key="13064:0" data-first-offset="true"><span data-slate-string="true">    deletedTopics.foreach(controllerContext.removeTopic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13065"><span data-slate-object="text" data-key="13066"><span data-slate-leaf="true" data-offset-key="13066:0" data-first-offset="true"><span data-slate-string="true">    addedPartitionReplicaAssignment.foreach {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13067"><span data-slate-object="text" data-key="13068"><span data-slate-leaf="true" data-offset-key="13068:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13069"><span data-slate-leaf="true" data-offset-key="13069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13070"><span data-slate-leaf="true" data-offset-key="13070:0" data-first-offset="true"><span data-slate-string="true"> (topicAndPartition, newReplicaAssignment) =&gt; controllerContext.updatePartitionFullReplicaAssignment(topicAndPartition, newReplicaAssignment)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13071"><span data-slate-object="text" data-key="13072"><span data-slate-leaf="true" data-offset-key="13072:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13073"><span data-slate-object="text" data-key="13074"><span data-slate-leaf="true" data-offset-key="13074:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="13075"><span data-slate-leaf="true" data-offset-key="13075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"New topics: [$newTopics], deleted topics: [$deletedTopics], new partition replica assignment"</span></span></span></span><span data-slate-object="text" data-key="13076"><span data-slate-leaf="true" data-offset-key="13076:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13077"><span data-slate-object="text" data-key="13078"><span data-slate-leaf="true" data-offset-key="13078:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="13079"><span data-slate-leaf="true" data-offset-key="13079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[$addedPartitionReplicaAssignment]"</span></span></span></span><span data-slate-object="text" data-key="13080"><span data-slate-leaf="true" data-offset-key="13080:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13081"><span data-slate-object="text" data-key="13082"><span data-slate-leaf="true" data-offset-key="13082:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13083"><span data-slate-leaf="true" data-offset-key="13083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13084"><span data-slate-leaf="true" data-offset-key="13084:0" data-first-offset="true"><span data-slate-string="true"> (addedPartitionReplicaAssignment.nonEmpty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13085"><span data-slate-object="text" data-key="13086"><span data-slate-leaf="true" data-offset-key="13086:0" data-first-offset="true"><span data-slate-string="true">      onNewPartitionCreation(addedPartitionReplicaAssignment.keySet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13087"><span data-slate-object="text" data-key="13088"><span data-slate-leaf="true" data-offset-key="13088:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13089"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13090" id="sr-toc-11"><span data-slate-object="text" data-key="13091"><span data-slate-leaf="true" data-offset-key="13091:0" data-first-offset="true"><span data-slate-string="true">partitionAssignments</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13092"><span data-slate-object="text" data-key="13093"><span data-slate-leaf="true" data-offset-key="13093:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该字段保存所有主题分区的副本分配情况</span></span></span></span><span data-slate-object="text" data-key="13094"><span data-slate-leaf="true" data-offset-key="13094:0" data-first-offset="true"><span data-slate-string="true">。在我看来，</span></span></span><span data-slate-object="text" data-key="13095"><span data-slate-leaf="true" data-offset-key="13095:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这是 Controller 最重要的元数据了</span></span></span></span><span data-slate-object="text" data-key="13096"><span data-slate-leaf="true" data-offset-key="13096:0" data-first-offset="true"><span data-slate-string="true">。事实上，你可以从这个字段衍生、定义很多实用的方法，来帮助 Kafka 从各种维度获取数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13097"><span data-slate-object="text" data-key="13098"><span data-slate-leaf="true" data-offset-key="13098:0" data-first-offset="true"><span data-slate-string="true">比如，如果 Kafka 要获取某个 Broker 上的所有分区，那么，它可以这样定义：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13099"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13100"><span data-slate-object="text" data-key="13101"><span data-slate-leaf="true" data-offset-key="13101:0" data-first-offset="true"><span data-slate-string="true">partitionAssignments.</span></span></span><span data-slate-object="text" data-key="13102"><span data-slate-leaf="true" data-offset-key="13102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flatMap</span></span></span></span><span data-slate-object="text" data-key="13103"><span data-slate-leaf="true" data-offset-key="13103:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13104"><span data-slate-object="text" data-key="13105"><span data-slate-leaf="true" data-offset-key="13105:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13106"><span data-slate-leaf="true" data-offset-key="13106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13107"><span data-slate-leaf="true" data-offset-key="13107:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13108"><span data-slate-leaf="true" data-offset-key="13108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="13109"><span data-slate-leaf="true" data-offset-key="13109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topic, topicReplicaAssignment</span></span></span></span></span><span data-slate-object="text" data-key="13110"><span data-slate-leaf="true" data-offset-key="13110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) =&gt;</span></span></span></span><span data-slate-object="text" data-key="13111"><span data-slate-leaf="true" data-offset-key="13111:0" data-first-offset="true"><span data-slate-string="true"> topicReplicaAssignment.</span></span></span><span data-slate-object="text" data-key="13112"><span data-slate-leaf="true" data-offset-key="13112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">filter</span></span></span></span><span data-slate-object="text" data-key="13113"><span data-slate-leaf="true" data-offset-key="13113:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13114"><span data-slate-object="text" data-key="13115"><span data-slate-leaf="true" data-offset-key="13115:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13116"><span data-slate-leaf="true" data-offset-key="13116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13117"><span data-slate-leaf="true" data-offset-key="13117:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13118"><span data-slate-leaf="true" data-offset-key="13118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="13119"><span data-slate-leaf="true" data-offset-key="13119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">_, partitionAssignment</span></span></span></span></span><span data-slate-object="text" data-key="13120"><span data-slate-leaf="true" data-offset-key="13120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) =&gt;</span></span></span></span><span data-slate-object="text" data-key="13121"><span data-slate-leaf="true" data-offset-key="13121:0" data-first-offset="true"><span data-slate-string="true"> partitionAssignment.</span></span></span><span data-slate-object="text" data-key="13122"><span data-slate-leaf="true" data-offset-key="13122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicas</span></span></span></span><span data-slate-object="text" data-key="13123"><span data-slate-leaf="true" data-offset-key="13123:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13124"><span data-slate-leaf="true" data-offset-key="13124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">contains</span></span></span></span><span data-slate-object="text" data-key="13125"><span data-slate-leaf="true" data-offset-key="13125:0" data-first-offset="true"><span data-slate-string="true">(brokerId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13126"><span data-slate-object="text" data-key="13127"><span data-slate-leaf="true" data-offset-key="13127:0" data-first-offset="true"><span data-slate-string="true">      }.</span></span></span><span data-slate-object="text" data-key="13128"><span data-slate-leaf="true" data-offset-key="13128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="13129"><span data-slate-leaf="true" data-offset-key="13129:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13130"><span data-slate-object="text" data-key="13131"><span data-slate-leaf="true" data-offset-key="13131:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13132"><span data-slate-leaf="true" data-offset-key="13132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13133"><span data-slate-leaf="true" data-offset-key="13133:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13134"><span data-slate-leaf="true" data-offset-key="13134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="13135"><span data-slate-leaf="true" data-offset-key="13135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partition, _</span></span></span></span></span><span data-slate-object="text" data-key="13136"><span data-slate-leaf="true" data-offset-key="13136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) =&gt;</span></span></span></span><span data-slate-object="text" data-key="13137"><span data-slate-leaf="true" data-offset-key="13137:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13138"><span data-slate-leaf="true" data-offset-key="13138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13139"><span data-slate-leaf="true" data-offset-key="13139:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13140"><span data-slate-leaf="true" data-offset-key="13140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicPartition</span></span></span></span><span data-slate-object="text" data-key="13141"><span data-slate-leaf="true" data-offset-key="13141:0" data-first-offset="true"><span data-slate-string="true">(topic, partition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13142"><span data-slate-object="text" data-key="13143"><span data-slate-leaf="true" data-offset-key="13143:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13144"><span data-slate-object="text" data-key="13145"><span data-slate-leaf="true" data-offset-key="13145:0" data-first-offset="true"><span data-slate-string="true">    }.</span></span></span><span data-slate-object="text" data-key="13146"><span data-slate-leaf="true" data-offset-key="13146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">toSet</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13147"><span data-slate-object="text" data-key="13148"><span data-slate-leaf="true" data-offset-key="13148:0" data-first-offset="true"><span data-slate-string="true">再比如，如果 Kafka 要获取某个主题的所有分区对象，代码可以这样写：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13149"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13150"><span data-slate-object="text" data-key="13151"><span data-slate-leaf="true" data-offset-key="13151:0" data-first-offset="true"><span data-slate-string="true">partitionAssignments.</span></span></span><span data-slate-object="text" data-key="13152"><span data-slate-leaf="true" data-offset-key="13152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getOrElse</span></span></span></span><span data-slate-object="text" data-key="13153"><span data-slate-leaf="true" data-offset-key="13153:0" data-first-offset="true"><span data-slate-string="true">(topic, mutable.</span></span></span><span data-slate-object="text" data-key="13154"><span data-slate-leaf="true" data-offset-key="13154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13155"><span data-slate-leaf="true" data-offset-key="13155:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13156"><span data-slate-leaf="true" data-offset-key="13156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">empty</span></span></span></span><span data-slate-object="text" data-key="13157"><span data-slate-leaf="true" data-offset-key="13157:0" data-first-offset="true"><span data-slate-string="true">).</span></span></span><span data-slate-object="text" data-key="13158"><span data-slate-leaf="true" data-offset-key="13158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="13159"><span data-slate-leaf="true" data-offset-key="13159:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13160"><span data-slate-object="text" data-key="13161"><span data-slate-leaf="true" data-offset-key="13161:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13162"><span data-slate-leaf="true" data-offset-key="13162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13163"><span data-slate-leaf="true" data-offset-key="13163:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13164"><span data-slate-leaf="true" data-offset-key="13164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="13165"><span data-slate-leaf="true" data-offset-key="13165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partition, _</span></span></span></span></span><span data-slate-object="text" data-key="13166"><span data-slate-leaf="true" data-offset-key="13166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) =&gt;</span></span></span></span><span data-slate-object="text" data-key="13167"><span data-slate-leaf="true" data-offset-key="13167:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13168"><span data-slate-leaf="true" data-offset-key="13168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13169"><span data-slate-leaf="true" data-offset-key="13169:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13170"><span data-slate-leaf="true" data-offset-key="13170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicPartition</span></span></span></span><span data-slate-object="text" data-key="13171"><span data-slate-leaf="true" data-offset-key="13171:0" data-first-offset="true"><span data-slate-string="true">(topic, partition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13172"><span data-slate-object="text" data-key="13173"><span data-slate-leaf="true" data-offset-key="13173:0" data-first-offset="true"><span data-slate-string="true">    }.</span></span></span><span data-slate-object="text" data-key="13174"><span data-slate-leaf="true" data-offset-key="13174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">toSet</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13175"><span data-slate-object="text" data-key="13176"><span data-slate-leaf="true" data-offset-key="13176:0" data-first-offset="true"><span data-slate-string="true">实际上，这两段代码分别是 ControllerContext.scala 中 partitionsOnBroker 方法和 partitionsForTopic 两个方法的主体实现代码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13177"><span data-slate-object="text" data-key="13178"><span data-slate-leaf="true" data-offset-key="13178:0" data-first-offset="true"><span data-slate-string="true">讲到这里，9 个重要的元数据字段我就介绍完了。前面说过，ControllerContext 中一共定义了 17 个元数据字段，你可以结合这 9 个字段，把其余 8 个的定义也过一遍，做到心中有数。</span></span></span><span data-slate-object="text" data-key="13179"><span data-slate-leaf="true" data-offset-key="13179:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">你对 Controller 元数据掌握得越好，就越能清晰地理解 Controller 在集群中发挥的作用</span></span></span></span><span data-slate-object="text" data-key="13180"><span data-slate-leaf="true" data-offset-key="13180:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13181"><span data-slate-object="text" data-key="13182"><span data-slate-leaf="true" data-offset-key="13182:0" data-first-offset="true"><span data-slate-string="true">值得注意的是，在学习每个元数据字段时，除了它的定义之外，我建议你去搜索一下，与之相关的工具方法都是如何实现的。如果后面你想要新增获取或更新元数据的方法，你要对操作它们的代码有很强的把控力才行。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13183" id="sr-toc-12"><span data-slate-object="text" data-key="13184"><span data-slate-leaf="true" data-offset-key="13184:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13185"><span data-slate-object="text" data-key="13186"><span data-slate-leaf="true" data-offset-key="13186:0" data-first-offset="true"><span data-slate-string="true">今天，我们揭开了 Kafka 重要组件 Controller 的学习大幕。我给出了 Controller 模块的学习路线，还介绍了 Controller 的重要元数据。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13187"><div data-slate-type="list-line" data-slate-object="block" data-key="13188"><span data-slate-object="text" data-key="13189"><span data-slate-leaf="true" data-offset-key="13189:0" data-first-offset="true"><span data-slate-string="true">Controller 元数据：Controller 当前定义了 17 种元数据，涵盖 Kafka 集群数据的方方面面。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13190"><span data-slate-object="text" data-key="13191"><span data-slate-leaf="true" data-offset-key="13191:0" data-first-offset="true"><span data-slate-string="true">ControllerContext：定义元数据以及操作它们的类。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13192"><span data-slate-object="text" data-key="13193"><span data-slate-leaf="true" data-offset-key="13193:0" data-first-offset="true"><span data-slate-string="true">关键元数据字段：最重要的元数据包括 offlinePartitionCount、liveBrokers、partitionAssignments 等。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13194"><span data-slate-object="text" data-key="13195"><span data-slate-leaf="true" data-offset-key="13195:0" data-first-offset="true"><span data-slate-string="true">ControllerContext 工具方法：ControllerContext 类定义了很多实用方法来管理这些元数据信息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13196"><span data-slate-object="text" data-key="13197"><span data-slate-leaf="true" data-offset-key="13197:0" data-first-offset="true"><span data-slate-string="true">下节课，我们将学习 Controller 是如何给 Broker 发送请求的。Controller 与 Broker 进行交互与通信，是 Controller 奠定王者地位的重要一环，我会向你详细解释它是如何做到这一点的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13198" id="sr-toc-13"><span data-slate-object="text" data-key="13199"><span data-slate-leaf="true" data-offset-key="13199:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13200"><span data-slate-object="text" data-key="13201"><span data-slate-leaf="true" data-offset-key="13201:0" data-first-offset="true"><span data-slate-string="true">我今天并未给出所有的元数据说明，请你自行结合代码分析一下，partitionLeadershipInfo 里面保存的是什么数据？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13202"><span data-slate-object="text" data-key="13203"><span data-slate-leaf="true" data-offset-key="13203:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-14">精选留言 (10)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们重点了解了 Kafka 中重要的源码入口类 KafkaApis。课后我请你思考如果一个 Consumer 要向 Broker 提交位移，它应该具备什么权限以及声明权限的具体代码位置哪段代码。下面我给出我的答案：消费者要具有 GROUP 的 READ 权限和 TOPIC 的 READ 权限才能提交位移。具体代码位置在 handleOffsetCommitRequest 方法的这两行中：
if (!authorize (request.context, READ, GROUP, offsetCommitRequest.data.groupId)) {
	......
} else {
	......
	val authorizedTopics = filterByAuthorized (request.context, READ, TOPIC, topics)(_.name)
	......
}

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-05-19</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 曾轼麟</span></div></div><div>我个人比较期待 kafka 摆脱 zookeeper 的时候，之前看过一篇文章，对比 kafka 和 RocketMQ 的性能对比，其中总结出，kafka 的性能会受到 topic 数量的增加而下降，看了源码后才逐渐明白其实制约 kafka 的正是 zookeeper</div><div><p>作者回复：个人感觉性能的那个问题和 ZooKeeper 关系不大。主要还是分区路径太分散导致顺序 IO 变为随机 IO</p></div><div><div>2020-05-31</div><div><div><i></i><span>4</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 曾轼麟</span></div></div><div>partitionLeadershipInfo 存储的主要是 leader，leaderEpoch，isr 集合，zkVersion，这些都定义在 LeaderAndIsr 这个类里面</div><div><p>作者回复: 👍</p></div><div><div>2020-05-31</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 吃饭饭</span></div></div><div>z 这里怎么理解【将集群上所有新分区和 Offline 分区状态变更为 Online 状态；】直接把 deadBrokers 标记为 Offline 不就可以了吗？</div><div><p>作者回复：没太明白这个问题。到底是 online 还是 offline 的问题？
</p></div><div><div>2021-08-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/4c/a6/e6f1d773.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>鸣己</span></div></div><div>我有遇到过一个集群有三个 controller; 它们好像谁也不服谁，导致好多 topic 没 leader</div><div><div>2021-03-25</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div>val partitionLeadershipInfo = mutable.Map.empty [TopicPartition, LeaderIsrAndControllerEpoch]

def removeTopic (topic: String): Unit = {
    allTopics -= topic
    partitionAssignments.remove (topic)
    partitionLeadershipInfo.foreach {
      case (topicPartition, _) if topicPartition.topic == topic =&gt; partitionLeadershipInfo.remove (topicPartition)
      case _ =&gt;
    }
  }
根据 partitionLeadershipInfo 定义，以及在 removeTopic 方法中 partitionLeadershipInfo 的应用，可大概理解 partitionLeadershipInfo 中存储的是分区以及 leader epoch  类似变更版本信息</div><div><div>2020-08-24</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>曾轼麟</span></div></div><div>在 kafka 中我发现经常使用 epoch 的方式来判断版本新旧，其实 epoch 这种设计思想类似于乐观锁的方式</div><div><p>作者回复：应该算是 token 机制的一种</p></div><div><div>2020-05-31</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>您说删除的 watcher，oncontrollerfailover 重新初始化上下文，我感觉代价昂贵了些，就应该做这么多事吗？</div><div><p>作者回复：可以具体说说哪一步在您看来是多余的，也许是个优化的方向：）
</p></div><div><div>2020-05-15</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>还有请问 partitionLeadershipInfo 中 controller 的 epoch 是干吗的呢？</div><div><p>作者回复：你可以认为是 controller 换了多少次。比如 epoch = 5，说明 controller 前前后后更换过 6 次</p></div><div><div>2020-05-15</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>partitionLeadershipInfo 总的来说每个分区对应的分区主副本，isr 集合，还有 controller 的 epoch 数，</div><div><p>作者回复：嗯，是的</p></div><div><div>2020-05-15</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".14"><outline class="toc-level-h1" data-reactid=".14.0" style="width: 175px;"><active data-reactid=".14.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".14.0.1"><span data-reactid=".14.0.1.0">11 | Controller 元数据：Controller 都保存有哪些东西？有几种状态？</span></a></outline><outline class="toc-level-h2" data-reactid=".14.1" style="width: 165px;"><active data-reactid=".14.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".14.1.1"><span data-reactid=".14.1.1.0">案例分享</span></a></outline><outline class="toc-level-h2" data-reactid=".14.2" style="width: 165px;"><active data-reactid=".14.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".14.2.1"><span data-reactid=".14.2.1.0">集群元数据</span></a></outline><outline class="toc-level-h2" data-reactid=".14.3" style="width: 165px;"><active data-reactid=".14.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".14.3.1"><span data-reactid=".14.3.1.0">ControllerContext</span></a></outline><outline class="toc-level-h3" data-reactid=".14.4" style="width: 155px;"><active data-reactid=".14.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".14.4.1"><span data-reactid=".14.4.1.0">ControllerStats</span></a></outline><outline class="toc-level-h3" data-reactid=".14.5" style="width: 155px;"><active data-reactid=".14.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".14.5.1"><span data-reactid=".14.5.1.0">offlinePartitionCount</span></a></outline><outline class="toc-level-h3" data-reactid=".14.6" style="width: 155px;"><active data-reactid=".14.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".14.6.1"><span data-reactid=".14.6.1.0">shuttingDownBrokerIds</span></a></outline><outline class="toc-level-h3" data-reactid=".14.7" style="width: 155px;"><active data-reactid=".14.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".14.7.1"><span data-reactid=".14.7.1.0">liveBrokers</span></a></outline><outline class="toc-level-h3" data-reactid=".14.8" style="width: 155px;"><active data-reactid=".14.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".14.8.1"><span data-reactid=".14.8.1.0">liveBrokerEpochs</span></a></outline><outline class="toc-level-h3" data-reactid=".14.9" style="width: 155px;"><active data-reactid=".14.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".14.9.1"><span data-reactid=".14.9.1.0">epoch &amp; epochZkVersion</span></a></outline><outline class="toc-level-h3" data-reactid=".14.a" style="width: 155px;"><active data-reactid=".14.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".14.a.1"><span data-reactid=".14.a.1.0">allTopics</span></a></outline><outline class="toc-level-h3" data-reactid=".14.b" style="width: 155px;"><active data-reactid=".14.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".14.b.1"><span data-reactid=".14.b.1.0">partitionAssignments</span></a></outline><outline class="toc-level-h2" data-reactid=".14.c" style="width: 165px;"><active data-reactid=".14.c.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".14.c.1"><span data-reactid=".14.c.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".14.d" style="width: 165px;"><active data-reactid=".14.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".14.d.1"><span data-reactid=".14.d.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".14.e" style="width: 165px;"><active data-reactid=".14.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".14.e.1"><span data-reactid=".14.e.1.0">精选留言 (10)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/235562" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>