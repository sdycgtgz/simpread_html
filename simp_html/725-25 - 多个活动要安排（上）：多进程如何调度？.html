
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 25 | 多个活动要安排（上）：多进程如何调度？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>25 | 多个活动要安排（上）：多进程如何调度？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我会带你实现分配和释放内存页面，达到内存管理的目的。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">25 | 多个活动要安排（上）：多进程如何调度？</h1><div><span>LMOS</span> <span>2021-07-05</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/ea/0b/ea0f1d8cc08fdc1612009729e5f6e50b.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：14.78M</span><span> 时长：16:10</span></div></div><audio title="25 | 多个活动要安排（上）：多进程如何调度？" src="https://res001.geekbang.org/media/audio/0b/c9/0bb0ab8d2c2cd7c3a9fb47dd5d8f29c9/ld/ld.m3u8" __idm_id__="950280"></audio></div><div><div><div><div data-slate-editor="true" data-key="12740" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="12741"><span data-slate-object="text" data-key="12742"><span data-slate-leaf="true" data-offset-key="12742:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12743"><span data-slate-object="text" data-key="12744"><span data-slate-leaf="true" data-offset-key="12744:0" data-first-offset="true"><span data-slate-string="true">上节课，我们了解了什么是进程，还一起写好了建立进程的代码。不知道你想过没有，如果在系统中只有一个进程，那我们提出进程相关的概念和实现与进程有关的功能，是不是就失去了意义呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12745"><span data-slate-object="text" data-key="12746"><span data-slate-leaf="true" data-offset-key="12746:0" data-first-offset="true"><span data-slate-string="true">显然，提出进程的目的之一，就是为了实现多个进程，使系统能运行多个应用程序。今天我们就在单进程的基础上扩展多进程，并在进程与进程之间进行调度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12747"><span data-slate-object="text" data-key="12748"><span data-slate-leaf="true" data-offset-key="12748:0" data-first-offset="true"><span data-slate-string="true">“你存在，我深深的脑海里，我的梦里，我的心里，我的代码里”，我经常一边哼着歌，一边写着代码，这就是我们大脑中最典型 “多进程” 场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12749"><span data-slate-object="text" data-key="12750"><span data-slate-leaf="true" data-offset-key="12750:0" data-first-offset="true"><span data-slate-string="true">再来举一个例子：你在 Windows 上，边听音乐，边浏览网页，还能回复微信消息。Windows 之所以能同时运行多个应用程序，就是因为 Windows 内核支持多进程机制，这就是最典型的多进程场景了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12751"><span data-slate-object="text" data-key="12752"><span data-slate-leaf="true" data-offset-key="12752:0" data-first-offset="true"><span data-slate-string="true">这节课配套代码，你可以点击</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12753"><span data-slate-object="text" data-key="12754"><span data-slate-leaf="true" data-offset-key="12754:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="12755"><span data-slate-leaf="true" data-offset-key="12755:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12756" id="sr-toc-1"><span data-slate-object="text" data-key="12757"><span data-slate-leaf="true" data-offset-key="12757:0" data-first-offset="true"><span data-slate-string="true">为什么需要多进程调度</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12758"><span data-slate-object="text" data-key="12759"><span data-slate-leaf="true" data-offset-key="12759:0" data-first-offset="true"><span data-slate-string="true">我们先来搞清楚多进程调度的原因是什么，我来归纳一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12760"><span data-slate-object="text" data-key="12761"><span data-slate-leaf="true" data-offset-key="12761:0" data-first-offset="true"><span data-slate-string="true">第一，CPU 同一时刻只能运行一个进程，而 CPU 个数总是比进程个数少，这就需要让多进程共用一个 CPU，每个进程在这个 CPU 上运行一段时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12762"><span data-slate-object="text" data-key="12763"><span data-slate-leaf="true" data-offset-key="12763:0" data-first-offset="true"><span data-slate-string="true">第二点原因，当一个进程不能获取某种资源，导致它不能继续运行时，就应该让出 CPU。当然你也可以把第一点中的 CPU 时间，也归纳为一种资源，这样就合并为一点：</span></span></span><span data-slate-object="text" data-key="12764"><span data-slate-leaf="true" data-offset-key="12764:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">进程拿不到资源就要让出 CPU。</span></span></span></span><span data-slate-object="text" data-key="12765"><span data-slate-leaf="true" data-offset-key="12765:0" data-first-offset="true"><span data-slate-string="true">我来为你画幅图就明白了，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12766"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/8b/52/8b94e8daaf985262d6a83d38dbb07152.jpg?wh=4704x3110"></div><div>多进程调度示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12767"><span data-slate-object="text" data-key="12768"><span data-slate-leaf="true" data-offset-key="12768:0" data-first-offset="true"><span data-slate-string="true">上图中，有五个进程，其中浏览器进程和微信进程依赖于网络和键盘的数据资源，如果不能满足它们，就应该通过进程调度让出 CPU。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12769"><span data-slate-object="text" data-key="12770"><span data-slate-leaf="true" data-offset-key="12770:0" data-first-offset="true"><span data-slate-string="true">而两个科学计算进程，则更多的依赖于 CPU，但是如果它们中的一个用完了自己的 CPU 时间，也得借助进程调度让出 CPU，不然它就会长期霸占 CPU，导致其它进程无法运行。需要注意的是，每个进程都会依赖一种资源，那就是 CPU 时间，你可以把 CPU 时间理解为它就是 CPU，一个进程必须要有 CPU 才能运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12771"><span data-slate-object="text" data-key="12772"><span data-slate-leaf="true" data-offset-key="12772:0" data-first-offset="true"><span data-slate-string="true">这里我们只需要明白，多个进程为什么要进行调度，就可以了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12773" id="sr-toc-2"><span data-slate-object="text" data-key="12774"><span data-slate-leaf="true" data-offset-key="12774:0" data-first-offset="true"><span data-slate-string="true">管理进程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12775"><span data-slate-object="text" data-key="12776"><span data-slate-leaf="true" data-offset-key="12776:0" data-first-offset="true"><span data-slate-string="true">下面我们一起来看看怎么管理进程，我们的 Cosmos 操作系统也支持多个进程，有了多个进程就要把它们管理起来。说白了，就是弄清楚这些进程有哪些状态，是如何组织起来的，又要从哪找到它们。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12777" id="sr-toc-3"><span data-slate-object="text" data-key="12778"><span data-slate-leaf="true" data-offset-key="12778:0" data-first-offset="true"><span data-slate-string="true">进程的生命周期</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12779"><span data-slate-object="text" data-key="12780"><span data-slate-leaf="true" data-offset-key="12780:0" data-first-offset="true"><span data-slate-string="true">人有生老病死，对于一个进程来说也是一样。一个进程从建立开始，接着运行，然后因为资源问题不得不暂停运行，最后退出系统。这一过程，我们称为进程的生命周期。在系统实现中，通常用进程的状态表示进程的生命周期。进程的状态我们用几个宏来定义，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12781"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12782"><span data-slate-object="text" data-key="12783"><span data-slate-leaf="true" data-offset-key="12783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12784"><span data-slate-leaf="true" data-offset-key="12784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12785"><span data-slate-leaf="true" data-offset-key="12785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> TDSTUS_RUN 0        </span></span></span></span><span data-slate-object="text" data-key="12786"><span data-slate-leaf="true" data-offset-key="12786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程运行状态</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12787"><span data-slate-object="text" data-key="12788"><span data-slate-leaf="true" data-offset-key="12788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12789"><span data-slate-leaf="true" data-offset-key="12789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12790"><span data-slate-leaf="true" data-offset-key="12790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> TDSTUS_SLEEP 3      </span></span></span></span><span data-slate-object="text" data-key="12791"><span data-slate-leaf="true" data-offset-key="12791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程睡眠状态</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12792"><span data-slate-object="text" data-key="12793"><span data-slate-leaf="true" data-offset-key="12793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12794"><span data-slate-leaf="true" data-offset-key="12794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12795"><span data-slate-leaf="true" data-offset-key="12795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> TDSTUS_WAIT 4       </span></span></span></span><span data-slate-object="text" data-key="12796"><span data-slate-leaf="true" data-offset-key="12796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程等待状态</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12797"><span data-slate-object="text" data-key="12798"><span data-slate-leaf="true" data-offset-key="12798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12799"><span data-slate-leaf="true" data-offset-key="12799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12800"><span data-slate-leaf="true" data-offset-key="12800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> TDSTUS_NEW 5        </span></span></span></span><span data-slate-object="text" data-key="12801"><span data-slate-leaf="true" data-offset-key="12801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程新建状态</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12802"><span data-slate-object="text" data-key="12803"><span data-slate-leaf="true" data-offset-key="12803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12804"><span data-slate-leaf="true" data-offset-key="12804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12805"><span data-slate-leaf="true" data-offset-key="12805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> TDSTUS_ZOMB 6       </span></span></span></span><span data-slate-object="text" data-key="12806"><span data-slate-leaf="true" data-offset-key="12806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程僵死状态</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12807"><span data-slate-object="text" data-key="12808"><span data-slate-leaf="true" data-offset-key="12808:0" data-first-offset="true"><span data-slate-string="true">可以发现，我们的进程有 5 个状态。其中进程僵死状态，表示进程将要退出系统不再进行调度。那么进程状态之间是如何转换的，别急，我来给画一幅图解释，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12809"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a3/7a/a3ec5e2e1c0dc6acdb50095b20e2977a.jpg?wh=3453x2630"></div><div>进程状态切换示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12810"><span data-slate-object="text" data-key="12811"><span data-slate-leaf="true" data-offset-key="12811:0" data-first-offset="true"><span data-slate-string="true">上图中已经为你展示了，从建立进程到进程退出系统各状态之间的转换关系和需要满足的条件。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12812" id="sr-toc-4"><span data-slate-object="text" data-key="12813"><span data-slate-leaf="true" data-offset-key="12813:0" data-first-offset="true"><span data-slate-string="true">如何组织进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12814"><span data-slate-object="text" data-key="12815"><span data-slate-leaf="true" data-offset-key="12815:0" data-first-offset="true"><span data-slate-string="true">首先我们来研究如何组织进程。由于系统中会有许多个进程，在上节课中我们用 thread_t 结构表示一个进程，因此会有多个 thread_t 结构。而根据刚才我们对进程生命周期的解读，我们又知道了进程是随时可能建立或者退出的，所以系统中会随时分配或者删除 thread_t 结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12816"><span data-slate-object="text" data-key="12817"><span data-slate-leaf="true" data-offset-key="12817:0" data-first-offset="true"><span data-slate-string="true">要应对这样的情况，最简单的办法就是</span></span></span><span data-slate-object="text" data-key="12818"><span data-slate-leaf="true" data-offset-key="12818:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">使用链表数据结构</span></span></span></span><span data-slate-object="text" data-key="12819"><span data-slate-leaf="true" data-offset-key="12819:0" data-first-offset="true"><span data-slate-string="true">，而且我们的进程有优先级，所以我们可以设计成</span></span></span><span data-slate-object="text" data-key="12820"><span data-slate-leaf="true" data-offset-key="12820:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">每个优先级对应一个链表头</span></span></span></span><span data-slate-object="text" data-key="12821"><span data-slate-leaf="true" data-offset-key="12821:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12822"><span data-slate-object="text" data-key="12823"><span data-slate-leaf="true" data-offset-key="12823:0" data-first-offset="true"><span data-slate-string="true">下面我们来把设计落地成数据结构，由于这是调度器模块，所以我们要建立几个文件 krlsched.h、krlsched.c，在其中写上代码，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12824"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12825"><span data-slate-object="text" data-key="12826"><span data-slate-leaf="true" data-offset-key="12826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="12827"><span data-slate-leaf="true" data-offset-key="12827:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12828"><span data-slate-leaf="true" data-offset-key="12828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12829"><span data-slate-leaf="true" data-offset-key="12829:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12830"><span data-slate-leaf="true" data-offset-key="12830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_THRDLST</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12831"><span data-slate-object="text" data-key="12832"><span data-slate-leaf="true" data-offset-key="12832:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12833"><span data-slate-object="text" data-key="12834"><span data-slate-leaf="true" data-offset-key="12834:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12835"><span data-slate-leaf="true" data-offset-key="12835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="12836"><span data-slate-leaf="true" data-offset-key="12836:0" data-first-offset="true"><span data-slate-string="true">    tdl_lsth;                </span></span></span><span data-slate-object="text" data-key="12837"><span data-slate-leaf="true" data-offset-key="12837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 挂载进程的链表头</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12838"><span data-slate-object="text" data-key="12839"><span data-slate-leaf="true" data-offset-key="12839:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12840"><span data-slate-leaf="true" data-offset-key="12840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12841"><span data-slate-leaf="true" data-offset-key="12841:0" data-first-offset="true"><span data-slate-string="true">*   tdl_curruntd;            </span></span></span><span data-slate-object="text" data-key="12842"><span data-slate-leaf="true" data-offset-key="12842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 该链表上正在运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12843"><span data-slate-object="text" data-key="12844"><span data-slate-leaf="true" data-offset-key="12844:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12845"><span data-slate-leaf="true" data-offset-key="12845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12846"><span data-slate-leaf="true" data-offset-key="12846:0" data-first-offset="true"><span data-slate-string="true">      tdl_nr;                  </span></span></span><span data-slate-object="text" data-key="12847"><span data-slate-leaf="true" data-offset-key="12847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 该链表上进程个数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12848"><span data-slate-object="text" data-key="12849"><span data-slate-leaf="true" data-offset-key="12849:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="12850"><span data-slate-leaf="true" data-offset-key="12850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thrdlst_t</span></span></span></span><span data-slate-object="text" data-key="12851"><span data-slate-leaf="true" data-offset-key="12851:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12852"><span data-slate-object="text" data-key="12853"><span data-slate-leaf="true" data-offset-key="12853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="12854"><span data-slate-leaf="true" data-offset-key="12854:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12855"><span data-slate-leaf="true" data-offset-key="12855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12856"><span data-slate-leaf="true" data-offset-key="12856:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12857"><span data-slate-leaf="true" data-offset-key="12857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_SCHDATA</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12858"><span data-slate-object="text" data-key="12859"><span data-slate-leaf="true" data-offset-key="12859:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12860"><span data-slate-object="text" data-key="12861"><span data-slate-leaf="true" data-offset-key="12861:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12862"><span data-slate-leaf="true" data-offset-key="12862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="12863"><span data-slate-leaf="true" data-offset-key="12863:0" data-first-offset="true"><span data-slate-string="true">  sda_lock;                </span></span></span><span data-slate-object="text" data-key="12864"><span data-slate-leaf="true" data-offset-key="12864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12865"><span data-slate-object="text" data-key="12866"><span data-slate-leaf="true" data-offset-key="12866:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12867"><span data-slate-leaf="true" data-offset-key="12867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12868"><span data-slate-leaf="true" data-offset-key="12868:0" data-first-offset="true"><span data-slate-string="true">      sda_cpuid;               </span></span></span><span data-slate-object="text" data-key="12869"><span data-slate-leaf="true" data-offset-key="12869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前 CPU id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12870"><span data-slate-object="text" data-key="12871"><span data-slate-leaf="true" data-offset-key="12871:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12872"><span data-slate-leaf="true" data-offset-key="12872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12873"><span data-slate-leaf="true" data-offset-key="12873:0" data-first-offset="true"><span data-slate-string="true">      sda_schdflgs;            </span></span></span><span data-slate-object="text" data-key="12874"><span data-slate-leaf="true" data-offset-key="12874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12875"><span data-slate-object="text" data-key="12876"><span data-slate-leaf="true" data-offset-key="12876:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12877"><span data-slate-leaf="true" data-offset-key="12877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12878"><span data-slate-leaf="true" data-offset-key="12878:0" data-first-offset="true"><span data-slate-string="true">      sda_premptidx;           </span></span></span><span data-slate-object="text" data-key="12879"><span data-slate-leaf="true" data-offset-key="12879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程抢占计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12880"><span data-slate-object="text" data-key="12881"><span data-slate-leaf="true" data-offset-key="12881:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12882"><span data-slate-leaf="true" data-offset-key="12882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12883"><span data-slate-leaf="true" data-offset-key="12883:0" data-first-offset="true"><span data-slate-string="true">      sda_threadnr;            </span></span></span><span data-slate-object="text" data-key="12884"><span data-slate-leaf="true" data-offset-key="12884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12885"><span data-slate-object="text" data-key="12886"><span data-slate-leaf="true" data-offset-key="12886:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12887"><span data-slate-leaf="true" data-offset-key="12887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12888"><span data-slate-leaf="true" data-offset-key="12888:0" data-first-offset="true"><span data-slate-string="true">      sda_prityidx;            </span></span></span><span data-slate-object="text" data-key="12889"><span data-slate-leaf="true" data-offset-key="12889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前优先级</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12890"><span data-slate-object="text" data-key="12891"><span data-slate-leaf="true" data-offset-key="12891:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12892"><span data-slate-leaf="true" data-offset-key="12892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12893"><span data-slate-leaf="true" data-offset-key="12893:0" data-first-offset="true"><span data-slate-string="true">*   sda_cpuidle;             </span></span></span><span data-slate-object="text" data-key="12894"><span data-slate-leaf="true" data-offset-key="12894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前 CPU 的空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12895"><span data-slate-object="text" data-key="12896"><span data-slate-leaf="true" data-offset-key="12896:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12897"><span data-slate-leaf="true" data-offset-key="12897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span><span data-slate-object="text" data-key="12898"><span data-slate-leaf="true" data-offset-key="12898:0" data-first-offset="true"><span data-slate-string="true">*   sda_currtd;              </span></span></span><span data-slate-object="text" data-key="12899"><span data-slate-leaf="true" data-offset-key="12899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前正在运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12900"><span data-slate-object="text" data-key="12901"><span data-slate-leaf="true" data-offset-key="12901:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12902"><span data-slate-leaf="true" data-offset-key="12902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thrdlst_t</span></span></span></span><span data-slate-object="text" data-key="12903"><span data-slate-leaf="true" data-offset-key="12903:0" data-first-offset="true"><span data-slate-string="true">   sda_thdlst[PRITY_MAX];   </span></span></span><span data-slate-object="text" data-key="12904"><span data-slate-leaf="true" data-offset-key="12904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程链表数组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12905"><span data-slate-object="text" data-key="12906"><span data-slate-leaf="true" data-offset-key="12906:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="12907"><span data-slate-leaf="true" data-offset-key="12907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t</span></span></span></span><span data-slate-object="text" data-key="12908"><span data-slate-leaf="true" data-offset-key="12908:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12909"><span data-slate-object="text" data-key="12910"><span data-slate-leaf="true" data-offset-key="12910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="12911"><span data-slate-leaf="true" data-offset-key="12911:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12912"><span data-slate-leaf="true" data-offset-key="12912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12913"><span data-slate-leaf="true" data-offset-key="12913:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12914"><span data-slate-leaf="true" data-offset-key="12914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_SCHEDCALSS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12915"><span data-slate-object="text" data-key="12916"><span data-slate-leaf="true" data-offset-key="12916:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12917"><span data-slate-object="text" data-key="12918"><span data-slate-leaf="true" data-offset-key="12918:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12919"><span data-slate-leaf="true" data-offset-key="12919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="12920"><span data-slate-leaf="true" data-offset-key="12920:0" data-first-offset="true"><span data-slate-string="true">  scls_lock;                </span></span></span><span data-slate-object="text" data-key="12921"><span data-slate-leaf="true" data-offset-key="12921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12922"><span data-slate-object="text" data-key="12923"><span data-slate-leaf="true" data-offset-key="12923:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12924"><span data-slate-leaf="true" data-offset-key="12924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12925"><span data-slate-leaf="true" data-offset-key="12925:0" data-first-offset="true"><span data-slate-string="true">      scls_cpunr;               </span></span></span><span data-slate-object="text" data-key="12926"><span data-slate-leaf="true" data-offset-key="12926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//CPU 个数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12927"><span data-slate-object="text" data-key="12928"><span data-slate-leaf="true" data-offset-key="12928:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12929"><span data-slate-leaf="true" data-offset-key="12929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12930"><span data-slate-leaf="true" data-offset-key="12930:0" data-first-offset="true"><span data-slate-string="true">      scls_threadnr;            </span></span></span><span data-slate-object="text" data-key="12931"><span data-slate-leaf="true" data-offset-key="12931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 系统中所有的进程数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12932"><span data-slate-object="text" data-key="12933"><span data-slate-leaf="true" data-offset-key="12933:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12934"><span data-slate-leaf="true" data-offset-key="12934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12935"><span data-slate-leaf="true" data-offset-key="12935:0" data-first-offset="true"><span data-slate-string="true">      scls_threadid_inc;        </span></span></span><span data-slate-object="text" data-key="12936"><span data-slate-leaf="true" data-offset-key="12936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配进程 id 所用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12937"><span data-slate-object="text" data-key="12938"><span data-slate-leaf="true" data-offset-key="12938:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12939"><span data-slate-leaf="true" data-offset-key="12939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t</span></span></span></span><span data-slate-object="text" data-key="12940"><span data-slate-leaf="true" data-offset-key="12940:0" data-first-offset="true"><span data-slate-string="true">   scls_schda[CPUCORE_MAX];  </span></span></span><span data-slate-object="text" data-key="12941"><span data-slate-leaf="true" data-offset-key="12941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每个 CPU 调度数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12942"><span data-slate-object="text" data-key="12943"><span data-slate-leaf="true" data-offset-key="12943:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="12944"><span data-slate-leaf="true" data-offset-key="12944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schedclass_t</span></span></span></span><span data-slate-object="text" data-key="12945"><span data-slate-leaf="true" data-offset-key="12945:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12946"><span data-slate-object="text" data-key="12947"><span data-slate-leaf="true" data-offset-key="12947:0" data-first-offset="true"><span data-slate-string="true">从上述代码中，我们发现 schedclass_t 是个全局数据结构，这个结构里包含一个 schdata_t 结构数组，数组大小根据 CPU 的数量决定。在每个 schdata_t 结构中，又包含一个进程优先级大小的 thrdlst_t 结构数组。我画幅图，你就明白了。这幅图能让你彻底理清以上数据结构之间的关系。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12948"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/51/49/5181c38bfcb42c688076daaeb3452d49.jpg?wh=4304x1933"></div><div>组织进程示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12949"><span data-slate-object="text" data-key="12950"><span data-slate-leaf="true" data-offset-key="12950:0" data-first-offset="true"><span data-slate-string="true">好，下面我们就去定义这个 schedclass_t 数据结构并初始化。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12951" id="sr-toc-5"><span data-slate-object="text" data-key="12952"><span data-slate-leaf="true" data-offset-key="12952:0" data-first-offset="true"><span data-slate-string="true">管理进程的初始化</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12953"><span data-slate-object="text" data-key="12954"><span data-slate-leaf="true" data-offset-key="12954:0" data-first-offset="true"><span data-slate-string="true">管理进程的初始化非常简单，就是对 schedclass_t 结构的变量的初始化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12955"><span data-slate-object="text" data-key="12956"><span data-slate-leaf="true" data-offset-key="12956:0" data-first-offset="true"><span data-slate-string="true">通过前面的学习，你也许已经发现了，schedclass_t 结构的变量应该是个全局变量，所以先得在 cosmos/kernel/krlglobal.c 文件中定义一个 schedclass_t 结构的全局变量，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12957"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12958"><span data-slate-object="text" data-key="12959"><span data-slate-leaf="true" data-offset-key="12959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KRL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="12960"><span data-slate-leaf="true" data-offset-key="12960:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12961"><span data-slate-leaf="true" data-offset-key="12961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schedclass_t</span></span></span></span><span data-slate-object="text" data-key="12962"><span data-slate-leaf="true" data-offset-key="12962:0" data-first-offset="true"><span data-slate-string="true">,osschedcls);</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12963"><span data-slate-object="text" data-key="12964"><span data-slate-leaf="true" data-offset-key="12964:0" data-first-offset="true"><span data-slate-string="true">有了 schedclass_t 结构的全局变量 osschedcls，接着我们在 cosmos/kernel/krlsched.c 文件中写好初始化 osschedcls 变量的代码，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="12965"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12966"><span data-slate-object="text" data-key="12967"><span data-slate-leaf="true" data-offset-key="12967:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="12968"><span data-slate-leaf="true" data-offset-key="12968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thrdlst_t_init</span></span></span></span><span data-slate-object="text" data-key="12969"><span data-slate-leaf="true" data-offset-key="12969:0" data-first-offset="true"><span data-slate-string="true">(thrdlst_t *initp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12970"><span data-slate-object="text" data-key="12971"><span data-slate-leaf="true" data-offset-key="12971:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12972"><span data-slate-object="text" data-key="12973"><span data-slate-leaf="true" data-offset-key="12973:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12974"><span data-slate-leaf="true" data-offset-key="12974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_init</span></span></span></span><span data-slate-object="text" data-key="12975"><span data-slate-leaf="true" data-offset-key="12975:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="12976"><span data-slate-leaf="true" data-offset-key="12976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12977"><span data-slate-leaf="true" data-offset-key="12977:0" data-first-offset="true"><span data-slate-string="true">tdl_lsth); </span></span></span><span data-slate-object="text" data-key="12978"><span data-slate-leaf="true" data-offset-key="12978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化挂载进程的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12979"><span data-slate-object="text" data-key="12980"><span data-slate-leaf="true" data-offset-key="12980:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="12981"><span data-slate-leaf="true" data-offset-key="12981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12982"><span data-slate-leaf="true" data-offset-key="12982:0" data-first-offset="true"><span data-slate-string="true">tdl_curruntd = NULL; </span></span></span><span data-slate-object="text" data-key="12983"><span data-slate-leaf="true" data-offset-key="12983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开始没有运行进程 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12984"><span data-slate-object="text" data-key="12985"><span data-slate-leaf="true" data-offset-key="12985:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="12986"><span data-slate-leaf="true" data-offset-key="12986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="12987"><span data-slate-leaf="true" data-offset-key="12987:0" data-first-offset="true"><span data-slate-string="true">tdl_nr = </span></span></span><span data-slate-object="text" data-key="12988"><span data-slate-leaf="true" data-offset-key="12988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12989"><span data-slate-leaf="true" data-offset-key="12989:0" data-first-offset="true"><span data-slate-string="true">;  </span></span></span><span data-slate-object="text" data-key="12990"><span data-slate-leaf="true" data-offset-key="12990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开始没有进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12991"><span data-slate-object="text" data-key="12992"><span data-slate-leaf="true" data-offset-key="12992:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12993"><span data-slate-leaf="true" data-offset-key="12993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12994"><span data-slate-leaf="true" data-offset-key="12994:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12995"><span data-slate-object="text" data-key="12996"><span data-slate-leaf="true" data-offset-key="12996:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12997"><span data-slate-object="text" data-key="12998"><span data-slate-leaf="true" data-offset-key="12998:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="12999"><span data-slate-leaf="true" data-offset-key="12999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t_init</span></span></span></span><span data-slate-object="text" data-key="13000"><span data-slate-leaf="true" data-offset-key="13000:0" data-first-offset="true"><span data-slate-string="true">(schdata_t *initp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13001"><span data-slate-object="text" data-key="13002"><span data-slate-leaf="true" data-offset-key="13002:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13003"><span data-slate-object="text" data-key="13004"><span data-slate-leaf="true" data-offset-key="13004:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13005"><span data-slate-leaf="true" data-offset-key="13005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_init</span></span></span></span><span data-slate-object="text" data-key="13006"><span data-slate-leaf="true" data-offset-key="13006:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="13007"><span data-slate-leaf="true" data-offset-key="13007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13008"><span data-slate-leaf="true" data-offset-key="13008:0" data-first-offset="true"><span data-slate-string="true">sda_lock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13009"><span data-slate-object="text" data-key="13010"><span data-slate-leaf="true" data-offset-key="13010:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13011"><span data-slate-leaf="true" data-offset-key="13011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13012"><span data-slate-leaf="true" data-offset-key="13012:0" data-first-offset="true"><span data-slate-string="true">sda_cpuid = </span></span></span><span data-slate-object="text" data-key="13013"><span data-slate-leaf="true" data-offset-key="13013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="13014"><span data-slate-leaf="true" data-offset-key="13014:0" data-first-offset="true"><span data-slate-string="true">(); </span></span></span><span data-slate-object="text" data-key="13015"><span data-slate-leaf="true" data-offset-key="13015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 CPU id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13016"><span data-slate-object="text" data-key="13017"><span data-slate-leaf="true" data-offset-key="13017:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13018"><span data-slate-leaf="true" data-offset-key="13018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13019"><span data-slate-leaf="true" data-offset-key="13019:0" data-first-offset="true"><span data-slate-string="true">sda_schdflgs = NOTS_SCHED_FLGS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13020"><span data-slate-object="text" data-key="13021"><span data-slate-leaf="true" data-offset-key="13021:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13022"><span data-slate-leaf="true" data-offset-key="13022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13023"><span data-slate-leaf="true" data-offset-key="13023:0" data-first-offset="true"><span data-slate-string="true">sda_premptidx = </span></span></span><span data-slate-object="text" data-key="13024"><span data-slate-leaf="true" data-offset-key="13024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13025"><span data-slate-leaf="true" data-offset-key="13025:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13026"><span data-slate-object="text" data-key="13027"><span data-slate-leaf="true" data-offset-key="13027:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13028"><span data-slate-leaf="true" data-offset-key="13028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13029"><span data-slate-leaf="true" data-offset-key="13029:0" data-first-offset="true"><span data-slate-string="true">sda_threadnr = </span></span></span><span data-slate-object="text" data-key="13030"><span data-slate-leaf="true" data-offset-key="13030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13031"><span data-slate-leaf="true" data-offset-key="13031:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13032"><span data-slate-object="text" data-key="13033"><span data-slate-leaf="true" data-offset-key="13033:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13034"><span data-slate-leaf="true" data-offset-key="13034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13035"><span data-slate-leaf="true" data-offset-key="13035:0" data-first-offset="true"><span data-slate-string="true">sda_prityidx = </span></span></span><span data-slate-object="text" data-key="13036"><span data-slate-leaf="true" data-offset-key="13036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13037"><span data-slate-leaf="true" data-offset-key="13037:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13038"><span data-slate-object="text" data-key="13039"><span data-slate-leaf="true" data-offset-key="13039:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13040"><span data-slate-leaf="true" data-offset-key="13040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13041"><span data-slate-leaf="true" data-offset-key="13041:0" data-first-offset="true"><span data-slate-string="true">sda_cpuidle = NULL; </span></span></span><span data-slate-object="text" data-key="13042"><span data-slate-leaf="true" data-offset-key="13042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开始没有空转进程和运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13043"><span data-slate-object="text" data-key="13044"><span data-slate-leaf="true" data-offset-key="13044:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13045"><span data-slate-leaf="true" data-offset-key="13045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13046"><span data-slate-leaf="true" data-offset-key="13046:0" data-first-offset="true"><span data-slate-string="true">sda_currtd = NULL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13047"><span data-slate-object="text" data-key="13048"><span data-slate-leaf="true" data-offset-key="13048:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13049"><span data-slate-leaf="true" data-offset-key="13049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="13050"><span data-slate-leaf="true" data-offset-key="13050:0" data-first-offset="true"><span data-slate-string="true"> (uint_t ti = </span></span></span><span data-slate-object="text" data-key="13051"><span data-slate-leaf="true" data-offset-key="13051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13052"><span data-slate-leaf="true" data-offset-key="13052:0" data-first-offset="true"><span data-slate-string="true">; ti &lt;PRITY_MAX; ti++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13053"><span data-slate-object="text" data-key="13054"><span data-slate-leaf="true" data-offset-key="13054:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="13055"><span data-slate-leaf="true" data-offset-key="13055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 schdata_t 结构中的每个 thrdlst_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13056"><span data-slate-object="text" data-key="13057"><span data-slate-leaf="true" data-offset-key="13057:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13058"><span data-slate-leaf="true" data-offset-key="13058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thrdlst_t_init</span></span></span></span><span data-slate-object="text" data-key="13059"><span data-slate-leaf="true" data-offset-key="13059:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="13060"><span data-slate-leaf="true" data-offset-key="13060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13061"><span data-slate-leaf="true" data-offset-key="13061:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[ti]);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13062"><span data-slate-object="text" data-key="13063"><span data-slate-leaf="true" data-offset-key="13063:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13064"><span data-slate-object="text" data-key="13065"><span data-slate-leaf="true" data-offset-key="13065:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13066"><span data-slate-leaf="true" data-offset-key="13066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13067"><span data-slate-leaf="true" data-offset-key="13067:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13068"><span data-slate-object="text" data-key="13069"><span data-slate-leaf="true" data-offset-key="13069:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13070"><span data-slate-object="text" data-key="13071"><span data-slate-leaf="true" data-offset-key="13071:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="13072"><span data-slate-leaf="true" data-offset-key="13072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schedclass_t_init</span></span></span></span><span data-slate-object="text" data-key="13073"><span data-slate-leaf="true" data-offset-key="13073:0" data-first-offset="true"><span data-slate-string="true">(schedclass_t *initp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13074"><span data-slate-object="text" data-key="13075"><span data-slate-leaf="true" data-offset-key="13075:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13076"><span data-slate-object="text" data-key="13077"><span data-slate-leaf="true" data-offset-key="13077:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13078"><span data-slate-leaf="true" data-offset-key="13078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_init</span></span></span></span><span data-slate-object="text" data-key="13079"><span data-slate-leaf="true" data-offset-key="13079:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="13080"><span data-slate-leaf="true" data-offset-key="13080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13081"><span data-slate-leaf="true" data-offset-key="13081:0" data-first-offset="true"><span data-slate-string="true">scls_lock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13082"><span data-slate-object="text" data-key="13083"><span data-slate-leaf="true" data-offset-key="13083:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13084"><span data-slate-leaf="true" data-offset-key="13084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13085"><span data-slate-leaf="true" data-offset-key="13085:0" data-first-offset="true"><span data-slate-string="true">scls_cpunr = CPUCORE_MAX;  </span></span></span><span data-slate-object="text" data-key="13086"><span data-slate-leaf="true" data-offset-key="13086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//CPU 最大个数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13087"><span data-slate-object="text" data-key="13088"><span data-slate-leaf="true" data-offset-key="13088:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13089"><span data-slate-leaf="true" data-offset-key="13089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13090"><span data-slate-leaf="true" data-offset-key="13090:0" data-first-offset="true"><span data-slate-string="true">scls_threadnr = </span></span></span><span data-slate-object="text" data-key="13091"><span data-slate-leaf="true" data-offset-key="13091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13092"><span data-slate-leaf="true" data-offset-key="13092:0" data-first-offset="true"><span data-slate-string="true">;   </span></span></span><span data-slate-object="text" data-key="13093"><span data-slate-leaf="true" data-offset-key="13093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开始没有进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13094"><span data-slate-object="text" data-key="13095"><span data-slate-leaf="true" data-offset-key="13095:0" data-first-offset="true"><span data-slate-string="true">    initp</span></span></span><span data-slate-object="text" data-key="13096"><span data-slate-leaf="true" data-offset-key="13096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13097"><span data-slate-leaf="true" data-offset-key="13097:0" data-first-offset="true"><span data-slate-string="true">scls_threadid_inc = </span></span></span><span data-slate-object="text" data-key="13098"><span data-slate-leaf="true" data-offset-key="13098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13099"><span data-slate-leaf="true" data-offset-key="13099:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13100"><span data-slate-object="text" data-key="13101"><span data-slate-leaf="true" data-offset-key="13101:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13102"><span data-slate-leaf="true" data-offset-key="13102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="13103"><span data-slate-leaf="true" data-offset-key="13103:0" data-first-offset="true"><span data-slate-string="true"> (uint_t si = </span></span></span><span data-slate-object="text" data-key="13104"><span data-slate-leaf="true" data-offset-key="13104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13105"><span data-slate-leaf="true" data-offset-key="13105:0" data-first-offset="true"><span data-slate-string="true">; si &lt;CPUCORE_MAX; si++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13106"><span data-slate-object="text" data-key="13107"><span data-slate-leaf="true" data-offset-key="13107:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="13108"><span data-slate-leaf="true" data-offset-key="13108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 osschedcls 变量中的每个 schdata_t</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13109"><span data-slate-object="text" data-key="13110"><span data-slate-leaf="true" data-offset-key="13110:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13111"><span data-slate-leaf="true" data-offset-key="13111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t_init</span></span></span></span><span data-slate-object="text" data-key="13112"><span data-slate-leaf="true" data-offset-key="13112:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="13113"><span data-slate-leaf="true" data-offset-key="13113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13114"><span data-slate-leaf="true" data-offset-key="13114:0" data-first-offset="true"><span data-slate-string="true">scls_schda[si]);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13115"><span data-slate-object="text" data-key="13116"><span data-slate-leaf="true" data-offset-key="13116:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13117"><span data-slate-object="text" data-key="13118"><span data-slate-leaf="true" data-offset-key="13118:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13119"><span data-slate-leaf="true" data-offset-key="13119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13120"><span data-slate-leaf="true" data-offset-key="13120:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13121"><span data-slate-object="text" data-key="13122"><span data-slate-leaf="true" data-offset-key="13122:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13123"><span data-slate-object="text" data-key="13124"><span data-slate-leaf="true" data-offset-key="13124:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="13125"><span data-slate-leaf="true" data-offset-key="13125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlsched</span></span></span></span><span data-slate-object="text" data-key="13126"><span data-slate-leaf="true" data-offset-key="13126:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13127"><span data-slate-object="text" data-key="13128"><span data-slate-leaf="true" data-offset-key="13128:0" data-first-offset="true"><span data-slate-string="true">{   </span></span></span><span data-slate-object="text" data-key="13129"><span data-slate-leaf="true" data-offset-key="13129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 osschedcls 变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13130"><span data-slate-object="text" data-key="13131"><span data-slate-leaf="true" data-offset-key="13131:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13132"><span data-slate-leaf="true" data-offset-key="13132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schedclass_t_init</span></span></span></span><span data-slate-object="text" data-key="13133"><span data-slate-leaf="true" data-offset-key="13133:0" data-first-offset="true"><span data-slate-string="true">(&amp;osschedcls);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13134"><span data-slate-object="text" data-key="13135"><span data-slate-leaf="true" data-offset-key="13135:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13136"><span data-slate-leaf="true" data-offset-key="13136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13137"><span data-slate-leaf="true" data-offset-key="13137:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13138"><span data-slate-object="text" data-key="13139"><span data-slate-leaf="true" data-offset-key="13139:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13140"><span data-slate-object="text" data-key="13141"><span data-slate-leaf="true" data-offset-key="13141:0" data-first-offset="true"><span data-slate-string="true">上述代码非常简单，由 init_krlsched 函数调用 schedclass_t_init 函数，对 osschedcls 变量进行初始化工作，但是 init_krlsched 函数由谁调用呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13142"><span data-slate-object="text" data-key="13143"><span data-slate-leaf="true" data-offset-key="13143:0" data-first-offset="true"><span data-slate-string="true">还记得之前学的内核功能层的入口函数吗（可回看</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13144"><span data-slate-object="text" data-key="13145"><span data-slate-leaf="true" data-offset-key="13145:0" data-first-offset="true"><span data-slate-string="true">第 13 节课</span></span></span></a><span data-slate-object="text" data-key="13146"><span data-slate-leaf="true" data-offset-key="13146:0" data-first-offset="true"><span data-slate-string="true">）？它就是 cosmos/kernel/krlinit.c 文件中的 </span></span></span><span data-slate-object="text" data-key="13147"><span data-slate-leaf="true" data-offset-key="13147:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">init_krl 函数</span></span></span></span><span data-slate-object="text" data-key="13148"><span data-slate-leaf="true" data-offset-key="13148:0" data-first-offset="true"><span data-slate-string="true">，我们在这个函数中来调用 init_krlsched 函数，代码如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13149"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13150"><span data-slate-object="text" data-key="13151"><span data-slate-leaf="true" data-offset-key="13151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="13152"><span data-slate-leaf="true" data-offset-key="13152:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13153"><span data-slate-leaf="true" data-offset-key="13153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krl</span></span></span></span><span data-slate-object="text" data-key="13154"><span data-slate-leaf="true" data-offset-key="13154:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13155"><span data-slate-leaf="true" data-offset-key="13155:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13156"><span data-slate-object="text" data-key="13157"><span data-slate-leaf="true" data-offset-key="13157:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13158"><span data-slate-object="text" data-key="13159"><span data-slate-leaf="true" data-offset-key="13159:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13160"><span data-slate-leaf="true" data-offset-key="13160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlsched</span></span></span></span><span data-slate-object="text" data-key="13161"><span data-slate-leaf="true" data-offset-key="13161:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13162"><span data-slate-object="text" data-key="13163"><span data-slate-leaf="true" data-offset-key="13163:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13164"><span data-slate-leaf="true" data-offset-key="13164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">die</span></span></span></span><span data-slate-object="text" data-key="13165"><span data-slate-leaf="true" data-offset-key="13165:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13166"><span data-slate-leaf="true" data-offset-key="13166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13167"><span data-slate-leaf="true" data-offset-key="13167:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span><span data-slate-object="text" data-key="13168"><span data-slate-leaf="true" data-offset-key="13168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 控制不让 init_krl 函数返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13169"><span data-slate-object="text" data-key="13170"><span data-slate-leaf="true" data-offset-key="13170:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13171"><span data-slate-leaf="true" data-offset-key="13171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13172"><span data-slate-leaf="true" data-offset-key="13172:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13173"><span data-slate-object="text" data-key="13174"><span data-slate-leaf="true" data-offset-key="13174:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13175"><span data-slate-object="text" data-key="13176"><span data-slate-leaf="true" data-offset-key="13176:0" data-first-offset="true"><span data-slate-string="true">至此，管理进程的初始化就完成了，其实这也是我们进程调度器的初始化，就是这么简单吗？当然不是，还有重要的进程调度等我们搞定。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13177" id="sr-toc-6"><span data-slate-object="text" data-key="13178"><span data-slate-leaf="true" data-offset-key="13178:0" data-first-offset="true"><span data-slate-string="true">设计实现进程调度器</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13179"><span data-slate-object="text" data-key="13180"><span data-slate-leaf="true" data-offset-key="13180:0" data-first-offset="true"><span data-slate-string="true">管理进程的数据结构已经初始化好了，现在我们开始设计实现进程调度器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13181"><span data-slate-object="text" data-key="13182"><span data-slate-leaf="true" data-offset-key="13182:0" data-first-offset="true"><span data-slate-string="true">进程调度器是为了在合适的时间点，合适的代码执行路径上进行进程调度。说白了，就是从当前运行进程切换到另一个进程上运行，让当前进程停止运行，由 CPU 开始执行另一个进程的代码。这个事情说来简单，但做起来并不容易，下面我将带领你一步步实现进程调度器。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13183" id="sr-toc-7"><span data-slate-object="text" data-key="13184"><span data-slate-leaf="true" data-offset-key="13184:0" data-first-offset="true"><span data-slate-string="true">进程调度器入口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13185"><span data-slate-object="text" data-key="13186"><span data-slate-leaf="true" data-offset-key="13186:0" data-first-offset="true"><span data-slate-string="true">首先请你想象一下，进程调度器是什么样子的。其实，进程调度器不过是个函数，和其它函数并没有本质区别，你在其它很多代码执行路径上都可以调用它。只是它会从一个进程运行到下一个进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13187"><span data-slate-object="text" data-key="13188"><span data-slate-leaf="true" data-offset-key="13188:0" data-first-offset="true"><span data-slate-string="true">那这个函数的功能就能定下来了：</span></span></span><span data-slate-object="text" data-key="13189"><span data-slate-leaf="true" data-offset-key="13189:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">无非是确定当前正在运行的进程，然后选择下一个将要运行的进程，最后从当前运行的进程，切换到下一个将要运行的进程。</span></span></span></span><span data-slate-object="text" data-key="13190"><span data-slate-leaf="true" data-offset-key="13190:0" data-first-offset="true"><span data-slate-string="true">下面我们先来写好进程调度器的入口函数，如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13191"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13192"><span data-slate-object="text" data-key="13193"><span data-slate-leaf="true" data-offset-key="13193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="13194"><span data-slate-leaf="true" data-offset-key="13194:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13195"><span data-slate-leaf="true" data-offset-key="13195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlschedul</span></span></span></span><span data-slate-object="text" data-key="13196"><span data-slate-leaf="true" data-offset-key="13196:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13197"><span data-slate-leaf="true" data-offset-key="13197:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13198"><span data-slate-object="text" data-key="13199"><span data-slate-leaf="true" data-offset-key="13199:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13200"><span data-slate-object="text" data-key="13201"><span data-slate-leaf="true" data-offset-key="13201:0" data-first-offset="true"><span data-slate-string="true">    thread_t *prev = </span></span></span><span data-slate-object="text" data-key="13202"><span data-slate-leaf="true" data-offset-key="13202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_retn_currthread</span></span></span></span><span data-slate-object="text" data-key="13203"><span data-slate-leaf="true" data-offset-key="13203:0" data-first-offset="true"><span data-slate-string="true">(),</span></span></span><span data-slate-object="text" data-key="13204"><span data-slate-leaf="true" data-offset-key="13204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回当前运行进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13205"><span data-slate-object="text" data-key="13206"><span data-slate-leaf="true" data-offset-key="13206:0" data-first-offset="true"><span data-slate-string="true">             *next = </span></span></span><span data-slate-object="text" data-key="13207"><span data-slate-leaf="true" data-offset-key="13207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_select_thread</span></span></span></span><span data-slate-object="text" data-key="13208"><span data-slate-leaf="true" data-offset-key="13208:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="13209"><span data-slate-leaf="true" data-offset-key="13209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 选择下一个运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13210"><span data-slate-object="text" data-key="13211"><span data-slate-leaf="true" data-offset-key="13211:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13212"><span data-slate-leaf="true" data-offset-key="13212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">save_to_new_context</span></span></span></span><span data-slate-object="text" data-key="13213"><span data-slate-leaf="true" data-offset-key="13213:0" data-first-offset="true"><span data-slate-string="true">(next, prev);</span></span></span><span data-slate-object="text" data-key="13214"><span data-slate-leaf="true" data-offset-key="13214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从当前进程切换到下一个进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13215"><span data-slate-object="text" data-key="13216"><span data-slate-leaf="true" data-offset-key="13216:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13217"><span data-slate-leaf="true" data-offset-key="13217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13218"><span data-slate-leaf="true" data-offset-key="13218:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13219"><span data-slate-object="text" data-key="13220"><span data-slate-leaf="true" data-offset-key="13220:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13221"><span data-slate-object="text" data-key="13222"><span data-slate-leaf="true" data-offset-key="13222:0" data-first-offset="true"><span data-slate-string="true">我们只要在任何需要调度进程的地方，调用上述代码中的函数就可以了。下面我们开始实现 krlschedul 函数中的其它功能逻辑。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13223" id="sr-toc-8"><span data-slate-object="text" data-key="13224"><span data-slate-leaf="true" data-offset-key="13224:0" data-first-offset="true"><span data-slate-string="true">如何获取当前运行的进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13225"><span data-slate-object="text" data-key="13226"><span data-slate-leaf="true" data-offset-key="13226:0" data-first-offset="true"><span data-slate-string="true">获取当前正在运行的进程，目的是为了保存当前进程的运行上下文，确保在下一次调度到当前运行的进程时能够恢复运行。后面你就会看到，每次切换到下一个进程运行时，我们就会将下一个运行的进程设置为当前运行的进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13227"><span data-slate-object="text" data-key="13228"><span data-slate-leaf="true" data-offset-key="13228:0" data-first-offset="true"><span data-slate-string="true">这个获取当前运行进程的函数，它的代码是这样的。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13229"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13230"><span data-slate-object="text" data-key="13231"><span data-slate-leaf="true" data-offset-key="13231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="13232"><span data-slate-leaf="true" data-offset-key="13232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="13233"><span data-slate-leaf="true" data-offset-key="13233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_retn_currthread</span></span></span></span></span><span data-slate-object="text" data-key="13234"><span data-slate-leaf="true" data-offset-key="13234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13235"><span data-slate-object="text" data-key="13236"><span data-slate-leaf="true" data-offset-key="13236:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13237"><span data-slate-object="text" data-key="13238"><span data-slate-leaf="true" data-offset-key="13238:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13239"><span data-slate-leaf="true" data-offset-key="13239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="13240"><span data-slate-leaf="true" data-offset-key="13240:0" data-first-offset="true"><span data-slate-string="true"> cpuid = </span></span></span><span data-slate-object="text" data-key="13241"><span data-slate-leaf="true" data-offset-key="13241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="13242"><span data-slate-leaf="true" data-offset-key="13242:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13243"><span data-slate-object="text" data-key="13244"><span data-slate-leaf="true" data-offset-key="13244:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13245"><span data-slate-leaf="true" data-offset-key="13245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过 cpuid 获取当前 cpu 的调度数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13246"><span data-slate-object="text" data-key="13247"><span data-slate-leaf="true" data-offset-key="13247:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13248"><span data-slate-leaf="true" data-offset-key="13248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t</span></span></span></span><span data-slate-object="text" data-key="13249"><span data-slate-leaf="true" data-offset-key="13249:0" data-first-offset="true"><span data-slate-string="true"> *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13250"><span data-slate-object="text" data-key="13251"><span data-slate-leaf="true" data-offset-key="13251:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13252"><span data-slate-leaf="true" data-offset-key="13252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13253"><span data-slate-leaf="true" data-offset-key="13253:0" data-first-offset="true"><span data-slate-string="true"> (schdap-&gt;sda_currtd == </span></span></span><span data-slate-object="text" data-key="13254"><span data-slate-leaf="true" data-offset-key="13254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="13255"><span data-slate-leaf="true" data-offset-key="13255:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13256"><span data-slate-object="text" data-key="13257"><span data-slate-leaf="true" data-offset-key="13257:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="13258"><span data-slate-leaf="true" data-offset-key="13258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 若调度数据结构中当前运行进程的指针为空，就出错死机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13259"><span data-slate-object="text" data-key="13260"><span data-slate-leaf="true" data-offset-key="13260:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13261"><span data-slate-leaf="true" data-offset-key="13261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_sysdie</span></span></span></span><span data-slate-object="text" data-key="13262"><span data-slate-leaf="true" data-offset-key="13262:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13263"><span data-slate-leaf="true" data-offset-key="13263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"schdap-&gt;sda_currtd NULL"</span></span></span></span><span data-slate-object="text" data-key="13264"><span data-slate-leaf="true" data-offset-key="13264:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13265"><span data-slate-object="text" data-key="13266"><span data-slate-leaf="true" data-offset-key="13266:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13267"><span data-slate-object="text" data-key="13268"><span data-slate-leaf="true" data-offset-key="13268:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13269"><span data-slate-leaf="true" data-offset-key="13269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13270"><span data-slate-leaf="true" data-offset-key="13270:0" data-first-offset="true"><span data-slate-string="true"> schdap-&gt;sda_currtd;</span></span></span><span data-slate-object="text" data-key="13271"><span data-slate-leaf="true" data-offset-key="13271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回当前运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13272"><span data-slate-object="text" data-key="13273"><span data-slate-leaf="true" data-offset-key="13273:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13274"><span data-slate-object="text" data-key="13275"><span data-slate-leaf="true" data-offset-key="13275:0" data-first-offset="true"><span data-slate-string="true">上述代码非常简单，如果你认真了解过前面组织进程的数据结构，就会发现，schdata_t 结构中的 </span></span></span><span data-slate-object="text" data-key="13276"><span data-slate-leaf="true" data-offset-key="13276:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sda_currtd 字段</span></span></span></span><span data-slate-object="text" data-key="13277"><span data-slate-leaf="true" data-offset-key="13277:0" data-first-offset="true"><span data-slate-string="true">正是保存当前正在运行进程的地址。返回这个字段的值，就能取得当前正在运行的进程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13278" id="sr-toc-9"><span data-slate-object="text" data-key="13279"><span data-slate-leaf="true" data-offset-key="13279:0" data-first-offset="true"><span data-slate-string="true">选择下一个进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13280"><span data-slate-object="text" data-key="13281"><span data-slate-leaf="true" data-offset-key="13281:0" data-first-offset="true"><span data-slate-string="true">根据调度器入口函数的设计，取得了当前正在运行的进程之后，下一步就是选择下个将要投入运行的进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13282"><span data-slate-object="text" data-key="13283"><span data-slate-leaf="true" data-offset-key="13283:0" data-first-offset="true"><span data-slate-string="true">在商业系统中，这个过程极为复杂。因为这个过程是</span></span></span><span data-slate-object="text" data-key="13284"><span data-slate-leaf="true" data-offset-key="13284:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">进程调度算法的核心</span></span></span></span><span data-slate-object="text" data-key="13285"><span data-slate-leaf="true" data-offset-key="13285:0" data-first-offset="true"><span data-slate-string="true">，它关乎到进程的吞吐量，能否及时响应请求，CPU 的利用率，各个进程之间运行获取资源的公平性，这些问题综合起来就会影响整个操作系统的性能、可靠性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13286"><span data-slate-object="text" data-key="13287"><span data-slate-leaf="true" data-offset-key="13287:0" data-first-offset="true"><span data-slate-string="true">作为初学者，我们不必搞得如此复杂，可以使用一个简单的优先级调度算法，就是始终选择优先级最高的进程，作为下一个运行的进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13288"><span data-slate-object="text" data-key="13289"><span data-slate-leaf="true" data-offset-key="13289:0" data-first-offset="true"><span data-slate-string="true">完成这个功能的代码，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="13290"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13291"><span data-slate-object="text" data-key="13292"><span data-slate-leaf="true" data-offset-key="13292:0" data-first-offset="true"><span data-slate-string="true">thread_t *</span></span></span><span data-slate-object="text" data-key="13293"><span data-slate-leaf="true" data-offset-key="13293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_select_thread</span></span></span></span><span data-slate-object="text" data-key="13294"><span data-slate-leaf="true" data-offset-key="13294:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13295"><span data-slate-object="text" data-key="13296"><span data-slate-leaf="true" data-offset-key="13296:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13297"><span data-slate-object="text" data-key="13298"><span data-slate-leaf="true" data-offset-key="13298:0" data-first-offset="true"><span data-slate-string="true">    thread_t *retthd, *tdtmp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13299"><span data-slate-object="text" data-key="13300"><span data-slate-leaf="true" data-offset-key="13300:0" data-first-offset="true"><span data-slate-string="true">    cpuflg_t cufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13301"><span data-slate-object="text" data-key="13302"><span data-slate-leaf="true" data-offset-key="13302:0" data-first-offset="true"><span data-slate-string="true">    uint_t cpuid = </span></span></span><span data-slate-object="text" data-key="13303"><span data-slate-leaf="true" data-offset-key="13303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="13304"><span data-slate-leaf="true" data-offset-key="13304:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13305"><span data-slate-object="text" data-key="13306"><span data-slate-leaf="true" data-offset-key="13306:0" data-first-offset="true"><span data-slate-string="true">    schdata_t *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13307"><span data-slate-object="text" data-key="13308"><span data-slate-leaf="true" data-offset-key="13308:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13309"><span data-slate-leaf="true" data-offset-key="13309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="13310"><span data-slate-leaf="true" data-offset-key="13310:0" data-first-offset="true"><span data-slate-string="true">(&amp;schdap</span></span></span><span data-slate-object="text" data-key="13311"><span data-slate-leaf="true" data-offset-key="13311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13312"><span data-slate-leaf="true" data-offset-key="13312:0" data-first-offset="true"><span data-slate-string="true">sda_lock, &amp;cufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13313"><span data-slate-object="text" data-key="13314"><span data-slate-leaf="true" data-offset-key="13314:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13315"><span data-slate-leaf="true" data-offset-key="13315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="13316"><span data-slate-leaf="true" data-offset-key="13316:0" data-first-offset="true"><span data-slate-string="true"> (uint_t pity = </span></span></span><span data-slate-object="text" data-key="13317"><span data-slate-leaf="true" data-offset-key="13317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13318"><span data-slate-leaf="true" data-offset-key="13318:0" data-first-offset="true"><span data-slate-string="true">; pity &lt;PRITY_MAX; pity++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13319"><span data-slate-object="text" data-key="13320"><span data-slate-leaf="true" data-offset-key="13320:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="13321"><span data-slate-leaf="true" data-offset-key="13321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从最高优先级开始扫描</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13322"><span data-slate-object="text" data-key="13323"><span data-slate-leaf="true" data-offset-key="13323:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13324"><span data-slate-leaf="true" data-offset-key="13324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13325"><span data-slate-leaf="true" data-offset-key="13325:0" data-first-offset="true"><span data-slate-string="true"> (schdap</span></span></span><span data-slate-object="text" data-key="13326"><span data-slate-leaf="true" data-offset-key="13326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13327"><span data-slate-leaf="true" data-offset-key="13327:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_nr &gt; </span></span></span><span data-slate-object="text" data-key="13328"><span data-slate-leaf="true" data-offset-key="13328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13329"><span data-slate-leaf="true" data-offset-key="13329:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13330"><span data-slate-object="text" data-key="13331"><span data-slate-leaf="true" data-offset-key="13331:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span><span data-slate-object="text" data-key="13332"><span data-slate-leaf="true" data-offset-key="13332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 若当前优先级的进程链表不为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13333"><span data-slate-object="text" data-key="13334"><span data-slate-leaf="true" data-offset-key="13334:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13335"><span data-slate-leaf="true" data-offset-key="13335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13336"><span data-slate-leaf="true" data-offset-key="13336:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="13337"><span data-slate-leaf="true" data-offset-key="13337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_is_empty_careful</span></span></span></span><span data-slate-object="text" data-key="13338"><span data-slate-leaf="true" data-offset-key="13338:0" data-first-offset="true"><span data-slate-string="true">(&amp;(schdap</span></span></span><span data-slate-object="text" data-key="13339"><span data-slate-leaf="true" data-offset-key="13339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13340"><span data-slate-leaf="true" data-offset-key="13340:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_lsth)) == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13341"><span data-slate-object="text" data-key="13342"><span data-slate-leaf="true" data-offset-key="13342:0" data-first-offset="true"><span data-slate-string="true">            {</span></span></span><span data-slate-object="text" data-key="13343"><span data-slate-leaf="true" data-offset-key="13343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取出当前优先级进程链表下的第一个进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13344"><span data-slate-object="text" data-key="13345"><span data-slate-leaf="true" data-offset-key="13345:0" data-first-offset="true"><span data-slate-string="true">                tdtmp = </span></span></span><span data-slate-object="text" data-key="13346"><span data-slate-leaf="true" data-offset-key="13346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_entry</span></span></span></span><span data-slate-object="text" data-key="13347"><span data-slate-leaf="true" data-offset-key="13347:0" data-first-offset="true"><span data-slate-string="true">(schdap</span></span></span><span data-slate-object="text" data-key="13348"><span data-slate-leaf="true" data-offset-key="13348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13349"><span data-slate-leaf="true" data-offset-key="13349:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_lsth.next, thread_t, td_list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13350"><span data-slate-object="text" data-key="13351"><span data-slate-leaf="true" data-offset-key="13351:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="13352"><span data-slate-leaf="true" data-offset-key="13352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_del</span></span></span></span><span data-slate-object="text" data-key="13353"><span data-slate-leaf="true" data-offset-key="13353:0" data-first-offset="true"><span data-slate-string="true">(&amp;tdtmp</span></span></span><span data-slate-object="text" data-key="13354"><span data-slate-leaf="true" data-offset-key="13354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13355"><span data-slate-leaf="true" data-offset-key="13355:0" data-first-offset="true"><span data-slate-string="true">td_list);</span></span></span><span data-slate-object="text" data-key="13356"><span data-slate-leaf="true" data-offset-key="13356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 脱链</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13357"><span data-slate-object="text" data-key="13358"><span data-slate-leaf="true" data-offset-key="13358:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="13359"><span data-slate-leaf="true" data-offset-key="13359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13360"><span data-slate-leaf="true" data-offset-key="13360:0" data-first-offset="true"><span data-slate-string="true"> (schdap</span></span></span><span data-slate-object="text" data-key="13361"><span data-slate-leaf="true" data-offset-key="13361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13362"><span data-slate-leaf="true" data-offset-key="13362:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd != NULL)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13363"><span data-slate-object="text" data-key="13364"><span data-slate-leaf="true" data-offset-key="13364:0" data-first-offset="true"><span data-slate-string="true">                {</span></span></span><span data-slate-object="text" data-key="13365"><span data-slate-leaf="true" data-offset-key="13365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将这 sda_thdlst [pity].tdl_curruntd 的进程挂入链表尾</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13366"><span data-slate-object="text" data-key="13367"><span data-slate-leaf="true" data-offset-key="13367:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="13368"><span data-slate-leaf="true" data-offset-key="13368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add_tail</span></span></span></span><span data-slate-object="text" data-key="13369"><span data-slate-leaf="true" data-offset-key="13369:0" data-first-offset="true"><span data-slate-string="true">(&amp;(schdap</span></span></span><span data-slate-object="text" data-key="13370"><span data-slate-leaf="true" data-offset-key="13370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13371"><span data-slate-leaf="true" data-offset-key="13371:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd</span></span></span><span data-slate-object="text" data-key="13372"><span data-slate-leaf="true" data-offset-key="13372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13373"><span data-slate-leaf="true" data-offset-key="13373:0" data-first-offset="true"><span data-slate-string="true">td_list), &amp;schdap</span></span></span><span data-slate-object="text" data-key="13374"><span data-slate-leaf="true" data-offset-key="13374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13375"><span data-slate-leaf="true" data-offset-key="13375:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_lsth);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13376"><span data-slate-object="text" data-key="13377"><span data-slate-leaf="true" data-offset-key="13377:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13378"><span data-slate-object="text" data-key="13379"><span data-slate-leaf="true" data-offset-key="13379:0" data-first-offset="true"><span data-slate-string="true">                schdap</span></span></span><span data-slate-object="text" data-key="13380"><span data-slate-leaf="true" data-offset-key="13380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13381"><span data-slate-leaf="true" data-offset-key="13381:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd = tdtmp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13382"><span data-slate-object="text" data-key="13383"><span data-slate-leaf="true" data-offset-key="13383:0" data-first-offset="true"><span data-slate-string="true">                retthd = tdtmp;</span></span></span><span data-slate-object="text" data-key="13384"><span data-slate-leaf="true" data-offset-key="13384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将选择的进程放入 sda_thdlst [pity].tdl_curruntd 中，并返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13385"><span data-slate-object="text" data-key="13386"><span data-slate-leaf="true" data-offset-key="13386:0" data-first-offset="true"><span data-slate-string="true">                goto return_step;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13387"><span data-slate-object="text" data-key="13388"><span data-slate-leaf="true" data-offset-key="13388:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13389"><span data-slate-object="text" data-key="13390"><span data-slate-leaf="true" data-offset-key="13390:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13391"><span data-slate-leaf="true" data-offset-key="13391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13392"><span data-slate-leaf="true" data-offset-key="13392:0" data-first-offset="true"><span data-slate-string="true"> (schdap</span></span></span><span data-slate-object="text" data-key="13393"><span data-slate-leaf="true" data-offset-key="13393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13394"><span data-slate-leaf="true" data-offset-key="13394:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd != NULL)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13395"><span data-slate-object="text" data-key="13396"><span data-slate-leaf="true" data-offset-key="13396:0" data-first-offset="true"><span data-slate-string="true">            {</span></span></span><span data-slate-object="text" data-key="13397"><span data-slate-leaf="true" data-offset-key="13397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 若 sda_thdlst [pity].tdl_curruntd 不为空就直接返回它</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13398"><span data-slate-object="text" data-key="13399"><span data-slate-leaf="true" data-offset-key="13399:0" data-first-offset="true"><span data-slate-string="true">                retthd = schdap</span></span></span><span data-slate-object="text" data-key="13400"><span data-slate-leaf="true" data-offset-key="13400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13401"><span data-slate-leaf="true" data-offset-key="13401:0" data-first-offset="true"><span data-slate-string="true">sda_thdlst[pity].tdl_curruntd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13402"><span data-slate-object="text" data-key="13403"><span data-slate-leaf="true" data-offset-key="13403:0" data-first-offset="true"><span data-slate-string="true">                goto return_step;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13404"><span data-slate-object="text" data-key="13405"><span data-slate-leaf="true" data-offset-key="13405:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13406"><span data-slate-object="text" data-key="13407"><span data-slate-leaf="true" data-offset-key="13407:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13408"><span data-slate-object="text" data-key="13409"><span data-slate-leaf="true" data-offset-key="13409:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13410"><span data-slate-object="text" data-key="13411"><span data-slate-leaf="true" data-offset-key="13411:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13412"><span data-slate-leaf="true" data-offset-key="13412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果最后也没有找到进程就返回默认的空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13413"><span data-slate-object="text" data-key="13414"><span data-slate-leaf="true" data-offset-key="13414:0" data-first-offset="true"><span data-slate-string="true">    schdap</span></span></span><span data-slate-object="text" data-key="13415"><span data-slate-leaf="true" data-offset-key="13415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13416"><span data-slate-leaf="true" data-offset-key="13416:0" data-first-offset="true"><span data-slate-string="true">sda_prityidx = PRITY_MIN;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13417"><span data-slate-object="text" data-key="13418"><span data-slate-leaf="true" data-offset-key="13418:0" data-first-offset="true"><span data-slate-string="true">    retthd = </span></span></span><span data-slate-object="text" data-key="13419"><span data-slate-leaf="true" data-offset-key="13419:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_retn_idlethread</span></span></span></span><span data-slate-object="text" data-key="13420"><span data-slate-leaf="true" data-offset-key="13420:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13421"><span data-slate-object="text" data-key="13422"><span data-slate-leaf="true" data-offset-key="13422:0" data-first-offset="true"><span data-slate-string="true">return_step:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13423"><span data-slate-object="text" data-key="13424"><span data-slate-leaf="true" data-offset-key="13424:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13425"><span data-slate-leaf="true" data-offset-key="13425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁并返回进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13426"><span data-slate-object="text" data-key="13427"><span data-slate-leaf="true" data-offset-key="13427:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13428"><span data-slate-leaf="true" data-offset-key="13428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="13429"><span data-slate-leaf="true" data-offset-key="13429:0" data-first-offset="true"><span data-slate-string="true">(&amp;schdap</span></span></span><span data-slate-object="text" data-key="13430"><span data-slate-leaf="true" data-offset-key="13430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13431"><span data-slate-leaf="true" data-offset-key="13431:0" data-first-offset="true"><span data-slate-string="true">sda_lock, &amp;cufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13432"><span data-slate-object="text" data-key="13433"><span data-slate-leaf="true" data-offset-key="13433:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13434"><span data-slate-leaf="true" data-offset-key="13434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13435"><span data-slate-leaf="true" data-offset-key="13435:0" data-first-offset="true"><span data-slate-string="true"> retthd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13436"><span data-slate-object="text" data-key="13437"><span data-slate-leaf="true" data-offset-key="13437:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13438"><span data-slate-object="text" data-key="13439"><span data-slate-leaf="true" data-offset-key="13439:0" data-first-offset="true"><span data-slate-string="true">上述代码的逻辑非常简单，我来给你梳理一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13440"><span data-slate-object="text" data-key="13441"><span data-slate-leaf="true" data-offset-key="13441:0" data-first-offset="true"><span data-slate-string="true">首先，从高到低扫描优先级进程链表，然后若当前优先级进程链表不为空，就取出该链表上的第一个进程，放入 thrdlst_t 结构中的 tdl_curruntd 字段中，并把之前 thrdlst_t 结构的 tdl_curruntd 字段中的进程挂入该链表的尾部，并返回。最后，当扫描到最低优先级时也没有找到进程，就返回默认的空转进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13442"><span data-slate-object="text" data-key="13443"><span data-slate-leaf="true" data-offset-key="13443:0" data-first-offset="true"><span data-slate-string="true">这个算法极其简单，但是对我们学习原理却足够了，也欢迎你举一反三，动手实现更高级的调度算法。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13444" id="sr-toc-10"><span data-slate-object="text" data-key="13445"><span data-slate-leaf="true" data-offset-key="13445:0" data-first-offset="true"><span data-slate-string="true">获取空转进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13446"><span data-slate-object="text" data-key="13447"><span data-slate-leaf="true" data-offset-key="13447:0" data-first-offset="true"><span data-slate-string="true">在选择下一个进程的函数中，如果没有找到合适的进程，就返回默认的空转进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13448"><span data-slate-object="text" data-key="13449"><span data-slate-leaf="true" data-offset-key="13449:0" data-first-offset="true"><span data-slate-string="true">你可以想一下，为什么要有一个空转进程，直接返回 NULL 不行吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13450"><span data-slate-object="text" data-key="13451"><span data-slate-leaf="true" data-offset-key="13451:0" data-first-offset="true"><span data-slate-string="true">还真不行，因为调度器的功能必须完成从一个进程到下一个进程的切换，如果没有下一个进程，而上一个进程又不能运行了，调度器将无处可去，整个系统也将停止运行，这当然不是我们要的结果，所以我们要给系统留下最后一条路。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13452"><span data-slate-object="text" data-key="13453"><span data-slate-leaf="true" data-offset-key="13453:0" data-first-offset="true"><span data-slate-string="true">下面我们先来实现获取空转进程的函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13454"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13455"><span data-slate-object="text" data-key="13456"><span data-slate-leaf="true" data-offset-key="13456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span><span data-slate-object="text" data-key="13457"><span data-slate-leaf="true" data-offset-key="13457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="13458"><span data-slate-leaf="true" data-offset-key="13458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_retn_idlethread</span></span></span></span></span><span data-slate-object="text" data-key="13459"><span data-slate-leaf="true" data-offset-key="13459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13460"><span data-slate-object="text" data-key="13461"><span data-slate-leaf="true" data-offset-key="13461:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13462"><span data-slate-object="text" data-key="13463"><span data-slate-leaf="true" data-offset-key="13463:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13464"><span data-slate-leaf="true" data-offset-key="13464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="13465"><span data-slate-leaf="true" data-offset-key="13465:0" data-first-offset="true"><span data-slate-string="true"> cpuid = </span></span></span><span data-slate-object="text" data-key="13466"><span data-slate-leaf="true" data-offset-key="13466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="13467"><span data-slate-leaf="true" data-offset-key="13467:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13468"><span data-slate-object="text" data-key="13469"><span data-slate-leaf="true" data-offset-key="13469:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13470"><span data-slate-leaf="true" data-offset-key="13470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过 cpuid 获取当前 cpu 的调度数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13471"><span data-slate-object="text" data-key="13472"><span data-slate-leaf="true" data-offset-key="13472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13473"><span data-slate-leaf="true" data-offset-key="13473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schdata_t</span></span></span></span><span data-slate-object="text" data-key="13474"><span data-slate-leaf="true" data-offset-key="13474:0" data-first-offset="true"><span data-slate-string="true"> *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13475"><span data-slate-object="text" data-key="13476"><span data-slate-leaf="true" data-offset-key="13476:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13477"><span data-slate-leaf="true" data-offset-key="13477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13478"><span data-slate-leaf="true" data-offset-key="13478:0" data-first-offset="true"><span data-slate-string="true"> (schdap-&gt;sda_cpuidle == </span></span></span><span data-slate-object="text" data-key="13479"><span data-slate-leaf="true" data-offset-key="13479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="13480"><span data-slate-leaf="true" data-offset-key="13480:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13481"><span data-slate-object="text" data-key="13482"><span data-slate-leaf="true" data-offset-key="13482:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="13483"><span data-slate-leaf="true" data-offset-key="13483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 若调度数据结构中空转进程的指针为空，就出错死机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13484"><span data-slate-object="text" data-key="13485"><span data-slate-leaf="true" data-offset-key="13485:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13486"><span data-slate-leaf="true" data-offset-key="13486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_sysdie</span></span></span></span><span data-slate-object="text" data-key="13487"><span data-slate-leaf="true" data-offset-key="13487:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13488"><span data-slate-leaf="true" data-offset-key="13488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"schdap-&gt;sda_cpuidle NULL"</span></span></span></span><span data-slate-object="text" data-key="13489"><span data-slate-leaf="true" data-offset-key="13489:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13490"><span data-slate-object="text" data-key="13491"><span data-slate-leaf="true" data-offset-key="13491:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13492"><span data-slate-object="text" data-key="13493"><span data-slate-leaf="true" data-offset-key="13493:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13494"><span data-slate-leaf="true" data-offset-key="13494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13495"><span data-slate-leaf="true" data-offset-key="13495:0" data-first-offset="true"><span data-slate-string="true"> schdap-&gt;sda_cpuidle;</span></span></span><span data-slate-object="text" data-key="13496"><span data-slate-leaf="true" data-offset-key="13496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回空转进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13497"><span data-slate-object="text" data-key="13498"><span data-slate-leaf="true" data-offset-key="13498:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13499"><span data-slate-object="text" data-key="13500"><span data-slate-leaf="true" data-offset-key="13500:0" data-first-offset="true"><span data-slate-string="true">上述代码非常简单，和我们之前实现的获取当前运行进程的函数如出一辙，只是使用 schdata_t 结构中的字段发生了改变。好，接下来我们要处理更重要的问题，那就是进程之间的切换。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13501" id="sr-toc-11"><span data-slate-object="text" data-key="13502"><span data-slate-leaf="true" data-offset-key="13502:0" data-first-offset="true"><span data-slate-string="true">进程切换</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13503"><span data-slate-object="text" data-key="13504"><span data-slate-leaf="true" data-offset-key="13504:0" data-first-offset="true"><span data-slate-string="true">经过前面的流程，我们已经找到了当前运行的进程 P1，和下一个将要运行的进程 P2，现在就进入最重要的进程切换流程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13505"><span data-slate-object="text" data-key="13506"><span data-slate-leaf="true" data-offset-key="13506:0" data-first-offset="true"><span data-slate-string="true">在进程切换前，我们还要了解另一个重要的问题：</span></span></span><span data-slate-object="text" data-key="13507"><span data-slate-leaf="true" data-offset-key="13507:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">进程在内核中函数调用路径，那什么是函数调用路径。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13508"><span data-slate-object="text" data-key="13509"><span data-slate-leaf="true" data-offset-key="13509:0" data-first-offset="true"><span data-slate-string="true">举个例子，比如进程 P1 调用了函数 A，接着在函数 A 中调用函数 B，然后在函数 B 中调用了函数 C，最后在函数 C 中调用了调度器函数 S，这个函数 A 到函数 S 就是进程 P1 的函数调用路径。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13510"><span data-slate-object="text" data-key="13511"><span data-slate-leaf="true" data-offset-key="13511:0" data-first-offset="true"><span data-slate-string="true">再比如，进程 P2 开始调用了函数 D，接着在函数 D 中调用函数 E，然后在函数 E 中又调用了函数 F，最后在函数 F 中调用了调度器函数 S，函数 D、E、F 到函数 S 就是进程 P2 的函数调用路径。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13512"><span data-slate-object="text" data-key="13513"><span data-slate-leaf="true" data-offset-key="13513:0" data-first-offset="true"><span data-slate-string="true">函数调用路径是通过栈来保存的，对于运行在内核空间中的进程，就是保存在对应的内核栈中。我为你准备了一幅图帮助理解。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13514"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/28/d0/283efe1570a388902ae842acyyb299d0.jpg?wh=4070x2140"></div><div>内核栈状态</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13515"><span data-slate-object="text" data-key="13516"><span data-slate-leaf="true" data-offset-key="13516:0" data-first-offset="true"><span data-slate-string="true">以上就是进程 P1，P2 的函数调用路径，也是它们调用函数时各自内核栈空间状态的变化结果。说个题外话，你有没有发现。C 语言栈才是最高效内存管理，而且变量的生命周期也是妥妥的，比很多高级语言的内存垃圾回收器都牛。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13517"><span data-slate-object="text" data-key="13518"><span data-slate-leaf="true" data-offset-key="13518:0" data-first-offset="true"><span data-slate-string="true">有了前面的基础，现在我们来动手实现进程切换的函数。在这个函数中，我们要干这几件事。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13519"><span data-slate-object="text" data-key="13520"><span data-slate-leaf="true" data-offset-key="13520:0" data-first-offset="true"><span data-slate-string="true">首先，我们把当前进程的通用寄存器保存到当前进程的内核栈中；然后，保存 CPU 的 RSP 寄存器到当前进程的机器上下文结构中，并且读取保存在下一个进程机器上下文结构中的 RSP 的值，把它存到 CPU 的 RSP 寄存器中；接着，调用一个函数切换 MMU 页表；最后，从下一个进程的内核栈中恢复下一个进程的通用寄存器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13521"><span data-slate-object="text" data-key="13522"><span data-slate-leaf="true" data-offset-key="13522:0" data-first-offset="true"><span data-slate-string="true">这样下一个进程就开始运行了，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13523"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13524"><span data-slate-object="text" data-key="13525"><span data-slate-leaf="true" data-offset-key="13525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="13526"><span data-slate-leaf="true" data-offset-key="13526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13527"><span data-slate-leaf="true" data-offset-key="13527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">save_to_new_context</span></span></span></span></span><span data-slate-object="text" data-key="13528"><span data-slate-leaf="true" data-offset-key="13528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="13529"><span data-slate-leaf="true" data-offset-key="13529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span></span><span data-slate-object="text" data-key="13530"><span data-slate-leaf="true" data-offset-key="13530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *next, </span></span></span></span></span><span data-slate-object="text" data-key="13531"><span data-slate-leaf="true" data-offset-key="13531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t</span></span></span></span></span></span><span data-slate-object="text" data-key="13532"><span data-slate-leaf="true" data-offset-key="13532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *prev)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13533"><span data-slate-object="text" data-key="13534"><span data-slate-leaf="true" data-offset-key="13534:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13535"><span data-slate-object="text" data-key="13536"><span data-slate-leaf="true" data-offset-key="13536:0" data-first-offset="true"><span data-slate-string="true">    __asm__ __volatile__(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13537"><span data-slate-object="text" data-key="13538"><span data-slate-leaf="true" data-offset-key="13538:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13539"><span data-slate-leaf="true" data-offset-key="13539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushfq \n\t"</span></span></span></span><span data-slate-object="text" data-key="13540"><span data-slate-leaf="true" data-offset-key="13540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存当前进程的标志寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13541"><span data-slate-object="text" data-key="13542"><span data-slate-leaf="true" data-offset-key="13542:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13543"><span data-slate-leaf="true" data-offset-key="13543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cli \n\t"</span></span></span></span><span data-slate-object="text" data-key="13544"><span data-slate-leaf="true" data-offset-key="13544:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13545"><span data-slate-leaf="true" data-offset-key="13545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13546"><span data-slate-object="text" data-key="13547"><span data-slate-leaf="true" data-offset-key="13547:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13548"><span data-slate-leaf="true" data-offset-key="13548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存当前进程的通用寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13549"><span data-slate-object="text" data-key="13550"><span data-slate-leaf="true" data-offset-key="13550:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13551"><span data-slate-leaf="true" data-offset-key="13551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rax\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13552"><span data-slate-object="text" data-key="13553"><span data-slate-leaf="true" data-offset-key="13553:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13554"><span data-slate-leaf="true" data-offset-key="13554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rbx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13555"><span data-slate-object="text" data-key="13556"><span data-slate-leaf="true" data-offset-key="13556:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13557"><span data-slate-leaf="true" data-offset-key="13557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rcx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13558"><span data-slate-object="text" data-key="13559"><span data-slate-leaf="true" data-offset-key="13559:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13560"><span data-slate-leaf="true" data-offset-key="13560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rdx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13561"><span data-slate-object="text" data-key="13562"><span data-slate-leaf="true" data-offset-key="13562:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13563"><span data-slate-leaf="true" data-offset-key="13563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rbp\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13564"><span data-slate-object="text" data-key="13565"><span data-slate-leaf="true" data-offset-key="13565:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13566"><span data-slate-leaf="true" data-offset-key="13566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rsi\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13567"><span data-slate-object="text" data-key="13568"><span data-slate-leaf="true" data-offset-key="13568:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13569"><span data-slate-leaf="true" data-offset-key="13569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%rdi\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13570"><span data-slate-object="text" data-key="13571"><span data-slate-leaf="true" data-offset-key="13571:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13572"><span data-slate-leaf="true" data-offset-key="13572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r8\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13573"><span data-slate-object="text" data-key="13574"><span data-slate-leaf="true" data-offset-key="13574:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13575"><span data-slate-leaf="true" data-offset-key="13575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r9\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13576"><span data-slate-object="text" data-key="13577"><span data-slate-leaf="true" data-offset-key="13577:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13578"><span data-slate-leaf="true" data-offset-key="13578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r10\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13579"><span data-slate-object="text" data-key="13580"><span data-slate-leaf="true" data-offset-key="13580:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13581"><span data-slate-leaf="true" data-offset-key="13581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r11\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13582"><span data-slate-object="text" data-key="13583"><span data-slate-leaf="true" data-offset-key="13583:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13584"><span data-slate-leaf="true" data-offset-key="13584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r12\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13585"><span data-slate-object="text" data-key="13586"><span data-slate-leaf="true" data-offset-key="13586:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13587"><span data-slate-leaf="true" data-offset-key="13587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r13\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13588"><span data-slate-object="text" data-key="13589"><span data-slate-leaf="true" data-offset-key="13589:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13590"><span data-slate-leaf="true" data-offset-key="13590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13591"><span data-slate-object="text" data-key="13592"><span data-slate-leaf="true" data-offset-key="13592:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13593"><span data-slate-leaf="true" data-offset-key="13593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushq %%r15\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13594"><span data-slate-object="text" data-key="13595"><span data-slate-leaf="true" data-offset-key="13595:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13596"><span data-slate-leaf="true" data-offset-key="13596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存 CPU 的 RSP 寄存器到当前进程的机器上下文结构中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13597"><span data-slate-object="text" data-key="13598"><span data-slate-leaf="true" data-offset-key="13598:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13599"><span data-slate-leaf="true" data-offset-key="13599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %%rsp,%[PREV_RSP] \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13600"><span data-slate-object="text" data-key="13601"><span data-slate-leaf="true" data-offset-key="13601:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13602"><span data-slate-leaf="true" data-offset-key="13602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把下一个进程的机器上下文结构中的 RSP 的值，写入 CPU 的 RSP 寄存器中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13603"><span data-slate-object="text" data-key="13604"><span data-slate-leaf="true" data-offset-key="13604:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13605"><span data-slate-leaf="true" data-offset-key="13605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[NEXT_RSP],%%rsp \n\t"</span></span></span></span><span data-slate-object="text" data-key="13606"><span data-slate-leaf="true" data-offset-key="13606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 事实上这里已经切换到下一个进程了，因为切换进程的内核栈    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13607"><span data-slate-object="text" data-key="13608"><span data-slate-leaf="true" data-offset-key="13608:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13609"><span data-slate-leaf="true" data-offset-key="13609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用__to_new_context 函数切换 MMU 页表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13610"><span data-slate-object="text" data-key="13611"><span data-slate-leaf="true" data-offset-key="13611:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13612"><span data-slate-leaf="true" data-offset-key="13612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"callq __to_new_context\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13613"><span data-slate-object="text" data-key="13614"><span data-slate-leaf="true" data-offset-key="13614:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13615"><span data-slate-leaf="true" data-offset-key="13615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 恢复下一个进程的通用寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13616"><span data-slate-object="text" data-key="13617"><span data-slate-leaf="true" data-offset-key="13617:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13618"><span data-slate-leaf="true" data-offset-key="13618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r15\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13619"><span data-slate-object="text" data-key="13620"><span data-slate-leaf="true" data-offset-key="13620:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13621"><span data-slate-leaf="true" data-offset-key="13621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13622"><span data-slate-object="text" data-key="13623"><span data-slate-leaf="true" data-offset-key="13623:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13624"><span data-slate-leaf="true" data-offset-key="13624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r13\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13625"><span data-slate-object="text" data-key="13626"><span data-slate-leaf="true" data-offset-key="13626:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13627"><span data-slate-leaf="true" data-offset-key="13627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r12\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13628"><span data-slate-object="text" data-key="13629"><span data-slate-leaf="true" data-offset-key="13629:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13630"><span data-slate-leaf="true" data-offset-key="13630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r11\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13631"><span data-slate-object="text" data-key="13632"><span data-slate-leaf="true" data-offset-key="13632:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13633"><span data-slate-leaf="true" data-offset-key="13633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r10\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13634"><span data-slate-object="text" data-key="13635"><span data-slate-leaf="true" data-offset-key="13635:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13636"><span data-slate-leaf="true" data-offset-key="13636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r9\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13637"><span data-slate-object="text" data-key="13638"><span data-slate-leaf="true" data-offset-key="13638:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13639"><span data-slate-leaf="true" data-offset-key="13639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r8\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13640"><span data-slate-object="text" data-key="13641"><span data-slate-leaf="true" data-offset-key="13641:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13642"><span data-slate-leaf="true" data-offset-key="13642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rdi\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13643"><span data-slate-object="text" data-key="13644"><span data-slate-leaf="true" data-offset-key="13644:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13645"><span data-slate-leaf="true" data-offset-key="13645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rsi\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13646"><span data-slate-object="text" data-key="13647"><span data-slate-leaf="true" data-offset-key="13647:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13648"><span data-slate-leaf="true" data-offset-key="13648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rbp\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13649"><span data-slate-object="text" data-key="13650"><span data-slate-leaf="true" data-offset-key="13650:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13651"><span data-slate-leaf="true" data-offset-key="13651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rdx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13652"><span data-slate-object="text" data-key="13653"><span data-slate-leaf="true" data-offset-key="13653:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13654"><span data-slate-leaf="true" data-offset-key="13654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rcx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13655"><span data-slate-object="text" data-key="13656"><span data-slate-leaf="true" data-offset-key="13656:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13657"><span data-slate-leaf="true" data-offset-key="13657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rbx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13658"><span data-slate-object="text" data-key="13659"><span data-slate-leaf="true" data-offset-key="13659:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13660"><span data-slate-leaf="true" data-offset-key="13660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rax\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13661"><span data-slate-object="text" data-key="13662"><span data-slate-leaf="true" data-offset-key="13662:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13663"><span data-slate-leaf="true" data-offset-key="13663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popfq \n\t"</span></span></span></span><span data-slate-object="text" data-key="13664"><span data-slate-leaf="true" data-offset-key="13664:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13665"><span data-slate-leaf="true" data-offset-key="13665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 恢复下一个进程的标志寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13666"><span data-slate-object="text" data-key="13667"><span data-slate-leaf="true" data-offset-key="13667:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13668"><span data-slate-leaf="true" data-offset-key="13668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 输出当前进程的内核栈地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13669"><span data-slate-object="text" data-key="13670"><span data-slate-leaf="true" data-offset-key="13670:0" data-first-offset="true"><span data-slate-string="true">        : [PREV_RSP] </span></span></span><span data-slate-object="text" data-key="13671"><span data-slate-leaf="true" data-offset-key="13671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=m"</span></span></span></span><span data-slate-object="text" data-key="13672"><span data-slate-leaf="true" data-offset-key="13672:0" data-first-offset="true"><span data-slate-string="true">(prev-&gt;td_context.ctx_nextrsp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13673"><span data-slate-object="text" data-key="13674"><span data-slate-leaf="true" data-offset-key="13674:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13675"><span data-slate-leaf="true" data-offset-key="13675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读取下一个进程的内核栈地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13676"><span data-slate-object="text" data-key="13677"><span data-slate-leaf="true" data-offset-key="13677:0" data-first-offset="true"><span data-slate-string="true">        : [NEXT_RSP] </span></span></span><span data-slate-object="text" data-key="13678"><span data-slate-leaf="true" data-offset-key="13678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"m"</span></span></span></span><span data-slate-object="text" data-key="13679"><span data-slate-leaf="true" data-offset-key="13679:0" data-first-offset="true"><span data-slate-string="true">(next-&gt;td_context.ctx_nextrsp), </span></span></span><span data-slate-object="text" data-key="13680"><span data-slate-leaf="true" data-offset-key="13680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"D"</span></span></span></span><span data-slate-object="text" data-key="13681"><span data-slate-leaf="true" data-offset-key="13681:0" data-first-offset="true"><span data-slate-string="true">(next), </span></span></span><span data-slate-object="text" data-key="13682"><span data-slate-leaf="true" data-offset-key="13682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"S"</span></span></span></span><span data-slate-object="text" data-key="13683"><span data-slate-leaf="true" data-offset-key="13683:0" data-first-offset="true"><span data-slate-string="true">(prev)</span></span></span><span data-slate-object="text" data-key="13684"><span data-slate-leaf="true" data-offset-key="13684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为调用__to_new_context 函数传递参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13685"><span data-slate-object="text" data-key="13686"><span data-slate-leaf="true" data-offset-key="13686:0" data-first-offset="true"><span data-slate-string="true">        : </span></span></span><span data-slate-object="text" data-key="13687"><span data-slate-leaf="true" data-offset-key="13687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="13688"><span data-slate-leaf="true" data-offset-key="13688:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13689"><span data-slate-object="text" data-key="13690"><span data-slate-leaf="true" data-offset-key="13690:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13691"><span data-slate-leaf="true" data-offset-key="13691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13692"><span data-slate-leaf="true" data-offset-key="13692:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13693"><span data-slate-object="text" data-key="13694"><span data-slate-leaf="true" data-offset-key="13694:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13695"><span data-slate-object="text" data-key="13696"><span data-slate-leaf="true" data-offset-key="13696:0" data-first-offset="true"><span data-slate-string="true">你看，代码中的 save_to_new_context 函数，是不是有点偷天换日的感觉？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13697"><span data-slate-object="text" data-key="13698"><span data-slate-leaf="true" data-offset-key="13698:0" data-first-offset="true"><span data-slate-string="true">通过切换进程的内核栈，导致切换进程，因为进程的函数调用路径就保存在对应的内核栈中，只要调用 krlschedul 函数，最后的函数调用路径一定会停在 save_to_new_context 函数中，当 save_to_new_context 函数一返回，就会导致回到调用 save_to_new_context 函数的下一行代码开始运行，在这里就是返回到 krlschedul 函数中，最后层层返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13699"><span data-slate-object="text" data-key="13700"><span data-slate-leaf="true" data-offset-key="13700:0" data-first-offset="true"><span data-slate-string="true">我知道你很难理解这一过程，所以准备了一幅图辅助说明。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13701"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/24/c4/2414600d584323034cbd383c756yybc4.jpg?wh=7865x3253"></div><div>进程切换示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13702"><span data-slate-object="text" data-key="13703"><span data-slate-leaf="true" data-offset-key="13703:0" data-first-offset="true"><span data-slate-string="true">结合上图，你就能理解这个进程切换的原理了。同时你也会发现一个问题，就是这个切换机制能够正常运行，必须保证下一个进程已经被调度过，也就是</span></span></span><span data-slate-object="text" data-key="13704"><span data-slate-leaf="true" data-offset-key="13704:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">它调用执行过 krlschedul 函数。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13705"><span data-slate-object="text" data-key="13706"><span data-slate-leaf="true" data-offset-key="13706:0" data-first-offset="true"><span data-slate-string="true">那么已知新建进程绝对没有调用过 krlschedul 函数，所以它得进行特殊处理。我们在 __to_new_context 函数中完成这个特殊处理，代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="13707"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13708"><span data-slate-object="text" data-key="13709"><span data-slate-leaf="true" data-offset-key="13709:0" data-first-offset="true"><span data-slate-string="true">void __to_new_context(thread_t *next, thread_t *prev)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13710"><span data-slate-object="text" data-key="13711"><span data-slate-leaf="true" data-offset-key="13711:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13712"><span data-slate-object="text" data-key="13713"><span data-slate-leaf="true" data-offset-key="13713:0" data-first-offset="true"><span data-slate-string="true">    uint_t cpuid = </span></span></span><span data-slate-object="text" data-key="13714"><span data-slate-leaf="true" data-offset-key="13714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_cpuid</span></span></span></span><span data-slate-object="text" data-key="13715"><span data-slate-leaf="true" data-offset-key="13715:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13716"><span data-slate-object="text" data-key="13717"><span data-slate-leaf="true" data-offset-key="13717:0" data-first-offset="true"><span data-slate-string="true">    schdata_t *schdap = &amp;osschedcls.scls_schda[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13718"><span data-slate-object="text" data-key="13719"><span data-slate-leaf="true" data-offset-key="13719:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13720"><span data-slate-leaf="true" data-offset-key="13720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置当前运行进程为下一个运行的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13721"><span data-slate-object="text" data-key="13722"><span data-slate-leaf="true" data-offset-key="13722:0" data-first-offset="true"><span data-slate-string="true">    schdap</span></span></span><span data-slate-object="text" data-key="13723"><span data-slate-leaf="true" data-offset-key="13723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13724"><span data-slate-leaf="true" data-offset-key="13724:0" data-first-offset="true"><span data-slate-string="true">sda_currtd = next;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13725"><span data-slate-object="text" data-key="13726"><span data-slate-leaf="true" data-offset-key="13726:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13727"><span data-slate-leaf="true" data-offset-key="13727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置下一个运行进程的 tss 为当前 CPU 的 tss</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13728"><span data-slate-object="text" data-key="13729"><span data-slate-leaf="true" data-offset-key="13729:0" data-first-offset="true"><span data-slate-string="true">    next</span></span></span><span data-slate-object="text" data-key="13730"><span data-slate-leaf="true" data-offset-key="13730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13731"><span data-slate-leaf="true" data-offset-key="13731:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nexttss = &amp;x64tss[cpuid];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13732"><span data-slate-object="text" data-key="13733"><span data-slate-leaf="true" data-offset-key="13733:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13734"><span data-slate-leaf="true" data-offset-key="13734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置当前 CPU 的 tss 中的 R0 栈为下一个运行进程的内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13735"><span data-slate-object="text" data-key="13736"><span data-slate-leaf="true" data-offset-key="13736:0" data-first-offset="true"><span data-slate-string="true">    next</span></span></span><span data-slate-object="text" data-key="13737"><span data-slate-leaf="true" data-offset-key="13737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13738"><span data-slate-leaf="true" data-offset-key="13738:0" data-first-offset="true"><span data-slate-string="true">td_context.ctx_nexttss</span></span></span><span data-slate-object="text" data-key="13739"><span data-slate-leaf="true" data-offset-key="13739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13740"><span data-slate-leaf="true" data-offset-key="13740:0" data-first-offset="true"><span data-slate-string="true">rsp0 = next</span></span></span><span data-slate-object="text" data-key="13741"><span data-slate-leaf="true" data-offset-key="13741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13742"><span data-slate-leaf="true" data-offset-key="13742:0" data-first-offset="true"><span data-slate-string="true">td_krlstktop;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13743"><span data-slate-object="text" data-key="13744"><span data-slate-leaf="true" data-offset-key="13744:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13745"><span data-slate-leaf="true" data-offset-key="13745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 装载下一个运行进程的 MMU 页表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13746"><span data-slate-object="text" data-key="13747"><span data-slate-leaf="true" data-offset-key="13747:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13748"><span data-slate-leaf="true" data-offset-key="13748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_mmu_load</span></span></span></span><span data-slate-object="text" data-key="13749"><span data-slate-leaf="true" data-offset-key="13749:0" data-first-offset="true"><span data-slate-string="true">(&amp;next</span></span></span><span data-slate-object="text" data-key="13750"><span data-slate-leaf="true" data-offset-key="13750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13751"><span data-slate-leaf="true" data-offset-key="13751:0" data-first-offset="true"><span data-slate-string="true">td_mmdsc</span></span></span><span data-slate-object="text" data-key="13752"><span data-slate-leaf="true" data-offset-key="13752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13753"><span data-slate-leaf="true" data-offset-key="13753:0" data-first-offset="true"><span data-slate-string="true">msd_mmu);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13754"><span data-slate-object="text" data-key="13755"><span data-slate-leaf="true" data-offset-key="13755:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13756"><span data-slate-leaf="true" data-offset-key="13756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13757"><span data-slate-leaf="true" data-offset-key="13757:0" data-first-offset="true"><span data-slate-string="true"> (next</span></span></span><span data-slate-object="text" data-key="13758"><span data-slate-leaf="true" data-offset-key="13758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13759"><span data-slate-leaf="true" data-offset-key="13759:0" data-first-offset="true"><span data-slate-string="true">td_stus == TDSTUS_NEW)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13760"><span data-slate-object="text" data-key="13761"><span data-slate-leaf="true" data-offset-key="13761:0" data-first-offset="true"><span data-slate-string="true">    {   </span></span></span><span data-slate-object="text" data-key="13762"><span data-slate-leaf="true" data-offset-key="13762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是新建进程第一次运行就要进行处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13763"><span data-slate-object="text" data-key="13764"><span data-slate-leaf="true" data-offset-key="13764:0" data-first-offset="true"><span data-slate-string="true">        next</span></span></span><span data-slate-object="text" data-key="13765"><span data-slate-leaf="true" data-offset-key="13765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13766"><span data-slate-leaf="true" data-offset-key="13766:0" data-first-offset="true"><span data-slate-string="true">td_stus = TDSTUS_RUN;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13767"><span data-slate-object="text" data-key="13768"><span data-slate-leaf="true" data-offset-key="13768:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13769"><span data-slate-leaf="true" data-offset-key="13769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">retnfrom_first_sched</span></span></span></span><span data-slate-object="text" data-key="13770"><span data-slate-leaf="true" data-offset-key="13770:0" data-first-offset="true"><span data-slate-string="true">(next);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13771"><span data-slate-object="text" data-key="13772"><span data-slate-leaf="true" data-offset-key="13772:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13773"><span data-slate-object="text" data-key="13774"><span data-slate-leaf="true" data-offset-key="13774:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13775"><span data-slate-leaf="true" data-offset-key="13775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13776"><span data-slate-leaf="true" data-offset-key="13776:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13777"><span data-slate-object="text" data-key="13778"><span data-slate-leaf="true" data-offset-key="13778:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13779"><span data-slate-object="text" data-key="13780"><span data-slate-leaf="true" data-offset-key="13780:0" data-first-offset="true"><span data-slate-string="true">上面代码的注释已经很清楚了，__to_new_context 负责设置当前运行的进程，处理 CPU 发生中断时需要切换栈的问题，又切换了一个进程的 MMU 页表（即使用新进程的地址空间），最后如果是新建进程第一次运行，就调用 retnfrom_first_sched 函数进行处理。下面我们来写好这个函数。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13781"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13782"><span data-slate-object="text" data-key="13783"><span data-slate-leaf="true" data-offset-key="13783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="13784"><span data-slate-leaf="true" data-offset-key="13784:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13785"><span data-slate-leaf="true" data-offset-key="13785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">retnfrom_first_sched</span></span></span></span><span data-slate-object="text" data-key="13786"><span data-slate-leaf="true" data-offset-key="13786:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13787"><span data-slate-leaf="true" data-offset-key="13787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">thread_t *thrdp</span></span></span></span><span data-slate-object="text" data-key="13788"><span data-slate-leaf="true" data-offset-key="13788:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13789"><span data-slate-object="text" data-key="13790"><span data-slate-leaf="true" data-offset-key="13790:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13791"><span data-slate-object="text" data-key="13792"><span data-slate-leaf="true" data-offset-key="13792:0" data-first-offset="true"><span data-slate-string="true">    __asm__ </span></span></span><span data-slate-object="text" data-key="13793"><span data-slate-leaf="true" data-offset-key="13793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">__volatile__</span></span></span></span><span data-slate-object="text" data-key="13794"><span data-slate-leaf="true" data-offset-key="13794:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13795"><span data-slate-object="text" data-key="13796"><span data-slate-leaf="true" data-offset-key="13796:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13797"><span data-slate-leaf="true" data-offset-key="13797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[NEXT_RSP],%%rsp\n\t"</span></span></span></span><span data-slate-object="text" data-key="13798"><span data-slate-leaf="true" data-offset-key="13798:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13799"><span data-slate-leaf="true" data-offset-key="13799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 CPU 的 RSP 寄存器为该进程机器上下文结构中的 RSP</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13800"><span data-slate-object="text" data-key="13801"><span data-slate-leaf="true" data-offset-key="13801:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13802"><span data-slate-leaf="true" data-offset-key="13802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 恢复进程保存在内核栈中的段寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13803"><span data-slate-object="text" data-key="13804"><span data-slate-leaf="true" data-offset-key="13804:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13805"><span data-slate-leaf="true" data-offset-key="13805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13806"><span data-slate-object="text" data-key="13807"><span data-slate-leaf="true" data-offset-key="13807:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13808"><span data-slate-leaf="true" data-offset-key="13808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movw %%r14w,%%gs\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13809"><span data-slate-object="text" data-key="13810"><span data-slate-leaf="true" data-offset-key="13810:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13811"><span data-slate-leaf="true" data-offset-key="13811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13812"><span data-slate-object="text" data-key="13813"><span data-slate-leaf="true" data-offset-key="13813:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13814"><span data-slate-leaf="true" data-offset-key="13814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movw %%r14w,%%fs\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13815"><span data-slate-object="text" data-key="13816"><span data-slate-leaf="true" data-offset-key="13816:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13817"><span data-slate-leaf="true" data-offset-key="13817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13818"><span data-slate-object="text" data-key="13819"><span data-slate-leaf="true" data-offset-key="13819:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13820"><span data-slate-leaf="true" data-offset-key="13820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movw %%r14w,%%es\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13821"><span data-slate-object="text" data-key="13822"><span data-slate-leaf="true" data-offset-key="13822:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13823"><span data-slate-leaf="true" data-offset-key="13823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13824"><span data-slate-object="text" data-key="13825"><span data-slate-leaf="true" data-offset-key="13825:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13826"><span data-slate-leaf="true" data-offset-key="13826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movw %%r14w,%%ds\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13827"><span data-slate-object="text" data-key="13828"><span data-slate-leaf="true" data-offset-key="13828:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13829"><span data-slate-leaf="true" data-offset-key="13829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 恢复进程保存在内核栈中的通用寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13830"><span data-slate-object="text" data-key="13831"><span data-slate-leaf="true" data-offset-key="13831:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13832"><span data-slate-leaf="true" data-offset-key="13832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r15\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13833"><span data-slate-object="text" data-key="13834"><span data-slate-leaf="true" data-offset-key="13834:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13835"><span data-slate-leaf="true" data-offset-key="13835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r14\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13836"><span data-slate-object="text" data-key="13837"><span data-slate-leaf="true" data-offset-key="13837:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13838"><span data-slate-leaf="true" data-offset-key="13838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r13\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13839"><span data-slate-object="text" data-key="13840"><span data-slate-leaf="true" data-offset-key="13840:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13841"><span data-slate-leaf="true" data-offset-key="13841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r12\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13842"><span data-slate-object="text" data-key="13843"><span data-slate-leaf="true" data-offset-key="13843:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13844"><span data-slate-leaf="true" data-offset-key="13844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r11\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13845"><span data-slate-object="text" data-key="13846"><span data-slate-leaf="true" data-offset-key="13846:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13847"><span data-slate-leaf="true" data-offset-key="13847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r10\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13848"><span data-slate-object="text" data-key="13849"><span data-slate-leaf="true" data-offset-key="13849:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13850"><span data-slate-leaf="true" data-offset-key="13850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r9\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13851"><span data-slate-object="text" data-key="13852"><span data-slate-leaf="true" data-offset-key="13852:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13853"><span data-slate-leaf="true" data-offset-key="13853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%r8\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13854"><span data-slate-object="text" data-key="13855"><span data-slate-leaf="true" data-offset-key="13855:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13856"><span data-slate-leaf="true" data-offset-key="13856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rdi\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13857"><span data-slate-object="text" data-key="13858"><span data-slate-leaf="true" data-offset-key="13858:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13859"><span data-slate-leaf="true" data-offset-key="13859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rsi\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13860"><span data-slate-object="text" data-key="13861"><span data-slate-leaf="true" data-offset-key="13861:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13862"><span data-slate-leaf="true" data-offset-key="13862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rbp\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13863"><span data-slate-object="text" data-key="13864"><span data-slate-leaf="true" data-offset-key="13864:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13865"><span data-slate-leaf="true" data-offset-key="13865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rdx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13866"><span data-slate-object="text" data-key="13867"><span data-slate-leaf="true" data-offset-key="13867:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13868"><span data-slate-leaf="true" data-offset-key="13868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rcx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13869"><span data-slate-object="text" data-key="13870"><span data-slate-leaf="true" data-offset-key="13870:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13871"><span data-slate-leaf="true" data-offset-key="13871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rbx\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13872"><span data-slate-object="text" data-key="13873"><span data-slate-leaf="true" data-offset-key="13873:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13874"><span data-slate-leaf="true" data-offset-key="13874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popq %%rax\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13875"><span data-slate-object="text" data-key="13876"><span data-slate-leaf="true" data-offset-key="13876:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13877"><span data-slate-leaf="true" data-offset-key="13877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 恢复进程保存在内核栈中的 RIP、CS、RFLAGS，（有可能需要恢复进程应用程序的 RSP、SS）寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13878"><span data-slate-object="text" data-key="13879"><span data-slate-leaf="true" data-offset-key="13879:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13880"><span data-slate-leaf="true" data-offset-key="13880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"iretq\n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13881"><span data-slate-object="text" data-key="13882"><span data-slate-leaf="true" data-offset-key="13882:0" data-first-offset="true"><span data-slate-string="true">        :</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13883"><span data-slate-object="text" data-key="13884"><span data-slate-leaf="true" data-offset-key="13884:0" data-first-offset="true"><span data-slate-string="true">        : [ </span></span></span><span data-slate-object="text" data-key="13885"><span data-slate-leaf="true" data-offset-key="13885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NEXT_RSP</span></span></span></span><span data-slate-object="text" data-key="13886"><span data-slate-leaf="true" data-offset-key="13886:0" data-first-offset="true"><span data-slate-string="true"> ] </span></span></span><span data-slate-object="text" data-key="13887"><span data-slate-leaf="true" data-offset-key="13887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"m"</span></span></span></span><span data-slate-object="text" data-key="13888"><span data-slate-leaf="true" data-offset-key="13888:0" data-first-offset="true"><span data-slate-string="true">(thrdp-&gt;td_context.</span></span></span><span data-slate-object="text" data-key="13889"><span data-slate-leaf="true" data-offset-key="13889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ctx_nextrsp</span></span></span></span><span data-slate-object="text" data-key="13890"><span data-slate-leaf="true" data-offset-key="13890:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13891"><span data-slate-object="text" data-key="13892"><span data-slate-leaf="true" data-offset-key="13892:0" data-first-offset="true"><span data-slate-string="true">        : </span></span></span><span data-slate-object="text" data-key="13893"><span data-slate-leaf="true" data-offset-key="13893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="13894"><span data-slate-leaf="true" data-offset-key="13894:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13895"><span data-slate-object="text" data-key="13896"><span data-slate-leaf="true" data-offset-key="13896:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13897"><span data-slate-object="text" data-key="13898"><span data-slate-leaf="true" data-offset-key="13898:0" data-first-offset="true"><span data-slate-string="true">retnfrom_first_sched 函数不会返回到调用它的 __to_new_context 函数中，而是直接运行新建进程的相关代码（如果你不理解这段代码的原理，可以回顾</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13899"><span data-slate-object="text" data-key="13900"><span data-slate-leaf="true" data-offset-key="13900:0" data-first-offset="true"><span data-slate-string="true">上一课</span></span></span></a><span data-slate-object="text" data-key="13901"><span data-slate-leaf="true" data-offset-key="13901:0" data-first-offset="true"><span data-slate-string="true">，看看建立进程时，对进程内核栈进行的初始化工作）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13902"><span data-slate-object="text" data-key="13903"><span data-slate-leaf="true" data-offset-key="13903:0" data-first-offset="true"><span data-slate-string="true">好，进行到这里，我们已经设计出了我们的 Cosmos 的进程调度器，但我们都知道，这样的调度器还不够，我们还没有解决进程的等待和唤醒问题，这些内容下节课我再跟你详细分享。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13904" id="sr-toc-12"><span data-slate-object="text" data-key="13905"><span data-slate-leaf="true" data-offset-key="13905:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13906"><span data-slate-object="text" data-key="13907"><span data-slate-leaf="true" data-offset-key="13907:0" data-first-offset="true"><span data-slate-string="true">这节课我们从了解为什么需要多进程调度开始，随后实现子调度管理多个进程，最终实现了进程调度器，这里面有很多重要的知识点，我来为你梳理一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13908"><span data-slate-object="text" data-key="13909"><span data-slate-leaf="true" data-offset-key="13909:0" data-first-offset="true"><span data-slate-string="true">1.</span></span></span><span data-slate-object="text" data-key="13910"><span data-slate-leaf="true" data-offset-key="13910:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 为什么需要多进程调度？</span></span></span></span><span data-slate-object="text" data-key="13911"><span data-slate-leaf="true" data-offset-key="13911:0" data-first-offset="true"><span data-slate-string="true">我们分析了系统中总有些资源不能满足每个进程的需求，所以一些进程必须要走走停停，这就需要不同的进程来回切换到 CPU 上运行，为了实现这个机制就需要多进程调度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13912"><span data-slate-object="text" data-key="13913"><span data-slate-leaf="true" data-offset-key="13913:0" data-first-offset="true"><span data-slate-string="true">2.</span></span></span><span data-slate-object="text" data-key="13914"><span data-slate-leaf="true" data-offset-key="13914:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 组织多个进程。</span></span></span></span><span data-slate-object="text" data-key="13915"><span data-slate-leaf="true" data-offset-key="13915:0" data-first-offset="true"><span data-slate-string="true">为了实现进程管理，必须要组织多个进程。我们设计了调度器数据结构，在该结构中，我们使用优先级链表数组来组织多个进程，并且对这些数据结构的变量进行了初始化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13916"><span data-slate-object="text" data-key="13917"><span data-slate-leaf="true" data-offset-key="13917:0" data-first-offset="true"><span data-slate-string="true">3.</span></span></span><span data-slate-object="text" data-key="13918"><span data-slate-leaf="true" data-offset-key="13918:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 进程调度。</span></span></span></span><span data-slate-object="text" data-key="13919"><span data-slate-leaf="true" data-offset-key="13919:0" data-first-offset="true"><span data-slate-string="true">有了多个进程就需要进程调度，我们的进程调度器是一个函数，在这个函数中选择了当前运行进程和下一个将要运行的进程，如果实在没有可运行的进程就选择空转进程，最后关键是进程间切换，我们是通过切换进程的内核栈来切换进程的函数调用路径，当调度器函数返回的时候已经是另一个进程了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13920" id="sr-toc-13"><span data-slate-object="text" data-key="13921"><span data-slate-leaf="true" data-offset-key="13921:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13922"><span data-slate-object="text" data-key="13923"><span data-slate-leaf="true" data-offset-key="13923:0" data-first-offset="true"><span data-slate-string="true">请问当调度器函数调度到一个新建进程时，为何要进入 retnfrom_first_sched 函数呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13924"><span data-slate-object="text" data-key="13925"><span data-slate-leaf="true" data-offset-key="13925:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区积极分享，相信通过主动输出，你将更好地理解这节课的内容。也欢迎把这节课分享给你的朋友，和他交流探讨，</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13926"><span data-slate-object="text" data-key="13927"><span data-slate-leaf="true" data-offset-key="13927:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-14">精选留言 (20)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>一、数据结构
全局有一个 osschedcls 变量，其数据结构为 schedclass_t，用于管理所有 cpu 的所有进程。
schedclass_t 包括一个 schdata_t 数组，每个 cpu 对应一个。schedclass_t [i]，用于管理第 i 个 cpu 的全部进程。
schedclass_t [i] 包括一个 thrdlst_t 数组，每个进程优先级对应一个。schedclass_t [i].schdata_t [j] 中，管理了第 i 个 cpu 的，优先级为 j 的全部进程。

二、初始化
进程结构初始化：
init_krl-&gt;init_krlsched-&gt;schedclass_t_init
-&gt; 对于每个 cpu，调用 schdata_t_init，进行初始化
-&gt; 对于每个 cpu 的每个进程优先级，调用 thrdlst_t_init 初始化列表

idel 进程初始化：
init_krl-&gt;init_krlcpuidle
-&gt;new_cpuidle-&gt;new_cpuidle_thread-&gt;krlthread_kernstack_init【krlcpuidle_main 传参】-&gt;krlschedul
-&gt;krlcpuidle_start-&gt;retnfrom_first_sched 启动 idel 进程

三、进程调度
init_krl-&gt;init_krlcpuidle-&gt;new_cpuidle-&gt;new_cpuidle_thread-&gt;krlthread_kernstack_init【krlcpuidle_main 传参】-&gt;krlschedul
-&gt;krlsched_retn_currthread 根据当前 cpuid，获取正在运行的进程
-&gt;krlsched_select_thread，获取下一个运行的进程
A、根据当前 cpuid，选择优先级最高进程列表中的第一个进程
B、并将该优先级的当前进程，重新放回进程列表
C、如果没有进程要运行，则返回 idel 进程
-&gt;save_to_new_context，进行进程切换
A、保存当前进程的寄存器状态，到当前寄存器的栈
B、切换栈寄存器，指 “向下一进程” 的栈
C、调用__to_new_context
D、从 “下一进程” 的栈，恢复寄存器状态
E、而上面这些保存的状态，都是 “下一进程” 在释放 CPU 时保存好的
F、当 CPU 再次回到这个所谓的 “下一进程” 时，又会用同样的方式还原现场，继续执行
-&gt;-&gt;__to_new_context
A、更新当前运行进程为 “下一个进程”
B、设置 “下一进程” 的 tss 为当前 CPU 的 tss
C、设置 “下一进程” 的内核栈
D、装载 “下一进程 “的 MMU 页表
E、如果 “下一个进程” 没有运行过，调用 retnfrom_first_sched，进行第一次运行初始化
-&gt;-&gt;-&gt; retnfrom_first_sched
设置好新进程的相关寄存器和栈，直接运行新建进程的相关代码</div><div><p>作者回复：大佬  梳理总结到位</p></div><div><div>2021-07-06</div><div><div><i></i><span>3</span></div><div><i></i><span>11</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div><span>置顶</span></div><div>文中已有答案: retnfrom_first_sched 函数不会返回到调用它的 __to_new_context 函数中，而是直接运行新建进程的相关代码。

新的进程暂时还没有上下文，所以也就没办法切换了，于是直接运行。</div><div><p>作者回复：对的 铁子</p></div><div><div>2021-07-05</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/68/1a/d9a35bc7.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Ziggy_aa</span></div><span>置顶</span></div><div>一刷的时候只是简单过了内容，到后面就跟不上了。现在二刷是跟着源码一步一步在看。从一开始初始化部分需要对照学习。渐渐熟悉代码风格和逻辑后，从内存中段部分开始就变成了先自己理解代码，再看文章确认了。还是推荐大家把源码读起来，学习的过程中会感觉越来越快。

这一章节最后的几个切换函数让我苦恼了一下。后来发现是自己搞蒙了两件事：
1. 如果你也一下子没反应过来为什么寄存器保存和复原的内容里没有 CS 和 RIP。那是因为 call 指令调用的时候自动已经把它们入栈了。别把这个搞忘了。
2. 我们是在调用 __to_new_context () 之前就已经切换到了新进程的栈了。这样我们在调用 __to_new_context () 的时候，已经是入栈在新进程的栈，所以，随着我们 return 回去，我们就在运行新的教程了。

至于新建进程为什么要用 retnfrom_first_sched 调转。对比代码可以发现，新建进程的 stack 和 __to_new_context () 返回后所需要的 stack 内容是不同的 （新建进程里还有 segment registers 的内容）。</div><div><p>作者回复：对的</p></div><div><div>2022-07-22</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/67/0f/3cb10900.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>菜鸟</span></div></div><div>我想问一下进程产生的整个过程是怎样的？即：命令行运行程序实例，是怎么初始化进程？是怎么把磁盘上的程序加载到内存？怎么确定进程的入口地址等</div><div><p>作者回复：看看后面的课程</p></div><div><div>2021-08-10</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 青玉白露</span></div></div><div>文中 ——“retnfrom_first_sched 函数不会返回到调用它的 __to_new_context 函数中，而是直接运行新建进程的相关代码”—— 就是思考题的答案了。
retnfrom_first_shed 可以视为一个初始化的过程
</div><div><p>作者回复：哈哈 正确的</p></div><div><div>2021-07-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI3F4IdQuDZrhN8ThibP85eCiaSWTYpTrcC6QB9EoAkw3IIj6otMibb1CgrS1uzITAnJmGLXQ2tgIkAQ/132"></div></div><div><div><div><span>cugphoenix</span></div></div><div>新建进程初始化内核栈的时候，会给存储在内核栈中的 intstkregs_t.r_rip_old，r_cs_old，r_rflgs... 这些赋值，在 retnfrom_first_sched 里面 iretq 时，正好会把这些值弹出到对应寄存器中，从而实现新进程的运行。</div><div><p>作者回复：正确的 </p></div><div><div>2021-07-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKy9XSxDLRibViazIs1wzhEmIQqMlhcoKhTXNvxXkaPGIveib8B9ibvpdkZxABKFIc4iaSMrkTh7EfWjtg/132"></div></div><div><div><div><span>likejjj</span></div></div><div>除了进程自己让出 cpu，进程调度是不是都是时钟中断触发的？时间片粒度的大小，是不是由时钟的频率决定的？比如 1/250</div><div><p>作者回复：那不一定</p></div><div><div>2022-06-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/9a/1d/be65c247.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>如果是你</span></div></div><div>请问又是谁调用的进程调度器呢？</div><div><p>作者回复：中断 内核</p></div><div><div>2022-06-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>艾恩凝</span></div></div><div>内存一过，一马平川</div><div><p>作者回复：内存很难</p></div><div><div>2022-05-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/e2/7e/ffde572d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>PAWCOOK</span></div></div><div>请问进程进入睡眠状态和进入等待状态有什么区别吗？我觉得它们本质上是一样的</div><div><p>作者回复：在 Cosmos 上是没区别的 其它别的 OS 上不同</p></div><div><div>2022-04-01</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>if...else...</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>为什么说 c 内核栈是比垃圾回收还要牛逼的内存管理方式呢？</div><div><p>作者回复: C 栈中变量占用的内存 你不用管理</p></div><div><div>2022-02-18</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek5167</span></div></div><div>进程切换的时候，cs:ip 寄存器不用处理吗，比如保存当前进程的 cs:ip 值</div><div><p>作者回复：会处理的 </p></div><div><div>2022-01-14</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek5167</span></div></div><div>如果要实现线程和线程间的切换，能提供一些思路和资料吗？</div><div><p>作者回复：你看课程里的实现啊</p></div><div><div>2022-01-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek5167</span></div></div><div>因为进程的函数调用路径就保存在对应的内核栈中，……
想问下这个保存动作是谁做的，具体是怎么做的</div><div><p>作者回复：不是谁做的 C 函数调用自动保存在栈中</p></div><div><div>2022-01-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/47/4f/419c050c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Mechanic</span></div></div><div>现在的硬件性能 (至少计算资源) 应该已经不是” 系统中总有些资源不能满足每个进程的需求 “，而是计算资源过于充沛导致如果只满足一个进程过于浪费了吧？</div><div><p>作者回复：进程很多的 不是一个进程</p></div><div><div>2021-11-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/2a/f8/8d483f93.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>paulpen</span></div></div><div>请问老师，进程切换时 ，段寄存器 比如 cs  要不要管？</div><div><p>作者回复：要管的 </p></div><div><div>2021-10-11</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/5f/e2/e6d3d9bf.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>XI</span></div></div><div>请教老师： ” 第一，CPU 同一时刻只能运行一个进程，而 CPU 个数总是比进程个数少，这就需要让多进程共用一个 CPU，每个进程在这个 CPU 上运行一段时间。" 多核 CPU 比如 6 核是不是就可以同时运行 6 个进程？，另外现在的 cpu 都标注 6 核 12 线程，每个进程又可以创建很多个线程，假设操作系统中有 10 个进程正在运行，每个进程又创建了 10 个线程抢占 cpu，那么操作系统中就有 100 个线程，这 100 个线程是怎么和 cpu 标注的 6 核 12 线程挂上联系的？</div><div><p>作者回复：这样的 cpu 可以同时支行 12 个线程 </p></div><div><div>2021-09-23</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>进击的小学生</span></div></div><div>大佬，今天跟朋友讨论，有一个问题没搞明白需要请教下：在多核 CPU 情况下，有没有多个线程在同一个时刻抢到同一个资源，进行同一操作，比如果某个写锁？如果有的话，这个怎么解决这种问题？</div><div><p>作者回复：只有一个线程可以写</p></div><div><div>2021-08-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>发现每次都是这三人</div><div><p>编辑回复：哈哈，优秀课代表。</p></div><div><div>2021-07-05</div><div><div><i></i><span>4</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div></div><div>又是到阅读理解题。哈</div><div><p>作者回复：简单吗</p></div><div><div>2021-07-05</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".m"><outline class="toc-level-h1" data-reactid=".m.0" style="width: 175px;"><active data-reactid=".m.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".m.0.1"><span data-reactid=".m.0.1.0">25 | 多个活动要安排（上）：多进程如何调度？</span></a></outline><outline class="toc-level-h2" data-reactid=".m.1" style="width: 165px;"><active data-reactid=".m.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".m.1.1"><span data-reactid=".m.1.1.0">为什么需要多进程调度</span></a></outline><outline class="toc-level-h2" data-reactid=".m.2" style="width: 165px;"><active data-reactid=".m.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".m.2.1"><span data-reactid=".m.2.1.0">管理进程</span></a></outline><outline class="toc-level-h3" data-reactid=".m.3" style="width: 155px;"><active data-reactid=".m.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".m.3.1"><span data-reactid=".m.3.1.0">进程的生命周期</span></a></outline><outline class="toc-level-h3" data-reactid=".m.4" style="width: 155px;"><active data-reactid=".m.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".m.4.1"><span data-reactid=".m.4.1.0">如何组织进程</span></a></outline><outline class="toc-level-h3" data-reactid=".m.5" style="width: 155px;"><active data-reactid=".m.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".m.5.1"><span data-reactid=".m.5.1.0">管理进程的初始化</span></a></outline><outline class="toc-level-h2" data-reactid=".m.6" style="width: 165px;"><active data-reactid=".m.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".m.6.1"><span data-reactid=".m.6.1.0">设计实现进程调度器</span></a></outline><outline class="toc-level-h3" data-reactid=".m.7" style="width: 155px;"><active data-reactid=".m.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".m.7.1"><span data-reactid=".m.7.1.0">进程调度器入口</span></a></outline><outline class="toc-level-h3" data-reactid=".m.8" style="width: 155px;"><active data-reactid=".m.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".m.8.1"><span data-reactid=".m.8.1.0">如何获取当前运行的进程</span></a></outline><outline class="toc-level-h3" data-reactid=".m.9" style="width: 155px;"><active data-reactid=".m.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".m.9.1"><span data-reactid=".m.9.1.0">选择下一个进程</span></a></outline><outline class="toc-level-h3" data-reactid=".m.a" style="width: 155px;"><active data-reactid=".m.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".m.a.1"><span data-reactid=".m.a.1.0">获取空转进程</span></a></outline><outline class="toc-level-h3" data-reactid=".m.b" style="width: 155px;"><active data-reactid=".m.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".m.b.1"><span data-reactid=".m.b.1.0">进程切换</span></a></outline><outline class="toc-level-h2" data-reactid=".m.c" style="width: 165px;"><active data-reactid=".m.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".m.c.1"><span data-reactid=".m.c.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".m.d" style="width: 165px;"><active data-reactid=".m.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".m.d.1"><span data-reactid=".m.d.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".m.e" style="width: 165px;"><active data-reactid=".m.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".m.e.1"><span data-reactid=".m.e.1.0">精选留言 (20)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/391222" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>