
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 12 | 设置工作模式与环境（下）：探查和收集信息</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>12 | 设置工作模式与环境（下）：探查和收集信息</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0"> 12 | 设置工作模式与环境（下）：探查和收集信息</h1><div><span>LMOS</span> <span>2021-06-04</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/dc/af/dcd4962cdbb149b38890cbf5193yy7af.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：13.67M</span><span> 时长：14:57</span></div></div><audio title="12 | 设置工作模式与环境（下）：探查和收集信息" src="https://res001.geekbang.org/media/audio/ae/7f/aed2eabd073f523fbf7170b51617067f/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="8362" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="8363"><span data-slate-object="text" data-key="8364"><span data-slate-leaf="true" data-offset-key="8364:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8365"><span data-slate-object="text" data-key="8366"><span data-slate-leaf="true" data-offset-key="8366:0" data-first-offset="true"><span data-slate-string="true">上节课我们动手实现了自己的二级引导器。今天这节课我们将进入二级引导器，完成具体工作的环节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8367"><span data-slate-object="text" data-key="8368"><span data-slate-leaf="true" data-offset-key="8368:0" data-first-offset="true"><span data-slate-string="true">在二级引导器中，我们要检查 CPU 是否支持 64 位的工作模式、收集内存布局信息，看看是不是合乎我们操作系统的最低运行要求，还要设置操作系统需要的 MMU 页表、设置显卡模式、释放中文字体文件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8369"><span data-slate-object="text" data-key="8370"><span data-slate-leaf="true" data-offset-key="8370:0" data-first-offset="true"><span data-slate-string="true">今天课程的配套代码，你可以点击</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8371"><span data-slate-object="text" data-key="8372"><span data-slate-leaf="true" data-offset-key="8372:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="8373"><span data-slate-leaf="true" data-offset-key="8373:0" data-first-offset="true"><span data-slate-string="true">，自行下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8374" id="sr-toc-1"><span data-slate-object="text" data-key="8375"><span data-slate-leaf="true" data-offset-key="8375:0" data-first-offset="true"><span data-slate-string="true">检查与收集机器信息</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8376"><span data-slate-object="text" data-key="8377"><span data-slate-leaf="true" data-offset-key="8377:0" data-first-offset="true"><span data-slate-string="true">如果 ldrkrl_entry () 函数是总裁，那么 init_bstartparm () 函数则是经理，</span></span><span data-slate-leaf="true" data-offset-key="8377:1"><span data-slate-object="annotation" data-annotation-key="gkann_52ec4164" data-attr-id="24560" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">它负责管理检查 CPU 模式、收集内存信息，设置内核栈，设置内核字体、建立内核 MMU 页表数据。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8378"><span data-slate-object="text" data-key="8379"><span data-slate-leaf="true" data-offset-key="8379:0" data-first-offset="true"><span data-slate-string="true">为了使代码更加清晰，我们并不直接在 ldrkrl_entry () 函数中搞事情，而是准备在另一个 bstartparm.c 文件中实现一个 init_bstartparm ()。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8380"><span data-slate-object="text" data-key="8381"><span data-slate-leaf="true" data-offset-key="8381:0" data-first-offset="true"><span data-slate-string="true">下面我们就来动手实现它，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8382"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8383"><span data-slate-object="text" data-key="8384"><span data-slate-leaf="true" data-offset-key="8384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 machbstart_t 结构体，清 0, 并设置一个标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8385"><span data-slate-object="text" data-key="8386"><span data-slate-leaf="true" data-offset-key="8386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="8387"><span data-slate-leaf="true" data-offset-key="8387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8388"><span data-slate-leaf="true" data-offset-key="8388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t_init</span></span></span></span></span><span data-slate-object="text" data-key="8389"><span data-slate-leaf="true" data-offset-key="8389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="8390"><span data-slate-leaf="true" data-offset-key="8390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="8391"><span data-slate-leaf="true" data-offset-key="8391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* initp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8392"><span data-slate-object="text" data-key="8393"><span data-slate-leaf="true" data-offset-key="8393:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8394"><span data-slate-object="text" data-key="8395"><span data-slate-leaf="true" data-offset-key="8395:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8396"><span data-slate-leaf="true" data-offset-key="8396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">memset</span></span></span></span><span data-slate-object="text" data-key="8397"><span data-slate-leaf="true" data-offset-key="8397:0" data-first-offset="true"><span data-slate-string="true">(initp,</span></span></span><span data-slate-object="text" data-key="8398"><span data-slate-leaf="true" data-offset-key="8398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8399"><span data-slate-leaf="true" data-offset-key="8399:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="8400"><span data-slate-leaf="true" data-offset-key="8400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="8401"><span data-slate-leaf="true" data-offset-key="8401:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8402"><span data-slate-leaf="true" data-offset-key="8402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="8403"><span data-slate-leaf="true" data-offset-key="8403:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8404"><span data-slate-object="text" data-key="8405"><span data-slate-leaf="true" data-offset-key="8405:0" data-first-offset="true"><span data-slate-string="true">    initp-&gt;mb_migc=MBS_MIGC;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8406"><span data-slate-object="text" data-key="8407"><span data-slate-leaf="true" data-offset-key="8407:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8408"><span data-slate-leaf="true" data-offset-key="8408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8409"><span data-slate-leaf="true" data-offset-key="8409:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8410"><span data-slate-object="text" data-key="8411"><span data-slate-leaf="true" data-offset-key="8411:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8412"><span data-slate-object="text" data-key="8413"><span data-slate-leaf="true" data-offset-key="8413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="8414"><span data-slate-leaf="true" data-offset-key="8414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8415"><span data-slate-leaf="true" data-offset-key="8415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bstartparm</span></span></span></span></span><span data-slate-object="text" data-key="8416"><span data-slate-leaf="true" data-offset-key="8416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8417"><span data-slate-object="text" data-key="8418"><span data-slate-leaf="true" data-offset-key="8418:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8419"><span data-slate-object="text" data-key="8420"><span data-slate-leaf="true" data-offset-key="8420:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8421"><span data-slate-leaf="true" data-offset-key="8421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="8422"><span data-slate-leaf="true" data-offset-key="8422:0" data-first-offset="true"><span data-slate-string="true">* mbsp = MBSPADR;</span></span></span><span data-slate-object="text" data-key="8423"><span data-slate-leaf="true" data-offset-key="8423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//1MB 的内存地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8424"><span data-slate-object="text" data-key="8425"><span data-slate-leaf="true" data-offset-key="8425:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8426"><span data-slate-leaf="true" data-offset-key="8426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t_init</span></span></span></span><span data-slate-object="text" data-key="8427"><span data-slate-leaf="true" data-offset-key="8427:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8428"><span data-slate-object="text" data-key="8429"><span data-slate-leaf="true" data-offset-key="8429:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8430"><span data-slate-leaf="true" data-offset-key="8430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8431"><span data-slate-leaf="true" data-offset-key="8431:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8432"><span data-slate-object="text" data-key="8433"><span data-slate-leaf="true" data-offset-key="8433:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8434"><span data-slate-object="text" data-key="8435"><span data-slate-leaf="true" data-offset-key="8435:0" data-first-offset="true"><span data-slate-string="true">目前我们的经理 init_bstartparm () 函数只是调用了一个 machbstart_t_init () 函数，在 1MB 内存地址处初始化了一个机器信息结构 machbstart_t，后面随着干活越来越多，还会调用更多的函数的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8436" id="sr-toc-2"><span data-slate-object="text" data-key="8437"><span data-slate-leaf="true" data-offset-key="8437:0" data-first-offset="true"><span data-slate-string="true">检查 CPU</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8438"><span data-slate-object="text" data-key="8439"><span data-slate-leaf="true" data-offset-key="8439:0" data-first-offset="true"><span data-slate-string="true">首先要检查我们的 CPU，因为它是执行程序的关键。我们要搞清楚它能执行什么形式的代码，支持 64 位长模式吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8440"><span data-slate-object="text" data-key="8441"><span data-slate-leaf="true" data-offset-key="8441:0" data-first-offset="true"><span data-slate-string="true">这个工作我们交给 init_chkcpu () 函数来干，由于我们要 CPUID 指令来检查 CPU 是否支持 64 位长模式，所以这个函数中需要找两个帮工：</span></span></span><span data-slate-object="text" data-key="8442"><span data-slate-leaf="true" data-offset-key="8442:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">chk_cpuid、chk_cpu_longmode</span></span></span></span><span data-slate-object="text" data-key="8443"><span data-slate-leaf="true" data-offset-key="8443:0" data-first-offset="true"><span data-slate-string="true"> 来干两件事，一个是检查 CPU 否支持 CPUID 指令，然后另一个用 CPUID 指令检查 CPU 支持 64 位长模式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8444"><span data-slate-object="text" data-key="8445"><span data-slate-leaf="true" data-offset-key="8445:0" data-first-offset="true"><span data-slate-string="true">下面我们去写好它们，如下所示。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="8446"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8447"><span data-slate-object="text" data-key="8448"><span data-slate-leaf="true" data-offset-key="8448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过改写 Eflags 寄存器的第 21 位，观察其位的变化判断是否支持 CPUID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8449"><span data-slate-object="text" data-key="8450"><span data-slate-leaf="true" data-offset-key="8450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8451"><span data-slate-leaf="true" data-offset-key="8451:0" data-first-offset="true"><span data-slate-string="true"> chk_cpuid()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8452"><span data-slate-object="text" data-key="8453"><span data-slate-leaf="true" data-offset-key="8453:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8454"><span data-slate-object="text" data-key="8455"><span data-slate-leaf="true" data-offset-key="8455:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8456"><span data-slate-leaf="true" data-offset-key="8456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8457"><span data-slate-leaf="true" data-offset-key="8457:0" data-first-offset="true"><span data-slate-string="true"> rets = </span></span></span><span data-slate-object="text" data-key="8458"><span data-slate-leaf="true" data-offset-key="8458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8459"><span data-slate-leaf="true" data-offset-key="8459:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8460"><span data-slate-object="text" data-key="8461"><span data-slate-leaf="true" data-offset-key="8461:0" data-first-offset="true"><span data-slate-string="true">    __asm__ __volatile__(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8462"><span data-slate-object="text" data-key="8463"><span data-slate-leaf="true" data-offset-key="8463:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8464"><span data-slate-leaf="true" data-offset-key="8464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushfl \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8465"><span data-slate-object="text" data-key="8466"><span data-slate-leaf="true" data-offset-key="8466:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8467"><span data-slate-leaf="true" data-offset-key="8467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popl %%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8468"><span data-slate-object="text" data-key="8469"><span data-slate-leaf="true" data-offset-key="8469:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8470"><span data-slate-leaf="true" data-offset-key="8470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movl %%eax,%%ebx \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8471"><span data-slate-object="text" data-key="8472"><span data-slate-leaf="true" data-offset-key="8472:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8473"><span data-slate-leaf="true" data-offset-key="8473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"xorl </span></span></span></span><span data-slate-object="text" data-key="8474"><span data-slate-leaf="true" data-offset-key="8474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0x0200000</span></span></span></span></span><span data-slate-object="text" data-key="8475"><span data-slate-leaf="true" data-offset-key="8475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8476"><span data-slate-object="text" data-key="8477"><span data-slate-leaf="true" data-offset-key="8477:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8478"><span data-slate-leaf="true" data-offset-key="8478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushl %%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8479"><span data-slate-object="text" data-key="8480"><span data-slate-leaf="true" data-offset-key="8480:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8481"><span data-slate-leaf="true" data-offset-key="8481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popfl \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8482"><span data-slate-object="text" data-key="8483"><span data-slate-leaf="true" data-offset-key="8483:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8484"><span data-slate-leaf="true" data-offset-key="8484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushfl \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8485"><span data-slate-object="text" data-key="8486"><span data-slate-leaf="true" data-offset-key="8486:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8487"><span data-slate-leaf="true" data-offset-key="8487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"popl %%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8488"><span data-slate-object="text" data-key="8489"><span data-slate-leaf="true" data-offset-key="8489:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8490"><span data-slate-leaf="true" data-offset-key="8490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"xorl %%ebx,%%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8491"><span data-slate-object="text" data-key="8492"><span data-slate-leaf="true" data-offset-key="8492:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8493"><span data-slate-leaf="true" data-offset-key="8493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jz 1f \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8494"><span data-slate-object="text" data-key="8495"><span data-slate-leaf="true" data-offset-key="8495:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8496"><span data-slate-leaf="true" data-offset-key="8496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movl </span></span></span></span><span data-slate-object="text" data-key="8497"><span data-slate-leaf="true" data-offset-key="8497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$1</span></span></span></span></span><span data-slate-object="text" data-key="8498"><span data-slate-leaf="true" data-offset-key="8498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%0 \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8499"><span data-slate-object="text" data-key="8500"><span data-slate-leaf="true" data-offset-key="8500:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8501"><span data-slate-leaf="true" data-offset-key="8501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jmp 2f \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8502"><span data-slate-object="text" data-key="8503"><span data-slate-leaf="true" data-offset-key="8503:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8504"><span data-slate-leaf="true" data-offset-key="8504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1: movl </span></span></span></span><span data-slate-object="text" data-key="8505"><span data-slate-leaf="true" data-offset-key="8505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0</span></span></span></span></span><span data-slate-object="text" data-key="8506"><span data-slate-leaf="true" data-offset-key="8506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%0 \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8507"><span data-slate-object="text" data-key="8508"><span data-slate-leaf="true" data-offset-key="8508:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8509"><span data-slate-leaf="true" data-offset-key="8509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2: \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8510"><span data-slate-object="text" data-key="8511"><span data-slate-leaf="true" data-offset-key="8511:0" data-first-offset="true"><span data-slate-string="true">        : </span></span></span><span data-slate-object="text" data-key="8512"><span data-slate-leaf="true" data-offset-key="8512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=c"</span></span></span></span><span data-slate-object="text" data-key="8513"><span data-slate-leaf="true" data-offset-key="8513:0" data-first-offset="true"><span data-slate-string="true">(rets)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8514"><span data-slate-object="text" data-key="8515"><span data-slate-leaf="true" data-offset-key="8515:0" data-first-offset="true"><span data-slate-string="true">        :</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8516"><span data-slate-object="text" data-key="8517"><span data-slate-leaf="true" data-offset-key="8517:0" data-first-offset="true"><span data-slate-string="true">        :);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8518"><span data-slate-object="text" data-key="8519"><span data-slate-leaf="true" data-offset-key="8519:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8520"><span data-slate-leaf="true" data-offset-key="8520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8521"><span data-slate-leaf="true" data-offset-key="8521:0" data-first-offset="true"><span data-slate-string="true"> rets;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8522"><span data-slate-object="text" data-key="8523"><span data-slate-leaf="true" data-offset-key="8523:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8524"><span data-slate-object="text" data-key="8525"><span data-slate-leaf="true" data-offset-key="8525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查 CPU 是否支持长模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8526"><span data-slate-object="text" data-key="8527"><span data-slate-leaf="true" data-offset-key="8527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8528"><span data-slate-leaf="true" data-offset-key="8528:0" data-first-offset="true"><span data-slate-string="true"> chk_cpu_longmode()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8529"><span data-slate-object="text" data-key="8530"><span data-slate-leaf="true" data-offset-key="8530:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8531"><span data-slate-object="text" data-key="8532"><span data-slate-leaf="true" data-offset-key="8532:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8533"><span data-slate-leaf="true" data-offset-key="8533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8534"><span data-slate-leaf="true" data-offset-key="8534:0" data-first-offset="true"><span data-slate-string="true"> rets = </span></span></span><span data-slate-object="text" data-key="8535"><span data-slate-leaf="true" data-offset-key="8535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8536"><span data-slate-leaf="true" data-offset-key="8536:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8537"><span data-slate-object="text" data-key="8538"><span data-slate-leaf="true" data-offset-key="8538:0" data-first-offset="true"><span data-slate-string="true">    __asm__ __volatile__(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8539"><span data-slate-object="text" data-key="8540"><span data-slate-leaf="true" data-offset-key="8540:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8541"><span data-slate-leaf="true" data-offset-key="8541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movl </span></span></span></span><span data-slate-object="text" data-key="8542"><span data-slate-leaf="true" data-offset-key="8542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0x80000000</span></span></span></span></span><span data-slate-object="text" data-key="8543"><span data-slate-leaf="true" data-offset-key="8543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8544"><span data-slate-object="text" data-key="8545"><span data-slate-leaf="true" data-offset-key="8545:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8546"><span data-slate-leaf="true" data-offset-key="8546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cpuid \n\t"</span></span></span></span><span data-slate-object="text" data-key="8547"><span data-slate-leaf="true" data-offset-key="8547:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8548"><span data-slate-leaf="true" data-offset-key="8548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 eax 中放入 0x80000000 调用 CPUID 指令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8549"><span data-slate-object="text" data-key="8550"><span data-slate-leaf="true" data-offset-key="8550:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8551"><span data-slate-leaf="true" data-offset-key="8551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cmpl </span></span></span></span><span data-slate-object="text" data-key="8552"><span data-slate-leaf="true" data-offset-key="8552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0x80000001</span></span></span></span></span><span data-slate-object="text" data-key="8553"><span data-slate-leaf="true" data-offset-key="8553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%%eax \n\t"</span></span></span></span><span data-slate-object="text" data-key="8554"><span data-slate-leaf="true" data-offset-key="8554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 看 eax 中返回结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8555"><span data-slate-object="text" data-key="8556"><span data-slate-leaf="true" data-offset-key="8556:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8557"><span data-slate-leaf="true" data-offset-key="8557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"setnb %%al \n\t"</span></span></span></span><span data-slate-object="text" data-key="8558"><span data-slate-leaf="true" data-offset-key="8558:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8559"><span data-slate-leaf="true" data-offset-key="8559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不为 0x80000001, 则不支持 0x80000001 号功能</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8560"><span data-slate-object="text" data-key="8561"><span data-slate-leaf="true" data-offset-key="8561:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8562"><span data-slate-leaf="true" data-offset-key="8562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jb 1f \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8563"><span data-slate-object="text" data-key="8564"><span data-slate-leaf="true" data-offset-key="8564:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8565"><span data-slate-leaf="true" data-offset-key="8565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movl </span></span></span></span><span data-slate-object="text" data-key="8566"><span data-slate-leaf="true" data-offset-key="8566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$0x80000001</span></span></span></span></span><span data-slate-object="text" data-key="8567"><span data-slate-leaf="true" data-offset-key="8567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8568"><span data-slate-object="text" data-key="8569"><span data-slate-leaf="true" data-offset-key="8569:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8570"><span data-slate-leaf="true" data-offset-key="8570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cpuid \n\t"</span></span></span></span><span data-slate-object="text" data-key="8571"><span data-slate-leaf="true" data-offset-key="8571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 eax 中放入 0x800000001 调用 CPUID 指令，检查 edx 中的返回数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8572"><span data-slate-object="text" data-key="8573"><span data-slate-leaf="true" data-offset-key="8573:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8574"><span data-slate-leaf="true" data-offset-key="8574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"bt </span></span></span></span><span data-slate-object="text" data-key="8575"><span data-slate-leaf="true" data-offset-key="8575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$29</span></span></span></span></span><span data-slate-object="text" data-key="8576"><span data-slate-leaf="true" data-offset-key="8576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,%%edx  \n\t"</span></span></span></span><span data-slate-object="text" data-key="8577"><span data-slate-leaf="true" data-offset-key="8577:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8578"><span data-slate-leaf="true" data-offset-key="8578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 长模式 支持位  是否为 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8579"><span data-slate-object="text" data-key="8580"><span data-slate-leaf="true" data-offset-key="8580:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8581"><span data-slate-leaf="true" data-offset-key="8581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"setcb %%al \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8582"><span data-slate-object="text" data-key="8583"><span data-slate-leaf="true" data-offset-key="8583:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8584"><span data-slate-leaf="true" data-offset-key="8584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1: \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8585"><span data-slate-object="text" data-key="8586"><span data-slate-leaf="true" data-offset-key="8586:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8587"><span data-slate-leaf="true" data-offset-key="8587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movzx %%al,%%eax \n\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8588"><span data-slate-object="text" data-key="8589"><span data-slate-leaf="true" data-offset-key="8589:0" data-first-offset="true"><span data-slate-string="true">        : </span></span></span><span data-slate-object="text" data-key="8590"><span data-slate-leaf="true" data-offset-key="8590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=a"</span></span></span></span><span data-slate-object="text" data-key="8591"><span data-slate-leaf="true" data-offset-key="8591:0" data-first-offset="true"><span data-slate-string="true">(rets)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8592"><span data-slate-object="text" data-key="8593"><span data-slate-leaf="true" data-offset-key="8593:0" data-first-offset="true"><span data-slate-string="true">        :</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8594"><span data-slate-object="text" data-key="8595"><span data-slate-leaf="true" data-offset-key="8595:0" data-first-offset="true"><span data-slate-string="true">        :);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8596"><span data-slate-object="text" data-key="8597"><span data-slate-leaf="true" data-offset-key="8597:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8598"><span data-slate-leaf="true" data-offset-key="8598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8599"><span data-slate-leaf="true" data-offset-key="8599:0" data-first-offset="true"><span data-slate-string="true"> rets;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8600"><span data-slate-object="text" data-key="8601"><span data-slate-leaf="true" data-offset-key="8601:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8602"><span data-slate-object="text" data-key="8603"><span data-slate-leaf="true" data-offset-key="8603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查 CPU 主函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8604"><span data-slate-object="text" data-key="8605"><span data-slate-leaf="true" data-offset-key="8605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="8606"><span data-slate-leaf="true" data-offset-key="8606:0" data-first-offset="true"><span data-slate-string="true"> init_chkcpu(machbstart_t *mbsp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8607"><span data-slate-object="text" data-key="8608"><span data-slate-leaf="true" data-offset-key="8608:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8609"><span data-slate-object="text" data-key="8610"><span data-slate-leaf="true" data-offset-key="8610:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8611"><span data-slate-leaf="true" data-offset-key="8611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8612"><span data-slate-leaf="true" data-offset-key="8612:0" data-first-offset="true"><span data-slate-string="true"> (!chk_cpuid())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8613"><span data-slate-object="text" data-key="8614"><span data-slate-leaf="true" data-offset-key="8614:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8615"><span data-slate-object="text" data-key="8616"><span data-slate-leaf="true" data-offset-key="8616:0" data-first-offset="true"><span data-slate-string="true">        kerror(</span></span></span><span data-slate-object="text" data-key="8617"><span data-slate-leaf="true" data-offset-key="8617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Your CPU is not support CPUID sys is die!"</span></span></span></span><span data-slate-object="text" data-key="8618"><span data-slate-leaf="true" data-offset-key="8618:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8619"><span data-slate-object="text" data-key="8620"><span data-slate-leaf="true" data-offset-key="8620:0" data-first-offset="true"><span data-slate-string="true">        CLI_HALT();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8621"><span data-slate-object="text" data-key="8622"><span data-slate-leaf="true" data-offset-key="8622:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8623"><span data-slate-object="text" data-key="8624"><span data-slate-leaf="true" data-offset-key="8624:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8625"><span data-slate-leaf="true" data-offset-key="8625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8626"><span data-slate-leaf="true" data-offset-key="8626:0" data-first-offset="true"><span data-slate-string="true"> (!chk_cpu_longmode())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8627"><span data-slate-object="text" data-key="8628"><span data-slate-leaf="true" data-offset-key="8628:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8629"><span data-slate-object="text" data-key="8630"><span data-slate-leaf="true" data-offset-key="8630:0" data-first-offset="true"><span data-slate-string="true">        kerror(</span></span></span><span data-slate-object="text" data-key="8631"><span data-slate-leaf="true" data-offset-key="8631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Your CPU is not support 64bits mode sys is die!"</span></span></span></span><span data-slate-object="text" data-key="8632"><span data-slate-leaf="true" data-offset-key="8632:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8633"><span data-slate-object="text" data-key="8634"><span data-slate-leaf="true" data-offset-key="8634:0" data-first-offset="true"><span data-slate-string="true">        CLI_HALT();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8635"><span data-slate-object="text" data-key="8636"><span data-slate-leaf="true" data-offset-key="8636:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8637"><span data-slate-object="text" data-key="8638"><span data-slate-leaf="true" data-offset-key="8638:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_cpumode = </span></span></span><span data-slate-object="text" data-key="8639"><span data-slate-leaf="true" data-offset-key="8639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x40</span></span></span></span><span data-slate-object="text" data-key="8640"><span data-slate-leaf="true" data-offset-key="8640:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span><span data-slate-object="text" data-key="8641"><span data-slate-leaf="true" data-offset-key="8641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果成功则设置机器信息结构的 cpu 模式为 64 位</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8642"><span data-slate-object="text" data-key="8643"><span data-slate-leaf="true" data-offset-key="8643:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8644"><span data-slate-leaf="true" data-offset-key="8644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8645"><span data-slate-leaf="true" data-offset-key="8645:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8646"><span data-slate-object="text" data-key="8647"><span data-slate-leaf="true" data-offset-key="8647:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8648"><span data-slate-object="text" data-key="8649"><span data-slate-leaf="true" data-offset-key="8649:0" data-first-offset="true"><span data-slate-string="true">上述代码中，检查 CPU 是否支持 CPUID 指令和检查 CPU 是否支持长模式，只要其中一步检查失败，我们就打印一条相应的提示信息，然后主动死机。</span></span></span><span data-slate-object="text" data-key="8650"><span data-slate-leaf="true" data-offset-key="8650:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这里需要你留意的是，最后设置机器信息结构中的 mb_cpumode 字段为 64,mbsp 正是传递进来的机器信息 machbstart_t 结构体的指针。</span></span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8651" id="sr-toc-3"><span data-slate-object="text" data-key="8652"><span data-slate-leaf="true" data-offset-key="8652:0" data-first-offset="true"><span data-slate-string="true">获取内存布局</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8653"><span data-slate-object="text" data-key="8654"><span data-slate-leaf="true" data-offset-key="8654:0" data-first-offset="true"><span data-slate-string="true">好了，CPU 已经检查完成 ，合乎我们的要求。下面就要获取内存布局信息了，物理内存在物理地址空间中是一段一段的，描述一段内存有一个数据结构，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8655"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8656"><span data-slate-object="text" data-key="8657"><span data-slate-leaf="true" data-offset-key="8657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8658"><span data-slate-leaf="true" data-offset-key="8658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8659"><span data-slate-leaf="true" data-offset-key="8659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> RAM_USABLE 1 </span></span></span></span><span data-slate-object="text" data-key="8660"><span data-slate-leaf="true" data-offset-key="8660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 可用内存</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8661"><span data-slate-object="text" data-key="8662"><span data-slate-leaf="true" data-offset-key="8662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8663"><span data-slate-leaf="true" data-offset-key="8663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8664"><span data-slate-leaf="true" data-offset-key="8664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> RAM_RESERV 2 </span></span></span></span><span data-slate-object="text" data-key="8665"><span data-slate-leaf="true" data-offset-key="8665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保留内存不可使用</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8666"><span data-slate-object="text" data-key="8667"><span data-slate-leaf="true" data-offset-key="8667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8668"><span data-slate-leaf="true" data-offset-key="8668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8669"><span data-slate-leaf="true" data-offset-key="8669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> RAM_ACPIREC 3 </span></span></span></span><span data-slate-object="text" data-key="8670"><span data-slate-leaf="true" data-offset-key="8670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//ACPI 表相关的</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8671"><span data-slate-object="text" data-key="8672"><span data-slate-leaf="true" data-offset-key="8672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8673"><span data-slate-leaf="true" data-offset-key="8673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8674"><span data-slate-leaf="true" data-offset-key="8674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> RAM_ACPINVS 4 </span></span></span></span><span data-slate-object="text" data-key="8675"><span data-slate-leaf="true" data-offset-key="8675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//ACPI NVS 空间</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8676"><span data-slate-object="text" data-key="8677"><span data-slate-leaf="true" data-offset-key="8677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8678"><span data-slate-leaf="true" data-offset-key="8678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8679"><span data-slate-leaf="true" data-offset-key="8679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> RAM_AREACON 5 </span></span></span></span><span data-slate-object="text" data-key="8680"><span data-slate-leaf="true" data-offset-key="8680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 包含坏内存</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8681"><span data-slate-object="text" data-key="8682"><span data-slate-leaf="true" data-offset-key="8682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="8683"><span data-slate-leaf="true" data-offset-key="8683:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8684"><span data-slate-leaf="true" data-offset-key="8684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="8685"><span data-slate-leaf="true" data-offset-key="8685:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8686"><span data-slate-leaf="true" data-offset-key="8686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_e820</span></span></span></span><span data-slate-object="text" data-key="8687"><span data-slate-leaf="true" data-offset-key="8687:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8688"><span data-slate-object="text" data-key="8689"><span data-slate-leaf="true" data-offset-key="8689:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8690"><span data-slate-leaf="true" data-offset-key="8690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="8691"><span data-slate-leaf="true" data-offset-key="8691:0" data-first-offset="true"><span data-slate-string="true"> saddr;    </span></span></span><span data-slate-object="text" data-key="8692"><span data-slate-leaf="true" data-offset-key="8692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 内存开始地址 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8693"><span data-slate-object="text" data-key="8694"><span data-slate-leaf="true" data-offset-key="8694:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8695"><span data-slate-leaf="true" data-offset-key="8695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="8696"><span data-slate-leaf="true" data-offset-key="8696:0" data-first-offset="true"><span data-slate-string="true"> lsize;    </span></span></span><span data-slate-object="text" data-key="8697"><span data-slate-leaf="true" data-offset-key="8697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 内存大小 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8698"><span data-slate-object="text" data-key="8699"><span data-slate-leaf="true" data-offset-key="8699:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8700"><span data-slate-leaf="true" data-offset-key="8700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="8701"><span data-slate-leaf="true" data-offset-key="8701:0" data-first-offset="true"><span data-slate-string="true"> type;    </span></span></span><span data-slate-object="text" data-key="8702"><span data-slate-leaf="true" data-offset-key="8702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 内存类型 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8703"><span data-slate-object="text" data-key="8704"><span data-slate-leaf="true" data-offset-key="8704:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="8705"><span data-slate-leaf="true" data-offset-key="8705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span><span data-slate-object="text" data-key="8706"><span data-slate-leaf="true" data-offset-key="8706:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8707"><span data-slate-object="text" data-key="8708"><span data-slate-leaf="true" data-offset-key="8708:0" data-first-offset="true"><span data-slate-string="true">获取内存布局信息就是获取这个结构体的数组，这个工作我们交给 init_mem 函数来干，这个函数需要完成两件事：一是获取上述这个结构体数组，二是检查内存大小，因为我们的内核对内存容量有要求，不能太小。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8709"><span data-slate-object="text" data-key="8710"><span data-slate-leaf="true" data-offset-key="8710:0" data-first-offset="true"><span data-slate-string="true">下面我们来动手实现这个 init_mem 函数。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8711"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8712"><span data-slate-object="text" data-key="8713"><span data-slate-leaf="true" data-offset-key="8713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8714"><span data-slate-leaf="true" data-offset-key="8714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8715"><span data-slate-leaf="true" data-offset-key="8715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ETYBAK_ADR 0x2000</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8716"><span data-slate-object="text" data-key="8717"><span data-slate-leaf="true" data-offset-key="8717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8718"><span data-slate-leaf="true" data-offset-key="8718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8719"><span data-slate-leaf="true" data-offset-key="8719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PM32_EIP_OFF (ETYBAK_ADR)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8720"><span data-slate-object="text" data-key="8721"><span data-slate-leaf="true" data-offset-key="8721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8722"><span data-slate-leaf="true" data-offset-key="8722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8723"><span data-slate-leaf="true" data-offset-key="8723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PM32_ESP_OFF (ETYBAK_ADR+4)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8724"><span data-slate-object="text" data-key="8725"><span data-slate-leaf="true" data-offset-key="8725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8726"><span data-slate-leaf="true" data-offset-key="8726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8727"><span data-slate-leaf="true" data-offset-key="8727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> E80MAP_NR (ETYBAK_ADR+64)</span></span></span></span><span data-slate-object="text" data-key="8728"><span data-slate-leaf="true" data-offset-key="8728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存 e820map_t 结构数组元素个数的地址</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8729"><span data-slate-object="text" data-key="8730"><span data-slate-leaf="true" data-offset-key="8730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8731"><span data-slate-leaf="true" data-offset-key="8731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8732"><span data-slate-leaf="true" data-offset-key="8732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> E80MAP_ADRADR (ETYBAK_ADR+68) </span></span></span></span><span data-slate-object="text" data-key="8733"><span data-slate-leaf="true" data-offset-key="8733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存 e820map_t 结构数组的开始地址</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8734"><span data-slate-object="text" data-key="8735"><span data-slate-leaf="true" data-offset-key="8735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="8736"><span data-slate-leaf="true" data-offset-key="8736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8737"><span data-slate-leaf="true" data-offset-key="8737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_mem</span></span></span></span></span><span data-slate-object="text" data-key="8738"><span data-slate-leaf="true" data-offset-key="8738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="8739"><span data-slate-leaf="true" data-offset-key="8739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="8740"><span data-slate-leaf="true" data-offset-key="8740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *mbsp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8741"><span data-slate-object="text" data-key="8742"><span data-slate-leaf="true" data-offset-key="8742:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8743"><span data-slate-object="text" data-key="8744"><span data-slate-leaf="true" data-offset-key="8744:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8745"><span data-slate-leaf="true" data-offset-key="8745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span><span data-slate-object="text" data-key="8746"><span data-slate-leaf="true" data-offset-key="8746:0" data-first-offset="true"><span data-slate-string="true"> *retemp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8747"><span data-slate-object="text" data-key="8748"><span data-slate-leaf="true" data-offset-key="8748:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8749"><span data-slate-leaf="true" data-offset-key="8749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="8750"><span data-slate-leaf="true" data-offset-key="8750:0" data-first-offset="true"><span data-slate-string="true"> retemnr = </span></span></span><span data-slate-object="text" data-key="8751"><span data-slate-leaf="true" data-offset-key="8751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8752"><span data-slate-leaf="true" data-offset-key="8752:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8753"><span data-slate-object="text" data-key="8754"><span data-slate-leaf="true" data-offset-key="8754:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8755"><span data-slate-leaf="true" data-offset-key="8755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mmap</span></span></span></span><span data-slate-object="text" data-key="8756"><span data-slate-leaf="true" data-offset-key="8756:0" data-first-offset="true"><span data-slate-string="true">(&amp;retemp, &amp;retemnr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8757"><span data-slate-object="text" data-key="8758"><span data-slate-leaf="true" data-offset-key="8758:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8759"><span data-slate-leaf="true" data-offset-key="8759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8760"><span data-slate-leaf="true" data-offset-key="8760:0" data-first-offset="true"><span data-slate-string="true"> (retemnr == </span></span></span><span data-slate-object="text" data-key="8761"><span data-slate-leaf="true" data-offset-key="8761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8762"><span data-slate-leaf="true" data-offset-key="8762:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8763"><span data-slate-object="text" data-key="8764"><span data-slate-leaf="true" data-offset-key="8764:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8765"><span data-slate-object="text" data-key="8766"><span data-slate-leaf="true" data-offset-key="8766:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8767"><span data-slate-leaf="true" data-offset-key="8767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="8768"><span data-slate-leaf="true" data-offset-key="8768:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8769"><span data-slate-leaf="true" data-offset-key="8769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"no e820map\n"</span></span></span></span><span data-slate-object="text" data-key="8770"><span data-slate-leaf="true" data-offset-key="8770:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8771"><span data-slate-object="text" data-key="8772"><span data-slate-leaf="true" data-offset-key="8772:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8773"><span data-slate-object="text" data-key="8774"><span data-slate-leaf="true" data-offset-key="8774:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8775"><span data-slate-leaf="true" data-offset-key="8775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据 e820map_t 结构数据检查内存大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8776"><span data-slate-object="text" data-key="8777"><span data-slate-leaf="true" data-offset-key="8777:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8778"><span data-slate-leaf="true" data-offset-key="8778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8779"><span data-slate-leaf="true" data-offset-key="8779:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="8780"><span data-slate-leaf="true" data-offset-key="8780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chk_memsize</span></span></span></span><span data-slate-object="text" data-key="8781"><span data-slate-leaf="true" data-offset-key="8781:0" data-first-offset="true"><span data-slate-string="true">(retemp, retemnr, </span></span></span><span data-slate-object="text" data-key="8782"><span data-slate-leaf="true" data-offset-key="8782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x100000</span></span></span></span><span data-slate-object="text" data-key="8783"><span data-slate-leaf="true" data-offset-key="8783:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="8784"><span data-slate-leaf="true" data-offset-key="8784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x8000000</span></span></span></span><span data-slate-object="text" data-key="8785"><span data-slate-leaf="true" data-offset-key="8785:0" data-first-offset="true"><span data-slate-string="true">) == </span></span></span><span data-slate-object="text" data-key="8786"><span data-slate-leaf="true" data-offset-key="8786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="8787"><span data-slate-leaf="true" data-offset-key="8787:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8788"><span data-slate-object="text" data-key="8789"><span data-slate-leaf="true" data-offset-key="8789:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8790"><span data-slate-object="text" data-key="8791"><span data-slate-leaf="true" data-offset-key="8791:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8792"><span data-slate-leaf="true" data-offset-key="8792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="8793"><span data-slate-leaf="true" data-offset-key="8793:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8794"><span data-slate-leaf="true" data-offset-key="8794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Your computer is low on memory, the memory cannot be less than 128MB!"</span></span></span></span><span data-slate-object="text" data-key="8795"><span data-slate-leaf="true" data-offset-key="8795:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8796"><span data-slate-object="text" data-key="8797"><span data-slate-leaf="true" data-offset-key="8797:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8798"><span data-slate-object="text" data-key="8799"><span data-slate-leaf="true" data-offset-key="8799:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_e820padr = (</span></span></span><span data-slate-object="text" data-key="8800"><span data-slate-leaf="true" data-offset-key="8800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="8801"><span data-slate-leaf="true" data-offset-key="8801:0" data-first-offset="true"><span data-slate-string="true">)((</span></span></span><span data-slate-object="text" data-key="8802"><span data-slate-leaf="true" data-offset-key="8802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="8803"><span data-slate-leaf="true" data-offset-key="8803:0" data-first-offset="true"><span data-slate-string="true">)(retemp));</span></span></span><span data-slate-object="text" data-key="8804"><span data-slate-leaf="true" data-offset-key="8804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 e820map_t 结构数组的首地址传给 mbsp-&gt;mb_e820padr </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8805"><span data-slate-object="text" data-key="8806"><span data-slate-leaf="true" data-offset-key="8806:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_e820nr = (</span></span></span><span data-slate-object="text" data-key="8807"><span data-slate-leaf="true" data-offset-key="8807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="8808"><span data-slate-leaf="true" data-offset-key="8808:0" data-first-offset="true"><span data-slate-string="true">)retemnr;</span></span></span><span data-slate-object="text" data-key="8809"><span data-slate-leaf="true" data-offset-key="8809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 e820map_t 结构数组元素个数传给 mbsp-&gt;mb_e820nr </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8810"><span data-slate-object="text" data-key="8811"><span data-slate-leaf="true" data-offset-key="8811:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_e820sz = retemnr * (</span></span></span><span data-slate-object="text" data-key="8812"><span data-slate-leaf="true" data-offset-key="8812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="8813"><span data-slate-leaf="true" data-offset-key="8813:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8814"><span data-slate-leaf="true" data-offset-key="8814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span><span data-slate-object="text" data-key="8815"><span data-slate-leaf="true" data-offset-key="8815:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span><span data-slate-object="text" data-key="8816"><span data-slate-leaf="true" data-offset-key="8816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 e820map_t 结构数组大小传给 mbsp-&gt;mb_e820sz </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8817"><span data-slate-object="text" data-key="8818"><span data-slate-leaf="true" data-offset-key="8818:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_memsz = </span></span></span><span data-slate-object="text" data-key="8819"><span data-slate-leaf="true" data-offset-key="8819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get_memsize</span></span></span></span><span data-slate-object="text" data-key="8820"><span data-slate-leaf="true" data-offset-key="8820:0" data-first-offset="true"><span data-slate-string="true">(retemp, retemnr);</span></span></span><span data-slate-object="text" data-key="8821"><span data-slate-leaf="true" data-offset-key="8821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据 e820map_t 结构数据计算内存大小。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8822"><span data-slate-object="text" data-key="8823"><span data-slate-leaf="true" data-offset-key="8823:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8824"><span data-slate-leaf="true" data-offset-key="8824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8825"><span data-slate-leaf="true" data-offset-key="8825:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8826"><span data-slate-object="text" data-key="8827"><span data-slate-leaf="true" data-offset-key="8827:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8828"><span data-slate-object="text" data-key="8829"><span data-slate-leaf="true" data-offset-key="8829:0" data-first-offset="true"><span data-slate-string="true">上面最难写的是 mmap 函数。不过，我们还是有办法破解的。如果你理解了前面调用 BIOS 的机制，就会发现，</span></span></span><span data-slate-object="text" data-key="8830"><span data-slate-leaf="true" data-offset-key="8830:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">只要调用了 BIOS 中断，就能获取 e820map 结构数组</span></span></span></span><span data-slate-object="text" data-key="8831"><span data-slate-leaf="true" data-offset-key="8831:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8832"><span data-slate-object="text" data-key="8833"><span data-slate-leaf="true" data-offset-key="8833:0" data-first-offset="true"><span data-slate-string="true">为了验证这个结论，我们来看一下 mmap 的函数调用关系：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8834"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8835"><span data-slate-object="text" data-key="8836"><span data-slate-leaf="true" data-offset-key="8836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="8837"><span data-slate-leaf="true" data-offset-key="8837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8838"><span data-slate-leaf="true" data-offset-key="8838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mmap</span></span></span></span></span><span data-slate-object="text" data-key="8839"><span data-slate-leaf="true" data-offset-key="8839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="8840"><span data-slate-leaf="true" data-offset-key="8840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span></span></span><span data-slate-object="text" data-key="8841"><span data-slate-leaf="true" data-offset-key="8841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> **retemp, </span></span></span></span></span><span data-slate-object="text" data-key="8842"><span data-slate-leaf="true" data-offset-key="8842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span></span></span><span data-slate-object="text" data-key="8843"><span data-slate-leaf="true" data-offset-key="8843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *retemnr)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8844"><span data-slate-object="text" data-key="8845"><span data-slate-leaf="true" data-offset-key="8845:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8846"><span data-slate-object="text" data-key="8847"><span data-slate-leaf="true" data-offset-key="8847:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8848"><span data-slate-leaf="true" data-offset-key="8848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">realadr_call_entry</span></span></span></span><span data-slate-object="text" data-key="8849"><span data-slate-leaf="true" data-offset-key="8849:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8850"><span data-slate-leaf="true" data-offset-key="8850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RLINTNR</span></span></span></span><span data-slate-object="text" data-key="8851"><span data-slate-leaf="true" data-offset-key="8851:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8852"><span data-slate-leaf="true" data-offset-key="8852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8853"><span data-slate-leaf="true" data-offset-key="8853:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="8854"><span data-slate-leaf="true" data-offset-key="8854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8855"><span data-slate-leaf="true" data-offset-key="8855:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="8856"><span data-slate-leaf="true" data-offset-key="8856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8857"><span data-slate-leaf="true" data-offset-key="8857:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8858"><span data-slate-object="text" data-key="8859"><span data-slate-leaf="true" data-offset-key="8859:0" data-first-offset="true"><span data-slate-string="true">    *retemnr = *((</span></span></span><span data-slate-object="text" data-key="8860"><span data-slate-leaf="true" data-offset-key="8860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="8861"><span data-slate-leaf="true" data-offset-key="8861:0" data-first-offset="true"><span data-slate-string="true"> *)(E80MAP_NR));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8862"><span data-slate-object="text" data-key="8863"><span data-slate-leaf="true" data-offset-key="8863:0" data-first-offset="true"><span data-slate-string="true">    *retemp = (</span></span></span><span data-slate-object="text" data-key="8864"><span data-slate-leaf="true" data-offset-key="8864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span><span data-slate-object="text" data-key="8865"><span data-slate-leaf="true" data-offset-key="8865:0" data-first-offset="true"><span data-slate-string="true"> *)(*((</span></span></span><span data-slate-object="text" data-key="8866"><span data-slate-leaf="true" data-offset-key="8866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="8867"><span data-slate-leaf="true" data-offset-key="8867:0" data-first-offset="true"><span data-slate-string="true"> *)(E80MAP_ADRADR)));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8868"><span data-slate-object="text" data-key="8869"><span data-slate-leaf="true" data-offset-key="8869:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8870"><span data-slate-leaf="true" data-offset-key="8870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8871"><span data-slate-leaf="true" data-offset-key="8871:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8872"><span data-slate-object="text" data-key="8873"><span data-slate-leaf="true" data-offset-key="8873:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8874"><span data-slate-object="text" data-key="8875"><span data-slate-leaf="true" data-offset-key="8875:0" data-first-offset="true"><span data-slate-string="true">可以看到，mmap 函数正是通过前面讲的 </span></span></span><span data-slate-object="text" data-key="8876"><span data-slate-leaf="true" data-offset-key="8876:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">realadr_call_entry 函数</span></span></span></span><span data-slate-object="text" data-key="8877"><span data-slate-leaf="true" data-offset-key="8877:0" data-first-offset="true"><span data-slate-string="true">，来调用实模式下的 _getmmap 函数的，并且在 _getmmap 函数中调用 BIOS 中断的。</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="8878"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8879"><span data-slate-object="text" data-key="8880"><span data-slate-leaf="true" data-offset-key="8880:0" data-first-offset="true"><span data-slate-string="true">_getmmap:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8881"><span data-slate-object="text" data-key="8882"><span data-slate-leaf="true" data-offset-key="8882:0" data-first-offset="true"><span data-slate-string="true">  push ds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8883"><span data-slate-object="text" data-key="8884"><span data-slate-leaf="true" data-offset-key="8884:0" data-first-offset="true"><span data-slate-string="true">  push es</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8885"><span data-slate-object="text" data-key="8886"><span data-slate-leaf="true" data-offset-key="8886:0" data-first-offset="true"><span data-slate-string="true">  push ss</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8887"><span data-slate-object="text" data-key="8888"><span data-slate-leaf="true" data-offset-key="8888:0" data-first-offset="true"><span data-slate-string="true">  mov esi,</span></span></span><span data-slate-object="text" data-key="8889"><span data-slate-leaf="true" data-offset-key="8889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8890"><span data-slate-object="text" data-key="8891"><span data-slate-leaf="true" data-offset-key="8891:0" data-first-offset="true"><span data-slate-string="true">  mov dword[E80MAP_NR],esi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8892"><span data-slate-object="text" data-key="8893"><span data-slate-leaf="true" data-offset-key="8893:0" data-first-offset="true"><span data-slate-string="true">  mov dword [E80MAP_ADRADR],E80MAP_ADR ;e820map 结构体开始地址</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8894"><span data-slate-object="text" data-key="8895"><span data-slate-leaf="true" data-offset-key="8895:0" data-first-offset="true"><span data-slate-string="true">  xor ebx,ebx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8896"><span data-slate-object="text" data-key="8897"><span data-slate-leaf="true" data-offset-key="8897:0" data-first-offset="true"><span data-slate-string="true">  mov edi,E80MAP_ADR</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8898"><span data-slate-object="text" data-key="8899"><span data-slate-leaf="true" data-offset-key="8899:0" data-first-offset="true"><span data-slate-string="true">loop:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8900"><span data-slate-object="text" data-key="8901"><span data-slate-leaf="true" data-offset-key="8901:0" data-first-offset="true"><span data-slate-string="true">  mov eax,</span></span></span><span data-slate-object="text" data-key="8902"><span data-slate-leaf="true" data-offset-key="8902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8903"><span data-slate-leaf="true" data-offset-key="8903:0" data-first-offset="true"><span data-slate-string="true">e820h ; 获取 e820map 结构参数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8904"><span data-slate-object="text" data-key="8905"><span data-slate-leaf="true" data-offset-key="8905:0" data-first-offset="true"><span data-slate-string="true">  mov ecx,</span></span></span><span data-slate-object="text" data-key="8906"><span data-slate-leaf="true" data-offset-key="8906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span><span data-slate-object="text" data-key="8907"><span data-slate-leaf="true" data-offset-key="8907:0" data-first-offset="true"><span data-slate-string="true">    ;e820map 结构大小</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8908"><span data-slate-object="text" data-key="8909"><span data-slate-leaf="true" data-offset-key="8909:0" data-first-offset="true"><span data-slate-string="true">  mov edx,</span></span></span><span data-slate-object="text" data-key="8910"><span data-slate-leaf="true" data-offset-key="8910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0534</span></span></span></span><span data-slate-object="text" data-key="8911"><span data-slate-leaf="true" data-offset-key="8911:0" data-first-offset="true"><span data-slate-string="true">d4150h ; 获取 e820map 结构参数必须是这个数据</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8912"><span data-slate-object="text" data-key="8913"><span data-slate-leaf="true" data-offset-key="8913:0" data-first-offset="true"><span data-slate-string="true">  int </span></span></span><span data-slate-object="text" data-key="8914"><span data-slate-leaf="true" data-offset-key="8914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">15</span></span></span></span><span data-slate-object="text" data-key="8915"><span data-slate-leaf="true" data-offset-key="8915:0" data-first-offset="true"><span data-slate-string="true">h  ;BIOS 的</span></span></span><span data-slate-object="text" data-key="8916"><span data-slate-leaf="true" data-offset-key="8916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 15</span></span></span></span><span data-slate-object="text" data-key="8917"><span data-slate-leaf="true" data-offset-key="8917:0" data-first-offset="true"><span data-slate-string="true">h 中断</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8918"><span data-slate-object="text" data-key="8919"><span data-slate-leaf="true" data-offset-key="8919:0" data-first-offset="true"><span data-slate-string="true">  jc .</span></span></span><span data-slate-object="text" data-key="8920"><span data-slate-leaf="true" data-offset-key="8920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8921"><span data-slate-object="text" data-key="8922"><span data-slate-leaf="true" data-offset-key="8922:0" data-first-offset="true"><span data-slate-string="true">  add edi,</span></span></span><span data-slate-object="text" data-key="8923"><span data-slate-leaf="true" data-offset-key="8923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8924"><span data-slate-object="text" data-key="8925"><span data-slate-leaf="true" data-offset-key="8925:0" data-first-offset="true"><span data-slate-string="true">  cmp edi,E80MAP_ADR+</span></span></span><span data-slate-object="text" data-key="8926"><span data-slate-leaf="true" data-offset-key="8926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8927"><span data-slate-leaf="true" data-offset-key="8927:0" data-first-offset="true"><span data-slate-string="true">x1000</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8928"><span data-slate-object="text" data-key="8929"><span data-slate-leaf="true" data-offset-key="8929:0" data-first-offset="true"><span data-slate-string="true">  jg .</span></span></span><span data-slate-object="text" data-key="8930"><span data-slate-leaf="true" data-offset-key="8930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8931"><span data-slate-object="text" data-key="8932"><span data-slate-leaf="true" data-offset-key="8932:0" data-first-offset="true"><span data-slate-string="true">  inc esi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8933"><span data-slate-object="text" data-key="8934"><span data-slate-leaf="true" data-offset-key="8934:0" data-first-offset="true"><span data-slate-string="true">  cmp ebx,</span></span></span><span data-slate-object="text" data-key="8935"><span data-slate-leaf="true" data-offset-key="8935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8936"><span data-slate-object="text" data-key="8937"><span data-slate-leaf="true" data-offset-key="8937:0" data-first-offset="true"><span data-slate-string="true">  jne loop ; 循环获取 e820map 结构</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8938"><span data-slate-object="text" data-key="8939"><span data-slate-leaf="true" data-offset-key="8939:0" data-first-offset="true"><span data-slate-string="true">  jmp .</span></span></span><span data-slate-object="text" data-key="8940"><span data-slate-leaf="true" data-offset-key="8940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8941"><span data-slate-object="text" data-key="8942"><span data-slate-leaf="true" data-offset-key="8942:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="8943"><span data-slate-leaf="true" data-offset-key="8943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="8944"><span data-slate-leaf="true" data-offset-key="8944:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8945"><span data-slate-object="text" data-key="8946"><span data-slate-leaf="true" data-offset-key="8946:0" data-first-offset="true"><span data-slate-string="true">  mov esi,</span></span></span><span data-slate-object="text" data-key="8947"><span data-slate-leaf="true" data-offset-key="8947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8948"><span data-slate-leaf="true" data-offset-key="8948:0" data-first-offset="true"><span data-slate-string="true">    ; 出错处理，e820map 结构数组元素个数为</span></span></span><span data-slate-object="text" data-key="8949"><span data-slate-leaf="true" data-offset-key="8949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8950"><span data-slate-object="text" data-key="8951"><span data-slate-leaf="true" data-offset-key="8951:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="8952"><span data-slate-leaf="true" data-offset-key="8952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="8953"><span data-slate-leaf="true" data-offset-key="8953:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8954"><span data-slate-object="text" data-key="8955"><span data-slate-leaf="true" data-offset-key="8955:0" data-first-offset="true"><span data-slate-string="true">  mov dword [E80MAP_NR],esi ;e820map 结构数组元素个数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8956"><span data-slate-object="text" data-key="8957"><span data-slate-leaf="true" data-offset-key="8957:0" data-first-offset="true"><span data-slate-string="true">  pop ss</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8958"><span data-slate-object="text" data-key="8959"><span data-slate-leaf="true" data-offset-key="8959:0" data-first-offset="true"><span data-slate-string="true">  pop es</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8960"><span data-slate-object="text" data-key="8961"><span data-slate-leaf="true" data-offset-key="8961:0" data-first-offset="true"><span data-slate-string="true">  pop ds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8962"><span data-slate-object="text" data-key="8963"><span data-slate-leaf="true" data-offset-key="8963:0" data-first-offset="true"><span data-slate-string="true">  ret</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8964"><span data-slate-object="text" data-key="8965"><span data-slate-leaf="true" data-offset-key="8965:0" data-first-offset="true"><span data-slate-string="true">如果你不明白上面代码的原理，请回到 “Cache 与内存：程序放在哪儿” </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8966"><span data-slate-object="text" data-key="8967"><span data-slate-leaf="true" data-offset-key="8967:0" data-first-offset="true"><span data-slate-string="true">那节课</span></span></span></a><span data-slate-object="text" data-key="8968"><span data-slate-leaf="true" data-offset-key="8968:0" data-first-offset="true"><span data-slate-string="true">，看一下获取内存视图相关的知识点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8969"><span data-slate-object="text" data-key="8970"><span data-slate-leaf="true" data-offset-key="8970:0" data-first-offset="true"><span data-slate-string="true">init_mem 函数在调用 mmap 函数后，就会得到 e820map 结构数组，其首地址和数组元素个数由 retemp，retemnr 两个变量分别提供。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8971" id="sr-toc-4"><span data-slate-object="text" data-key="8972"><span data-slate-leaf="true" data-offset-key="8972:0" data-first-offset="true"><span data-slate-string="true">初始化内核栈</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8973"><span data-slate-object="text" data-key="8974"><span data-slate-leaf="true" data-offset-key="8974:0" data-first-offset="true"><span data-slate-string="true">因为我们的操作系统是 C 语言写的，所以需要有栈，下面我们就来给即将运行的内核初始化一个栈。这个操作非常简单，就是在机器信息结构 machbstart_t 中，记录一下栈地址和栈大小，供内核在启动时使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8975"><span data-slate-object="text" data-key="8976"><span data-slate-leaf="true" data-offset-key="8976:0" data-first-offset="true"><span data-slate-string="true">不过，就算操作再简单，我们也要封装成函数来使用。让我们动手来写出这个函数吧，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8977"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8978"><span data-slate-object="text" data-key="8979"><span data-slate-leaf="true" data-offset-key="8979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8980"><span data-slate-leaf="true" data-offset-key="8980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8981"><span data-slate-leaf="true" data-offset-key="8981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> IKSTACK_PHYADR (0x90000-0x10)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8982"><span data-slate-object="text" data-key="8983"><span data-slate-leaf="true" data-offset-key="8983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="8984"><span data-slate-leaf="true" data-offset-key="8984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="8985"><span data-slate-leaf="true" data-offset-key="8985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> IKSTACK_SIZE 0x1000</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8986"><span data-slate-object="text" data-key="8987"><span data-slate-leaf="true" data-offset-key="8987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8988"><span data-slate-object="text" data-key="8989"><span data-slate-leaf="true" data-offset-key="8989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="8990"><span data-slate-leaf="true" data-offset-key="8990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8991"><span data-slate-leaf="true" data-offset-key="8991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlinitstack</span></span></span></span></span><span data-slate-object="text" data-key="8992"><span data-slate-leaf="true" data-offset-key="8992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="8993"><span data-slate-leaf="true" data-offset-key="8993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="8994"><span data-slate-leaf="true" data-offset-key="8994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *mbsp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8995"><span data-slate-object="text" data-key="8996"><span data-slate-leaf="true" data-offset-key="8996:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8997"><span data-slate-object="text" data-key="8998"><span data-slate-leaf="true" data-offset-key="8998:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8999"><span data-slate-leaf="true" data-offset-key="8999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9000"><span data-slate-leaf="true" data-offset-key="9000:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9001"><span data-slate-leaf="true" data-offset-key="9001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9002"><span data-slate-leaf="true" data-offset-key="9002:0" data-first-offset="true"><span data-slate-string="true"> &gt; </span></span></span><span data-slate-object="text" data-key="9003"><span data-slate-leaf="true" data-offset-key="9003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">move_krlimg</span></span></span></span><span data-slate-object="text" data-key="9004"><span data-slate-leaf="true" data-offset-key="9004:0" data-first-offset="true"><span data-slate-string="true">(mbsp, (</span></span></span><span data-slate-object="text" data-key="9005"><span data-slate-leaf="true" data-offset-key="9005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9006"><span data-slate-leaf="true" data-offset-key="9006:0" data-first-offset="true"><span data-slate-string="true">)(</span></span></span><span data-slate-object="text" data-key="9007"><span data-slate-leaf="true" data-offset-key="9007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x8f000</span></span></span></span><span data-slate-object="text" data-key="9008"><span data-slate-leaf="true" data-offset-key="9008:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="9009"><span data-slate-leaf="true" data-offset-key="9009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1001</span></span></span></span><span data-slate-object="text" data-key="9010"><span data-slate-leaf="true" data-offset-key="9010:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9011"><span data-slate-object="text" data-key="9012"><span data-slate-leaf="true" data-offset-key="9012:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9013"><span data-slate-object="text" data-key="9014"><span data-slate-leaf="true" data-offset-key="9014:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9015"><span data-slate-leaf="true" data-offset-key="9015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="9016"><span data-slate-leaf="true" data-offset-key="9016:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9017"><span data-slate-leaf="true" data-offset-key="9017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"iks_moveimg err"</span></span></span></span><span data-slate-object="text" data-key="9018"><span data-slate-leaf="true" data-offset-key="9018:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9019"><span data-slate-object="text" data-key="9020"><span data-slate-leaf="true" data-offset-key="9020:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9021"><span data-slate-object="text" data-key="9022"><span data-slate-leaf="true" data-offset-key="9022:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_krlinitstack = IKSTACK_PHYADR;</span></span></span><span data-slate-object="text" data-key="9023"><span data-slate-leaf="true" data-offset-key="9023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 栈顶地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9024"><span data-slate-object="text" data-key="9025"><span data-slate-leaf="true" data-offset-key="9025:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_krlitstacksz = IKSTACK_SIZE; </span></span></span><span data-slate-object="text" data-key="9026"><span data-slate-leaf="true" data-offset-key="9026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 栈大小是 4KB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9027"><span data-slate-object="text" data-key="9028"><span data-slate-leaf="true" data-offset-key="9028:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9029"><span data-slate-leaf="true" data-offset-key="9029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9030"><span data-slate-leaf="true" data-offset-key="9030:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9031"><span data-slate-object="text" data-key="9032"><span data-slate-leaf="true" data-offset-key="9032:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9033"><span data-slate-object="text" data-key="9034"><span data-slate-leaf="true" data-offset-key="9034:0" data-first-offset="true"><span data-slate-string="true">init_krlinitstack 函数非常简单，但是其中调用了一个 move_krlimg 函数你要注意，这个我已经帮你写好啦，它主要负责判断一个地址空间是否和内存中存放的内容有冲突。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9035"><span data-slate-object="text" data-key="9036"><span data-slate-leaf="true" data-offset-key="9036:0" data-first-offset="true"><span data-slate-string="true">因为我们的内存中已经放置了机器信息结构、内存视图结构数组、二级引导器、内核映像文件，所以在处理内存空间时不能和内存中已经存在的他们冲突，否则就要覆盖他们的数据。0x8f000～（0x8f000+0x1001），正是我们的内核栈空间，我们需要检测它是否和其它空间有冲突。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9037" id="sr-toc-5"><span data-slate-object="text" data-key="9038"><span data-slate-leaf="true" data-offset-key="9038:0" data-first-offset="true"><span data-slate-string="true">放置内核文件与字库文件</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9039"><span data-slate-object="text" data-key="9040"><span data-slate-leaf="true" data-offset-key="9040:0" data-first-offset="true"><span data-slate-string="true">放置内核文件和字库文件这一步，也非常简单，甚至放置其它文件也一样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9041"><span data-slate-object="text" data-key="9042"><span data-slate-leaf="true" data-offset-key="9042:0" data-first-offset="true"><span data-slate-string="true">因为我们的内核已经编译成了一个独立的二进制程序，和其它文件一起被打包到映像文件中了。所以我们必须要从映像中把它解包出来，将其放在特定的物理内存空间中才可以，放置字库文件和放置内核文件的原理一样，所以我们来一起实现。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="9043"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9044"><span data-slate-object="text" data-key="9045"><span data-slate-leaf="true" data-offset-key="9045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放置内核文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9046"><span data-slate-object="text" data-key="9047"><span data-slate-leaf="true" data-offset-key="9047:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="9048"><span data-slate-leaf="true" data-offset-key="9048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlfile</span></span></span></span><span data-slate-object="text" data-key="9049"><span data-slate-leaf="true" data-offset-key="9049:0" data-first-offset="true"><span data-slate-string="true">(machbstart_t *mbsp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9050"><span data-slate-object="text" data-key="9051"><span data-slate-leaf="true" data-offset-key="9051:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9052"><span data-slate-object="text" data-key="9053"><span data-slate-leaf="true" data-offset-key="9053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在映像中查找相应的文件，并复制到对应的地址，并返回文件的大小，这里是查找 kernel.bin 文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9054"><span data-slate-object="text" data-key="9055"><span data-slate-leaf="true" data-offset-key="9055:0" data-first-offset="true"><span data-slate-string="true">    u64_t sz = </span></span></span><span data-slate-object="text" data-key="9056"><span data-slate-leaf="true" data-offset-key="9056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">r_file_to_padr</span></span></span></span><span data-slate-object="text" data-key="9057"><span data-slate-leaf="true" data-offset-key="9057:0" data-first-offset="true"><span data-slate-string="true">(mbsp, IMGKRNL_PHYADR, </span></span></span><span data-slate-object="text" data-key="9058"><span data-slate-leaf="true" data-offset-key="9058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"kernel.bin"</span></span></span></span><span data-slate-object="text" data-key="9059"><span data-slate-leaf="true" data-offset-key="9059:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9060"><span data-slate-object="text" data-key="9061"><span data-slate-leaf="true" data-offset-key="9061:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9062"><span data-slate-leaf="true" data-offset-key="9062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9063"><span data-slate-leaf="true" data-offset-key="9063:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9064"><span data-slate-leaf="true" data-offset-key="9064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9065"><span data-slate-leaf="true" data-offset-key="9065:0" data-first-offset="true"><span data-slate-string="true"> == sz)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9066"><span data-slate-object="text" data-key="9067"><span data-slate-leaf="true" data-offset-key="9067:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9068"><span data-slate-object="text" data-key="9069"><span data-slate-leaf="true" data-offset-key="9069:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9070"><span data-slate-leaf="true" data-offset-key="9070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="9071"><span data-slate-leaf="true" data-offset-key="9071:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9072"><span data-slate-leaf="true" data-offset-key="9072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r_file_to_padr err"</span></span></span></span><span data-slate-object="text" data-key="9073"><span data-slate-leaf="true" data-offset-key="9073:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9074"><span data-slate-object="text" data-key="9075"><span data-slate-leaf="true" data-offset-key="9075:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9076"><span data-slate-object="text" data-key="9077"><span data-slate-leaf="true" data-offset-key="9077:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9078"><span data-slate-leaf="true" data-offset-key="9078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放置完成后更新机器信息结构中的数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9079"><span data-slate-object="text" data-key="9080"><span data-slate-leaf="true" data-offset-key="9080:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9081"><span data-slate-leaf="true" data-offset-key="9081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9082"><span data-slate-leaf="true" data-offset-key="9082:0" data-first-offset="true"><span data-slate-string="true">mb_krlimgpadr = IMGKRNL_PHYADR;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9083"><span data-slate-object="text" data-key="9084"><span data-slate-leaf="true" data-offset-key="9084:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9085"><span data-slate-leaf="true" data-offset-key="9085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9086"><span data-slate-leaf="true" data-offset-key="9086:0" data-first-offset="true"><span data-slate-string="true">mb_krlsz = sz;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9087"><span data-slate-object="text" data-key="9088"><span data-slate-leaf="true" data-offset-key="9088:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9089"><span data-slate-leaf="true" data-offset-key="9089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//mbsp-&gt;mb_nextwtpadr 始终要保持指向下一段空闲内存的首地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9090"><span data-slate-object="text" data-key="9091"><span data-slate-leaf="true" data-offset-key="9091:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9092"><span data-slate-leaf="true" data-offset-key="9092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9093"><span data-slate-leaf="true" data-offset-key="9093:0" data-first-offset="true"><span data-slate-string="true">mb_nextwtpadr = </span></span></span><span data-slate-object="text" data-key="9094"><span data-slate-leaf="true" data-offset-key="9094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">P4K_ALIGN</span></span></span></span><span data-slate-object="text" data-key="9095"><span data-slate-leaf="true" data-offset-key="9095:0" data-first-offset="true"><span data-slate-string="true">(mbsp</span></span></span><span data-slate-object="text" data-key="9096"><span data-slate-leaf="true" data-offset-key="9096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9097"><span data-slate-leaf="true" data-offset-key="9097:0" data-first-offset="true"><span data-slate-string="true">mb_krlimgpadr + mbsp</span></span></span><span data-slate-object="text" data-key="9098"><span data-slate-leaf="true" data-offset-key="9098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9099"><span data-slate-leaf="true" data-offset-key="9099:0" data-first-offset="true"><span data-slate-string="true">mb_krlsz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9100"><span data-slate-object="text" data-key="9101"><span data-slate-leaf="true" data-offset-key="9101:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9102"><span data-slate-leaf="true" data-offset-key="9102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9103"><span data-slate-leaf="true" data-offset-key="9103:0" data-first-offset="true"><span data-slate-string="true">mb_kalldendpadr = mbsp</span></span></span><span data-slate-object="text" data-key="9104"><span data-slate-leaf="true" data-offset-key="9104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9105"><span data-slate-leaf="true" data-offset-key="9105:0" data-first-offset="true"><span data-slate-string="true">mb_krlimgpadr + mbsp</span></span></span><span data-slate-object="text" data-key="9106"><span data-slate-leaf="true" data-offset-key="9106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9107"><span data-slate-leaf="true" data-offset-key="9107:0" data-first-offset="true"><span data-slate-string="true">mb_krlsz;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9108"><span data-slate-object="text" data-key="9109"><span data-slate-leaf="true" data-offset-key="9109:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9110"><span data-slate-leaf="true" data-offset-key="9110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9111"><span data-slate-leaf="true" data-offset-key="9111:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9112"><span data-slate-object="text" data-key="9113"><span data-slate-leaf="true" data-offset-key="9113:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9114"><span data-slate-object="text" data-key="9115"><span data-slate-leaf="true" data-offset-key="9115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放置字库文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9116"><span data-slate-object="text" data-key="9117"><span data-slate-leaf="true" data-offset-key="9117:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="9118"><span data-slate-leaf="true" data-offset-key="9118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_defutfont</span></span></span></span><span data-slate-object="text" data-key="9119"><span data-slate-leaf="true" data-offset-key="9119:0" data-first-offset="true"><span data-slate-string="true">(machbstart_t *mbsp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9120"><span data-slate-object="text" data-key="9121"><span data-slate-leaf="true" data-offset-key="9121:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9122"><span data-slate-object="text" data-key="9123"><span data-slate-leaf="true" data-offset-key="9123:0" data-first-offset="true"><span data-slate-string="true">    u64_t sz = </span></span></span><span data-slate-object="text" data-key="9124"><span data-slate-leaf="true" data-offset-key="9124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9125"><span data-slate-leaf="true" data-offset-key="9125:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9126"><span data-slate-object="text" data-key="9127"><span data-slate-leaf="true" data-offset-key="9127:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9128"><span data-slate-leaf="true" data-offset-key="9128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取下一段空闲内存空间的首地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9129"><span data-slate-object="text" data-key="9130"><span data-slate-leaf="true" data-offset-key="9130:0" data-first-offset="true"><span data-slate-string="true">    u32_t dfadr = (u32_t)mbsp</span></span></span><span data-slate-object="text" data-key="9131"><span data-slate-leaf="true" data-offset-key="9131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9132"><span data-slate-leaf="true" data-offset-key="9132:0" data-first-offset="true"><span data-slate-string="true">mb_nextwtpadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9133"><span data-slate-object="text" data-key="9134"><span data-slate-leaf="true" data-offset-key="9134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在映像中查找相应的文件，并复制到对应的地址，并返回文件的大小，这里是查找 font.fnt 文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9135"><span data-slate-object="text" data-key="9136"><span data-slate-leaf="true" data-offset-key="9136:0" data-first-offset="true"><span data-slate-string="true">    sz = </span></span></span><span data-slate-object="text" data-key="9137"><span data-slate-leaf="true" data-offset-key="9137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">r_file_to_padr</span></span></span></span><span data-slate-object="text" data-key="9138"><span data-slate-leaf="true" data-offset-key="9138:0" data-first-offset="true"><span data-slate-string="true">(mbsp, dfadr, </span></span></span><span data-slate-object="text" data-key="9139"><span data-slate-leaf="true" data-offset-key="9139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"font.fnt"</span></span></span></span><span data-slate-object="text" data-key="9140"><span data-slate-leaf="true" data-offset-key="9140:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9141"><span data-slate-object="text" data-key="9142"><span data-slate-leaf="true" data-offset-key="9142:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9143"><span data-slate-leaf="true" data-offset-key="9143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9144"><span data-slate-leaf="true" data-offset-key="9144:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9145"><span data-slate-leaf="true" data-offset-key="9145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9146"><span data-slate-leaf="true" data-offset-key="9146:0" data-first-offset="true"><span data-slate-string="true"> == sz)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9147"><span data-slate-object="text" data-key="9148"><span data-slate-leaf="true" data-offset-key="9148:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9149"><span data-slate-object="text" data-key="9150"><span data-slate-leaf="true" data-offset-key="9150:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9151"><span data-slate-leaf="true" data-offset-key="9151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="9152"><span data-slate-leaf="true" data-offset-key="9152:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9153"><span data-slate-leaf="true" data-offset-key="9153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r_file_to_padr err"</span></span></span></span><span data-slate-object="text" data-key="9154"><span data-slate-leaf="true" data-offset-key="9154:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9155"><span data-slate-object="text" data-key="9156"><span data-slate-leaf="true" data-offset-key="9156:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9157"><span data-slate-object="text" data-key="9158"><span data-slate-leaf="true" data-offset-key="9158:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9159"><span data-slate-leaf="true" data-offset-key="9159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放置完成后更新机器信息结构中的数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9160"><span data-slate-object="text" data-key="9161"><span data-slate-leaf="true" data-offset-key="9161:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9162"><span data-slate-leaf="true" data-offset-key="9162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9163"><span data-slate-leaf="true" data-offset-key="9163:0" data-first-offset="true"><span data-slate-string="true">mb_bfontpadr = (u64_t)(dfadr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9164"><span data-slate-object="text" data-key="9165"><span data-slate-leaf="true" data-offset-key="9165:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9166"><span data-slate-leaf="true" data-offset-key="9166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9167"><span data-slate-leaf="true" data-offset-key="9167:0" data-first-offset="true"><span data-slate-string="true">mb_bfontsz = sz;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9168"><span data-slate-object="text" data-key="9169"><span data-slate-leaf="true" data-offset-key="9169:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9170"><span data-slate-leaf="true" data-offset-key="9170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新机器信息结构中下一段空闲内存的首地址  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9171"><span data-slate-object="text" data-key="9172"><span data-slate-leaf="true" data-offset-key="9172:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9173"><span data-slate-leaf="true" data-offset-key="9173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9174"><span data-slate-leaf="true" data-offset-key="9174:0" data-first-offset="true"><span data-slate-string="true">mb_nextwtpadr = </span></span></span><span data-slate-object="text" data-key="9175"><span data-slate-leaf="true" data-offset-key="9175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">P4K_ALIGN</span></span></span></span><span data-slate-object="text" data-key="9176"><span data-slate-leaf="true" data-offset-key="9176:0" data-first-offset="true"><span data-slate-string="true">((u32_t)(dfadr) + sz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9177"><span data-slate-object="text" data-key="9178"><span data-slate-leaf="true" data-offset-key="9178:0" data-first-offset="true"><span data-slate-string="true">    mbsp</span></span></span><span data-slate-object="text" data-key="9179"><span data-slate-leaf="true" data-offset-key="9179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9180"><span data-slate-leaf="true" data-offset-key="9180:0" data-first-offset="true"><span data-slate-string="true">mb_kalldendpadr = mbsp</span></span></span><span data-slate-object="text" data-key="9181"><span data-slate-leaf="true" data-offset-key="9181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9182"><span data-slate-leaf="true" data-offset-key="9182:0" data-first-offset="true"><span data-slate-string="true">mb_bfontpadr + mbsp</span></span></span><span data-slate-object="text" data-key="9183"><span data-slate-leaf="true" data-offset-key="9183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9184"><span data-slate-leaf="true" data-offset-key="9184:0" data-first-offset="true"><span data-slate-string="true">mb_bfontsz;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9185"><span data-slate-object="text" data-key="9186"><span data-slate-leaf="true" data-offset-key="9186:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9187"><span data-slate-leaf="true" data-offset-key="9187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9188"><span data-slate-leaf="true" data-offset-key="9188:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9189"><span data-slate-object="text" data-key="9190"><span data-slate-leaf="true" data-offset-key="9190:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9191"><span data-slate-object="text" data-key="9192"><span data-slate-leaf="true" data-offset-key="9192:0" data-first-offset="true"><span data-slate-string="true">以上代码的注释已经很清楚了，都是调用 r_file_to_padr 函数在映像中查找 kernel.bin 和 font.fnt 文件，并复制到对应的空闲内存空间中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9193"><span data-slate-object="text" data-key="9194"><span data-slate-leaf="true" data-offset-key="9194:0" data-first-offset="true"><span data-slate-string="true">请注意，由于内核是代码数据，所以必须要复制到指定的内存空间中。r_file_to_padr 函数我已经帮你写好了，其中的原理在前面的内容里已经做了说明，这里不再展开。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9195" id="sr-toc-6"><span data-slate-object="text" data-key="9196"><span data-slate-leaf="true" data-offset-key="9196:0" data-first-offset="true"><span data-slate-string="true">建立 MMU 页表数据</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9197"><span data-slate-object="text" data-key="9198"><span data-slate-leaf="true" data-offset-key="9198:0" data-first-offset="true"><span data-slate-string="true">前面解决了文件放置问题，我们还要解决另一个问题 —— 建立 MMU 页表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9199"><span data-slate-object="text" data-key="9200"><span data-slate-leaf="true" data-offset-key="9200:0" data-first-offset="true"><span data-slate-string="true">我们在二级引导器中建立 MMU 页表数据，目的就是要在内核加载运行之初开启长模式时，MMU 需要的页表数据已经准备好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9201"><span data-slate-object="text" data-key="9202"><span data-slate-leaf="true" data-offset-key="9202:0" data-first-offset="true"><span data-slate-string="true">由于我们的内核虚拟地址空间从 0xffff800000000000 开始，所以我们这个虚拟地址映射到从物理地址 0 开始，大小都是 0x400000000 即 16GB，也就是说我们要虚拟地址空间：0xffff800000000000～0xffff800400000000 映射到物理地址空间 0～0x400000000。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9203"><span data-slate-object="text" data-key="9204"><span data-slate-leaf="true" data-offset-key="9204:0" data-first-offset="true"><span data-slate-string="true">我们为了简化编程，使用</span></span></span><span data-slate-object="text" data-key="9205"><span data-slate-leaf="true" data-offset-key="9205:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">长模式下的 2MB 分页方式</span></span></span></span><span data-slate-object="text" data-key="9206"><span data-slate-leaf="true" data-offset-key="9206:0" data-first-offset="true"><span data-slate-string="true">，下面我们用代码实现它，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9207"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9208"><span data-slate-object="text" data-key="9209"><span data-slate-leaf="true" data-offset-key="9209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9210"><span data-slate-leaf="true" data-offset-key="9210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9211"><span data-slate-leaf="true" data-offset-key="9211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> KINITPAGE_PHYADR 0x1000000</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9212"><span data-slate-object="text" data-key="9213"><span data-slate-leaf="true" data-offset-key="9213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="9214"><span data-slate-leaf="true" data-offset-key="9214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9215"><span data-slate-leaf="true" data-offset-key="9215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bstartpages</span></span></span></span></span><span data-slate-object="text" data-key="9216"><span data-slate-leaf="true" data-offset-key="9216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9217"><span data-slate-leaf="true" data-offset-key="9217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="9218"><span data-slate-leaf="true" data-offset-key="9218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *mbsp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9219"><span data-slate-object="text" data-key="9220"><span data-slate-leaf="true" data-offset-key="9220:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9221"><span data-slate-object="text" data-key="9222"><span data-slate-leaf="true" data-offset-key="9222:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9223"><span data-slate-leaf="true" data-offset-key="9223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 顶级页目录</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9224"><span data-slate-object="text" data-key="9225"><span data-slate-leaf="true" data-offset-key="9225:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9226"><span data-slate-leaf="true" data-offset-key="9226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9227"><span data-slate-leaf="true" data-offset-key="9227:0" data-first-offset="true"><span data-slate-string="true"> *p = (</span></span></span><span data-slate-object="text" data-key="9228"><span data-slate-leaf="true" data-offset-key="9228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9229"><span data-slate-leaf="true" data-offset-key="9229:0" data-first-offset="true"><span data-slate-string="true"> *)(KINITPAGE_PHYADR);</span></span></span><span data-slate-object="text" data-key="9230"><span data-slate-leaf="true" data-offset-key="9230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//16MB 地址处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9231"><span data-slate-object="text" data-key="9232"><span data-slate-leaf="true" data-offset-key="9232:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9233"><span data-slate-leaf="true" data-offset-key="9233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 页目录指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9234"><span data-slate-object="text" data-key="9235"><span data-slate-leaf="true" data-offset-key="9235:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9236"><span data-slate-leaf="true" data-offset-key="9236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9237"><span data-slate-leaf="true" data-offset-key="9237:0" data-first-offset="true"><span data-slate-string="true"> *pdpte = (</span></span></span><span data-slate-object="text" data-key="9238"><span data-slate-leaf="true" data-offset-key="9238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9239"><span data-slate-leaf="true" data-offset-key="9239:0" data-first-offset="true"><span data-slate-string="true"> *)(KINITPAGE_PHYADR + </span></span></span><span data-slate-object="text" data-key="9240"><span data-slate-leaf="true" data-offset-key="9240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1000</span></span></span></span><span data-slate-object="text" data-key="9241"><span data-slate-leaf="true" data-offset-key="9241:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9242"><span data-slate-object="text" data-key="9243"><span data-slate-leaf="true" data-offset-key="9243:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9244"><span data-slate-leaf="true" data-offset-key="9244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 页目录</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9245"><span data-slate-object="text" data-key="9246"><span data-slate-leaf="true" data-offset-key="9246:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9247"><span data-slate-leaf="true" data-offset-key="9247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9248"><span data-slate-leaf="true" data-offset-key="9248:0" data-first-offset="true"><span data-slate-string="true"> *pde = (</span></span></span><span data-slate-object="text" data-key="9249"><span data-slate-leaf="true" data-offset-key="9249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9250"><span data-slate-leaf="true" data-offset-key="9250:0" data-first-offset="true"><span data-slate-string="true"> *)(KINITPAGE_PHYADR + </span></span></span><span data-slate-object="text" data-key="9251"><span data-slate-leaf="true" data-offset-key="9251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x2000</span></span></span></span><span data-slate-object="text" data-key="9252"><span data-slate-leaf="true" data-offset-key="9252:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9253"><span data-slate-object="text" data-key="9254"><span data-slate-leaf="true" data-offset-key="9254:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9255"><span data-slate-leaf="true" data-offset-key="9255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 物理地址从 0 开始</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9256"><span data-slate-object="text" data-key="9257"><span data-slate-leaf="true" data-offset-key="9257:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9258"><span data-slate-leaf="true" data-offset-key="9258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9259"><span data-slate-leaf="true" data-offset-key="9259:0" data-first-offset="true"><span data-slate-string="true"> adr = </span></span></span><span data-slate-object="text" data-key="9260"><span data-slate-leaf="true" data-offset-key="9260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9261"><span data-slate-leaf="true" data-offset-key="9261:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9262"><span data-slate-object="text" data-key="9263"><span data-slate-leaf="true" data-offset-key="9263:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9264"><span data-slate-leaf="true" data-offset-key="9264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9265"><span data-slate-leaf="true" data-offset-key="9265:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9266"><span data-slate-leaf="true" data-offset-key="9266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9267"><span data-slate-leaf="true" data-offset-key="9267:0" data-first-offset="true"><span data-slate-string="true"> &gt; </span></span></span><span data-slate-object="text" data-key="9268"><span data-slate-leaf="true" data-offset-key="9268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">move_krlimg</span></span></span></span><span data-slate-object="text" data-key="9269"><span data-slate-leaf="true" data-offset-key="9269:0" data-first-offset="true"><span data-slate-string="true">(mbsp, (</span></span></span><span data-slate-object="text" data-key="9270"><span data-slate-leaf="true" data-offset-key="9270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9271"><span data-slate-leaf="true" data-offset-key="9271:0" data-first-offset="true"><span data-slate-string="true">)(KINITPAGE_PHYADR), (</span></span></span><span data-slate-object="text" data-key="9272"><span data-slate-leaf="true" data-offset-key="9272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1000</span></span></span></span><span data-slate-object="text" data-key="9273"><span data-slate-leaf="true" data-offset-key="9273:0" data-first-offset="true"><span data-slate-string="true"> * </span></span></span><span data-slate-object="text" data-key="9274"><span data-slate-leaf="true" data-offset-key="9274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="9275"><span data-slate-leaf="true" data-offset-key="9275:0" data-first-offset="true"><span data-slate-string="true"> + </span></span></span><span data-slate-object="text" data-key="9276"><span data-slate-leaf="true" data-offset-key="9276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x2000</span></span></span></span><span data-slate-object="text" data-key="9277"><span data-slate-leaf="true" data-offset-key="9277:0" data-first-offset="true"><span data-slate-string="true">)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9278"><span data-slate-object="text" data-key="9279"><span data-slate-leaf="true" data-offset-key="9279:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9280"><span data-slate-object="text" data-key="9281"><span data-slate-leaf="true" data-offset-key="9281:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9282"><span data-slate-leaf="true" data-offset-key="9282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="9283"><span data-slate-leaf="true" data-offset-key="9283:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9284"><span data-slate-leaf="true" data-offset-key="9284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"move_krlimg err"</span></span></span></span><span data-slate-object="text" data-key="9285"><span data-slate-leaf="true" data-offset-key="9285:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9286"><span data-slate-object="text" data-key="9287"><span data-slate-leaf="true" data-offset-key="9287:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9288"><span data-slate-object="text" data-key="9289"><span data-slate-leaf="true" data-offset-key="9289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9290"><span data-slate-leaf="true" data-offset-key="9290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将顶级页目录、页目录指针的空间清 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9291"><span data-slate-object="text" data-key="9292"><span data-slate-leaf="true" data-offset-key="9292:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9293"><span data-slate-leaf="true" data-offset-key="9293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9294"><span data-slate-leaf="true" data-offset-key="9294:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9295"><span data-slate-leaf="true" data-offset-key="9295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="9296"><span data-slate-leaf="true" data-offset-key="9296:0" data-first-offset="true"><span data-slate-string="true"> mi = </span></span></span><span data-slate-object="text" data-key="9297"><span data-slate-leaf="true" data-offset-key="9297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9298"><span data-slate-leaf="true" data-offset-key="9298:0" data-first-offset="true"><span data-slate-string="true">; mi &lt;PGENTY_SIZE; mi++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9299"><span data-slate-object="text" data-key="9300"><span data-slate-leaf="true" data-offset-key="9300:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9301"><span data-slate-object="text" data-key="9302"><span data-slate-leaf="true" data-offset-key="9302:0" data-first-offset="true"><span data-slate-string="true">        p[mi] = </span></span></span><span data-slate-object="text" data-key="9303"><span data-slate-leaf="true" data-offset-key="9303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9304"><span data-slate-leaf="true" data-offset-key="9304:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9305"><span data-slate-object="text" data-key="9306"><span data-slate-leaf="true" data-offset-key="9306:0" data-first-offset="true"><span data-slate-string="true">        pdpte[mi] = </span></span></span><span data-slate-object="text" data-key="9307"><span data-slate-leaf="true" data-offset-key="9307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9308"><span data-slate-leaf="true" data-offset-key="9308:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9309"><span data-slate-object="text" data-key="9310"><span data-slate-leaf="true" data-offset-key="9310:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9311"><span data-slate-object="text" data-key="9312"><span data-slate-leaf="true" data-offset-key="9312:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9313"><span data-slate-leaf="true" data-offset-key="9313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 映射</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9314"><span data-slate-object="text" data-key="9315"><span data-slate-leaf="true" data-offset-key="9315:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9316"><span data-slate-leaf="true" data-offset-key="9316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9317"><span data-slate-leaf="true" data-offset-key="9317:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9318"><span data-slate-leaf="true" data-offset-key="9318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="9319"><span data-slate-leaf="true" data-offset-key="9319:0" data-first-offset="true"><span data-slate-string="true"> pdei = </span></span></span><span data-slate-object="text" data-key="9320"><span data-slate-leaf="true" data-offset-key="9320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9321"><span data-slate-leaf="true" data-offset-key="9321:0" data-first-offset="true"><span data-slate-string="true">; pdei &lt; </span></span></span><span data-slate-object="text" data-key="9322"><span data-slate-leaf="true" data-offset-key="9322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="9323"><span data-slate-leaf="true" data-offset-key="9323:0" data-first-offset="true"><span data-slate-string="true">; pdei++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9324"><span data-slate-object="text" data-key="9325"><span data-slate-leaf="true" data-offset-key="9325:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9326"><span data-slate-object="text" data-key="9327"><span data-slate-leaf="true" data-offset-key="9327:0" data-first-offset="true"><span data-slate-string="true">        pdpte[pdei] = (</span></span></span><span data-slate-object="text" data-key="9328"><span data-slate-leaf="true" data-offset-key="9328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9329"><span data-slate-leaf="true" data-offset-key="9329:0" data-first-offset="true"><span data-slate-string="true">)((</span></span></span><span data-slate-object="text" data-key="9330"><span data-slate-leaf="true" data-offset-key="9330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9331"><span data-slate-leaf="true" data-offset-key="9331:0" data-first-offset="true"><span data-slate-string="true">)pde | KPDPTE_RW | KPDPTE_P);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9332"><span data-slate-object="text" data-key="9333"><span data-slate-leaf="true" data-offset-key="9333:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9334"><span data-slate-leaf="true" data-offset-key="9334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9335"><span data-slate-leaf="true" data-offset-key="9335:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="9336"><span data-slate-leaf="true" data-offset-key="9336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="9337"><span data-slate-leaf="true" data-offset-key="9337:0" data-first-offset="true"><span data-slate-string="true"> pdeii = </span></span></span><span data-slate-object="text" data-key="9338"><span data-slate-leaf="true" data-offset-key="9338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9339"><span data-slate-leaf="true" data-offset-key="9339:0" data-first-offset="true"><span data-slate-string="true">; pdeii &lt;PGENTY_SIZE; pdeii++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9340"><span data-slate-object="text" data-key="9341"><span data-slate-leaf="true" data-offset-key="9341:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span><span data-slate-object="text" data-key="9342"><span data-slate-leaf="true" data-offset-key="9342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 大页 KPDE_PS 2MB，可读写 KPDE_RW，存在 KPDE_P</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9343"><span data-slate-object="text" data-key="9344"><span data-slate-leaf="true" data-offset-key="9344:0" data-first-offset="true"><span data-slate-string="true">            pde[pdeii] = </span></span></span><span data-slate-object="text" data-key="9345"><span data-slate-leaf="true" data-offset-key="9345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9346"><span data-slate-leaf="true" data-offset-key="9346:0" data-first-offset="true"><span data-slate-string="true"> | adr | KPDE_PS | KPDE_RW | KPDE_P;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9347"><span data-slate-object="text" data-key="9348"><span data-slate-leaf="true" data-offset-key="9348:0" data-first-offset="true"><span data-slate-string="true">            adr += </span></span></span><span data-slate-object="text" data-key="9349"><span data-slate-leaf="true" data-offset-key="9349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x200000</span></span></span></span><span data-slate-object="text" data-key="9350"><span data-slate-leaf="true" data-offset-key="9350:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9351"><span data-slate-object="text" data-key="9352"><span data-slate-leaf="true" data-offset-key="9352:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9353"><span data-slate-object="text" data-key="9354"><span data-slate-leaf="true" data-offset-key="9354:0" data-first-offset="true"><span data-slate-string="true">        pde = (</span></span></span><span data-slate-object="text" data-key="9355"><span data-slate-leaf="true" data-offset-key="9355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9356"><span data-slate-leaf="true" data-offset-key="9356:0" data-first-offset="true"><span data-slate-string="true"> *)((</span></span></span><span data-slate-object="text" data-key="9357"><span data-slate-leaf="true" data-offset-key="9357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9358"><span data-slate-leaf="true" data-offset-key="9358:0" data-first-offset="true"><span data-slate-string="true">)pde + </span></span></span><span data-slate-object="text" data-key="9359"><span data-slate-leaf="true" data-offset-key="9359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1000</span></span></span></span><span data-slate-object="text" data-key="9360"><span data-slate-leaf="true" data-offset-key="9360:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9361"><span data-slate-object="text" data-key="9362"><span data-slate-leaf="true" data-offset-key="9362:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9363"><span data-slate-object="text" data-key="9364"><span data-slate-leaf="true" data-offset-key="9364:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9365"><span data-slate-leaf="true" data-offset-key="9365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 让顶级页目录中第 0 项和第 ((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; 0x1ff 项，指向同一个页目录指针页  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9366"><span data-slate-object="text" data-key="9367"><span data-slate-leaf="true" data-offset-key="9367:0" data-first-offset="true"><span data-slate-string="true">    p[((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; </span></span></span><span data-slate-object="text" data-key="9368"><span data-slate-leaf="true" data-offset-key="9368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1ff</span></span></span></span><span data-slate-object="text" data-key="9369"><span data-slate-leaf="true" data-offset-key="9369:0" data-first-offset="true"><span data-slate-string="true">] = (</span></span></span><span data-slate-object="text" data-key="9370"><span data-slate-leaf="true" data-offset-key="9370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9371"><span data-slate-leaf="true" data-offset-key="9371:0" data-first-offset="true"><span data-slate-string="true">)((</span></span></span><span data-slate-object="text" data-key="9372"><span data-slate-leaf="true" data-offset-key="9372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9373"><span data-slate-leaf="true" data-offset-key="9373:0" data-first-offset="true"><span data-slate-string="true">)pdpte | KPML4_RW | KPML4_P);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9374"><span data-slate-object="text" data-key="9375"><span data-slate-leaf="true" data-offset-key="9375:0" data-first-offset="true"><span data-slate-string="true">    p[</span></span></span><span data-slate-object="text" data-key="9376"><span data-slate-leaf="true" data-offset-key="9376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9377"><span data-slate-leaf="true" data-offset-key="9377:0" data-first-offset="true"><span data-slate-string="true">] = (</span></span></span><span data-slate-object="text" data-key="9378"><span data-slate-leaf="true" data-offset-key="9378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9379"><span data-slate-leaf="true" data-offset-key="9379:0" data-first-offset="true"><span data-slate-string="true">)((</span></span></span><span data-slate-object="text" data-key="9380"><span data-slate-leaf="true" data-offset-key="9380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9381"><span data-slate-leaf="true" data-offset-key="9381:0" data-first-offset="true"><span data-slate-string="true">)pdpte | KPML4_RW | KPML4_P);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9382"><span data-slate-object="text" data-key="9383"><span data-slate-leaf="true" data-offset-key="9383:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9384"><span data-slate-leaf="true" data-offset-key="9384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把页表首地址保存在机器信息结构中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9385"><span data-slate-object="text" data-key="9386"><span data-slate-leaf="true" data-offset-key="9386:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_pml4padr = (</span></span></span><span data-slate-object="text" data-key="9387"><span data-slate-leaf="true" data-offset-key="9387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9388"><span data-slate-leaf="true" data-offset-key="9388:0" data-first-offset="true"><span data-slate-string="true">)(KINITPAGE_PHYADR);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9389"><span data-slate-object="text" data-key="9390"><span data-slate-leaf="true" data-offset-key="9390:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_subpageslen = (</span></span></span><span data-slate-object="text" data-key="9391"><span data-slate-leaf="true" data-offset-key="9391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9392"><span data-slate-leaf="true" data-offset-key="9392:0" data-first-offset="true"><span data-slate-string="true">)(</span></span></span><span data-slate-object="text" data-key="9393"><span data-slate-leaf="true" data-offset-key="9393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1000</span></span></span></span><span data-slate-object="text" data-key="9394"><span data-slate-leaf="true" data-offset-key="9394:0" data-first-offset="true"><span data-slate-string="true"> * </span></span></span><span data-slate-object="text" data-key="9395"><span data-slate-leaf="true" data-offset-key="9395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="9396"><span data-slate-leaf="true" data-offset-key="9396:0" data-first-offset="true"><span data-slate-string="true"> + </span></span></span><span data-slate-object="text" data-key="9397"><span data-slate-leaf="true" data-offset-key="9397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x2000</span></span></span></span><span data-slate-object="text" data-key="9398"><span data-slate-leaf="true" data-offset-key="9398:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9399"><span data-slate-object="text" data-key="9400"><span data-slate-leaf="true" data-offset-key="9400:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_kpmapphymemsz = (</span></span></span><span data-slate-object="text" data-key="9401"><span data-slate-leaf="true" data-offset-key="9401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="9402"><span data-slate-leaf="true" data-offset-key="9402:0" data-first-offset="true"><span data-slate-string="true">)(</span></span></span><span data-slate-object="text" data-key="9403"><span data-slate-leaf="true" data-offset-key="9403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x400000000</span></span></span></span><span data-slate-object="text" data-key="9404"><span data-slate-leaf="true" data-offset-key="9404:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9405"><span data-slate-object="text" data-key="9406"><span data-slate-leaf="true" data-offset-key="9406:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9407"><span data-slate-leaf="true" data-offset-key="9407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9408"><span data-slate-leaf="true" data-offset-key="9408:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9409"><span data-slate-object="text" data-key="9410"><span data-slate-leaf="true" data-offset-key="9410:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9411"><span data-slate-object="text" data-key="9412"><span data-slate-leaf="true" data-offset-key="9412:0" data-first-offset="true"><span data-slate-string="true">这个函数的代码写得非常简单，</span></span></span><span data-slate-object="text" data-key="9413"><span data-slate-leaf="true" data-offset-key="9413:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">映射的核心逻辑由两重循环控制</span></span></span></span><span data-slate-object="text" data-key="9414"><span data-slate-leaf="true" data-offset-key="9414:0" data-first-offset="true"><span data-slate-string="true">，</span></span><span data-slate-leaf="true" data-offset-key="9414:1"><span data-slate-object="annotation" data-annotation-key="gkann_f8df5c1b" data-attr-id="42963" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">外层循环控制页目录指针顶，只有 16 项，其中每一项都指向一个页目录，每个页目录中有 512 个物理页地址。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9415"><span data-slate-object="text" data-key="9416"><span data-slate-leaf="true" data-offset-key="9416:0" data-first-offset="true"><span data-slate-string="true">物理地址每次增加 2MB，这是由 26～30 行的内层循环控制，每执行一次外层循环就要执行 512 次内层循环。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9417"><span data-slate-object="text" data-key="9418"><span data-slate-leaf="true" data-offset-key="9418:0" data-first-offset="true"><span data-slate-string="true">最后，</span></span><span data-slate-leaf="true" data-offset-key="9418:1"><span data-slate-object="annotation" data-annotation-key="gkann_7ea6adc6" data-attr-id="30250" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">顶级页目录中第 0 项和第 ((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; 0x1ff 项，</span></span></span><span data-slate-leaf="true" data-offset-key="9418:2"><span data-slate-string="true">指向同一个页目录指针页，这样的话就能让虚拟地址：0xffff800000000000～0xffff800400000000 和虚拟地址：0～0x400000000，访问到同一个物理地址空间 0～0x400000000，这样做是有目的，</span></span></span><span data-slate-object="text" data-key="9419"><span data-slate-leaf="true" data-offset-key="9419:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">内核在启动初期，虚拟地址和物理地址要保持相同。</span></span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9420" id="sr-toc-7"><span data-slate-object="text" data-key="9421"><span data-slate-leaf="true" data-offset-key="9421:0" data-first-offset="true"><span data-slate-string="true">设置图形模式</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9422"><span data-slate-object="text" data-key="9423"><span data-slate-leaf="true" data-offset-key="9423:0" data-first-offset="true"><span data-slate-string="true">在计算机加电启动时，计算机上显卡会自动进入文本模式，文本模式只能显示 ASCII 字符，不能显示汉字和图形，所以我们要让显卡切换到图形模式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9424"><span data-slate-object="text" data-key="9425"><span data-slate-leaf="true" data-offset-key="9425:0" data-first-offset="true"><span data-slate-string="true">切换显卡模式依然要用 BIOS 中断，这个调用原理我们前面已经了如指掌。在实模式切换显卡模式的汇编代码，我已经帮你写好了，下面我们只要写个 C 函数调用它们就好了，代码如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="9426"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9427"><span data-slate-object="text" data-key="9428"><span data-slate-leaf="true" data-offset-key="9428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9429"><span data-slate-leaf="true" data-offset-key="9429:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9430"><span data-slate-leaf="true" data-offset-key="9430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_graph</span></span></span></span><span data-slate-object="text" data-key="9431"><span data-slate-leaf="true" data-offset-key="9431:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9432"><span data-slate-leaf="true" data-offset-key="9432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t* mbsp</span></span></span></span><span data-slate-object="text" data-key="9433"><span data-slate-leaf="true" data-offset-key="9433:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9434"><span data-slate-object="text" data-key="9435"><span data-slate-leaf="true" data-offset-key="9435:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9436"><span data-slate-object="text" data-key="9437"><span data-slate-leaf="true" data-offset-key="9437:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9438"><span data-slate-leaf="true" data-offset-key="9438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化图形数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9439"><span data-slate-object="text" data-key="9440"><span data-slate-leaf="true" data-offset-key="9440:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9441"><span data-slate-leaf="true" data-offset-key="9441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">graph_t_init</span></span></span></span><span data-slate-object="text" data-key="9442"><span data-slate-leaf="true" data-offset-key="9442:0" data-first-offset="true"><span data-slate-string="true">(&amp;mbsp-&gt;mb_ghparm);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9443"><span data-slate-object="text" data-key="9444"><span data-slate-leaf="true" data-offset-key="9444:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9445"><span data-slate-leaf="true" data-offset-key="9445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 VBE 模式，通过 BIOS 中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9446"><span data-slate-object="text" data-key="9447"><span data-slate-leaf="true" data-offset-key="9447:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9448"><span data-slate-leaf="true" data-offset-key="9448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get_vbemode</span></span></span></span><span data-slate-object="text" data-key="9449"><span data-slate-leaf="true" data-offset-key="9449:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9450"><span data-slate-object="text" data-key="9451"><span data-slate-leaf="true" data-offset-key="9451:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9452"><span data-slate-leaf="true" data-offset-key="9452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取一个具体 VBE 模式的信息，通过 BIOS 中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9453"><span data-slate-object="text" data-key="9454"><span data-slate-leaf="true" data-offset-key="9454:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9455"><span data-slate-leaf="true" data-offset-key="9455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get_vbemodeinfo</span></span></span></span><span data-slate-object="text" data-key="9456"><span data-slate-leaf="true" data-offset-key="9456:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9457"><span data-slate-object="text" data-key="9458"><span data-slate-leaf="true" data-offset-key="9458:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9459"><span data-slate-leaf="true" data-offset-key="9459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 VBE 模式，通过 BIOS 中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9460"><span data-slate-object="text" data-key="9461"><span data-slate-leaf="true" data-offset-key="9461:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9462"><span data-slate-leaf="true" data-offset-key="9462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_vbemodeinfo</span></span></span></span><span data-slate-object="text" data-key="9463"><span data-slate-leaf="true" data-offset-key="9463:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9464"><span data-slate-object="text" data-key="9465"><span data-slate-leaf="true" data-offset-key="9465:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9466"><span data-slate-leaf="true" data-offset-key="9466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9467"><span data-slate-leaf="true" data-offset-key="9467:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9468"><span data-slate-object="text" data-key="9469"><span data-slate-leaf="true" data-offset-key="9469:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9470"><span data-slate-object="text" data-key="9471"><span data-slate-leaf="true" data-offset-key="9471:0" data-first-offset="true"><span data-slate-string="true">上面 init_graph 函数中的这些处理 VBE 模式的代码，我已经帮你写好，你可以自己在 graph.c 文件查看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9472"><span data-slate-object="text" data-key="9473"><span data-slate-leaf="true" data-offset-key="9473:0" data-first-offset="true"><span data-slate-string="true">什么？你不懂 VBE，其实我开始也不懂，后来通过搜寻资料才知道。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9474"><span data-slate-object="text" data-key="9475"><span data-slate-leaf="true" data-offset-key="9475:0" data-first-offset="true"><span data-slate-string="true">其实 VBE 是显卡的一个图形规范标准，它定义了显卡的几种图形模式，每个模式包括屏幕分辨率，像素格式与大小，显存大小。调用 BIOS 10h 中断可以返回这些数据结构。</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9476"><span data-slate-object="text" data-key="9477"><span data-slate-leaf="true" data-offset-key="9477:0" data-first-offset="true"><span data-slate-string="true">如果你实在对 VBE 感兴趣，可以自行阅读其规范</span></span></span></a><span data-slate-object="text" data-key="9478"><span data-slate-leaf="true" data-offset-key="9478:0" data-first-offset="true"><span data-slate-string="true"> 。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9479"><span data-slate-object="text" data-key="9480"><span data-slate-leaf="true" data-offset-key="9480:0" data-first-offset="true"><span data-slate-string="true">这里我们选择使用了 VBE 的 118h 模式，该模式下屏幕分辨率为 1024x768，显存大小是 16.8MB。显存开始地址一般为 0xe0000000。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9481"><span data-slate-object="text" data-key="9482"><span data-slate-leaf="true" data-offset-key="9482:0" data-first-offset="true"><span data-slate-string="true">屏幕分辨率为 1024x768，即把屏幕分成 768 行，每行 1024 个像素点，但每个像素点占用显存的 32 位数据（4 字节，红、绿、蓝、透明各占 8 位）。我们只要往对应的显存地址写入相应的像素数据，屏幕对应的位置就能显示了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9483"><span data-slate-object="text" data-key="9484"><span data-slate-leaf="true" data-offset-key="9484:0" data-first-offset="true"><span data-slate-string="true">每个像素点，我们可以用如下数据结构表示：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9485"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9486"><span data-slate-object="text" data-key="9487"><span data-slate-leaf="true" data-offset-key="9487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="9488"><span data-slate-leaf="true" data-offset-key="9488:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9489"><span data-slate-leaf="true" data-offset-key="9489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9490"><span data-slate-leaf="true" data-offset-key="9490:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9491"><span data-slate-leaf="true" data-offset-key="9491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_PIXCL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9492"><span data-slate-object="text" data-key="9493"><span data-slate-leaf="true" data-offset-key="9493:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9494"><span data-slate-object="text" data-key="9495"><span data-slate-leaf="true" data-offset-key="9495:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9496"><span data-slate-leaf="true" data-offset-key="9496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="9497"><span data-slate-leaf="true" data-offset-key="9497:0" data-first-offset="true"><span data-slate-string="true"> cl_b; </span></span></span><span data-slate-object="text" data-key="9498"><span data-slate-leaf="true" data-offset-key="9498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 蓝</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9499"><span data-slate-object="text" data-key="9500"><span data-slate-leaf="true" data-offset-key="9500:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9501"><span data-slate-leaf="true" data-offset-key="9501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="9502"><span data-slate-leaf="true" data-offset-key="9502:0" data-first-offset="true"><span data-slate-string="true"> cl_g; </span></span></span><span data-slate-object="text" data-key="9503"><span data-slate-leaf="true" data-offset-key="9503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 绿</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9504"><span data-slate-object="text" data-key="9505"><span data-slate-leaf="true" data-offset-key="9505:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9506"><span data-slate-leaf="true" data-offset-key="9506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="9507"><span data-slate-leaf="true" data-offset-key="9507:0" data-first-offset="true"><span data-slate-string="true"> cl_r; </span></span></span><span data-slate-object="text" data-key="9508"><span data-slate-leaf="true" data-offset-key="9508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 红</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9509"><span data-slate-object="text" data-key="9510"><span data-slate-leaf="true" data-offset-key="9510:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9511"><span data-slate-leaf="true" data-offset-key="9511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="9512"><span data-slate-leaf="true" data-offset-key="9512:0" data-first-offset="true"><span data-slate-string="true"> cl_a; </span></span></span><span data-slate-object="text" data-key="9513"><span data-slate-leaf="true" data-offset-key="9513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 透明</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9514"><span data-slate-object="text" data-key="9515"><span data-slate-leaf="true" data-offset-key="9515:0" data-first-offset="true"><span data-slate-string="true">}__attribute__((packed)) </span></span></span><span data-slate-object="text" data-key="9516"><span data-slate-leaf="true" data-offset-key="9516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixcl_t</span></span></span></span><span data-slate-object="text" data-key="9517"><span data-slate-leaf="true" data-offset-key="9517:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9518"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9519"><span data-slate-object="text" data-key="9520"><span data-slate-leaf="true" data-offset-key="9520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9521"><span data-slate-leaf="true" data-offset-key="9521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9522"><span data-slate-leaf="true" data-offset-key="9522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> BGRA(r,g,b) ((0|(r&lt;&lt;16)|(g&lt;&lt;8)|b))</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9523"><span data-slate-object="text" data-key="9524"><span data-slate-leaf="true" data-offset-key="9524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通常情况下用 pixl_t 和 BGRA 宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9525"><span data-slate-object="text" data-key="9526"><span data-slate-leaf="true" data-offset-key="9526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="9527"><span data-slate-leaf="true" data-offset-key="9527:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9528"><span data-slate-leaf="true" data-offset-key="9528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9529"><span data-slate-leaf="true" data-offset-key="9529:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9530"><span data-slate-leaf="true" data-offset-key="9530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixl_t</span></span></span></span><span data-slate-object="text" data-key="9531"><span data-slate-leaf="true" data-offset-key="9531:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9532"><span data-slate-object="text" data-key="9533"><span data-slate-leaf="true" data-offset-key="9533:0" data-first-offset="true"><span data-slate-string="true">我们再来看看屏幕像素点和显存位置对应的计算方式：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9534"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9535"><span data-slate-object="text" data-key="9536"><span data-slate-leaf="true" data-offset-key="9536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9537"><span data-slate-leaf="true" data-offset-key="9537:0" data-first-offset="true"><span data-slate-string="true">* dispmem = (</span></span></span><span data-slate-object="text" data-key="9538"><span data-slate-leaf="true" data-offset-key="9538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9539"><span data-slate-leaf="true" data-offset-key="9539:0" data-first-offset="true"><span data-slate-string="true">*)mbsp-&gt;mb_ghparm.gh_framphyadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9540"><span data-slate-object="text" data-key="9541"><span data-slate-leaf="true" data-offset-key="9541:0" data-first-offset="true"><span data-slate-string="true">dispmem[x + (y * </span></span></span><span data-slate-object="text" data-key="9542"><span data-slate-leaf="true" data-offset-key="9542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1024</span></span></span></span><span data-slate-object="text" data-key="9543"><span data-slate-leaf="true" data-offset-key="9543:0" data-first-offset="true"><span data-slate-string="true">)] = pix;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9544"><span data-slate-object="text" data-key="9545"><span data-slate-leaf="true" data-offset-key="9545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//x，y 是像素的位置</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9546" id="sr-toc-8"><span data-slate-object="text" data-key="9547"><span data-slate-leaf="true" data-offset-key="9547:0" data-first-offset="true"><span data-slate-string="true">串联</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9548"><span data-slate-object="text" data-key="9549"><span data-slate-leaf="true" data-offset-key="9549:0" data-first-offset="true"><span data-slate-string="true">好了，所有的实施工作的函数已经完成了，现在我们需要在 init_bstartparm () 函数中把它们串联起来，即按照事情的先后顺序，依次调用它们完成相应的工作，实现检查、收集机器信息，设置工作环境。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="9550"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9551"><span data-slate-object="text" data-key="9552"><span data-slate-leaf="true" data-offset-key="9552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9553"><span data-slate-leaf="true" data-offset-key="9553:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9554"><span data-slate-leaf="true" data-offset-key="9554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bstartparm</span></span></span></span><span data-slate-object="text" data-key="9555"><span data-slate-leaf="true" data-offset-key="9555:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9556"><span data-slate-leaf="true" data-offset-key="9556:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9557"><span data-slate-object="text" data-key="9558"><span data-slate-leaf="true" data-offset-key="9558:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9559"><span data-slate-object="text" data-key="9560"><span data-slate-leaf="true" data-offset-key="9560:0" data-first-offset="true"><span data-slate-string="true">    machbstart_t *mbsp = </span></span></span><span data-slate-object="text" data-key="9561"><span data-slate-leaf="true" data-offset-key="9561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">MBSPADR</span></span></span></span><span data-slate-object="text" data-key="9562"><span data-slate-leaf="true" data-offset-key="9562:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9563"><span data-slate-object="text" data-key="9564"><span data-slate-leaf="true" data-offset-key="9564:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9565"><span data-slate-leaf="true" data-offset-key="9565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t_init</span></span></span></span><span data-slate-object="text" data-key="9566"><span data-slate-leaf="true" data-offset-key="9566:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9567"><span data-slate-object="text" data-key="9568"><span data-slate-leaf="true" data-offset-key="9568:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9569"><span data-slate-leaf="true" data-offset-key="9569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查 CPU</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9570"><span data-slate-object="text" data-key="9571"><span data-slate-leaf="true" data-offset-key="9571:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9572"><span data-slate-leaf="true" data-offset-key="9572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_chkcpu</span></span></span></span><span data-slate-object="text" data-key="9573"><span data-slate-leaf="true" data-offset-key="9573:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9574"><span data-slate-object="text" data-key="9575"><span data-slate-leaf="true" data-offset-key="9575:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9576"><span data-slate-leaf="true" data-offset-key="9576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取内存布局</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9577"><span data-slate-object="text" data-key="9578"><span data-slate-leaf="true" data-offset-key="9578:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9579"><span data-slate-leaf="true" data-offset-key="9579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_mem</span></span></span></span><span data-slate-object="text" data-key="9580"><span data-slate-leaf="true" data-offset-key="9580:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9581"><span data-slate-object="text" data-key="9582"><span data-slate-leaf="true" data-offset-key="9582:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9583"><span data-slate-leaf="true" data-offset-key="9583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9584"><span data-slate-object="text" data-key="9585"><span data-slate-leaf="true" data-offset-key="9585:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9586"><span data-slate-leaf="true" data-offset-key="9586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlinitstack</span></span></span></span><span data-slate-object="text" data-key="9587"><span data-slate-leaf="true" data-offset-key="9587:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9588"><span data-slate-object="text" data-key="9589"><span data-slate-leaf="true" data-offset-key="9589:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9590"><span data-slate-leaf="true" data-offset-key="9590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放置内核文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9591"><span data-slate-object="text" data-key="9592"><span data-slate-leaf="true" data-offset-key="9592:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9593"><span data-slate-leaf="true" data-offset-key="9593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlfile</span></span></span></span><span data-slate-object="text" data-key="9594"><span data-slate-leaf="true" data-offset-key="9594:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9595"><span data-slate-object="text" data-key="9596"><span data-slate-leaf="true" data-offset-key="9596:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9597"><span data-slate-leaf="true" data-offset-key="9597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放置字库文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9598"><span data-slate-object="text" data-key="9599"><span data-slate-leaf="true" data-offset-key="9599:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9600"><span data-slate-leaf="true" data-offset-key="9600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_defutfont</span></span></span></span><span data-slate-object="text" data-key="9601"><span data-slate-leaf="true" data-offset-key="9601:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9602"><span data-slate-object="text" data-key="9603"><span data-slate-leaf="true" data-offset-key="9603:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9604"><span data-slate-leaf="true" data-offset-key="9604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_meme820</span></span></span></span><span data-slate-object="text" data-key="9605"><span data-slate-leaf="true" data-offset-key="9605:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9606"><span data-slate-object="text" data-key="9607"><span data-slate-leaf="true" data-offset-key="9607:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9608"><span data-slate-leaf="true" data-offset-key="9608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 MMU 页表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9609"><span data-slate-object="text" data-key="9610"><span data-slate-leaf="true" data-offset-key="9610:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9611"><span data-slate-leaf="true" data-offset-key="9611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bstartpages</span></span></span></span><span data-slate-object="text" data-key="9612"><span data-slate-leaf="true" data-offset-key="9612:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9613"><span data-slate-object="text" data-key="9614"><span data-slate-leaf="true" data-offset-key="9614:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9615"><span data-slate-leaf="true" data-offset-key="9615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置图形模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9616"><span data-slate-object="text" data-key="9617"><span data-slate-leaf="true" data-offset-key="9617:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9618"><span data-slate-leaf="true" data-offset-key="9618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_graph</span></span></span></span><span data-slate-object="text" data-key="9619"><span data-slate-leaf="true" data-offset-key="9619:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9620"><span data-slate-object="text" data-key="9621"><span data-slate-leaf="true" data-offset-key="9621:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9622"><span data-slate-leaf="true" data-offset-key="9622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9623"><span data-slate-leaf="true" data-offset-key="9623:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9624"><span data-slate-object="text" data-key="9625"><span data-slate-leaf="true" data-offset-key="9625:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9626"><span data-slate-object="text" data-key="9627"><span data-slate-leaf="true" data-offset-key="9627:0" data-first-offset="true"><span data-slate-string="true">到这里，init_bstartparm () 函数就成功完成了它的使命。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9628" id="sr-toc-9"><span data-slate-object="text" data-key="9629"><span data-slate-leaf="true" data-offset-key="9629:0" data-first-offset="true"><span data-slate-string="true">显示 Logo</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9630"><span data-slate-object="text" data-key="9631"><span data-slate-leaf="true" data-offset-key="9631:0" data-first-offset="true"><span data-slate-string="true">前面我们已经设置了图形模式，也应该要展示一下了，检查一下工作成果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9632"><span data-slate-object="text" data-key="9633"><span data-slate-leaf="true" data-offset-key="9633:0" data-first-offset="true"><span data-slate-string="true">我们来显示一下我们内核的 logo。其实在二级引导器中，我已经帮你写好了显示 logo 函数，而 logo 文件是个 </span></span></span><span data-slate-object="text" data-key="9634"><span data-slate-leaf="true" data-offset-key="9634:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">24 位的位图文件</span></span></span></span><span data-slate-object="text" data-key="9635"><span data-slate-leaf="true" data-offset-key="9635:0" data-first-offset="true"><span data-slate-string="true">，目前为了简单起见，我们</span></span></span><span data-slate-object="text" data-key="9636"><span data-slate-leaf="true" data-offset-key="9636:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">只支持这种格式的图片文件</span></span></span></span><span data-slate-object="text" data-key="9637"><span data-slate-leaf="true" data-offset-key="9637:0" data-first-offset="true"><span data-slate-string="true">。下面我们去调用这个函数。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9638"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9639"><span data-slate-object="text" data-key="9640"><span data-slate-leaf="true" data-offset-key="9640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="9641"><span data-slate-leaf="true" data-offset-key="9641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9642"><span data-slate-leaf="true" data-offset-key="9642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logo</span></span></span></span></span><span data-slate-object="text" data-key="9643"><span data-slate-leaf="true" data-offset-key="9643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9644"><span data-slate-leaf="true" data-offset-key="9644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="9645"><span data-slate-leaf="true" data-offset-key="9645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* mbsp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9646"><span data-slate-object="text" data-key="9647"><span data-slate-leaf="true" data-offset-key="9647:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9648"><span data-slate-object="text" data-key="9649"><span data-slate-leaf="true" data-offset-key="9649:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9650"><span data-slate-leaf="true" data-offset-key="9650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="9651"><span data-slate-leaf="true" data-offset-key="9651:0" data-first-offset="true"><span data-slate-string="true"> retadr=</span></span></span><span data-slate-object="text" data-key="9652"><span data-slate-leaf="true" data-offset-key="9652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9653"><span data-slate-leaf="true" data-offset-key="9653:0" data-first-offset="true"><span data-slate-string="true">,sz=</span></span></span><span data-slate-object="text" data-key="9654"><span data-slate-leaf="true" data-offset-key="9654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9655"><span data-slate-leaf="true" data-offset-key="9655:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9656"><span data-slate-object="text" data-key="9657"><span data-slate-leaf="true" data-offset-key="9657:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9658"><span data-slate-leaf="true" data-offset-key="9658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在映像文件中获取 logo.bmp 文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9659"><span data-slate-object="text" data-key="9660"><span data-slate-leaf="true" data-offset-key="9660:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9661"><span data-slate-leaf="true" data-offset-key="9661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get_file_rpadrandsz</span></span></span></span><span data-slate-object="text" data-key="9662"><span data-slate-leaf="true" data-offset-key="9662:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9663"><span data-slate-leaf="true" data-offset-key="9663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"logo.bmp"</span></span></span></span><span data-slate-object="text" data-key="9664"><span data-slate-leaf="true" data-offset-key="9664:0" data-first-offset="true"><span data-slate-string="true">,mbsp,&amp;retadr,&amp;sz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9665"><span data-slate-object="text" data-key="9666"><span data-slate-leaf="true" data-offset-key="9666:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9667"><span data-slate-leaf="true" data-offset-key="9667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9668"><span data-slate-leaf="true" data-offset-key="9668:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9669"><span data-slate-leaf="true" data-offset-key="9669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9670"><span data-slate-leaf="true" data-offset-key="9670:0" data-first-offset="true"><span data-slate-string="true">==retadr)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9671"><span data-slate-object="text" data-key="9672"><span data-slate-leaf="true" data-offset-key="9672:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9673"><span data-slate-object="text" data-key="9674"><span data-slate-leaf="true" data-offset-key="9674:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9675"><span data-slate-leaf="true" data-offset-key="9675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kerror</span></span></span></span><span data-slate-object="text" data-key="9676"><span data-slate-leaf="true" data-offset-key="9676:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9677"><span data-slate-leaf="true" data-offset-key="9677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"logo getfilerpadrsz err"</span></span></span></span><span data-slate-object="text" data-key="9678"><span data-slate-leaf="true" data-offset-key="9678:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9679"><span data-slate-object="text" data-key="9680"><span data-slate-leaf="true" data-offset-key="9680:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9681"><span data-slate-object="text" data-key="9682"><span data-slate-leaf="true" data-offset-key="9682:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9683"><span data-slate-leaf="true" data-offset-key="9683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显示 logo 文件中的图像数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9684"><span data-slate-object="text" data-key="9685"><span data-slate-leaf="true" data-offset-key="9685:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9686"><span data-slate-leaf="true" data-offset-key="9686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bmp_print</span></span></span></span><span data-slate-object="text" data-key="9687"><span data-slate-leaf="true" data-offset-key="9687:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="9688"><span data-slate-leaf="true" data-offset-key="9688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9689"><span data-slate-leaf="true" data-offset-key="9689:0" data-first-offset="true"><span data-slate-string="true">*)retadr,mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9690"><span data-slate-object="text" data-key="9691"><span data-slate-leaf="true" data-offset-key="9691:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9692"><span data-slate-leaf="true" data-offset-key="9692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9693"><span data-slate-leaf="true" data-offset-key="9693:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9694"><span data-slate-object="text" data-key="9695"><span data-slate-leaf="true" data-offset-key="9695:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9696"><span data-slate-object="text" data-key="9697"><span data-slate-leaf="true" data-offset-key="9697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="9698"><span data-slate-leaf="true" data-offset-key="9698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9699"><span data-slate-leaf="true" data-offset-key="9699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_graph</span></span></span></span></span><span data-slate-object="text" data-key="9700"><span data-slate-leaf="true" data-offset-key="9700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9701"><span data-slate-leaf="true" data-offset-key="9701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="9702"><span data-slate-leaf="true" data-offset-key="9702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* mbsp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9703"><span data-slate-object="text" data-key="9704"><span data-slate-leaf="true" data-offset-key="9704:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9705"><span data-slate-object="text" data-key="9706"><span data-slate-leaf="true" data-offset-key="9706:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9707"><span data-slate-leaf="true" data-offset-key="9707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//…… 前面代码省略</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9708"><span data-slate-object="text" data-key="9709"><span data-slate-leaf="true" data-offset-key="9709:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9710"><span data-slate-leaf="true" data-offset-key="9710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显示</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9711"><span data-slate-object="text" data-key="9712"><span data-slate-leaf="true" data-offset-key="9712:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9713"><span data-slate-leaf="true" data-offset-key="9713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logo</span></span></span></span><span data-slate-object="text" data-key="9714"><span data-slate-leaf="true" data-offset-key="9714:0" data-first-offset="true"><span data-slate-string="true">(mbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9715"><span data-slate-object="text" data-key="9716"><span data-slate-leaf="true" data-offset-key="9716:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9717"><span data-slate-leaf="true" data-offset-key="9717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9718"><span data-slate-leaf="true" data-offset-key="9718:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9719"><span data-slate-object="text" data-key="9720"><span data-slate-leaf="true" data-offset-key="9720:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9721"><span data-slate-object="text" data-key="9722"><span data-slate-leaf="true" data-offset-key="9722:0" data-first-offset="true"><span data-slate-string="true">在图格式的文件中，除了文件头的数据就是图形像素点的数据，只不过 24 位的位图每个像素占用 3 字节，并且位置是倒排的，即第一个像素的数据是在文件的最后，依次类推。我们只要依次将位图文件的数据，按照倒排次序写入显存中，这样就可以显示了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9723"><span data-slate-object="text" data-key="9724"><span data-slate-leaf="true" data-offset-key="9724:0" data-first-offset="true"><span data-slate-string="true">我们需要把二级引导器的文件和 logo 文件打包成映像文件，然后放在虚拟硬盘中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9725"><span data-slate-object="text" data-key="9726"><span data-slate-leaf="true" data-offset-key="9726:0" data-first-offset="true"><span data-slate-string="true">复制文件到虚拟硬盘中得先 mount，然后复制，最后转换成 VDI 格式的虚拟硬盘，再挂载到虚拟机上启动就行了。这也是为什么要手动建立硬盘的原因，打包命令如下。</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="9727"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9728"><span data-slate-object="text" data-key="9729"><span data-slate-leaf="true" data-offset-key="9729:0" data-first-offset="true"><span data-slate-string="true">lmoskrlimg -m k -lhf initldrimh.</span></span></span><span data-slate-object="text" data-key="9730"><span data-slate-leaf="true" data-offset-key="9730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bin</span></span></span></span><span data-slate-object="text" data-key="9731"><span data-slate-leaf="true" data-offset-key="9731:0" data-first-offset="true"><span data-slate-string="true"> -o Cosmos.eki -f initldrsve.</span></span></span><span data-slate-object="text" data-key="9732"><span data-slate-leaf="true" data-offset-key="9732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bin</span></span></span></span><span data-slate-object="text" data-key="9733"><span data-slate-leaf="true" data-offset-key="9733:0" data-first-offset="true"><span data-slate-string="true"> initldrkrl.</span></span></span><span data-slate-object="text" data-key="9734"><span data-slate-leaf="true" data-offset-key="9734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bin</span></span></span></span><span data-slate-object="text" data-key="9735"><span data-slate-leaf="true" data-offset-key="9735:0" data-first-offset="true"><span data-slate-string="true"> font.fnt logo.bmp</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9736"><span data-slate-object="text" data-key="9737"><span data-slate-leaf="true" data-offset-key="9737:0" data-first-offset="true"><span data-slate-string="true">如果手动打命令对你来说还是比较难，也别担心，我已经帮你写好了 make 脚本，你只需要进入代码目录中 make vboxtest 就行了，运行结果如下 。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9738"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c3/y0/c3d4f0b072b837f208fbd52749913yy0.jpg?wh=1054*931"></div><div>代码运行结果示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9739"><span data-slate-object="text" data-key="9740"><span data-slate-leaf="true" data-offset-key="9740:0" data-first-offset="true"><span data-slate-string="true">啊哈！终于显示了 logo。是不是挺有成就感的？这至少证明我们辛苦写的代码是正确的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9741"><span data-slate-object="text" data-key="9742"><span data-slate-leaf="true" data-offset-key="9742:0" data-first-offset="true"><span data-slate-string="true">但是目前我们的代码执行流还在二级引导器中，我们的目的是开发自己的操作系统，不，我们是要开发 Cosmos。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9743"><span data-slate-object="text" data-key="9744"><span data-slate-leaf="true" data-offset-key="9744:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">后面，我们正式用 Cosmos 命名我们的操作系统。</span></span></span></span><span data-slate-object="text" data-key="9745"><span data-slate-leaf="true" data-offset-key="9745:0" data-first-offset="true"><span data-slate-string="true">Cosmos 可以翻译成宇宙，尽管它刚刚诞生，但我对它充满期待，所以用了这样一个能够 “包括万物，包罗万象” 的名字。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9746" id="sr-toc-10"><span data-slate-object="text" data-key="9747"><span data-slate-leaf="true" data-offset-key="9747:0" data-first-offset="true"><span data-slate-string="true">进入 Cosmos</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9748"><span data-slate-object="text" data-key="9749"><span data-slate-leaf="true" data-offset-key="9749:0" data-first-offset="true"><span data-slate-string="true">我们在调用 Cosmos 第一个 C 函数之前，我们依然要写一小段汇编代码，切换 CPU 到长模式，初始化 CPU 寄存器和 C 语言要用的栈。因为目前代码执行流在二级引导器中，进入到 Cosmos 中这样在二级引导器中初始过的东西都不能用了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9750"><span data-slate-object="text" data-key="9751"><span data-slate-leaf="true" data-offset-key="9751:0" data-first-offset="true"><span data-slate-string="true">因为 CPU 进入了长模式，寄存器的位宽都变了，所以需要重新初始化。让我们一起来写这段汇编代码吧，我们先在 Cosmos/hal/x86/ 下建立一个 init_entry.asm 文件，写上后面这段代码。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9752"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div><div data-code-line-number="78"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9753"><span data-slate-object="text" data-key="9754"><span data-slate-leaf="true" data-offset-key="9754:0" data-first-offset="true"><span data-slate-string="true">[section .start.text]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9755"><span data-slate-object="text" data-key="9756"><span data-slate-leaf="true" data-offset-key="9756:0" data-first-offset="true"><span data-slate-string="true">[BITS </span></span></span><span data-slate-object="text" data-key="9757"><span data-slate-leaf="true" data-offset-key="9757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="9758"><span data-slate-leaf="true" data-offset-key="9758:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9759"><span data-slate-object="text" data-key="9760"><span data-slate-leaf="true" data-offset-key="9760:0" data-first-offset="true"><span data-slate-string="true">_start:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9761"><span data-slate-object="text" data-key="9762"><span data-slate-leaf="true" data-offset-key="9762:0" data-first-offset="true"><span data-slate-string="true">    cli</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9763"><span data-slate-object="text" data-key="9764"><span data-slate-leaf="true" data-offset-key="9764:0" data-first-offset="true"><span data-slate-string="true">    mov ax,</span></span></span><span data-slate-object="text" data-key="9765"><span data-slate-leaf="true" data-offset-key="9765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x10</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9766"><span data-slate-object="text" data-key="9767"><span data-slate-leaf="true" data-offset-key="9767:0" data-first-offset="true"><span data-slate-string="true">    mov ds,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9768"><span data-slate-object="text" data-key="9769"><span data-slate-leaf="true" data-offset-key="9769:0" data-first-offset="true"><span data-slate-string="true">    mov es,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9770"><span data-slate-object="text" data-key="9771"><span data-slate-leaf="true" data-offset-key="9771:0" data-first-offset="true"><span data-slate-string="true">    mov ss,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9772"><span data-slate-object="text" data-key="9773"><span data-slate-leaf="true" data-offset-key="9773:0" data-first-offset="true"><span data-slate-string="true">    mov fs,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9774"><span data-slate-object="text" data-key="9775"><span data-slate-leaf="true" data-offset-key="9775:0" data-first-offset="true"><span data-slate-string="true">    mov gs,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9776"><span data-slate-object="text" data-key="9777"><span data-slate-leaf="true" data-offset-key="9777:0" data-first-offset="true"><span data-slate-string="true">    lgdt [eGdtPtr]        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9778"><span data-slate-object="text" data-key="9779"><span data-slate-leaf="true" data-offset-key="9779:0" data-first-offset="true"><span data-slate-string="true">    ; 开启 PAE</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9780"><span data-slate-object="text" data-key="9781"><span data-slate-leaf="true" data-offset-key="9781:0" data-first-offset="true"><span data-slate-string="true">    mov eax, cr4</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9782"><span data-slate-object="text" data-key="9783"><span data-slate-leaf="true" data-offset-key="9783:0" data-first-offset="true"><span data-slate-string="true">    bts eax, </span></span></span><span data-slate-object="text" data-key="9784"><span data-slate-leaf="true" data-offset-key="9784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="9785"><span data-slate-leaf="true" data-offset-key="9785:0" data-first-offset="true"><span data-slate-string="true">                      ; CR4.PAE = </span></span></span><span data-slate-object="text" data-key="9786"><span data-slate-leaf="true" data-offset-key="9786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9787"><span data-slate-object="text" data-key="9788"><span data-slate-leaf="true" data-offset-key="9788:0" data-first-offset="true"><span data-slate-string="true">    mov cr4, eax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9789"><span data-slate-object="text" data-key="9790"><span data-slate-leaf="true" data-offset-key="9790:0" data-first-offset="true"><span data-slate-string="true">    mov eax, PML4T_BADR             ; 加载 MMU 顶级页目录</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9791"><span data-slate-object="text" data-key="9792"><span data-slate-leaf="true" data-offset-key="9792:0" data-first-offset="true"><span data-slate-string="true">    mov cr3, eax  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9793"><span data-slate-object="text" data-key="9794"><span data-slate-leaf="true" data-offset-key="9794:0" data-first-offset="true"><span data-slate-string="true">    ; 开启 </span></span></span><span data-slate-object="text" data-key="9795"><span data-slate-leaf="true" data-offset-key="9795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64b</span></span></span></span><span data-slate-object="text" data-key="9796"><span data-slate-leaf="true" data-offset-key="9796:0" data-first-offset="true"><span data-slate-string="true">its </span></span></span><span data-slate-object="text" data-key="9797"><span data-slate-leaf="true" data-offset-key="9797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="9798"><span data-slate-leaf="true" data-offset-key="9798:0" data-first-offset="true"><span data-slate-string="true">-mode</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9799"><span data-slate-object="text" data-key="9800"><span data-slate-leaf="true" data-offset-key="9800:0" data-first-offset="true"><span data-slate-string="true">    mov ecx, IA32_EFER</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9801"><span data-slate-object="text" data-key="9802"><span data-slate-leaf="true" data-offset-key="9802:0" data-first-offset="true"><span data-slate-string="true">    rdmsr</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9803"><span data-slate-object="text" data-key="9804"><span data-slate-leaf="true" data-offset-key="9804:0" data-first-offset="true"><span data-slate-string="true">    bts eax, </span></span></span><span data-slate-object="text" data-key="9805"><span data-slate-leaf="true" data-offset-key="9805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span><span data-slate-object="text" data-key="9806"><span data-slate-leaf="true" data-offset-key="9806:0" data-first-offset="true"><span data-slate-string="true">                      ; IA32_EFER.LME =</span></span></span><span data-slate-object="text" data-key="9807"><span data-slate-leaf="true" data-offset-key="9807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9808"><span data-slate-object="text" data-key="9809"><span data-slate-leaf="true" data-offset-key="9809:0" data-first-offset="true"><span data-slate-string="true">    wrmsr</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9810"><span data-slate-object="text" data-key="9811"><span data-slate-leaf="true" data-offset-key="9811:0" data-first-offset="true"><span data-slate-string="true">    ; 开启 PE 和 paging</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9812"><span data-slate-object="text" data-key="9813"><span data-slate-leaf="true" data-offset-key="9813:0" data-first-offset="true"><span data-slate-string="true">    mov eax, cr0</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9814"><span data-slate-object="text" data-key="9815"><span data-slate-leaf="true" data-offset-key="9815:0" data-first-offset="true"><span data-slate-string="true">    bts eax, </span></span></span><span data-slate-object="text" data-key="9816"><span data-slate-leaf="true" data-offset-key="9816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9817"><span data-slate-leaf="true" data-offset-key="9817:0" data-first-offset="true"><span data-slate-string="true">                      ; CR0.PE =</span></span></span><span data-slate-object="text" data-key="9818"><span data-slate-leaf="true" data-offset-key="9818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9819"><span data-slate-object="text" data-key="9820"><span data-slate-leaf="true" data-offset-key="9820:0" data-first-offset="true"><span data-slate-string="true">    bts eax, </span></span></span><span data-slate-object="text" data-key="9821"><span data-slate-leaf="true" data-offset-key="9821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">31</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9822"><span data-slate-object="text" data-key="9823"><span data-slate-leaf="true" data-offset-key="9823:0" data-first-offset="true"><span data-slate-string="true">    ; 开启 CACHE       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9824"><span data-slate-object="text" data-key="9825"><span data-slate-leaf="true" data-offset-key="9825:0" data-first-offset="true"><span data-slate-string="true">    btr eax,</span></span></span><span data-slate-object="text" data-key="9826"><span data-slate-leaf="true" data-offset-key="9826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29</span></span></span></span><span data-slate-object="text" data-key="9827"><span data-slate-leaf="true" data-offset-key="9827:0" data-first-offset="true"><span data-slate-string="true">                    ; CR0.NW=</span></span></span><span data-slate-object="text" data-key="9828"><span data-slate-leaf="true" data-offset-key="9828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9829"><span data-slate-object="text" data-key="9830"><span data-slate-leaf="true" data-offset-key="9830:0" data-first-offset="true"><span data-slate-string="true">    btr eax,</span></span></span><span data-slate-object="text" data-key="9831"><span data-slate-leaf="true" data-offset-key="9831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">30</span></span></span></span><span data-slate-object="text" data-key="9832"><span data-slate-leaf="true" data-offset-key="9832:0" data-first-offset="true"><span data-slate-string="true">                    ; CR0.CD=</span></span></span><span data-slate-object="text" data-key="9833"><span data-slate-leaf="true" data-offset-key="9833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9834"><span data-slate-leaf="true" data-offset-key="9834:0" data-first-offset="true"><span data-slate-string="true">  CACHE</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9835"><span data-slate-object="text" data-key="9836"><span data-slate-leaf="true" data-offset-key="9836:0" data-first-offset="true"><span data-slate-string="true">    mov cr0, eax                    ; IA32_EFER.LMA = </span></span></span><span data-slate-object="text" data-key="9837"><span data-slate-leaf="true" data-offset-key="9837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9838"><span data-slate-object="text" data-key="9839"><span data-slate-leaf="true" data-offset-key="9839:0" data-first-offset="true"><span data-slate-string="true">    jmp </span></span></span><span data-slate-object="text" data-key="9840"><span data-slate-leaf="true" data-offset-key="9840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">08</span></span></span></span><span data-slate-object="text" data-key="9841"><span data-slate-leaf="true" data-offset-key="9841:0" data-first-offset="true"><span data-slate-string="true">:entry64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9842"><span data-slate-object="text" data-key="9843"><span data-slate-leaf="true" data-offset-key="9843:0" data-first-offset="true"><span data-slate-string="true">[BITS </span></span></span><span data-slate-object="text" data-key="9844"><span data-slate-leaf="true" data-offset-key="9844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="9845"><span data-slate-leaf="true" data-offset-key="9845:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9846"><span data-slate-object="text" data-key="9847"><span data-slate-leaf="true" data-offset-key="9847:0" data-first-offset="true"><span data-slate-string="true">entry64:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9848"><span data-slate-object="text" data-key="9849"><span data-slate-leaf="true" data-offset-key="9849:0" data-first-offset="true"><span data-slate-string="true">    mov ax,</span></span></span><span data-slate-object="text" data-key="9850"><span data-slate-leaf="true" data-offset-key="9850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x10</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9851"><span data-slate-object="text" data-key="9852"><span data-slate-leaf="true" data-offset-key="9852:0" data-first-offset="true"><span data-slate-string="true">    mov ds,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9853"><span data-slate-object="text" data-key="9854"><span data-slate-leaf="true" data-offset-key="9854:0" data-first-offset="true"><span data-slate-string="true">    mov es,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9855"><span data-slate-object="text" data-key="9856"><span data-slate-leaf="true" data-offset-key="9856:0" data-first-offset="true"><span data-slate-string="true">    mov ss,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9857"><span data-slate-object="text" data-key="9858"><span data-slate-leaf="true" data-offset-key="9858:0" data-first-offset="true"><span data-slate-string="true">    mov fs,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9859"><span data-slate-object="text" data-key="9860"><span data-slate-leaf="true" data-offset-key="9860:0" data-first-offset="true"><span data-slate-string="true">    mov gs,ax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9861"><span data-slate-object="text" data-key="9862"><span data-slate-leaf="true" data-offset-key="9862:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9863"><span data-slate-leaf="true" data-offset-key="9863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9864"><span data-slate-leaf="true" data-offset-key="9864:0" data-first-offset="true"><span data-slate-string="true"> rax,rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9865"><span data-slate-object="text" data-key="9866"><span data-slate-leaf="true" data-offset-key="9866:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9867"><span data-slate-leaf="true" data-offset-key="9867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9868"><span data-slate-leaf="true" data-offset-key="9868:0" data-first-offset="true"><span data-slate-string="true"> rbx,rbx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9869"><span data-slate-object="text" data-key="9870"><span data-slate-leaf="true" data-offset-key="9870:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9871"><span data-slate-leaf="true" data-offset-key="9871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9872"><span data-slate-leaf="true" data-offset-key="9872:0" data-first-offset="true"><span data-slate-string="true"> rbp,rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9873"><span data-slate-object="text" data-key="9874"><span data-slate-leaf="true" data-offset-key="9874:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9875"><span data-slate-leaf="true" data-offset-key="9875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9876"><span data-slate-leaf="true" data-offset-key="9876:0" data-first-offset="true"><span data-slate-string="true"> rcx,rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9877"><span data-slate-object="text" data-key="9878"><span data-slate-leaf="true" data-offset-key="9878:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9879"><span data-slate-leaf="true" data-offset-key="9879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9880"><span data-slate-leaf="true" data-offset-key="9880:0" data-first-offset="true"><span data-slate-string="true"> rdx,rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9881"><span data-slate-object="text" data-key="9882"><span data-slate-leaf="true" data-offset-key="9882:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9883"><span data-slate-leaf="true" data-offset-key="9883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9884"><span data-slate-leaf="true" data-offset-key="9884:0" data-first-offset="true"><span data-slate-string="true"> rdi,rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9885"><span data-slate-object="text" data-key="9886"><span data-slate-leaf="true" data-offset-key="9886:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9887"><span data-slate-leaf="true" data-offset-key="9887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9888"><span data-slate-leaf="true" data-offset-key="9888:0" data-first-offset="true"><span data-slate-string="true"> rsi,rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9889"><span data-slate-object="text" data-key="9890"><span data-slate-leaf="true" data-offset-key="9890:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9891"><span data-slate-leaf="true" data-offset-key="9891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9892"><span data-slate-leaf="true" data-offset-key="9892:0" data-first-offset="true"><span data-slate-string="true"> r8,r8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9893"><span data-slate-object="text" data-key="9894"><span data-slate-leaf="true" data-offset-key="9894:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9895"><span data-slate-leaf="true" data-offset-key="9895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9896"><span data-slate-leaf="true" data-offset-key="9896:0" data-first-offset="true"><span data-slate-string="true"> r9,r9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9897"><span data-slate-object="text" data-key="9898"><span data-slate-leaf="true" data-offset-key="9898:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9899"><span data-slate-leaf="true" data-offset-key="9899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9900"><span data-slate-leaf="true" data-offset-key="9900:0" data-first-offset="true"><span data-slate-string="true"> r10,r10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9901"><span data-slate-object="text" data-key="9902"><span data-slate-leaf="true" data-offset-key="9902:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9903"><span data-slate-leaf="true" data-offset-key="9903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9904"><span data-slate-leaf="true" data-offset-key="9904:0" data-first-offset="true"><span data-slate-string="true"> r11,r11</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9905"><span data-slate-object="text" data-key="9906"><span data-slate-leaf="true" data-offset-key="9906:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9907"><span data-slate-leaf="true" data-offset-key="9907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9908"><span data-slate-leaf="true" data-offset-key="9908:0" data-first-offset="true"><span data-slate-string="true"> r12,r12</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9909"><span data-slate-object="text" data-key="9910"><span data-slate-leaf="true" data-offset-key="9910:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9911"><span data-slate-leaf="true" data-offset-key="9911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9912"><span data-slate-leaf="true" data-offset-key="9912:0" data-first-offset="true"><span data-slate-string="true"> r13,r13</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9913"><span data-slate-object="text" data-key="9914"><span data-slate-leaf="true" data-offset-key="9914:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9915"><span data-slate-leaf="true" data-offset-key="9915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9916"><span data-slate-leaf="true" data-offset-key="9916:0" data-first-offset="true"><span data-slate-string="true"> r14,r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9917"><span data-slate-object="text" data-key="9918"><span data-slate-leaf="true" data-offset-key="9918:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9919"><span data-slate-leaf="true" data-offset-key="9919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9920"><span data-slate-leaf="true" data-offset-key="9920:0" data-first-offset="true"><span data-slate-string="true"> r15,r15</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9921"><span data-slate-object="text" data-key="9922"><span data-slate-leaf="true" data-offset-key="9922:0" data-first-offset="true"><span data-slate-string="true">    mov rbx,MBSP_ADR</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9923"><span data-slate-object="text" data-key="9924"><span data-slate-leaf="true" data-offset-key="9924:0" data-first-offset="true"><span data-slate-string="true">    mov rax,KRLVIRADR</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9925"><span data-slate-object="text" data-key="9926"><span data-slate-leaf="true" data-offset-key="9926:0" data-first-offset="true"><span data-slate-string="true">    mov rcx,[rbx+KINITSTACK_OFF]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9927"><span data-slate-object="text" data-key="9928"><span data-slate-leaf="true" data-offset-key="9928:0" data-first-offset="true"><span data-slate-string="true">    add rax,rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9929"><span data-slate-object="text" data-key="9930"><span data-slate-leaf="true" data-offset-key="9930:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9931"><span data-slate-leaf="true" data-offset-key="9931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9932"><span data-slate-leaf="true" data-offset-key="9932:0" data-first-offset="true"><span data-slate-string="true"> rcx,rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9933"><span data-slate-object="text" data-key="9934"><span data-slate-leaf="true" data-offset-key="9934:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9935"><span data-slate-leaf="true" data-offset-key="9935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xor</span></span></span></span><span data-slate-object="text" data-key="9936"><span data-slate-leaf="true" data-offset-key="9936:0" data-first-offset="true"><span data-slate-string="true"> rbx,rbx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9937"><span data-slate-object="text" data-key="9938"><span data-slate-leaf="true" data-offset-key="9938:0" data-first-offset="true"><span data-slate-string="true">    mov rsp,rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9939"><span data-slate-object="text" data-key="9940"><span data-slate-leaf="true" data-offset-key="9940:0" data-first-offset="true"><span data-slate-string="true">    push </span></span></span><span data-slate-object="text" data-key="9941"><span data-slate-leaf="true" data-offset-key="9941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9942"><span data-slate-object="text" data-key="9943"><span data-slate-leaf="true" data-offset-key="9943:0" data-first-offset="true"><span data-slate-string="true">    push </span></span></span><span data-slate-object="text" data-key="9944"><span data-slate-leaf="true" data-offset-key="9944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x8</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9945"><span data-slate-object="text" data-key="9946"><span data-slate-leaf="true" data-offset-key="9946:0" data-first-offset="true"><span data-slate-string="true">    mov rax,hal_start                 ; 调用内核主函数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9947"><span data-slate-object="text" data-key="9948"><span data-slate-leaf="true" data-offset-key="9948:0" data-first-offset="true"><span data-slate-string="true">    push rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9949"><span data-slate-object="text" data-key="9950"><span data-slate-leaf="true" data-offset-key="9950:0" data-first-offset="true"><span data-slate-string="true">    dw </span></span></span><span data-slate-object="text" data-key="9951"><span data-slate-leaf="true" data-offset-key="9951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xcb48</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9952"><span data-slate-object="text" data-key="9953"><span data-slate-leaf="true" data-offset-key="9953:0" data-first-offset="true"><span data-slate-string="true">    jmp $</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9954"><span data-slate-object="text" data-key="9955"><span data-slate-leaf="true" data-offset-key="9955:0" data-first-offset="true"><span data-slate-string="true">[section .start.data]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9956"><span data-slate-object="text" data-key="9957"><span data-slate-leaf="true" data-offset-key="9957:0" data-first-offset="true"><span data-slate-string="true">[BITS </span></span></span><span data-slate-object="text" data-key="9958"><span data-slate-leaf="true" data-offset-key="9958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="9959"><span data-slate-leaf="true" data-offset-key="9959:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9960"><span data-slate-object="text" data-key="9961"><span data-slate-leaf="true" data-offset-key="9961:0" data-first-offset="true"><span data-slate-string="true">x64_GDT:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9962"><span data-slate-object="text" data-key="9963"><span data-slate-leaf="true" data-offset-key="9963:0" data-first-offset="true"><span data-slate-string="true">enull_x64_dsc:  dq </span></span></span><span data-slate-object="text" data-key="9964"><span data-slate-leaf="true" data-offset-key="9964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9965"><span data-slate-leaf="true" data-offset-key="9965:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9966"><span data-slate-object="text" data-key="9967"><span data-slate-leaf="true" data-offset-key="9967:0" data-first-offset="true"><span data-slate-string="true">ekrnl_c64_dsc:  dq </span></span></span><span data-slate-object="text" data-key="9968"><span data-slate-leaf="true" data-offset-key="9968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x0020980000000000</span></span></span></span><span data-slate-object="text" data-key="9969"><span data-slate-leaf="true" data-offset-key="9969:0" data-first-offset="true"><span data-slate-string="true">   ; </span></span></span><span data-slate-object="text" data-key="9970"><span data-slate-leaf="true" data-offset-key="9970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="9971"><span data-slate-leaf="true" data-offset-key="9971:0" data-first-offset="true"><span data-slate-string="true">-bit 内核代码段</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9972"><span data-slate-object="text" data-key="9973"><span data-slate-leaf="true" data-offset-key="9973:0" data-first-offset="true"><span data-slate-string="true">ekrnl_d64_dsc:  dq </span></span></span><span data-slate-object="text" data-key="9974"><span data-slate-leaf="true" data-offset-key="9974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x0000920000000000</span></span></span></span><span data-slate-object="text" data-key="9975"><span data-slate-leaf="true" data-offset-key="9975:0" data-first-offset="true"><span data-slate-string="true">   ; </span></span></span><span data-slate-object="text" data-key="9976"><span data-slate-leaf="true" data-offset-key="9976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="9977"><span data-slate-leaf="true" data-offset-key="9977:0" data-first-offset="true"><span data-slate-string="true">-bit 内核数据段</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9978"><span data-slate-object="text" data-key="9979"><span data-slate-leaf="true" data-offset-key="9979:0" data-first-offset="true"><span data-slate-string="true">euser_c64_dsc:  dq </span></span></span><span data-slate-object="text" data-key="9980"><span data-slate-leaf="true" data-offset-key="9980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x0020f80000000000</span></span></span></span><span data-slate-object="text" data-key="9981"><span data-slate-leaf="true" data-offset-key="9981:0" data-first-offset="true"><span data-slate-string="true">   ; </span></span></span><span data-slate-object="text" data-key="9982"><span data-slate-leaf="true" data-offset-key="9982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="9983"><span data-slate-leaf="true" data-offset-key="9983:0" data-first-offset="true"><span data-slate-string="true">-bit 用户代码段</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9984"><span data-slate-object="text" data-key="9985"><span data-slate-leaf="true" data-offset-key="9985:0" data-first-offset="true"><span data-slate-string="true">euser_d64_dsc:  dq </span></span></span><span data-slate-object="text" data-key="9986"><span data-slate-leaf="true" data-offset-key="9986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x0000f20000000000</span></span></span></span><span data-slate-object="text" data-key="9987"><span data-slate-leaf="true" data-offset-key="9987:0" data-first-offset="true"><span data-slate-string="true">   ; </span></span></span><span data-slate-object="text" data-key="9988"><span data-slate-leaf="true" data-offset-key="9988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="9989"><span data-slate-leaf="true" data-offset-key="9989:0" data-first-offset="true"><span data-slate-string="true">-bit 用户数据段</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9990"><span data-slate-object="text" data-key="9991"><span data-slate-leaf="true" data-offset-key="9991:0" data-first-offset="true"><span data-slate-string="true">eGdtLen      equ  $ - enull_x64_dsc   ; GDT 长度</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9992"><span data-slate-object="text" data-key="9993"><span data-slate-leaf="true" data-offset-key="9993:0" data-first-offset="true"><span data-slate-string="true">eGdtPtr:    dw eGdtLen - </span></span></span><span data-slate-object="text" data-key="9994"><span data-slate-leaf="true" data-offset-key="9994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9995"><span data-slate-leaf="true" data-offset-key="9995:0" data-first-offset="true"><span data-slate-string="true">      ; GDT 界限</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9996"><span data-slate-object="text" data-key="9997"><span data-slate-leaf="true" data-offset-key="9997:0" data-first-offset="true"><span data-slate-string="true">        dq ex64_GDT</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9998"><span data-slate-object="text" data-key="9999"><span data-slate-leaf="true" data-offset-key="9999:0" data-first-offset="true"><span data-slate-string="true">上述代码中，1～11 行表示加载 70～75 行的 GDT，13～17 行是设置 MMU 并加载在二级引导器中准备好的 MMU 页表，19～30 行是开启长模式并打开 Cache，34～54 行则是初始化长模式下的寄存器，55～61 行是读取二级引导器准备的机器信息结构中的栈地址，并用这个数据设置 RSP 寄存器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10000"><span data-slate-object="text" data-key="10001"><span data-slate-leaf="true" data-offset-key="10001:0" data-first-offset="true"><span data-slate-string="true">最关键的是 63～66 行，它开始把 8 和 hal_start 函数的地址压入栈中。dw 0xcb48 是直接写一条指令的机器码 ——0xcb48，这是一条返回指令。这个返回指令有点特殊，它会把栈中的数据分别弹出到 RIP，CS 寄存器，这正是为了调用我们 Cosmos 的</span></span></span><span data-slate-object="text" data-key="10002"><span data-slate-leaf="true" data-offset-key="10002:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一个 C 函数 hal_start</span></span></span></span><span data-slate-object="text" data-key="10003"><span data-slate-leaf="true" data-offset-key="10003:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10004" id="sr-toc-11"><span data-slate-object="text" data-key="10005"><span data-slate-leaf="true" data-offset-key="10005:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10006"><span data-slate-object="text" data-key="10007"><span data-slate-leaf="true" data-offset-key="10007:0" data-first-offset="true"><span data-slate-string="true">这是我们设置工作模式与环境的最后一课，到此为止我们的二级引导器已经建立起来了，成功从 GRUB 手中接过了权柄，开始了它自己的一系列工作，二级引导器完成的工作不算少，我来帮你梳理一下，重点如下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10008"><span data-slate-object="text" data-key="10009"><span data-slate-leaf="true" data-offset-key="10009:0" data-first-offset="true"><span data-slate-string="true">1. 二级引导器彻底摆脱了 GRUB 的控制之后，就开始检查 CPU，获取内存布局信息，确认是不是我们要求的 CPU 和内存大小，接着初始化内核栈、放置好内核文件和字库文件，建立 MMU 页表数据和设置好图形模式，为后面运行内核做好准备。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10010"><span data-slate-object="text" data-key="10011"><span data-slate-leaf="true" data-offset-key="10011:0" data-first-offset="true"><span data-slate-string="true">2. 当二级引导器完成了上述功能后，就会显示我们操作系统的 logo，这标志着二级引导器所有的工作一切正常。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10012"><span data-slate-object="text" data-key="10013"><span data-slate-leaf="true" data-offset-key="10013:0" data-first-offset="true"><span data-slate-string="true">3. 进入 Cosmos，我们的二级引导器通过跳转到 Cosmos 的入口，结束了自己光荣使命，Cosmos 的入口是一小段汇编代码，主要是开启 CPU 的长模式，最后调用了 Cosmos 的第一个 C 函数 hal_start。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10014"><span data-slate-object="text" data-key="10015"><span data-slate-leaf="true" data-offset-key="10015:0" data-first-offset="true"><span data-slate-string="true">你想过吗？我们的二级引导器还可以做更多的事情，其实还可以在二级引导器中获取 ACPI 表，进而获取 CPU 数量和其它设备信息，期待你的实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10016" id="sr-toc-12"><span data-slate-object="text" data-key="10017"><span data-slate-leaf="true" data-offset-key="10017:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10018"><span data-slate-object="text" data-key="10019"><span data-slate-leaf="true" data-offset-key="10019:0" data-first-offset="true"><span data-slate-string="true">请你想一下，init_bstartparm () 函数中的 init_mem820 () 函数，这个函数到底干了什么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10020"><span data-slate-object="text" data-key="10021"><span data-slate-leaf="true" data-offset-key="10021:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我互动。如果你身边有朋友对手写操作系统有热情，也欢迎你把这节课转发给他。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>24</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-13">精选留言 (72)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>大体上整理了一下，有几处没弄清楚【下半部分】：
11、返回到 bstartparm.c
调用了 chkcpmm.c 的 init_bstartpages

12、然后调用到了 fs.c 的 move_krlimg 函数申请了内存，建立了 MMU 页表：
顶级页目录，开始于 0x1000000
页目录指针目录，开始于 0x1001000，，共 16 项 ，其中每一项都指向一个页目录
页目录，开始于 0x1002000， 每页指向 512 个物理页，每页 2MB【 0x200000】

让物理地址 p [0] 和虚拟地址 p [((KRNL_VIRTUAL_ADDRESS_START) &gt;&gt; KPML4_SHIFT) &amp; 0x1ff]，指向同一个页目录指针页，确保内核在启动初期，虚拟地址和物理地址要保持相同
没搞清楚为什么虚拟地址是这个，也暂时没搞清楚为何要指向 (u64_t)((u32_t) pdpte | KPML4_RW | KPML4_P)

最后，把页表首地址保存在机器信息结构中

13、返回到 bstartparm.c
调用了 graph.c 的 init_graph
A、初始化了数据结构

B、调用 init_bgadevice
首先获取 GBA 设备 ID
检查设备最大分辨率
设置显示参数，并将参数保存到 mbsp 结构中

C、如果不是图形模式，要通过 BIOS 中断进行切换，设置显示参数，并将参数保存到 mbsp 结构中：
获取 VBE 模式，通过 BIOS 中断
获取一个具体 VBE 模式的信息，通过 BIOS 中断
设置 VBE 模式，通过 BIOS 中断
这三个方法同样用到了 realadr_call_entry，调用路径与上面_getmmap 类似，不再展开

D、初始化了一块儿内存
感觉会与物理地址与虚拟地址之间转换由一定关系

E、进行 logo 显示
调用 get_file_rpadrandsz 定位到位图文件
调用 bmp_print，读入像素点，BGRA 转换
最后调用 write_pixcolor，写入到 mbsp-&gt;mb_ghparm 正确的位置，图像就显示出来了

14、然后一路返回
到 bstartparm.c 的 init_bstartparm
到 ldrkrlentry.c 的 ldrkrl_entry
到 ldrkrl32.asm 的 call ldrkrl_entry
再往下是 jmp 0x2000000
这个地址就是 IMGKRNL_PHYADR，就是刚才放 Cosmos.eki 的位置

15、然后就接上了本节最后一部分内容了，不容易啊！哈哈哈！</div><div><p>作者回复：因为有一段 地址是物理地址，二级引导器中，并没有切换到长模式，是没有办法使用高端的物理地址，只能从低端地址切换</p></div><div><div>2021-06-05</div><div><div><i></i></div><div><i></i><span>16</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>大体上整理了一下，有几处没弄清楚【上半部分】：

1、bstartparm.c 从 init_bstartparm 函数开始
A、初始化 machbstart_t

2、跳转到 chkcpmm.c 的 init_chkcpu 函数，检查是否支持 CPUID 功能
A、init_chkcpu 函数
CPU 自带检查方式：无法反转 Eflags 第 21 位，表示 CPU 支持 CPUID 功能
如果反转成功，说明不支持 CPUID，打印内核错误并退出
B、然后调用 CPUID 功能，判断是否支持长模式
先通过通过 0x80000000 参数，调用 cpuid 命令，判断 CPU 是否支持扩展处理器信息【返回值比 0x80000000 大】
如果支持，通过 0x80000001 参数，调用 cpuid 命令，获取扩展处理器信息，然后检测第 29 位，判断是否支持长模式
如果不支持，打印内核错误并退出
C、设置 mbsp 中 cpumode 为 64 位

3、返回 chkcpmm.c，继续检测内存信息
A、跳转到 chkcpmm.c 的 init_mem 函数
B、通过 mmap 调用 realadr_call_entry (RLINTNR (0),0,0)
C、实际会执行 ldrkrl32.asm 的 realadr_call_entry
D、跳转到 save_eip_jmp
E、最后在 cpmty_mode 处，把 0x18：0x1000 [段描述索引：段内的偏移]，装入到 CS：EIP 寄存器中
F、而 EIP 这个地址恰恰是内存中 initldrsve.bin 的位置，因为之前 write_realintsvefile 把数据加载到了 REALDRV_PHYADR  0x1000【而且在 initldrsve.lds 好像也指定了段内偏移 0x1000】
同时 CS 中段描述符为 k16cd_dsc，说明是 16 位代码段，可以执行，CPU 继续从 EIP 地址执行
G、而 initldrsve.bin 是由 realintsve.asm 编译得到的，所以实际会继续执行 realintsve.asm 中代码
H、然后到 real_entry 这里，通过传入的参数 ax，判断调用 func_table 哪个方法
当前参数位 0，ax 就是 0，也就是调用了 func_table 的第一个函数_getmmap
I、_getmmap 中，通过 BIOS 的 15h 中断，获取内存信息
J、检查内存信息，如果小于 128M，打印内核错误并退出
K、设置 machbstart_t 内存相关参数
L、然后调用了 init_acpi

4、在 init_acpi 中
通过 “RSD PTR ” 及校验，判断是否支持 ACPI 功能
不支持则 打印内核错误并退出

5、返回到 bstartparm.c
好像是确认了一下 initldrsve.bin 的状态，获取了一下文件内存地址及大小

6、返回到 bstartparm.c，继续调用到 chkcpmm.c 的 init_krlinitstack 函数

7、然后调用到了 fs.c 的 move_krlimg 函数
首先判断新申请的地址，是否可用
-》如果可用直接使用
-》如果不可用，则判断申请的内存大小是否超出设备物理大小
-》-》如果超出大小，系统打印内核错误并退出
-》-》如果不超出大小，系统会将内存对齐到 0x1000 后，将 initldrsve.bin 移动到新位置，并修正地址
整体来说 move_krlimg 更像是申请内存，但不知道为何要不断驱赶 initldrsve.bin 文件

8、返回到 chkcpmm.c
初始化栈顶和栈大小

9、返回到 bstartparm.c
调用 fs.c 的 init_krlfile 函数，将 Cosmos.eki 加载到了 IMGKRNL_PHYADR
并填写了 mbsp 相关内容

10、返回到 bstartparm.c
调用了 chkcpmm.c 的 init_meme820 函数
然后调用到了 fs.c 的 move_krlimg 函数申请了内存，拷贝了一份 e820map_t 到 Cosmos.eki 之后的地址，并修正 mbsp 指向新地址
感觉和内存保护 或 物理地址与虚拟地址之间转换有一定关系</div><div><p>作者回复：是的，你学的很透</p></div><div><div>2021-06-05</div><div><div><i></i><span>6</span></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/24/dd/cc/9c926552.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 言 C</span></div><span>置顶</span></div><div>经过一段时间的摸索，今天终于成功显示了 Cosmos 的 logo 界面了，遇到了几个坑，特此来给大家填坑了：
1、出现无法找到 Cosmos 的错误提示，如下：
正在生成 Cosmos 内核映像文件，请稍后……
文件数：6
映像文件大小：4911104
Converting from raw image file="../hd.img" to file="../exckrnl/hd.vdi"...
Creating dynamic image with size 104857600 bytes (100MB)...
VBoxManage: error: Could not find a registered machine named 'Cosmos'
VBoxManage: error: Details: code VBOX_E_OBJECT_NOT_FOUND (0x80bb0001), component VirtualBoxWrap, interface IVirtualBox, callee nsISupports
VBoxManage: error: Context: "FindMachine (Bstr (a-&gt;argv [0]).raw (), machine.asOutParam ())" at line 1044 of file VBoxManageStorageController.cpp
make [1]: *** [vbox.mkf:13：idectrnul] 错误 1
make: *** [Makefile:101：VBOXRUN] 错误 2

解决办法：需要自己建立一个虚拟机，命名为 Cosmos

2、运行 make  virtualtest 后，virtualbox 启动后没有出现 logo 图片，而出现错误提示：INITKLDR DIE ERROR:S 

解决办法：建立虚拟机时，需要选择为 64bit 的系统

3、这个问题是与第二个的关联问题，当你在建立虚拟机时，想选择 64bit 的系统，却发现只有 32bit 的

解决办法：
VirtualBox 安装 64 位的系统需要满足以下条件：

1. 64 位的 cpu
2. cpu 允许硬件虚拟化

先来看第一个条件，64 位的 CPU，这个嘛，现在的笔记本一般都是 64 位的了，所以不用担心，除非是好几年之间的电脑。如果你不清楚，可以打开命令行，输入 systeminfo，在输出的信息中找到 CPU 这一行，如果是 X86_64 的，就是 64 位 CPU；

第二条，是否开启 CPU 硬件虚拟化 1，这个嘛，各大厂商的情况不大相同，有的电脑默认开启了（比如，我的 HP），有的没有，所以需要自行开启，开启方法：开机时按某个键进入 BIOS 设置界面 2。
然后，setup==&gt;security==&gt;cpu virtualization，将 cpu virtualization 这一项由 Disable 设置为 Enable。保存，然后重启电脑，硬件虚拟化就开启成功了。

如果你是通过 windows + vmware + virtualbox 的方式实现的，还需要设置 VMware，打开 vmware，找到对应的虚拟机，虚拟机设置 -&gt; 硬件 -&gt; 处理器 -&gt; 虚拟化引擎，这里一般会有三个选项，全都勾上

然后在打开该虚拟机，去 virtualbox 中建立虚拟机时，就会发现有 64bit 的选项了
 

</div><div><p>作者回复：厉害了 </p></div><div><div>2021-10-17</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>首先，这个函数为啥这么命名，没整明白</div><div><p>作者回复：这个问题不重要啊 </p></div><div><div>2021-06-04</div><div><div><i></i><span>7</span></div><div><i></i><span>12</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>思考题还是挺麻烦的，主要是没有注释啊，很多字段的含义都是靠猜，文章也没有介绍到这些。
首先是 init_mem820 这个函数本身：
```c
void init_meme820 (machbstart_t *mbsp)
{
    e820map_t *semp = (e820map_t *)((u32_t)(mbsp-&gt;mb_e820padr)); //  e820 数组地址
    u64_t senr = mbsp-&gt;mb_e820nr; // 个数
    e820map_t *demp = (e820map_t *)((u32_t)(mbsp-&gt;mb_nextwtpadr));
    if (1 &gt; move_krlimg (mbsp, (u64_t)((u32_t) demp), (senr * (sizeof (e820map_t)))))
    {
        kerror ("move_krlimg err");
    }

    m2mcopy (semp, demp, (sint_t)(senr * (sizeof (e820map_t))));
    mbsp-&gt;mb_e820padr = (u64_t)((u32_t)(demp));
    mbsp-&gt;mb_e820sz = senr * (sizeof (e820map_t));
    mbsp-&gt;mb_nextwtpadr = P4K_ALIGN ((u32_t)(demp) + (u32_t)(senr * (sizeof (e820map_t))));
    mbsp-&gt;mb_kalldendpadr = mbsp-&gt;mb_e820padr + mbsp-&gt;mb_e820sz;
    return;
}
```
我们发现这个函数实际上在拷贝内存，即将 semp 指针处的 senr * (sizeof (e820map_t) 内存大小拷贝到
demp 处，而 demp 的地址正是 mb_nextwtpadr，那么这个 mb_nextwtpadr 是怎么来的呢？在 init_krlfile 函数中可以大致猜测：

```c
void init_krlfile (machbstart_t *mbsp)
{
    u64_t sz = r_file_to_padr (mbsp, IMGKRNL_PHYADR, "kernel.bin");
    if (0 == sz)
    {
        kerror ("r_file_to_padr err");
    }
    mbsp-&gt;mb_krlimgpadr = IMGKRNL_PHYADR;
    mbsp-&gt;mb_krlsz = sz;
    // 页对齐
    mbsp-&gt;mb_nextwtpadr = P4K_ALIGN (mbsp-&gt;mb_krlimgpadr + mbsp-&gt;mb_krlsz);
    mbsp-&gt;mb_kalldendpadr = mbsp-&gt;mb_krlimgpadr + mbsp-&gt;mb_krlsz;
    return;
}
```
没错，mb_nextwtpadr 正是跳过内核起始地址 + 内核大小后的第一个页地址，注意需要 4k 对齐。
那么刚才内存拷贝的意图也很明显，对于初始化后的内存，内核本身的内存映射是不可访问的，必须保护充分内核，所以 init_mem820 函数的作用是跳过内核初始化内存。
由于代码无注释，文中篇幅有限，如有错误，多多指正，望海涵～</div><div><p>作者回复：你猜的很对 看来我确实不用写注释</p></div><div><div>2021-06-04</div><div><div><i></i></div><div><i></i><span>10</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>大体上整理了一下，有几处没弄清楚【补充最后一段，发漏了】
15、然后就接上了本节最后一部分内容了，不容易啊！哈哈哈！
Cosmos.bin 中【前面写错为 Cosmos.eki 了】，ld 设置的程序入口为 init_entry.asm 的_start:

16、 init_entry.asm 中_start:
A、关闭中断
B、通过 LGDT 命令，指定长度和初始位置，加载 GDT
C、设置页表，开启 PAE【CR4 第五位设置为 1】，将页表顶级目录放入 CR3
D、读取 EFER，将第八位设置为 1，写回 EFER，设置为长模式
E、开启保护模式【CR0 第 0 位设置为 1】，开启分页【CR0 第 31 位设置为 1】，开启 CACHE【CR0 第 30 位设置为 0】，开启 WriteThrough【CR0 第 29 位设置为 0】
F、初始化寄存器们
G、将之前复制到 Cosmos.bin 之后的 mbsp 地址，放入 rsp
H、0 入栈，0x8 入栈， hal_start 函数地址入栈
I、调用机器指令 “0xcb48”，做一个 “返回” 操作，同时从栈中弹出两个数据 [0x8：hal_start 函数地址]，到 [CS：RIP]
长模式下，指令寄存器为 RIP，也就是说下一个指令为 hal_start 函数地址
CS 中为 0x8，对应到 ekrnl_c64_dsc，对应到内核代码段，可以执行，CPU 继续冲 RIP 地址执行

17、hal_start.c
A、执行 hal_start 函数</div><div><p>作者回复：嗯 就是这样的</p></div><div><div>2021-06-05</div><div><div><i></i></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/8d/c6/e648d118.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 嗣树</span></div></div><div>回答下思考题，init_mem820 () 的作用？

先说结论，init_mem820 函数的作用是将 init_mem () 中获取到的内存信息转存到字体文件之后，其实就是为它找一个安稳的地方存放。

简单分析一下：
init_mem () -&gt; mmap () -&gt; realadr_call_entry ()
然后进入实模式调用中断，实模式的访址能力是有限，我们为中断处理指定临时的地址 (E80MAP_ADRADR) 存放内存信息数组
#define ETYBAK_ADR 0x2000
#define E80MAP_ADRADR (ETYBAK_ADR+68)

接下来在把内核文件加载到指定内存地址，字体文件紧随其后，然后就是我们收集到的信息，我们还要把放在临时位置的信息复制出来。
</div><div><p>作者回复：对 的 对的 就是这样的</p></div><div><div>2021-06-04</div><div><div><i></i><span>2</span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/24/ae/64/98ef557d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 然</span></div></div><div>init_mem820 () 函数作用是把 e820map 结构数组从低地址处（0x2068）搬到高地址处（0x2000000 之上）。

问什么要搬？在实模式下能用的地址空间有限，只能访问低地址。所以 e820map 结构数组不能一直存在低地址处。</div><div><p>作者回复：对 对 对 你理解的很好</p></div><div><div>2021-06-05</div><div><div><i></i><span>4</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/c4/4d/85014aab.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 一叉树</span></div></div><div>Mac 主机 + VBox。卡在了文中 “你只需要进入代码目录中 make vboxtest 就行了，运行结果如下 。” 这一步很久很久。

我是在 Ubuntu 虚拟机中执行 make vboxtest 的，会生成一个 hd.img，同时会有如下报错

恭喜我，系统编译构建完成！ ^_^
恭喜我，系统编译构建完成！ ^_^
正在生成 Cosmos 内核映像文件，请稍后……
文件数：6
映像文件大小：4911104
[sudo] password for mie: 
make [1]: VBoxManage: Command not found
make [1]: *** [vbox.mkf:23: tranvdi] Error 127
make: *** [Makefile:101: VBOXRUN] Error 2

这时候需要自己
1. 把生成的 hd.img 搞到外面的 mac
2. 使用第 10 节课用到的命令转化为 vdi 文件：
VBoxManage convertfromraw ./hd.img --format VDI ./hd.vdi
3. 新建一个虚拟机，将这个生成的 hd.vdi 当硬盘挂上去
4. 成功运行 ^_^

曾经郁闷这一步怎么这么跳跃，文中省了这么多步骤。但仔细观察 cosmos/lesson12/Cosmos/build/vbox.mkf 这个文件你会发现，这一切老师早帮你写好了，只是我使用 mac 主机 + Ubuntu 虚拟机学习 + 另一虚拟机运行结果，用了两个虚拟机而非套娃，所以在 Ubuntu 中报错 VBoxManage: Command not found。老师写的自动拉起虚拟机运行的脚本没能自动运行。</div><div><p>作者回复: 66666</p></div><div><div>2022-02-21</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/02/2a/2b0018d3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>XF - 薛峰</span></div></div><div>这一讲的实验，我的配置是 Win10+Virtualbox+Ubuntu 用来做 make 编译，使用 make vboxtest 命令编译，有关 Vbox 的报错不用理会（我没在虚拟机下的虚拟机里安装），只要找到 hd.vdi 文件就好了，退出 Ubuntu，另新建虚拟机使用这个 hd.vdi 就行了。如果只使用 make，没有转换成 hd.vdi</div><div><p>作者回复：你好，你需要转换成 hd.vdi</p></div><div><div>2021-06-20</div><div><div><i></i><span>7</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/90/4e/0da9d4d2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 孙孙孙</span></div></div><div>正在生成 Cosmos 内核映像文件，请稍后……
文件数：6
映像文件大小：4911104
Converting from raw image file="../hd.img" to file="../exckrnl/hd.vdi"...
Creating dynamic image with size 104857600 bytes (100MB)...
VBoxManage: error: Could not find a registered machine named 'Cosmos'
VBoxManage: error: Details: code VBOX_E_OBJECT_NOT_FOUND (0x80bb0001), component VirtualBoxWrap, interface IVirtualBox, callee nsISupports
VBoxManage: error: Context: "FindMachine (Bstr (a-&gt;argv [0]).raw (), machine.asOutParam ())" at line 1044 of file VBoxManageStorageController.cpp
make [1]: *** [vbox.mkf:13：idectrnul] 错误 1
make: *** [Makefile:101：VBOXRUN] 错误 2
 有人知道这个是为什么吗？</div><div><p>作者回复：你好，你需要先建立一个虚拟机</p></div><div><div>2021-06-06</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/CN4AD6J2Kcgc4ywz1SSXXvVG2XBmdJQ1RC1mhVjyanmbyOOfWFo5vvIiaIXzVicrVgJ8pvBQC1YZkk6rYdZ9utVA/132"></div></div><div><div><div><span> 野欲</span></div></div><div>跟着写完了代码也不知道 cosmos 是怎么跑起来的，迷惑</div><div><p>作者回复：那就再来一遍</p></div><div><div>2021-09-26</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/1b/b1/26955fb4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>scutgj2010</span></div></div><div>我是 vmware 虚拟机，不支持 VBE 的 118 模式，一直在报错 vbe mode not 118，手动改成 117 或者 120，还是继续报错，这个怎么解决呀？</div><div><p>作者回复：必须要 118 否则要改图形驱动的 </p></div><div><div>2021-08-15</div><div><div><i></i><span>4</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/9c/6f/f96bd546.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>zhanghj</span></div></div><div>各种数据结构放的位置，比如内存视图，内核文件保存的位置，栈顶指针的地址，这些地址值是如何规划的？</div><div><p>作者回复：看看内存的布局 进行合理规划</p></div><div><div>2021-06-13</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f1/24/07ce02a0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 熊光红</span></div></div><div>用 lession12 的 hd.img 制作了个 hd.vdi，加载到虚拟机，运行出现 out of memory 错误，请问如何建立调试环境调试一下，看看哪儿出错了</div><div><p>作者回复：你好，你需要给虚拟机配置更大的内存</p></div><div><div>2021-06-06</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_504185</span></div></div><div>7. 然后回到 12 课代码的根目录有 Makefile 的目录，利用命令 make vboxtest，虚拟机启动了一直提示 VT-x 不支持。
8. 查了资料，从 BIOS 里查看了已经开启虚拟化了，不知道为啥原因，有说 Win10 从 10 月后多 Hyper-v 需要关闭；
9. 关闭了 Hyper-V，再次实验还是提示不支持。
10. 考虑是否是 Virtualbox 里没开启 VT-x，查了虚拟机 Cosmos，设置的 system 里确实没开启；
11. 使用命令开启，开启后还是不行，完全懵了。
12. 使用手工创建 Cosmos 虚拟机，发现 Virtualbox 就是没有 64 位系统的选项。
13. 这时考虑到 Virtualbox 的宿主机是 VMWare，所以 VMWare 也开启 VT-x！！！！
14. 再次运行，需修改 Cosmos 虚拟机内存，默认 128M，改为 1024M，实验成功。</div><div><p>作者回复：是的 </p></div><div><div>2021-11-18</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_504185</span></div></div><div>先说步骤吧：
第一步：开启硬件 BIOS 里的 VT-x；
第二步： 如果和我一样有虚拟机开启虚拟机的 VT-x；
第三步：检查 Virtualbox 创建虚拟机时出现了可以选择创建 64 位系统的选项就可以了；
第四步：lesson12 代码，
	cd build,
 	make createvm -f vbox.mkf
	make crtidectr -f vbox.mkf
	 cd ..
	make vboxtest

其中这几天实验过程记录一下：
我的开始用的环境是：Win10+VMware12 （Ubuntu20.4 64 位）

1. 开始从 Ubuntu 里创建 hd.img，安装 grub 和编译 Cosmos.eki 放到 /boot/ 目录下；
2. 然后利用 StarWindConverter.exe 转换成 VMware 识别的硬盘格式，运行；
3. 运行程序提示 INITKRL DIE ERROR：not find file ；
4. 开始以为是 VMWare 虚拟机的问题（目前来看应该不是），转战使用 Ubuntu20.4 里安装 Virtualbox，开启套娃模式。
5.Ubuntu64 位操作系统里使用 sudo apt-get install virtualbox-6.1 提示 Package 'virtualbox-6.1' has no installation candidate，
  就去官网下载 64 位 virtualbox 手动安装，最后提示安装失败，不支持，最后利用 Ubuntu 自带的 App Store 安装了 Virtualbox6.1；
6. 开始利用 12 课代码做实验，仔细看来 makefi</div><div><p>作者回复：哈哈</p></div><div><div>2021-11-18</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/24/f2/79/b2012f53.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 余生</span></div></div><div>起动提示 INITKLDR DIE ERROR:S ，建虚机时选 64 位，入坑了很久才爬出来</div><div><p>作者回复：怎么会有这个错误的 </p></div><div><div>2021-09-09</div><div><div><i></i><span>5</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/fa/f0/241294cd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 李城</span></div></div><div>将 Cosmos.eki 更名为 HelloOS.eki, 放在./hdisk/boot 目录下，打开虚拟机，报错 not find file, 不知如何下手</div><div><p>作者回复：用 gitee 上课程目录中的代码构建  不要自己替换</p></div><div><div>2021-09-02</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div></div><div>还很奇怪 mem820 这个函数怎么没有细讲。原来是思考题。</div><div><p>编辑回复：哈哈 是滴。</p></div><div><div>2021-06-04</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".14"><outline class="toc-level-h1" data-reactid=".14.0" style="width: 175px;"><active data-reactid=".14.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".14.0.1"><span data-reactid=".14.0.1.0"> 12 | 设置工作模式与环境（下）：探查和收集信息</span></a></outline><outline class="toc-level-h2" data-reactid=".14.1" style="width: 165px;"><active data-reactid=".14.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".14.1.1"><span data-reactid=".14.1.1.0">检查与收集机器信息</span></a></outline><outline class="toc-level-h3" data-reactid=".14.2" style="width: 155px;"><active data-reactid=".14.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".14.2.1"><span data-reactid=".14.2.1.0">检查 CPU</span></a></outline><outline class="toc-level-h3" data-reactid=".14.3" style="width: 155px;"><active data-reactid=".14.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".14.3.1"><span data-reactid=".14.3.1.0">获取内存布局</span></a></outline><outline class="toc-level-h3" data-reactid=".14.4" style="width: 155px;"><active data-reactid=".14.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".14.4.1"><span data-reactid=".14.4.1.0">初始化内核栈</span></a></outline><outline class="toc-level-h3" data-reactid=".14.5" style="width: 155px;"><active data-reactid=".14.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".14.5.1"><span data-reactid=".14.5.1.0">放置内核文件与字库文件</span></a></outline><outline class="toc-level-h3" data-reactid=".14.6" style="width: 155px;"><active data-reactid=".14.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".14.6.1"><span data-reactid=".14.6.1.0">建立 MMU 页表数据</span></a></outline><outline class="toc-level-h3" data-reactid=".14.7" style="width: 155px;"><active data-reactid=".14.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".14.7.1"><span data-reactid=".14.7.1.0">设置图形模式</span></a></outline><outline class="toc-level-h3" data-reactid=".14.8" style="width: 155px;"><active data-reactid=".14.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".14.8.1"><span data-reactid=".14.8.1.0">串联</span></a></outline><outline class="toc-level-h2" data-reactid=".14.9" style="width: 165px;"><active data-reactid=".14.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".14.9.1"><span data-reactid=".14.9.1.0">显示 Logo</span></a></outline><outline class="toc-level-h2" data-reactid=".14.a" style="width: 165px;"><active data-reactid=".14.a.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".14.a.1"><span data-reactid=".14.a.1.0">进入 Cosmos</span></a></outline><outline class="toc-level-h2" data-reactid=".14.b" style="width: 165px;"><active data-reactid=".14.b.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".14.b.1"><span data-reactid=".14.b.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".14.c" style="width: 165px;"><active data-reactid=".14.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".14.c.1"><span data-reactid=".14.c.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".14.d" style="width: 165px;"><active data-reactid=".14.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".14.d.1"><span data-reactid=".14.d.1.0">精选留言 (72)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/381157" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>