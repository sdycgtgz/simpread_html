
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 17 | 内存视角（三）：OOM 都是谁的锅？怎么破？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>17 | 内存视角（三）：OOM 都是谁的锅？怎么破？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">你知道 Spark 是如何使用内存的吗？不同的内存区域之间的关系是什么，它们又是如何划分的？今天，我就来和你深入探讨一下。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">17 | 内存视角（三）：OOM 都是谁的锅？怎么破？</h1><div><span>吴磊</span> <span> 2021-04-21</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f8/ee/f841a23670cb0a15690ac5586eda5bee.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：吴磊</span><span>大小：16.17M</span><span> 时长：17:42</span></div></div><audio title="17 | 内存视角（三）：OOM都是谁的锅？怎么破？" src="https://res001.geekbang.org/media/audio/86/e9/86ab8c3bc234f9c90684b1bf5d8bffe9/ld/ld.m3u8" __idm_id__="131083"></audio></div><div><div><div><div data-slate-editor="true" data-key="2796" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="2797"><span data-slate-object="text" data-key="2798"><span data-slate-leaf="true" data-offset-key="2798:0" data-first-offset="true"><span data-slate-string="true">你好，我是吴磊。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2799"><span data-slate-object="text" data-key="2800"><span data-slate-leaf="true" data-offset-key="2800:0" data-first-offset="true"><span data-slate-string="true">无论是批处理、流计算，还是数据分析、机器学习，只要是在 Spark 作业中，我们总能见到 OOM（Out Of Memory，内存溢出）的身影。一旦出现 OOM，作业就会中断，应用的业务功能也都无法执行。因此，及时处理 OOM 问题是我们日常开发中一项非常重要的工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2801"><span data-slate-object="text" data-key="2802"><span data-slate-leaf="true" data-offset-key="2802:0" data-first-offset="true"><span data-slate-string="true">但是，Spark 报出的 OOM 问题可以说是五花八门，常常让人找不到头绪。比如，我们经常遇到，数据集按照尺寸估算本该可以完全放进内存，但 Spark 依然会报 OOM 异常。这个时候，不少同学都会参考网上的做法，把 spark.executor.memory 不断地调大、调大、再调大，直到内心崩溃也无济于事，最后只能放弃。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2803"><span data-slate-object="text" data-key="2804"><span data-slate-leaf="true" data-offset-key="2804:0" data-first-offset="true"><span data-slate-string="true">那么，当我们拿到 OOM 这个 “烫手的山芋” 的时候该怎么办呢？我们最先应该弄清楚的是 “</span></span></span><span data-slate-object="text" data-key="2805"><span data-slate-leaf="true" data-offset-key="2805:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">到底哪里出现了 OOM</span></span></span></span><span data-slate-object="text" data-key="2806"><span data-slate-leaf="true" data-offset-key="2806:0" data-first-offset="true"><span data-slate-string="true">”。只有准确定位出现问题的具体区域，我们的调优才能有的放矢。具体来说，这个 “</span></span></span><span data-slate-object="text" data-key="2807"><span data-slate-leaf="true" data-offset-key="2807:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">哪里</span></span></span></span><span data-slate-object="text" data-key="2808"><span data-slate-leaf="true" data-offset-key="2808:0" data-first-offset="true"><span data-slate-string="true">”，我们至少要分 3 个方面去看。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2809"><div data-slate-type="list-line" data-slate-object="block" data-key="2810"><span data-slate-object="text" data-key="2811"><span data-slate-leaf="true" data-offset-key="2811:0" data-first-offset="true"><span data-slate-string="true">发生 OOM 的 LOC（Line Of Code），也就是代码位置在哪？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2812"><span data-slate-object="text" data-key="2813"><span data-slate-leaf="true" data-offset-key="2813:0" data-first-offset="true"><span data-slate-string="true">OOM 发生在 Driver 端，还是在 Executor 端？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2814"><span data-slate-object="text" data-key="2815"><span data-slate-leaf="true" data-offset-key="2815:0" data-first-offset="true"><span data-slate-string="true">如果是发生在 Executor 端，OOM 到底发生在哪一片内存区域？</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2816"><span data-slate-object="text" data-key="2817"><span data-slate-leaf="true" data-offset-key="2817:0" data-first-offset="true"><span data-slate-string="true">定位出错代码的位置非常重要但也非常简单，我们只要利用 Stack Trace 就能很快找到抛出问题的 LOC。因此，更</span></span></span><span data-slate-object="text" data-key="2818"><span data-slate-leaf="true" data-offset-key="2818:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">关键的是，我们要明确出问题的到底是 Driver 端还是 Executor 端，以及是哪片内存区域</span></span></span></span><span data-slate-object="text" data-key="2819"><span data-slate-leaf="true" data-offset-key="2819:0" data-first-offset="true"><span data-slate-string="true">。Driver 和 Executor 产生 OOM 的病灶不同，我们自然需要区别对待。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2820"><span data-slate-object="text" data-key="2821"><span data-slate-leaf="true" data-offset-key="2821:0" data-first-offset="true"><span data-slate-string="true">所以今天这一讲，我们就先来说说 Driver 端的 OOM 问题和应对方法。由于内存在 Executor 端被划分成了不同区域，因此，对于 Executor 端怪相百出的 OOM，我们还要结合案例来分类讨论。最后，我会带你整理出一套应对 OOM 的 “武功秘籍”，让你在面对 OOM 的时候，能够见招拆招、有的放矢！</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2822" id="sr-toc-1"><span data-slate-object="text" data-key="2823"><span data-slate-leaf="true" data-offset-key="2823:0" data-first-offset="true"><span data-slate-string="true">Driver 端的 OOM</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2824"><span data-slate-object="text" data-key="2825"><span data-slate-leaf="true" data-offset-key="2825:0" data-first-offset="true"><span data-slate-string="true">我们先来说说 Driver 端的 OOM。Driver 的主要职责是任务调度，同时参与非常少量的任务计算，因此 Driver 的内存配置一般都偏低，也没有更加细分的内存区域。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2826"><span data-slate-object="text" data-key="2827"><span data-slate-leaf="true" data-offset-key="2827:0" data-first-offset="true"><span data-slate-string="true">因为 Driver 的内存就是囫囵的那么一块，所以 Driver 端的 OOM 问题自然不是调度系统的毛病，只可能来自它涉及的计算任务，主要有两类：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2828"><div data-slate-type="list-line" data-slate-object="block" data-key="2829"><span data-slate-object="text" data-key="2830"><span data-slate-leaf="true" data-offset-key="2830:0" data-first-offset="true"><span data-slate-string="true">创建小规模的分布式数据集：使用 parallelize、createDataFrame 等 API 创建数据集</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2831"><span data-slate-object="text" data-key="2832"><span data-slate-leaf="true" data-offset-key="2832:0" data-first-offset="true"><span data-slate-string="true">收集计算结果：通过 take、show、collect 等算子把结果收集到 Driver 端</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2833"><span data-slate-object="text" data-key="2834"><span data-slate-leaf="true" data-offset-key="2834:0" data-first-offset="true"><span data-slate-string="true">因此 Driver 端的 OOM 逃不出 2 类病灶：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2835"><div data-slate-type="list-line" data-slate-object="block" data-key="2836"><span data-slate-object="text" data-key="2837"><span data-slate-leaf="true" data-offset-key="2837:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">创建的数据集超过内存上限</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2838"><span data-slate-object="text" data-key="2839"><span data-slate-leaf="true" data-offset-key="2839:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">收集的结果集超过内存上限</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2840"><span data-slate-object="text" data-key="2841"><span data-slate-leaf="true" data-offset-key="2841:0" data-first-offset="true"><span data-slate-string="true">第一类病灶不言自明，咱们不细说了。看到第二类病灶，想必你第一时间想到的就是万恶的 collect。确实，说到 OOM 就不得不提 collect。collect 算子会从 Executors 把全量数据拉回到 Driver 端，因此，如果结果集尺寸超过 Driver 内存上限，它自然会报 OOM。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2842"><span data-slate-object="text" data-key="2843"><span data-slate-leaf="true" data-offset-key="2843:0" data-first-offset="true"><span data-slate-string="true">由开发者直接调用 collect 算子而触发的 OOM 问题其实很好定位，比较难定位的是间接调用 collect 而导致的 OOM。那么，间接调用 collect 是指什么呢？还记得广播变量的工作原理吗？</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2844"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/b3/2a/b3c5ab392c2303bf7923488623b4022a.jpg?wh=5094*1695"></div><div>广播变量的创建与分发</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2845"><span data-slate-object="text" data-key="2846"><span data-slate-leaf="true" data-offset-key="2846:0" data-first-offset="true"><span data-slate-string="true">广播变量在创建的过程中，需要先把分布在所有 Executors 的数据分片拉取到 Driver 端，然后在 Driver 端构建广播变量，最后 Driver 端把封装好的广播变量再分发给各个 Executors。第一步的数据拉取其实就是用 collect 实现的。如果 Executors 中数据分片的总大小超过 Driver 端内存上限也会报 OOM。在日常的调优工作中，你看到的表象和症状可能是：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="2847"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2848"><span data-slate-object="text" data-key="2849"><span data-slate-leaf="true" data-offset-key="2849:0" data-first-offset="true"><span data-slate-string="true">java.lang.OutOfMemoryError: Not enough memory to build and broadcast</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2850"><span data-slate-object="text" data-key="2851"><span data-slate-leaf="true" data-offset-key="2851:0" data-first-offset="true"><span data-slate-string="true">但实际的病理却是 Driver 端内存受限，没有办法容纳拉取回的结果集。找到了病因，再去应对 Driver 端的 OOM 就很简单了。我们只要对结果集尺寸做适当的预估，然后再相应地增加 Driver 侧的内存配置就好了。</span></span><span data-slate-leaf="true" data-offset-key="2851:1"><span data-slate-object="annotation" data-annotation-key="gkann_147870fd" data-attr-id="22537" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">调节 Driver 端侧内存大小我们要用到 spark.driver.memory 配置项，预估数据集尺寸可以用 “先 Cache，再查看执行计划” 的方式，示例代码如下。</span></span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="2852"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2853"><span data-slate-object="text" data-key="2854"><span data-slate-leaf="true" data-offset-key="2854:0" data-first-offset="true"><span data-slate-string="true">val </span></span></span><span data-slate-object="text" data-key="2855"><span data-slate-leaf="true" data-offset-key="2855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">df</span></span></span></span><span data-slate-object="text" data-key="2856"><span data-slate-leaf="true" data-offset-key="2856:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="2857"><span data-slate-leaf="true" data-offset-key="2857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">DataFrame</span></span></span></span><span data-slate-object="text" data-key="2858"><span data-slate-leaf="true" data-offset-key="2858:0" data-first-offset="true"><span data-slate-string="true"> = _</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2859"><span data-slate-object="text" data-key="2860"><span data-slate-leaf="true" data-offset-key="2860:0" data-first-offset="true"><span data-slate-string="true">df.</span></span></span><span data-slate-object="text" data-key="2861"><span data-slate-leaf="true" data-offset-key="2861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cache</span></span></span></span><span data-slate-object="text" data-key="2862"><span data-slate-leaf="true" data-offset-key="2862:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2863"><span data-slate-leaf="true" data-offset-key="2863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">count</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2864"><span data-slate-object="text" data-key="2865"><span data-slate-leaf="true" data-offset-key="2865:0" data-first-offset="true"><span data-slate-string="true">val plan = df.</span></span></span><span data-slate-object="text" data-key="2866"><span data-slate-leaf="true" data-offset-key="2866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">queryExecution</span></span></span></span><span data-slate-object="text" data-key="2867"><span data-slate-leaf="true" data-offset-key="2867:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2868"><span data-slate-leaf="true" data-offset-key="2868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logical</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2869"><span data-slate-object="text" data-key="2870"><span data-slate-leaf="true" data-offset-key="2870:0" data-first-offset="true"><span data-slate-string="true">val </span></span></span><span data-slate-object="text" data-key="2871"><span data-slate-leaf="true" data-offset-key="2871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">estimated</span></span></span></span><span data-slate-object="text" data-key="2872"><span data-slate-leaf="true" data-offset-key="2872:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="2873"><span data-slate-leaf="true" data-offset-key="2873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BigInt</span></span></span></span><span data-slate-object="text" data-key="2874"><span data-slate-leaf="true" data-offset-key="2874:0" data-first-offset="true"><span data-slate-string="true"> = spark</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2875"><span data-slate-object="text" data-key="2876"><span data-slate-leaf="true" data-offset-key="2876:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2877"><span data-slate-leaf="true" data-offset-key="2877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sessionState</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2878"><span data-slate-object="text" data-key="2879"><span data-slate-leaf="true" data-offset-key="2879:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2880"><span data-slate-leaf="true" data-offset-key="2880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">executePlan</span></span></span></span><span data-slate-object="text" data-key="2881"><span data-slate-leaf="true" data-offset-key="2881:0" data-first-offset="true"><span data-slate-string="true">(plan)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2882"><span data-slate-object="text" data-key="2883"><span data-slate-leaf="true" data-offset-key="2883:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2884"><span data-slate-leaf="true" data-offset-key="2884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">optimizedPlan</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2885"><span data-slate-object="text" data-key="2886"><span data-slate-leaf="true" data-offset-key="2886:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2887"><span data-slate-leaf="true" data-offset-key="2887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stats</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2888"><span data-slate-object="text" data-key="2889"><span data-slate-leaf="true" data-offset-key="2889:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="2890"><span data-slate-leaf="true" data-offset-key="2890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeInBytes</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2891" id="sr-toc-2"><span data-slate-object="text" data-key="2892"><span data-slate-leaf="true" data-offset-key="2892:0" data-first-offset="true"><span data-slate-string="true">Executor 端的 OOM</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2893"><span data-slate-object="text" data-key="2894"><span data-slate-leaf="true" data-offset-key="2894:0" data-first-offset="true"><span data-slate-string="true">我们再来说说 Executor 端的 OOM。我们知道，执行内存分为 4 个区域：Reserved Memory、User Memory、Storage Memory 和 Execution Memory。这 4 个区域中都有哪些区域会报 OOM 异常呢？哪些区域压根就不存在 OOM 的可能呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2895"><span data-slate-object="text" data-key="2896"><span data-slate-leaf="true" data-offset-key="2896:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 Executors 中，与任务执行有关的内存区域才存在 OOM 的隐患</span></span></span></span><span data-slate-object="text" data-key="2897"><span data-slate-leaf="true" data-offset-key="2897:0" data-first-offset="true"><span data-slate-string="true">。其中，Reserved Memory 大小固定为 300MB，因为它是硬编码到源码中的，所以不受用户控制。而对于 Storage Memory 来说，即便数据集不能完全缓存到 MemoryStore，Spark 也不会抛 OOM 异常，额外的数据要么落盘（MEMORY_AND_DISK）、要么直接放弃（MEMORY_ONLY）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2898"><span data-slate-object="text" data-key="2899"><span data-slate-leaf="true" data-offset-key="2899:0" data-first-offset="true"><span data-slate-string="true">因此，当 Executors 出现 OOM 的问题，我们可以先把 Reserved Memory 和 Storage Memory 排除，然后锁定 Execution Memory 和 User Memory 去找毛病。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2900" id="sr-toc-3"><span data-slate-object="text" data-key="2901"><span data-slate-leaf="true" data-offset-key="2901:0" data-first-offset="true"><span data-slate-string="true">User Memory 的 OOM</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2902"><span data-slate-object="text" data-key="2903"><span data-slate-leaf="true" data-offset-key="2903:0" data-first-offset="true"><span data-slate-string="true">在内存管理那一讲，我们说过 User Memory 用于存储用户自定义的数据结构，如数组、列表、字典等。因此，如果这些数据结构的总大小超出了 User Memory 内存区域的上限，你可能就会看到下表示例中的报错。</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="2904"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2905"><span data-slate-object="text" data-key="2906"><span data-slate-leaf="true" data-offset-key="2906:0" data-first-offset="true"><span data-slate-string="true">java.lang.OutOfMemoryError: Java heap space at java.util.Arrays.copyOf</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2907"><span data-slate-object="text" data-key="2908"><span data-slate-leaf="true" data-offset-key="2908:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2909"><span data-slate-object="text" data-key="2910"><span data-slate-leaf="true" data-offset-key="2910:0" data-first-offset="true"><span data-slate-string="true">java.lang.OutOfMemoryError: Java heap space at java.lang.reflect.Array.newInstance</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2911"><span data-slate-object="text" data-key="2912"><span data-slate-leaf="true" data-offset-key="2912:0" data-first-offset="true"><span data-slate-string="true">如果你的数据结构是用于分布式数据转换，在计算 User Memory 内存消耗时，你就需要考虑 Executor 的线程池大小。还记得下面的这个例子吗？</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="2913"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2914"><span data-slate-object="text" data-key="2915"><span data-slate-leaf="true" data-offset-key="2915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2916"><span data-slate-leaf="true" data-offset-key="2916:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2917"><span data-slate-leaf="true" data-offset-key="2917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dict</span></span></span></span><span data-slate-object="text" data-key="2918"><span data-slate-leaf="true" data-offset-key="2918:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2919"><span data-slate-leaf="true" data-offset-key="2919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2920"><span data-slate-leaf="true" data-offset-key="2920:0" data-first-offset="true"><span data-slate-string="true"> List(“spark”, “tune”)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2921"><span data-slate-object="text" data-key="2922"><span data-slate-leaf="true" data-offset-key="2922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2923"><span data-slate-leaf="true" data-offset-key="2923:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2924"><span data-slate-leaf="true" data-offset-key="2924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">words</span></span></span></span><span data-slate-object="text" data-key="2925"><span data-slate-leaf="true" data-offset-key="2925:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2926"><span data-slate-leaf="true" data-offset-key="2926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2927"><span data-slate-leaf="true" data-offset-key="2927:0" data-first-offset="true"><span data-slate-string="true"> spark.sparkContext.textFile(“~/words.csv”)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2928"><span data-slate-object="text" data-key="2929"><span data-slate-leaf="true" data-offset-key="2929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2930"><span data-slate-leaf="true" data-offset-key="2930:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2931"><span data-slate-leaf="true" data-offset-key="2931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">keywords</span></span></span></span><span data-slate-object="text" data-key="2932"><span data-slate-leaf="true" data-offset-key="2932:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2933"><span data-slate-leaf="true" data-offset-key="2933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2934"><span data-slate-leaf="true" data-offset-key="2934:0" data-first-offset="true"><span data-slate-string="true"> words.filter(word =&gt; dict.contains(word))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2935"><span data-slate-object="text" data-key="2936"><span data-slate-leaf="true" data-offset-key="2936:0" data-first-offset="true"><span data-slate-string="true">keywords.map((_, </span></span></span><span data-slate-object="text" data-key="2937"><span data-slate-leaf="true" data-offset-key="2937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="2938"><span data-slate-leaf="true" data-offset-key="2938:0" data-first-offset="true"><span data-slate-string="true">)).reduceByKey(_ + _).collect</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2939"><span data-slate-object="text" data-key="2940"><span data-slate-leaf="true" data-offset-key="2940:0" data-first-offset="true"><span data-slate-string="true">自定义的列表 dict 会随着 Task 分发到所有 Executors，因此多个 Task 中的 dict 会对 User Memory 产生重复消耗。如果把 dict 尺寸记为 #size，Executor 线程池大小记为 #threads，那么 dict 对 User Memory 的总消耗就是：#size * #threads。一旦总消耗超出 User Memory 内存上限，自然就会产生 OOM 问题。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2941"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/ba/39/ba45d47a910ccb92861b1fd153b36839.jpg?wh=3540*1482"></div><div>用户数据在任务中的分发</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2942"><span data-slate-object="text" data-key="2943"><span data-slate-leaf="true" data-offset-key="2943:0" data-first-offset="true"><span data-slate-string="true">那么，解决 User Memory 端 OOM 的思路和 Driver 端的并无二致，也是先对数据结构的消耗进行预估，然后相应地扩大 User Memory 的内存配置。不过，相比 Driver，User Memory 内存上限的影响因素更多，总大小由 spark.executor.memory * （ 1 - spark.memory.fraction）计算得到。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2944" id="sr-toc-4"><span data-slate-object="text" data-key="2945"><span data-slate-leaf="true" data-offset-key="2945:0" data-first-offset="true"><span data-slate-string="true">Execution Memory 的 OOM</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2946"><span data-slate-object="text" data-key="2947"><span data-slate-leaf="true" data-offset-key="2947:0" data-first-offset="true"><span data-slate-string="true">要说 OOM 的高发区，非 Execution Memory 莫属。久行夜路必撞鬼，在分布式任务执行的过程中，Execution Memory 首当其冲，因此出错的概率相比其他内存区域更高。关于 Execution Memory 的 OOM，我发现不少同学都存在这么一个误区：只要数据量比执行内存小就不会发生 OOM，相反就会有一定的几率触发 OOM 问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2948"><span data-slate-object="text" data-key="2949"><span data-slate-leaf="true" data-offset-key="2949:0" data-first-offset="true"><span data-slate-string="true">实际上，</span></span></span><span data-slate-object="text" data-key="2950"><span data-slate-leaf="true" data-offset-key="2950:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">数据量并不是决定 OOM 与否的关键因素，数据分布与 Execution Memory 的运行时规划是否匹配才是</span></span></span></span><span data-slate-object="text" data-key="2951"><span data-slate-leaf="true" data-offset-key="2951:0" data-first-offset="true"><span data-slate-string="true">。这么说可能比较抽象，你还记得黄小乙的如意算盘吗？为了提高老乡们种地的热情和积极性，他制定了个转让协议，所有老乡申请的土地面积介于 1/N/2 和 1/N 之间。因此，如果有的老乡贪多求快，买的种子远远超过 1/N 上限能够容纳的数量，这位老乡多买的那部分种子都会被白白浪费掉。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2952"><span data-slate-object="text" data-key="2953"><span data-slate-leaf="true" data-offset-key="2953:0" data-first-offset="true"><span data-slate-string="true">同样的，我们可以把 Execution Memory 看作是</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2954"><span data-slate-object="text" data-key="2955"><span data-slate-leaf="true" data-offset-key="2955:0" data-first-offset="true"><span data-slate-string="true">土地，把分布式数据集看作是种子，一旦</span></span></span><span data-slate-object="text" data-key="2956"><span data-slate-leaf="true" data-offset-key="2956:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">分布式任务的内存请求超出 1/N 这个上限，</span></span></span></span><span data-slate-object="text" data-key="2957"><span data-slate-leaf="true" data-offset-key="2957:0" data-first-offset="true"><span data-slate-string="true">Execution Memory 就会出现 OOM 问题。而且，相比其他场景下的 OOM 问题，Execution Memory 的 OOM 要复杂得多，它不仅仅与内存空间大小、数据分布有关，还与 Executor 线程池和运行时任务调度有关。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2958"><span data-slate-object="text" data-key="2959"><span data-slate-leaf="true" data-offset-key="2959:0" data-first-offset="true"><span data-slate-string="true">抓住了引起 OOM 问题最核心的原因，对于 Execution Memory OOM 的诸多表象，我们就能从容应对了。下面，我们就来看两个平时开发中常见的实例：数据倾斜和数据膨胀。为了方便说明，在这两个实例中，计算节点的硬件配置是一样的，都是 2 个 CPU core，每个 core 有两个线程，内存大小为 1GB，并且 spark.executor.cores 设置为 3，spark.executor.memory 设置为 900MB。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2960"><span data-slate-object="text" data-key="2961"><span data-slate-leaf="true" data-offset-key="2961:0" data-first-offset="true"><span data-slate-string="true">根据配置项那一讲我们说过的不同内存区域的计算公式，在默认配置下，我们不难算出 Execution Memory 和 Storage Memory 内存空间都是 180MB。而且，因为我们的例子里没有 RDD 缓存，所以 Execution Memory 内存空间上限是 360MB。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2962" id="sr-toc-5"><span data-slate-object="text" data-key="2963"><span data-slate-leaf="true" data-offset-key="2963:0" data-first-offset="true"><span data-slate-string="true">实例 1：数据倾斜</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2964"><span data-slate-object="text" data-key="2965"><span data-slate-leaf="true" data-offset-key="2965:0" data-first-offset="true"><span data-slate-string="true">我们先来看第一个数据倾斜的例子。节点在 Reduce 阶段拉取数据分片，3 个 Reduce Task 对应的数据分片大小分别是 100MB 和 300MB。显然，第三个数据分片存在轻微的数据倾斜。由于 Executor 线程池大小为 3，因此每个 Reduce Task 最多可获得 360MB * 1 / 3 = 120MB 的内存空间。Task1、Task2 获取到的内存空间足以容纳分片 1、分片 2，因此可以顺利完成任务。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2966"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/bb/e2/bbd4052de37200a7152646668f88a5e2.jpg?wh=4134*1836"></div><div>数据倾斜导致 OOM</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2967"><span data-slate-object="text" data-key="2968"><span data-slate-leaf="true" data-offset-key="2968:0" data-first-offset="true"><span data-slate-string="true">Task3 的数据分片大小远超内存上限，即便 Spark 在 Reduce 阶段支持 Spill 和外排，120MB 的内存空间也无法满足 300MB 数据最基本的计算需要，如 PairBuffer 和 AppendOnlyMap 等数据结构的内存消耗，以及数据排序的临时内存消耗等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2969"><span data-slate-object="text" data-key="2970"><span data-slate-leaf="true" data-offset-key="2970:0" data-first-offset="true"><span data-slate-string="true">这个例子的表象是数据倾斜导致 OOM，但实质上是 Task3 的内存请求超出 1/N 上限。因此，针对以这个案例为代表的数据倾斜问题，我们至少有 2 种调优思路：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2971"><div data-slate-type="list-line" data-slate-object="block" data-key="2972"><span data-slate-object="text" data-key="2973"><span data-slate-leaf="true" data-offset-key="2973:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">消除数据倾斜，让所有的数据分片尺寸都不大于 100MB</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2974"><span data-slate-object="text" data-key="2975"><span data-slate-leaf="true" data-offset-key="2975:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">调整 Executor 线程池、内存、并行度等相关配置，提高 1/N 上限到 300MB</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2976"><span data-slate-object="text" data-key="2977"><span data-slate-leaf="true" data-offset-key="2977:0" data-first-offset="true"><span data-slate-string="true">每一种思路都可以衍生出许多不同的方法，就拿第 2 种思路来说，要满足 1/N 的上限，最简单地，我们可以把 spark.executor.cores 设置成 1，也就是 Executor 线程池只有一个线程 “并行” 工作。这个时候，每个任务的内存上限都变成了 360MB，容纳 300MB 的数据分片绰绰有余。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2978"><span data-slate-object="text" data-key="2979"><span data-slate-leaf="true" data-offset-key="2979:0" data-first-offset="true"><span data-slate-string="true">当然，线程池大小设置为 1 是不可取的，刚刚只是为了说明调优的灵活性。延续第二个思路，你需要去平衡多个方面的配置项，在充分利用 CPU 的前提下解决 OOM 的问题。比如：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2980"><div data-slate-type="list-line" data-slate-object="block" data-key="2981"><span data-slate-object="text" data-key="2982"><span data-slate-leaf="true" data-offset-key="2982:0" data-first-offset="true"><span data-slate-string="true">维持并发度、并行度不变，增大执行内存设置，提高 1/N 上限到 300MB</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2983"><span data-slate-object="text" data-key="2984"><span data-slate-leaf="true" data-offset-key="2984:0" data-first-offset="true"><span data-slate-string="true">维持并发度、执行内存不变，使用相关配置项来提升并行度将数据打散，让所有的数据分片尺寸都缩小到 100MB 以内</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2985"><span data-slate-object="text" data-key="2986"><span data-slate-leaf="true" data-offset-key="2986:0" data-first-offset="true"><span data-slate-string="true">关于线程池、内存和并行度之间的平衡与设置，我在 CPU 视角那一讲做过详细的介绍，你可以去回顾一下。至于怎么消除数据倾斜，你可以好好想想，再把你的思路分享出来。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2987" id="sr-toc-6"><span data-slate-object="text" data-key="2988"><span data-slate-leaf="true" data-offset-key="2988:0" data-first-offset="true"><span data-slate-string="true">实例 2：数据膨胀</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2989"><span data-slate-object="text" data-key="2990"><span data-slate-leaf="true" data-offset-key="2990:0" data-first-offset="true"><span data-slate-string="true">我们再来看第二个数据膨胀的例子。节点在 Map 阶段拉取 HDFS 数据分片，3 个 Map Task 对应的数据分片大小都是 100MB。按照之前的计算，每个 Map Task 最多可获得 120MB 的执行内存，不应该出现 OOM 问题才对。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2991"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/63/cb/639c65b2ce9213295feedd3634e261cb.jpg?wh=4689*1919"></div><div>数据膨胀导致 OOM</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2992"><span data-slate-object="text" data-key="2993"><span data-slate-leaf="true" data-offset-key="2993:0" data-first-offset="true"><span data-slate-string="true">尴尬的地方在于，磁盘中的数据进了 JVM 之后会膨胀。在我们的例子中，数据分片加载到 JVM Heap 之后翻了 3 倍，原本 100MB 的数据变成了 300MB，因此，OOM 就成了一件必然会发生的事情。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2994"><span data-slate-object="text" data-key="2995"><span data-slate-leaf="true" data-offset-key="2995:0" data-first-offset="true"><span data-slate-string="true">在这个案例中，表象是数据膨胀导致 OOM，但本质上还是 Task2 和 Task3 的内存请求超出 1/N 上限。因此，针对以这个案例为代表的数据膨胀问题，我们还是有至少 2 种调优思路：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2996"><div data-slate-type="list-line" data-slate-object="block" data-key="2997"><span data-slate-object="text" data-key="2998"><span data-slate-leaf="true" data-offset-key="2998:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">把数据打散，提高数据分片数量、降低数据粒度，让膨胀之后的数据量降到 100MB 左右</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2999"><span data-slate-object="text" data-key="3000"><span data-slate-leaf="true" data-offset-key="3000:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">加大内存配置，结合 Executor 线程池调整，提高 1/N 上限到 300MB</span></span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3001" id="sr-toc-7"><span data-slate-object="text" data-key="3002"><span data-slate-leaf="true" data-offset-key="3002:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="3003"><span data-slate-object="text" data-key="3004"><span data-slate-leaf="true" data-offset-key="3004:0" data-first-offset="true"><span data-slate-string="true">想要高效解决五花八门的 OOM 问题，最重要的就是准确定位问题出现的区域，这样我们的调优才能有的放矢，我建议你按照两步进行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3005"><span data-slate-object="text" data-key="3006"><span data-slate-leaf="true" data-offset-key="3006:0" data-first-offset="true"><span data-slate-string="true">首先，定位 OOM 发生的代码位置，你通过 Stack Trace 就能很快得到答案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3007"><span data-slate-object="text" data-key="3008"><span data-slate-leaf="true" data-offset-key="3008:0" data-first-offset="true"><span data-slate-string="true">其次，定位 OOM 是发生在 Driver 端还是在 Executor 端</span></span></span><span data-slate-object="text" data-key="3009"><span data-slate-leaf="true" data-offset-key="3009:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">。</span></span></span></span><span data-slate-object="text" data-key="3010"><span data-slate-leaf="true" data-offset-key="3010:0" data-first-offset="true"><span data-slate-string="true">如果是发生在 Executor 端，再定位具体发生的区域。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3011"><span data-slate-object="text" data-key="3012"><span data-slate-leaf="true" data-offset-key="3012:0" data-first-offset="true"><span data-slate-string="true">发生在 Driver 端的 OOM 可以归结为两类：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="3013"><div data-slate-type="list-line" data-slate-object="block" data-key="3014"><span data-slate-object="text" data-key="3015"><span data-slate-leaf="true" data-offset-key="3015:0" data-first-offset="true"><span data-slate-string="true">创建的数据集超过内存上限</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="3016"><span data-slate-object="text" data-key="3017"><span data-slate-leaf="true" data-offset-key="3017:0" data-first-offset="true"><span data-slate-string="true">收集的结果集超过内存上限</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3018"><span data-slate-object="text" data-key="3019"><span data-slate-leaf="true" data-offset-key="3019:0" data-first-offset="true"><span data-slate-string="true">应对 Driver 端 OOM 的常规方法，是先适当预估结果集尺寸，然后再相应增加 Driver 侧的内存配置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3020"><span data-slate-object="text" data-key="3021"><span data-slate-leaf="true" data-offset-key="3021:0" data-first-offset="true"><span data-slate-string="true">发生在 Executors 侧的 OOM 只和 User Memory 和 Execution Memory 区域有关，因为它们都和任务执行有关。其中，User Memory 区域 OOM 的产生的原因和解决办法与 Driver 别无二致，你可以直接参考。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3022"><span data-slate-object="text" data-key="3023"><span data-slate-leaf="true" data-offset-key="3023:0" data-first-offset="true"><span data-slate-string="true">而 Execution Memory 区域 OOM 的产生的原因是数据分布与 Execution Memory 的运行时规划不匹配，也就是分布式任务的内存请求超出了 1/N 上限。解决 Execution Memory 区域 OOM 问题的思路总的来说可以分为 3 类：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="3024"><div data-slate-type="list-line" data-slate-object="block" data-key="3025"><span data-slate-object="text" data-key="3026"><span data-slate-leaf="true" data-offset-key="3026:0" data-first-offset="true"><span data-slate-string="true">消除数据倾斜，让所有的数据分片尺寸都小于 1/N 上限</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="3027"><span data-slate-object="text" data-key="3028"><span data-slate-leaf="true" data-offset-key="3028:0" data-first-offset="true"><span data-slate-string="true">把数据打散，提高数据分片数量、降低数据粒度，让膨胀之后的数据量降到 1/N 以下</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="3029"><span data-slate-object="text" data-key="3030"><span data-slate-leaf="true" data-offset-key="3030:0" data-first-offset="true"><span data-slate-string="true">加大内存配置，结合 Executor 线程池调整，提高 1/N 上限</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3031" id="sr-toc-8"><span data-slate-object="text" data-key="3032"><span data-slate-leaf="true" data-offset-key="3032:0" data-first-offset="true"><span data-slate-string="true">每日一练</span></span></span></h2><div data-slate-type="list" data-slate-object="block" data-key="3033"><div data-slate-type="list-line" data-slate-object="block" data-key="3034"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="3035"><span data-slate-leaf="true" data-offset-key="3035:0" data-first-offset="true"><span data-slate-string="true">数据膨胀导致 OOM 的例子中，为什么 Task1 能获取到 300MB 的内存空间？（提示：可以回顾 CPU 视角那一讲去寻找答案。）</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="3036"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="3037"><span data-slate-leaf="true" data-offset-key="3037:0" data-first-offset="true"><span data-slate-string="true">在日常开发中，你还遇到过哪些 OOM 表象？你能把它们归纳到我们今天讲的分类中吗？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3038"><span data-slate-object="text" data-key="3039"><span data-slate-leaf="true" data-offset-key="3039:0" data-first-offset="true"><span data-slate-string="true">期待在留言区看到你的思考和分享，我们下一讲见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-9">精选留言 (23)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>wow_xiaodi</span></div></div><div>老师，从第一讲看到这里，貌似有个东西还没介绍，假设并行度、executor core 和每个 core 均摊的 execution memory 都估算好了，那么我要几个 executor，每个 executor 几个 core 好呢，就是说我 executor 多，然后每个 executor 的 core 少点，还是反过来好呢，是否有经验之谈？</div><div><p>作者回复：好问题，思考的很细致～一般来说，在这种情况，我们倾向于 “广撒网”，就是 Executors 个数多一些，每个 Executors 的资源相对小一些，比较轻量。

这么做的目的，主要是保证分布式计算的鲁棒性与扩展性，轻量 Executors 失败、重建的开销，要小于重量级的 Executors。尤其是在开启了 Dynamic Allocation 的情况下，更是如此。</p></div><div><div>2021-08-07</div><div><div><i></i></div><div><i></i><span>10</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/f1/bb/547b580a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 苏子浩</span></div></div><div>老师好，我有一下三个问题：
(i) 关于 Task 获取内存方面中 “每个线程分到的可用内存有一定的上下限，下限是 M/N/2，上限是 M/N，也就是属于 [M/(2*N), M/N].”, 同时注意到上述的 M 和 N 其实是随着 Executor 中 task 的状态动态变化的，根据前文提到的 “执行内存总量 M 动态变化，由于 Execution Memory 可以占用 Storage Memory 以及抢占的优先级，所以 ExecutionMemory 的下限是 Execution Memory 初始值，上限是 spark.executor.memory * spark.memory.fraction” 和 “N~ 是 Executor 内当前的并发度”。但是在具体的例子中怎么 task 的内存分配我不是很理解。比如本文中提到的 “实例 1：数据倾斜” 所提到的 “Executor 线程池大小为 3，因此每个 Reduce Task 最多可获得 360MB * 1 / 3 = 120MB 的内存空间。Task1、Task2 获取到的内存空间足以容纳分片 1、分片 2，因此可以顺利完成任务。” 我不理解的是，此时的 Task 是以 “一批” 的形式同时进入 Executor 吗？所以是 “360MB/3=120MB”。为什么不是 Task1‘到的早’，它刚来的时候 N=1，所以它最多可以拿到整个执行内存，即 360MB 呢？但是 Task1 实际只需要 100MB，所以分 100MB 给 Task1。此时可用的‘动态执行内存总量’变成 260MB（如果是这样，那么接着的内存构成是：(1) 80MBStorage Memory + 180Execution Memory 还是 (2) 180MBStorage Memory + 80MBExecution Memory？i.e. 其实我想问的是在内存分配上的优先级是怎么分配？先去‘贪心’地抢先占用 Storage Memory 等用完以后再使用 Execution Memory 还是分配 Execution Memory 再开始用 Execution Memory？根据您的黄小己招租种地的规则应该是先去占用自己所属的部分的内存吧？）
(ii) 同时，实例二：数据膨胀例子中，“task1 之所以能拿到 300MB，是因为它 “到的早”，它刚来的时候 N=1，所以它最多可以拿到整个执行内存。“那么 task1 实际是拿到了多少内存呢？是 300MB 还是 360MB？是按需分配还是给 360MB？如果是分配了 300MB，那么此时 “动态执行内存总量” 变成了多少呢，是 60MB 吗？那么此时 Task2 进入时，假设 Task3 还没有进入，N 等于 2 了，所以 Task2 分配到的执行是 60 / 2 = 30MB 吗？
(iii) Executor 中的 Task 是同时进入的吗？我的意思是 Driver 是否会一次性生成所有的的 Task，并将 Task 全部都发送到 Executor 去执行？还是 Driver 不完全发送所有 Task，根据 Executor 的并发度（基本上取决于 Executor 的 cores 个数）去发送，按照 Executor 的执行情况去发送 Task，执行完一个 Task 再发送一个 Task？虽然之前有提到其实 Task 本身是自带任务调度意愿的。
打了很多字，确实自己没有想明白，麻烦老师了，不好意思！谢谢！</div><div><p>作者回复：都是很好的问题～没事，不用怕字数多，像这样的讨论多多益善～咱们一个一个来说。

i）先说执行内存的上限，你也说了，是 Execution Memory、外加 Storage Memory 空闲的部分。再说内存抢占，这两部分内存的消耗，一定是优先消耗 Execution Memory，然后再去抢占 Storage Memory，而且，抢占的时候，还只能抢 Storage Memory 空闲的部分（Storage Memory 的空间也是动态变化的，比如中间有缓存任务往 Storage Memory 里面灌数据）。这块其实可以想想黄小乙的占地协议，他必须先把自己的地种满，然后才能去抢人家的地，不能说，一上来，就把人家麻子的地给占了，那也不公平嘛！再者，关于任务的内存消耗，思考的很深入，挺好～我们要区分两个概念，一个，是 Task 可以获取到的内存上限、也就是 1/N；一个，是 Task 计算对于内存的消耗需要。换句话说，一个是供给上限，一个是计算需求。内存的分配，是按照需求来分配的，也就是说，你需要多少，就逐步给你分配多少。并不是说，你的上限是 120MB，Memory Manager 一下子就把这 120MB 全部划给你、预留给你了。1/N 只是说明，你最多可以拿这么多，但是你具体消耗多少，取决于你手里有多少农作物的种子。这就好比，你手里就 1 亩地的种子，却想从黄小乙那里租赁 10 亩地，那黄小乙也不能同意呀！剩下的 9 亩地，不是白白浪费掉了么。

ii）好像已经把问题 ii）回答了，哈哈，就是你说的那样，消耗 300MB，还剩 60MB。如果 Task2 到了、Task3 还没到，就是你算的结果 60MB/2 = 30MB。

iii）这个确实是个好问题，不过这个问题也暴露了你调度系统那一讲没吃透 😃，这部分其实要结合调度系统去理解。还记得 DAGScheduler、TaskScheduler 和 SchedulerBackend 吗？Executors 的空闲状态，是由 SchedulerBackend 维护的，TaskScheduler 拿到 DAGScheduler 拆解的 Tasks 之后，开始去 SchedulerBackend 那里尝试拿 ResourceOffer，然后再从 Tasks 里面去挑，挑那些满足本地性级别要求的任务，然后再调度过去。你可以把 DAGScheduler 理解为任务执行的需求端，把 SchedulerBackend 理解成计算资源的供给端，而 TaskScheduler 就是中间的媒人、中介、撮合商。回答你的问题，首先，不是 Driver 一股脑把 Tasks 都分发过去，因为 Tasks 的执行需求，要先看 SchedulerBackend 有没有足够的资源供给。实际上，这个流程恰恰相反，是 SchedulerBackend 先提供 ResourceOffer，然后 TaskScheduler 才能去挑 Tasks，然后把任务调度过去。所以实际的调度情况，和你后者说的差不多，也就是你说的：“按照 Executor 的执行情况去发送 Task”。任务调度确实比较难，除了前面的第 5 讲《调度系统》，还可以看看 infoQ 的这篇，这篇《权力的游戏》更详尽：https://www.infoq.cn/article/5aOHzQIaXX6NlHriLtSI</p></div><div><div>2021-04-27</div><div><div><i></i></div><div><i></i><span>9</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/c6/09/7f2bcc6e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>sky_sql</span></div></div><div>老师好！麻烦问下 Shuffle 文件寻址有个参数 spark.reducer.maxSizeInFlight 默认 48m，这个 buffer 缓冲每次拉取 48m 数据。是 Execution Memory 剩余部分不够 48m 就会 oom 吗？这个和 1/N 的有啥关联？</div><div><p>作者回复：好问题，你说的是对的，这部分 buffer 也算作 Execution Memory 的一部分，也会记到 Execution Memory 的 “账上”。因此，如果像你说的这种 edge case，连 48M 都没有了，那拉数据的时候确实会 OOM。这部分就没有 1/N 的关系了哈，每个 task 都是这么大的 buffer，一旦不够，也就 OOM 了。</p></div><div><div>2021-04-21</div><div><div><i></i></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span> 王天雨</span></div></div><div>1、执行内存总量是动态变化的，最大是 spark.executor.memory * spark.memory.fraction
本例中最大 360M。
其次并发度 N 是固定不变，但是 Executor 中当前并行执行的任务数是小于等于 N 的，
上下限公式的计算是根据 Executor 中当前并行执行的并发度来计算的。
因此先拿到任务的线程能够申请更多的资源，极端情况下，本例单个 Task 可享受 360M 内存。</div><div><p>作者回复：正解～赞～👍  老弟对于执行内存的（1/N/2，1/N）理解得相当到位～</p></div><div><div>2021-04-21</div><div><div><i></i><span>4</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 快跑</span></div></div><div>老师好！
实例 1 中
1、为什么提到 “线程池大小设置为 1 是不可取的”？

2、假如 spark.executor.cores 设置成 1 ，有 3 个 Task，串行。  
第一个 Task 执行完成后，360M 的内存会全部都释放么？会不会有垃圾还没有回收的情况，导致 Task2 的内存没有 360M 可以</div><div><p>作者回复: 1. 如果并发度是 1，单个 Executor 就是纯粹的串行计算了，Spark “分布式” 计算引擎的并行计算就失去了意义。即便还是可以有多个 Executors，但是如果每个 Executor 在同一时间只有一个线程在工作，这种 “分布式” 计算的效率也是极其低下的。

2. 好问题，确实有这个隐患。不过呢，因为任务执行涉及的对象都是 short-lived，也就是生命周期都很短，不像 Storage Memory 存储的缓存对象、生命周期很长。因此，执行任务涉及到的对象，多是放在年轻代，Minor GC 的触发会频繁一些，回收效率也更高。不像 long-lived objects，往往需要触发 Full GC 才能回收。因此，即便有还未回收的内存，也不影响任务执行，因为 Minor GC 频繁、且轻量，能够相对及时地把内存回收。</p></div><div><div>2021-04-21</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/f1/bb/547b580a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 苏子浩</span></div></div><div>老师，我想问一下，数据膨胀导致 OOM 的例子中，一定会出现 OOM 吗？既然 Task1 能获取到 300MB 的内存空间，那么挂起 Task2 线程和 Task3 线程，等待 Task1 内存释放，然后依次完成 3 个 Task 呢？</div><div><p>作者回复：你说的对，如果 Spark 可以保证依次运行这 3 个 Tasks，确实不会 OOM。不过，这里的关键是 “依次”，当 Executors 线程池大于 1 的时候，Spark 不能保证 “依次” 处理 task。Task 确实有先来后到，但是要是严格保证 “依次” 可就难了。

把 spark.executor.cores 置为 1，就是咱们这讲举的极端的例子，Spark 可以严格保证 “依次”，不过就像咱们说的，它其实已经失去并行计算的意义了。</p></div><div><div>2021-04-27</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/qmdZbyxrRD5qQLKjWkmdp3PCVhwmWTcp0cs04s39pic2RcNw0nNKTDgKqedSQ54bAGWjAVSc9p4vWP8RJRKB6nA/132"></div></div><div><div><div><span> 冯杰</span></div></div><div>老师好，文章中提到：“Task3 的数据分片大小远超内存上限，即便 Spark 在 Reduce 阶段支持 Spill 和外排，120MB 的内存空间也无法满足 300MB 数据最基本的计算需要，如 PairBuffer 和 AppendOnlyMap 等数据结构的内存消耗，以及数据排序的临时内存消耗等等。”

关于上述这段话有点疑问：
1、shuffle read 阶段，reduce task 去 fetch 数据时，是可以支持 spill 到磁盘的。  但在实际工作中，经常出现 fetch fail 的异常，增加内存后或者同等内存下换为堆外内存也可以解决问题；
2、为什么支持 spill 操作，还会导致 OOM 呢？     看老师的解答是需要一个最基础的内存需求，比如：300MB 的数据需要 120M+50M 内存，这块儿不是很明白</div><div><p>作者回复：好问题～

其实这两个问题，都可以归结为一个问题，就是 JVM 堆内内存的使用与占用预估。其实课程中咱们提到过，就是 Spark 对于 JVM 堆内内存的估计是不够准确的，这主要是为了牺牲一定的精度，而照顾效率上的考虑。

而堆外内存的计算，就不存在这样的隐患，堆外内存的计算，是非常精确的。因此，JVM 堆内内存的 OOM，相比堆外会更加的频发。

Task 之间的内存争抢，在 “逻辑上” 会尊重（M/N/2, M/N）的限制，但实际在 JVM 里面，不同 Task 所占用的内存，是没有明确边界的。再加上 Spark 对于内存预估的不准确，OOM 也就在所难免。

Spill，仅仅是在 Spark 的预估值明确表示内存不足的时候，才会触发。而很多时候，OOM 的根源在于，“看上去” 内存是够的，但真要用的时候，发现不够。

除了预估不准以外，一些内存数据结构的扩展，也会触发 OOM。比方说，AppendOnlyMap、PartitionedPairBuffer，他们在 spill 之前，会有一次扩容，在内存中的扩容，目的就是为了承载更多的用户数据。如果扩容的过程中，发现内存不足，那就只能 OOM 了。因为这里没有 Spill 的逻辑，纯粹的内存扩容。

说得不够系统，头上一句、腚上一句，希望对老弟有所帮助～</p></div><div><div>2021-10-08</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/d1/f6/d75afb79.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 在路上</span></div></div><div>老师好，请教下关于 driver 端 oom 问题，生产中遇到过这样问题，数据表数据量大，每次扫描近一年分区，几十个表关联场景，每次任务启动都一直初始化，有的时候还超时失败，任务一只 run 不起来，我记得没修改逻辑的时候是把 driver 调到 100 多 g 解决的。后续把代码扫描分区缩短了没有了，想问一下这种情况 driver 在计算分片吗？为啥这么久啊。</div><div><p>作者回复：老弟说的生产环境，我理解是物理上的分布式集群哈。如果是真正的分布式集群，那肯定就不是 Driver 在读数据。坦白地说，你说的这种情况，我觉得挺蹊跷的，把 Driver 端调大，就能解决问题，但是，把需要扫描的数据量缩小，问题也不见了。所以听上去，是数据量太大，可问题是，Driver 并不需要扫描数据，需要扫描的数据量多少，也不会给 Driver 增减负担，所以这个就很奇怪了。结合你的描述：“每次任务启动都一直初始化，有的时候还超时失败，任务一只 run 不起来”，倒是有一种可能，就是 DAG 过于复杂（几十个表关联），导致任务调度失败（比如 Task 过大，Task 分发超时，等等），不过这个需要老弟确认，你说的超时，具体是什么超时？Task 分发超时，还是心跳连接超时？有了这些信息，更好判断一些～</p></div><div><div>2021-12-03</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/b5/88/477e7812.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>RespectM</span></div></div><div>老师数据膨胀如何监控，怎么看是否是数据膨胀导致的 oom，还是 shuffle 的时候 netty 导致的堆外内存 oom？</div><div><p>作者回复：首先，这两种 OOM 的报错信息不同哈，前者一般是 Not enough heap memory，也就是堆内空间不足；而后者一般会报 overhead 不够，所以仅从报错信息，基本就能分辨两者的区别。

再者，对于数据膨胀的监控，可以考虑利用 Spark UI 的一些常规指标，比如说 Stage 详情页面的 Shuffle spill (memory) 和 Shuffle spill (disk)，它们标记了同一份数据在内存与磁盘中的大小，通过观察两者的差异，可以量化对比数据在内存中的膨胀系数，也就是：
Memory Expansion Rate ≈ Shuffle spill (memory) / Shuffle spill (disk)。</p></div><div><div>2021-05-30</div><div><div><i></i><span>3</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/f1/bb/547b580a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 苏子浩</span></div></div><div>老师，您好。关于文中在 “case1: 数据倾斜” 部分提到的 “针对以这个案例为代表的数据倾斜问题，我们至少有 2 种调优思路：1. 消除数据倾斜，让所有的数据分片尺寸都不大于 100MB；2. 调整 Executor 线程池、内存、并行度等相关配置，提高 1/N 上限到 300MB”。我有两点疑问：
（1）这里提到的数据分片尺寸 100MB 是怎么定的呢？为什么不是 120MB 呢？本例子中 Executor 线程池大小为 3，每个 Reduce Task 最多可获得 360MB / 3 = 120MB 的内存空间。以及关于留言关于 “spark.reducer.maxSizeInFlight“的回复：” 这部分 buffer 也算作 Execution Memory 的一部分，也会记到 Execution Memory 的 “账上”。“那么保证数据分片尺寸低于 120MB 或者 100MB 此时有效吗？

（2）调整 Executor 线程池、内存、并行度等相关配置，提高 “ 1/N ” 上限到 300MB，这里为什么是 “1/N” 而不是 14 讲中的 “动态实时变化的 Execution Memory / N～” 呢？文中所举的例子 “维持并发度、并行度不变，增大执行内存设置，提高 1/N 上限到 300MB”，这里我的理解变化的是 Execution Memory ，和 “1/N” 这个本身有关系吗？
谢谢老师！</div><div><p>作者回复：好问题，我们一个一个来说。

1） 你说的没错，线程池大小为 3 的话，确实每个 Task 最多可以拿到 120MB 的内存。咱们原文里面建议分片大小 100MB，目的其实就是留点富余，不要满打满地真的把分片大小弄到和上限一样大。

留富余的目的，其实就是为了任务执行的稳定性和可靠性。首先，这里面有你说的因素，也就是其他环节也都需要内存；再者，即便其他环节不消耗内存，我们也得留下富余。原因是，对于任务调度来说，作为开发者，我们不能直接掌控，任务总有先来后到，在 N~ &lt; N 的时候，我们用 N=3 去计算每个 Task 分得的内存大小，就会有偏差，这个咱们原文也有讲。所以，我们在考虑每个分片数据量大小的时候，要尽量留些富余出来。

2）我们之所以用 N 去计算、去预估，有两个原因。第一个很简单，N~ 是不确定的，我们只知道 N~ &lt; N，但不知道 N~ 具体是多少。再者，虽然由于调度系统的缘故，Task 有先来后到，在任务调度初期 N~ 确实小于 N，但是随着执行的进行，N~ 总会追上来、等于 N，而且这个过程其实很快。也就是在大部分时间，N~ 都是等于 N 的。另外，在你说的 case 里，只有增大 Execution Memory，相应的 1/N 也才能跟着变大呀 😃</p></div><div><div>2021-04-27</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Fendora 范东_</span></div></div><div>1.task1 首先运行的，拿到自己 1/N 发现还不够，就继续申请内存。task2/task3 后面运行，发现可用内存满足下限，就跑去运行了，结果 task1 抢先申请到 300M，task2,task3 在运行时需要更多内存，不能得到满足，导致 OOM。
2.driver 端 oom:
遇到过执行查询 SQL，结果集太大，oom。通过调 maxResultSize 大小来解决。   
executor 端 oom:
之前没细究过，oom 了就给 executor 调大内存就完了。。。。😅</div><div><p>作者回复: 1. 不完全对，task1 之所以能拿到，是因为它 “到的早”，它刚来的时候 N=1，所以它最多可以拿到整个执行内存。task2、task3 不行，是因为他们来得晚，他们到的时候，N 至少等于 2 了，所以 “每人” 最多拿执行内存的一半，所以肯定会 OOM。这里其实有点 tricky，主要想考大家对于（1/N/2，1/N）的理解是不是足够透彻。

2. 对，driver OOM 调整 maxResultSize 比较典型。学过这一讲，Executors 内存调优可以做得更细致一些了，就不必每次都是单纯调大 executor.memory~</p></div><div><div>2021-04-21</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Fendora 范东_</span></div></div><div>有个疑问
collect 是把 executor 所有数据全部拉回来，但是他是一次性全放到 driver 端吗？如果是，那 fetchsize 的大小只是为了分批输出吗，是不是调的越大输出就越快了；如果不是，那就不应该出现 driver 端 oom 吧
按照文中分析来看，collect 就是把所有数据一次性拉到 driver 端了吧？</div><div><p>作者回复: collect 是全量拉，你说的 fetch size，我理解是单批次拉取的最大数据量，是用来限制网络吞吐的，因此这个参数和 Driver 是否 OOM 没有关系。Driver 能承受的全量数据大小，由 maxResultSize 参数来决定，如果你拉的全量数据，大于 maxResultSize，就会 OOM。</p></div><div><div>2021-04-21</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/05/92/b609f7e3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 骨汤鸡蛋面</span></div></div><div>老师，我在公司做 AI 云平台相关工作，AI 云平台的工作流里面有很多 spark 任务，这个任务可能跑一天的数据，也可能跑一个月的，但是算法工程师不会调节 spark 参数，就导致 任务的运行时间不可控，所以，我们想做一个 配置建议的工具，告诉算法人员这次提交任务，cpu 和 mem 最好配多大。请问下，spark 有人开展类似工作嘛？</div><div><div>2022-05-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Unknown element</span></div></div><div>老师您好，我有几个问题：
（1）文章中举的例子，“每个 core 有两个线程” 是怎么设置的？spark.task.cpus=0.5 吗？
（2）我看官方文档对于 spark.executor.cores 的定义是 The number of cores to use on each executor. 现在 spark.executor.cores=3 但是一个机器上只有两个 core，那这时候创建 executor 的资源好像不够？另外您说 spark.executor.cores=1 就失去并行的意义了，但是我们目前 spark.executor.cores 就设置的是 1（捂脸）运维说这是经过慎重考虑的默认参数，在 https://mp.weixin.qq.com/s/gNxQKTH9JkNsDaBKttvAsQ 这篇文章的 06 规范优化 =&gt; 03 参数滥用问题 有提到，不知道老师对这个设置怎么看呢？
（3）您对 To_Drill 和 狗哭 两位同学的问题回答感觉有一点矛盾呢～在 狗哭 的问题的回答中您说 “task 申请不到额外内存，不得不进入 waiting list，等待别的 task 把内存释放，这个时候，CPU 也会挂起”，也就是说 task 开始计算之后发现内存不够但是又申请不到额外内存就会被挂起，但是在 To_Drill 的问题的回答中您说 “task 为了容纳整个数据分片，需要不停地申请内存，如果内存不够，任务不能再挂起了，因为挂起来，内存也不能释放，别的 task 也进不来，挂起没有意义，所以只能硬着头皮往下执行，直到把内存撑爆为止”，意思应该是 task 开始计算之后发现内存不够但是又申请不到额外内存这时就直接抛 oom？不知道是不是我没理解对...
谢谢老师！！</div><div><p>作者回复：好问题，老弟看的非常仔细、认真，赞一个先👍，咱们一个个说
1）是的，如果一个 core，要跑两个 task，就设置 0.5，不过这个需要每个 core 切实可以超线程到至少两个线程，物理上才可行
2）先说结论，spark.executor.cores 设置为 1，是没问题的，只要 Executors 数量足够多，也可以充分利用硬件资源，做到并行计算。我又回顾了下原文，原文的说法，确实有问题，漏了一句话。就是在咱们 OOM 数据倾斜的例子里，本意是说，在一个物理机的那一个 Executor 中，把 spark.executor.cores 设置为 1，那么那个 Executor 就从并行计算，退化到串行计算，因为只有一个 cpu 嘛。但是，实际上一个物理机，可以起多个 Executors，每个 Executors 只有一个 cpu，也是 OK 的。只不过我们这里，为了说明 OOM 的 root cause，把场景和问题都简化了，就假设一个物理机，只起一个 Executor，串行起来的话，就不会有倾斜导致的 OOM 问题。总结来说，在实际工业部署中，一个集群，多个 Executors，每一个 Executors 一个 CPU core，是完全 OK 的。
3）我看了下，这里确实有矛盾的地方，可能当时回答 “狗哭” 同学的时候，比较草率了。这里 double confirm 下，给 “To_Drill” 的答复是正确的哈，参考后者的答复即可～挂起，只存在于 task 启动前（拿不到 N/2），一旦拿到 N/2 内存，task 即开始执行，执行过程中，如果内存申请持续得不到满足，就抛 OOM</p></div><div><div>2022-01-04</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/66/54/05b7341b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>毕务刚</span></div></div><div>老师好：

将 HDFS 的 json 文件导入到 hive 表时，出现 java.lang.OutOfMemoryError: GC overhead limit exceeded，
并且在 log 中，可以看到 WARN MemoryManager: Total allocation exceeds 95.00% (906,992,014 bytes) of heap memory

代码很简单
spark.read.json ("**").write.mode ("overwrite").saveAsTable ("**")

这个问题是哪部分内存出现了问题呢？ 
如果不增加内存， 还可以如何优化？</div><div><p>作者回复：消耗的是 Execution Memory，从报错上看，可以把先把 Executors 内存调大，看上去现在只有 1GB，比较小。

另外，问下老弟 JSON 文件平均多大？或者说，JSON 文件的分片多大？分片最好不要超过 1GB，128M、256M 为宜。另外，还有个问题，每个 JSON 字符串大概多大？因为 JVM 里面，是需要给每个 JSON 串构建对象的，如果 JSON 串本身很大，也会有 OOM 隐患。

所以回答老弟的问题，如果不动内存，那就只好对源文件下手了，把数据分片打散一些，不过还是那句话，如果一个 JSON 结构本身就很大，这个就比较麻烦，毕竟对象的构建，是以一个 JSON 结构为粒度的</p></div><div><div>2021-11-25</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/98/4d/582d24f4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>To_Drill</span></div></div><div>老师，对下边这个描述我有个疑问，既然内存是陆续分配的，申请不到内存时会挂起，那些 OOM 的 case 为啥没有挂起呢？
2）再一个，就是随着 task 的进展，task 对于内存的持续申请，得不到满足，注意，是持续申请，Spark 根据 task 的计算需要，陆续给 task 分配内存，并不是一下子就提前 allocate 一定量的内存，这个是很多同学困惑的地方～就是大家一开始可能申请的都不多，但是随着各自 task 计算的进展，大家申请的内存量会陆续增大，慢慢的，就会出现有些 task 申请不到额外内存，不得不进入 waiting list，等待别的 task 把内存释放，这个时候，CPU 也会挂起，造成 CPU 资源的浪费</div><div><p>作者回复：好问题，是申请不到 M/N/2，会被挂起，一旦这个初始值达到了，task 就会唤醒执行。

执行过程中，根据任务和数据量需要，会不停地申请内存，当然，中间可以利用 spill 机制，来做外排。但是，像 AppendOnlyMap，PartitionPairBuffer 这种内存数据结构，在内存有需要时，他们会翻倍地扩张；还有一些任务，比如 Hash Join 的 build 阶段，hash table 是需要在内存中构建的。

这样的话，task 为了容纳整个数据分片，需要不停地申请内存，如果内存不够，任务不能再挂起了，因为挂起来，内存也不能释放，别的 task 也进不来，挂起没有意义，所以只能硬着头皮往下执行，直到把内存撑爆为止</p></div><div><div>2021-11-23</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/78/a0/7a248ddc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>福</span></div></div><div>老师好，关于苏子浩的提问的。。。。。(ii) 同时，实例二：数据膨胀例子中，“task1 之所以能拿到 300MB，是因为它 “到的早”，它刚来的时候 N=1，所以它最多可以拿到整个执行内存。“那么 task1 实际是拿到了多少内存呢？是 300MB 还是 360MB？是按需分配还是给 360MB？如果是分配了 300MB，那么此时 “动态执行内存总量” 变成了多少呢，是 60MB 吗？那么此时 Task2 进入时，假设 Task3 还没有进入，N 等于 2 了，所以 Task2 分配到的执行是 60 / 2 = 30MB 吗？
我的理解是这样的，，，tast1 分走了 300M，tast2 进来了，此时 N=2，我觉得应该是 task1 和 task2 来分一共的 360M (两个任务最大的上限（360/2）180M), 此时 task2 只需要 100M，那么 task2 可以运行，task1 应该只能分到 360-100 等于 260M，但是因为 task1 本身需要 300，所以 oom，，，， 不理解 为什么 task2 是分到 60/2=30M</div><div><p>作者回复：老弟说的对，这里 60 / 2 = 30MB 是不对的，应该是（360/2）= 180M，就是说，在算每个 Task 能够分配的内存时，分子应该是 “动态执行内存总量”，而不是当前的 Free Memory，这里需要更正下，感谢老弟提醒～

接下来，咱们来分析一下这个过程。Task2 进来之后，每个 Task，在理论上，最少拿到 90M，最多拿到 180M。但是这个时候，Task1 已经占据了 300M，Free Memory 还剩 60M。

在这种情况下，Task2 会被挂起，等待 Task1 释放内存，直到 Free Memory 超过 90M，这个时候 Task2 恢复执行，但是，Task2 需要 300M 的内存（不是你说的 100M 哈，要考虑膨胀系数），随着 Task2 的推进执行，需要消耗的内存越来越多，但是系统提供不了 Task2 所需的内存消耗，因而最终会 OOM~</p></div><div><div>2021-11-11</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/96/17/200c21f0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>狗哭</span></div></div><div>老师您好，接着上面苏子浩的第二问的回答我有点不太明白了。前面 cpu 那一讲线程挂起这个问题里面有这样一段：M 的下限是 Execution Memory 初始值，上限是 spark.executor.memory * spark.memory.fraction 划定的所有内存区域。那这样的话 task2 进来时给它的内存不应该是（360/2/2，360/2）吗？如果是 60/2 的话，那线程挂起只有一种情况了，就是这个线程一点内存也没抢占到，也不存在因为分配的内存大于 0 小于 M/N/2 而挂起这种情况了吧。请老师指点</div><div><p>作者回复：可能原文我没说清楚哈～CPU 挂起有两种情况：
1）一个就是底线不满足：也就是连 M/N/2 的内存都申请不到～
2）再一个，就是随着 task 的进展，task 对于内存的持续申请，得不到满足，注意，是持续申请，Spark 根据 task 的计算需要，陆续给 task 分配内存，并不是一下子就提前 allocate 一定量的内存，这个是很多同学困惑的地方～就是大家一开始可能申请的都不多，但是随着各自 task 计算的进展，大家申请的内存量会陆续增大，慢慢的，就会出现有些 task 申请不到额外内存，不得不进入 waiting list，等待别的 task 把内存释放，这个时候，CPU 也会挂起，造成 CPU 资源的浪费</p></div><div><div>2021-11-04</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1e/f2/f5/b82f410d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Unknown element</span></div></div><div>老师 问下数据倾斜的第二种解决方法 “维持并发度、执行内存不变，使用相关配置项来提升并行度将数据打散，让所有的数据分片尺寸都缩小到 100MB 以内” 感觉不能解决本质问题吧，发生数据倾斜应该是因为某个分区数据量太大了，但是分区不管打的多散，这些数据在 reduce 阶段都会汇集到一个节点吧？</div><div><p>作者回复：是的，你说的没错，这种做法，本质上会缓解因为并行度设置问题而引入的倾斜问题（比如并行度过低，Hash 过后大部分数据被划分到少量分区之上）。对于那些少数 id 带来的绝对倾斜问题，纯靠调整并行度是没用的～

这个时候，要么用 AQE 的自动倾斜处理，要么手工加盐，消除倾斜。</p></div><div><div>2021-10-25</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/00/3f/a0f84788.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Sean</span></div></div><div>磊哥好，磊哥上文提到的案例中采用默认配置，源码里面是这样描述的:
"The region shared between execution and storage is a fraction of (the total heap space - 300MB) configurable through`spark.memory.fraction`(default 0.6). The position of the boundary within this space is further determined by`spark.memory.storageFraction`(default 0.5). This means the size of the storage region is 0.6 * 0.5 = 0.3 of the heap space by default"
1. 总的堆内存没有提到 user memory, 只有 storage + execution + reserved
2. 默认配置 fraction:0.5,storagefraction:0.6,storage=(900-300)*0.3=180m,execution=(900-300)*0.6*(1-0.5)=180m
3. 没有缓存这里理解为没有使用到 storage memory 缓存 RDD, 广播变量等数据，为 0M, 则 execution 可以额外占用 180M,xecution = 360M
4. 反推 900M= reserved300m+storage180M+execution180M+240M, 可以理解为 240M 是预留的给 user memory 的内存吗？</div><div><p>作者回复：就按照文中给出的公式计算就好了，user memory 一定是有的～JVM 堆内就分成了 4 部分，Reserved、User、Execution、Storage。你可以再翻翻其他源码～</p></div><div><div>2021-08-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".v"><outline class="toc-level-h1" data-reactid=".v.0" style="width: 175px;"><active data-reactid=".v.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".v.0.1"><span data-reactid=".v.0.1.0">17 | 内存视角（三）：OOM 都是谁的锅？怎么破？</span></a></outline><outline class="toc-level-h2" data-reactid=".v.1" style="width: 165px;"><active data-reactid=".v.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".v.1.1"><span data-reactid=".v.1.1.0">Driver 端的 OOM</span></a></outline><outline class="toc-level-h2" data-reactid=".v.2" style="width: 165px;"><active data-reactid=".v.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".v.2.1"><span data-reactid=".v.2.1.0">Executor 端的 OOM</span></a></outline><outline class="toc-level-h3" data-reactid=".v.3" style="width: 155px;"><active data-reactid=".v.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".v.3.1"><span data-reactid=".v.3.1.0">User Memory 的 OOM</span></a></outline><outline class="toc-level-h3" data-reactid=".v.4" style="width: 155px;"><active data-reactid=".v.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".v.4.1"><span data-reactid=".v.4.1.0">Execution Memory 的 OOM</span></a></outline><outline class="toc-level-h4" data-reactid=".v.5" style="width: 145px;"><active data-reactid=".v.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".v.5.1"><span data-reactid=".v.5.1.0">实例 1：数据倾斜</span></a></outline><outline class="toc-level-h4" data-reactid=".v.6" style="width: 145px;"><active data-reactid=".v.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".v.6.1"><span data-reactid=".v.6.1.0">实例 2：数据膨胀</span></a></outline><outline class="toc-level-h2" data-reactid=".v.7" style="width: 165px;"><active data-reactid=".v.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".v.7.1"><span data-reactid=".v.7.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".v.8" style="width: 165px;"><active data-reactid=".v.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".v.8.1"><span data-reactid=".v.8.1.0">每日一练</span></a></outline><outline class="toc-level-h2" data-reactid=".v.9" style="width: 165px;"><active data-reactid=".v.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".v.9.1"><span data-reactid=".v.9.1.0">精选留言 (23)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/365238" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>