
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 第 16 讲 | synchronized 底层如何实现？什么是锁的升级、降级？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>第 16 讲 | synchronized 底层如何实现？什么是锁的升级、降级？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">第 16 讲 | synchronized 底层如何实现？什么是锁的升级、降级？</h1><div><span>杨晓峰</span> <span> 2018-06-12</span></div><div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/3e/ad/3eaf209ce283dfbf7a0cac3b040259ad.jpg" style="width: auto;"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：黄洲君</span><span>大小：5.06M</span><span> 时长：11:03</span></div></div><audio title="第16讲 | synchronized底层如何实现？什么是锁的升级、降级？" src="https://res001.geekbang.org/media/audio/95/de/954f1b49e90575183558eaca0a55c8de/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="6637" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="6638"><span data-slate-object="text" data-key="6639"><span data-slate-leaf="true" data-offset-key="6639:0" data-first-offset="true"><span data-slate-string="true">我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6640"><span data-slate-object="text" data-key="6641"><span data-slate-leaf="true" data-offset-key="6641:0" data-first-offset="true"><span data-slate-string="true">上一讲</span></span></span></a><span data-slate-object="text" data-key="6642"><span data-slate-leaf="true" data-offset-key="6642:0" data-first-offset="true"><span data-slate-string="true">对比和分析了 synchronized 和 ReentrantLock，算是专栏进入并发编程阶段的热身，相信你已经对线程安全，以及如何使用基本的同步机制有了基础，今天我们将深入了解 synchronize 底层机制，分析其他锁实现和应用场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6643"><span data-slate-object="text" data-key="6644"><span data-slate-leaf="true" data-offset-key="6644:0" data-first-offset="true"><span data-slate-string="true">今天我要问你的问题是 ，</span></span></span><span data-slate-object="text" data-key="6645"><span data-slate-leaf="true" data-offset-key="6645:0" data-first-offset="true"><span data-slate-type="primary" data-slate-object="mark"><span data-slate-string="true">synchronized 底层如何实现？什么是锁的升级、降级？</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6646" id="sr-toc-1"><span data-slate-object="text" data-key="6647"><span data-slate-leaf="true" data-offset-key="6647:0" data-first-offset="true"><span data-slate-string="true">典型回答</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6648"><span data-slate-object="text" data-key="6649"><span data-slate-leaf="true" data-offset-key="6649:0" data-first-offset="true"><span data-slate-string="true">在回答这个问题前，先简单复习一下上一讲的知识点。</span></span><span data-slate-leaf="true" data-offset-key="6649:1"><span data-slate-object="annotation" data-annotation-key="gkann_5c6eb494" data-attr-id="7337" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">synchronized 代码块是由一对儿 monitorenter/monitorexit 指令实现的，Monitor 对象是同步的基本实现</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6650"><span data-slate-object="text" data-key="6651"><span data-slate-leaf="true" data-offset-key="6651:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5c6eb494" data-attr-id="7337" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">单元</span></span></span></span></a><span data-slate-object="text" data-key="6652"><span data-slate-leaf="true" data-offset-key="6652:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5c6eb494" data-attr-id="7337" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6653"><span data-slate-object="text" data-key="6654"><span data-slate-leaf="true" data-offset-key="6654:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d656c76e" data-attr-id="7949" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在 Java 6 之前，Monitor 的实现完全是依靠操作系统内部的互斥锁，因为需要进行用户态到内核态的切换，所以同步操作是一个无差别的重量级操作。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6655"><span data-slate-object="text" data-key="6656"><span data-slate-leaf="true" data-offset-key="6656:0" data-first-offset="true"><span data-slate-string="true">现代的（Oracle）JDK 中，</span></span><span data-slate-leaf="true" data-offset-key="6656:1"><span data-slate-object="annotation" data-annotation-key="gkann_226e5964" data-attr-id="7950" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">JVM 对此进行了大刀阔斧地改进，提供了三种不同的 Monitor 实现，也就是常说的三种不同的锁：偏斜锁（Biased Locking）、轻量级锁和重量级锁，大大改进了其性能。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6657"><span data-slate-object="text" data-key="6658"><span data-slate-leaf="true" data-offset-key="6658:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d83e5d7b" data-attr-id="7951" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">所谓锁的升级、降级，就是 JVM 优化 synchronized 运行的机制，当 JVM 检测到不同的竞争状况时，会自动切换到适合的锁实现，这种切换就是锁的升级、降级。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6659"><span data-slate-object="text" data-key="6660"><span data-slate-leaf="true" data-offset-key="6660:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_715cf93f" data-attr-id="7952" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">当没有竞争出现时，默认会使用偏斜锁。JVM 会利用 CAS 操作（</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6661"><span data-slate-object="text" data-key="6662"><span data-slate-leaf="true" data-offset-key="6662:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_715cf93f" data-attr-id="7952" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">compare and swap</span></span></span></span></a><span data-slate-object="text" data-key="6663"><span data-slate-leaf="true" data-offset-key="6663:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_715cf93f" data-attr-id="7952" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">），在对象头上的 Mark Word 部分设置线程 ID，以表示这个对象偏向于当前线程，所以并不涉及真正的互斥锁。这样做的假设是基于在很多应用场景中，大部分对象生命周期中最多会被一个线程锁定，使用偏斜锁可以降低无竞争开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6664"><span data-slate-object="text" data-key="6665"><span data-slate-leaf="true" data-offset-key="6665:0" data-first-offset="true"><span data-slate-string="true">如果有另外的线程试图锁定某个已经被偏斜过的对象，JVM 就需要撤销（revoke）偏斜锁，并切换到轻量级锁实现。</span></span><span data-slate-leaf="true" data-offset-key="6665:1"><span data-slate-object="annotation" data-annotation-key="gkann_8b342441" data-attr-id="5403" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">轻量级锁依赖 CAS 操作 Mark Word 来试图获取锁，如果重试成功，就使用普通的轻量级锁；否则，进一步升级为重量级锁。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6666"><span data-slate-object="text" data-key="6667"><span data-slate-leaf="true" data-offset-key="6667:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_46ab9b45" data-attr-id="7953" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我注意到有的观点认为 Java 不会进行锁降级。实际上据我所知，锁降级确实是会发生的，当 JVM 进入安全点（</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6668"><span data-slate-object="text" data-key="6669"><span data-slate-leaf="true" data-offset-key="6669:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_46ab9b45" data-attr-id="7953" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">SafePoint</span></span></span></span></a><span data-slate-object="text" data-key="6670"><span data-slate-leaf="true" data-offset-key="6670:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_46ab9b45" data-attr-id="7953" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">）的时候，会检查是否有闲置的 Monitor，然后试图进行降级。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6671" id="sr-toc-2"><span data-slate-object="text" data-key="6672"><span data-slate-leaf="true" data-offset-key="6672:0" data-first-offset="true"><span data-slate-string="true">考点分析</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6673"><span data-slate-object="text" data-key="6674"><span data-slate-leaf="true" data-offset-key="6674:0" data-first-offset="true"><span data-slate-string="true">今天的问题主要是考察你对 Java 内置锁实现的掌握，也是并发的经典题目。我在前面给出的典型回答，涵盖了一些基本概念。如果基础不牢，有些概念理解起来就比较晦涩，我建议还是尽量理解和掌握，即使有不懂的也不用担心，在后续学习中还会逐步加深认识。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6675"><span data-slate-object="text" data-key="6676"><span data-slate-leaf="true" data-offset-key="6676:0" data-first-offset="true"><span data-slate-string="true">我个人认为，能够基础性地理解这些概念和机制，其实对于大多数并发编程已经足够了，毕竟大部分工程师未必会进行更底层、更基础的研发，很多时候解决的是知道与否，真正的提高还要靠实践踩坑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6677"><span data-slate-object="text" data-key="6678"><span data-slate-leaf="true" data-offset-key="6678:0" data-first-offset="true"><span data-slate-string="true">后面我会进一步分析：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6679"><div data-slate-type="list-line" data-slate-object="block" data-key="6680"><span data-slate-object="text" data-key="6681"><span data-slate-leaf="true" data-offset-key="6681:0" data-first-offset="true"><span data-slate-string="true">从源码层面，稍微展开一些 synchronized 的底层实现，并补充一些上面答案中欠缺的细节，有同学反馈这部分容易被问到。如果你对 Java 底层源码有兴趣，但还没有找到入手点，这里可以成为一个切入点。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6682"><span data-slate-object="text" data-key="6683"><span data-slate-leaf="true" data-offset-key="6683:0" data-first-offset="true"><span data-slate-string="true">理解并发包中 java.util.concurrent.lock 提供的其他锁实现，毕竟 Java 可不是只有 ReentrantLock 一种显式的锁类型，我会结合代码分析其使用。</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6684" id="sr-toc-3"><span data-slate-object="text" data-key="6685"><span data-slate-leaf="true" data-offset-key="6685:0" data-first-offset="true"><span data-slate-string="true">知识扩展</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6686"><span data-slate-object="text" data-key="6687"><span data-slate-leaf="true" data-offset-key="6687:0" data-first-offset="true"><span data-slate-string="true">我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6688"><span data-slate-object="text" data-key="6689"><span data-slate-leaf="true" data-offset-key="6689:0" data-first-offset="true"><span data-slate-string="true">上一讲</span></span></span></a><span data-slate-object="text" data-key="6690"><span data-slate-leaf="true" data-offset-key="6690:0" data-first-offset="true"><span data-slate-string="true">提到过 synchronized 是 JVM 内部的 Intrinsic Lock，所以偏斜锁、轻量级锁、重量级锁的代码实现，并不在核心类库部分，而是在 JVM 的代码中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6691"><span data-slate-object="text" data-key="6692"><span data-slate-leaf="true" data-offset-key="6692:0" data-first-offset="true"><span data-slate-string="true">Java 代码运行可能是解释模式也可能是编译模式（如果不记得，请复习</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6693"><span data-slate-object="text" data-key="6694"><span data-slate-leaf="true" data-offset-key="6694:0" data-first-offset="true"><span data-slate-string="true">专栏第 1 讲</span></span></span></a><span data-slate-object="text" data-key="6695"><span data-slate-leaf="true" data-offset-key="6695:0" data-first-offset="true"><span data-slate-string="true">），所以对应的同步逻辑实现，也会分散在不同模块下，比如，解释器版本就是：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6696"><a data-slate-type="link" data-slate-object="inline" data-key="6697"><span data-slate-object="text" data-key="6698"><span data-slate-leaf="true" data-offset-key="6698:0" data-first-offset="true"><span data-slate-string="true">src/hotspot/share/interpreter/interpreterRuntime.cpp</span></span></span></a></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6699"><span data-slate-object="text" data-key="6700"><span data-slate-leaf="true" data-offset-key="6700:0" data-first-offset="true"><span data-slate-string="true">为了简化便于理解，我这里会专注于通用的基类实现：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6701"><a data-slate-type="link" data-slate-object="inline" data-key="6702"><span data-slate-object="text" data-key="6703"><span data-slate-leaf="true" data-offset-key="6703:0" data-first-offset="true"><span data-slate-string="true">src/hotspot/share/runtime/</span></span></span></a></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6704"><span data-slate-object="text" data-key="6705"><span data-slate-leaf="true" data-offset-key="6705:0" data-first-offset="true"><span data-slate-string="true">另外请注意，链接指向的是最新 JDK 代码库，所以可能某些实现与历史版本有所不同。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6706"><span data-slate-object="text" data-key="6707"><span data-slate-leaf="true" data-offset-key="6707:0" data-first-offset="true"><span data-slate-string="true">首先，synchronized 的行为是 JVM runtime 的一部分，所以我们需要先找到 Runtime 相关的功能实现。通过在代码中查询类似 “monitor_enter” 或 “Monitor Enter”，很直观的就可以定位到：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6708"><div data-slate-type="list-line" data-slate-object="block" data-key="6709"><a data-slate-type="link" data-slate-object="inline" data-key="6710"><span data-slate-object="text" data-key="6711"><span data-slate-leaf="true" data-offset-key="6711:0" data-first-offset="true"><span data-slate-string="true">sharedRuntime.cpp</span></span></span></a><span data-slate-object="text" data-key="6712"><span data-slate-leaf="true" data-offset-key="6712:0" data-first-offset="true"><span data-slate-string="true">/hpp，它是解释器和编译器运行时的基类。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6713"><a data-slate-type="link" data-slate-object="inline" data-key="6714"><span data-slate-object="text" data-key="6715"><span data-slate-leaf="true" data-offset-key="6715:0" data-first-offset="true"><span data-slate-string="true">synchronizer.cpp</span></span></span></a><span data-slate-object="text" data-key="6716"><span data-slate-leaf="true" data-offset-key="6716:0" data-first-offset="true"><span data-slate-string="true">/hpp，JVM 同步相关的各种基础逻辑。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6717"><span data-slate-object="text" data-key="6718"><span data-slate-leaf="true" data-offset-key="6718:0" data-first-offset="true"><span data-slate-string="true">在 sharedRuntime.cpp 中，下面代码体现了 synchronized 的主要逻辑。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="6719"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6720"><span data-slate-object="text" data-key="6721"><span data-slate-leaf="true" data-offset-key="6721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Handle </span></span></span></span><span data-slate-object="text" data-key="6722"><span data-slate-leaf="true" data-offset-key="6722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">h_obj</span></span></span></span></span><span data-slate-object="text" data-key="6723"><span data-slate-leaf="true" data-offset-key="6723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(THREAD, obj)</span></span></span></span></span><span data-slate-object="text" data-key="6724"><span data-slate-leaf="true" data-offset-key="6724:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6725"><span data-slate-object="text" data-key="6726"><span data-slate-leaf="true" data-offset-key="6726:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6727"><span data-slate-leaf="true" data-offset-key="6727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6728"><span data-slate-leaf="true" data-offset-key="6728:0" data-first-offset="true"><span data-slate-string="true"> (UseBiasedLocking) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6729"><span data-slate-object="text" data-key="6730"><span data-slate-leaf="true" data-offset-key="6730:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6731"><span data-slate-leaf="true" data-offset-key="6731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Retry fast entry if bias is revoked to avoid unnecessary inflation</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6732"><span data-slate-object="text" data-key="6733"><span data-slate-leaf="true" data-offset-key="6733:0" data-first-offset="true"><span data-slate-string="true">    ObjectSynchronizer::</span></span></span><span data-slate-object="text" data-key="6734"><span data-slate-leaf="true" data-offset-key="6734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fast_enter</span></span></span></span><span data-slate-object="text" data-key="6735"><span data-slate-leaf="true" data-offset-key="6735:0" data-first-offset="true"><span data-slate-string="true">(h_obj, lock, </span></span></span><span data-slate-object="text" data-key="6736"><span data-slate-leaf="true" data-offset-key="6736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="6737"><span data-slate-leaf="true" data-offset-key="6737:0" data-first-offset="true"><span data-slate-string="true">, CHECK);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6738"><span data-slate-object="text" data-key="6739"><span data-slate-leaf="true" data-offset-key="6739:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="6740"><span data-slate-leaf="true" data-offset-key="6740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="6741"><span data-slate-leaf="true" data-offset-key="6741:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6742"><span data-slate-object="text" data-key="6743"><span data-slate-leaf="true" data-offset-key="6743:0" data-first-offset="true"><span data-slate-string="true">    ObjectSynchronizer::</span></span></span><span data-slate-object="text" data-key="6744"><span data-slate-leaf="true" data-offset-key="6744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">slow_enter</span></span></span></span><span data-slate-object="text" data-key="6745"><span data-slate-leaf="true" data-offset-key="6745:0" data-first-offset="true"><span data-slate-string="true">(h_obj, lock, CHECK);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6746"><span data-slate-object="text" data-key="6747"><span data-slate-leaf="true" data-offset-key="6747:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6748"><span data-slate-object="text" data-key="6749"><span data-slate-leaf="true" data-offset-key="6749:0" data-first-offset="true"><span data-slate-string="true">其实现可以简单进行分解：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6750"><div data-slate-type="list-line" data-slate-object="block" data-key="6751"><span data-slate-object="text" data-key="6752"><span data-slate-leaf="true" data-offset-key="6752:0" data-first-offset="true"><span data-slate-string="true">UseBiasedLocking 是一个检查，因为，在 JVM 启动时，我们可以指定是否开启偏斜锁。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6753"><span data-slate-object="text" data-key="6754"><span data-slate-leaf="true" data-offset-key="6754:0" data-first-offset="true"><span data-slate-string="true">偏斜锁并不适合所有应用场景，</span></span><span data-slate-leaf="true" data-offset-key="6754:1"><span data-slate-object="annotation" data-annotation-key="gkann_1f38ba71" data-attr-id="27726" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">撤销操作（revoke）是比较重的行为，</span></span></span><span data-slate-leaf="true" data-offset-key="6754:2"><span data-slate-string="true">只有当存在较多不会真正竞争的 synchronized 块儿时，才能体现出明显改善。实践中对于偏斜锁的一直是有争议的，有人甚至认为，当你需要大量使用并发类库时，往往意味着你不需要偏斜锁。从具体选择来看，我还是建议需要在实践中进行测试，根据结果再决定是否使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6755"><span data-slate-object="text" data-key="6756"><span data-slate-leaf="true" data-offset-key="6756:0" data-first-offset="true"><span data-slate-string="true">还有一方面是，偏斜锁会延缓 JIT 预热的进程，所以很多性能测试中会显式地关闭偏斜锁，命令如下：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="6757"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6758"><span data-slate-object="text" data-key="6759"><span data-slate-leaf="true" data-offset-key="6759:0" data-first-offset="true"><span data-slate-string="true">-XX:-UseBiasedLocking</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6760"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="6761"><div data-slate-type="list-line" data-slate-object="block" data-key="6762"><span data-slate-object="text" data-key="6763"><span data-slate-leaf="true" data-offset-key="6763:0" data-first-offset="true"><span data-slate-string="true">fast_enter 是我们熟悉的完整锁获取路径，slow_enter 则是绕过偏斜锁，直接进入轻量级锁获取逻辑。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6764"><span data-slate-object="text" data-key="6765"><span data-slate-leaf="true" data-offset-key="6765:0" data-first-offset="true"><span data-slate-string="true">那么 fast_enter 是如何实现的呢？同样是通过在代码库搜索，我们可以定位到 synchronizer.cpp。 类似 fast_enter 这种实现，解释器或者动态编译器，都是拷贝这段基础逻辑，所以如果我们修改这部分逻辑，要保证一致性。这部分代码是非常敏感的，微小的问题都可能导致死锁或者正确性问题。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="6766"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6767"><span data-slate-object="text" data-key="6768"><span data-slate-leaf="true" data-offset-key="6768:0" data-first-offset="true"><span data-slate-string="true">void ObjectSynchronizer::</span></span></span><span data-slate-object="text" data-key="6769"><span data-slate-leaf="true" data-offset-key="6769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fast_enter</span></span></span></span><span data-slate-object="text" data-key="6770"><span data-slate-leaf="true" data-offset-key="6770:0" data-first-offset="true"><span data-slate-string="true">(Handle obj, BasicLock* lock,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6771"><span data-slate-object="text" data-key="6772"><span data-slate-leaf="true" data-offset-key="6772:0" data-first-offset="true"><span data-slate-string="true">                                  </span></span></span><span data-slate-object="text" data-key="6773"><span data-slate-leaf="true" data-offset-key="6773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="6774"><span data-slate-leaf="true" data-offset-key="6774:0" data-first-offset="true"><span data-slate-string="true"> attempt_rebias, TRAPS) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6775"><span data-slate-object="text" data-key="6776"><span data-slate-leaf="true" data-offset-key="6776:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6777"><span data-slate-leaf="true" data-offset-key="6777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6778"><span data-slate-leaf="true" data-offset-key="6778:0" data-first-offset="true"><span data-slate-string="true"> (UseBiasedLocking) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6779"><span data-slate-object="text" data-key="6780"><span data-slate-leaf="true" data-offset-key="6780:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6781"><span data-slate-leaf="true" data-offset-key="6781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6782"><span data-slate-leaf="true" data-offset-key="6782:0" data-first-offset="true"><span data-slate-string="true"> (!SafepointSynchronize::</span></span></span><span data-slate-object="text" data-key="6783"><span data-slate-leaf="true" data-offset-key="6783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is_at_safepoint</span></span></span></span><span data-slate-object="text" data-key="6784"><span data-slate-leaf="true" data-offset-key="6784:0" data-first-offset="true"><span data-slate-string="true">()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6785"><span data-slate-object="text" data-key="6786"><span data-slate-leaf="true" data-offset-key="6786:0" data-first-offset="true"><span data-slate-string="true">      BiasedLocking::Condition cond = BiasedLocking::</span></span></span><span data-slate-object="text" data-key="6787"><span data-slate-leaf="true" data-offset-key="6787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">revoke_and_rebias</span></span></span></span><span data-slate-object="text" data-key="6788"><span data-slate-leaf="true" data-offset-key="6788:0" data-first-offset="true"><span data-slate-string="true">(obj, attempt_rebias, THREAD);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6789"><span data-slate-object="text" data-key="6790"><span data-slate-leaf="true" data-offset-key="6790:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6791"><span data-slate-leaf="true" data-offset-key="6791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6792"><span data-slate-leaf="true" data-offset-key="6792:0" data-first-offset="true"><span data-slate-string="true"> (cond == BiasedLocking::BIAS_REVOKED_AND_REBIASED) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6793"><span data-slate-object="text" data-key="6794"><span data-slate-leaf="true" data-offset-key="6794:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6795"><span data-slate-leaf="true" data-offset-key="6795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6796"><span data-slate-leaf="true" data-offset-key="6796:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6797"><span data-slate-object="text" data-key="6798"><span data-slate-leaf="true" data-offset-key="6798:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6799"><span data-slate-object="text" data-key="6800"><span data-slate-leaf="true" data-offset-key="6800:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="6801"><span data-slate-leaf="true" data-offset-key="6801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="6802"><span data-slate-leaf="true" data-offset-key="6802:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6803"><span data-slate-object="text" data-key="6804"><span data-slate-leaf="true" data-offset-key="6804:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6805"><span data-slate-leaf="true" data-offset-key="6805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">assert</span></span></span></span><span data-slate-object="text" data-key="6806"><span data-slate-leaf="true" data-offset-key="6806:0" data-first-offset="true"><span data-slate-string="true">(!attempt_rebias, </span></span></span><span data-slate-object="text" data-key="6807"><span data-slate-leaf="true" data-offset-key="6807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"can not rebias toward VM thread"</span></span></span></span><span data-slate-object="text" data-key="6808"><span data-slate-leaf="true" data-offset-key="6808:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6809"><span data-slate-object="text" data-key="6810"><span data-slate-leaf="true" data-offset-key="6810:0" data-first-offset="true"><span data-slate-string="true">      BiasedLocking::</span></span></span><span data-slate-object="text" data-key="6811"><span data-slate-leaf="true" data-offset-key="6811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">revoke_at_safepoint</span></span></span></span><span data-slate-object="text" data-key="6812"><span data-slate-leaf="true" data-offset-key="6812:0" data-first-offset="true"><span data-slate-string="true">(obj);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6813"><span data-slate-object="text" data-key="6814"><span data-slate-leaf="true" data-offset-key="6814:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6815"><span data-slate-object="text" data-key="6816"><span data-slate-leaf="true" data-offset-key="6816:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6817"><span data-slate-leaf="true" data-offset-key="6817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">assert</span></span></span></span><span data-slate-object="text" data-key="6818"><span data-slate-leaf="true" data-offset-key="6818:0" data-first-offset="true"><span data-slate-string="true">(!obj</span></span></span><span data-slate-object="text" data-key="6819"><span data-slate-leaf="true" data-offset-key="6819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6820"><span data-slate-leaf="true" data-offset-key="6820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mark</span></span></span></span><span data-slate-object="text" data-key="6821"><span data-slate-leaf="true" data-offset-key="6821:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span><span data-slate-object="text" data-key="6822"><span data-slate-leaf="true" data-offset-key="6822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6823"><span data-slate-leaf="true" data-offset-key="6823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">has_bias_pattern</span></span></span></span><span data-slate-object="text" data-key="6824"><span data-slate-leaf="true" data-offset-key="6824:0" data-first-offset="true"><span data-slate-string="true">(), </span></span></span><span data-slate-object="text" data-key="6825"><span data-slate-leaf="true" data-offset-key="6825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"biases should be revoked by now"</span></span></span></span><span data-slate-object="text" data-key="6826"><span data-slate-leaf="true" data-offset-key="6826:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6827"><span data-slate-object="text" data-key="6828"><span data-slate-leaf="true" data-offset-key="6828:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6829"><span data-slate-object="text" data-key="6830"><span data-slate-leaf="true" data-offset-key="6830:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6831"><span data-slate-object="text" data-key="6832"><span data-slate-leaf="true" data-offset-key="6832:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6833"><span data-slate-leaf="true" data-offset-key="6833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">slow_enter</span></span></span></span><span data-slate-object="text" data-key="6834"><span data-slate-leaf="true" data-offset-key="6834:0" data-first-offset="true"><span data-slate-string="true">(obj, lock, THREAD);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6835"><span data-slate-object="text" data-key="6836"><span data-slate-leaf="true" data-offset-key="6836:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6837"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6838"><span data-slate-object="text" data-key="6839"><span data-slate-leaf="true" data-offset-key="6839:0" data-first-offset="true"><span data-slate-string="true">我来分析下这段逻辑实现：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6840"><div data-slate-type="list-line" data-slate-object="block" data-key="6841"><a data-slate-type="link" data-slate-object="inline" data-key="6842"><span data-slate-object="text" data-key="6843"><span data-slate-leaf="true" data-offset-key="6843:0" data-first-offset="true"><span data-slate-string="true">biasedLocking</span></span></span></a><span data-slate-object="text" data-key="6844"><span data-slate-leaf="true" data-offset-key="6844:0" data-first-offset="true"><span data-slate-string="true"> 定义了偏斜锁相关操作，revoke_and_rebias 是获取偏斜锁的入口方法，revoke_at_safepoint 则定义了当检测到安全点时的处理逻辑。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6845"><span data-slate-object="text" data-key="6846"><span data-slate-leaf="true" data-offset-key="6846:0" data-first-offset="true"><span data-slate-string="true">如果获取偏斜锁失败，则进入 slow_enter。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6847"><span data-slate-object="text" data-key="6848"><span data-slate-leaf="true" data-offset-key="6848:0" data-first-offset="true"><span data-slate-string="true">这个方法里面同样检查是否开启了偏斜锁，但是从代码路径来看，其实如果关闭了偏斜锁，是不会进入这个方法的，所以算是个额外的保障性检查吧。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6849"><span data-slate-object="text" data-key="6850"><span data-slate-leaf="true" data-offset-key="6850:0" data-first-offset="true"><span data-slate-string="true">另外，如果你仔细查看 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6851"><span data-slate-object="text" data-key="6852"><span data-slate-leaf="true" data-offset-key="6852:0" data-first-offset="true"><span data-slate-string="true">synchronizer.cpp</span></span></span></a><span data-slate-object="text" data-key="6853"><span data-slate-leaf="true" data-offset-key="6853:0" data-first-offset="true"><span data-slate-string="true"> 里，会发现不仅仅是 synchronized 的逻辑，包括从本地代码，也就是 JNI，触发的 Monitor 动作，全都可以在里面找到（jni_enter/jni_exit）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6854"><span data-slate-object="text" data-key="6855"><span data-slate-leaf="true" data-offset-key="6855:0" data-first-offset="true"><span data-slate-string="true">关于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6856"><span data-slate-object="text" data-key="6857"><span data-slate-leaf="true" data-offset-key="6857:0" data-first-offset="true"><span data-slate-string="true">biasedLocking</span></span></span></a><span data-slate-object="text" data-key="6858"><span data-slate-leaf="true" data-offset-key="6858:0" data-first-offset="true"><span data-slate-string="true"> 的更多细节我就不展开了，明白它是通过 CAS 设置 Mark Word 就完全够用了，对象头中 Mark Word 的结构，可以参考下图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6859"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/b1/fc/b1221c308d2aaf13d0d677033ee406fc.png?wh=1005*314"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6860"><span data-slate-object="text" data-key="6861"><span data-slate-leaf="true" data-offset-key="6861:0" data-first-offset="true"><span data-slate-string="true">顺着锁升降级的过程分析下去，偏斜锁到轻量级锁的过程是如何实现的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6862"><span data-slate-object="text" data-key="6863"><span data-slate-leaf="true" data-offset-key="6863:0" data-first-offset="true"><span data-slate-string="true">我们来看看 slow_enter 到底做了什么。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="6864"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6865"><span data-slate-object="text" data-key="6866"><span data-slate-leaf="true" data-offset-key="6866:0" data-first-offset="true"><span data-slate-string="true">void ObjectSynchronizer::</span></span></span><span data-slate-object="text" data-key="6867"><span data-slate-leaf="true" data-offset-key="6867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">slow_enter</span></span></span></span><span data-slate-object="text" data-key="6868"><span data-slate-leaf="true" data-offset-key="6868:0" data-first-offset="true"><span data-slate-string="true">(Handle obj, BasicLock* lock, TRAPS) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6869"><span data-slate-object="text" data-key="6870"><span data-slate-leaf="true" data-offset-key="6870:0" data-first-offset="true"><span data-slate-string="true">  markOop mark = obj</span></span></span><span data-slate-object="text" data-key="6871"><span data-slate-leaf="true" data-offset-key="6871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6872"><span data-slate-leaf="true" data-offset-key="6872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mark</span></span></span></span><span data-slate-object="text" data-key="6873"><span data-slate-leaf="true" data-offset-key="6873:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6874"><span data-slate-object="text" data-key="6875"><span data-slate-leaf="true" data-offset-key="6875:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6876"><span data-slate-leaf="true" data-offset-key="6876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6877"><span data-slate-leaf="true" data-offset-key="6877:0" data-first-offset="true"><span data-slate-string="true"> (mark</span></span></span><span data-slate-object="text" data-key="6878"><span data-slate-leaf="true" data-offset-key="6878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6879"><span data-slate-leaf="true" data-offset-key="6879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is_neutral</span></span></span></span><span data-slate-object="text" data-key="6880"><span data-slate-leaf="true" data-offset-key="6880:0" data-first-offset="true"><span data-slate-string="true">()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6881"><span data-slate-object="text" data-key="6882"><span data-slate-leaf="true" data-offset-key="6882:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="6883"><span data-slate-leaf="true" data-offset-key="6883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将目前的 Mark Word 复制到 Displaced Header 上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6884"><span data-slate-object="text" data-key="6885"><span data-slate-leaf="true" data-offset-key="6885:0" data-first-offset="true"><span data-slate-string="true">  lock</span></span></span><span data-slate-object="text" data-key="6886"><span data-slate-leaf="true" data-offset-key="6886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6887"><span data-slate-leaf="true" data-offset-key="6887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_displaced_header</span></span></span></span><span data-slate-object="text" data-key="6888"><span data-slate-leaf="true" data-offset-key="6888:0" data-first-offset="true"><span data-slate-string="true">(mark);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6889"><span data-slate-object="text" data-key="6890"><span data-slate-leaf="true" data-offset-key="6890:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6891"><span data-slate-leaf="true" data-offset-key="6891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 利用 CAS 设置对象的 Mark Word</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6892"><span data-slate-object="text" data-key="6893"><span data-slate-leaf="true" data-offset-key="6893:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6894"><span data-slate-leaf="true" data-offset-key="6894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6895"><span data-slate-leaf="true" data-offset-key="6895:0" data-first-offset="true"><span data-slate-string="true"> (mark == </span></span></span><span data-slate-object="text" data-key="6896"><span data-slate-leaf="true" data-offset-key="6896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">obj</span></span></span></span><span data-slate-object="text" data-key="6897"><span data-slate-leaf="true" data-offset-key="6897:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span><span data-slate-object="text" data-key="6898"><span data-slate-leaf="true" data-offset-key="6898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6899"><span data-slate-leaf="true" data-offset-key="6899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cas_set_mark</span></span></span></span><span data-slate-object="text" data-key="6900"><span data-slate-leaf="true" data-offset-key="6900:0" data-first-offset="true"><span data-slate-string="true">((markOop) lock, mark)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6901"><span data-slate-object="text" data-key="6902"><span data-slate-leaf="true" data-offset-key="6902:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6903"><span data-slate-leaf="true" data-offset-key="6903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TEVENT</span></span></span></span><span data-slate-object="text" data-key="6904"><span data-slate-leaf="true" data-offset-key="6904:0" data-first-offset="true"><span data-slate-string="true">(slow_enter: release stacklock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6905"><span data-slate-object="text" data-key="6906"><span data-slate-leaf="true" data-offset-key="6906:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6907"><span data-slate-leaf="true" data-offset-key="6907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6908"><span data-slate-leaf="true" data-offset-key="6908:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6909"><span data-slate-object="text" data-key="6910"><span data-slate-leaf="true" data-offset-key="6910:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6911"><span data-slate-object="text" data-key="6912"><span data-slate-leaf="true" data-offset-key="6912:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6913"><span data-slate-leaf="true" data-offset-key="6913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查存在竞争</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6914"><span data-slate-object="text" data-key="6915"><span data-slate-leaf="true" data-offset-key="6915:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="6916"><span data-slate-leaf="true" data-offset-key="6916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="6917"><span data-slate-leaf="true" data-offset-key="6917:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6918"><span data-slate-leaf="true" data-offset-key="6918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6919"><span data-slate-leaf="true" data-offset-key="6919:0" data-first-offset="true"><span data-slate-string="true"> (mark</span></span></span><span data-slate-object="text" data-key="6920"><span data-slate-leaf="true" data-offset-key="6920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6921"><span data-slate-leaf="true" data-offset-key="6921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">has_locker</span></span></span></span><span data-slate-object="text" data-key="6922"><span data-slate-leaf="true" data-offset-key="6922:0" data-first-offset="true"><span data-slate-string="true">() &amp;&amp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6923"><span data-slate-object="text" data-key="6924"><span data-slate-leaf="true" data-offset-key="6924:0" data-first-offset="true"><span data-slate-string="true">             THREAD</span></span></span><span data-slate-object="text" data-key="6925"><span data-slate-leaf="true" data-offset-key="6925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6926"><span data-slate-leaf="true" data-offset-key="6926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is_lock_owned</span></span></span></span><span data-slate-object="text" data-key="6927"><span data-slate-leaf="true" data-offset-key="6927:0" data-first-offset="true"><span data-slate-string="true">((address)mark</span></span></span><span data-slate-object="text" data-key="6928"><span data-slate-leaf="true" data-offset-key="6928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6929"><span data-slate-leaf="true" data-offset-key="6929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">locker</span></span></span></span><span data-slate-object="text" data-key="6930"><span data-slate-leaf="true" data-offset-key="6930:0" data-first-offset="true"><span data-slate-string="true">())) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6931"><span data-slate-object="text" data-key="6932"><span data-slate-leaf="true" data-offset-key="6932:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6933"><span data-slate-leaf="true" data-offset-key="6933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6934"><span data-slate-object="text" data-key="6935"><span data-slate-leaf="true" data-offset-key="6935:0" data-first-offset="true"><span data-slate-string="true">    lock</span></span></span><span data-slate-object="text" data-key="6936"><span data-slate-leaf="true" data-offset-key="6936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6937"><span data-slate-leaf="true" data-offset-key="6937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_displaced_header</span></span></span></span><span data-slate-object="text" data-key="6938"><span data-slate-leaf="true" data-offset-key="6938:0" data-first-offset="true"><span data-slate-string="true">(NULL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6939"><span data-slate-object="text" data-key="6940"><span data-slate-leaf="true" data-offset-key="6940:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6941"><span data-slate-leaf="true" data-offset-key="6941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6942"><span data-slate-leaf="true" data-offset-key="6942:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6943"><span data-slate-object="text" data-key="6944"><span data-slate-leaf="true" data-offset-key="6944:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6945"><span data-slate-object="text" data-key="6946"><span data-slate-leaf="true" data-offset-key="6946:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6947"><span data-slate-object="text" data-key="6948"><span data-slate-leaf="true" data-offset-key="6948:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6949"><span data-slate-leaf="true" data-offset-key="6949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 重置 Displaced Header</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6950"><span data-slate-object="text" data-key="6951"><span data-slate-leaf="true" data-offset-key="6951:0" data-first-offset="true"><span data-slate-string="true">  lock</span></span></span><span data-slate-object="text" data-key="6952"><span data-slate-leaf="true" data-offset-key="6952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6953"><span data-slate-leaf="true" data-offset-key="6953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_displaced_header</span></span></span></span><span data-slate-object="text" data-key="6954"><span data-slate-leaf="true" data-offset-key="6954:0" data-first-offset="true"><span data-slate-string="true">(markOopDesc::</span></span></span><span data-slate-object="text" data-key="6955"><span data-slate-leaf="true" data-offset-key="6955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unused_mark</span></span></span></span><span data-slate-object="text" data-key="6956"><span data-slate-leaf="true" data-offset-key="6956:0" data-first-offset="true"><span data-slate-string="true">());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6957"><span data-slate-object="text" data-key="6958"><span data-slate-leaf="true" data-offset-key="6958:0" data-first-offset="true"><span data-slate-string="true">  ObjectSynchronizer::</span></span></span><span data-slate-object="text" data-key="6959"><span data-slate-leaf="true" data-offset-key="6959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inflate</span></span></span></span><span data-slate-object="text" data-key="6960"><span data-slate-leaf="true" data-offset-key="6960:0" data-first-offset="true"><span data-slate-string="true">(THREAD,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6961"><span data-slate-object="text" data-key="6962"><span data-slate-leaf="true" data-offset-key="6962:0" data-first-offset="true"><span data-slate-string="true">                            </span></span></span><span data-slate-object="text" data-key="6963"><span data-slate-leaf="true" data-offset-key="6963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">obj</span></span></span></span><span data-slate-object="text" data-key="6964"><span data-slate-leaf="true" data-offset-key="6964:0" data-first-offset="true"><span data-slate-string="true">(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6965"><span data-slate-object="text" data-key="6966"><span data-slate-leaf="true" data-offset-key="6966:0" data-first-offset="true"><span data-slate-string="true">                              inflate_cause_monitor_enter)</span></span></span><span data-slate-object="text" data-key="6967"><span data-slate-leaf="true" data-offset-key="6967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6968"><span data-slate-leaf="true" data-offset-key="6968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">enter</span></span></span></span><span data-slate-object="text" data-key="6969"><span data-slate-leaf="true" data-offset-key="6969:0" data-first-offset="true"><span data-slate-string="true">(THREAD);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6970"><span data-slate-object="text" data-key="6971"><span data-slate-leaf="true" data-offset-key="6971:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6972"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6973"><span data-slate-object="text" data-key="6974"><span data-slate-leaf="true" data-offset-key="6974:0" data-first-offset="true"><span data-slate-string="true">请结合我在代码中添加的注释，来理解如何从试图获取轻量级锁，逐步进入锁膨胀的过程。你可以发现这个处理逻辑，和我在这一讲最初介绍的过程是十分吻合的。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6975"><div data-slate-type="list-line" data-slate-object="block" data-key="6976"><span data-slate-object="text" data-key="6977"><span data-slate-leaf="true" data-offset-key="6977:0" data-first-offset="true"><span data-slate-string="true">设置 Displaced Header，然后利用 cas_set_mark 设置对象 Mark Word，如果成功就成功获取轻量级锁。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6978"><span data-slate-object="text" data-key="6979"><span data-slate-leaf="true" data-offset-key="6979:0" data-first-offset="true"><span data-slate-string="true">否则 Displaced Header，然后进入锁膨胀阶段，具体实现在 inflate 方法中。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6980"><span data-slate-object="text" data-key="6981"><span data-slate-leaf="true" data-offset-key="6981:0" data-first-offset="true"><span data-slate-string="true">今天就不介绍膨胀的细节了，我这里提供了源代码分析的思路和样例，考虑到应用实践，再进一步增加源代码解读意义不大，有兴趣的同学可以参考我提供的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6982"><span data-slate-object="text" data-key="6983"><span data-slate-leaf="true" data-offset-key="6983:0" data-first-offset="true"><span data-slate-string="true">synchronizer.cpp</span></span></span></a><span data-slate-object="text" data-key="6984"><span data-slate-leaf="true" data-offset-key="6984:0" data-first-offset="true"><span data-slate-string="true"> 链接，例如：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6985"><div data-slate-type="list-line" data-slate-object="block" data-key="6986"><span data-slate-object="text" data-key="6987"><span data-slate-leaf="true" data-offset-key="6987:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">deflate_idle_monitors</span></span></span></span><span data-slate-object="text" data-key="6988"><span data-slate-leaf="true" data-offset-key="6988:0" data-first-offset="true"><span data-slate-string="true"> 是分析</span></span></span><span data-slate-object="text" data-key="6989"><span data-slate-leaf="true" data-offset-key="6989:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">锁降级</span></span></span></span><span data-slate-object="text" data-key="6990"><span data-slate-leaf="true" data-offset-key="6990:0" data-first-offset="true"><span data-slate-string="true">逻辑的入口，这部分行为还在进行持续改进，因为其逻辑是在安全点内运行，处理不当可能拖长 JVM 停顿（STW，stop-the-world）的时间。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6991"><span data-slate-object="text" data-key="6992"><span data-slate-leaf="true" data-offset-key="6992:0" data-first-offset="true"><span data-slate-string="true">fast_exit 或者 slow_exit 是对应的锁释放逻辑。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6993"><span data-slate-object="text" data-key="6994"><span data-slate-leaf="true" data-offset-key="6994:0" data-first-offset="true"><span data-slate-string="true">前面分析了 synchronized 的底层实现，理解起来有一定难度，下面我们来看一些相对轻松的内容。 我在上一讲对比了 synchronized 和 ReentrantLock，Java 核心类库中还有其他一些特别的锁类型，具体请参考下面的图。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6995"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/f5/11/f5753a4695fd771f8178120858086811.png?wh=751*310"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6996"><span data-slate-object="text" data-key="6997"><span data-slate-leaf="true" data-offset-key="6997:0" data-first-offset="true"><span data-slate-string="true">你可能注意到了，这些锁竟然不都是实现了 Lock 接口，ReadWriteLock 是一个单独的接口，它通常是代表了一对儿锁，分别对应只读和写操作，标准类库中提供了再入版本的读写锁实现（ReentrantReadWriteLock），对应的语义和 ReentrantLock 比较相似。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6998"><span data-slate-object="text" data-key="6999"><span data-slate-leaf="true" data-offset-key="6999:0" data-first-offset="true"><span data-slate-string="true">StampedLock 竟然也是个单独的类型，从类图结构可以看出它是不支持再入性的语义的，也就是它不是以持有锁的线程为单位。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7000"><span data-slate-object="text" data-key="7001"><span data-slate-leaf="true" data-offset-key="7001:0" data-first-offset="true"><span data-slate-string="true">为什么我们需要读写锁（ReadWriteLock）等其他锁呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7002"><span data-slate-object="text" data-key="7003"><span data-slate-leaf="true" data-offset-key="7003:0" data-first-offset="true"><span data-slate-string="true">这是因为，</span></span><span data-slate-leaf="true" data-offset-key="7003:1"><span data-slate-object="annotation" data-annotation-key="gkann_bb5d1dbb" data-attr-id="22389" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">虽然 ReentrantLock 和 synchronized 简单实用，但是行为上有一定局限性，通俗点说就是 “太霸道”，要么不占，要么独占。实际应用场景中，有的时候不需要大量竞争的写操作，而是以并发读取为主，如何进一步优化并发操作的粒度呢？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7004"><span data-slate-object="text" data-key="7005"><span data-slate-leaf="true" data-offset-key="7005:0" data-first-offset="true"><span data-slate-string="true">Java 并发包提供的读写锁等扩展了锁的能力，它所基于的原理是多个读操作是不需要互斥的，因为读操作并不会更改数据，所以不存在互相干扰。而写操作则会导致并发一致性的问题，</span></span><span data-slate-leaf="true" data-offset-key="7005:1"><span data-slate-object="annotation" data-annotation-key="gkann_9667c3c4" data-attr-id="11180" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">所以写线程之间、读写线程之间，需要精心设计的互斥逻辑。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7006"><span data-slate-object="text" data-key="7007"><span data-slate-leaf="true" data-offset-key="7007:0" data-first-offset="true"><span data-slate-string="true">下面是一个基于读写锁实现的数据结构，当数据量较大，并发读多、并发写少的时候，能够比纯同步版本凸显出优势。</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="7008"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7009"><span data-slate-object="text" data-key="7010"><span data-slate-leaf="true" data-offset-key="7010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7011"><span data-slate-leaf="true" data-offset-key="7011:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7012"><span data-slate-leaf="true" data-offset-key="7012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="7013"><span data-slate-leaf="true" data-offset-key="7013:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7014"><span data-slate-leaf="true" data-offset-key="7014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RWSample</span></span></span></span><span data-slate-object="text" data-key="7015"><span data-slate-leaf="true" data-offset-key="7015:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7016"><span data-slate-object="text" data-key="7017"><span data-slate-leaf="true" data-offset-key="7017:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7018"><span data-slate-leaf="true" data-offset-key="7018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7019"><span data-slate-leaf="true" data-offset-key="7019:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7020"><span data-slate-leaf="true" data-offset-key="7020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="7021"><span data-slate-leaf="true" data-offset-key="7021:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7022"><span data-slate-leaf="true" data-offset-key="7022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7023"><span data-slate-leaf="true" data-offset-key="7023:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7024"><span data-slate-leaf="true" data-offset-key="7024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7025"><span data-slate-leaf="true" data-offset-key="7025:0" data-first-offset="true"><span data-slate-string="true">&gt; m = </span></span></span><span data-slate-object="text" data-key="7026"><span data-slate-leaf="true" data-offset-key="7026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7027"><span data-slate-leaf="true" data-offset-key="7027:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7028"><span data-slate-leaf="true" data-offset-key="7028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TreeMap</span></span></span></span><span data-slate-object="text" data-key="7029"><span data-slate-leaf="true" data-offset-key="7029:0" data-first-offset="true"><span data-slate-string="true">&lt;&gt;();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7030"><span data-slate-object="text" data-key="7031"><span data-slate-leaf="true" data-offset-key="7031:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7032"><span data-slate-leaf="true" data-offset-key="7032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7033"><span data-slate-leaf="true" data-offset-key="7033:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7034"><span data-slate-leaf="true" data-offset-key="7034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReentrantReadWriteLock</span></span></span></span><span data-slate-object="text" data-key="7035"><span data-slate-leaf="true" data-offset-key="7035:0" data-first-offset="true"><span data-slate-string="true"> rwl = </span></span></span><span data-slate-object="text" data-key="7036"><span data-slate-leaf="true" data-offset-key="7036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7037"><span data-slate-leaf="true" data-offset-key="7037:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7038"><span data-slate-leaf="true" data-offset-key="7038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReentrantReadWriteLock</span></span></span></span><span data-slate-object="text" data-key="7039"><span data-slate-leaf="true" data-offset-key="7039:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7040"><span data-slate-object="text" data-key="7041"><span data-slate-leaf="true" data-offset-key="7041:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7042"><span data-slate-leaf="true" data-offset-key="7042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7043"><span data-slate-leaf="true" data-offset-key="7043:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7044"><span data-slate-leaf="true" data-offset-key="7044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Lock</span></span></span></span><span data-slate-object="text" data-key="7045"><span data-slate-leaf="true" data-offset-key="7045:0" data-first-offset="true"><span data-slate-string="true"> r = rwl.</span></span></span><span data-slate-object="text" data-key="7046"><span data-slate-leaf="true" data-offset-key="7046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readLock</span></span></span></span><span data-slate-object="text" data-key="7047"><span data-slate-leaf="true" data-offset-key="7047:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7048"><span data-slate-object="text" data-key="7049"><span data-slate-leaf="true" data-offset-key="7049:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7050"><span data-slate-leaf="true" data-offset-key="7050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7051"><span data-slate-leaf="true" data-offset-key="7051:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7052"><span data-slate-leaf="true" data-offset-key="7052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Lock</span></span></span></span><span data-slate-object="text" data-key="7053"><span data-slate-leaf="true" data-offset-key="7053:0" data-first-offset="true"><span data-slate-string="true"> w = rwl.</span></span></span><span data-slate-object="text" data-key="7054"><span data-slate-leaf="true" data-offset-key="7054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">writeLock</span></span></span></span><span data-slate-object="text" data-key="7055"><span data-slate-leaf="true" data-offset-key="7055:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7056"><span data-slate-object="text" data-key="7057"><span data-slate-leaf="true" data-offset-key="7057:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7058"><span data-slate-leaf="true" data-offset-key="7058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7059"><span data-slate-leaf="true" data-offset-key="7059:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7060"><span data-slate-leaf="true" data-offset-key="7060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7061"><span data-slate-leaf="true" data-offset-key="7061:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7062"><span data-slate-leaf="true" data-offset-key="7062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7063"><span data-slate-leaf="true" data-offset-key="7063:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7064"><span data-slate-leaf="true" data-offset-key="7064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span></span><span data-slate-object="text" data-key="7065"><span data-slate-leaf="true" data-offset-key="7065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> key</span></span></span></span><span data-slate-object="text" data-key="7066"><span data-slate-leaf="true" data-offset-key="7066:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7067"><span data-slate-object="text" data-key="7068"><span data-slate-leaf="true" data-offset-key="7068:0" data-first-offset="true"><span data-slate-string="true">      r.</span></span></span><span data-slate-object="text" data-key="7069"><span data-slate-leaf="true" data-offset-key="7069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">lock</span></span></span></span><span data-slate-object="text" data-key="7070"><span data-slate-leaf="true" data-offset-key="7070:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7071"><span data-slate-object="text" data-key="7072"><span data-slate-leaf="true" data-offset-key="7072:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7073"><span data-slate-leaf="true" data-offset-key="7073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">System</span></span></span></span><span data-slate-object="text" data-key="7074"><span data-slate-leaf="true" data-offset-key="7074:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="7075"><span data-slate-leaf="true" data-offset-key="7075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="7076"><span data-slate-leaf="true" data-offset-key="7076:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="7077"><span data-slate-leaf="true" data-offset-key="7077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="7078"><span data-slate-leaf="true" data-offset-key="7078:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7079"><span data-slate-leaf="true" data-offset-key="7079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"读锁锁定！"</span></span></span></span><span data-slate-object="text" data-key="7080"><span data-slate-leaf="true" data-offset-key="7080:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7081"><span data-slate-object="text" data-key="7082"><span data-slate-leaf="true" data-offset-key="7082:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7083"><span data-slate-leaf="true" data-offset-key="7083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7084"><span data-slate-leaf="true" data-offset-key="7084:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7085"><span data-slate-object="text" data-key="7086"><span data-slate-leaf="true" data-offset-key="7086:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="7087"><span data-slate-leaf="true" data-offset-key="7087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7088"><span data-slate-leaf="true" data-offset-key="7088:0" data-first-offset="true"><span data-slate-string="true"> m.</span></span></span><span data-slate-object="text" data-key="7089"><span data-slate-leaf="true" data-offset-key="7089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7090"><span data-slate-leaf="true" data-offset-key="7090:0" data-first-offset="true"><span data-slate-string="true">(key);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7091"><span data-slate-object="text" data-key="7092"><span data-slate-leaf="true" data-offset-key="7092:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="7093"><span data-slate-leaf="true" data-offset-key="7093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="7094"><span data-slate-leaf="true" data-offset-key="7094:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7095"><span data-slate-object="text" data-key="7096"><span data-slate-leaf="true" data-offset-key="7096:0" data-first-offset="true"><span data-slate-string="true">          r.</span></span></span><span data-slate-object="text" data-key="7097"><span data-slate-leaf="true" data-offset-key="7097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlock</span></span></span></span><span data-slate-object="text" data-key="7098"><span data-slate-leaf="true" data-offset-key="7098:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7099"><span data-slate-object="text" data-key="7100"><span data-slate-leaf="true" data-offset-key="7100:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7101"><span data-slate-object="text" data-key="7102"><span data-slate-leaf="true" data-offset-key="7102:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7103"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7104"><span data-slate-object="text" data-key="7105"><span data-slate-leaf="true" data-offset-key="7105:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7106"><span data-slate-leaf="true" data-offset-key="7106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7107"><span data-slate-leaf="true" data-offset-key="7107:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7108"><span data-slate-leaf="true" data-offset-key="7108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7109"><span data-slate-leaf="true" data-offset-key="7109:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7110"><span data-slate-leaf="true" data-offset-key="7110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="7111"><span data-slate-leaf="true" data-offset-key="7111:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7112"><span data-slate-leaf="true" data-offset-key="7112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span></span><span data-slate-object="text" data-key="7113"><span data-slate-leaf="true" data-offset-key="7113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> key, </span></span></span></span><span data-slate-object="text" data-key="7114"><span data-slate-leaf="true" data-offset-key="7114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span></span><span data-slate-object="text" data-key="7115"><span data-slate-leaf="true" data-offset-key="7115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> entry</span></span></span></span><span data-slate-object="text" data-key="7116"><span data-slate-leaf="true" data-offset-key="7116:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7117"><span data-slate-object="text" data-key="7118"><span data-slate-leaf="true" data-offset-key="7118:0" data-first-offset="true"><span data-slate-string="true">      w.</span></span></span><span data-slate-object="text" data-key="7119"><span data-slate-leaf="true" data-offset-key="7119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">lock</span></span></span></span><span data-slate-object="text" data-key="7120"><span data-slate-leaf="true" data-offset-key="7120:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7121"><span data-slate-object="text" data-key="7122"><span data-slate-leaf="true" data-offset-key="7122:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7123"><span data-slate-leaf="true" data-offset-key="7123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">System</span></span></span></span><span data-slate-object="text" data-key="7124"><span data-slate-leaf="true" data-offset-key="7124:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="7125"><span data-slate-leaf="true" data-offset-key="7125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="7126"><span data-slate-leaf="true" data-offset-key="7126:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="7127"><span data-slate-leaf="true" data-offset-key="7127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="7128"><span data-slate-leaf="true" data-offset-key="7128:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7129"><span data-slate-leaf="true" data-offset-key="7129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"写锁锁定！"</span></span></span></span><span data-slate-object="text" data-key="7130"><span data-slate-leaf="true" data-offset-key="7130:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7131"><span data-slate-object="text" data-key="7132"><span data-slate-leaf="true" data-offset-key="7132:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7133"><span data-slate-leaf="true" data-offset-key="7133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7134"><span data-slate-leaf="true" data-offset-key="7134:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7135"><span data-slate-object="text" data-key="7136"><span data-slate-leaf="true" data-offset-key="7136:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7137"><span data-slate-leaf="true" data-offset-key="7137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7138"><span data-slate-leaf="true" data-offset-key="7138:0" data-first-offset="true"><span data-slate-string="true"> m.</span></span></span><span data-slate-object="text" data-key="7139"><span data-slate-leaf="true" data-offset-key="7139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="7140"><span data-slate-leaf="true" data-offset-key="7140:0" data-first-offset="true"><span data-slate-string="true">(key, entry);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7141"><span data-slate-object="text" data-key="7142"><span data-slate-leaf="true" data-offset-key="7142:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="7143"><span data-slate-leaf="true" data-offset-key="7143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="7144"><span data-slate-leaf="true" data-offset-key="7144:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7145"><span data-slate-object="text" data-key="7146"><span data-slate-leaf="true" data-offset-key="7146:0" data-first-offset="true"><span data-slate-string="true">            w.</span></span></span><span data-slate-object="text" data-key="7147"><span data-slate-leaf="true" data-offset-key="7147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlock</span></span></span></span><span data-slate-object="text" data-key="7148"><span data-slate-leaf="true" data-offset-key="7148:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7149"><span data-slate-object="text" data-key="7150"><span data-slate-leaf="true" data-offset-key="7150:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7151"><span data-slate-object="text" data-key="7152"><span data-slate-leaf="true" data-offset-key="7152:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7153"><span data-slate-object="text" data-key="7154"><span data-slate-leaf="true" data-offset-key="7154:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7155"><span data-slate-leaf="true" data-offset-key="7155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// …</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7156"><span data-slate-object="text" data-key="7157"><span data-slate-leaf="true" data-offset-key="7157:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7158"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7159"><span data-slate-object="text" data-key="7160"><span data-slate-leaf="true" data-offset-key="7160:0" data-first-offset="true"><span data-slate-string="true">在运行过程中，如果读锁试图锁定时，写锁是被某个线程持有，读锁将无法获得，而只好等待对方操作结束，这样就可以自动保证不会读取到有争议的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7161"><span data-slate-object="text" data-key="7162"><span data-slate-leaf="true" data-offset-key="7162:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_455854d8" data-attr-id="37290" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">读写锁看起来比 synchronized 的粒度似乎细一些，但在实际应用中，其表现也并不尽如人意，主要还是因为相对比较大的开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7163"><span data-slate-object="text" data-key="7164"><span data-slate-leaf="true" data-offset-key="7164:0" data-first-offset="true"><span data-slate-string="true">所以，</span></span><span data-slate-leaf="true" data-offset-key="7164:1"><span data-slate-object="annotation" data-annotation-key="gkann_851fb6c4" data-attr-id="22371" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">JDK 在后期引入了 StampedLock，在提供类似读写锁的同时，还支持优化读模式。优化读基于假设，大多数情况下读操作并不会和写操作冲突，其逻辑是先试着读，然后通过 validate 方法确认是否进入了写模式，如果没有进入，就成功避免了开销；如果进入，则尝试获取读锁。</span></span></span><span data-slate-leaf="true" data-offset-key="7164:2"><span data-slate-string="true">请参考我下面的样例代码。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="7165"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7166"><span data-slate-object="text" data-key="7167"><span data-slate-leaf="true" data-offset-key="7167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7168"><span data-slate-leaf="true" data-offset-key="7168:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7169"><span data-slate-leaf="true" data-offset-key="7169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="7170"><span data-slate-leaf="true" data-offset-key="7170:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7171"><span data-slate-leaf="true" data-offset-key="7171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StampedSample</span></span></span></span><span data-slate-object="text" data-key="7172"><span data-slate-leaf="true" data-offset-key="7172:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7173"><span data-slate-object="text" data-key="7174"><span data-slate-leaf="true" data-offset-key="7174:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7175"><span data-slate-leaf="true" data-offset-key="7175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7176"><span data-slate-leaf="true" data-offset-key="7176:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7177"><span data-slate-leaf="true" data-offset-key="7177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7178"><span data-slate-leaf="true" data-offset-key="7178:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7179"><span data-slate-leaf="true" data-offset-key="7179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StampedLock</span></span></span></span><span data-slate-object="text" data-key="7180"><span data-slate-leaf="true" data-offset-key="7180:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7181"><span data-slate-leaf="true" data-offset-key="7181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sl</span></span></span></span><span data-slate-object="text" data-key="7182"><span data-slate-leaf="true" data-offset-key="7182:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7183"><span data-slate-leaf="true" data-offset-key="7183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="7184"><span data-slate-leaf="true" data-offset-key="7184:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7185"><span data-slate-leaf="true" data-offset-key="7185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7186"><span data-slate-leaf="true" data-offset-key="7186:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7187"><span data-slate-leaf="true" data-offset-key="7187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StampedLock</span></span></span></span><span data-slate-object="text" data-key="7188"><span data-slate-leaf="true" data-offset-key="7188:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7189"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7190"><span data-slate-object="text" data-key="7191"><span data-slate-leaf="true" data-offset-key="7191:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7192"><span data-slate-leaf="true" data-offset-key="7192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="7193"><span data-slate-leaf="true" data-offset-key="7193:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7194"><span data-slate-leaf="true" data-offset-key="7194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutate</span></span></span></span><span data-slate-object="text" data-key="7195"><span data-slate-leaf="true" data-offset-key="7195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="7196"><span data-slate-leaf="true" data-offset-key="7196:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7197"><span data-slate-object="text" data-key="7198"><span data-slate-leaf="true" data-offset-key="7198:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7199"><span data-slate-leaf="true" data-offset-key="7199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="7200"><span data-slate-leaf="true" data-offset-key="7200:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7201"><span data-slate-leaf="true" data-offset-key="7201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stamp</span></span></span></span><span data-slate-object="text" data-key="7202"><span data-slate-leaf="true" data-offset-key="7202:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7203"><span data-slate-leaf="true" data-offset-key="7203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="7204"><span data-slate-leaf="true" data-offset-key="7204:0" data-first-offset="true"><span data-slate-string="true"> sl.writeLock();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7205"><span data-slate-object="text" data-key="7206"><span data-slate-leaf="true" data-offset-key="7206:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7207"><span data-slate-leaf="true" data-offset-key="7207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7208"><span data-slate-leaf="true" data-offset-key="7208:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7209"><span data-slate-object="text" data-key="7210"><span data-slate-leaf="true" data-offset-key="7210:0" data-first-offset="true"><span data-slate-string="true">          write();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7211"><span data-slate-object="text" data-key="7212"><span data-slate-leaf="true" data-offset-key="7212:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="7213"><span data-slate-leaf="true" data-offset-key="7213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="7214"><span data-slate-leaf="true" data-offset-key="7214:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7215"><span data-slate-object="text" data-key="7216"><span data-slate-leaf="true" data-offset-key="7216:0" data-first-offset="true"><span data-slate-string="true">          sl.unlockWrite(stamp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7217"><span data-slate-object="text" data-key="7218"><span data-slate-leaf="true" data-offset-key="7218:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7219"><span data-slate-object="text" data-key="7220"><span data-slate-leaf="true" data-offset-key="7220:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7221"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7222"><span data-slate-object="text" data-key="7223"><span data-slate-leaf="true" data-offset-key="7223:0" data-first-offset="true"><span data-slate-string="true">  Data </span></span></span><span data-slate-object="text" data-key="7224"><span data-slate-leaf="true" data-offset-key="7224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">access</span></span></span></span><span data-slate-object="text" data-key="7225"><span data-slate-leaf="true" data-offset-key="7225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="7226"><span data-slate-leaf="true" data-offset-key="7226:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7227"><span data-slate-object="text" data-key="7228"><span data-slate-leaf="true" data-offset-key="7228:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7229"><span data-slate-leaf="true" data-offset-key="7229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="7230"><span data-slate-leaf="true" data-offset-key="7230:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7231"><span data-slate-leaf="true" data-offset-key="7231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stamp</span></span></span></span><span data-slate-object="text" data-key="7232"><span data-slate-leaf="true" data-offset-key="7232:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7233"><span data-slate-leaf="true" data-offset-key="7233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="7234"><span data-slate-leaf="true" data-offset-key="7234:0" data-first-offset="true"><span data-slate-string="true"> sl.tryOptimisticRead();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7235"><span data-slate-object="text" data-key="7236"><span data-slate-leaf="true" data-offset-key="7236:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7237"><span data-slate-leaf="true" data-offset-key="7237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Data</span></span></span></span><span data-slate-object="text" data-key="7238"><span data-slate-leaf="true" data-offset-key="7238:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7239"><span data-slate-leaf="true" data-offset-key="7239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">data</span></span></span></span><span data-slate-object="text" data-key="7240"><span data-slate-leaf="true" data-offset-key="7240:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7241"><span data-slate-leaf="true" data-offset-key="7241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="7242"><span data-slate-leaf="true" data-offset-key="7242:0" data-first-offset="true"><span data-slate-string="true"> read();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7243"><span data-slate-object="text" data-key="7244"><span data-slate-leaf="true" data-offset-key="7244:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7245"><span data-slate-leaf="true" data-offset-key="7245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7246"><span data-slate-leaf="true" data-offset-key="7246:0" data-first-offset="true"><span data-slate-string="true"> (!sl.validate(stamp)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7247"><span data-slate-object="text" data-key="7248"><span data-slate-leaf="true" data-offset-key="7248:0" data-first-offset="true"><span data-slate-string="true">          stamp = sl.readLock();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7249"><span data-slate-object="text" data-key="7250"><span data-slate-leaf="true" data-offset-key="7250:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="7251"><span data-slate-leaf="true" data-offset-key="7251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7252"><span data-slate-leaf="true" data-offset-key="7252:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7253"><span data-slate-object="text" data-key="7254"><span data-slate-leaf="true" data-offset-key="7254:0" data-first-offset="true"><span data-slate-string="true">              data = read();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7255"><span data-slate-object="text" data-key="7256"><span data-slate-leaf="true" data-offset-key="7256:0" data-first-offset="true"><span data-slate-string="true">          } </span></span></span><span data-slate-object="text" data-key="7257"><span data-slate-leaf="true" data-offset-key="7257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="7258"><span data-slate-leaf="true" data-offset-key="7258:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7259"><span data-slate-object="text" data-key="7260"><span data-slate-leaf="true" data-offset-key="7260:0" data-first-offset="true"><span data-slate-string="true">              sl.unlockRead(stamp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7261"><span data-slate-object="text" data-key="7262"><span data-slate-leaf="true" data-offset-key="7262:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7263"><span data-slate-object="text" data-key="7264"><span data-slate-leaf="true" data-offset-key="7264:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7265"><span data-slate-object="text" data-key="7266"><span data-slate-leaf="true" data-offset-key="7266:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7267"><span data-slate-leaf="true" data-offset-key="7267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7268"><span data-slate-leaf="true" data-offset-key="7268:0" data-first-offset="true"><span data-slate-string="true"> data;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7269"><span data-slate-object="text" data-key="7270"><span data-slate-leaf="true" data-offset-key="7270:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7271"><span data-slate-object="text" data-key="7272"><span data-slate-leaf="true" data-offset-key="7272:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7273"><span data-slate-leaf="true" data-offset-key="7273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// …</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7274"><span data-slate-object="text" data-key="7275"><span data-slate-leaf="true" data-offset-key="7275:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7276"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7277"><span data-slate-object="text" data-key="7278"><span data-slate-leaf="true" data-offset-key="7278:0" data-first-offset="true"><span data-slate-string="true">注意，这里的 writeLock 和 unLockWrite 一定要保证成对调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7279"><span data-slate-object="text" data-key="7280"><span data-slate-leaf="true" data-offset-key="7280:0" data-first-offset="true"><span data-slate-string="true">你可能很好奇这些显式锁的实现机制，Java 并发包内的各种同步工具，不仅仅是各种 Lock，其他的如 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7281"><span data-slate-object="text" data-key="7282"><span data-slate-leaf="true" data-offset-key="7282:0" data-first-offset="true"><span data-slate-string="true">Semaphore</span></span></span></a><span data-slate-object="text" data-key="7283"><span data-slate-leaf="true" data-offset-key="7283:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7284"><span data-slate-object="text" data-key="7285"><span data-slate-leaf="true" data-offset-key="7285:0" data-first-offset="true"><span data-slate-string="true">CountDownLatch</span></span></span></a><span data-slate-object="text" data-key="7286"><span data-slate-leaf="true" data-offset-key="7286:0" data-first-offset="true"><span data-slate-string="true">，甚至是早期的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7287"><span data-slate-object="text" data-key="7288"><span data-slate-leaf="true" data-offset-key="7288:0" data-first-offset="true"><span data-slate-string="true">FutureTask</span></span></span></a><span data-slate-object="text" data-key="7289"><span data-slate-leaf="true" data-offset-key="7289:0" data-first-offset="true"><span data-slate-string="true"> 等，都是基于一种 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7290"><span data-slate-object="text" data-key="7291"><span data-slate-leaf="true" data-offset-key="7291:0" data-first-offset="true"><span data-slate-string="true">AQS</span></span></span></a><span data-slate-object="text" data-key="7292"><span data-slate-leaf="true" data-offset-key="7292:0" data-first-offset="true"><span data-slate-string="true"> 框架。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7293"><span data-slate-object="text" data-key="7294"><span data-slate-leaf="true" data-offset-key="7294:0" data-first-offset="true"><span data-slate-string="true">今天，我全面分析了 synchronized 相关实现和内部运行机制，简单介绍了并发包中提供的其他显式锁，并结合样例代码介绍了其使用方法，希望对你有所帮助。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7295" id="sr-toc-4"><span data-slate-object="text" data-key="7296"><span data-slate-leaf="true" data-offset-key="7296:0" data-first-offset="true"><span data-slate-string="true">一课一练</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7297"><span data-slate-object="text" data-key="7298"><span data-slate-leaf="true" data-offset-key="7298:0" data-first-offset="true"><span data-slate-string="true">关于今天我们讨论的你做到心中有数了吗？思考一个问题，你知道 “自旋锁” 是做什么的吗？它的使用场景是什么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7299"><span data-slate-object="text" data-key="7300"><span data-slate-leaf="true" data-offset-key="7300:0" data-first-offset="true"><span data-slate-string="true">请你在留言区写写你对这个问题的思考，我会选出经过认真思考的留言，送给你一份学习奖励礼券，欢迎你与我一起讨论。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7301"><span data-slate-object="text" data-key="7302"><span data-slate-leaf="true" data-offset-key="7302:0" data-first-offset="true"><span data-slate-string="true">你的朋友是不是也在准备面试呢？你可以 “请朋友读”，把今天的题目分享给好友，或许你能帮到他。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>29</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-5">精选留言 (69)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/77/b3/991f3f9b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>公号 - 技术夜未眠</span></div></div><div>自旋锁：竞争锁的失败的线程，并不会真实的在操作系统层面挂起等待，而是 JVM 会让线程做几个空循环 (基于预测在不久的将来就能获得)，在经过若干次循环后，如果可以获得锁，那么进入临界区，如果还不能获得锁，才会真实的将线程在操作系统层面进行挂起。

适用场景：自旋锁可以减少线程的阻塞，这对于锁竞争不激烈，且占用锁时间非常短的代码块来说，有较大的性能提升，因为自旋的消耗会小于线程阻塞挂起操作的消耗。
如果锁的竞争激烈，或者持有锁的线程需要长时间占用锁执行同步块，就不适合使用自旋锁了，因为自旋锁在获取锁前一直都是占用 cpu 做无用功，线程自旋的消耗大于线程阻塞挂起操作的消耗，造成 cpu 的浪费。</div><div><p>作者回复：不错，自旋是种乐观情况的优化</p></div><div><div>2018-06-12</div><div><div><i></i><span>2</span></div><div><i></i><span>179</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/6e/ff/bcbfae67.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yearning</span></div></div><div>这次原理真的看了很久，一直鼓劲自己，看不懂就是说明自己有突破。

下面看了并发编程对于自旋锁的了解，同时更深刻理解同步锁的性能。

自旋锁采用让当前线程不停循环体内执行实现，当循环条件被其他线程改变时，才能进入临界区。

由于自旋锁只是将当前线程不停执行循环体，不进行线程状态的改变，所以响应会更快。但当线程不停增加时，性能下降明显。
线程竞争不激烈，并且保持锁的时间段。适合使用自旋锁。

为什么会提出自旋锁，因为互斥锁，在线程的睡眠和唤醒都是复杂而昂贵的操作，需要大量的 CPU 指令。如果互斥仅仅被锁住是一小段时间，
用来进行线程休眠和唤醒的操作时间比睡眠时间还长，更有可能比不上不断自旋锁上轮询的时间长。

当然自旋锁被持有的时间更长，其他尝试获取自旋锁的线程会一直轮询自旋锁的状态。这将十分浪费 CPU。

在单核 CPU 上，自旋锁是无用，因为当自旋锁尝试获取锁不成功会一直尝试，这会一直占用 CPU，其他线程不可能运行，
同时由于其他线程无法运行，所以当前线程无法释放锁。

混合型互斥锁， 在多核系统上起初表现的像自旋锁一样， 如果一个线程不能获取互斥锁， 它不会马上被切换为休眠状态，在一段时间依然无法获取锁，进行睡眠状态。

混合型自旋锁，起初表现的和正常自旋锁一样，如果无法获取互斥锁，它也许会放弃该线程的执行，并允许其他线程执行。

切记，自旋锁只有在多核 CPU 上有效果，单核毫无效果，只是浪费时间。


以上基本参考来源于：
http://ifeve.com/java_lock_see1/
http://ifeve.com/practice-of-using-spinlock-instead-of-mutex/</div><div><p>作者回复：很不错总结</p></div><div><div>2018-06-12</div><div><div><i></i><span>4</span></div><div><i></i><span>77</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/d6/60/f21b2164.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>jacy</span></div></div><div>看了大家对自旋锁的评论，我的收获如下:
1. 基于乐观情况下推荐使用，即锁竞争不强，锁等待时间不长的情况下推荐使用
2. 单 cpu 无效，因为基于 cas 的轮询会占用 cpu, 导致无法做线程切换
3. 轮询不产生上下文切换，如果可估计到睡眠的时间很长，用互斥锁更好
</div><div><p>作者回复：不错</p></div><div><div>2018-06-19</div><div><div><i></i><span>4</span></div><div><i></i><span>33</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/32/3f/fa4ac035.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>sunlight001</span></div></div><div>自旋锁是尝试获取锁的线程不会立即阻塞，采用循环的方式去获取锁，好处是减少了上下文切换，缺点是消耗 cpu</div><div><p>作者回复：不错</p></div><div><div>2018-06-12</div><div><div><i></i></div><div><i></i><span>29</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/02/6f/301b1381.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Roysatm</span></div></div><div>
1.synchronized 锁，可分为偏向锁、轻量级锁、重量级锁。在 jvm 没有显示关闭偏向锁的情况下，初始状态时默认是偏向锁时，
线程请求先通过 CAS 替换 mark word 中 threadId, 如果替换成功则该线程持有当前锁。如果替换失败，锁会升级为轻量级锁，
线程请求会尝试 CAS 替换 mark word 中指向栈中锁记录的指针，如果替换成功则该线程持有当前锁。
如果替换失败，当前线程会自旋一定次数，继续尝试获取 CAS 替换，如果超过一定自旋次数，锁升级为重量级锁。

synchronized 锁是调用系统内核互斥锁实现的，线程在获取 synchronized 锁失败后，也会进入一个等待获取锁队列中（系统内核实现的），
线程会由运行态切换到阻塞态，让出 CPU，待其他线程释放锁后唤醒它。

synchronize 锁重（1.6 之后 jvm 有优化）就是重在两点，一是调用内核互斥锁实现，二是线程获取锁失败会变成阻塞态，让出 CPU，等待唤醒（有一定的上下文切换）</div><div><div>2019-02-17</div><div><div><i></i><span>3</span></div><div><i></i><span>25</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/fe/3c/13175251.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Miaozhe</span></div></div><div>杨老师，偏斜锁有什么作用？还是没有看明白，如果只是被一个线程获取，那么锁还有什么意义？
另外，如果我有两个线程明确定义调用同一个对象的 Synchronized 块，JVM 默认肯定先使用偏斜锁，之后在升级到轻量级所，必须经过撤销 Revoke 吗？编译的时候不会自动优化？</div><div><p>作者回复：我理解偏斜锁就是为了优化那些没有并发却写了同步逻辑的代码；javac 编译时能判断的是有限的；一旦有另外线程想获取，就会 revoke，而且开销明显</p></div><div><div>2018-06-12</div><div><div><i></i><span>2</span></div><div><i></i><span>23</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/10/96/5e/8bba3a8a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 陈一嘉</span></div></div><div>自旋锁 for (;;) 结合 cas 确保线程获取取锁</div><div><p>作者回复：差不多</p></div><div><div>2018-06-12</div><div><div><i></i></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/1a/66/2d9db9ed.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 苦行僧</span></div></div><div>轻量级锁和重量级锁没有详细说明和区别，仅从名字不好区别</div><div><div>2019-02-18</div><div><div><i></i><span>1</span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/ff/70/9329316e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>stephen chow</span></div></div><div>StampLock 是先试着读吧？你写的先试着修改。。</div><div><p>作者回复：嗯，是有点写跑偏了，看上下文倒也能理解，谢谢指出</p></div><div><div>2018-10-01</div><div><div><i></i></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/33/92/99530cee.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 灰飞灰猪不会灰飞。烟灭</span></div></div><div>老师 AQS 就不涉及用户态和内核态的切换了 对吧？</div><div><p>作者回复：我理解是，cas 是基于特定指令</p></div><div><div>2018-06-12</div><div><div><i></i></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/10/e2/47/e910afec.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 刘杰</span></div></div><div>偏斜锁和轻量级锁的区别不是很清晰</div><div><div>2018-07-12</div><div><div><i></i><span></span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/fe/3c/13175251.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Miaozhe</span></div></div><div>关于自旋转锁不适合单核 CPU 的问题，下来查找了一下资料:
1.JVM 在操作系统中是作为一个进程存在，但是 OS 一般都将将线程作为最小调度单位，进程是资源分配的最小单位。这就是说进程是不活动的，只是作为线程的容器，那么 Java 的线程是在 JVM 进程中，也被 CPU 调度。
2. 单核 CPU 使用多线程时，一个线程被 CPU 执行，其它处于等待轮巡状态。
3. 为什么多线程跑在单核 CPU 上也比较快呢？是由于这种线程还有其它 IO 操作 (File,Socket)，可以跟 CPU 运算并行。
4. 结论，根据前面 3 点的分析，与自旋转锁的优点冲突：线程竞争不激烈，占用锁时间短。</div><div><p>作者回复：自旋是基于乐观假设，就是等待中锁被释放了，单核 cpu 就自己占着 cpu，别人没机会让</p></div><div><div>2018-06-13</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/fe/3c/13175251.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Miaozhe</span></div></div><div>杨老师，看到有回复说自旋锁在单核 CPU 上是无用，感觉这个理论不准确，因为 Java 多线程在很早时候单核 CPC 的 PC 上就能运行，计算机原理中也介绍，控制器会轮巡各个进程或线程。而且多线程是运行在 JVM 上，跟物理机没有很直接的关系吧？</div><div><p>作者回复：已回复，我也认为单核无用</p></div><div><div>2018-06-13</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/63/14/06eff9a4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Jerry 银银</span></div></div><div>『其逻辑是先试着修改，然后通过 validate 方法确认是否...』    
这里面先试着修改写错了，小编帮忙改下吧，应该是：『其逻辑是先试着读，然后....』 我看到留言中，有其它同学早就提出了，但是一直没有被修正。。。。</div><div><p>作者回复：谢谢指出</p></div><div><div>2019-02-02</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/ce/b3/804aa247.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 大熊</span></div></div><div>老师，请问下为什么要有读锁？读不会改变数据为什么还要加锁呢</div><div><p>作者回复：针对不同场景，例如，并发读比写多，比较适合 readwritelock；readlock 不是排他的（exclusive），保证看到的 data 是更新过的</p></div><div><div>2018-10-16</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/ff/a5/eccc7653.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>clz1341521</span></div></div><div>自旋锁是一种乐观优化
自旋锁：竞争锁的失败的线程，并不会真实的在操作系统层面挂起等待，而是 JVM 会让线程做几个空循环 (基于预测在不久的将来就能获得)，在经过若干次循环后，如果可以获得锁，那么进入临界区，如果还不能获得锁，才会真实的将线程在操作系统层面进行挂起。

适用场景：自旋锁可以减少线程的阻塞，这对于锁竞争不激烈，且占用锁时间非常短的代码块来说，有较大的性能提升，因为自旋的消耗会小于线程阻塞挂起操作的消耗。</div><div><div>2018-08-05</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/cc/de/e28c01e1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 剑八</span></div></div><div>syncronized 为了性能优化按场景将锁分为几个阶段：
无锁，偏向锁，轻量级，重量级
相应的应用场景也是从竞争无，竞争少，竞争多
同步加锁都是在对象上的，相应信息也是在对象的 MARK WORD 上
偏向锁是在有一个线程获取锁时直接在对应锁对象的 MARK WORD 上设置当前为偏向锁模式及对应的偏向锁线程 ID
偏向锁到轻量级的切换是 2 个及以上线程发生了竞争，如果竞争的线程 CAS 能替换获取到锁，则进入轻量级锁，否则进入重量级锁
轻量级锁有线程在获取锁时使用 CAS 自旋
进入重量级锁则获取不到锁的线程就会进入到系统挂起的状态了，涉及到用户态到系统态的切换
这里涉及到 JAVA 的线程模型是与操作系统线程一对一的</div><div><div>2020-12-27</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/11/39/24/ab14f6cf.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>rong</span></div></div><div>老师，有个问题不明白，就是锁代码块的时候，只有一个 monitorenter 指令，那怎么知道这个锁绑定的是哪个对象呢？比如我自定义了 Person 类，他的实例 person，@synchronized（person），我看到字节码中只有 monitorenter，没看到他和 person 对象的绑定关系啊？</div><div><div>2019-09-04</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 张天屹</span></div></div><div>自旋锁我理解了，但是没用过，请问其对于 Java 来说是 jdk 提供的 api 还是 JVM 层面的实现，还是 OS 层面的实现呢？</div><div><div>2019-04-01</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/67/f4/9a1feb59.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 钱</span></div></div><div>自旋锁，之前知乎上看过一个比喻，一辆车遇到红灯，一看还有 5 秒就变绿了，那就不熄火等一下。发动机类比 CPU，先占一会，就能获取锁（绿灯），如果要等 5 分钟，就熄火等待，时间到了再打火成本也合算。
恩，还是回到，锁本质的问题上来理解锁吧！
锁 - 本质就是一种多线程同步机制，各种锁华丽花哨的是对锁特征的描述。
本节需要扩充，然后多看几遍。</div><div><div>2018-12-15</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1e"><outline class="toc-level-h1" data-reactid=".1e.0" style="width: 175px;"><active data-reactid=".1e.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1e.0.1"><span data-reactid=".1e.0.1.0">第 16 讲 | synchronized 底层如何实现？什么是锁的升级、降级？</span></a></outline><outline class="toc-level-h2" data-reactid=".1e.1" style="width: 165px;"><active data-reactid=".1e.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1e.1.1"><span data-reactid=".1e.1.1.0">典型回答</span></a></outline><outline class="toc-level-h2" data-reactid=".1e.2" style="width: 165px;"><active data-reactid=".1e.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1e.2.1"><span data-reactid=".1e.2.1.0">考点分析</span></a></outline><outline class="toc-level-h2" data-reactid=".1e.3" style="width: 165px;"><active data-reactid=".1e.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1e.3.1"><span data-reactid=".1e.3.1.0">知识扩展</span></a></outline><outline class="toc-level-h2" data-reactid=".1e.4" style="width: 165px;"><active data-reactid=".1e.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1e.4.1"><span data-reactid=".1e.4.1.0">一课一练</span></a></outline><outline class="toc-level-h2" data-reactid=".1e.5" style="width: 165px;"><active data-reactid=".1e.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1e.5.1"><span data-reactid=".1e.5.1.0">精选留言 (69)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/9042" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>