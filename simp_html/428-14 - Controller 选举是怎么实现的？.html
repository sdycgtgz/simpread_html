
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 14 | Controller 选举是怎么实现的？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>14 | Controller 选举是怎么实现的？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">14 | Controller 选举是怎么实现的？</h1><div><span>胡夕</span> <span> 2020-05-21</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/02/5f/02228da671815cf2839936d3627e5a5f.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：20.39M</span><span> 时长：22:16</span></div></div><audio title="14 | Controller选举是怎么实现的？" src="https://res001.geekbang.org//media/audio/aa/18/aab8712a07a0638527505d3e3574df18/ld/ld.m3u8" __idm_id__="49169"></audio></div><div><div><div><div data-slate-editor="true" data-key="15029" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="15030"><span data-slate-object="text" data-key="15031"><span data-slate-leaf="true" data-offset-key="15031:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15032"><span data-slate-object="text" data-key="15033"><span data-slate-leaf="true" data-offset-key="15033:0" data-first-offset="true"><span data-slate-string="true">上节课，我们学习了单线程事件队列模型处理 Controller 事件的代码。Controller 组件通过 ControllerEventManager 类构造了一个阻塞队列，同时配以专属的事件处理线程，实现了对各类 ControllerEvent 的处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15034"><span data-slate-object="text" data-key="15035"><span data-slate-leaf="true" data-offset-key="15035:0" data-first-offset="true"><span data-slate-string="true">这种设计思路既保证了多线程访问所需的线程安全，还简化了 Controller 端的代码结构，极大地提升了代码的可维护性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15036"><span data-slate-object="text" data-key="15037"><span data-slate-leaf="true" data-offset-key="15037:0" data-first-offset="true"><span data-slate-string="true">今天，我们学习下 Controller 选举部分的源码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15038"><span data-slate-object="text" data-key="15039"><span data-slate-leaf="true" data-offset-key="15039:0" data-first-offset="true"><span data-slate-string="true">还记得我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15040"><span data-slate-object="text" data-key="15041"><span data-slate-leaf="true" data-offset-key="15041:0" data-first-offset="true"><span data-slate-string="true">第 11 节课</span></span></span></a><span data-slate-object="text" data-key="15042"><span data-slate-leaf="true" data-offset-key="15042:0" data-first-offset="true"><span data-slate-string="true">的案例中提到的 “恢复大法”—— 删除 ZooKeeper 的 /controller 节点吗？当时，我们靠着这个 “秘籍” 涉险过关，既恢复了错误的集群状态，又避免了重启整个生产环境。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15043"><span data-slate-object="text" data-key="15044"><span data-slate-leaf="true" data-offset-key="15044:0" data-first-offset="true"><span data-slate-string="true">但你有没有想过，为什么删除 /controller 节点能够令集群元数据重新保持同步呢？如果不了解这背后的原理，我们是不敢贸然在生产环境做这种操作的。今天，我们要学习的就是这背后的一整套实现逻辑，重点关注下 Controller 是怎么被选举出来的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15045"><span data-slate-object="text" data-key="15046"><span data-slate-leaf="true" data-offset-key="15046:0" data-first-offset="true"><span data-slate-string="true">我始终认为，只有掌握了这些知识，才算真正入门 Kafka 服务器端的代码了。作为 Broker 端最重要的组件之一，Controller 在 Kafka 中的地位无可替代。整个 Kafka 集群就只有一个 Controller，从某种意义上来说，它是目前 Kafka 这个分布式系统中唯一的 “单点”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15047"><span data-slate-object="text" data-key="15048"><span data-slate-leaf="true" data-offset-key="15048:0" data-first-offset="true"><span data-slate-string="true">因此，了解这个 “单点” 的选举触发场景，以及如何被选举出来的，对于我们后面深入理解 Controller 在集群中的作用非常有帮助。毕竟，Controller 对外提供的一些服务也是采用了类似的实现原理。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15049" id="sr-toc-1"><span data-slate-object="text" data-key="15050"><span data-slate-leaf="true" data-offset-key="15050:0" data-first-offset="true"><span data-slate-string="true">概览</span></span></span></h2><h3 data-slate-type="heading" data-slate-object="block" data-key="15051" id="sr-toc-2"><span data-slate-object="text" data-key="15052"><span data-slate-leaf="true" data-offset-key="15052:0" data-first-offset="true"><span data-slate-string="true">ZooKeeper /controller 节点</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15053"><span data-slate-object="text" data-key="15054"><span data-slate-leaf="true" data-offset-key="15054:0" data-first-offset="true"><span data-slate-string="true">再次强调下，</span></span></span><span data-slate-object="text" data-key="15055"><span data-slate-leaf="true" data-offset-key="15055:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在一个 Kafka 集群中，某段时间内只能有一台 Broker 被选举为 Controller。随着时间的推移，可能会有不同的 Broker 陆续担任过 Controller 的角色，但是在某一时刻，Controller 只能由一个 Broker 担任</span></span></span></span><span data-slate-object="text" data-key="15056"><span data-slate-leaf="true" data-offset-key="15056:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15057"><span data-slate-object="text" data-key="15058"><span data-slate-leaf="true" data-offset-key="15058:0" data-first-offset="true"><span data-slate-string="true">那选择哪个 Broker 充当 Controller 呢？当前，Controller 的选举过程依赖 ZooKeeper 完成。ZooKeeper 除了扮演集群元数据的 “真理之源” 角色，还定义了 /controller 临时节点（Ephemeral Node），以协助完成 Controller 的选举。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15059"><span data-slate-object="text" data-key="15060"><span data-slate-leaf="true" data-offset-key="15060:0" data-first-offset="true"><span data-slate-string="true">下面这段代码展示的是一个双 Broker 的 Kafka 集群上的 ZooKeeper 中 /controller 节点：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="15061"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15062"><span data-slate-object="text" data-key="15063"><span data-slate-leaf="true" data-offset-key="15063:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="15064"><span data-slate-leaf="true" data-offset-key="15064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"version"</span></span></span></span><span data-slate-object="text" data-key="15065"><span data-slate-leaf="true" data-offset-key="15065:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15066"><span data-slate-leaf="true" data-offset-key="15066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15067"><span data-slate-leaf="true" data-offset-key="15067:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="15068"><span data-slate-leaf="true" data-offset-key="15068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"brokerid"</span></span></span></span><span data-slate-object="text" data-key="15069"><span data-slate-leaf="true" data-offset-key="15069:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15070"><span data-slate-leaf="true" data-offset-key="15070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15071"><span data-slate-leaf="true" data-offset-key="15071:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="15072"><span data-slate-leaf="true" data-offset-key="15072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"timestamp"</span></span></span></span><span data-slate-object="text" data-key="15073"><span data-slate-leaf="true" data-offset-key="15073:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15074"><span data-slate-leaf="true" data-offset-key="15074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1585098432431"</span></span></span></span><span data-slate-object="text" data-key="15075"><span data-slate-leaf="true" data-offset-key="15075:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15076"><span data-slate-object="text" data-key="15077"><span data-slate-leaf="true" data-offset-key="15077:0" data-first-offset="true"><span data-slate-string="true">cZxid = </span></span></span><span data-slate-object="text" data-key="15078"><span data-slate-leaf="true" data-offset-key="15078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1a</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15079"><span data-slate-object="text" data-key="15080"><span data-slate-leaf="true" data-offset-key="15080:0" data-first-offset="true"><span data-slate-string="true">ctime = </span></span></span><span data-slate-object="text" data-key="15081"><span data-slate-leaf="true" data-offset-key="15081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Wed</span></span></span></span><span data-slate-object="text" data-key="15082"><span data-slate-leaf="true" data-offset-key="15082:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15083"><span data-slate-leaf="true" data-offset-key="15083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Mar</span></span></span></span><span data-slate-object="text" data-key="15084"><span data-slate-leaf="true" data-offset-key="15084:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15085"><span data-slate-leaf="true" data-offset-key="15085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">25</span></span></span></span><span data-slate-object="text" data-key="15086"><span data-slate-leaf="true" data-offset-key="15086:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15087"><span data-slate-leaf="true" data-offset-key="15087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">09</span></span></span></span><span data-slate-object="text" data-key="15088"><span data-slate-leaf="true" data-offset-key="15088:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15089"><span data-slate-leaf="true" data-offset-key="15089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">07</span></span></span></span><span data-slate-object="text" data-key="15090"><span data-slate-leaf="true" data-offset-key="15090:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15091"><span data-slate-leaf="true" data-offset-key="15091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">12</span></span></span></span><span data-slate-object="text" data-key="15092"><span data-slate-leaf="true" data-offset-key="15092:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15093"><span data-slate-leaf="true" data-offset-key="15093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CST</span></span></span></span><span data-slate-object="text" data-key="15094"><span data-slate-leaf="true" data-offset-key="15094:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15095"><span data-slate-leaf="true" data-offset-key="15095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2020</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15096"><span data-slate-object="text" data-key="15097"><span data-slate-leaf="true" data-offset-key="15097:0" data-first-offset="true"><span data-slate-string="true">mZxid = </span></span></span><span data-slate-object="text" data-key="15098"><span data-slate-leaf="true" data-offset-key="15098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1a</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15099"><span data-slate-object="text" data-key="15100"><span data-slate-leaf="true" data-offset-key="15100:0" data-first-offset="true"><span data-slate-string="true">mtime = </span></span></span><span data-slate-object="text" data-key="15101"><span data-slate-leaf="true" data-offset-key="15101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Wed</span></span></span></span><span data-slate-object="text" data-key="15102"><span data-slate-leaf="true" data-offset-key="15102:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15103"><span data-slate-leaf="true" data-offset-key="15103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Mar</span></span></span></span><span data-slate-object="text" data-key="15104"><span data-slate-leaf="true" data-offset-key="15104:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15105"><span data-slate-leaf="true" data-offset-key="15105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">25</span></span></span></span><span data-slate-object="text" data-key="15106"><span data-slate-leaf="true" data-offset-key="15106:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15107"><span data-slate-leaf="true" data-offset-key="15107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">09</span></span></span></span><span data-slate-object="text" data-key="15108"><span data-slate-leaf="true" data-offset-key="15108:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15109"><span data-slate-leaf="true" data-offset-key="15109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">07</span></span></span></span><span data-slate-object="text" data-key="15110"><span data-slate-leaf="true" data-offset-key="15110:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="15111"><span data-slate-leaf="true" data-offset-key="15111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">12</span></span></span></span><span data-slate-object="text" data-key="15112"><span data-slate-leaf="true" data-offset-key="15112:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15113"><span data-slate-leaf="true" data-offset-key="15113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CST</span></span></span></span><span data-slate-object="text" data-key="15114"><span data-slate-leaf="true" data-offset-key="15114:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15115"><span data-slate-leaf="true" data-offset-key="15115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2020</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15116"><span data-slate-object="text" data-key="15117"><span data-slate-leaf="true" data-offset-key="15117:0" data-first-offset="true"><span data-slate-string="true">pZxid = </span></span></span><span data-slate-object="text" data-key="15118"><span data-slate-leaf="true" data-offset-key="15118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1a</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15119"><span data-slate-object="text" data-key="15120"><span data-slate-leaf="true" data-offset-key="15120:0" data-first-offset="true"><span data-slate-string="true">cversion = </span></span></span><span data-slate-object="text" data-key="15121"><span data-slate-leaf="true" data-offset-key="15121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15122"><span data-slate-object="text" data-key="15123"><span data-slate-leaf="true" data-offset-key="15123:0" data-first-offset="true"><span data-slate-string="true">dataVersion = </span></span></span><span data-slate-object="text" data-key="15124"><span data-slate-leaf="true" data-offset-key="15124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15125"><span data-slate-object="text" data-key="15126"><span data-slate-leaf="true" data-offset-key="15126:0" data-first-offset="true"><span data-slate-string="true">aclVersion = </span></span></span><span data-slate-object="text" data-key="15127"><span data-slate-leaf="true" data-offset-key="15127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15128"><span data-slate-object="text" data-key="15129"><span data-slate-leaf="true" data-offset-key="15129:0" data-first-offset="true"><span data-slate-string="true">ephemeralOwner = </span></span></span><span data-slate-object="text" data-key="15130"><span data-slate-leaf="true" data-offset-key="15130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x100002d3a1f0000</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15131"><span data-slate-object="text" data-key="15132"><span data-slate-leaf="true" data-offset-key="15132:0" data-first-offset="true"><span data-slate-string="true">dataLength = </span></span></span><span data-slate-object="text" data-key="15133"><span data-slate-leaf="true" data-offset-key="15133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">54</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15134"><span data-slate-object="text" data-key="15135"><span data-slate-leaf="true" data-offset-key="15135:0" data-first-offset="true"><span data-slate-string="true">numChildren = </span></span></span><span data-slate-object="text" data-key="15136"><span data-slate-leaf="true" data-offset-key="15136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15137"><span data-slate-object="text" data-key="15138"><span data-slate-leaf="true" data-offset-key="15138:0" data-first-offset="true"><span data-slate-string="true">有两个地方的内容，你要重点关注一下。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15139"><div data-slate-type="list-line" data-slate-object="block" data-key="15140"><span data-slate-object="text" data-key="15141"><span data-slate-leaf="true" data-offset-key="15141:0" data-first-offset="true"><span data-slate-string="true">Controller Broker Id 是 0，表示序号为 0 的 Broker 是集群 Controller。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15142"><span data-slate-object="text" data-key="15143"><span data-slate-leaf="true" data-offset-key="15143:0" data-first-offset="true"><span data-slate-string="true">ephemeralOwner 字段不是 0x0，说明这是一个临时节点。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15144"><span data-slate-object="text" data-key="15145"><span data-slate-leaf="true" data-offset-key="15145:0" data-first-offset="true"><span data-slate-string="true">既然是临时节点，那么，一旦 Broker 与 ZooKeeper 的会话终止，该节点就会消失。Controller 选举就依靠了这个特性。每个 Broker 都会监听 /controller 节点随时准备应聘 Controller 角色。下图展示了 Broker 与 /controller 节点的交互关系：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15146"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/2e/83/2e75cdbfb68c86169ec83f58e59e1283.jpg?wh=1948*1252"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15147"><span data-slate-object="text" data-key="15148"><span data-slate-leaf="true" data-offset-key="15148:0" data-first-offset="true"><span data-slate-string="true">如图所示，集群上所有的 Broker 都在实时监听 ZooKeeper 上的这个节点。这里的 “监听” 有两个含义。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15149"><div data-slate-type="list-line" data-slate-object="block" data-key="15150"><span data-slate-object="text" data-key="15151"><span data-slate-leaf="true" data-offset-key="15151:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">监听这个节点是否存在</span></span></span></span><span data-slate-object="text" data-key="15152"><span data-slate-leaf="true" data-offset-key="15152:0" data-first-offset="true"><span data-slate-string="true">。</span></span><span data-slate-leaf="true" data-offset-key="15152:1"><span data-slate-object="annotation" data-annotation-key="gkann_af7cc5ed" data-attr-id="9585" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">倘若发现这个节点不存在，Broker 会立即 “抢注” 该节点，即创建 /controller 节点。创建成功的那个 Broker，即当选为新一届的 Controller。</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15153"><span data-slate-object="text" data-key="15154"><span data-slate-leaf="true" data-offset-key="15154:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">监听这个节点数据是否发生了变更</span></span></span></span><span data-slate-object="text" data-key="15155"><span data-slate-leaf="true" data-offset-key="15155:0" data-first-offset="true"><span data-slate-string="true">。同样，一旦发现该节点的内容发生了变化，Broker 也会立即启动新一轮的 Controller 选举。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15156"><span data-slate-object="text" data-key="15157"><span data-slate-leaf="true" data-offset-key="15157:0" data-first-offset="true"><span data-slate-string="true">掌握了这些基础之后，下面我们来阅读具体的源码文件：KafkaController.scala。这是一个 2200 行的大文件。我先向你介绍一下这个文件的大致结构，以免你陷入到一些繁枝末节中。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15158" id="sr-toc-3"><span data-slate-object="text" data-key="15159"><span data-slate-leaf="true" data-offset-key="15159:0" data-first-offset="true"><span data-slate-string="true">源码结构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15160"><span data-slate-object="text" data-key="15161"><span data-slate-leaf="true" data-offset-key="15161:0" data-first-offset="true"><span data-slate-string="true">KafkaController 文件的代码结构如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15162"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7e/88/7e5ddb69df585b5bbbcc91336ab8f588.jpg?wh=2250*1532"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15163"><span data-slate-object="text" data-key="15164"><span data-slate-leaf="true" data-offset-key="15164:0" data-first-offset="true"><span data-slate-string="true">整体而言，该文件大致由五部分组成。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15165"><div data-slate-type="list-line" data-slate-object="block" data-key="15166"><span data-slate-object="text" data-key="15167"><span data-slate-leaf="true" data-offset-key="15167:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_40710b2d" data-attr-id="32477" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">选举触发器</span></span></span></span></span><span data-slate-object="text" data-key="15168"><span data-slate-leaf="true" data-offset-key="15168:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_40710b2d" data-attr-id="32477" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">（ElectionTrigger）：这里的选举不是指 Controller 选举，而是指主题分区副本的选举，即为哪些分区选择 Leader 副本。</span></span></span><span data-slate-leaf="true" data-offset-key="15168:1"><span data-slate-string="true">后面在学习副本管理器和分区管理器时，我们会讲到它。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15169"><span data-slate-object="text" data-key="15170"><span data-slate-leaf="true" data-offset-key="15170:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaController Object</span></span></span></span><span data-slate-object="text" data-key="15171"><span data-slate-leaf="true" data-offset-key="15171:0" data-first-offset="true"><span data-slate-string="true">：KafkaController 伴生对象，仅仅定义了一些常量和回调函数类型。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15172"><span data-slate-object="text" data-key="15173"><span data-slate-leaf="true" data-offset-key="15173:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ControllerEvent</span></span></span></span><span data-slate-object="text" data-key="15174"><span data-slate-leaf="true" data-offset-key="15174:0" data-first-offset="true"><span data-slate-string="true">：定义 Controller 事件类型。上节课我们详细学习过 Controller 事件以及基于事件的单线程事件队列模型。这部分的代码看着很多，但实际上都是千篇一律的。你看懂了一个事件的定义，其他的也就不在话下了。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15175"><span data-slate-object="text" data-key="15176"><span data-slate-leaf="true" data-offset-key="15176:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">各种 ZooKeeper 监听器</span></span></span></span><span data-slate-object="text" data-key="15177"><span data-slate-leaf="true" data-offset-key="15177:0" data-first-offset="true"><span data-slate-string="true">：定义 ZooKeeper 监听器，去监听 ZooKeeper 中各个节点的变更。今天，我们重点关注监听 /controller 节点的那个监听器。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15178"><span data-slate-object="text" data-key="15179"><span data-slate-leaf="true" data-offset-key="15179:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaController Class</span></span></span></span><span data-slate-object="text" data-key="15180"><span data-slate-leaf="true" data-offset-key="15180:0" data-first-offset="true"><span data-slate-string="true">：定义 KafkaController 类以及实际的处理逻辑。这是我们今天的重点学习对象。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15181"><span data-slate-object="text" data-key="15182"><span data-slate-leaf="true" data-offset-key="15182:0" data-first-offset="true"><span data-slate-string="true">接下来，我会给你重点介绍 KafkaController 类、ZooKeeper 监听器和 Controller 选举这三大部分。在众多的 ZooKeeper 监听器中，我会详细介绍监听 Controller 变更的监听器，它也是我们了解 Controller 选举流程的核心环节。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15183" id="sr-toc-4"><span data-slate-object="text" data-key="15184"><span data-slate-leaf="true" data-offset-key="15184:0" data-first-offset="true"><span data-slate-string="true">KafkaController 类</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15185"><span data-slate-object="text" data-key="15186"><span data-slate-leaf="true" data-offset-key="15186:0" data-first-offset="true"><span data-slate-string="true">这个类大约有 1900 行代码，里面定义了非常多的变量和方法。这些方法大多是处理不同 Controller 事件的。后面讲到选举流程的时候，我会挑一些有代表性的来介绍。我希望你能举一反三，借此吃透其他方法的代码。毕竟，它们做的事情大同小异，至少代码风格非常相似。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15187"><span data-slate-object="text" data-key="15188"><span data-slate-leaf="true" data-offset-key="15188:0" data-first-offset="true"><span data-slate-string="true">在学习重要的方法之前，我们必须要先掌握 KafkaController 类的定义。接下来，我们从 4 个维度来进行学习，分别是原生字段、辅助字段、各类 ZooKeeper 监听器字段和统计字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15189"><span data-slate-object="text" data-key="15190"><span data-slate-leaf="true" data-offset-key="15190:0" data-first-offset="true"><span data-slate-string="true">弄明白了这些字段的含义之后，再去看操作这些字段的方法，会更加有的放矢，理解起来也会更加容易。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15191" id="sr-toc-5"><span data-slate-object="text" data-key="15192"><span data-slate-leaf="true" data-offset-key="15192:0" data-first-offset="true"><span data-slate-string="true">原生字段</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15193"><span data-slate-object="text" data-key="15194"><span data-slate-leaf="true" data-offset-key="15194:0" data-first-offset="true"><span data-slate-string="true">首先来看原生字段。所谓的原生字段，是指在创建一个 KafkaController 实例时，需要指定的字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15195"><span data-slate-object="text" data-key="15196"><span data-slate-leaf="true" data-offset-key="15196:0" data-first-offset="true"><span data-slate-string="true">先来看下 KafkaController 类的定义代码：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="15197"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15198"><span data-slate-object="text" data-key="15199"><span data-slate-leaf="true" data-offset-key="15199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字段含义：</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15200"><span data-slate-object="text" data-key="15201"><span data-slate-leaf="true" data-offset-key="15201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//config：Kafka 配置信息，通过它，你能拿到 Broker 端所有参数的值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15202"><span data-slate-object="text" data-key="15203"><span data-slate-leaf="true" data-offset-key="15203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//zkClient：ZooKeeper 客户端，Controller 与 ZooKeeper 的所有交互均通过该属性完成</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15204"><span data-slate-object="text" data-key="15205"><span data-slate-leaf="true" data-offset-key="15205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//time：提供时间服务 (如获取当前时间) 的工具类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15206"><span data-slate-object="text" data-key="15207"><span data-slate-leaf="true" data-offset-key="15207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//metrics：实现指标监控服务 (如创建监控指标) 的工具类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15208"><span data-slate-object="text" data-key="15209"><span data-slate-leaf="true" data-offset-key="15209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//initialBrokerInfo：Broker 节点信息，包括主机名、端口号，所用监听器等</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15210"><span data-slate-object="text" data-key="15211"><span data-slate-leaf="true" data-offset-key="15211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//initialBrokerEpoch：Broker Epoch 值，用于隔离老 Controller 发送的请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15212"><span data-slate-object="text" data-key="15213"><span data-slate-leaf="true" data-offset-key="15213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//tokenManager：实现 Delegation token 管理的工具类。Delegation token 是一种轻量级的认证机制</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15214"><span data-slate-object="text" data-key="15215"><span data-slate-leaf="true" data-offset-key="15215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//threadNamePrefix：Controller 端事件处理线程名字前缀</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15216"><span data-slate-object="text" data-key="15217"><span data-slate-leaf="true" data-offset-key="15217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="15218"><span data-slate-leaf="true" data-offset-key="15218:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15219"><span data-slate-leaf="true" data-offset-key="15219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaController</span></span></span></span><span data-slate-object="text" data-key="15220"><span data-slate-leaf="true" data-offset-key="15220:0" data-first-offset="true"><span data-slate-string="true">(val </span></span></span><span data-slate-object="text" data-key="15221"><span data-slate-leaf="true" data-offset-key="15221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">config</span></span></span></span><span data-slate-object="text" data-key="15222"><span data-slate-leaf="true" data-offset-key="15222:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15223"><span data-slate-leaf="true" data-offset-key="15223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaConfig</span></span></span></span><span data-slate-object="text" data-key="15224"><span data-slate-leaf="true" data-offset-key="15224:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15225"><span data-slate-object="text" data-key="15226"><span data-slate-leaf="true" data-offset-key="15226:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15227"><span data-slate-leaf="true" data-offset-key="15227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">zkClient</span></span></span></span><span data-slate-object="text" data-key="15228"><span data-slate-leaf="true" data-offset-key="15228:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15229"><span data-slate-leaf="true" data-offset-key="15229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaZkClient</span></span></span></span><span data-slate-object="text" data-key="15230"><span data-slate-leaf="true" data-offset-key="15230:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15231"><span data-slate-object="text" data-key="15232"><span data-slate-leaf="true" data-offset-key="15232:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15233"><span data-slate-leaf="true" data-offset-key="15233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">time</span></span></span></span><span data-slate-object="text" data-key="15234"><span data-slate-leaf="true" data-offset-key="15234:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15235"><span data-slate-leaf="true" data-offset-key="15235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Time</span></span></span></span><span data-slate-object="text" data-key="15236"><span data-slate-leaf="true" data-offset-key="15236:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15237"><span data-slate-object="text" data-key="15238"><span data-slate-leaf="true" data-offset-key="15238:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15239"><span data-slate-leaf="true" data-offset-key="15239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">metrics</span></span></span></span><span data-slate-object="text" data-key="15240"><span data-slate-leaf="true" data-offset-key="15240:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15241"><span data-slate-leaf="true" data-offset-key="15241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Metrics</span></span></span></span><span data-slate-object="text" data-key="15242"><span data-slate-leaf="true" data-offset-key="15242:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15243"><span data-slate-object="text" data-key="15244"><span data-slate-leaf="true" data-offset-key="15244:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15245"><span data-slate-leaf="true" data-offset-key="15245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">initialBrokerInfo</span></span></span></span><span data-slate-object="text" data-key="15246"><span data-slate-leaf="true" data-offset-key="15246:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15247"><span data-slate-leaf="true" data-offset-key="15247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerInfo</span></span></span></span><span data-slate-object="text" data-key="15248"><span data-slate-leaf="true" data-offset-key="15248:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15249"><span data-slate-object="text" data-key="15250"><span data-slate-leaf="true" data-offset-key="15250:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15251"><span data-slate-leaf="true" data-offset-key="15251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">initialBrokerEpoch</span></span></span></span><span data-slate-object="text" data-key="15252"><span data-slate-leaf="true" data-offset-key="15252:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15253"><span data-slate-leaf="true" data-offset-key="15253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Long</span></span></span></span><span data-slate-object="text" data-key="15254"><span data-slate-leaf="true" data-offset-key="15254:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15255"><span data-slate-object="text" data-key="15256"><span data-slate-leaf="true" data-offset-key="15256:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15257"><span data-slate-leaf="true" data-offset-key="15257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">tokenManager</span></span></span></span><span data-slate-object="text" data-key="15258"><span data-slate-leaf="true" data-offset-key="15258:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15259"><span data-slate-leaf="true" data-offset-key="15259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">DelegationTokenManager</span></span></span></span><span data-slate-object="text" data-key="15260"><span data-slate-leaf="true" data-offset-key="15260:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15261"><span data-slate-object="text" data-key="15262"><span data-slate-leaf="true" data-offset-key="15262:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="15263"><span data-slate-leaf="true" data-offset-key="15263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">threadNamePrefix</span></span></span></span><span data-slate-object="text" data-key="15264"><span data-slate-leaf="true" data-offset-key="15264:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15265"><span data-slate-leaf="true" data-offset-key="15265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Option</span></span></span></span><span data-slate-object="text" data-key="15266"><span data-slate-leaf="true" data-offset-key="15266:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="15267"><span data-slate-leaf="true" data-offset-key="15267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="15268"><span data-slate-leaf="true" data-offset-key="15268:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="15269"><span data-slate-leaf="true" data-offset-key="15269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">None</span></span></span></span><span data-slate-object="text" data-key="15270"><span data-slate-leaf="true" data-offset-key="15270:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15271"><span data-slate-object="text" data-key="15272"><span data-slate-leaf="true" data-offset-key="15272:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15273"><span data-slate-leaf="true" data-offset-key="15273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="15274"><span data-slate-leaf="true" data-offset-key="15274:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15275"><span data-slate-leaf="true" data-offset-key="15275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerEventProcessor</span></span></span></span><span data-slate-object="text" data-key="15276"><span data-slate-leaf="true" data-offset-key="15276:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15277"><span data-slate-leaf="true" data-offset-key="15277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">with</span></span></span></span><span data-slate-object="text" data-key="15278"><span data-slate-leaf="true" data-offset-key="15278:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15279"><span data-slate-leaf="true" data-offset-key="15279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="15280"><span data-slate-leaf="true" data-offset-key="15280:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15281"><span data-slate-leaf="true" data-offset-key="15281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">with</span></span></span></span><span data-slate-object="text" data-key="15282"><span data-slate-leaf="true" data-offset-key="15282:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15283"><span data-slate-leaf="true" data-offset-key="15283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaMetricsGroup</span></span></span></span><span data-slate-object="text" data-key="15284"><span data-slate-leaf="true" data-offset-key="15284:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15285"><span data-slate-object="text" data-key="15286"><span data-slate-leaf="true" data-offset-key="15286:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15287"><span data-slate-object="text" data-key="15288"><span data-slate-leaf="true" data-offset-key="15288:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15289"><span data-slate-object="text" data-key="15290"><span data-slate-leaf="true" data-offset-key="15290:0" data-first-offset="true"><span data-slate-string="true">就像我上节课说过的，KafkaController 实现了 ControllerEventProcessor 接口，因而也就实现了处理 Controller 事件的 process 方法。这里面比较重要的字段有 3 个。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15291"><div data-slate-type="list-line" data-slate-object="block" data-key="15292"><span data-slate-object="text" data-key="15293"><span data-slate-leaf="true" data-offset-key="15293:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">config</span></span></span></span><span data-slate-object="text" data-key="15294"><span data-slate-leaf="true" data-offset-key="15294:0" data-first-offset="true"><span data-slate-string="true">：KafkaConfig 类实例，里面封装了 Broker 端所有参数的值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15295"><span data-slate-object="text" data-key="15296"><span data-slate-leaf="true" data-offset-key="15296:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">zkClient</span></span></span></span><span data-slate-object="text" data-key="15297"><span data-slate-leaf="true" data-offset-key="15297:0" data-first-offset="true"><span data-slate-string="true">：ZooKeeper 客户端类，定义了与 ZooKeeper 交互的所有方法。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15298"><span data-slate-object="text" data-key="15299"><span data-slate-leaf="true" data-offset-key="15299:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">initialBrokerEpoch</span></span></span></span><span data-slate-object="text" data-key="15300"><span data-slate-leaf="true" data-offset-key="15300:0" data-first-offset="true"><span data-slate-string="true">：Controller 所在 Broker 的 Epoch 值。Kafka 使用它来确保 Broker 不会处理老 Controller 发来的请求。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15301"><span data-slate-object="text" data-key="15302"><span data-slate-leaf="true" data-offset-key="15302:0" data-first-offset="true"><span data-slate-string="true">其他字段要么是像 time、metrics 一样，是工具类字段，要么是像 initialBrokerInfo、tokenManager 字段一样，使用场景很有限，我就不展开讲了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15303" id="sr-toc-6"><span data-slate-object="text" data-key="15304"><span data-slate-leaf="true" data-offset-key="15304:0" data-first-offset="true"><span data-slate-string="true">辅助字段</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15305"><span data-slate-object="text" data-key="15306"><span data-slate-leaf="true" data-offset-key="15306:0" data-first-offset="true"><span data-slate-string="true">除了原生字段之外，KafkaController 还定义了很多辅助字段，帮助实现 Controller 的各类功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15307"><span data-slate-object="text" data-key="15308"><span data-slate-leaf="true" data-offset-key="15308:0" data-first-offset="true"><span data-slate-string="true">我们来看一些重要的辅助字段：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="15309"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15310"><span data-slate-object="text" data-key="15311"><span data-slate-leaf="true" data-offset-key="15311:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15312"><span data-slate-object="text" data-key="15313"><span data-slate-leaf="true" data-offset-key="15313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 集群元数据类，保存集群所有元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15314"><span data-slate-object="text" data-key="15315"><span data-slate-leaf="true" data-offset-key="15315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15316"><span data-slate-leaf="true" data-offset-key="15316:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15317"><span data-slate-leaf="true" data-offset-key="15317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerContext</span></span></span></span><span data-slate-object="text" data-key="15318"><span data-slate-leaf="true" data-offset-key="15318:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15319"><span data-slate-leaf="true" data-offset-key="15319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15320"><span data-slate-leaf="true" data-offset-key="15320:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15321"><span data-slate-leaf="true" data-offset-key="15321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15322"><span data-slate-leaf="true" data-offset-key="15322:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15323"><span data-slate-leaf="true" data-offset-key="15323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerContext</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15324"><span data-slate-object="text" data-key="15325"><span data-slate-leaf="true" data-offset-key="15325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 端通道管理器类，负责 Controller 向 Broker 发送请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15326"><span data-slate-object="text" data-key="15327"><span data-slate-leaf="true" data-offset-key="15327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15328"><span data-slate-leaf="true" data-offset-key="15328:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15329"><span data-slate-leaf="true" data-offset-key="15329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerChannelManager</span></span></span></span><span data-slate-object="text" data-key="15330"><span data-slate-leaf="true" data-offset-key="15330:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15331"><span data-slate-leaf="true" data-offset-key="15331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15332"><span data-slate-leaf="true" data-offset-key="15332:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15333"><span data-slate-leaf="true" data-offset-key="15333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15334"><span data-slate-leaf="true" data-offset-key="15334:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15335"><span data-slate-leaf="true" data-offset-key="15335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerChannelManager</span></span></span></span><span data-slate-object="text" data-key="15336"><span data-slate-leaf="true" data-offset-key="15336:0" data-first-offset="true"><span data-slate-string="true">(controllerContext, config, time, metrics,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15337"><span data-slate-object="text" data-key="15338"><span data-slate-leaf="true" data-offset-key="15338:0" data-first-offset="true"><span data-slate-string="true">  stateChangeLogger, threadNamePrefix)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15339"><span data-slate-object="text" data-key="15340"><span data-slate-leaf="true" data-offset-key="15340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 线程调度器，当前唯一负责定期执行 Leader 重选举</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15341"><span data-slate-object="text" data-key="15342"><span data-slate-leaf="true" data-offset-key="15342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15343"><span data-slate-leaf="true" data-offset-key="15343:0" data-first-offset="true"><span data-slate-string="true">[controller] </span></span></span><span data-slate-object="text" data-key="15344"><span data-slate-leaf="true" data-offset-key="15344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15345"><span data-slate-leaf="true" data-offset-key="15345:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15346"><span data-slate-leaf="true" data-offset-key="15346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kafkaScheduler</span></span></span></span><span data-slate-object="text" data-key="15347"><span data-slate-leaf="true" data-offset-key="15347:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15348"><span data-slate-leaf="true" data-offset-key="15348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15349"><span data-slate-leaf="true" data-offset-key="15349:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15350"><span data-slate-leaf="true" data-offset-key="15350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15351"><span data-slate-leaf="true" data-offset-key="15351:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15352"><span data-slate-leaf="true" data-offset-key="15352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaScheduler</span></span></span></span><span data-slate-object="text" data-key="15353"><span data-slate-leaf="true" data-offset-key="15353:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15354"><span data-slate-leaf="true" data-offset-key="15354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15355"><span data-slate-leaf="true" data-offset-key="15355:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15356"><span data-slate-object="text" data-key="15357"><span data-slate-leaf="true" data-offset-key="15357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 事件管理器，负责管理事件处理线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15358"><span data-slate-object="text" data-key="15359"><span data-slate-leaf="true" data-offset-key="15359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15360"><span data-slate-leaf="true" data-offset-key="15360:0" data-first-offset="true"><span data-slate-string="true">[controller] </span></span></span><span data-slate-object="text" data-key="15361"><span data-slate-leaf="true" data-offset-key="15361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15362"><span data-slate-leaf="true" data-offset-key="15362:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15363"><span data-slate-leaf="true" data-offset-key="15363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">eventManager</span></span></span></span><span data-slate-object="text" data-key="15364"><span data-slate-leaf="true" data-offset-key="15364:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15365"><span data-slate-leaf="true" data-offset-key="15365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15366"><span data-slate-leaf="true" data-offset-key="15366:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15367"><span data-slate-leaf="true" data-offset-key="15367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15368"><span data-slate-leaf="true" data-offset-key="15368:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15369"><span data-slate-leaf="true" data-offset-key="15369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerEventManager</span></span></span></span><span data-slate-object="text" data-key="15370"><span data-slate-leaf="true" data-offset-key="15370:0" data-first-offset="true"><span data-slate-string="true">(config.brokerId, </span></span></span><span data-slate-object="text" data-key="15371"><span data-slate-leaf="true" data-offset-key="15371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="15372"><span data-slate-leaf="true" data-offset-key="15372:0" data-first-offset="true"><span data-slate-string="true">, time,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15373"><span data-slate-object="text" data-key="15374"><span data-slate-leaf="true" data-offset-key="15374:0" data-first-offset="true"><span data-slate-string="true">  controllerContext.stats.rateAndTimeMetrics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15375"><span data-slate-object="text" data-key="15376"><span data-slate-leaf="true" data-offset-key="15376:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15377"><span data-slate-object="text" data-key="15378"><span data-slate-leaf="true" data-offset-key="15378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 副本状态机，负责副本状态转换</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15379"><span data-slate-object="text" data-key="15380"><span data-slate-leaf="true" data-offset-key="15380:0" data-first-offset="true"><span data-slate-string="true">val replicaStateMachine: ReplicaStateMachine = </span></span></span><span data-slate-object="text" data-key="15381"><span data-slate-leaf="true" data-offset-key="15381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15382"><span data-slate-leaf="true" data-offset-key="15382:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15383"><span data-slate-leaf="true" data-offset-key="15383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZkReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="15384"><span data-slate-leaf="true" data-offset-key="15384:0" data-first-offset="true"><span data-slate-string="true">(config, stateChangeLogger, controllerContext, zkClient,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15385"><span data-slate-object="text" data-key="15386"><span data-slate-leaf="true" data-offset-key="15386:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15387"><span data-slate-leaf="true" data-offset-key="15387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15388"><span data-slate-leaf="true" data-offset-key="15388:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15389"><span data-slate-leaf="true" data-offset-key="15389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerBrokerRequestBatch</span></span></span></span><span data-slate-object="text" data-key="15390"><span data-slate-leaf="true" data-offset-key="15390:0" data-first-offset="true"><span data-slate-string="true">(config, controllerChannelManager, eventManager, controllerContext, stateChangeLogger))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15391"><span data-slate-object="text" data-key="15392"><span data-slate-leaf="true" data-offset-key="15392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分区状态机，负责分区状态转换</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15393"><span data-slate-object="text" data-key="15394"><span data-slate-leaf="true" data-offset-key="15394:0" data-first-offset="true"><span data-slate-string="true">val partitionStateMachine: PartitionStateMachine = </span></span></span><span data-slate-object="text" data-key="15395"><span data-slate-leaf="true" data-offset-key="15395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15396"><span data-slate-leaf="true" data-offset-key="15396:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15397"><span data-slate-leaf="true" data-offset-key="15397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZkPartitionStateMachine</span></span></span></span><span data-slate-object="text" data-key="15398"><span data-slate-leaf="true" data-offset-key="15398:0" data-first-offset="true"><span data-slate-string="true">(config, stateChangeLogger, controllerContext, zkClient,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15399"><span data-slate-object="text" data-key="15400"><span data-slate-leaf="true" data-offset-key="15400:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15401"><span data-slate-leaf="true" data-offset-key="15401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15402"><span data-slate-leaf="true" data-offset-key="15402:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15403"><span data-slate-leaf="true" data-offset-key="15403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerBrokerRequestBatch</span></span></span></span><span data-slate-object="text" data-key="15404"><span data-slate-leaf="true" data-offset-key="15404:0" data-first-offset="true"><span data-slate-string="true">(config, controllerChannelManager, eventManager, controllerContext, stateChangeLogger))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15405"><span data-slate-object="text" data-key="15406"><span data-slate-leaf="true" data-offset-key="15406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题删除管理器，负责删除主题及日志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15407"><span data-slate-object="text" data-key="15408"><span data-slate-leaf="true" data-offset-key="15408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15409"><span data-slate-leaf="true" data-offset-key="15409:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15410"><span data-slate-leaf="true" data-offset-key="15410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicDeletionManager</span></span></span></span><span data-slate-object="text" data-key="15411"><span data-slate-leaf="true" data-offset-key="15411:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15412"><span data-slate-leaf="true" data-offset-key="15412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15413"><span data-slate-leaf="true" data-offset-key="15413:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15414"><span data-slate-leaf="true" data-offset-key="15414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15415"><span data-slate-leaf="true" data-offset-key="15415:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15416"><span data-slate-leaf="true" data-offset-key="15416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicDeletionManager</span></span></span></span><span data-slate-object="text" data-key="15417"><span data-slate-leaf="true" data-offset-key="15417:0" data-first-offset="true"><span data-slate-string="true">(config, controllerContext, replicaStateMachine,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15418"><span data-slate-object="text" data-key="15419"><span data-slate-leaf="true" data-offset-key="15419:0" data-first-offset="true"><span data-slate-string="true">  partitionStateMachine, </span></span></span><span data-slate-object="text" data-key="15420"><span data-slate-leaf="true" data-offset-key="15420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15421"><span data-slate-leaf="true" data-offset-key="15421:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15422"><span data-slate-leaf="true" data-offset-key="15422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerDeletionClient</span></span></span></span><span data-slate-object="text" data-key="15423"><span data-slate-leaf="true" data-offset-key="15423:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15424"><span data-slate-leaf="true" data-offset-key="15424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="15425"><span data-slate-leaf="true" data-offset-key="15425:0" data-first-offset="true"><span data-slate-string="true">, zkClient))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15426"><span data-slate-object="text" data-key="15427"><span data-slate-leaf="true" data-offset-key="15427:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15428"><span data-slate-object="text" data-key="15429"><span data-slate-leaf="true" data-offset-key="15429:0" data-first-offset="true"><span data-slate-string="true">其中，有 7 个字段是重中之重。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15430"><div data-slate-type="list-line" data-slate-object="block" data-key="15431"><span data-slate-object="text" data-key="15432"><span data-slate-leaf="true" data-offset-key="15432:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">controllerContext</span></span></span></span><span data-slate-object="text" data-key="15433"><span data-slate-leaf="true" data-offset-key="15433:0" data-first-offset="true"><span data-slate-string="true">：集群元数据类，保存集群所有元数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15434"><span data-slate-object="text" data-key="15435"><span data-slate-leaf="true" data-offset-key="15435:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">controllerChannelManager</span></span></span></span><span data-slate-object="text" data-key="15436"><span data-slate-leaf="true" data-offset-key="15436:0" data-first-offset="true"><span data-slate-string="true">：Controller 端通道管理器类，负责 Controller 向 Broker 发送请求。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15437"><span data-slate-object="text" data-key="15438"><span data-slate-leaf="true" data-offset-key="15438:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">kafkaScheduler</span></span></span></span><span data-slate-object="text" data-key="15439"><span data-slate-leaf="true" data-offset-key="15439:0" data-first-offset="true"><span data-slate-string="true">：线程调度器，当前唯一负责定期执行分区重平衡 Leader 选举。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15440"><span data-slate-object="text" data-key="15441"><span data-slate-leaf="true" data-offset-key="15441:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">eventManager</span></span></span></span><span data-slate-object="text" data-key="15442"><span data-slate-leaf="true" data-offset-key="15442:0" data-first-offset="true"><span data-slate-string="true">：Controller 事件管理器，负责管理事件处理线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15443"><span data-slate-object="text" data-key="15444"><span data-slate-leaf="true" data-offset-key="15444:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">replicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="15445"><span data-slate-leaf="true" data-offset-key="15445:0" data-first-offset="true"><span data-slate-string="true">：副本状态机，负责副本状态转换。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15446"><span data-slate-object="text" data-key="15447"><span data-slate-leaf="true" data-offset-key="15447:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">partitionStateMachine</span></span></span></span><span data-slate-object="text" data-key="15448"><span data-slate-leaf="true" data-offset-key="15448:0" data-first-offset="true"><span data-slate-string="true">：分区状态机，负责分区状态转换。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15449"><span data-slate-object="text" data-key="15450"><span data-slate-leaf="true" data-offset-key="15450:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">topicDeletionManager</span></span></span></span><span data-slate-object="text" data-key="15451"><span data-slate-leaf="true" data-offset-key="15451:0" data-first-offset="true"><span data-slate-string="true">：主题删除管理器，负责删除主题及日志。</span></span></span></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15452" id="sr-toc-7"><span data-slate-object="text" data-key="15453"><span data-slate-leaf="true" data-offset-key="15453:0" data-first-offset="true"><span data-slate-string="true">各类 ZooKeeper 监听器</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15454"><span data-slate-object="text" data-key="15455"><span data-slate-leaf="true" data-offset-key="15455:0" data-first-offset="true"><span data-slate-string="true">我们今天开头学到的 ControllerChangeHandler 仅仅是其中的一种。实际上，该类定义了很多监听器，如下所示：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="15456"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15457"><span data-slate-object="text" data-key="15458"><span data-slate-leaf="true" data-offset-key="15458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 节点 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15459"><span data-slate-object="text" data-key="15460"><span data-slate-leaf="true" data-offset-key="15460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15461"><span data-slate-leaf="true" data-offset-key="15461:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15462"><span data-slate-leaf="true" data-offset-key="15462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15463"><span data-slate-leaf="true" data-offset-key="15463:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15464"><span data-slate-leaf="true" data-offset-key="15464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15465"><span data-slate-leaf="true" data-offset-key="15465:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15466"><span data-slate-leaf="true" data-offset-key="15466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15467"><span data-slate-leaf="true" data-offset-key="15467:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15468"><span data-slate-leaf="true" data-offset-key="15468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15469"><span data-slate-leaf="true" data-offset-key="15469:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15470"><span data-slate-leaf="true" data-offset-key="15470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15471"><span data-slate-leaf="true" data-offset-key="15471:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15472"><span data-slate-object="text" data-key="15473"><span data-slate-leaf="true" data-offset-key="15473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Broker 数量 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15474"><span data-slate-object="text" data-key="15475"><span data-slate-leaf="true" data-offset-key="15475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15476"><span data-slate-leaf="true" data-offset-key="15476:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15477"><span data-slate-leaf="true" data-offset-key="15477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15478"><span data-slate-leaf="true" data-offset-key="15478:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15479"><span data-slate-leaf="true" data-offset-key="15479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15480"><span data-slate-leaf="true" data-offset-key="15480:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15481"><span data-slate-leaf="true" data-offset-key="15481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15482"><span data-slate-leaf="true" data-offset-key="15482:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15483"><span data-slate-leaf="true" data-offset-key="15483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15484"><span data-slate-leaf="true" data-offset-key="15484:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15485"><span data-slate-leaf="true" data-offset-key="15485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15486"><span data-slate-leaf="true" data-offset-key="15486:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15487"><span data-slate-object="text" data-key="15488"><span data-slate-leaf="true" data-offset-key="15488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Broker 信息变更 ZooKeeper 监听器集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15489"><span data-slate-object="text" data-key="15490"><span data-slate-leaf="true" data-offset-key="15490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15491"><span data-slate-leaf="true" data-offset-key="15491:0" data-first-offset="true"><span data-slate-string="true"> val brokerModificationsHandlers: mutable.Map[Int, BrokerModificationsHandler] = mutable.Map.empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15492"><span data-slate-object="text" data-key="15493"><span data-slate-leaf="true" data-offset-key="15493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题数量 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15494"><span data-slate-object="text" data-key="15495"><span data-slate-leaf="true" data-offset-key="15495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15496"><span data-slate-leaf="true" data-offset-key="15496:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15497"><span data-slate-leaf="true" data-offset-key="15497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15498"><span data-slate-leaf="true" data-offset-key="15498:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15499"><span data-slate-leaf="true" data-offset-key="15499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15500"><span data-slate-leaf="true" data-offset-key="15500:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15501"><span data-slate-leaf="true" data-offset-key="15501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15502"><span data-slate-leaf="true" data-offset-key="15502:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15503"><span data-slate-leaf="true" data-offset-key="15503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15504"><span data-slate-leaf="true" data-offset-key="15504:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15505"><span data-slate-leaf="true" data-offset-key="15505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15506"><span data-slate-leaf="true" data-offset-key="15506:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15507"><span data-slate-object="text" data-key="15508"><span data-slate-leaf="true" data-offset-key="15508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题删除 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15509"><span data-slate-object="text" data-key="15510"><span data-slate-leaf="true" data-offset-key="15510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15511"><span data-slate-leaf="true" data-offset-key="15511:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15512"><span data-slate-leaf="true" data-offset-key="15512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15513"><span data-slate-leaf="true" data-offset-key="15513:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15514"><span data-slate-leaf="true" data-offset-key="15514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicDeletionHandler</span></span></span></span><span data-slate-object="text" data-key="15515"><span data-slate-leaf="true" data-offset-key="15515:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15516"><span data-slate-leaf="true" data-offset-key="15516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15517"><span data-slate-leaf="true" data-offset-key="15517:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15518"><span data-slate-leaf="true" data-offset-key="15518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15519"><span data-slate-leaf="true" data-offset-key="15519:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15520"><span data-slate-leaf="true" data-offset-key="15520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicDeletionHandler</span></span></span></span><span data-slate-object="text" data-key="15521"><span data-slate-leaf="true" data-offset-key="15521:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15522"><span data-slate-object="text" data-key="15523"><span data-slate-leaf="true" data-offset-key="15523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题分区变更 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15524"><span data-slate-object="text" data-key="15525"><span data-slate-leaf="true" data-offset-key="15525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15526"><span data-slate-leaf="true" data-offset-key="15526:0" data-first-offset="true"><span data-slate-string="true"> val partitionModificationsHandlers: mutable.Map[String, PartitionModificationsHandler] = mutable.Map.empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15527"><span data-slate-object="text" data-key="15528"><span data-slate-leaf="true" data-offset-key="15528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题分区重分配 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15529"><span data-slate-object="text" data-key="15530"><span data-slate-leaf="true" data-offset-key="15530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15531"><span data-slate-leaf="true" data-offset-key="15531:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15532"><span data-slate-leaf="true" data-offset-key="15532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15533"><span data-slate-leaf="true" data-offset-key="15533:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15534"><span data-slate-leaf="true" data-offset-key="15534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionReassignmentHandler</span></span></span></span><span data-slate-object="text" data-key="15535"><span data-slate-leaf="true" data-offset-key="15535:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15536"><span data-slate-leaf="true" data-offset-key="15536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15537"><span data-slate-leaf="true" data-offset-key="15537:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15538"><span data-slate-leaf="true" data-offset-key="15538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15539"><span data-slate-leaf="true" data-offset-key="15539:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15540"><span data-slate-leaf="true" data-offset-key="15540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">PartitionReassignmentHandler</span></span></span></span><span data-slate-object="text" data-key="15541"><span data-slate-leaf="true" data-offset-key="15541:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15542"><span data-slate-object="text" data-key="15543"><span data-slate-leaf="true" data-offset-key="15543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Preferred Leader 选举 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15544"><span data-slate-object="text" data-key="15545"><span data-slate-leaf="true" data-offset-key="15545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15546"><span data-slate-leaf="true" data-offset-key="15546:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15547"><span data-slate-leaf="true" data-offset-key="15547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15548"><span data-slate-leaf="true" data-offset-key="15548:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15549"><span data-slate-leaf="true" data-offset-key="15549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">preferredReplicaElectionHandler</span></span></span></span><span data-slate-object="text" data-key="15550"><span data-slate-leaf="true" data-offset-key="15550:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15551"><span data-slate-leaf="true" data-offset-key="15551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15552"><span data-slate-leaf="true" data-offset-key="15552:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15553"><span data-slate-leaf="true" data-offset-key="15553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15554"><span data-slate-leaf="true" data-offset-key="15554:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15555"><span data-slate-leaf="true" data-offset-key="15555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">PreferredReplicaElectionHandler</span></span></span></span><span data-slate-object="text" data-key="15556"><span data-slate-leaf="true" data-offset-key="15556:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15557"><span data-slate-object="text" data-key="15558"><span data-slate-leaf="true" data-offset-key="15558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ISR 副本集合变更 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15559"><span data-slate-object="text" data-key="15560"><span data-slate-leaf="true" data-offset-key="15560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15561"><span data-slate-leaf="true" data-offset-key="15561:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15562"><span data-slate-leaf="true" data-offset-key="15562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15563"><span data-slate-leaf="true" data-offset-key="15563:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15564"><span data-slate-leaf="true" data-offset-key="15564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">isrChangeNotificationHandler</span></span></span></span><span data-slate-object="text" data-key="15565"><span data-slate-leaf="true" data-offset-key="15565:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15566"><span data-slate-leaf="true" data-offset-key="15566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15567"><span data-slate-leaf="true" data-offset-key="15567:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15568"><span data-slate-leaf="true" data-offset-key="15568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15569"><span data-slate-leaf="true" data-offset-key="15569:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15570"><span data-slate-leaf="true" data-offset-key="15570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">IsrChangeNotificationHandler</span></span></span></span><span data-slate-object="text" data-key="15571"><span data-slate-leaf="true" data-offset-key="15571:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15572"><span data-slate-object="text" data-key="15573"><span data-slate-leaf="true" data-offset-key="15573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 日志路径变更 ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15574"><span data-slate-object="text" data-key="15575"><span data-slate-leaf="true" data-offset-key="15575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15576"><span data-slate-leaf="true" data-offset-key="15576:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15577"><span data-slate-leaf="true" data-offset-key="15577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15578"><span data-slate-leaf="true" data-offset-key="15578:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15579"><span data-slate-leaf="true" data-offset-key="15579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logDirEventNotificationHandler</span></span></span></span><span data-slate-object="text" data-key="15580"><span data-slate-leaf="true" data-offset-key="15580:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15581"><span data-slate-leaf="true" data-offset-key="15581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15582"><span data-slate-leaf="true" data-offset-key="15582:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15583"><span data-slate-leaf="true" data-offset-key="15583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15584"><span data-slate-leaf="true" data-offset-key="15584:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15585"><span data-slate-leaf="true" data-offset-key="15585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">LogDirEventNotificationHandler</span></span></span></span><span data-slate-object="text" data-key="15586"><span data-slate-leaf="true" data-offset-key="15586:0" data-first-offset="true"><span data-slate-string="true">(eventManager)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15587"><span data-slate-object="text" data-key="15588"><span data-slate-leaf="true" data-offset-key="15588:0" data-first-offset="true"><span data-slate-string="true">我分别解释一下这些 ZooKeeper 监听器的作用：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15589"><div data-slate-type="list-line" data-slate-object="block" data-key="15590"><span data-slate-object="text" data-key="15591"><span data-slate-leaf="true" data-offset-key="15591:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">controllerChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15592"><span data-slate-leaf="true" data-offset-key="15592:0" data-first-offset="true"><span data-slate-string="true">：前面说过，它是监听 /controller 节点变更的。这种变更包括节点创建、删除以及数据变更。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15593"><span data-slate-object="text" data-key="15594"><span data-slate-leaf="true" data-offset-key="15594:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15595"><span data-slate-leaf="true" data-offset-key="15595:0" data-first-offset="true"><span data-slate-string="true">：监听 Broker 的数量变化。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15596"><span data-slate-object="text" data-key="15597"><span data-slate-leaf="true" data-offset-key="15597:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerModificationsHandlers</span></span></span></span><span data-slate-object="text" data-key="15598"><span data-slate-leaf="true" data-offset-key="15598:0" data-first-offset="true"><span data-slate-string="true">：监听 Broker 的数据变更，比如 Broker 的配置信息发生的变化。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15599"><span data-slate-object="text" data-key="15600"><span data-slate-leaf="true" data-offset-key="15600:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">topicChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15601"><span data-slate-leaf="true" data-offset-key="15601:0" data-first-offset="true"><span data-slate-string="true">：监控主题数量变更。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15602"><span data-slate-object="text" data-key="15603"><span data-slate-leaf="true" data-offset-key="15603:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">topicDeletionHandler</span></span></span></span><span data-slate-object="text" data-key="15604"><span data-slate-leaf="true" data-offset-key="15604:0" data-first-offset="true"><span data-slate-string="true">：监听主题删除节点 /admin/delete_topics 的子节点数量变更。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15605"><span data-slate-object="text" data-key="15606"><span data-slate-leaf="true" data-offset-key="15606:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">partitionModificationsHandlers</span></span></span></span><span data-slate-object="text" data-key="15607"><span data-slate-leaf="true" data-offset-key="15607:0" data-first-offset="true"><span data-slate-string="true">：监控主题分区数据变更的监听器，比如，新增加了副本、分区更换了 Leader 副本。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15608"><span data-slate-object="text" data-key="15609"><span data-slate-leaf="true" data-offset-key="15609:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">partitionReassignmentHandler</span></span></span></span><span data-slate-object="text" data-key="15610"><span data-slate-leaf="true" data-offset-key="15610:0" data-first-offset="true"><span data-slate-string="true">：监听分区副本重分配任务。一旦发现新提交的任务，就为目标分区执行副本重分配。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15611"><span data-slate-object="text" data-key="15612"><span data-slate-leaf="true" data-offset-key="15612:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">preferredReplicaElectionHandler</span></span></span></span><span data-slate-object="text" data-key="15613"><span data-slate-leaf="true" data-offset-key="15613:0" data-first-offset="true"><span data-slate-string="true">：监听 Preferred Leader 选举任务。一旦发现新提交的任务，就为目标主题执行 Preferred Leader 选举。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15614"><span data-slate-object="text" data-key="15615"><span data-slate-leaf="true" data-offset-key="15615:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">isrChangeNotificationHandler</span></span></span></span><span data-slate-object="text" data-key="15616"><span data-slate-leaf="true" data-offset-key="15616:0" data-first-offset="true"><span data-slate-string="true">：监听 ISR 副本集合变更。一旦被触发，就需要获取 ISR 发生变更的分区列表，然后更新 Controller 端对应的 Leader 和 ISR 缓存元数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15617"><span data-slate-object="text" data-key="15618"><span data-slate-leaf="true" data-offset-key="15618:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">logDirEventNotificationHandler</span></span></span></span><span data-slate-object="text" data-key="15619"><span data-slate-leaf="true" data-offset-key="15619:0" data-first-offset="true"><span data-slate-string="true">：监听日志路径变更。一旦被触发，需要获取受影响的 Broker 列表，然后处理这些 Broker 上失效的日志路径。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15620"><span data-slate-object="text" data-key="15621"><span data-slate-leaf="true" data-offset-key="15621:0" data-first-offset="true"><span data-slate-string="true">我画了一张脑图，希望可以帮助你更高效地记住这些 ZooKeeper 监听器：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15622"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/8f/31/8feed623165ab6e50b31614e67498c31.jpg?wh=2250*2963"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15623" id="sr-toc-8"><span data-slate-object="text" data-key="15624"><span data-slate-leaf="true" data-offset-key="15624:0" data-first-offset="true"><span data-slate-string="true">统计字段</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15625"><span data-slate-object="text" data-key="15626"><span data-slate-leaf="true" data-offset-key="15626:0" data-first-offset="true"><span data-slate-string="true">最后，我们来看统计字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15627"><span data-slate-object="text" data-key="15628"><span data-slate-leaf="true" data-offset-key="15628:0" data-first-offset="true"><span data-slate-string="true">这些统计字段大多用于计算统计指标。有的监控指标甚至是非常重要的 Controller 监控项，比如 ActiveControllerCount 指标。下面，我们来了解下 KafkaController 都定义了哪些统计字段。这些指标的含义一目了然，非常清晰，我用注释的方式给出每个字段的含义：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="15629"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15630"><span data-slate-object="text" data-key="15631"><span data-slate-leaf="true" data-offset-key="15631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前 Controller 所在 Broker Id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15632"><span data-slate-object="text" data-key="15633"><span data-slate-leaf="true" data-offset-key="15633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15634"><span data-slate-leaf="true" data-offset-key="15634:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15635"><span data-slate-leaf="true" data-offset-key="15635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15636"><span data-slate-leaf="true" data-offset-key="15636:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15637"><span data-slate-leaf="true" data-offset-key="15637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15638"><span data-slate-leaf="true" data-offset-key="15638:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15639"><span data-slate-leaf="true" data-offset-key="15639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">activeControllerId</span></span></span></span><span data-slate-object="text" data-key="15640"><span data-slate-leaf="true" data-offset-key="15640:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15641"><span data-slate-leaf="true" data-offset-key="15641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15642"><span data-slate-leaf="true" data-offset-key="15642:0" data-first-offset="true"><span data-slate-string="true"> -</span></span></span><span data-slate-object="text" data-key="15643"><span data-slate-leaf="true" data-offset-key="15643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15644"><span data-slate-object="text" data-key="15645"><span data-slate-leaf="true" data-offset-key="15645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 离线分区总数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15646"><span data-slate-object="text" data-key="15647"><span data-slate-leaf="true" data-offset-key="15647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15648"><span data-slate-leaf="true" data-offset-key="15648:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15649"><span data-slate-leaf="true" data-offset-key="15649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15650"><span data-slate-leaf="true" data-offset-key="15650:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15651"><span data-slate-leaf="true" data-offset-key="15651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15652"><span data-slate-leaf="true" data-offset-key="15652:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15653"><span data-slate-leaf="true" data-offset-key="15653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">offlinePartitionCount</span></span></span></span><span data-slate-object="text" data-key="15654"><span data-slate-leaf="true" data-offset-key="15654:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15655"><span data-slate-leaf="true" data-offset-key="15655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15656"><span data-slate-leaf="true" data-offset-key="15656:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15657"><span data-slate-leaf="true" data-offset-key="15657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15658"><span data-slate-object="text" data-key="15659"><span data-slate-leaf="true" data-offset-key="15659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 满足 Preferred Leader 选举条件的总分区数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15660"><span data-slate-object="text" data-key="15661"><span data-slate-leaf="true" data-offset-key="15661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15662"><span data-slate-leaf="true" data-offset-key="15662:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15663"><span data-slate-leaf="true" data-offset-key="15663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15664"><span data-slate-leaf="true" data-offset-key="15664:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15665"><span data-slate-leaf="true" data-offset-key="15665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15666"><span data-slate-leaf="true" data-offset-key="15666:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15667"><span data-slate-leaf="true" data-offset-key="15667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">preferredReplicaImbalanceCount</span></span></span></span><span data-slate-object="text" data-key="15668"><span data-slate-leaf="true" data-offset-key="15668:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15669"><span data-slate-leaf="true" data-offset-key="15669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15670"><span data-slate-leaf="true" data-offset-key="15670:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15671"><span data-slate-leaf="true" data-offset-key="15671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15672"><span data-slate-object="text" data-key="15673"><span data-slate-leaf="true" data-offset-key="15673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 总主题数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15674"><span data-slate-object="text" data-key="15675"><span data-slate-leaf="true" data-offset-key="15675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15676"><span data-slate-leaf="true" data-offset-key="15676:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15677"><span data-slate-leaf="true" data-offset-key="15677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15678"><span data-slate-leaf="true" data-offset-key="15678:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15679"><span data-slate-leaf="true" data-offset-key="15679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15680"><span data-slate-leaf="true" data-offset-key="15680:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15681"><span data-slate-leaf="true" data-offset-key="15681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">globalTopicCount</span></span></span></span><span data-slate-object="text" data-key="15682"><span data-slate-leaf="true" data-offset-key="15682:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15683"><span data-slate-leaf="true" data-offset-key="15683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15684"><span data-slate-leaf="true" data-offset-key="15684:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15685"><span data-slate-leaf="true" data-offset-key="15685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15686"><span data-slate-object="text" data-key="15687"><span data-slate-leaf="true" data-offset-key="15687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 总主题分区数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15688"><span data-slate-object="text" data-key="15689"><span data-slate-leaf="true" data-offset-key="15689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15690"><span data-slate-leaf="true" data-offset-key="15690:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15691"><span data-slate-leaf="true" data-offset-key="15691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15692"><span data-slate-leaf="true" data-offset-key="15692:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15693"><span data-slate-leaf="true" data-offset-key="15693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15694"><span data-slate-leaf="true" data-offset-key="15694:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15695"><span data-slate-leaf="true" data-offset-key="15695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">globalPartitionCount</span></span></span></span><span data-slate-object="text" data-key="15696"><span data-slate-leaf="true" data-offset-key="15696:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15697"><span data-slate-leaf="true" data-offset-key="15697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15698"><span data-slate-leaf="true" data-offset-key="15698:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15699"><span data-slate-leaf="true" data-offset-key="15699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15700"><span data-slate-object="text" data-key="15701"><span data-slate-leaf="true" data-offset-key="15701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 待删除主题数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15702"><span data-slate-object="text" data-key="15703"><span data-slate-leaf="true" data-offset-key="15703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15704"><span data-slate-leaf="true" data-offset-key="15704:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15705"><span data-slate-leaf="true" data-offset-key="15705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15706"><span data-slate-leaf="true" data-offset-key="15706:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15707"><span data-slate-leaf="true" data-offset-key="15707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15708"><span data-slate-leaf="true" data-offset-key="15708:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15709"><span data-slate-leaf="true" data-offset-key="15709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicsToDeleteCount</span></span></span></span><span data-slate-object="text" data-key="15710"><span data-slate-leaf="true" data-offset-key="15710:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15711"><span data-slate-leaf="true" data-offset-key="15711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15712"><span data-slate-leaf="true" data-offset-key="15712:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15713"><span data-slate-leaf="true" data-offset-key="15713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15714"><span data-slate-object="text" data-key="15715"><span data-slate-leaf="true" data-offset-key="15715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 待删除副本数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15716"><span data-slate-object="text" data-key="15717"><span data-slate-leaf="true" data-offset-key="15717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15718"><span data-slate-leaf="true" data-offset-key="15718:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15719"><span data-slate-leaf="true" data-offset-key="15719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15720"><span data-slate-leaf="true" data-offset-key="15720:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15721"><span data-slate-leaf="true" data-offset-key="15721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15722"><span data-slate-leaf="true" data-offset-key="15722:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15723"><span data-slate-leaf="true" data-offset-key="15723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicasToDeleteCount</span></span></span></span><span data-slate-object="text" data-key="15724"><span data-slate-leaf="true" data-offset-key="15724:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15725"><span data-slate-leaf="true" data-offset-key="15725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15726"><span data-slate-leaf="true" data-offset-key="15726:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15727"><span data-slate-leaf="true" data-offset-key="15727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15728"><span data-slate-object="text" data-key="15729"><span data-slate-leaf="true" data-offset-key="15729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 暂时无法删除的主题数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15730"><span data-slate-object="text" data-key="15731"><span data-slate-leaf="true" data-offset-key="15731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15732"><span data-slate-leaf="true" data-offset-key="15732:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15733"><span data-slate-leaf="true" data-offset-key="15733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15734"><span data-slate-leaf="true" data-offset-key="15734:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15735"><span data-slate-leaf="true" data-offset-key="15735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15736"><span data-slate-leaf="true" data-offset-key="15736:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15737"><span data-slate-leaf="true" data-offset-key="15737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ineligibleTopicsToDeleteCount</span></span></span></span><span data-slate-object="text" data-key="15738"><span data-slate-leaf="true" data-offset-key="15738:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15739"><span data-slate-leaf="true" data-offset-key="15739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15740"><span data-slate-leaf="true" data-offset-key="15740:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15741"><span data-slate-leaf="true" data-offset-key="15741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15742"><span data-slate-object="text" data-key="15743"><span data-slate-leaf="true" data-offset-key="15743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 暂时无法删除的副本数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15744"><span data-slate-object="text" data-key="15745"><span data-slate-leaf="true" data-offset-key="15745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="15746"><span data-slate-leaf="true" data-offset-key="15746:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15747"><span data-slate-leaf="true" data-offset-key="15747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15748"><span data-slate-leaf="true" data-offset-key="15748:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15749"><span data-slate-leaf="true" data-offset-key="15749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15750"><span data-slate-leaf="true" data-offset-key="15750:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15751"><span data-slate-leaf="true" data-offset-key="15751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ineligibleReplicasToDeleteCount</span></span></span></span><span data-slate-object="text" data-key="15752"><span data-slate-leaf="true" data-offset-key="15752:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15753"><span data-slate-leaf="true" data-offset-key="15753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15754"><span data-slate-leaf="true" data-offset-key="15754:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15755"><span data-slate-leaf="true" data-offset-key="15755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15756"><span data-slate-object="text" data-key="15757"><span data-slate-leaf="true" data-offset-key="15757:0" data-first-offset="true"><span data-slate-string="true">好了，KafkaController 类的定义我们就全部介绍完了。再次强调下，因为 KafkaController 类的代码很多，我强烈建议你熟练掌握这些字段的含义，因为后面的所有方法都是围绕着这些字段进行操作的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15758"><span data-slate-object="text" data-key="15759"><span data-slate-leaf="true" data-offset-key="15759:0" data-first-offset="true"><span data-slate-string="true">接下来，我以 Controller 的选举流程为例，引出 KafkaController 的一些方法的实现原理。不过，在此之前，我们要学习监听 Controller 变更的 ZooKeeper 监听器：ControllerChangeHandler 的源码。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15760" id="sr-toc-9"><span data-slate-object="text" data-key="15761"><span data-slate-leaf="true" data-offset-key="15761:0" data-first-offset="true"><span data-slate-string="true">ControllerChangeHandler 监听器</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15762"><span data-slate-object="text" data-key="15763"><span data-slate-leaf="true" data-offset-key="15763:0" data-first-offset="true"><span data-slate-string="true">就像我前面说到的，KafkaController 定义了十几种 ZooKeeper 监听器。和 Controller 相关的监听器是 ControllerChangeHandler，用于监听 Controller 的变更，定义代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="15764"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15765"><span data-slate-object="text" data-key="15766"><span data-slate-leaf="true" data-offset-key="15766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="15767"><span data-slate-leaf="true" data-offset-key="15767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15768"><span data-slate-leaf="true" data-offset-key="15768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerChangeHandler</span></span></span></span></span><span data-slate-object="text" data-key="15769"><span data-slate-leaf="true" data-offset-key="15769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(eventManager: ControllerEventManager)</span></span></span></span></span><span data-slate-object="text" data-key="15770"><span data-slate-leaf="true" data-offset-key="15770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> extends ZNodeChangeHandler </span></span></span></span><span data-slate-object="text" data-key="15771"><span data-slate-leaf="true" data-offset-key="15771:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15772"><span data-slate-object="text" data-key="15773"><span data-slate-leaf="true" data-offset-key="15773:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15774"><span data-slate-leaf="true" data-offset-key="15774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ZooKeeper 中 Controller 节点路径，即 /controller</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15775"><span data-slate-object="text" data-key="15776"><span data-slate-leaf="true" data-offset-key="15776:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15777"><span data-slate-leaf="true" data-offset-key="15777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="15778"><span data-slate-leaf="true" data-offset-key="15778:0" data-first-offset="true"><span data-slate-string="true"> val path: String = ControllerZNode.path</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15779"><span data-slate-object="text" data-key="15780"><span data-slate-leaf="true" data-offset-key="15780:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15781"><span data-slate-leaf="true" data-offset-key="15781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听 /controller 节点创建事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15782"><span data-slate-object="text" data-key="15783"><span data-slate-leaf="true" data-offset-key="15783:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15784"><span data-slate-leaf="true" data-offset-key="15784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="15785"><span data-slate-leaf="true" data-offset-key="15785:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="15786"><span data-slate-leaf="true" data-offset-key="15786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleCreation</span></span></span></span><span data-slate-object="text" data-key="15787"><span data-slate-leaf="true" data-offset-key="15787:0" data-first-offset="true"><span data-slate-string="true">(): Unit = eventManager.</span></span></span><span data-slate-object="text" data-key="15788"><span data-slate-leaf="true" data-offset-key="15788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="15789"><span data-slate-leaf="true" data-offset-key="15789:0" data-first-offset="true"><span data-slate-string="true">(ControllerChange)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15790"><span data-slate-object="text" data-key="15791"><span data-slate-leaf="true" data-offset-key="15791:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15792"><span data-slate-leaf="true" data-offset-key="15792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听 /controller 节点被删除事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15793"><span data-slate-object="text" data-key="15794"><span data-slate-leaf="true" data-offset-key="15794:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15795"><span data-slate-leaf="true" data-offset-key="15795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="15796"><span data-slate-leaf="true" data-offset-key="15796:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="15797"><span data-slate-leaf="true" data-offset-key="15797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleDeletion</span></span></span></span><span data-slate-object="text" data-key="15798"><span data-slate-leaf="true" data-offset-key="15798:0" data-first-offset="true"><span data-slate-string="true">(): Unit = eventManager.</span></span></span><span data-slate-object="text" data-key="15799"><span data-slate-leaf="true" data-offset-key="15799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="15800"><span data-slate-leaf="true" data-offset-key="15800:0" data-first-offset="true"><span data-slate-string="true">(Reelect)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15801"><span data-slate-object="text" data-key="15802"><span data-slate-leaf="true" data-offset-key="15802:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15803"><span data-slate-leaf="true" data-offset-key="15803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听 /controller 节点数据变更事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15804"><span data-slate-object="text" data-key="15805"><span data-slate-leaf="true" data-offset-key="15805:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15806"><span data-slate-leaf="true" data-offset-key="15806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="15807"><span data-slate-leaf="true" data-offset-key="15807:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="15808"><span data-slate-leaf="true" data-offset-key="15808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleDataChange</span></span></span></span><span data-slate-object="text" data-key="15809"><span data-slate-leaf="true" data-offset-key="15809:0" data-first-offset="true"><span data-slate-string="true">(): Unit = eventManager.</span></span></span><span data-slate-object="text" data-key="15810"><span data-slate-leaf="true" data-offset-key="15810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="15811"><span data-slate-leaf="true" data-offset-key="15811:0" data-first-offset="true"><span data-slate-string="true">(ControllerChange)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15812"><span data-slate-object="text" data-key="15813"><span data-slate-leaf="true" data-offset-key="15813:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15814"><span data-slate-object="text" data-key="15815"><span data-slate-leaf="true" data-offset-key="15815:0" data-first-offset="true"><span data-slate-string="true">该监听器接收 ControllerEventManager 实例，实现了 ZNodeChangeHandler 接口的三个方法：</span></span></span><span data-slate-object="text" data-key="15816"><span data-slate-leaf="true" data-offset-key="15816:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">handleCreation</span></span></span></span><span data-slate-object="text" data-key="15817"><span data-slate-leaf="true" data-offset-key="15817:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-object="text" data-key="15818"><span data-slate-leaf="true" data-offset-key="15818:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">handleDeletion</span></span></span></span><span data-slate-object="text" data-key="15819"><span data-slate-leaf="true" data-offset-key="15819:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><span data-slate-object="text" data-key="15820"><span data-slate-leaf="true" data-offset-key="15820:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">handleDataChange</span></span></span></span><span data-slate-object="text" data-key="15821"><span data-slate-leaf="true" data-offset-key="15821:0" data-first-offset="true"><span data-slate-string="true">。该监听器下的 path 变量，实际上就是 /controller 字符串，表示它监听 ZooKeeper 的这个节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15822"><span data-slate-object="text" data-key="15823"><span data-slate-leaf="true" data-offset-key="15823:0" data-first-offset="true"><span data-slate-string="true">3 个 handle 方法都用于监听 /controller 节点的变更，但实现细节上稍有不同。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15824"><span data-slate-object="text" data-key="15825"><span data-slate-leaf="true" data-offset-key="15825:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1bd8a354" data-attr-id="32479" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">handleCreation 和 handleDataChange 的处理方式是向事件队列写入 ControllerChange 事件；handleDeletion 的处理方式是向事件队列写入 Reelect 事件。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15826"><span data-slate-object="text" data-key="15827"><span data-slate-leaf="true" data-offset-key="15827:0" data-first-offset="true"><span data-slate-string="true">Deletion 表明 ZooKeeper 中 /controller 节点不存在了，即 Kafka 集群中的 Controller 暂时空缺了。因为它和 Creation 和 DataChange 是不同的状态，需要区别对待，因此，Reelect 事件做的事情要比 ControllerChange 的多：处理 ControllerChange 事件，只需要当前 Broker 执行 “卸任 Controller” 的逻辑即可，而 Reelect 事件是重选举，除了 Broker 执行卸任逻辑之外，还要求 Broker 参与到重选举中来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15828"><span data-slate-object="text" data-key="15829"><span data-slate-leaf="true" data-offset-key="15829:0" data-first-offset="true"><span data-slate-string="true">由于 KafkaController 的 process 方法代码非常长，因此，我节选了刚刚提到的那两个事件的处理代码：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="15830"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15831"><span data-slate-object="text" data-key="15832"><span data-slate-leaf="true" data-offset-key="15832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//process 方法 (部分)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15833"><span data-slate-object="text" data-key="15834"><span data-slate-leaf="true" data-offset-key="15834:0" data-first-offset="true"><span data-slate-string="true">override def </span></span></span><span data-slate-object="text" data-key="15835"><span data-slate-leaf="true" data-offset-key="15835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">process</span></span></span></span><span data-slate-object="text" data-key="15836"><span data-slate-leaf="true" data-offset-key="15836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(event: ControllerEvent)</span></span></span></span><span data-slate-object="text" data-key="15837"><span data-slate-leaf="true" data-offset-key="15837:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15838"><span data-slate-object="text" data-key="15839"><span data-slate-leaf="true" data-offset-key="15839:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15840"><span data-slate-leaf="true" data-offset-key="15840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="15841"><span data-slate-leaf="true" data-offset-key="15841:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15842"><span data-slate-object="text" data-key="15843"><span data-slate-leaf="true" data-offset-key="15843:0" data-first-offset="true"><span data-slate-string="true">      event match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15844"><span data-slate-object="text" data-key="15845"><span data-slate-leaf="true" data-offset-key="15845:0" data-first-offset="true"><span data-slate-string="true">       ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15846"><span data-slate-object="text" data-key="15847"><span data-slate-leaf="true" data-offset-key="15847:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="15848"><span data-slate-leaf="true" data-offset-key="15848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ControllerChange 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15849"><span data-slate-object="text" data-key="15850"><span data-slate-leaf="true" data-offset-key="15850:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="15851"><span data-slate-leaf="true" data-offset-key="15851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="15852"><span data-slate-leaf="true" data-offset-key="15852:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15853"><span data-slate-leaf="true" data-offset-key="15853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerChange</span></span></span></span><span data-slate-object="text" data-key="15854"><span data-slate-leaf="true" data-offset-key="15854:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15855"><span data-slate-leaf="true" data-offset-key="15855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15856"><span data-slate-leaf="true" data-offset-key="15856:0" data-first-offset="true"><span data-slate-string="true">&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15857"><span data-slate-object="text" data-key="15858"><span data-slate-leaf="true" data-offset-key="15858:0" data-first-offset="true"><span data-slate-string="true">          processControllerChange()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15859"><span data-slate-object="text" data-key="15860"><span data-slate-leaf="true" data-offset-key="15860:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="15861"><span data-slate-leaf="true" data-offset-key="15861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Reelect 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15862"><span data-slate-object="text" data-key="15863"><span data-slate-leaf="true" data-offset-key="15863:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="15864"><span data-slate-leaf="true" data-offset-key="15864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="15865"><span data-slate-leaf="true" data-offset-key="15865:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15866"><span data-slate-leaf="true" data-offset-key="15866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Reelect</span></span></span></span><span data-slate-object="text" data-key="15867"><span data-slate-leaf="true" data-offset-key="15867:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15868"><span data-slate-leaf="true" data-offset-key="15868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15869"><span data-slate-leaf="true" data-offset-key="15869:0" data-first-offset="true"><span data-slate-string="true">&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15870"><span data-slate-object="text" data-key="15871"><span data-slate-leaf="true" data-offset-key="15871:0" data-first-offset="true"><span data-slate-string="true">          processReelect()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15872"><span data-slate-object="text" data-key="15873"><span data-slate-leaf="true" data-offset-key="15873:0" data-first-offset="true"><span data-slate-string="true">        ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15874"><span data-slate-object="text" data-key="15875"><span data-slate-leaf="true" data-offset-key="15875:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15876"><span data-slate-object="text" data-key="15877"><span data-slate-leaf="true" data-offset-key="15877:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15878"><span data-slate-object="text" data-key="15879"><span data-slate-leaf="true" data-offset-key="15879:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15880"><span data-slate-object="text" data-key="15881"><span data-slate-leaf="true" data-offset-key="15881:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15882"><span data-slate-object="text" data-key="15883"><span data-slate-leaf="true" data-offset-key="15883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 ControllerChange 事件，仅执行卸任逻辑即可</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15884"><span data-slate-object="text" data-key="15885"><span data-slate-leaf="true" data-offset-key="15885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15886"><span data-slate-leaf="true" data-offset-key="15886:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="15887"><span data-slate-leaf="true" data-offset-key="15887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processControllerChange</span></span></span></span><span data-slate-object="text" data-key="15888"><span data-slate-leaf="true" data-offset-key="15888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="15889"><span data-slate-leaf="true" data-offset-key="15889:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15890"><span data-slate-object="text" data-key="15891"><span data-slate-leaf="true" data-offset-key="15891:0" data-first-offset="true"><span data-slate-string="true">    maybeResign()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15892"><span data-slate-object="text" data-key="15893"><span data-slate-leaf="true" data-offset-key="15893:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15894"><span data-slate-object="text" data-key="15895"><span data-slate-leaf="true" data-offset-key="15895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 Reelect 事件，还需要执行 elect 方法参与新一轮的选举</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15896"><span data-slate-object="text" data-key="15897"><span data-slate-leaf="true" data-offset-key="15897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="15898"><span data-slate-leaf="true" data-offset-key="15898:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="15899"><span data-slate-leaf="true" data-offset-key="15899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processReelect</span></span></span></span><span data-slate-object="text" data-key="15900"><span data-slate-leaf="true" data-offset-key="15900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="15901"><span data-slate-leaf="true" data-offset-key="15901:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15902"><span data-slate-object="text" data-key="15903"><span data-slate-leaf="true" data-offset-key="15903:0" data-first-offset="true"><span data-slate-string="true">    maybeResign()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15904"><span data-slate-object="text" data-key="15905"><span data-slate-leaf="true" data-offset-key="15905:0" data-first-offset="true"><span data-slate-string="true">    elect()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15906"><span data-slate-object="text" data-key="15907"><span data-slate-leaf="true" data-offset-key="15907:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15908"><span data-slate-object="text" data-key="15909"><span data-slate-leaf="true" data-offset-key="15909:0" data-first-offset="true"><span data-slate-string="true">可以看到，虽然代码非常长，但整体结构却工整清晰，全部都是基于模式匹配的事件处理。process 方法会根据给定的 Controller 事件类型，调用对应的 process*** 方法处理该事件。这里只列举了 ZooKeeper 端 /controller 节点监听器监听的两类事件，以及对应的处理方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15910"><span data-slate-object="text" data-key="15911"><span data-slate-leaf="true" data-offset-key="15911:0" data-first-offset="true"><span data-slate-string="true">对于 ControllerChange 事件而言，处理方式是调用 maybeResign 去执行 Controller 的卸任逻辑。如果是 Reelect 事件，除了执行卸任逻辑之外，还要额外执行 elect 方法进行新一轮的 Controller 选举。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15912" id="sr-toc-10"><span data-slate-object="text" data-key="15913"><span data-slate-leaf="true" data-offset-key="15913:0" data-first-offset="true"><span data-slate-string="true">Controller 选举流程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15914"><span data-slate-object="text" data-key="15915"><span data-slate-leaf="true" data-offset-key="15915:0" data-first-offset="true"><span data-slate-string="true">说完了 ControllerChangeHandler 源码，我们来看下 Controller 的选举。所谓的 Controller 选举，是指 Kafka 选择集群中一台 Broker 行使 Controller 职责。整个选举过程分为两个步骤：触发选举和开始选举。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15916" id="sr-toc-11"><span data-slate-object="text" data-key="15917"><span data-slate-leaf="true" data-offset-key="15917:0" data-first-offset="true"><span data-slate-string="true">触发选举</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15918"><span data-slate-object="text" data-key="15919"><span data-slate-leaf="true" data-offset-key="15919:0" data-first-offset="true"><span data-slate-string="true">我先用一张图展示下可能触发 Controller 选举的三个场景。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15920"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a8/98/a8cbc562518f93f9befc6bd7a87d5b98.jpg?wh=2276*2297"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15921"><span data-slate-object="text" data-key="15922"><span data-slate-leaf="true" data-offset-key="15922:0" data-first-offset="true"><span data-slate-string="true">这三个场景是：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15923"><div data-slate-type="list-line" data-slate-object="block" data-key="15924"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="15925"><span data-slate-leaf="true" data-offset-key="15925:0" data-first-offset="true"><span data-slate-string="true">集群从零启动时；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="15926"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="15927"><span data-slate-leaf="true" data-offset-key="15927:0" data-first-offset="true"><span data-slate-string="true">Broker 侦测 /controller 节点消失时；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="15928"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="15929"><span data-slate-leaf="true" data-offset-key="15929:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d50720a6" data-attr-id="32480" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Broker 侦测到 /controller 节点数据发生变更时。</span></span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15930"><span data-slate-object="text" data-key="15931"><span data-slate-leaf="true" data-offset-key="15931:0" data-first-offset="true"><span data-slate-string="true">这三个场景殊途同归，最后都要执行选举 Controller 的动作。我来一一解释下这三个场景，然后再介绍选举 Controller 的具体操作。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="15932" id="sr-toc-12"><span data-slate-object="text" data-key="15933"><span data-slate-leaf="true" data-offset-key="15933:0" data-first-offset="true"><span data-slate-string="true">场景一：集群从零启动</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="15934"><span data-slate-object="text" data-key="15935"><span data-slate-leaf="true" data-offset-key="15935:0" data-first-offset="true"><span data-slate-string="true">集群首次启动时，Controller 尚未被选举出来。于是，Broker 启动后，首先将 Startup 这个 ControllerEvent 写入到事件队列中，然后启动对应的事件处理线程和 ControllerChangeHandler ZooKeeper 监听器，最后依赖事件处理线程进行 Controller 的选举。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15936"><span data-slate-object="text" data-key="15937"><span data-slate-leaf="true" data-offset-key="15937:0" data-first-offset="true"><span data-slate-string="true">在源码中，KafkaController 类的 startup 方法就是做这些事情的。当 Broker 启动时，它会调用这个方法启动 ControllerEventThread 线程。值得注意的是，</span></span></span><span data-slate-object="text" data-key="15938"><span data-slate-leaf="true" data-offset-key="15938:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">每个 Broker 都需要做这些事情，不是说只有 Controller 所在的 Broker 才需要执行这些逻辑</span></span></span></span><span data-slate-object="text" data-key="15939"><span data-slate-leaf="true" data-offset-key="15939:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15940"><span data-slate-object="text" data-key="15941"><span data-slate-leaf="true" data-offset-key="15941:0" data-first-offset="true"><span data-slate-string="true">startup 方法的主体代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="15942"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15943"><span data-slate-object="text" data-key="15944"><span data-slate-leaf="true" data-offset-key="15944:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="15945"><span data-slate-leaf="true" data-offset-key="15945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startup</span></span></span></span><span data-slate-object="text" data-key="15946"><span data-slate-leaf="true" data-offset-key="15946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="15947"><span data-slate-leaf="true" data-offset-key="15947:0" data-first-offset="true"><span data-slate-string="true"> = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15948"><span data-slate-object="text" data-key="15949"><span data-slate-leaf="true" data-offset-key="15949:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15950"><span data-slate-leaf="true" data-offset-key="15950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：注册 ZooKeeper 状态变更监听器，它是用于监听 Zookeeper 会话过期的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15951"><span data-slate-object="text" data-key="15952"><span data-slate-leaf="true" data-offset-key="15952:0" data-first-offset="true"><span data-slate-string="true">  zkClient.registerStateChangeHandler(</span></span></span><span data-slate-object="text" data-key="15953"><span data-slate-leaf="true" data-offset-key="15953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="15954"><span data-slate-leaf="true" data-offset-key="15954:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15955"><span data-slate-leaf="true" data-offset-key="15955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StateChangeHandler</span></span></span></span><span data-slate-object="text" data-key="15956"><span data-slate-leaf="true" data-offset-key="15956:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15957"><span data-slate-object="text" data-key="15958"><span data-slate-leaf="true" data-offset-key="15958:0" data-first-offset="true"><span data-slate-string="true">    override val name: String = StateChangeHandlers.ControllerHandler</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15959"><span data-slate-object="text" data-key="15960"><span data-slate-leaf="true" data-offset-key="15960:0" data-first-offset="true"><span data-slate-string="true">    override def </span></span></span><span data-slate-object="text" data-key="15961"><span data-slate-leaf="true" data-offset-key="15961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">afterInitializingSession</span></span></span></span><span data-slate-object="text" data-key="15962"><span data-slate-leaf="true" data-offset-key="15962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="15963"><span data-slate-leaf="true" data-offset-key="15963:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15964"><span data-slate-object="text" data-key="15965"><span data-slate-leaf="true" data-offset-key="15965:0" data-first-offset="true"><span data-slate-string="true">      eventManager.put(RegisterBrokerAndReelect)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15966"><span data-slate-object="text" data-key="15967"><span data-slate-leaf="true" data-offset-key="15967:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15968"><span data-slate-object="text" data-key="15969"><span data-slate-leaf="true" data-offset-key="15969:0" data-first-offset="true"><span data-slate-string="true">    override def </span></span></span><span data-slate-object="text" data-key="15970"><span data-slate-leaf="true" data-offset-key="15970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">beforeInitializingSession</span></span></span></span><span data-slate-object="text" data-key="15971"><span data-slate-leaf="true" data-offset-key="15971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="15972"><span data-slate-leaf="true" data-offset-key="15972:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15973"><span data-slate-object="text" data-key="15974"><span data-slate-leaf="true" data-offset-key="15974:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="15975"><span data-slate-leaf="true" data-offset-key="15975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="15976"><span data-slate-leaf="true" data-offset-key="15976:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15977"><span data-slate-leaf="true" data-offset-key="15977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">queuedEvent</span></span></span></span><span data-slate-object="text" data-key="15978"><span data-slate-leaf="true" data-offset-key="15978:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15979"><span data-slate-leaf="true" data-offset-key="15979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="15980"><span data-slate-leaf="true" data-offset-key="15980:0" data-first-offset="true"><span data-slate-string="true"> eventManager.clearAndPut(Expire)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15981"><span data-slate-object="text" data-key="15982"><span data-slate-leaf="true" data-offset-key="15982:0" data-first-offset="true"><span data-slate-string="true">      queuedEvent.awaitProcessing()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15983"><span data-slate-object="text" data-key="15984"><span data-slate-leaf="true" data-offset-key="15984:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15985"><span data-slate-object="text" data-key="15986"><span data-slate-leaf="true" data-offset-key="15986:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15987"><span data-slate-object="text" data-key="15988"><span data-slate-leaf="true" data-offset-key="15988:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15989"><span data-slate-leaf="true" data-offset-key="15989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：写入 Startup 事件到事件队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15990"><span data-slate-object="text" data-key="15991"><span data-slate-leaf="true" data-offset-key="15991:0" data-first-offset="true"><span data-slate-string="true">  eventManager.put(Startup)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15992"><span data-slate-object="text" data-key="15993"><span data-slate-leaf="true" data-offset-key="15993:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15994"><span data-slate-leaf="true" data-offset-key="15994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：启动 ControllerEventThread 线程，开始处理事件队列中的 ControllerEvent</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15995"><span data-slate-object="text" data-key="15996"><span data-slate-leaf="true" data-offset-key="15996:0" data-first-offset="true"><span data-slate-string="true">  eventManager.start()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15997"><span data-slate-object="text" data-key="15998"><span data-slate-leaf="true" data-offset-key="15998:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15999"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16000"><span data-slate-object="text" data-key="16001"><span data-slate-leaf="true" data-offset-key="16001:0" data-first-offset="true"><span data-slate-string="true">首先，startup 方法会注册 ZooKeeper 状态变更监听器，用于监听 Broker 与 ZooKeeper 之间的会话是否过期。接着，写入 Startup 事件到事件队列，然后启动 ControllerEventThread 线程，开始处理事件队列中的 Startup 事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16002"><span data-slate-object="text" data-key="16003"><span data-slate-leaf="true" data-offset-key="16003:0" data-first-offset="true"><span data-slate-string="true">接下来，我们来学习下 KafkaController 的 process 方法处理 Startup 事件的方法：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16004"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16005"><span data-slate-object="text" data-key="16006"><span data-slate-leaf="true" data-offset-key="16006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// KafkaController 的 process 方法，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16007"><span data-slate-object="text" data-key="16008"><span data-slate-leaf="true" data-offset-key="16008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="16009"><span data-slate-leaf="true" data-offset-key="16009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="16010"><span data-slate-leaf="true" data-offset-key="16010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">process</span></span></span></span></span><span data-slate-object="text" data-key="16011"><span data-slate-leaf="true" data-offset-key="16011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(event: ControllerEvent)</span></span></span></span></span><span data-slate-object="text" data-key="16012"><span data-slate-leaf="true" data-offset-key="16012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="16013"><span data-slate-leaf="true" data-offset-key="16013:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16014"><span data-slate-object="text" data-key="16015"><span data-slate-leaf="true" data-offset-key="16015:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16016"><span data-slate-leaf="true" data-offset-key="16016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="16017"><span data-slate-leaf="true" data-offset-key="16017:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16018"><span data-slate-object="text" data-key="16019"><span data-slate-leaf="true" data-offset-key="16019:0" data-first-offset="true"><span data-slate-string="true">      event match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16020"><span data-slate-object="text" data-key="16021"><span data-slate-leaf="true" data-offset-key="16021:0" data-first-offset="true"><span data-slate-string="true">       ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16022"><span data-slate-object="text" data-key="16023"><span data-slate-leaf="true" data-offset-key="16023:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="16024"><span data-slate-leaf="true" data-offset-key="16024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16025"><span data-slate-leaf="true" data-offset-key="16025:0" data-first-offset="true"><span data-slate-string="true"> Startup =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16026"><span data-slate-object="text" data-key="16027"><span data-slate-leaf="true" data-offset-key="16027:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="16028"><span data-slate-leaf="true" data-offset-key="16028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processStartup</span></span></span></span><span data-slate-object="text" data-key="16029"><span data-slate-leaf="true" data-offset-key="16029:0" data-first-offset="true"><span data-slate-string="true">() </span></span></span><span data-slate-object="text" data-key="16030"><span data-slate-leaf="true" data-offset-key="16030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 Startup 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16031"><span data-slate-object="text" data-key="16032"><span data-slate-leaf="true" data-offset-key="16032:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16033"><span data-slate-object="text" data-key="16034"><span data-slate-leaf="true" data-offset-key="16034:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16035"><span data-slate-object="text" data-key="16036"><span data-slate-leaf="true" data-offset-key="16036:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16037"><span data-slate-object="text" data-key="16038"><span data-slate-leaf="true" data-offset-key="16038:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16039"><span data-slate-object="text" data-key="16040"><span data-slate-leaf="true" data-offset-key="16040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="16041"><span data-slate-leaf="true" data-offset-key="16041:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="16042"><span data-slate-leaf="true" data-offset-key="16042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processStartup</span></span></span></span><span data-slate-object="text" data-key="16043"><span data-slate-leaf="true" data-offset-key="16043:0" data-first-offset="true"><span data-slate-string="true">(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16044"><span data-slate-object="text" data-key="16045"><span data-slate-leaf="true" data-offset-key="16045:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="16046"><span data-slate-leaf="true" data-offset-key="16046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注册 ControllerChangeHandler ZooKeeper 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16047"><span data-slate-object="text" data-key="16048"><span data-slate-leaf="true" data-offset-key="16048:0" data-first-offset="true"><span data-slate-string="true">   zkClient.</span></span></span><span data-slate-object="text" data-key="16049"><span data-slate-leaf="true" data-offset-key="16049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">registerZNodeChangeHandlerAndCheckExistence</span></span></span></span><span data-slate-object="text" data-key="16050"><span data-slate-leaf="true" data-offset-key="16050:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16051"><span data-slate-object="text" data-key="16052"><span data-slate-leaf="true" data-offset-key="16052:0" data-first-offset="true"><span data-slate-string="true">    controllerChangeHandler)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16053"><span data-slate-object="text" data-key="16054"><span data-slate-leaf="true" data-offset-key="16054:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="16055"><span data-slate-leaf="true" data-offset-key="16055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行 Controller 选举</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16056"><span data-slate-object="text" data-key="16057"><span data-slate-leaf="true" data-offset-key="16057:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="16058"><span data-slate-leaf="true" data-offset-key="16058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">elect</span></span></span></span><span data-slate-object="text" data-key="16059"><span data-slate-leaf="true" data-offset-key="16059:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16060"><span data-slate-object="text" data-key="16061"><span data-slate-leaf="true" data-offset-key="16061:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16062"><span data-slate-object="text" data-key="16063"><span data-slate-leaf="true" data-offset-key="16063:0" data-first-offset="true"><span data-slate-string="true">从这段代码可知，process 方法调用 processStartup 方法去处理 Startup 事件。而 processStartup 方法又会调用 zkClient 的 registerZNodeChangeHandlerAndCheckExistence 方法注册 ControllerChangeHandler 监听器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16064"><span data-slate-object="text" data-key="16065"><span data-slate-leaf="true" data-offset-key="16065:0" data-first-offset="true"><span data-slate-string="true">值得注意的是，虽然前面的三个场景是并列的关系，但实际上，后面的两个场景必须要等场景一的这一步成功执行之后，才能被触发。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16066"><span data-slate-object="text" data-key="16067"><span data-slate-leaf="true" data-offset-key="16067:0" data-first-offset="true"><span data-slate-string="true">这三种场景都要选举 Controller，因此，我们最后统一学习 elect 方法的代码实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16068"><span data-slate-object="text" data-key="16069"><span data-slate-leaf="true" data-offset-key="16069:0" data-first-offset="true"><span data-slate-string="true">总体来说，集群启动时，Broker 通过向事件队列 “塞入” Startup 事件的方式，来触发 Controller 的竞选。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="16070" id="sr-toc-13"><span data-slate-object="text" data-key="16071"><span data-slate-leaf="true" data-offset-key="16071:0" data-first-offset="true"><span data-slate-string="true">场景二：/controller 节点消失</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="16072"><span data-slate-object="text" data-key="16073"><span data-slate-leaf="true" data-offset-key="16073:0" data-first-offset="true"><span data-slate-string="true">Broker 检测到 /controller 节点消失时，就意味着，此时整个集群中没有 Controller。因此，所有检测到 /controller 节点消失的 Broker，都会立即调用 elect 方法执行竞选逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16074"><span data-slate-object="text" data-key="16075"><span data-slate-leaf="true" data-offset-key="16075:0" data-first-offset="true"><span data-slate-string="true">你可能会问：“Broker 是怎么侦测到 ZooKeeper 上的这一变化的呢？” 实际上，这是 ZooKeeper 监听器提供的功能，换句话说，这是 Apache ZooKeeper 自己实现的功能，所以我们才说，Kafka 依赖 ZooKeeper 完成 Controller 的选举。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16076"><span data-slate-object="text" data-key="16077"><span data-slate-leaf="true" data-offset-key="16077:0" data-first-offset="true"><span data-slate-string="true">讲到这里，我说点题外话，社区最近正在酝酿彻底移除 ZooKeeper 依赖。具体到 Controller 端的变化，就是在 Kafka 内部实现一个类似于 Raft 的共识算法来选举 Controller。我会在后面的特别放送里详细讲一下社区移除 ZooKeeper 的全盘计划。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="16078" id="sr-toc-14"><span data-slate-object="text" data-key="16079"><span data-slate-leaf="true" data-offset-key="16079:0" data-first-offset="true"><span data-slate-string="true">场景三：/controller 节点数据变更</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="16080"><span data-slate-object="text" data-key="16081"><span data-slate-leaf="true" data-offset-key="16081:0" data-first-offset="true"><span data-slate-string="true">Broker 检测到 /controller 节点数据发生变化，通常表明，Controller “易主” 了，这就分为两种情况：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16082"><div data-slate-type="list-line" data-slate-object="block" data-key="16083"><span data-slate-object="text" data-key="16084"><span data-slate-leaf="true" data-offset-key="16084:0" data-first-offset="true"><span data-slate-string="true">如果 Broker 之前是 Controller，那么该 Broker 需要首先执行卸任操作，然后再尝试竞选；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16085"><span data-slate-object="text" data-key="16086"><span data-slate-leaf="true" data-offset-key="16086:0" data-first-offset="true"><span data-slate-string="true">如果 Broker 之前不是 Controller，那么，该 Broker 直接去竞选新 Controller。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16087"><span data-slate-object="text" data-key="16088"><span data-slate-leaf="true" data-offset-key="16088:0" data-first-offset="true"><span data-slate-string="true">具体到代码层面，maybeResign 方法形象地说明了这两种情况。你要注意方法中的 maybe 字样，这表明，Broker 可能需要执行卸任操作，也可能不需要。Kafka 源码非常喜欢用 maybe*** 来命名方法名，以表示那些在特定条件下才需要执行的逻辑。以下是 maybeResign 的实现：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="16089"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16090"><span data-slate-object="text" data-key="16091"><span data-slate-leaf="true" data-offset-key="16091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="16092"><span data-slate-leaf="true" data-offset-key="16092:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="16093"><span data-slate-leaf="true" data-offset-key="16093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maybeResign</span></span></span></span><span data-slate-object="text" data-key="16094"><span data-slate-leaf="true" data-offset-key="16094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="16095"><span data-slate-leaf="true" data-offset-key="16095:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16096"><span data-slate-object="text" data-key="16097"><span data-slate-leaf="true" data-offset-key="16097:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16098"><span data-slate-leaf="true" data-offset-key="16098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 非常关键的一步！这是判断是否需要执行卸任逻辑的重要依据！</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16099"><span data-slate-object="text" data-key="16100"><span data-slate-leaf="true" data-offset-key="16100:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16101"><span data-slate-leaf="true" data-offset-key="16101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断该 Broker 之前是否是 Controller</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16102"><span data-slate-object="text" data-key="16103"><span data-slate-leaf="true" data-offset-key="16103:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16104"><span data-slate-leaf="true" data-offset-key="16104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16105"><span data-slate-leaf="true" data-offset-key="16105:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16106"><span data-slate-leaf="true" data-offset-key="16106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">wasActiveBeforeChange</span></span></span></span><span data-slate-object="text" data-key="16107"><span data-slate-leaf="true" data-offset-key="16107:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16108"><span data-slate-leaf="true" data-offset-key="16108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16109"><span data-slate-leaf="true" data-offset-key="16109:0" data-first-offset="true"><span data-slate-string="true"> isActive</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16110"><span data-slate-object="text" data-key="16111"><span data-slate-leaf="true" data-offset-key="16111:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16112"><span data-slate-leaf="true" data-offset-key="16112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注册 ControllerChangeHandler 监听器  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16113"><span data-slate-object="text" data-key="16114"><span data-slate-leaf="true" data-offset-key="16114:0" data-first-offset="true"><span data-slate-string="true">  zkClient.registerZNodeChangeHandlerAndCheckExistence(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16115"><span data-slate-object="text" data-key="16116"><span data-slate-leaf="true" data-offset-key="16116:0" data-first-offset="true"><span data-slate-string="true">    controllerChangeHandler)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16117"><span data-slate-object="text" data-key="16118"><span data-slate-leaf="true" data-offset-key="16118:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16119"><span data-slate-leaf="true" data-offset-key="16119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前集群 Controller 所在的 Broker Id，如果没有 Controller 则返回 - 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16120"><span data-slate-object="text" data-key="16121"><span data-slate-leaf="true" data-offset-key="16121:0" data-first-offset="true"><span data-slate-string="true">  activeControllerId = zkClient.getControllerId.getOrElse(-</span></span></span><span data-slate-object="text" data-key="16122"><span data-slate-leaf="true" data-offset-key="16122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16123"><span data-slate-leaf="true" data-offset-key="16123:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16124"><span data-slate-object="text" data-key="16125"><span data-slate-leaf="true" data-offset-key="16125:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16126"><span data-slate-leaf="true" data-offset-key="16126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该 Broker 之前是 Controller 但现在不是了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16127"><span data-slate-object="text" data-key="16128"><span data-slate-leaf="true" data-offset-key="16128:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16129"><span data-slate-leaf="true" data-offset-key="16129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16130"><span data-slate-leaf="true" data-offset-key="16130:0" data-first-offset="true"><span data-slate-string="true"> (wasActiveBeforeChange &amp;&amp; !isActive) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16131"><span data-slate-object="text" data-key="16132"><span data-slate-leaf="true" data-offset-key="16132:0" data-first-offset="true"><span data-slate-string="true">    onControllerResignation() </span></span></span><span data-slate-object="text" data-key="16133"><span data-slate-leaf="true" data-offset-key="16133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行卸任逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16134"><span data-slate-object="text" data-key="16135"><span data-slate-leaf="true" data-offset-key="16135:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16136"><span data-slate-object="text" data-key="16137"><span data-slate-leaf="true" data-offset-key="16137:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16138"><span data-slate-object="text" data-key="16139"><span data-slate-leaf="true" data-offset-key="16139:0" data-first-offset="true"><span data-slate-string="true">代码的第一行非常关键，它是决定是否需要执行卸任的重要依据。毕竟，如果 Broker 之前不是 Controller，那何来 “卸任” 一说呢？之后代码要注册 ControllerChangeHandler 监听器，获取当前集群 Controller 所在的 Broker ID，如果没有 Controller，则返回 -1。有了这些数据之后，maybeResign 方法需要判断该 Broker 是否之前是 Controller 但现在不是了。如果是这种情况的话，则调用 onControllerResignation 方法执行 Controller 卸任逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16140"><span data-slate-object="text" data-key="16141"><span data-slate-leaf="true" data-offset-key="16141:0" data-first-offset="true"><span data-slate-string="true">说到 “卸任”，你可能会问：“卸任逻辑是由哪个方法执行的呢？” 实际上，这是由 onControllerResignation 方法执行的，它主要是用于清空各种数据结构的值、取消 ZooKeeper 监听器、关闭各种状态机以及管理器，等等。我用注释的方式给出它的逻辑实现：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16142"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16143"><span data-slate-object="text" data-key="16144"><span data-slate-leaf="true" data-offset-key="16144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="16145"><span data-slate-leaf="true" data-offset-key="16145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="16146"><span data-slate-leaf="true" data-offset-key="16146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">onControllerResignation</span></span></span></span></span><span data-slate-object="text" data-key="16147"><span data-slate-leaf="true" data-offset-key="16147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16148"><span data-slate-leaf="true" data-offset-key="16148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="16149"><span data-slate-leaf="true" data-offset-key="16149:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16150"><span data-slate-object="text" data-key="16151"><span data-slate-leaf="true" data-offset-key="16151:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16152"><span data-slate-leaf="true" data-offset-key="16152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">debug</span></span></span></span><span data-slate-object="text" data-key="16153"><span data-slate-leaf="true" data-offset-key="16153:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16154"><span data-slate-leaf="true" data-offset-key="16154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Resigning"</span></span></span></span><span data-slate-object="text" data-key="16155"><span data-slate-leaf="true" data-offset-key="16155:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16156"><span data-slate-object="text" data-key="16157"><span data-slate-leaf="true" data-offset-key="16157:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16158"><span data-slate-leaf="true" data-offset-key="16158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消 ZooKeeper 监听器的注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16159"><span data-slate-object="text" data-key="16160"><span data-slate-leaf="true" data-offset-key="16160:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16161"><span data-slate-leaf="true" data-offset-key="16161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChildChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16162"><span data-slate-leaf="true" data-offset-key="16162:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16163"><span data-slate-object="text" data-key="16164"><span data-slate-leaf="true" data-offset-key="16164:0" data-first-offset="true"><span data-slate-string="true">    isrChangeNotificationHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16165"><span data-slate-object="text" data-key="16166"><span data-slate-leaf="true" data-offset-key="16166:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16167"><span data-slate-leaf="true" data-offset-key="16167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16168"><span data-slate-leaf="true" data-offset-key="16168:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16169"><span data-slate-object="text" data-key="16170"><span data-slate-leaf="true" data-offset-key="16170:0" data-first-offset="true"><span data-slate-string="true">    partitionReassignmentHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16171"><span data-slate-object="text" data-key="16172"><span data-slate-leaf="true" data-offset-key="16172:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16173"><span data-slate-leaf="true" data-offset-key="16173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16174"><span data-slate-leaf="true" data-offset-key="16174:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16175"><span data-slate-object="text" data-key="16176"><span data-slate-leaf="true" data-offset-key="16176:0" data-first-offset="true"><span data-slate-string="true">    preferredReplicaElectionHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16177"><span data-slate-object="text" data-key="16178"><span data-slate-leaf="true" data-offset-key="16178:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16179"><span data-slate-leaf="true" data-offset-key="16179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChildChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16180"><span data-slate-leaf="true" data-offset-key="16180:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16181"><span data-slate-object="text" data-key="16182"><span data-slate-leaf="true" data-offset-key="16182:0" data-first-offset="true"><span data-slate-string="true">    logDirEventNotificationHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16183"><span data-slate-object="text" data-key="16184"><span data-slate-leaf="true" data-offset-key="16184:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16185"><span data-slate-leaf="true" data-offset-key="16185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterBrokerModificationsHandler</span></span></span></span><span data-slate-object="text" data-key="16186"><span data-slate-leaf="true" data-offset-key="16186:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16187"><span data-slate-object="text" data-key="16188"><span data-slate-leaf="true" data-offset-key="16188:0" data-first-offset="true"><span data-slate-string="true">    brokerModificationsHandlers.keySet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16189"><span data-slate-object="text" data-key="16190"><span data-slate-leaf="true" data-offset-key="16190:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16191"><span data-slate-leaf="true" data-offset-key="16191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭 Kafka 线程调度器，其实就是取消定期的 Leader 重选举</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16192"><span data-slate-object="text" data-key="16193"><span data-slate-leaf="true" data-offset-key="16193:0" data-first-offset="true"><span data-slate-string="true">  kafkaScheduler.</span></span></span><span data-slate-object="text" data-key="16194"><span data-slate-leaf="true" data-offset-key="16194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span><span data-slate-object="text" data-key="16195"><span data-slate-leaf="true" data-offset-key="16195:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16196"><span data-slate-object="text" data-key="16197"><span data-slate-leaf="true" data-offset-key="16197:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16198"><span data-slate-leaf="true" data-offset-key="16198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将统计字段全部清 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16199"><span data-slate-object="text" data-key="16200"><span data-slate-leaf="true" data-offset-key="16200:0" data-first-offset="true"><span data-slate-string="true">  offlinePartitionCount = </span></span></span><span data-slate-object="text" data-key="16201"><span data-slate-leaf="true" data-offset-key="16201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16202"><span data-slate-object="text" data-key="16203"><span data-slate-leaf="true" data-offset-key="16203:0" data-first-offset="true"><span data-slate-string="true">  preferredReplicaImbalanceCount = </span></span></span><span data-slate-object="text" data-key="16204"><span data-slate-leaf="true" data-offset-key="16204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16205"><span data-slate-object="text" data-key="16206"><span data-slate-leaf="true" data-offset-key="16206:0" data-first-offset="true"><span data-slate-string="true">  globalTopicCount = </span></span></span><span data-slate-object="text" data-key="16207"><span data-slate-leaf="true" data-offset-key="16207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16208"><span data-slate-object="text" data-key="16209"><span data-slate-leaf="true" data-offset-key="16209:0" data-first-offset="true"><span data-slate-string="true">  globalPartitionCount = </span></span></span><span data-slate-object="text" data-key="16210"><span data-slate-leaf="true" data-offset-key="16210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16211"><span data-slate-object="text" data-key="16212"><span data-slate-leaf="true" data-offset-key="16212:0" data-first-offset="true"><span data-slate-string="true">  topicsToDeleteCount = </span></span></span><span data-slate-object="text" data-key="16213"><span data-slate-leaf="true" data-offset-key="16213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16214"><span data-slate-object="text" data-key="16215"><span data-slate-leaf="true" data-offset-key="16215:0" data-first-offset="true"><span data-slate-string="true">  replicasToDeleteCount = </span></span></span><span data-slate-object="text" data-key="16216"><span data-slate-leaf="true" data-offset-key="16216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16217"><span data-slate-object="text" data-key="16218"><span data-slate-leaf="true" data-offset-key="16218:0" data-first-offset="true"><span data-slate-string="true">  ineligibleTopicsToDeleteCount = </span></span></span><span data-slate-object="text" data-key="16219"><span data-slate-leaf="true" data-offset-key="16219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16220"><span data-slate-object="text" data-key="16221"><span data-slate-leaf="true" data-offset-key="16221:0" data-first-offset="true"><span data-slate-string="true">  ineligibleReplicasToDeleteCount = </span></span></span><span data-slate-object="text" data-key="16222"><span data-slate-leaf="true" data-offset-key="16222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16223"><span data-slate-object="text" data-key="16224"><span data-slate-leaf="true" data-offset-key="16224:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16225"><span data-slate-leaf="true" data-offset-key="16225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭 Token 过期检查调度器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16226"><span data-slate-object="text" data-key="16227"><span data-slate-leaf="true" data-offset-key="16227:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16228"><span data-slate-leaf="true" data-offset-key="16228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16229"><span data-slate-leaf="true" data-offset-key="16229:0" data-first-offset="true"><span data-slate-string="true"> (tokenCleanScheduler.isStarted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16230"><span data-slate-object="text" data-key="16231"><span data-slate-leaf="true" data-offset-key="16231:0" data-first-offset="true"><span data-slate-string="true">    tokenCleanScheduler.</span></span></span><span data-slate-object="text" data-key="16232"><span data-slate-leaf="true" data-offset-key="16232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span><span data-slate-object="text" data-key="16233"><span data-slate-leaf="true" data-offset-key="16233:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16234"><span data-slate-object="text" data-key="16235"><span data-slate-leaf="true" data-offset-key="16235:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16236"><span data-slate-leaf="true" data-offset-key="16236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消分区重分配监听器的注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16237"><span data-slate-object="text" data-key="16238"><span data-slate-leaf="true" data-offset-key="16238:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16239"><span data-slate-leaf="true" data-offset-key="16239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterPartitionReassignmentIsrChangeHandlers</span></span></span></span><span data-slate-object="text" data-key="16240"><span data-slate-leaf="true" data-offset-key="16240:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16241"><span data-slate-object="text" data-key="16242"><span data-slate-leaf="true" data-offset-key="16242:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16243"><span data-slate-leaf="true" data-offset-key="16243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭分区状态机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16244"><span data-slate-object="text" data-key="16245"><span data-slate-leaf="true" data-offset-key="16245:0" data-first-offset="true"><span data-slate-string="true">  partitionStateMachine.</span></span></span><span data-slate-object="text" data-key="16246"><span data-slate-leaf="true" data-offset-key="16246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span><span data-slate-object="text" data-key="16247"><span data-slate-leaf="true" data-offset-key="16247:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16248"><span data-slate-object="text" data-key="16249"><span data-slate-leaf="true" data-offset-key="16249:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16250"><span data-slate-leaf="true" data-offset-key="16250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消主题变更监听器的注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16251"><span data-slate-object="text" data-key="16252"><span data-slate-leaf="true" data-offset-key="16252:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16253"><span data-slate-leaf="true" data-offset-key="16253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChildChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16254"><span data-slate-leaf="true" data-offset-key="16254:0" data-first-offset="true"><span data-slate-string="true">(topicChangeHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16255"><span data-slate-object="text" data-key="16256"><span data-slate-leaf="true" data-offset-key="16256:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16257"><span data-slate-leaf="true" data-offset-key="16257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消分区变更监听器的注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16258"><span data-slate-object="text" data-key="16259"><span data-slate-leaf="true" data-offset-key="16259:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16260"><span data-slate-leaf="true" data-offset-key="16260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterPartitionModificationsHandlers</span></span></span></span><span data-slate-object="text" data-key="16261"><span data-slate-leaf="true" data-offset-key="16261:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16262"><span data-slate-object="text" data-key="16263"><span data-slate-leaf="true" data-offset-key="16263:0" data-first-offset="true"><span data-slate-string="true">    partitionModificationsHandlers.keys.toSeq)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16264"><span data-slate-object="text" data-key="16265"><span data-slate-leaf="true" data-offset-key="16265:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16266"><span data-slate-leaf="true" data-offset-key="16266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消主题删除监听器的注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16267"><span data-slate-object="text" data-key="16268"><span data-slate-leaf="true" data-offset-key="16268:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16269"><span data-slate-leaf="true" data-offset-key="16269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChildChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16270"><span data-slate-leaf="true" data-offset-key="16270:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16271"><span data-slate-object="text" data-key="16272"><span data-slate-leaf="true" data-offset-key="16272:0" data-first-offset="true"><span data-slate-string="true">    topicDeletionHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16273"><span data-slate-object="text" data-key="16274"><span data-slate-leaf="true" data-offset-key="16274:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16275"><span data-slate-leaf="true" data-offset-key="16275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭副本状态机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16276"><span data-slate-object="text" data-key="16277"><span data-slate-leaf="true" data-offset-key="16277:0" data-first-offset="true"><span data-slate-string="true">  replicaStateMachine.</span></span></span><span data-slate-object="text" data-key="16278"><span data-slate-leaf="true" data-offset-key="16278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span><span data-slate-object="text" data-key="16279"><span data-slate-leaf="true" data-offset-key="16279:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16280"><span data-slate-object="text" data-key="16281"><span data-slate-leaf="true" data-offset-key="16281:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16282"><span data-slate-leaf="true" data-offset-key="16282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消 Broker 变更监听器的注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16283"><span data-slate-object="text" data-key="16284"><span data-slate-leaf="true" data-offset-key="16284:0" data-first-offset="true"><span data-slate-string="true">  zkClient.</span></span></span><span data-slate-object="text" data-key="16285"><span data-slate-leaf="true" data-offset-key="16285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterZNodeChildChangeHandler</span></span></span></span><span data-slate-object="text" data-key="16286"><span data-slate-leaf="true" data-offset-key="16286:0" data-first-offset="true"><span data-slate-string="true">(brokerChangeHandler.path)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16287"><span data-slate-object="text" data-key="16288"><span data-slate-leaf="true" data-offset-key="16288:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16289"><span data-slate-leaf="true" data-offset-key="16289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭 Controller 通道管理器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16290"><span data-slate-object="text" data-key="16291"><span data-slate-leaf="true" data-offset-key="16291:0" data-first-offset="true"><span data-slate-string="true">  controllerChannelManager.</span></span></span><span data-slate-object="text" data-key="16292"><span data-slate-leaf="true" data-offset-key="16292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span><span data-slate-object="text" data-key="16293"><span data-slate-leaf="true" data-offset-key="16293:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16294"><span data-slate-object="text" data-key="16295"><span data-slate-leaf="true" data-offset-key="16295:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16296"><span data-slate-leaf="true" data-offset-key="16296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清空集群元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16297"><span data-slate-object="text" data-key="16298"><span data-slate-leaf="true" data-offset-key="16298:0" data-first-offset="true"><span data-slate-string="true">  controllerContext.</span></span></span><span data-slate-object="text" data-key="16299"><span data-slate-leaf="true" data-offset-key="16299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">resetContext</span></span></span></span><span data-slate-object="text" data-key="16300"><span data-slate-leaf="true" data-offset-key="16300:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16301"><span data-slate-object="text" data-key="16302"><span data-slate-leaf="true" data-offset-key="16302:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16303"><span data-slate-leaf="true" data-offset-key="16303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">info</span></span></span></span><span data-slate-object="text" data-key="16304"><span data-slate-leaf="true" data-offset-key="16304:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16305"><span data-slate-leaf="true" data-offset-key="16305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Resigned"</span></span></span></span><span data-slate-object="text" data-key="16306"><span data-slate-leaf="true" data-offset-key="16306:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16307"><span data-slate-object="text" data-key="16308"><span data-slate-leaf="true" data-offset-key="16308:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16309"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16310" id="sr-toc-15"><span data-slate-object="text" data-key="16311"><span data-slate-leaf="true" data-offset-key="16311:0" data-first-offset="true"><span data-slate-string="true">选举 Controller</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16312"><span data-slate-object="text" data-key="16313"><span data-slate-leaf="true" data-offset-key="16313:0" data-first-offset="true"><span data-slate-string="true">讲完了触发场景，接下来，我们就要学习 Controller 选举的源码了。前面说过了，这三种选举场景最后都会调用 elect 方法来执行选举逻辑。我们来看下它的实现：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="16314"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16315"><span data-slate-object="text" data-key="16316"><span data-slate-leaf="true" data-offset-key="16316:0" data-first-offset="true"><span data-slate-string="true">private def elect(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16317"><span data-slate-object="text" data-key="16318"><span data-slate-leaf="true" data-offset-key="16318:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16319"><span data-slate-leaf="true" data-offset-key="16319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：获取当前 Controller 所在 Broker 的序号，如果 Controller 不存在，显式标记为 - 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16320"><span data-slate-object="text" data-key="16321"><span data-slate-leaf="true" data-offset-key="16321:0" data-first-offset="true"><span data-slate-string="true">    activeControllerId = zkClient.getControllerId.getOrElse(</span></span></span><span data-slate-object="text" data-key="16322"><span data-slate-leaf="true" data-offset-key="16322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="16323"><span data-slate-leaf="true" data-offset-key="16323:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16324"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16325"><span data-slate-object="text" data-key="16326"><span data-slate-leaf="true" data-offset-key="16326:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16327"><span data-slate-leaf="true" data-offset-key="16327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：如果当前 Controller 已经选出来了，直接返回即可</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16328"><span data-slate-object="text" data-key="16329"><span data-slate-leaf="true" data-offset-key="16329:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16330"><span data-slate-leaf="true" data-offset-key="16330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16331"><span data-slate-leaf="true" data-offset-key="16331:0" data-first-offset="true"><span data-slate-string="true"> (activeControllerId != </span></span></span><span data-slate-object="text" data-key="16332"><span data-slate-leaf="true" data-offset-key="16332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="16333"><span data-slate-leaf="true" data-offset-key="16333:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16334"><span data-slate-object="text" data-key="16335"><span data-slate-leaf="true" data-offset-key="16335:0" data-first-offset="true"><span data-slate-string="true">      debug(s</span></span></span><span data-slate-object="text" data-key="16336"><span data-slate-leaf="true" data-offset-key="16336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Broker </span></span></span></span><span data-slate-object="text" data-key="16337"><span data-slate-leaf="true" data-offset-key="16337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$activeControllerId</span></span></span></span></span><span data-slate-object="text" data-key="16338"><span data-slate-leaf="true" data-offset-key="16338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> has been elected as the controller, so stopping the election process."</span></span></span></span><span data-slate-object="text" data-key="16339"><span data-slate-leaf="true" data-offset-key="16339:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16340"><span data-slate-object="text" data-key="16341"><span data-slate-leaf="true" data-offset-key="16341:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16342"><span data-slate-leaf="true" data-offset-key="16342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16343"><span data-slate-object="text" data-key="16344"><span data-slate-leaf="true" data-offset-key="16344:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16345"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16346"><span data-slate-object="text" data-key="16347"><span data-slate-leaf="true" data-offset-key="16347:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16348"><span data-slate-leaf="true" data-offset-key="16348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="16349"><span data-slate-leaf="true" data-offset-key="16349:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16350"><span data-slate-object="text" data-key="16351"><span data-slate-leaf="true" data-offset-key="16351:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16352"><span data-slate-leaf="true" data-offset-key="16352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：注册 Controller 相关信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16353"><span data-slate-object="text" data-key="16354"><span data-slate-leaf="true" data-offset-key="16354:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16355"><span data-slate-leaf="true" data-offset-key="16355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主要是创建 /controller 节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16356"><span data-slate-object="text" data-key="16357"><span data-slate-leaf="true" data-offset-key="16357:0" data-first-offset="true"><span data-slate-string="true">      val (epoch, epochZkVersion) = zkClient.registerControllerAndIncrementControllerEpoch(config.brokerId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16358"><span data-slate-object="text" data-key="16359"><span data-slate-leaf="true" data-offset-key="16359:0" data-first-offset="true"><span data-slate-string="true">      controllerContext.epoch = epoch</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16360"><span data-slate-object="text" data-key="16361"><span data-slate-leaf="true" data-offset-key="16361:0" data-first-offset="true"><span data-slate-string="true">      controllerContext.epochZkVersion = epochZkVersion</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16362"><span data-slate-object="text" data-key="16363"><span data-slate-leaf="true" data-offset-key="16363:0" data-first-offset="true"><span data-slate-string="true">      activeControllerId = config.brokerId</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16364"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16365"><span data-slate-object="text" data-key="16366"><span data-slate-leaf="true" data-offset-key="16366:0" data-first-offset="true"><span data-slate-string="true">      info(s</span></span></span><span data-slate-object="text" data-key="16367"><span data-slate-leaf="true" data-offset-key="16367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="16368"><span data-slate-leaf="true" data-offset-key="16368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${config.brokerId}</span></span></span></span></span><span data-slate-object="text" data-key="16369"><span data-slate-leaf="true" data-offset-key="16369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> successfully elected as the controller. Epoch incremented to </span></span></span></span><span data-slate-object="text" data-key="16370"><span data-slate-leaf="true" data-offset-key="16370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${controllerContext.epoch}</span></span></span></span></span><span data-slate-object="text" data-key="16371"><span data-slate-leaf="true" data-offset-key="16371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> "</span></span></span></span><span data-slate-object="text" data-key="16372"><span data-slate-leaf="true" data-offset-key="16372:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16373"><span data-slate-object="text" data-key="16374"><span data-slate-leaf="true" data-offset-key="16374:0" data-first-offset="true"><span data-slate-string="true">        s</span></span></span><span data-slate-object="text" data-key="16375"><span data-slate-leaf="true" data-offset-key="16375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"and epoch zk version is now </span></span></span></span><span data-slate-object="text" data-key="16376"><span data-slate-leaf="true" data-offset-key="16376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${controllerContext.epochZkVersion}</span></span></span></span></span><span data-slate-object="text" data-key="16377"><span data-slate-leaf="true" data-offset-key="16377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="16378"><span data-slate-leaf="true" data-offset-key="16378:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16379"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16380"><span data-slate-object="text" data-key="16381"><span data-slate-leaf="true" data-offset-key="16381:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16382"><span data-slate-leaf="true" data-offset-key="16382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 4 步：执行当选 Controller 的后续逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16383"><span data-slate-object="text" data-key="16384"><span data-slate-leaf="true" data-offset-key="16384:0" data-first-offset="true"><span data-slate-string="true">      onControllerFailover()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16385"><span data-slate-object="text" data-key="16386"><span data-slate-leaf="true" data-offset-key="16386:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="16387"><span data-slate-leaf="true" data-offset-key="16387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="16388"><span data-slate-leaf="true" data-offset-key="16388:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16389"><span data-slate-object="text" data-key="16390"><span data-slate-leaf="true" data-offset-key="16390:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16391"><span data-slate-leaf="true" data-offset-key="16391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16392"><span data-slate-leaf="true" data-offset-key="16392:0" data-first-offset="true"><span data-slate-string="true"> e: ControllerMovedException =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16393"><span data-slate-object="text" data-key="16394"><span data-slate-leaf="true" data-offset-key="16394:0" data-first-offset="true"><span data-slate-string="true">        maybeResign()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16395"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16396"><span data-slate-object="text" data-key="16397"><span data-slate-leaf="true" data-offset-key="16397:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16398"><span data-slate-leaf="true" data-offset-key="16398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16399"><span data-slate-leaf="true" data-offset-key="16399:0" data-first-offset="true"><span data-slate-string="true"> (activeControllerId != </span></span></span><span data-slate-object="text" data-key="16400"><span data-slate-leaf="true" data-offset-key="16400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="16401"><span data-slate-leaf="true" data-offset-key="16401:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16402"><span data-slate-object="text" data-key="16403"><span data-slate-leaf="true" data-offset-key="16403:0" data-first-offset="true"><span data-slate-string="true">          debug(s</span></span></span><span data-slate-object="text" data-key="16404"><span data-slate-leaf="true" data-offset-key="16404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Broker </span></span></span></span><span data-slate-object="text" data-key="16405"><span data-slate-leaf="true" data-offset-key="16405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$activeControllerId</span></span></span></span></span><span data-slate-object="text" data-key="16406"><span data-slate-leaf="true" data-offset-key="16406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> was elected as controller instead of broker </span></span></span></span><span data-slate-object="text" data-key="16407"><span data-slate-leaf="true" data-offset-key="16407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${config.brokerId}</span></span></span></span></span><span data-slate-object="text" data-key="16408"><span data-slate-leaf="true" data-offset-key="16408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="16409"><span data-slate-leaf="true" data-offset-key="16409:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16410"><span data-slate-object="text" data-key="16411"><span data-slate-leaf="true" data-offset-key="16411:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16412"><span data-slate-leaf="true" data-offset-key="16412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16413"><span data-slate-object="text" data-key="16414"><span data-slate-leaf="true" data-offset-key="16414:0" data-first-offset="true"><span data-slate-string="true">          warn(</span></span></span><span data-slate-object="text" data-key="16415"><span data-slate-leaf="true" data-offset-key="16415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"A controller has been elected but just resigned, this will result in another round of election"</span></span></span></span><span data-slate-object="text" data-key="16416"><span data-slate-leaf="true" data-offset-key="16416:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16417"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16418"><span data-slate-object="text" data-key="16419"><span data-slate-leaf="true" data-offset-key="16419:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16420"><span data-slate-leaf="true" data-offset-key="16420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16421"><span data-slate-leaf="true" data-offset-key="16421:0" data-first-offset="true"><span data-slate-string="true"> t: Throwable =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16422"><span data-slate-object="text" data-key="16423"><span data-slate-leaf="true" data-offset-key="16423:0" data-first-offset="true"><span data-slate-string="true">        error(s</span></span></span><span data-slate-object="text" data-key="16424"><span data-slate-leaf="true" data-offset-key="16424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Error while electing or becoming controller on broker </span></span></span></span><span data-slate-object="text" data-key="16425"><span data-slate-leaf="true" data-offset-key="16425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${config.brokerId}</span></span></span></span></span><span data-slate-object="text" data-key="16426"><span data-slate-leaf="true" data-offset-key="16426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">. "</span></span></span></span><span data-slate-object="text" data-key="16427"><span data-slate-leaf="true" data-offset-key="16427:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16428"><span data-slate-object="text" data-key="16429"><span data-slate-leaf="true" data-offset-key="16429:0" data-first-offset="true"><span data-slate-string="true">          s</span></span></span><span data-slate-object="text" data-key="16430"><span data-slate-leaf="true" data-offset-key="16430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Trigger controller movement immediately"</span></span></span></span><span data-slate-object="text" data-key="16431"><span data-slate-leaf="true" data-offset-key="16431:0" data-first-offset="true"><span data-slate-string="true">, t)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16432"><span data-slate-object="text" data-key="16433"><span data-slate-leaf="true" data-offset-key="16433:0" data-first-offset="true"><span data-slate-string="true">        triggerControllerMove()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16434"><span data-slate-object="text" data-key="16435"><span data-slate-leaf="true" data-offset-key="16435:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16436"><span data-slate-object="text" data-key="16437"><span data-slate-leaf="true" data-offset-key="16437:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16438"><span data-slate-object="text" data-key="16439"><span data-slate-leaf="true" data-offset-key="16439:0" data-first-offset="true"><span data-slate-string="true">为了帮助你更好地理解这个方法，我再画一张图来进行说明：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16440"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/23/1b/2331395774956a61f37836c46d65d01b.jpg?wh=2104*2136"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16441"><span data-slate-object="text" data-key="16442"><span data-slate-leaf="true" data-offset-key="16442:0" data-first-offset="true"><span data-slate-string="true">该方法首先检查 Controller 是否已经选出来了。要知道，集群中的所有 Broker 都要执行这些逻辑，因此，非常有可能出现某些 Broker 在执行 elect 方法时，Controller 已经被选出来的情况。如果 Controller 已经选出来了，那么，自然也就不用再做什么了。相反地，如果 Controller 尚未被选举出来，那么，代码会尝试创建 /controller 节点去抢注 Controller。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16443"><span data-slate-object="text" data-key="16444"><span data-slate-leaf="true" data-offset-key="16444:0" data-first-offset="true"><span data-slate-string="true">一旦抢注成功，就调用 onControllerFailover 方法，执行选举成功后的动作。这些动作包括注册各类 ZooKeeper 监听器、删除日志路径变更和 ISR 副本变更通知事件、启动 Controller 通道管理器，以及启动副本状态机和分区状态机。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16445"><span data-slate-object="text" data-key="16446"><span data-slate-leaf="true" data-offset-key="16446:0" data-first-offset="true"><span data-slate-string="true">如果抢注失败了，代码会抛出 ControllerMovedException 异常。这通常表明 Controller 已经被其他 Broker 抢先占据了，那么，此时代码调用 maybeResign 方法去执行卸任逻辑。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16447" id="sr-toc-16"><span data-slate-object="text" data-key="16448"><span data-slate-leaf="true" data-offset-key="16448:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16449"><span data-slate-object="text" data-key="16450"><span data-slate-leaf="true" data-offset-key="16450:0" data-first-offset="true"><span data-slate-string="true">今天，我们梳理了 Controller 选举的全过程，包括 Controller 如何借助 ZooKeeper 监听器实现监听 Controller 节点，以及 Controller 的选举触发场景和完整流程。我们来回顾一下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16451"><div data-slate-type="list-line" data-slate-object="block" data-key="16452"><span data-slate-object="text" data-key="16453"><span data-slate-leaf="true" data-offset-key="16453:0" data-first-offset="true"><span data-slate-string="true">Controller 依赖 ZooKeeper 实现 Controller 选举，主要是借助于 /controller 临时节点和 ZooKeeper 的监听器机制。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16454"><span data-slate-object="text" data-key="16455"><span data-slate-leaf="true" data-offset-key="16455:0" data-first-offset="true"><span data-slate-string="true">Controller 触发场景有 3 种：集群启动时；/controller 节点被删除时；/controller 节点数据变更时。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16456"><span data-slate-object="text" data-key="16457"><span data-slate-leaf="true" data-offset-key="16457:0" data-first-offset="true"><span data-slate-string="true">源码最终调用 elect 方法实现 Controller 选举。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="16458"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/e2/74/e28c134e4fd11ff8ed87933aee88d374.jpg?wh=2250*3387"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16459"><span data-slate-object="text" data-key="16460"><span data-slate-leaf="true" data-offset-key="16460:0" data-first-offset="true"><span data-slate-string="true">下节课，我将带你学习 Controller 的其他重要功能，包括它如何管理 Broker 和副本等。你千万不要错过。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16461" id="sr-toc-17"><span data-slate-object="text" data-key="16462"><span data-slate-leaf="true" data-offset-key="16462:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16463"><span data-slate-object="text" data-key="16464"><span data-slate-leaf="true" data-offset-key="16464:0" data-first-offset="true"><span data-slate-string="true">在这节课刚开始的时候，我提到，删除 /controller 会触发 Controller 选举，之后会同步集群元数据信息。那么，你知道源码是在哪里更新的元数据请求吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16465"><span data-slate-object="text" data-key="16466"><span data-slate-leaf="true" data-offset-key="16466:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区畅所欲言，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-18">精选留言 (8)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们重点了解了 Controller 的单线程 + 阻塞队列消息处理模式。课后我请你思考这样一个问题：ControllerEventManager 的 put 方法代码是否需要加 putLock 保护。这是一个开放式的问题，就我个人的观点，我认为是不需要的。因为 queue 本身是线程安全的，queuedEvent 又是线程私有的栈上引用，因此这里的线程安全性可完全由 queue 字段类型 LinkedBlockingQueue 来保证。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-05-29</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/03/1c/c9fe6738.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Kvicii.Y</span></div></div><div>在最后的 elect 方法中，如果抢注失败抛出 ControllerMovedException 异常后为什么要执行卸任逻辑逻辑呢？此时这个 Broker 即使之前是 Controller 但应该也是执行过卸任逻辑了，为什么还要重复的执行一次呢</div><div><p>作者回复: maybeResign 只是 maybe：）</p></div><div><div>2020-07-02</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/8b/fe/f2b2ae63.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>t-mac</span></div></div><div>老师， 以前的版本有注册 "registerSessionExpirationListener ()"  新版本不需要这个监听 zk session 的 listener 了吗？ 这个 listener 是不是非必须的？</div><div><p>作者回复：不需要了。新版本 Controller 没有这个监听器了</p></div><div><div>2021-02-06</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/12/f3/f3/3fbb4c38.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>旭杰</span></div></div><div>触发场景三：controller 节点数据发生变更。这种情况下 Zookeeper 会通知 ControllerChange 事件，Broker 端执行 processControllerChange ()-&gt;maybeResign ()，只是做一些清理工作，该事件本身应该不会触发 controller 选举。该事件应该属于 Controller 易主过程中的一部分，最终是由 Zookeeper 通知 Reelect () 事件来触发选举流程。</div><div><p>作者回复: ������</p></div><div><div>2020-11-03</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/12/f3/f3/3fbb4c38.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>旭杰</span></div></div><div>/controller 节点数据变更 数据变更指的是？isr 集合变更 /broker 列表变更这种吗</div><div><p>作者回复：就是 controller 发生变更，因为 /controller 节点的数据就是 controller 所在的 broker id</p></div><div><div>2020-10-21</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/4f/37/ad1ca21d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>在路上</span></div></div><div>老师，controller 会出现脑裂吗？或者是在哪个版本这个 bug 修复了呢？</div><div><p>作者回复：嗯，实际上我更愿意这么说：ZooKeeper 出现脑裂导致 Kafka 集群出现多个 controller。Kafka 提供了一些参数可以帮忙应对这种场景：unclean.leader.election.enable、replication.factor 和 min.insync.replicas</p></div><div><div>2020-10-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>thomas</span></div></div><div>老师，新建一个 topic 时，是如何决定选哪一个是领导者副本？假如有两个 broker，replica. factor=2</div><div><p>作者回复：一般是按照副本列表中的第一个副本是 leader 副本。而副本列表一般是按照 brokerid 顺序排列</p></div><div><div>2020-05-28</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>空知</span></div></div><div>调用 onControllerFailover 时候
sendUpdateMetadataRequest (controllerContext.liveOrShuttingDownBrokerIds.toSeq, Set.empty)
向集群里的 brokers 发送更新元数据请求 </div><div><p>作者回复：对，让它们去更新元数据</p></div><div><div>2020-05-21</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1d"><outline class="toc-level-h1" data-reactid=".1d.0" style="width: 175px;"><active data-reactid=".1d.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1d.0.1"><span data-reactid=".1d.0.1.0">14 | Controller 选举是怎么实现的？</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.1" style="width: 165px;"><active data-reactid=".1d.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1d.1.1"><span data-reactid=".1d.1.1.0">概览</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.2" style="width: 155px;"><active data-reactid=".1d.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1d.2.1"><span data-reactid=".1d.2.1.0">ZooKeeper /controller 节点</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.3" style="width: 155px;"><active data-reactid=".1d.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1d.3.1"><span data-reactid=".1d.3.1.0">源码结构</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.4" style="width: 165px;"><active data-reactid=".1d.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1d.4.1"><span data-reactid=".1d.4.1.0">KafkaController 类</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.5" style="width: 155px;"><active data-reactid=".1d.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1d.5.1"><span data-reactid=".1d.5.1.0">原生字段</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.6" style="width: 155px;"><active data-reactid=".1d.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1d.6.1"><span data-reactid=".1d.6.1.0">辅助字段</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.7" style="width: 155px;"><active data-reactid=".1d.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1d.7.1"><span data-reactid=".1d.7.1.0">各类 ZooKeeper 监听器</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.8" style="width: 155px;"><active data-reactid=".1d.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1d.8.1"><span data-reactid=".1d.8.1.0">统计字段</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.9" style="width: 165px;"><active data-reactid=".1d.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1d.9.1"><span data-reactid=".1d.9.1.0">ControllerChangeHandler 监听器</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.a" style="width: 165px;"><active data-reactid=".1d.a.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1d.a.1"><span data-reactid=".1d.a.1.0">Controller 选举流程</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.b" style="width: 155px;"><active data-reactid=".1d.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1d.b.1"><span data-reactid=".1d.b.1.0">触发选举</span></a></outline><outline class="toc-level-h4" data-reactid=".1d.c" style="width: 145px;"><active data-reactid=".1d.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".1d.c.1"><span data-reactid=".1d.c.1.0">场景一：集群从零启动</span></a></outline><outline class="toc-level-h4" data-reactid=".1d.d" style="width: 145px;"><active data-reactid=".1d.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".1d.d.1"><span data-reactid=".1d.d.1.0">场景二：/controller 节点消失</span></a></outline><outline class="toc-level-h4" data-reactid=".1d.e" style="width: 145px;"><active data-reactid=".1d.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".1d.e.1"><span data-reactid=".1d.e.1.0">场景三：/controller 节点数据变更</span></a></outline><outline class="toc-level-h3" data-reactid=".1d.f" style="width: 155px;"><active data-reactid=".1d.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".1d.f.1"><span data-reactid=".1d.f.1.0">选举 Controller</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.g" style="width: 165px;"><active data-reactid=".1d.g.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".1d.g.1"><span data-reactid=".1d.g.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.h" style="width: 165px;"><active data-reactid=".1d.h.0"></active><a class="toc-outline-theme-github" href="#sr-toc-17" data-reactid=".1d.h.1"><span data-reactid=".1d.h.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".1d.i" style="width: 165px;"><active data-reactid=".1d.i.0"></active><a class="toc-outline-theme-github" href="#sr-toc-18" data-reactid=".1d.i.1"><span data-reactid=".1d.i.1.0">精选留言 (8)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/238614" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>