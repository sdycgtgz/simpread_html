
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 24｜管理进程：如何设计完善的运行命令？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>24｜管理进程：如何设计完善的运行命令？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">细节和生态是 Gin 如此成功核心原因。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">24｜管理进程：如何设计完善的运行命令？</h1><div><span>叶剑峰</span> <span> 2021-11-10</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a8/15/a89c319f1ee6970649d6daf8a6a71c15.jpeg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：叶剑峰</span><span>大小：14.33M</span><span> 时长：15:41</span></div></div><audio title="24｜管理进程：如何设计完善的运行命令？" src="https://res001.geekbang.org/media/audio/57/3f/575a3eae630d30fc4370fd447d7b3f3f/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="17137" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="17138"><span data-slate-object="text" data-key="17139"><span data-slate-leaf="true" data-offset-key="17139:0" data-first-offset="true"><span data-slate-string="true">你好，我是轩脉刃。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17140"><span data-slate-object="text" data-key="17141"><span data-slate-leaf="true" data-offset-key="17141:0" data-first-offset="true"><span data-slate-string="true">在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17142"><span data-slate-object="text" data-key="17143"><span data-slate-leaf="true" data-offset-key="17143:0" data-first-offset="true"><span data-slate-string="true">第 13 章</span></span></span></a><span data-slate-object="text" data-key="17144"><span data-slate-leaf="true" data-offset-key="17144:0" data-first-offset="true"><span data-slate-string="true">我们引入命令行的时候，将 Web 启动方式改成了一个命令行。但是当时只完成了一个最简单的启动 Web 服务的命令，这节课，我们要做的是完善这个 Web 服务运行命令，让 Web 服务的运行有完整的启动、停止、重启、查询的进程管理功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17145"><span data-slate-object="text" data-key="17146"><span data-slate-leaf="true" data-offset-key="17146:0" data-first-offset="true"><span data-slate-string="true">这套完整的进程管理功能，能让应用管理者非常方便地通过一套命令来统一管控一个应用，降低应用管理者的管理成本，后续也能为实现应用自动化部署到远端服务的工具提供了基础。下面我们来具体看下如何设计这套命令并且实现它吧。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17147" id="sr-toc-1"><span data-slate-object="text" data-key="17148"><span data-slate-leaf="true" data-offset-key="17148:0" data-first-offset="true"><span data-slate-string="true">运行命令的设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17149"><span data-slate-object="text" data-key="17150"><span data-slate-leaf="true" data-offset-key="17150:0" data-first-offset="true"><span data-slate-string="true">首先照惯例需要设计一下运行命令，一级命令为 app，二级命令设计如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17151"><div data-slate-type="list-line" data-slate-object="block" data-key="17152"><span data-slate-type="code" data-slate-object="inline" data-key="17153"><span data-slate-object="text" data-key="17154"><span data-slate-leaf="true" data-offset-key="17154:0" data-first-offset="true"><span data-slate-string="true">./hade app start</span></span></span></span><span data-slate-object="text" data-key="17155"><span data-slate-leaf="true" data-offset-key="17155:0" data-first-offset="true"><span data-slate-string="true"> 二级命令，启动一个 app 服务</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17156"><span data-slate-type="code" data-slate-object="inline" data-key="17157"><span data-slate-object="text" data-key="17158"><span data-slate-leaf="true" data-offset-key="17158:0" data-first-offset="true"><span data-slate-string="true">./hade app state</span></span></span></span><span data-slate-object="text" data-key="17159"><span data-slate-leaf="true" data-offset-key="17159:0" data-first-offset="true"><span data-slate-string="true"> 二级命令，获取启动的 app 的信息</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17160"><span data-slate-type="code" data-slate-object="inline" data-key="17161"><span data-slate-object="text" data-key="17162"><span data-slate-leaf="true" data-offset-key="17162:0" data-first-offset="true"><span data-slate-string="true">./hade app stop</span></span></span></span><span data-slate-object="text" data-key="17163"><span data-slate-leaf="true" data-offset-key="17163:0" data-first-offset="true"><span data-slate-string="true"> 二级命令，停止已经启动的 app 服务</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17164"><span data-slate-type="code" data-slate-object="inline" data-key="17165"><span data-slate-object="text" data-key="17166"><span data-slate-leaf="true" data-offset-key="17166:0" data-first-offset="true"><span data-slate-string="true">./hade app restart</span></span></span></span><span data-slate-object="text" data-key="17167"><span data-slate-leaf="true" data-offset-key="17167:0" data-first-offset="true"><span data-slate-string="true"> 二级命令，重新启动一个 app 服务</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17168"><span data-slate-object="text" data-key="17169"><span data-slate-leaf="true" data-offset-key="17169:0" data-first-offset="true"><span data-slate-string="true">这四个二级命令，有 app 服务的启动、停止、重启、查询，基本上已经把一个 app 服务启动的状态变更都包含了，能基本满足后面我们对于一个应用的管理需求。下面来讨论下每个命令的功能和设计。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17170" id="sr-toc-2"><span data-slate-object="text" data-key="17171"><span data-slate-leaf="true" data-offset-key="17171:0" data-first-offset="true"><span data-slate-string="true">启动命令</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17172"><span data-slate-object="text" data-key="17173"><span data-slate-leaf="true" data-offset-key="17173:0" data-first-offset="true"><span data-slate-string="true">首先是 start 这个命令，写在 framework/command/app.go 中。我们先分析下参数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17174"><span data-slate-object="text" data-key="17175"><span data-slate-leaf="true" data-offset-key="17175:0" data-first-offset="true"><span data-slate-string="true">想要启动 app 服务，至少需要一个参数，就是</span></span></span><span data-slate-object="text" data-key="17176"><span data-slate-leaf="true" data-offset-key="17176:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">启动服务的监听地址</span></span></span></span><span data-slate-object="text" data-key="17177"><span data-slate-leaf="true" data-offset-key="17177:0" data-first-offset="true"><span data-slate-string="true">。如何获取呢？首先可以直接从默认配置获取，另外因为这是一个控制台命令，也一定可以直接从命令行获取。除了这两种方式，我们回顾下之前的配置项获取方法，还有环境变量和配置项。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17178"><span data-slate-object="text" data-key="17179"><span data-slate-leaf="true" data-offset-key="17179:0" data-first-offset="true"><span data-slate-string="true">所以总结起来，环境变量这个参数我们设计为有四个方式可以获取，一个是直接从命令行参数获取 address 参数，二是从环境变量 ADDRESS 中获取，然后是从配置文件中获取配置项 app.address，最后如果以上三个方式都没有设置，就使用默认值：8888。关键的代码逻辑如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17180"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17181"><span data-slate-object="text" data-key="17182"><span data-slate-leaf="true" data-offset-key="17182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17183"><span data-slate-leaf="true" data-offset-key="17183:0" data-first-offset="true"><span data-slate-string="true"> appAddress == </span></span></span><span data-slate-object="text" data-key="17184"><span data-slate-leaf="true" data-offset-key="17184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="17185"><span data-slate-leaf="true" data-offset-key="17185:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17186"><span data-slate-object="text" data-key="17187"><span data-slate-leaf="true" data-offset-key="17187:0" data-first-offset="true"><span data-slate-string="true">    envService := container.MustMake(contract.EnvKey).(contract.Env)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17188"><span data-slate-object="text" data-key="17189"><span data-slate-leaf="true" data-offset-key="17189:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17190"><span data-slate-leaf="true" data-offset-key="17190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17191"><span data-slate-leaf="true" data-offset-key="17191:0" data-first-offset="true"><span data-slate-string="true"> envService.Get(</span></span></span><span data-slate-object="text" data-key="17192"><span data-slate-leaf="true" data-offset-key="17192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ADDRESS"</span></span></span></span><span data-slate-object="text" data-key="17193"><span data-slate-leaf="true" data-offset-key="17193:0" data-first-offset="true"><span data-slate-string="true">) != </span></span></span><span data-slate-object="text" data-key="17194"><span data-slate-leaf="true" data-offset-key="17194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="17195"><span data-slate-leaf="true" data-offset-key="17195:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17196"><span data-slate-object="text" data-key="17197"><span data-slate-leaf="true" data-offset-key="17197:0" data-first-offset="true"><span data-slate-string="true">        appAddress = envService.Get(</span></span></span><span data-slate-object="text" data-key="17198"><span data-slate-leaf="true" data-offset-key="17198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ADDRESS"</span></span></span></span><span data-slate-object="text" data-key="17199"><span data-slate-leaf="true" data-offset-key="17199:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17200"><span data-slate-object="text" data-key="17201"><span data-slate-leaf="true" data-offset-key="17201:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="17202"><span data-slate-leaf="true" data-offset-key="17202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17203"><span data-slate-leaf="true" data-offset-key="17203:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17204"><span data-slate-object="text" data-key="17205"><span data-slate-leaf="true" data-offset-key="17205:0" data-first-offset="true"><span data-slate-string="true">        configService := container.MustMake(contract.ConfigKey).(contract.Config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17206"><span data-slate-object="text" data-key="17207"><span data-slate-leaf="true" data-offset-key="17207:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17208"><span data-slate-leaf="true" data-offset-key="17208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17209"><span data-slate-leaf="true" data-offset-key="17209:0" data-first-offset="true"><span data-slate-string="true"> configService.IsExist(</span></span></span><span data-slate-object="text" data-key="17210"><span data-slate-leaf="true" data-offset-key="17210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.address"</span></span></span></span><span data-slate-object="text" data-key="17211"><span data-slate-leaf="true" data-offset-key="17211:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17212"><span data-slate-object="text" data-key="17213"><span data-slate-leaf="true" data-offset-key="17213:0" data-first-offset="true"><span data-slate-string="true">            appAddress = configService.GetString(</span></span></span><span data-slate-object="text" data-key="17214"><span data-slate-leaf="true" data-offset-key="17214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.address"</span></span></span></span><span data-slate-object="text" data-key="17215"><span data-slate-leaf="true" data-offset-key="17215:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17216"><span data-slate-object="text" data-key="17217"><span data-slate-leaf="true" data-offset-key="17217:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="17218"><span data-slate-leaf="true" data-offset-key="17218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17219"><span data-slate-leaf="true" data-offset-key="17219:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17220"><span data-slate-object="text" data-key="17221"><span data-slate-leaf="true" data-offset-key="17221:0" data-first-offset="true"><span data-slate-string="true">            appAddress = </span></span></span><span data-slate-object="text" data-key="17222"><span data-slate-leaf="true" data-offset-key="17222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">":8888"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17223"><span data-slate-object="text" data-key="17224"><span data-slate-leaf="true" data-offset-key="17224:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17225"><span data-slate-object="text" data-key="17226"><span data-slate-leaf="true" data-offset-key="17226:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17227"><span data-slate-object="text" data-key="17228"><span data-slate-leaf="true" data-offset-key="17228:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17229"><span data-slate-object="text" data-key="17230"><span data-slate-leaf="true" data-offset-key="17230:0" data-first-offset="true"><span data-slate-string="true">除了监听地址的参数，回忆之前 cron 命令运行的时候，启动 app 服务，我们是有两种启动方式的，一种是启动后直接挂在控制台，这种启动方式适合调试开发使用；而另外一种，以守护进程 daemon 的方式启动，直接挂载在后台。所以，对于这两种启动方式，我们也需要有一个参数 daemon，标记是使用哪种方式启动。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17231"><span data-slate-object="text" data-key="17232"><span data-slate-leaf="true" data-offset-key="17232:0" data-first-offset="true"><span data-slate-string="true">有了 appAddress、daemon 这两个参数，我们顺着继续想</span></span></span><span data-slate-object="text" data-key="17233"><span data-slate-leaf="true" data-offset-key="17233:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">启动服务时需要的记录文件</span></span></span></span><span data-slate-object="text" data-key="17234"><span data-slate-leaf="true" data-offset-key="17234:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17235"><span data-slate-object="text" data-key="17236"><span data-slate-leaf="true" data-offset-key="17236:0" data-first-offset="true"><span data-slate-string="true">不管是使用挂载方式，还是 daemon 方式启动进程，都能获取到一个进程 PID，启动 app 服务的时候，要将这个 PID 记录在一个文件中，这里我们就存储在 app/storage/runtime/app.pid 文件中。在运行时候，需要保证这个目录和文件是存在的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17237"><span data-slate-object="text" data-key="17238"><span data-slate-leaf="true" data-offset-key="17238:0" data-first-offset="true"><span data-slate-string="true">同时也会产生日志，日志存放在 app/storage/log/app.log 中，所以我们要确认这个目录是否存在。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17239"><span data-slate-object="text" data-key="17240"><span data-slate-leaf="true" data-offset-key="17240:0" data-first-offset="true"><span data-slate-string="true">关于 app.pid 和 app.log 对应的代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17241"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17242"><span data-slate-object="text" data-key="17243"><span data-slate-leaf="true" data-offset-key="17243:0" data-first-offset="true"><span data-slate-string="true">appService := container.MustMake(contract.AppKey).(contract.App)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17244"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17245"><span data-slate-object="text" data-key="17246"><span data-slate-leaf="true" data-offset-key="17246:0" data-first-offset="true"><span data-slate-string="true">pidFolder := appService.RuntimeFolder()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17247"><span data-slate-object="text" data-key="17248"><span data-slate-leaf="true" data-offset-key="17248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17249"><span data-slate-leaf="true" data-offset-key="17249:0" data-first-offset="true"><span data-slate-string="true"> !util.Exists(pidFolder) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17250"><span data-slate-object="text" data-key="17251"><span data-slate-leaf="true" data-offset-key="17251:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17252"><span data-slate-leaf="true" data-offset-key="17252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17253"><span data-slate-leaf="true" data-offset-key="17253:0" data-first-offset="true"><span data-slate-string="true"> err := os.MkdirAll(pidFolder, os.ModePerm); err != </span></span></span><span data-slate-object="text" data-key="17254"><span data-slate-leaf="true" data-offset-key="17254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17255"><span data-slate-leaf="true" data-offset-key="17255:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17256"><span data-slate-object="text" data-key="17257"><span data-slate-leaf="true" data-offset-key="17257:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17258"><span data-slate-leaf="true" data-offset-key="17258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17259"><span data-slate-leaf="true" data-offset-key="17259:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17260"><span data-slate-object="text" data-key="17261"><span data-slate-leaf="true" data-offset-key="17261:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17262"><span data-slate-object="text" data-key="17263"><span data-slate-leaf="true" data-offset-key="17263:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17264"><span data-slate-object="text" data-key="17265"><span data-slate-leaf="true" data-offset-key="17265:0" data-first-offset="true"><span data-slate-string="true">serverPidFile := filepath.Join(pidFolder, </span></span></span><span data-slate-object="text" data-key="17266"><span data-slate-leaf="true" data-offset-key="17266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.pid"</span></span></span></span><span data-slate-object="text" data-key="17267"><span data-slate-leaf="true" data-offset-key="17267:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17268"><span data-slate-object="text" data-key="17269"><span data-slate-leaf="true" data-offset-key="17269:0" data-first-offset="true"><span data-slate-string="true">logFolder := appService.LogFolder()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17270"><span data-slate-object="text" data-key="17271"><span data-slate-leaf="true" data-offset-key="17271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17272"><span data-slate-leaf="true" data-offset-key="17272:0" data-first-offset="true"><span data-slate-string="true"> !util.Exists(logFolder) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17273"><span data-slate-object="text" data-key="17274"><span data-slate-leaf="true" data-offset-key="17274:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17275"><span data-slate-leaf="true" data-offset-key="17275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17276"><span data-slate-leaf="true" data-offset-key="17276:0" data-first-offset="true"><span data-slate-string="true"> err := os.MkdirAll(logFolder, os.ModePerm); err != </span></span></span><span data-slate-object="text" data-key="17277"><span data-slate-leaf="true" data-offset-key="17277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17278"><span data-slate-leaf="true" data-offset-key="17278:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17279"><span data-slate-object="text" data-key="17280"><span data-slate-leaf="true" data-offset-key="17280:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17281"><span data-slate-leaf="true" data-offset-key="17281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17282"><span data-slate-leaf="true" data-offset-key="17282:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17283"><span data-slate-object="text" data-key="17284"><span data-slate-leaf="true" data-offset-key="17284:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17285"><span data-slate-object="text" data-key="17286"><span data-slate-leaf="true" data-offset-key="17286:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17287"><span data-slate-object="text" data-key="17288"><span data-slate-leaf="true" data-offset-key="17288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 应用日志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17289"><span data-slate-object="text" data-key="17290"><span data-slate-leaf="true" data-offset-key="17290:0" data-first-offset="true"><span data-slate-string="true">serverLogFile := filepath.Join(logFolder, </span></span></span><span data-slate-object="text" data-key="17291"><span data-slate-leaf="true" data-offset-key="17291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.log"</span></span></span></span><span data-slate-object="text" data-key="17292"><span data-slate-leaf="true" data-offset-key="17292:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17293"><span data-slate-object="text" data-key="17294"><span data-slate-leaf="true" data-offset-key="17294:0" data-first-offset="true"><span data-slate-string="true">currentFolder := util.GetExecDirectory()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17295"><span data-slate-object="text" data-key="17296"><span data-slate-leaf="true" data-offset-key="17296:0" data-first-offset="true"><span data-slate-string="true">好到这里，准备工作都做好了，我们看看 Web 服务的启动，逻辑和之前设计的基本上没有什么区别，使用 net/http 来启动一个 Web 服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17297"><span data-slate-object="text" data-key="17298"><span data-slate-leaf="true" data-offset-key="17298:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">重点是启动的时候注意设置优雅关闭机制</span></span></span></span><span data-slate-object="text" data-key="17299"><span data-slate-leaf="true" data-offset-key="17299:0" data-first-offset="true"><span data-slate-string="true">。先使用</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17300"><span data-slate-object="text" data-key="17301"><span data-slate-leaf="true" data-offset-key="17301:0" data-first-offset="true"><span data-slate-string="true">第六章</span></span></span></a><span data-slate-object="text" data-key="17302"><span data-slate-leaf="true" data-offset-key="17302:0" data-first-offset="true"><span data-slate-string="true">实现的优雅关闭机制：开启一个 Goroutine 启动服务，主 Goroutine 监听信号，当获取到信号之后，等待所有请求都结束或者超过最长等待时长，就结束信号。当然，这里的最长等待时长可以设置为配置项，从 app.close_wait 配置项中获取，如果没有配置项，我们默认使用 5s 的最长等待时长。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17303"><span data-slate-object="text" data-key="17304"><span data-slate-leaf="true" data-offset-key="17304:0" data-first-offset="true"><span data-slate-string="true">启动相关代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17305"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17306"><span data-slate-object="text" data-key="17307"><span data-slate-leaf="true" data-offset-key="17307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动 AppServer, 这个函数会将当前 goroutine 阻塞</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17308"><span data-slate-object="text" data-key="17309"><span data-slate-leaf="true" data-offset-key="17309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17310"><span data-slate-leaf="true" data-offset-key="17310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17311"><span data-slate-leaf="true" data-offset-key="17311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startAppServe</span></span></span></span></span><span data-slate-object="text" data-key="17312"><span data-slate-leaf="true" data-offset-key="17312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(server *http.Server, c framework.Container)</span></span></span></span></span><span data-slate-object="text" data-key="17313"><span data-slate-leaf="true" data-offset-key="17313:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17314"><span data-slate-leaf="true" data-offset-key="17314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17315"><span data-slate-leaf="true" data-offset-key="17315:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17316"><span data-slate-object="text" data-key="17317"><span data-slate-leaf="true" data-offset-key="17317:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17318"><span data-slate-leaf="true" data-offset-key="17318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个 goroutine 是启动服务的 goroutine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17319"><span data-slate-object="text" data-key="17320"><span data-slate-leaf="true" data-offset-key="17320:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17321"><span data-slate-leaf="true" data-offset-key="17321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17322"><span data-slate-leaf="true" data-offset-key="17322:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17323"><span data-slate-leaf="true" data-offset-key="17323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17324"><span data-slate-leaf="true" data-offset-key="17324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17325"><span data-slate-leaf="true" data-offset-key="17325:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17326"><span data-slate-object="text" data-key="17327"><span data-slate-leaf="true" data-offset-key="17327:0" data-first-offset="true"><span data-slate-string="true">        server.ListenAndServe()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17328"><span data-slate-object="text" data-key="17329"><span data-slate-leaf="true" data-offset-key="17329:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17330"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17331"><span data-slate-object="text" data-key="17332"><span data-slate-leaf="true" data-offset-key="17332:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17333"><span data-slate-leaf="true" data-offset-key="17333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前的 goroutine 等待信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17334"><span data-slate-object="text" data-key="17335"><span data-slate-leaf="true" data-offset-key="17335:0" data-first-offset="true"><span data-slate-string="true">    quit := </span></span></span><span data-slate-object="text" data-key="17336"><span data-slate-leaf="true" data-offset-key="17336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17337"><span data-slate-leaf="true" data-offset-key="17337:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17338"><span data-slate-leaf="true" data-offset-key="17338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17339"><span data-slate-leaf="true" data-offset-key="17339:0" data-first-offset="true"><span data-slate-string="true"> os.Signal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17340"><span data-slate-object="text" data-key="17341"><span data-slate-leaf="true" data-offset-key="17341:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17342"><span data-slate-leaf="true" data-offset-key="17342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监控信号：SIGINT, SIGTERM, SIGQUIT</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17343"><span data-slate-object="text" data-key="17344"><span data-slate-leaf="true" data-offset-key="17344:0" data-first-offset="true"><span data-slate-string="true">    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17345"><span data-slate-object="text" data-key="17346"><span data-slate-leaf="true" data-offset-key="17346:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17347"><span data-slate-leaf="true" data-offset-key="17347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里会阻塞当前 goroutine 等待信号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17348"><span data-slate-object="text" data-key="17349"><span data-slate-leaf="true" data-offset-key="17349:0" data-first-offset="true"><span data-slate-string="true">    &lt;-quit</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17350"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17351"><span data-slate-object="text" data-key="17352"><span data-slate-leaf="true" data-offset-key="17352:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17353"><span data-slate-leaf="true" data-offset-key="17353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 Server.Shutdown graceful 结束</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17354"><span data-slate-object="text" data-key="17355"><span data-slate-leaf="true" data-offset-key="17355:0" data-first-offset="true"><span data-slate-string="true">    closeWait := </span></span></span><span data-slate-object="text" data-key="17356"><span data-slate-leaf="true" data-offset-key="17356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17357"><span data-slate-object="text" data-key="17358"><span data-slate-leaf="true" data-offset-key="17358:0" data-first-offset="true"><span data-slate-string="true">    configService := c.MustMake(contract.ConfigKey).(contract.Config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17359"><span data-slate-object="text" data-key="17360"><span data-slate-leaf="true" data-offset-key="17360:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17361"><span data-slate-leaf="true" data-offset-key="17361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17362"><span data-slate-leaf="true" data-offset-key="17362:0" data-first-offset="true"><span data-slate-string="true"> configService.IsExist(</span></span></span><span data-slate-object="text" data-key="17363"><span data-slate-leaf="true" data-offset-key="17363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.close_wait"</span></span></span></span><span data-slate-object="text" data-key="17364"><span data-slate-leaf="true" data-offset-key="17364:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17365"><span data-slate-object="text" data-key="17366"><span data-slate-leaf="true" data-offset-key="17366:0" data-first-offset="true"><span data-slate-string="true">        closeWait = configService.GetInt(</span></span></span><span data-slate-object="text" data-key="17367"><span data-slate-leaf="true" data-offset-key="17367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.close_wait"</span></span></span></span><span data-slate-object="text" data-key="17368"><span data-slate-leaf="true" data-offset-key="17368:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17369"><span data-slate-object="text" data-key="17370"><span data-slate-leaf="true" data-offset-key="17370:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17371"><span data-slate-object="text" data-key="17372"><span data-slate-leaf="true" data-offset-key="17372:0" data-first-offset="true"><span data-slate-string="true">    timeoutCtx, cancel := context.WithTimeout(context.Background(), time.Duration(closeWait)*time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17373"><span data-slate-object="text" data-key="17374"><span data-slate-leaf="true" data-offset-key="17374:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17375"><span data-slate-leaf="true" data-offset-key="17375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="17376"><span data-slate-leaf="true" data-offset-key="17376:0" data-first-offset="true"><span data-slate-string="true"> cancel()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17377"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17378"><span data-slate-object="text" data-key="17379"><span data-slate-leaf="true" data-offset-key="17379:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17380"><span data-slate-leaf="true" data-offset-key="17380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17381"><span data-slate-leaf="true" data-offset-key="17381:0" data-first-offset="true"><span data-slate-string="true"> err := server.Shutdown(timeoutCtx); err != </span></span></span><span data-slate-object="text" data-key="17382"><span data-slate-leaf="true" data-offset-key="17382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17383"><span data-slate-leaf="true" data-offset-key="17383:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17384"><span data-slate-object="text" data-key="17385"><span data-slate-leaf="true" data-offset-key="17385:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17386"><span data-slate-leaf="true" data-offset-key="17386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17387"><span data-slate-leaf="true" data-offset-key="17387:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17388"><span data-slate-object="text" data-key="17389"><span data-slate-leaf="true" data-offset-key="17389:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17390"><span data-slate-object="text" data-key="17391"><span data-slate-leaf="true" data-offset-key="17391:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17392"><span data-slate-leaf="true" data-offset-key="17392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17393"><span data-slate-leaf="true" data-offset-key="17393:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17394"><span data-slate-leaf="true" data-offset-key="17394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17395"><span data-slate-object="text" data-key="17396"><span data-slate-leaf="true" data-offset-key="17396:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17397"><span data-slate-object="text" data-key="17398"><span data-slate-leaf="true" data-offset-key="17398:0" data-first-offset="true"><span data-slate-string="true">但是这里还出现了一个问题，挂在控制台的启动，比较简单，直接调用封装好的 startAppServe 就行了。但 daemon 方式如何启动呢？它是不能直接在主进程中调用 startAppServe 方法的，会把主进程给阻塞挂起来了，怎么办呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17399"><span data-slate-object="text" data-key="17400"><span data-slate-leaf="true" data-offset-key="17400:0" data-first-offset="true"><span data-slate-string="true">这个其实在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17401"><span data-slate-object="text" data-key="17402"><span data-slate-leaf="true" data-offset-key="17402:0" data-first-offset="true"><span data-slate-string="true">第十四章</span></span></span></a><span data-slate-object="text" data-key="17403"><span data-slate-leaf="true" data-offset-key="17403:0" data-first-offset="true"><span data-slate-string="true">定时任务中有说到，我们可以使用和定时任务一样的实现机制，使用开源库 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17404"><span data-slate-object="text" data-key="17405"><span data-slate-leaf="true" data-offset-key="17405:0" data-first-offset="true"><span data-slate-string="true">go-daemon</span></span></span></a><span data-slate-object="text" data-key="17406"><span data-slate-leaf="true" data-offset-key="17406:0" data-first-offset="true"><span data-slate-string="true">。比较重要，所以这里再啰嗦一下，</span></span></span><span data-slate-object="text" data-key="17407"><span data-slate-leaf="true" data-offset-key="17407:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">理解 go-daemon 库的使用，要理解最核心的 daemon.Context 结构</span></span></span></span><span data-slate-object="text" data-key="17408"><span data-slate-leaf="true" data-offset-key="17408:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17409"><span data-slate-object="text" data-key="17410"><span data-slate-leaf="true" data-offset-key="17410:0" data-first-offset="true"><span data-slate-string="true">在我们框架这个需求中，daemon 方式启动命令为  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17411"><span data-slate-object="text" data-key="17412"><span data-slate-leaf="true" data-offset-key="17412:0" data-first-offset="true"><span data-slate-string="true">./hade app start --daemon=true</span></span></span></span><span data-slate-object="text" data-key="17413"><span data-slate-leaf="true" data-offset-key="17413:0" data-first-offset="true"><span data-slate-string="true"> 。所以在 daemon.Context 结构中的 Args 参数填写如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17414"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17415"><span data-slate-object="text" data-key="17416"><span data-slate-leaf="true" data-offset-key="17416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建一个 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17417"><span data-slate-object="text" data-key="17418"><span data-slate-leaf="true" data-offset-key="17418:0" data-first-offset="true"><span data-slate-string="true">cntxt := &amp;daemon.Context{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17419"><span data-slate-object="text" data-key="17420"><span data-slate-leaf="true" data-offset-key="17420:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17421"><span data-slate-object="text" data-key="17422"><span data-slate-leaf="true" data-offset-key="17422:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17423"><span data-slate-leaf="true" data-offset-key="17423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 子进程的参数，按照这个参数设置，子进程的命令为 ./hade app start --daemon=true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17424"><span data-slate-object="text" data-key="17425"><span data-slate-leaf="true" data-offset-key="17425:0" data-first-offset="true"><span data-slate-string="true">   Args: []</span></span></span><span data-slate-object="text" data-key="17426"><span data-slate-leaf="true" data-offset-key="17426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="17427"><span data-slate-leaf="true" data-offset-key="17427:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="17428"><span data-slate-leaf="true" data-offset-key="17428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="17429"><span data-slate-leaf="true" data-offset-key="17429:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17430"><span data-slate-leaf="true" data-offset-key="17430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app"</span></span></span></span><span data-slate-object="text" data-key="17431"><span data-slate-leaf="true" data-offset-key="17431:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17432"><span data-slate-leaf="true" data-offset-key="17432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start"</span></span></span></span><span data-slate-object="text" data-key="17433"><span data-slate-leaf="true" data-offset-key="17433:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17434"><span data-slate-leaf="true" data-offset-key="17434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"--daemon=true"</span></span></span></span><span data-slate-object="text" data-key="17435"><span data-slate-leaf="true" data-offset-key="17435:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17436"><span data-slate-object="text" data-key="17437"><span data-slate-leaf="true" data-offset-key="17437:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17438"><span data-slate-object="text" data-key="17439"><span data-slate-leaf="true" data-offset-key="17439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动子进程，d 不为空表示当前是父进程，d 为空表示当前是子进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17440"><span data-slate-object="text" data-key="17441"><span data-slate-leaf="true" data-offset-key="17441:0" data-first-offset="true"><span data-slate-string="true">d, err := cntxt.Reborn()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17442"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17443"><span data-slate-object="text" data-key="17444"><span data-slate-leaf="true" data-offset-key="17444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17445"><span data-slate-leaf="true" data-offset-key="17445:0" data-first-offset="true"><span data-slate-string="true"> d != </span></span></span><span data-slate-object="text" data-key="17446"><span data-slate-leaf="true" data-offset-key="17446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17447"><span data-slate-leaf="true" data-offset-key="17447:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17448"><span data-slate-object="text" data-key="17449"><span data-slate-leaf="true" data-offset-key="17449:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17450"><span data-slate-leaf="true" data-offset-key="17450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 父进程直接打印启动成功信息，不做任何操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17451"><span data-slate-object="text" data-key="17452"><span data-slate-leaf="true" data-offset-key="17452:0" data-first-offset="true"><span data-slate-string="true">   fmt.Println(</span></span></span><span data-slate-object="text" data-key="17453"><span data-slate-leaf="true" data-offset-key="17453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app 启动成功，pid:"</span></span></span></span><span data-slate-object="text" data-key="17454"><span data-slate-leaf="true" data-offset-key="17454:0" data-first-offset="true"><span data-slate-string="true">, d.Pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17455"><span data-slate-object="text" data-key="17456"><span data-slate-leaf="true" data-offset-key="17456:0" data-first-offset="true"><span data-slate-string="true">   fmt.Println(</span></span></span><span data-slate-object="text" data-key="17457"><span data-slate-leaf="true" data-offset-key="17457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"日志文件:"</span></span></span></span><span data-slate-object="text" data-key="17458"><span data-slate-leaf="true" data-offset-key="17458:0" data-first-offset="true"><span data-slate-string="true">, serverLogFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17459"><span data-slate-object="text" data-key="17460"><span data-slate-leaf="true" data-offset-key="17460:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17461"><span data-slate-leaf="true" data-offset-key="17461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17462"><span data-slate-leaf="true" data-offset-key="17462:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17463"><span data-slate-leaf="true" data-offset-key="17463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17464"><span data-slate-object="text" data-key="17465"><span data-slate-leaf="true" data-offset-key="17465:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17466"><span data-slate-object="text" data-key="17467"><span data-slate-leaf="true" data-offset-key="17467:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17468"><span data-slate-object="text" data-key="17469"><span data-slate-leaf="true" data-offset-key="17469:0" data-first-offset="true"><span data-slate-string="true">有的同学对这个启动子进程的 Reborn 可能有些疑惑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17470"><span data-slate-object="text" data-key="17471"><span data-slate-leaf="true" data-offset-key="17471:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8607e7b7" data-attr-id="44496" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们把 Reborn 理解成 fork，</span></span></span><span data-slate-leaf="true" data-offset-key="17471:1"><span data-slate-string="true">当调用这个函数的时候，父进程会继续往下走，但是返回值 d 不为空，它的信息是子进程的进程号等信息。而子进程会重新运行对应的命令，再次进入到 Reborn 函数的时候，返回的 d 就为 nil。所以</span></span></span><span data-slate-object="text" data-key="17472"><span data-slate-leaf="true" data-offset-key="17472:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 Reborn 的后面，我们让父进程直接 return，而让子进程继续往后进行操作，这样就达到了 fork 一个子进程的效果了</span></span></span></span><span data-slate-object="text" data-key="17473"><span data-slate-leaf="true" data-offset-key="17473:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17474"><span data-slate-object="text" data-key="17475"><span data-slate-leaf="true" data-offset-key="17475:0" data-first-offset="true"><span data-slate-string="true">理解了这一点，对应的代码就很简单了：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17476"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17477"><span data-slate-object="text" data-key="17478"><span data-slate-leaf="true" data-offset-key="17478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//daemon 模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17479"><span data-slate-object="text" data-key="17480"><span data-slate-leaf="true" data-offset-key="17480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17481"><span data-slate-leaf="true" data-offset-key="17481:0" data-first-offset="true"><span data-slate-string="true"> appDaemon {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17482"><span data-slate-object="text" data-key="17483"><span data-slate-leaf="true" data-offset-key="17483:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17484"><span data-slate-leaf="true" data-offset-key="17484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建一个 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17485"><span data-slate-object="text" data-key="17486"><span data-slate-leaf="true" data-offset-key="17486:0" data-first-offset="true"><span data-slate-string="true">    cntxt := &amp;daemon.Context{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17487"><span data-slate-object="text" data-key="17488"><span data-slate-leaf="true" data-offset-key="17488:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17489"><span data-slate-leaf="true" data-offset-key="17489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 pid 文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17490"><span data-slate-object="text" data-key="17491"><span data-slate-leaf="true" data-offset-key="17491:0" data-first-offset="true"><span data-slate-string="true">        PidFileName: serverPidFile,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17492"><span data-slate-object="text" data-key="17493"><span data-slate-leaf="true" data-offset-key="17493:0" data-first-offset="true"><span data-slate-string="true">        PidFilePerm: </span></span></span><span data-slate-object="text" data-key="17494"><span data-slate-leaf="true" data-offset-key="17494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0664</span></span></span></span><span data-slate-object="text" data-key="17495"><span data-slate-leaf="true" data-offset-key="17495:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17496"><span data-slate-object="text" data-key="17497"><span data-slate-leaf="true" data-offset-key="17497:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17498"><span data-slate-leaf="true" data-offset-key="17498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置日志文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17499"><span data-slate-object="text" data-key="17500"><span data-slate-leaf="true" data-offset-key="17500:0" data-first-offset="true"><span data-slate-string="true">        LogFileName: serverLogFile,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17501"><span data-slate-object="text" data-key="17502"><span data-slate-leaf="true" data-offset-key="17502:0" data-first-offset="true"><span data-slate-string="true">        LogFilePerm: </span></span></span><span data-slate-object="text" data-key="17503"><span data-slate-leaf="true" data-offset-key="17503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0640</span></span></span></span><span data-slate-object="text" data-key="17504"><span data-slate-leaf="true" data-offset-key="17504:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17505"><span data-slate-object="text" data-key="17506"><span data-slate-leaf="true" data-offset-key="17506:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17507"><span data-slate-leaf="true" data-offset-key="17507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置工作路径</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17508"><span data-slate-object="text" data-key="17509"><span data-slate-leaf="true" data-offset-key="17509:0" data-first-offset="true"><span data-slate-string="true">        WorkDir: currentFolder,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17510"><span data-slate-object="text" data-key="17511"><span data-slate-leaf="true" data-offset-key="17511:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17512"><span data-slate-leaf="true" data-offset-key="17512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置所有设置文件的 mask，默认为 750</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17513"><span data-slate-object="text" data-key="17514"><span data-slate-leaf="true" data-offset-key="17514:0" data-first-offset="true"><span data-slate-string="true">        Umask: </span></span></span><span data-slate-object="text" data-key="17515"><span data-slate-leaf="true" data-offset-key="17515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">027</span></span></span></span><span data-slate-object="text" data-key="17516"><span data-slate-leaf="true" data-offset-key="17516:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17517"><span data-slate-object="text" data-key="17518"><span data-slate-leaf="true" data-offset-key="17518:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17519"><span data-slate-leaf="true" data-offset-key="17519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 子进程的参数，按照这个参数设置，子进程的命令为 ./hade app start --daemon=true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17520"><span data-slate-object="text" data-key="17521"><span data-slate-leaf="true" data-offset-key="17521:0" data-first-offset="true"><span data-slate-string="true">        Args: []</span></span></span><span data-slate-object="text" data-key="17522"><span data-slate-leaf="true" data-offset-key="17522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="17523"><span data-slate-leaf="true" data-offset-key="17523:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="17524"><span data-slate-leaf="true" data-offset-key="17524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="17525"><span data-slate-leaf="true" data-offset-key="17525:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17526"><span data-slate-leaf="true" data-offset-key="17526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app"</span></span></span></span><span data-slate-object="text" data-key="17527"><span data-slate-leaf="true" data-offset-key="17527:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17528"><span data-slate-leaf="true" data-offset-key="17528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start"</span></span></span></span><span data-slate-object="text" data-key="17529"><span data-slate-leaf="true" data-offset-key="17529:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17530"><span data-slate-leaf="true" data-offset-key="17530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"--daemon=true"</span></span></span></span><span data-slate-object="text" data-key="17531"><span data-slate-leaf="true" data-offset-key="17531:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17532"><span data-slate-object="text" data-key="17533"><span data-slate-leaf="true" data-offset-key="17533:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17534"><span data-slate-object="text" data-key="17535"><span data-slate-leaf="true" data-offset-key="17535:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17536"><span data-slate-leaf="true" data-offset-key="17536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动子进程，d 不为空表示当前是父进程，d 为空表示当前是子进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17537"><span data-slate-object="text" data-key="17538"><span data-slate-leaf="true" data-offset-key="17538:0" data-first-offset="true"><span data-slate-string="true">    d, err := cntxt.Reborn()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17539"><span data-slate-object="text" data-key="17540"><span data-slate-leaf="true" data-offset-key="17540:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17541"><span data-slate-leaf="true" data-offset-key="17541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17542"><span data-slate-leaf="true" data-offset-key="17542:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17543"><span data-slate-leaf="true" data-offset-key="17543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17544"><span data-slate-leaf="true" data-offset-key="17544:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17545"><span data-slate-object="text" data-key="17546"><span data-slate-leaf="true" data-offset-key="17546:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17547"><span data-slate-leaf="true" data-offset-key="17547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17548"><span data-slate-leaf="true" data-offset-key="17548:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17549"><span data-slate-object="text" data-key="17550"><span data-slate-leaf="true" data-offset-key="17550:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17551"><span data-slate-object="text" data-key="17552"><span data-slate-leaf="true" data-offset-key="17552:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17553"><span data-slate-leaf="true" data-offset-key="17553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17554"><span data-slate-leaf="true" data-offset-key="17554:0" data-first-offset="true"><span data-slate-string="true"> d != </span></span></span><span data-slate-object="text" data-key="17555"><span data-slate-leaf="true" data-offset-key="17555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17556"><span data-slate-leaf="true" data-offset-key="17556:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17557"><span data-slate-object="text" data-key="17558"><span data-slate-leaf="true" data-offset-key="17558:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17559"><span data-slate-leaf="true" data-offset-key="17559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 父进程直接打印启动成功信息，不做任何操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17560"><span data-slate-object="text" data-key="17561"><span data-slate-leaf="true" data-offset-key="17561:0" data-first-offset="true"><span data-slate-string="true">        fmt.Println(</span></span></span><span data-slate-object="text" data-key="17562"><span data-slate-leaf="true" data-offset-key="17562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app 启动成功，pid:"</span></span></span></span><span data-slate-object="text" data-key="17563"><span data-slate-leaf="true" data-offset-key="17563:0" data-first-offset="true"><span data-slate-string="true">, d.Pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17564"><span data-slate-object="text" data-key="17565"><span data-slate-leaf="true" data-offset-key="17565:0" data-first-offset="true"><span data-slate-string="true">        fmt.Println(</span></span></span><span data-slate-object="text" data-key="17566"><span data-slate-leaf="true" data-offset-key="17566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"日志文件:"</span></span></span></span><span data-slate-object="text" data-key="17567"><span data-slate-leaf="true" data-offset-key="17567:0" data-first-offset="true"><span data-slate-string="true">, serverLogFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17568"><span data-slate-object="text" data-key="17569"><span data-slate-leaf="true" data-offset-key="17569:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17570"><span data-slate-leaf="true" data-offset-key="17570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17571"><span data-slate-leaf="true" data-offset-key="17571:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17572"><span data-slate-leaf="true" data-offset-key="17572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17573"><span data-slate-object="text" data-key="17574"><span data-slate-leaf="true" data-offset-key="17574:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17575"><span data-slate-object="text" data-key="17576"><span data-slate-leaf="true" data-offset-key="17576:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17577"><span data-slate-leaf="true" data-offset-key="17577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="17578"><span data-slate-leaf="true" data-offset-key="17578:0" data-first-offset="true"><span data-slate-string="true"> cntxt.Release()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17579"><span data-slate-object="text" data-key="17580"><span data-slate-leaf="true" data-offset-key="17580:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17581"><span data-slate-leaf="true" data-offset-key="17581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 子进程执行真正的 app 启动操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17582"><span data-slate-object="text" data-key="17583"><span data-slate-leaf="true" data-offset-key="17583:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="17584"><span data-slate-leaf="true" data-offset-key="17584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"deamon started"</span></span></span></span><span data-slate-object="text" data-key="17585"><span data-slate-leaf="true" data-offset-key="17585:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17586"><span data-slate-object="text" data-key="17587"><span data-slate-leaf="true" data-offset-key="17587:0" data-first-offset="true"><span data-slate-string="true">    gspt.SetProcTitle(</span></span></span><span data-slate-object="text" data-key="17588"><span data-slate-leaf="true" data-offset-key="17588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hade app"</span></span></span></span><span data-slate-object="text" data-key="17589"><span data-slate-leaf="true" data-offset-key="17589:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17590"><span data-slate-object="text" data-key="17591"><span data-slate-leaf="true" data-offset-key="17591:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17592"><span data-slate-leaf="true" data-offset-key="17592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17593"><span data-slate-leaf="true" data-offset-key="17593:0" data-first-offset="true"><span data-slate-string="true"> err := startAppServe(server, container); err != </span></span></span><span data-slate-object="text" data-key="17594"><span data-slate-leaf="true" data-offset-key="17594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17595"><span data-slate-leaf="true" data-offset-key="17595:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17596"><span data-slate-object="text" data-key="17597"><span data-slate-leaf="true" data-offset-key="17597:0" data-first-offset="true"><span data-slate-string="true">        fmt.Println(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17598"><span data-slate-object="text" data-key="17599"><span data-slate-leaf="true" data-offset-key="17599:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17600"><span data-slate-object="text" data-key="17601"><span data-slate-leaf="true" data-offset-key="17601:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17602"><span data-slate-leaf="true" data-offset-key="17602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17603"><span data-slate-leaf="true" data-offset-key="17603:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17604"><span data-slate-leaf="true" data-offset-key="17604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17605"><span data-slate-object="text" data-key="17606"><span data-slate-leaf="true" data-offset-key="17606:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17607"><span data-slate-object="text" data-key="17608"><span data-slate-leaf="true" data-offset-key="17608:0" data-first-offset="true"><span data-slate-string="true">到这里服务的进程启动成功，最后还有一点细节，对于启动的进程，我们一般都希望能自定义它的进程名称。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17609"><span data-slate-object="text" data-key="17610"><span data-slate-leaf="true" data-offset-key="17610:0" data-first-offset="true"><span data-slate-string="true">这里可以使用一个第三方库 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17611"><span data-slate-object="text" data-key="17612"><span data-slate-leaf="true" data-offset-key="17612:0" data-first-offset="true"><span data-slate-string="true">gspt</span></span></span></a><span data-slate-object="text" data-key="17613"><span data-slate-leaf="true" data-offset-key="17613:0" data-first-offset="true"><span data-slate-string="true">。它使用 MIT 协议，虽然 star 数不多，但是我个人亲测是功能齐全且有效的。在 Golang 中没有现成的设置进程名称的方法，只能调用 C 的设置进程名称的方法 setproctitle。所以这个库使用的方式是，使用 cgo 从 Go 中调用 C 的方法来实现进程名称的修改。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17614"><span data-slate-object="text" data-key="17615"><span data-slate-leaf="true" data-offset-key="17615:0" data-first-offset="true"><span data-slate-string="true">它的使用非常简单，就是一个函数 SetProcTitle 方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17616"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17617"><span data-slate-object="text" data-key="17618"><span data-slate-leaf="true" data-offset-key="17618:0" data-first-offset="true"><span data-slate-string="true">gspt.SetProcTitle(</span></span></span><span data-slate-object="text" data-key="17619"><span data-slate-leaf="true" data-offset-key="17619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hade app"</span></span></span></span><span data-slate-object="text" data-key="17620"><span data-slate-leaf="true" data-offset-key="17620:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17621"><span data-slate-object="text" data-key="17622"><span data-slate-leaf="true" data-offset-key="17622:0" data-first-offset="true"><span data-slate-string="true">现在，进程的启动就基本完成了。当然最后还有非常重要的关闭逻辑也记得加上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17623"><span data-slate-object="text" data-key="17624"><span data-slate-leaf="true" data-offset-key="17624:0" data-first-offset="true"><span data-slate-string="true">好了，以上我们讨论了 start 的关键设计，再回头梳理一遍这个命令的实现步骤：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17625"><div data-slate-type="list-line" data-slate-object="block" data-key="17626"><span data-slate-object="text" data-key="17627"><span data-slate-leaf="true" data-offset-key="17627:0" data-first-offset="true"><span data-slate-string="true">从四个方式获取参数 appAddress</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17628"><span data-slate-object="text" data-key="17629"><span data-slate-leaf="true" data-offset-key="17629:0" data-first-offset="true"><span data-slate-string="true">获取参数 daemon</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17630"><span data-slate-object="text" data-key="17631"><span data-slate-leaf="true" data-offset-key="17631:0" data-first-offset="true"><span data-slate-string="true">确认 runtime 目录和 PID 文件存在</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17632"><span data-slate-object="text" data-key="17633"><span data-slate-leaf="true" data-offset-key="17633:0" data-first-offset="true"><span data-slate-string="true">确认 log 目录的 log 文件存在</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17634"><span data-slate-object="text" data-key="17635"><span data-slate-leaf="true" data-offset-key="17635:0" data-first-offset="true"><span data-slate-string="true">判断是否是 daemon 方式。如果是，就使用 go-daemon 来启动一个子进程；如果不是，直接进行后续调用</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17636"><span data-slate-object="text" data-key="17637"><span data-slate-leaf="true" data-offset-key="17637:0" data-first-offset="true"><span data-slate-string="true">使用 gspt 来设置当前进程名称</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17638"><span data-slate-object="text" data-key="17639"><span data-slate-leaf="true" data-offset-key="17639:0" data-first-offset="true"><span data-slate-string="true">启动 app 服务</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17640"><span data-slate-object="text" data-key="17641"><span data-slate-leaf="true" data-offset-key="17641:0" data-first-offset="true"><span data-slate-string="true">具体的实现步骤相信你已经很清楚了，完整代码我们写在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17642"><span data-slate-object="text" data-key="17643"><span data-slate-leaf="true" data-offset-key="17643:0" data-first-offset="true"><span data-slate-string="true"> framework/command/app.go</span></span></span></a><span data-slate-object="text" data-key="17644"><span data-slate-leaf="true" data-offset-key="17644:0" data-first-offset="true"><span data-slate-string="true"> 中了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17645" id="sr-toc-3"><span data-slate-object="text" data-key="17646"><span data-slate-leaf="true" data-offset-key="17646:0" data-first-offset="true"><span data-slate-string="true">获取进程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17647"><span data-slate-object="text" data-key="17648"><span data-slate-leaf="true" data-offset-key="17648:0" data-first-offset="true"><span data-slate-string="true">已经完成了启动进程的命令，那么第二个获取进程 PID 的命令就非常简单了。因为启动命令的时候创建了一个 PID 文件，app/storage/runtime/app.pid，读取这个文件就可以获取到进程的 PID 信息了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17649"><span data-slate-object="text" data-key="17650"><span data-slate-leaf="true" data-offset-key="17650:0" data-first-offset="true"><span data-slate-string="true">但是这里我们可以更谨慎一些加一步，获取到 PID 之后，去操作系统中查询这个 PID 的进程是否存在，存在的话，就确定这个 PID 是可行的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17651"><span data-slate-object="text" data-key="17652"><span data-slate-leaf="true" data-offset-key="17652:0" data-first-offset="true"><span data-slate-string="true">如何根据 PID 查询一个进程是否存在呢？常用的比如 Linux 的 ps 和 grep 命令，基本上都是通过 Linux 的其他命令来检查输出，</span></span></span><span data-slate-object="text" data-key="17653"><span data-slate-leaf="true" data-offset-key="17653:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">但最为可靠的方式是直接使用信号对接要查询的进程：通过给进程发送信号来检测，这个信号就是信号 0</span></span></span></span><span data-slate-object="text" data-key="17654"><span data-slate-leaf="true" data-offset-key="17654:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17655"><span data-slate-object="text" data-key="17656"><span data-slate-leaf="true" data-offset-key="17656:0" data-first-offset="true"><span data-slate-string="true">给进程发送信号 0 之后什么都不会操作，如果进程存在，不返回错误信息；如果进程不存在，会返回不存在进程的错误信息。在 Golang 中，我们可以用 os 库的 Process 结构来发送信号。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17657"><span data-slate-object="text" data-key="17658"><span data-slate-leaf="true" data-offset-key="17658:0" data-first-offset="true"><span data-slate-string="true">代码在 framework/util/exec.go 中，逻辑也很清晰，先用 os.FindProcess 来获取这个 PID 对应的进程，然后给进程发送 signal 0， 如果返回 nil，代表进程存在，否则进程不存在。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17659"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17660"><span data-slate-object="text" data-key="17661"><span data-slate-leaf="true" data-offset-key="17661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// CheckProcessExist 检查进程 pid 是否存在，如果存在的话，返回 true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17662"><span data-slate-object="text" data-key="17663"><span data-slate-leaf="true" data-offset-key="17663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17664"><span data-slate-leaf="true" data-offset-key="17664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17665"><span data-slate-leaf="true" data-offset-key="17665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CheckProcessExist</span></span></span></span></span><span data-slate-object="text" data-key="17666"><span data-slate-leaf="true" data-offset-key="17666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pid </span></span></span></span></span><span data-slate-object="text" data-key="17667"><span data-slate-leaf="true" data-offset-key="17667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17668"><span data-slate-leaf="true" data-offset-key="17668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17669"><span data-slate-leaf="true" data-offset-key="17669:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17670"><span data-slate-leaf="true" data-offset-key="17670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="17671"><span data-slate-leaf="true" data-offset-key="17671:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17672"><span data-slate-object="text" data-key="17673"><span data-slate-leaf="true" data-offset-key="17673:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17674"><span data-slate-leaf="true" data-offset-key="17674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查询这个 pid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17675"><span data-slate-object="text" data-key="17676"><span data-slate-leaf="true" data-offset-key="17676:0" data-first-offset="true"><span data-slate-string="true">   process, err := os.FindProcess(pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17677"><span data-slate-object="text" data-key="17678"><span data-slate-leaf="true" data-offset-key="17678:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17679"><span data-slate-leaf="true" data-offset-key="17679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17680"><span data-slate-leaf="true" data-offset-key="17680:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17681"><span data-slate-leaf="true" data-offset-key="17681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17682"><span data-slate-leaf="true" data-offset-key="17682:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17683"><span data-slate-object="text" data-key="17684"><span data-slate-leaf="true" data-offset-key="17684:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17685"><span data-slate-leaf="true" data-offset-key="17685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17686"><span data-slate-leaf="true" data-offset-key="17686:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17687"><span data-slate-leaf="true" data-offset-key="17687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17688"><span data-slate-object="text" data-key="17689"><span data-slate-leaf="true" data-offset-key="17689:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17690"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17691"><span data-slate-object="text" data-key="17692"><span data-slate-leaf="true" data-offset-key="17692:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17693"><span data-slate-leaf="true" data-offset-key="17693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 给进程发送 signal 0, 如果返回 nil，代表进程存在，否则进程不存在</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17694"><span data-slate-object="text" data-key="17695"><span data-slate-leaf="true" data-offset-key="17695:0" data-first-offset="true"><span data-slate-string="true">   err = process.Signal(syscall.Signal(</span></span></span><span data-slate-object="text" data-key="17696"><span data-slate-leaf="true" data-offset-key="17696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17697"><span data-slate-leaf="true" data-offset-key="17697:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17698"><span data-slate-object="text" data-key="17699"><span data-slate-leaf="true" data-offset-key="17699:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17700"><span data-slate-leaf="true" data-offset-key="17700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17701"><span data-slate-leaf="true" data-offset-key="17701:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17702"><span data-slate-leaf="true" data-offset-key="17702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17703"><span data-slate-leaf="true" data-offset-key="17703:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17704"><span data-slate-object="text" data-key="17705"><span data-slate-leaf="true" data-offset-key="17705:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17706"><span data-slate-leaf="true" data-offset-key="17706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17707"><span data-slate-leaf="true" data-offset-key="17707:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17708"><span data-slate-leaf="true" data-offset-key="17708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17709"><span data-slate-object="text" data-key="17710"><span data-slate-leaf="true" data-offset-key="17710:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17711"><span data-slate-object="text" data-key="17712"><span data-slate-leaf="true" data-offset-key="17712:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="17713"><span data-slate-leaf="true" data-offset-key="17713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17714"><span data-slate-leaf="true" data-offset-key="17714:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17715"><span data-slate-leaf="true" data-offset-key="17715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17716"><span data-slate-object="text" data-key="17717"><span data-slate-leaf="true" data-offset-key="17717:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17718"><span data-slate-object="text" data-key="17719"><span data-slate-leaf="true" data-offset-key="17719:0" data-first-offset="true"><span data-slate-string="true">这个关键函数实现之后，其他的就很容易了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17720"><span data-slate-object="text" data-key="17721"><span data-slate-leaf="true" data-offset-key="17721:0" data-first-offset="true"><span data-slate-string="true">这里我们也简单说一下进程获取的具体步骤：获取 PID 文件内容之后，做判断，如果有 PID 文件且有内容就继续，否则返回无进程；然后：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17722"><div data-slate-type="list-line" data-slate-object="block" data-key="17723"><span data-slate-object="text" data-key="17724"><span data-slate-leaf="true" data-offset-key="17724:0" data-first-offset="true"><span data-slate-string="true">将内容转换为 PID 的 int 类型，转换失败视为无进程；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17725"><span data-slate-object="text" data-key="17726"><span data-slate-leaf="true" data-offset-key="17726:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">使用 signal 0 确认这个进程是否存在，存在返回结果有进程，不存在返回结构无进程</span></span></span></span><span data-slate-object="text" data-key="17727"><span data-slate-leaf="true" data-offset-key="17727:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17728"><span data-slate-object="text" data-key="17729"><span data-slate-leaf="true" data-offset-key="17729:0" data-first-offset="true"><span data-slate-string="true">具体代码如下，存放在 framework/command/app.go 文件中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17730"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17731"><span data-slate-object="text" data-key="17732"><span data-slate-leaf="true" data-offset-key="17732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取启动的 app 的 pid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17733"><span data-slate-object="text" data-key="17734"><span data-slate-leaf="true" data-offset-key="17734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17735"><span data-slate-leaf="true" data-offset-key="17735:0" data-first-offset="true"><span data-slate-string="true"> appStateCommand = &amp;cobra.Command{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17736"><span data-slate-object="text" data-key="17737"><span data-slate-leaf="true" data-offset-key="17737:0" data-first-offset="true"><span data-slate-string="true">   Use:   </span></span></span><span data-slate-object="text" data-key="17738"><span data-slate-leaf="true" data-offset-key="17738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"state"</span></span></span></span><span data-slate-object="text" data-key="17739"><span data-slate-leaf="true" data-offset-key="17739:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17740"><span data-slate-object="text" data-key="17741"><span data-slate-leaf="true" data-offset-key="17741:0" data-first-offset="true"><span data-slate-string="true">   Short: </span></span></span><span data-slate-object="text" data-key="17742"><span data-slate-leaf="true" data-offset-key="17742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"获取启动的 app 的 pid"</span></span></span></span><span data-slate-object="text" data-key="17743"><span data-slate-leaf="true" data-offset-key="17743:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17744"><span data-slate-object="text" data-key="17745"><span data-slate-leaf="true" data-offset-key="17745:0" data-first-offset="true"><span data-slate-string="true">   RunE: </span></span></span><span data-slate-object="text" data-key="17746"><span data-slate-leaf="true" data-offset-key="17746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17747"><span data-slate-leaf="true" data-offset-key="17747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *cobra.Command, args []</span></span></span></span></span><span data-slate-object="text" data-key="17748"><span data-slate-leaf="true" data-offset-key="17748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="17749"><span data-slate-leaf="true" data-offset-key="17749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17750"><span data-slate-leaf="true" data-offset-key="17750:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17751"><span data-slate-leaf="true" data-offset-key="17751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17752"><span data-slate-leaf="true" data-offset-key="17752:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17753"><span data-slate-object="text" data-key="17754"><span data-slate-leaf="true" data-offset-key="17754:0" data-first-offset="true"><span data-slate-string="true">      container := c.GetContainer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17755"><span data-slate-object="text" data-key="17756"><span data-slate-leaf="true" data-offset-key="17756:0" data-first-offset="true"><span data-slate-string="true">      appService := container.MustMake(contract.AppKey).(contract.App)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17757"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17758"><span data-slate-object="text" data-key="17759"><span data-slate-leaf="true" data-offset-key="17759:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17760"><span data-slate-leaf="true" data-offset-key="17760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 pid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17761"><span data-slate-object="text" data-key="17762"><span data-slate-leaf="true" data-offset-key="17762:0" data-first-offset="true"><span data-slate-string="true">      serverPidFile := filepath.Join(appService.RuntimeFolder(), </span></span></span><span data-slate-object="text" data-key="17763"><span data-slate-leaf="true" data-offset-key="17763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.pid"</span></span></span></span><span data-slate-object="text" data-key="17764"><span data-slate-leaf="true" data-offset-key="17764:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17765"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17766"><span data-slate-object="text" data-key="17767"><span data-slate-leaf="true" data-offset-key="17767:0" data-first-offset="true"><span data-slate-string="true">      content, err := ioutil.ReadFile(serverPidFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17768"><span data-slate-object="text" data-key="17769"><span data-slate-leaf="true" data-offset-key="17769:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17770"><span data-slate-leaf="true" data-offset-key="17770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17771"><span data-slate-leaf="true" data-offset-key="17771:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17772"><span data-slate-leaf="true" data-offset-key="17772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17773"><span data-slate-leaf="true" data-offset-key="17773:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17774"><span data-slate-object="text" data-key="17775"><span data-slate-leaf="true" data-offset-key="17775:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17776"><span data-slate-leaf="true" data-offset-key="17776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17777"><span data-slate-leaf="true" data-offset-key="17777:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17778"><span data-slate-object="text" data-key="17779"><span data-slate-leaf="true" data-offset-key="17779:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17780"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17781"><span data-slate-object="text" data-key="17782"><span data-slate-leaf="true" data-offset-key="17782:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17783"><span data-slate-leaf="true" data-offset-key="17783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17784"><span data-slate-leaf="true" data-offset-key="17784:0" data-first-offset="true"><span data-slate-string="true"> content != </span></span></span><span data-slate-object="text" data-key="17785"><span data-slate-leaf="true" data-offset-key="17785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17786"><span data-slate-leaf="true" data-offset-key="17786:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17787"><span data-slate-leaf="true" data-offset-key="17787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17788"><span data-slate-leaf="true" data-offset-key="17788:0" data-first-offset="true"><span data-slate-string="true">(content) &gt; </span></span></span><span data-slate-object="text" data-key="17789"><span data-slate-leaf="true" data-offset-key="17789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17790"><span data-slate-leaf="true" data-offset-key="17790:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17791"><span data-slate-object="text" data-key="17792"><span data-slate-leaf="true" data-offset-key="17792:0" data-first-offset="true"><span data-slate-string="true">         pid, err := strconv.Atoi(</span></span></span><span data-slate-object="text" data-key="17793"><span data-slate-leaf="true" data-offset-key="17793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="17794"><span data-slate-leaf="true" data-offset-key="17794:0" data-first-offset="true"><span data-slate-string="true">(content))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17795"><span data-slate-object="text" data-key="17796"><span data-slate-leaf="true" data-offset-key="17796:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17797"><span data-slate-leaf="true" data-offset-key="17797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17798"><span data-slate-leaf="true" data-offset-key="17798:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17799"><span data-slate-leaf="true" data-offset-key="17799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17800"><span data-slate-leaf="true" data-offset-key="17800:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17801"><span data-slate-object="text" data-key="17802"><span data-slate-leaf="true" data-offset-key="17802:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17803"><span data-slate-leaf="true" data-offset-key="17803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17804"><span data-slate-leaf="true" data-offset-key="17804:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17805"><span data-slate-object="text" data-key="17806"><span data-slate-leaf="true" data-offset-key="17806:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17807"><span data-slate-object="text" data-key="17808"><span data-slate-leaf="true" data-offset-key="17808:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17809"><span data-slate-leaf="true" data-offset-key="17809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17810"><span data-slate-leaf="true" data-offset-key="17810:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17811"><span data-slate-object="text" data-key="17812"><span data-slate-leaf="true" data-offset-key="17812:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(</span></span></span><span data-slate-object="text" data-key="17813"><span data-slate-leaf="true" data-offset-key="17813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app 服务已经启动，pid:"</span></span></span></span><span data-slate-object="text" data-key="17814"><span data-slate-leaf="true" data-offset-key="17814:0" data-first-offset="true"><span data-slate-string="true">, pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17815"><span data-slate-object="text" data-key="17816"><span data-slate-leaf="true" data-offset-key="17816:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17817"><span data-slate-leaf="true" data-offset-key="17817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17818"><span data-slate-leaf="true" data-offset-key="17818:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17819"><span data-slate-leaf="true" data-offset-key="17819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17820"><span data-slate-object="text" data-key="17821"><span data-slate-leaf="true" data-offset-key="17821:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17822"><span data-slate-object="text" data-key="17823"><span data-slate-leaf="true" data-offset-key="17823:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17824"><span data-slate-object="text" data-key="17825"><span data-slate-leaf="true" data-offset-key="17825:0" data-first-offset="true"><span data-slate-string="true">      fmt.Println(</span></span></span><span data-slate-object="text" data-key="17826"><span data-slate-leaf="true" data-offset-key="17826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"没有 app 服务存在"</span></span></span></span><span data-slate-object="text" data-key="17827"><span data-slate-leaf="true" data-offset-key="17827:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17828"><span data-slate-object="text" data-key="17829"><span data-slate-leaf="true" data-offset-key="17829:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17830"><span data-slate-leaf="true" data-offset-key="17830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17831"><span data-slate-leaf="true" data-offset-key="17831:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17832"><span data-slate-leaf="true" data-offset-key="17832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17833"><span data-slate-object="text" data-key="17834"><span data-slate-leaf="true" data-offset-key="17834:0" data-first-offset="true"><span data-slate-string="true">   },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17835"><span data-slate-object="text" data-key="17836"><span data-slate-leaf="true" data-offset-key="17836:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17837" id="sr-toc-4"><span data-slate-object="text" data-key="17838"><span data-slate-leaf="true" data-offset-key="17838:0" data-first-offset="true"><span data-slate-string="true">停止命令</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17839"><span data-slate-object="text" data-key="17840"><span data-slate-leaf="true" data-offset-key="17840:0" data-first-offset="true"><span data-slate-string="true">命令的启动和获取完成了，就到了第三个停止命令了。既然有了进程号，需要停止一个进程，我们还是可以使用第六章说的信号量方法，回顾下当时说的四个关闭信号：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17841"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e9/50/e93163afd641b744b2b3f8faf46f4e50.jpg?wh=1920x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17842"><span data-slate-object="text" data-key="17843"><span data-slate-leaf="true" data-offset-key="17843:0" data-first-offset="true"><span data-slate-string="true">由于启动进程监听了 SIGINT、SIGQUIT、SIGTERM 这三个信号，所以我们在这三个信号中选取一个发送给 PID 所在的进程即可，这里就选择更符合 “关闭” 语义的 SIGTERM 信号。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17844"><span data-slate-object="text" data-key="17845"><span data-slate-leaf="true" data-offset-key="17845:0" data-first-offset="true"><span data-slate-string="true">同样实现步骤也很清晰，获取 PID 文件内容之后，判断如果有 PID 文件且有内容再继续，否则什么都不做，之后就是：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17846"><div data-slate-type="list-line" data-slate-object="block" data-key="17847"><span data-slate-object="text" data-key="17848"><span data-slate-leaf="true" data-offset-key="17848:0" data-first-offset="true"><span data-slate-string="true">将内容转换为 PID 的 int 类型，转换失败则什么都不做</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17849"><span data-slate-object="text" data-key="17850"><span data-slate-leaf="true" data-offset-key="17850:0" data-first-offset="true"><span data-slate-string="true">直接给这个 PID 进程发送 SIGTERM 信号</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17851"><span data-slate-object="text" data-key="17852"><span data-slate-leaf="true" data-offset-key="17852:0" data-first-offset="true"><span data-slate-string="true">将 PID 文件内容清空</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17853"><span data-slate-object="text" data-key="17854"><span data-slate-leaf="true" data-offset-key="17854:0" data-first-offset="true"><span data-slate-string="true">对应代码同样在 framework/command/app.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17855"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17856"><span data-slate-object="text" data-key="17857"><span data-slate-leaf="true" data-offset-key="17857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 停止一个已经启动的 app 服务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17858"><span data-slate-object="text" data-key="17859"><span data-slate-leaf="true" data-offset-key="17859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17860"><span data-slate-leaf="true" data-offset-key="17860:0" data-first-offset="true"><span data-slate-string="true"> appStopCommand = &amp;cobra.Command{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17861"><span data-slate-object="text" data-key="17862"><span data-slate-leaf="true" data-offset-key="17862:0" data-first-offset="true"><span data-slate-string="true">   Use:   </span></span></span><span data-slate-object="text" data-key="17863"><span data-slate-leaf="true" data-offset-key="17863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"stop"</span></span></span></span><span data-slate-object="text" data-key="17864"><span data-slate-leaf="true" data-offset-key="17864:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17865"><span data-slate-object="text" data-key="17866"><span data-slate-leaf="true" data-offset-key="17866:0" data-first-offset="true"><span data-slate-string="true">   Short: </span></span></span><span data-slate-object="text" data-key="17867"><span data-slate-leaf="true" data-offset-key="17867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"停止一个已经启动的 app 服务"</span></span></span></span><span data-slate-object="text" data-key="17868"><span data-slate-leaf="true" data-offset-key="17868:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17869"><span data-slate-object="text" data-key="17870"><span data-slate-leaf="true" data-offset-key="17870:0" data-first-offset="true"><span data-slate-string="true">   RunE: </span></span></span><span data-slate-object="text" data-key="17871"><span data-slate-leaf="true" data-offset-key="17871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17872"><span data-slate-leaf="true" data-offset-key="17872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *cobra.Command, args []</span></span></span></span></span><span data-slate-object="text" data-key="17873"><span data-slate-leaf="true" data-offset-key="17873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="17874"><span data-slate-leaf="true" data-offset-key="17874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17875"><span data-slate-leaf="true" data-offset-key="17875:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17876"><span data-slate-leaf="true" data-offset-key="17876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17877"><span data-slate-leaf="true" data-offset-key="17877:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17878"><span data-slate-object="text" data-key="17879"><span data-slate-leaf="true" data-offset-key="17879:0" data-first-offset="true"><span data-slate-string="true">      container := c.GetContainer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17880"><span data-slate-object="text" data-key="17881"><span data-slate-leaf="true" data-offset-key="17881:0" data-first-offset="true"><span data-slate-string="true">      appService := container.MustMake(contract.AppKey).(contract.App)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17882"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17883"><span data-slate-object="text" data-key="17884"><span data-slate-leaf="true" data-offset-key="17884:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17885"><span data-slate-leaf="true" data-offset-key="17885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// GetPid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17886"><span data-slate-object="text" data-key="17887"><span data-slate-leaf="true" data-offset-key="17887:0" data-first-offset="true"><span data-slate-string="true">      serverPidFile := filepath.Join(appService.RuntimeFolder(), </span></span></span><span data-slate-object="text" data-key="17888"><span data-slate-leaf="true" data-offset-key="17888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.pid"</span></span></span></span><span data-slate-object="text" data-key="17889"><span data-slate-leaf="true" data-offset-key="17889:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17890"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17891"><span data-slate-object="text" data-key="17892"><span data-slate-leaf="true" data-offset-key="17892:0" data-first-offset="true"><span data-slate-string="true">      content, err := ioutil.ReadFile(serverPidFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17893"><span data-slate-object="text" data-key="17894"><span data-slate-leaf="true" data-offset-key="17894:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17895"><span data-slate-leaf="true" data-offset-key="17895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17896"><span data-slate-leaf="true" data-offset-key="17896:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17897"><span data-slate-leaf="true" data-offset-key="17897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17898"><span data-slate-leaf="true" data-offset-key="17898:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17899"><span data-slate-object="text" data-key="17900"><span data-slate-leaf="true" data-offset-key="17900:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17901"><span data-slate-leaf="true" data-offset-key="17901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17902"><span data-slate-leaf="true" data-offset-key="17902:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17903"><span data-slate-object="text" data-key="17904"><span data-slate-leaf="true" data-offset-key="17904:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17905"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17906"><span data-slate-object="text" data-key="17907"><span data-slate-leaf="true" data-offset-key="17907:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17908"><span data-slate-leaf="true" data-offset-key="17908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17909"><span data-slate-leaf="true" data-offset-key="17909:0" data-first-offset="true"><span data-slate-string="true"> content != </span></span></span><span data-slate-object="text" data-key="17910"><span data-slate-leaf="true" data-offset-key="17910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17911"><span data-slate-leaf="true" data-offset-key="17911:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17912"><span data-slate-leaf="true" data-offset-key="17912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17913"><span data-slate-leaf="true" data-offset-key="17913:0" data-first-offset="true"><span data-slate-string="true">(content) != </span></span></span><span data-slate-object="text" data-key="17914"><span data-slate-leaf="true" data-offset-key="17914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17915"><span data-slate-leaf="true" data-offset-key="17915:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17916"><span data-slate-object="text" data-key="17917"><span data-slate-leaf="true" data-offset-key="17917:0" data-first-offset="true"><span data-slate-string="true">         pid, err := strconv.Atoi(</span></span></span><span data-slate-object="text" data-key="17918"><span data-slate-leaf="true" data-offset-key="17918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="17919"><span data-slate-leaf="true" data-offset-key="17919:0" data-first-offset="true"><span data-slate-string="true">(content))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17920"><span data-slate-object="text" data-key="17921"><span data-slate-leaf="true" data-offset-key="17921:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17922"><span data-slate-leaf="true" data-offset-key="17922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17923"><span data-slate-leaf="true" data-offset-key="17923:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="17924"><span data-slate-leaf="true" data-offset-key="17924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17925"><span data-slate-leaf="true" data-offset-key="17925:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17926"><span data-slate-object="text" data-key="17927"><span data-slate-leaf="true" data-offset-key="17927:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17928"><span data-slate-leaf="true" data-offset-key="17928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17929"><span data-slate-leaf="true" data-offset-key="17929:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17930"><span data-slate-object="text" data-key="17931"><span data-slate-leaf="true" data-offset-key="17931:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17932"><span data-slate-object="text" data-key="17933"><span data-slate-leaf="true" data-offset-key="17933:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17934"><span data-slate-leaf="true" data-offset-key="17934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 发送 SIGTERM 命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17935"><span data-slate-object="text" data-key="17936"><span data-slate-leaf="true" data-offset-key="17936:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17937"><span data-slate-leaf="true" data-offset-key="17937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17938"><span data-slate-leaf="true" data-offset-key="17938:0" data-first-offset="true"><span data-slate-string="true"> err := syscall.Kill(pid, syscall.SIGTERM); err != </span></span></span><span data-slate-object="text" data-key="17939"><span data-slate-leaf="true" data-offset-key="17939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17940"><span data-slate-leaf="true" data-offset-key="17940:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17941"><span data-slate-object="text" data-key="17942"><span data-slate-leaf="true" data-offset-key="17942:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17943"><span data-slate-leaf="true" data-offset-key="17943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17944"><span data-slate-leaf="true" data-offset-key="17944:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17945"><span data-slate-object="text" data-key="17946"><span data-slate-leaf="true" data-offset-key="17946:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17947"><span data-slate-object="text" data-key="17948"><span data-slate-leaf="true" data-offset-key="17948:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="17949"><span data-slate-leaf="true" data-offset-key="17949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17950"><span data-slate-leaf="true" data-offset-key="17950:0" data-first-offset="true"><span data-slate-string="true"> err := ioutil.WriteFile(serverPidFile, []</span></span></span><span data-slate-object="text" data-key="17951"><span data-slate-leaf="true" data-offset-key="17951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="17952"><span data-slate-leaf="true" data-offset-key="17952:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="17953"><span data-slate-leaf="true" data-offset-key="17953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0644</span></span></span></span><span data-slate-object="text" data-key="17954"><span data-slate-leaf="true" data-offset-key="17954:0" data-first-offset="true"><span data-slate-string="true">); err != </span></span></span><span data-slate-object="text" data-key="17955"><span data-slate-leaf="true" data-offset-key="17955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17956"><span data-slate-leaf="true" data-offset-key="17956:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17957"><span data-slate-object="text" data-key="17958"><span data-slate-leaf="true" data-offset-key="17958:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17959"><span data-slate-leaf="true" data-offset-key="17959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17960"><span data-slate-leaf="true" data-offset-key="17960:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17961"><span data-slate-object="text" data-key="17962"><span data-slate-leaf="true" data-offset-key="17962:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17963"><span data-slate-object="text" data-key="17964"><span data-slate-leaf="true" data-offset-key="17964:0" data-first-offset="true"><span data-slate-string="true">         fmt.Println(</span></span></span><span data-slate-object="text" data-key="17965"><span data-slate-leaf="true" data-offset-key="17965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"停止进程:"</span></span></span></span><span data-slate-object="text" data-key="17966"><span data-slate-leaf="true" data-offset-key="17966:0" data-first-offset="true"><span data-slate-string="true">, pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17967"><span data-slate-object="text" data-key="17968"><span data-slate-leaf="true" data-offset-key="17968:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17969"><span data-slate-object="text" data-key="17970"><span data-slate-leaf="true" data-offset-key="17970:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17971"><span data-slate-leaf="true" data-offset-key="17971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17972"><span data-slate-leaf="true" data-offset-key="17972:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17973"><span data-slate-leaf="true" data-offset-key="17973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17974"><span data-slate-object="text" data-key="17975"><span data-slate-leaf="true" data-offset-key="17975:0" data-first-offset="true"><span data-slate-string="true">   },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17976"><span data-slate-object="text" data-key="17977"><span data-slate-leaf="true" data-offset-key="17977:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17978" id="sr-toc-5"><span data-slate-object="text" data-key="17979"><span data-slate-leaf="true" data-offset-key="17979:0" data-first-offset="true"><span data-slate-string="true">重启命令</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17980"><span data-slate-object="text" data-key="17981"><span data-slate-leaf="true" data-offset-key="17981:0" data-first-offset="true"><span data-slate-string="true">最后我们要完成重启命令，还是在 framework/command/app.go 中。大致逻辑也很清晰，读取 PID 文件之后判断，如果 PID 文件中没有 PID，说明没有进程在运行，直接启动新进程；如果 PID 文件中有 PID，检查旧进程是否存在，如果不存在，直接启动新进程，如果存在，这里就有一些需要注意的了。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17982"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17983"><span data-slate-object="text" data-key="17984"><span data-slate-leaf="true" data-offset-key="17984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 pid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17985"><span data-slate-object="text" data-key="17986"><span data-slate-leaf="true" data-offset-key="17986:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17987"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17988"><span data-slate-object="text" data-key="17989"><span data-slate-leaf="true" data-offset-key="17989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17990"><span data-slate-leaf="true" data-offset-key="17990:0" data-first-offset="true"><span data-slate-string="true"> content != </span></span></span><span data-slate-object="text" data-key="17991"><span data-slate-leaf="true" data-offset-key="17991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17992"><span data-slate-leaf="true" data-offset-key="17992:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; </span></span></span><span data-slate-object="text" data-key="17993"><span data-slate-leaf="true" data-offset-key="17993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17994"><span data-slate-leaf="true" data-offset-key="17994:0" data-first-offset="true"><span data-slate-string="true">(content) != </span></span></span><span data-slate-object="text" data-key="17995"><span data-slate-leaf="true" data-offset-key="17995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17996"><span data-slate-leaf="true" data-offset-key="17996:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17997"><span data-slate-object="text" data-key="17998"><span data-slate-leaf="true" data-offset-key="17998:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17999"><span data-slate-leaf="true" data-offset-key="17999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解析 pid 是否存在</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18000"><span data-slate-object="text" data-key="18001"><span data-slate-leaf="true" data-offset-key="18001:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18002"><span data-slate-leaf="true" data-offset-key="18002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18003"><span data-slate-leaf="true" data-offset-key="18003:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18004"><span data-slate-object="text" data-key="18005"><span data-slate-leaf="true" data-offset-key="18005:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18006"><span data-slate-leaf="true" data-offset-key="18006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭旧的 pid 进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18007"><span data-slate-object="text" data-key="18008"><span data-slate-leaf="true" data-offset-key="18008:0" data-first-offset="true"><span data-slate-string="true">        ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18009"><span data-slate-object="text" data-key="18010"><span data-slate-leaf="true" data-offset-key="18010:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18011"><span data-slate-object="text" data-key="18012"><span data-slate-leaf="true" data-offset-key="18012:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18013"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18014"><span data-slate-object="text" data-key="18015"><span data-slate-leaf="true" data-offset-key="18015:0" data-first-offset="true"><span data-slate-string="true">appDaemon = </span></span></span><span data-slate-object="text" data-key="18016"><span data-slate-leaf="true" data-offset-key="18016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18017"><span data-slate-object="text" data-key="18018"><span data-slate-leaf="true" data-offset-key="18018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动新的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18019"><span data-slate-object="text" data-key="18020"><span data-slate-leaf="true" data-offset-key="18020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18021"><span data-slate-leaf="true" data-offset-key="18021:0" data-first-offset="true"><span data-slate-string="true"> appStartCommand.RunE(c, args)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18022"><span data-slate-object="text" data-key="18023"><span data-slate-leaf="true" data-offset-key="18023:0" data-first-offset="true"><span data-slate-string="true">因为重启的逻辑是先结束旧进程，再启动新进程。结束进程和停止命令一样，使用 SIGTERM 信号就能保证进程的优雅关闭了。但是</span></span></span><span data-slate-object="text" data-key="18024"><span data-slate-leaf="true" data-offset-key="18024:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">由于新、旧进程都是使用同一个端口，所以必须保证旧进程结束，才能启动新的进程</span></span></span></span><span data-slate-object="text" data-key="18025"><span data-slate-leaf="true" data-offset-key="18025:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18026"><span data-slate-object="text" data-key="18027"><span data-slate-leaf="true" data-offset-key="18027:0" data-first-offset="true"><span data-slate-string="true">而怎么保证旧进程确实结束了呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18028"><span data-slate-object="text" data-key="18029"><span data-slate-leaf="true" data-offset-key="18029:0" data-first-offset="true"><span data-slate-string="true">这里可以使用前面定义的 CheckProcessExist 方法，每秒做一次轮询，检测 PID 对应的进程是否已经关闭。那么轮询多少次呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18030"><span data-slate-object="text" data-key="18031"><span data-slate-leaf="true" data-offset-key="18031:0" data-first-offset="true"><span data-slate-string="true">我们知道在启动进程的时候，设置了一个优雅关闭的最大超时时间 closeWait，这个 closeWait 的时间设置为秒。那么</span></span></span><span data-slate-object="text" data-key="18032"><span data-slate-leaf="true" data-offset-key="18032:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为了轮询检查旧进程是否关闭，我们只需要设置次数超过 closeWait 的轮询时间即可</span></span></span></span><span data-slate-object="text" data-key="18033"><span data-slate-leaf="true" data-offset-key="18033:0" data-first-offset="true"><span data-slate-string="true">。考虑到 net/http 在 closeWait 之后还有一些程序运行的逻辑，这里我们可以设置为 2 * closeWait，时间是非常充裕的。关键代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18034"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18035"><span data-slate-object="text" data-key="18036"><span data-slate-leaf="true" data-offset-key="18036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确认进程已经关闭，每秒检测一次， 最多检测 closeWait * 2 秒</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18037"><span data-slate-object="text" data-key="18038"><span data-slate-leaf="true" data-offset-key="18038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18039"><span data-slate-leaf="true" data-offset-key="18039:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="18040"><span data-slate-leaf="true" data-offset-key="18040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18041"><span data-slate-leaf="true" data-offset-key="18041:0" data-first-offset="true"><span data-slate-string="true">; i &lt; closeWait*</span></span></span><span data-slate-object="text" data-key="18042"><span data-slate-leaf="true" data-offset-key="18042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="18043"><span data-slate-leaf="true" data-offset-key="18043:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18044"><span data-slate-object="text" data-key="18045"><span data-slate-leaf="true" data-offset-key="18045:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18046"><span data-slate-leaf="true" data-offset-key="18046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18047"><span data-slate-leaf="true" data-offset-key="18047:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) == </span></span></span><span data-slate-object="text" data-key="18048"><span data-slate-leaf="true" data-offset-key="18048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="18049"><span data-slate-leaf="true" data-offset-key="18049:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18050"><span data-slate-object="text" data-key="18051"><span data-slate-leaf="true" data-offset-key="18051:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18052"><span data-slate-leaf="true" data-offset-key="18052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18053"><span data-slate-object="text" data-key="18054"><span data-slate-leaf="true" data-offset-key="18054:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18055"><span data-slate-object="text" data-key="18056"><span data-slate-leaf="true" data-offset-key="18056:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="18057"><span data-slate-leaf="true" data-offset-key="18057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="18058"><span data-slate-leaf="true" data-offset-key="18058:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18059"><span data-slate-object="text" data-key="18060"><span data-slate-leaf="true" data-offset-key="18060:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18061"><span data-slate-object="text" data-key="18062"><span data-slate-leaf="true" data-offset-key="18062:0" data-first-offset="true"><span data-slate-string="true">再严谨一些，可以这么设置，如果在 2*closeWait 时间内，旧进程还未关闭，那么就不能启动新进程了，需要直接返回错误。所以，在 2 * closeWait 轮询之后，我们还需要再做一次检查，检查进程是否关闭，如果没有关闭的话，直接返回 error：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18063"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18064"><span data-slate-object="text" data-key="18065"><span data-slate-leaf="true" data-offset-key="18065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确认进程已经关闭，每秒检测一次， 最多检测 closeWait * 2 秒</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18066"><span data-slate-object="text" data-key="18067"><span data-slate-leaf="true" data-offset-key="18067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18068"><span data-slate-leaf="true" data-offset-key="18068:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="18069"><span data-slate-leaf="true" data-offset-key="18069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18070"><span data-slate-leaf="true" data-offset-key="18070:0" data-first-offset="true"><span data-slate-string="true">; i &lt; closeWait*</span></span></span><span data-slate-object="text" data-key="18071"><span data-slate-leaf="true" data-offset-key="18071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="18072"><span data-slate-leaf="true" data-offset-key="18072:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18073"><span data-slate-object="text" data-key="18074"><span data-slate-leaf="true" data-offset-key="18074:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18075"><span data-slate-leaf="true" data-offset-key="18075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18076"><span data-slate-leaf="true" data-offset-key="18076:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) == </span></span></span><span data-slate-object="text" data-key="18077"><span data-slate-leaf="true" data-offset-key="18077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="18078"><span data-slate-leaf="true" data-offset-key="18078:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18079"><span data-slate-object="text" data-key="18080"><span data-slate-leaf="true" data-offset-key="18080:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18081"><span data-slate-leaf="true" data-offset-key="18081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18082"><span data-slate-object="text" data-key="18083"><span data-slate-leaf="true" data-offset-key="18083:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18084"><span data-slate-object="text" data-key="18085"><span data-slate-leaf="true" data-offset-key="18085:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="18086"><span data-slate-leaf="true" data-offset-key="18086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="18087"><span data-slate-leaf="true" data-offset-key="18087:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18088"><span data-slate-object="text" data-key="18089"><span data-slate-leaf="true" data-offset-key="18089:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18090"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18091"><span data-slate-object="text" data-key="18092"><span data-slate-leaf="true" data-offset-key="18092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果进程等待了 2*closeWait 之后还没结束，返回错误，不进行后续的操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18093"><span data-slate-object="text" data-key="18094"><span data-slate-leaf="true" data-offset-key="18094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18095"><span data-slate-leaf="true" data-offset-key="18095:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) == </span></span></span><span data-slate-object="text" data-key="18096"><span data-slate-leaf="true" data-offset-key="18096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="18097"><span data-slate-leaf="true" data-offset-key="18097:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18098"><span data-slate-object="text" data-key="18099"><span data-slate-leaf="true" data-offset-key="18099:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="18100"><span data-slate-leaf="true" data-offset-key="18100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"结束进程失败:"</span></span></span></span><span data-slate-object="text" data-key="18101"><span data-slate-leaf="true" data-offset-key="18101:0" data-first-offset="true"><span data-slate-string="true">+strconv.Itoa(pid), </span></span></span><span data-slate-object="text" data-key="18102"><span data-slate-leaf="true" data-offset-key="18102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"请查看原因"</span></span></span></span><span data-slate-object="text" data-key="18103"><span data-slate-leaf="true" data-offset-key="18103:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18104"><span data-slate-object="text" data-key="18105"><span data-slate-leaf="true" data-offset-key="18105:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18106"><span data-slate-leaf="true" data-offset-key="18106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18107"><span data-slate-leaf="true" data-offset-key="18107:0" data-first-offset="true"><span data-slate-string="true"> errors.New(</span></span></span><span data-slate-object="text" data-key="18108"><span data-slate-leaf="true" data-offset-key="18108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"结束进程失败"</span></span></span></span><span data-slate-object="text" data-key="18109"><span data-slate-leaf="true" data-offset-key="18109:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18110"><span data-slate-object="text" data-key="18111"><span data-slate-leaf="true" data-offset-key="18111:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18112"><span data-slate-object="text" data-key="18113"><span data-slate-leaf="true" data-offset-key="18113:0" data-first-offset="true"><span data-slate-string="true">在确认旧进程结束后，记得把 PID 文件清空，再启动一个新进程。启动进程的逻辑还是比较复杂的，就不重复写了，我们直接调用 appStartCommand 的 RunE 方法来实现，会更优雅一些。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18114"><span data-slate-object="text" data-key="18115"><span data-slate-leaf="true" data-offset-key="18115:0" data-first-offset="true"><span data-slate-string="true">同其他命令一样，这里再梳理一下判断旧进程存在之后详细的实现步骤，如果存在：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18116"><div data-slate-type="list-line" data-slate-object="block" data-key="18117"><span data-slate-object="text" data-key="18118"><span data-slate-leaf="true" data-offset-key="18118:0" data-first-offset="true"><span data-slate-string="true">发送 SIGTERM 信号</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18119"><span data-slate-object="text" data-key="18120"><span data-slate-leaf="true" data-offset-key="18120:0" data-first-offset="true"><span data-slate-string="true">循环 2*closeWait 次数，每秒执行一次查询进程是否已经结束</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18121"><span data-slate-object="text" data-key="18122"><span data-slate-leaf="true" data-offset-key="18122:0" data-first-offset="true"><span data-slate-string="true">如果某次查询进程已经结束，或者等待 2*closeWait 循环结束之后，再次查询一次进程</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18123"><span data-slate-object="text" data-key="18124"><span data-slate-leaf="true" data-offset-key="18124:0" data-first-offset="true"><span data-slate-string="true">如果还未结束，返回进程结束失败</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18125"><span data-slate-object="text" data-key="18126"><span data-slate-leaf="true" data-offset-key="18126:0" data-first-offset="true"><span data-slate-string="true">如果已经结束，将 PID 文件清空，启动新进程</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18127"><span data-slate-object="text" data-key="18128"><span data-slate-leaf="true" data-offset-key="18128:0" data-first-offset="true"><span data-slate-string="true">在 framework/command/app.go 中，整体代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18129"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18130"><span data-slate-object="text" data-key="18131"><span data-slate-leaf="true" data-offset-key="18131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 重新启动一个 app 服务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18132"><span data-slate-object="text" data-key="18133"><span data-slate-leaf="true" data-offset-key="18133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18134"><span data-slate-leaf="true" data-offset-key="18134:0" data-first-offset="true"><span data-slate-string="true"> appRestartCommand = &amp;cobra.Command{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18135"><span data-slate-object="text" data-key="18136"><span data-slate-leaf="true" data-offset-key="18136:0" data-first-offset="true"><span data-slate-string="true">   Use:   </span></span></span><span data-slate-object="text" data-key="18137"><span data-slate-leaf="true" data-offset-key="18137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"restart"</span></span></span></span><span data-slate-object="text" data-key="18138"><span data-slate-leaf="true" data-offset-key="18138:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18139"><span data-slate-object="text" data-key="18140"><span data-slate-leaf="true" data-offset-key="18140:0" data-first-offset="true"><span data-slate-string="true">   Short: </span></span></span><span data-slate-object="text" data-key="18141"><span data-slate-leaf="true" data-offset-key="18141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"重新启动一个 app 服务"</span></span></span></span><span data-slate-object="text" data-key="18142"><span data-slate-leaf="true" data-offset-key="18142:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18143"><span data-slate-object="text" data-key="18144"><span data-slate-leaf="true" data-offset-key="18144:0" data-first-offset="true"><span data-slate-string="true">   RunE: </span></span></span><span data-slate-object="text" data-key="18145"><span data-slate-leaf="true" data-offset-key="18145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18146"><span data-slate-leaf="true" data-offset-key="18146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *cobra.Command, args []</span></span></span></span></span><span data-slate-object="text" data-key="18147"><span data-slate-leaf="true" data-offset-key="18147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="18148"><span data-slate-leaf="true" data-offset-key="18148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="18149"><span data-slate-leaf="true" data-offset-key="18149:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18150"><span data-slate-leaf="true" data-offset-key="18150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="18151"><span data-slate-leaf="true" data-offset-key="18151:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18152"><span data-slate-object="text" data-key="18153"><span data-slate-leaf="true" data-offset-key="18153:0" data-first-offset="true"><span data-slate-string="true">      container := c.GetContainer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18154"><span data-slate-object="text" data-key="18155"><span data-slate-leaf="true" data-offset-key="18155:0" data-first-offset="true"><span data-slate-string="true">      appService := container.MustMake(contract.AppKey).(contract.App)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18156"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18157"><span data-slate-object="text" data-key="18158"><span data-slate-leaf="true" data-offset-key="18158:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18159"><span data-slate-leaf="true" data-offset-key="18159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// GetPid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18160"><span data-slate-object="text" data-key="18161"><span data-slate-leaf="true" data-offset-key="18161:0" data-first-offset="true"><span data-slate-string="true">      serverPidFile := filepath.Join(appService.RuntimeFolder(), </span></span></span><span data-slate-object="text" data-key="18162"><span data-slate-leaf="true" data-offset-key="18162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.pid"</span></span></span></span><span data-slate-object="text" data-key="18163"><span data-slate-leaf="true" data-offset-key="18163:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18164"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18165"><span data-slate-object="text" data-key="18166"><span data-slate-leaf="true" data-offset-key="18166:0" data-first-offset="true"><span data-slate-string="true">      content, err := ioutil.ReadFile(serverPidFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18167"><span data-slate-object="text" data-key="18168"><span data-slate-leaf="true" data-offset-key="18168:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18169"><span data-slate-leaf="true" data-offset-key="18169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18170"><span data-slate-leaf="true" data-offset-key="18170:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="18171"><span data-slate-leaf="true" data-offset-key="18171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18172"><span data-slate-leaf="true" data-offset-key="18172:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18173"><span data-slate-object="text" data-key="18174"><span data-slate-leaf="true" data-offset-key="18174:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="18175"><span data-slate-leaf="true" data-offset-key="18175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18176"><span data-slate-leaf="true" data-offset-key="18176:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18177"><span data-slate-object="text" data-key="18178"><span data-slate-leaf="true" data-offset-key="18178:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18179"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18180"><span data-slate-object="text" data-key="18181"><span data-slate-leaf="true" data-offset-key="18181:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18182"><span data-slate-leaf="true" data-offset-key="18182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18183"><span data-slate-leaf="true" data-offset-key="18183:0" data-first-offset="true"><span data-slate-string="true"> content != </span></span></span><span data-slate-object="text" data-key="18184"><span data-slate-leaf="true" data-offset-key="18184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18185"><span data-slate-leaf="true" data-offset-key="18185:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; </span></span></span><span data-slate-object="text" data-key="18186"><span data-slate-leaf="true" data-offset-key="18186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="18187"><span data-slate-leaf="true" data-offset-key="18187:0" data-first-offset="true"><span data-slate-string="true">(content) != </span></span></span><span data-slate-object="text" data-key="18188"><span data-slate-leaf="true" data-offset-key="18188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18189"><span data-slate-leaf="true" data-offset-key="18189:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18190"><span data-slate-object="text" data-key="18191"><span data-slate-leaf="true" data-offset-key="18191:0" data-first-offset="true"><span data-slate-string="true">         pid, err := strconv.Atoi(</span></span></span><span data-slate-object="text" data-key="18192"><span data-slate-leaf="true" data-offset-key="18192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="18193"><span data-slate-leaf="true" data-offset-key="18193:0" data-first-offset="true"><span data-slate-string="true">(content))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18194"><span data-slate-object="text" data-key="18195"><span data-slate-leaf="true" data-offset-key="18195:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="18196"><span data-slate-leaf="true" data-offset-key="18196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18197"><span data-slate-leaf="true" data-offset-key="18197:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="18198"><span data-slate-leaf="true" data-offset-key="18198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18199"><span data-slate-leaf="true" data-offset-key="18199:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18200"><span data-slate-object="text" data-key="18201"><span data-slate-leaf="true" data-offset-key="18201:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18202"><span data-slate-leaf="true" data-offset-key="18202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18203"><span data-slate-leaf="true" data-offset-key="18203:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18204"><span data-slate-object="text" data-key="18205"><span data-slate-leaf="true" data-offset-key="18205:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18206"><span data-slate-object="text" data-key="18207"><span data-slate-leaf="true" data-offset-key="18207:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="18208"><span data-slate-leaf="true" data-offset-key="18208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18209"><span data-slate-leaf="true" data-offset-key="18209:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18210"><span data-slate-object="text" data-key="18211"><span data-slate-leaf="true" data-offset-key="18211:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18212"><span data-slate-leaf="true" data-offset-key="18212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 杀死进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18213"><span data-slate-object="text" data-key="18214"><span data-slate-leaf="true" data-offset-key="18214:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18215"><span data-slate-leaf="true" data-offset-key="18215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18216"><span data-slate-leaf="true" data-offset-key="18216:0" data-first-offset="true"><span data-slate-string="true"> err := syscall.Kill(pid, syscall.SIGTERM); err != </span></span></span><span data-slate-object="text" data-key="18217"><span data-slate-leaf="true" data-offset-key="18217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18218"><span data-slate-leaf="true" data-offset-key="18218:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18219"><span data-slate-object="text" data-key="18220"><span data-slate-leaf="true" data-offset-key="18220:0" data-first-offset="true"><span data-slate-string="true">               </span></span></span><span data-slate-object="text" data-key="18221"><span data-slate-leaf="true" data-offset-key="18221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18222"><span data-slate-leaf="true" data-offset-key="18222:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18223"><span data-slate-object="text" data-key="18224"><span data-slate-leaf="true" data-offset-key="18224:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18225"><span data-slate-object="text" data-key="18226"><span data-slate-leaf="true" data-offset-key="18226:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18227"><span data-slate-leaf="true" data-offset-key="18227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18228"><span data-slate-leaf="true" data-offset-key="18228:0" data-first-offset="true"><span data-slate-string="true"> err := ioutil.WriteFile(serverPidFile, []</span></span></span><span data-slate-object="text" data-key="18229"><span data-slate-leaf="true" data-offset-key="18229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="18230"><span data-slate-leaf="true" data-offset-key="18230:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="18231"><span data-slate-leaf="true" data-offset-key="18231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0644</span></span></span></span><span data-slate-object="text" data-key="18232"><span data-slate-leaf="true" data-offset-key="18232:0" data-first-offset="true"><span data-slate-string="true">); err != </span></span></span><span data-slate-object="text" data-key="18233"><span data-slate-leaf="true" data-offset-key="18233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18234"><span data-slate-leaf="true" data-offset-key="18234:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18235"><span data-slate-object="text" data-key="18236"><span data-slate-leaf="true" data-offset-key="18236:0" data-first-offset="true"><span data-slate-string="true">               </span></span></span><span data-slate-object="text" data-key="18237"><span data-slate-leaf="true" data-offset-key="18237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18238"><span data-slate-leaf="true" data-offset-key="18238:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18239"><span data-slate-object="text" data-key="18240"><span data-slate-leaf="true" data-offset-key="18240:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18241"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18242"><span data-slate-object="text" data-key="18243"><span data-slate-leaf="true" data-offset-key="18243:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18244"><span data-slate-leaf="true" data-offset-key="18244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 closeWait</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18245"><span data-slate-object="text" data-key="18246"><span data-slate-leaf="true" data-offset-key="18246:0" data-first-offset="true"><span data-slate-string="true">            closeWait := </span></span></span><span data-slate-object="text" data-key="18247"><span data-slate-leaf="true" data-offset-key="18247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18248"><span data-slate-object="text" data-key="18249"><span data-slate-leaf="true" data-offset-key="18249:0" data-first-offset="true"><span data-slate-string="true">            configService := container.MustMake(contract.ConfigKey).(contract.Config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18250"><span data-slate-object="text" data-key="18251"><span data-slate-leaf="true" data-offset-key="18251:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18252"><span data-slate-leaf="true" data-offset-key="18252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18253"><span data-slate-leaf="true" data-offset-key="18253:0" data-first-offset="true"><span data-slate-string="true"> configService.IsExist(</span></span></span><span data-slate-object="text" data-key="18254"><span data-slate-leaf="true" data-offset-key="18254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.close_wait"</span></span></span></span><span data-slate-object="text" data-key="18255"><span data-slate-leaf="true" data-offset-key="18255:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18256"><span data-slate-object="text" data-key="18257"><span data-slate-leaf="true" data-offset-key="18257:0" data-first-offset="true"><span data-slate-string="true">               closeWait = configService.GetInt(</span></span></span><span data-slate-object="text" data-key="18258"><span data-slate-leaf="true" data-offset-key="18258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"app.close_wait"</span></span></span></span><span data-slate-object="text" data-key="18259"><span data-slate-leaf="true" data-offset-key="18259:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18260"><span data-slate-object="text" data-key="18261"><span data-slate-leaf="true" data-offset-key="18261:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18262"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18263"><span data-slate-object="text" data-key="18264"><span data-slate-leaf="true" data-offset-key="18264:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18265"><span data-slate-leaf="true" data-offset-key="18265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确认进程已经关闭，每秒检测一次， 最多检测 closeWait * 2 秒</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18266"><span data-slate-object="text" data-key="18267"><span data-slate-leaf="true" data-offset-key="18267:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18268"><span data-slate-leaf="true" data-offset-key="18268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18269"><span data-slate-leaf="true" data-offset-key="18269:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="18270"><span data-slate-leaf="true" data-offset-key="18270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18271"><span data-slate-leaf="true" data-offset-key="18271:0" data-first-offset="true"><span data-slate-string="true">; i &lt; closeWait*</span></span></span><span data-slate-object="text" data-key="18272"><span data-slate-leaf="true" data-offset-key="18272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="18273"><span data-slate-leaf="true" data-offset-key="18273:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18274"><span data-slate-object="text" data-key="18275"><span data-slate-leaf="true" data-offset-key="18275:0" data-first-offset="true"><span data-slate-string="true">               </span></span></span><span data-slate-object="text" data-key="18276"><span data-slate-leaf="true" data-offset-key="18276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18277"><span data-slate-leaf="true" data-offset-key="18277:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) == </span></span></span><span data-slate-object="text" data-key="18278"><span data-slate-leaf="true" data-offset-key="18278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="18279"><span data-slate-leaf="true" data-offset-key="18279:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18280"><span data-slate-object="text" data-key="18281"><span data-slate-leaf="true" data-offset-key="18281:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="18282"><span data-slate-leaf="true" data-offset-key="18282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18283"><span data-slate-object="text" data-key="18284"><span data-slate-leaf="true" data-offset-key="18284:0" data-first-offset="true"><span data-slate-string="true">               }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18285"><span data-slate-object="text" data-key="18286"><span data-slate-leaf="true" data-offset-key="18286:0" data-first-offset="true"><span data-slate-string="true">               time.Sleep(</span></span></span><span data-slate-object="text" data-key="18287"><span data-slate-leaf="true" data-offset-key="18287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="18288"><span data-slate-leaf="true" data-offset-key="18288:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18289"><span data-slate-object="text" data-key="18290"><span data-slate-leaf="true" data-offset-key="18290:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18291"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18292"><span data-slate-object="text" data-key="18293"><span data-slate-leaf="true" data-offset-key="18293:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18294"><span data-slate-leaf="true" data-offset-key="18294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果进程等待了 2*closeWait 之后还没结束，返回错误，不进行后续的操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18295"><span data-slate-object="text" data-key="18296"><span data-slate-leaf="true" data-offset-key="18296:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18297"><span data-slate-leaf="true" data-offset-key="18297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18298"><span data-slate-leaf="true" data-offset-key="18298:0" data-first-offset="true"><span data-slate-string="true"> util.CheckProcessExist(pid) == </span></span></span><span data-slate-object="text" data-key="18299"><span data-slate-leaf="true" data-offset-key="18299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="18300"><span data-slate-leaf="true" data-offset-key="18300:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18301"><span data-slate-object="text" data-key="18302"><span data-slate-leaf="true" data-offset-key="18302:0" data-first-offset="true"><span data-slate-string="true">               fmt.Println(</span></span></span><span data-slate-object="text" data-key="18303"><span data-slate-leaf="true" data-offset-key="18303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"结束进程失败:"</span></span></span></span><span data-slate-object="text" data-key="18304"><span data-slate-leaf="true" data-offset-key="18304:0" data-first-offset="true"><span data-slate-string="true">+strconv.Itoa(pid), </span></span></span><span data-slate-object="text" data-key="18305"><span data-slate-leaf="true" data-offset-key="18305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"请查看原因"</span></span></span></span><span data-slate-object="text" data-key="18306"><span data-slate-leaf="true" data-offset-key="18306:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18307"><span data-slate-object="text" data-key="18308"><span data-slate-leaf="true" data-offset-key="18308:0" data-first-offset="true"><span data-slate-string="true">               </span></span></span><span data-slate-object="text" data-key="18309"><span data-slate-leaf="true" data-offset-key="18309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18310"><span data-slate-leaf="true" data-offset-key="18310:0" data-first-offset="true"><span data-slate-string="true"> errors.New(</span></span></span><span data-slate-object="text" data-key="18311"><span data-slate-leaf="true" data-offset-key="18311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"结束进程失败"</span></span></span></span><span data-slate-object="text" data-key="18312"><span data-slate-leaf="true" data-offset-key="18312:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18313"><span data-slate-object="text" data-key="18314"><span data-slate-leaf="true" data-offset-key="18314:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18315"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18316"><span data-slate-object="text" data-key="18317"><span data-slate-leaf="true" data-offset-key="18317:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(</span></span></span><span data-slate-object="text" data-key="18318"><span data-slate-leaf="true" data-offset-key="18318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"结束进程成功:"</span></span></span></span><span data-slate-object="text" data-key="18319"><span data-slate-leaf="true" data-offset-key="18319:0" data-first-offset="true"><span data-slate-string="true"> + strconv.Itoa(pid))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18320"><span data-slate-object="text" data-key="18321"><span data-slate-leaf="true" data-offset-key="18321:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18322"><span data-slate-object="text" data-key="18323"><span data-slate-leaf="true" data-offset-key="18323:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18324"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18325"><span data-slate-object="text" data-key="18326"><span data-slate-leaf="true" data-offset-key="18326:0" data-first-offset="true"><span data-slate-string="true">      appDaemon = </span></span></span><span data-slate-object="text" data-key="18327"><span data-slate-leaf="true" data-offset-key="18327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18328"><span data-slate-object="text" data-key="18329"><span data-slate-leaf="true" data-offset-key="18329:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18330"><span data-slate-leaf="true" data-offset-key="18330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 直接 daemon 方式启动 apps</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18331"><span data-slate-object="text" data-key="18332"><span data-slate-leaf="true" data-offset-key="18332:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18333"><span data-slate-leaf="true" data-offset-key="18333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18334"><span data-slate-leaf="true" data-offset-key="18334:0" data-first-offset="true"><span data-slate-string="true"> appStartCommand.RunE(c, args)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18335"><span data-slate-object="text" data-key="18336"><span data-slate-leaf="true" data-offset-key="18336:0" data-first-offset="true"><span data-slate-string="true">   },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18337"><span data-slate-object="text" data-key="18338"><span data-slate-leaf="true" data-offset-key="18338:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18339" id="sr-toc-6"><span data-slate-object="text" data-key="18340"><span data-slate-leaf="true" data-offset-key="18340:0" data-first-offset="true"><span data-slate-string="true">测试</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18341"><span data-slate-object="text" data-key="18342"><span data-slate-leaf="true" data-offset-key="18342:0" data-first-offset="true"><span data-slate-string="true">下面来测试一下。首先记得使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18343"><span data-slate-object="text" data-key="18344"><span data-slate-leaf="true" data-offset-key="18344:0" data-first-offset="true"><span data-slate-string="true">./hade build sef</span></span></span></span><span data-slate-object="text" data-key="18345"><span data-slate-leaf="true" data-offset-key="18345:0" data-first-offset="true"><span data-slate-string="true"> 命令编译，我们设置的默认服务启动地址为 “:8888”，这里就不用这个默认启动地址，使用环境变量 ADDRESS=:8080 来启动服务。这样能测试到环境变量是否能生效。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18346"><span data-slate-object="text" data-key="18347"><span data-slate-leaf="true" data-offset-key="18347:0" data-first-offset="true"><span data-slate-string="true">调用命令  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18348"><span data-slate-object="text" data-key="18349"><span data-slate-leaf="true" data-offset-key="18349:0" data-first-offset="true"><span data-slate-string="true">ADDRESS=:8080 ./hade app start --daemon=true</span></span></span></span><span data-slate-object="text" data-key="18350"><span data-slate-leaf="true" data-offset-key="18350:0" data-first-offset="true"><span data-slate-string="true"> 以 daemon 方式启动一个 8080 端口的服务：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18351"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/5d/a4/5dc59ecb06330bd5097c79fc2040e6a4.png?wh=1316x150"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18352"><span data-slate-object="text" data-key="18353"><span data-slate-leaf="true" data-offset-key="18353:0" data-first-offset="true"><span data-slate-string="true">使用浏览器打开 localhost:8080/demo/demo：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18354"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/aa/97/aa16b16c741b837d94682664d1c0yy97.png?wh=1458x372"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18355"><span data-slate-object="text" data-key="18356"><span data-slate-leaf="true" data-offset-key="18356:0" data-first-offset="true"><span data-slate-string="true">服务启动成功，且正常提供服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18357"><span data-slate-object="text" data-key="18358"><span data-slate-leaf="true" data-offset-key="18358:0" data-first-offset="true"><span data-slate-string="true">使用  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18359"><span data-slate-object="text" data-key="18360"><span data-slate-leaf="true" data-offset-key="18360:0" data-first-offset="true"><span data-slate-string="true">./hade app state</span></span></span></span><span data-slate-object="text" data-key="18361"><span data-slate-leaf="true" data-offset-key="18361:0" data-first-offset="true"><span data-slate-string="true"> 查看进程状态：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18362"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/eb/ee/eb02d0c5f341cbc3632037a6f119dcee.png?wh=922x98"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18363"><span data-slate-object="text" data-key="18364"><span data-slate-leaf="true" data-offset-key="18364:0" data-first-offset="true"><span data-slate-string="true">使用命令  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18365"><span data-slate-object="text" data-key="18366"><span data-slate-leaf="true" data-offset-key="18366:0" data-first-offset="true"><span data-slate-string="true">ADDRESS=:8080 ./hade app restart</span></span></span></span><span data-slate-object="text" data-key="18367"><span data-slate-leaf="true" data-offset-key="18367:0" data-first-offset="true"><span data-slate-string="true"> 重新启动进程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18368"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/2a/c4/2a1b9e077e357364529e43b786e943c4.png?wh=1152x194"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18369"><span data-slate-object="text" data-key="18370"><span data-slate-leaf="true" data-offset-key="18370:0" data-first-offset="true"><span data-slate-string="true">再次访问浏览器 localhost:8080/demo/demo，正常提供服务：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18371"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/95/f4/95a1ce5d43a1bf28133a75f773341cf4.png?wh=804x280"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18372"><span data-slate-object="text" data-key="18373"><span data-slate-leaf="true" data-offset-key="18373:0" data-first-offset="true"><span data-slate-string="true">最后调用停止进程命令 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18374"><span data-slate-object="text" data-key="18375"><span data-slate-leaf="true" data-offset-key="18375:0" data-first-offset="true"><span data-slate-string="true">./hade app stop</span></span></span></span><span data-slate-object="text" data-key="18376"><span data-slate-leaf="true" data-offset-key="18376:0" data-first-offset="true"><span data-slate-string="true"> ：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18377"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/0f/40/0fb19b39412d970ccb72e43635830040.png?wh=964x100"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18378"><span data-slate-object="text" data-key="18379"><span data-slate-leaf="true" data-offset-key="18379:0" data-first-offset="true"><span data-slate-string="true">到这里，对进程的启动、关闭、查询和重启的命令就验证完成了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18380"><span data-slate-object="text" data-key="18381"><span data-slate-leaf="true" data-offset-key="18381:0" data-first-offset="true"><span data-slate-string="true">今天我们的所有代码都保存在 GitHub 上的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18382"><span data-slate-object="text" data-key="18383"><span data-slate-leaf="true" data-offset-key="18383:0" data-first-offset="true"><span data-slate-string="true">geekbang/24</span></span></span></a><span data-slate-object="text" data-key="18384"><span data-slate-leaf="true" data-offset-key="18384:0" data-first-offset="true"><span data-slate-string="true"> 分支了。只修改了 framework/command/app.go 和 framework/util/exec.go 文件，其他保持不变。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18385"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/c1/6b/c137079e767c7fb3a4e1bd2292b6ca6b.png?wh=584x1626" style="width: auto;"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18386" id="sr-toc-7"><span data-slate-object="text" data-key="18387"><span data-slate-leaf="true" data-offset-key="18387:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18388"><span data-slate-object="text" data-key="18389"><span data-slate-leaf="true" data-offset-key="18389:0" data-first-offset="true"><span data-slate-string="true">今天我们完成了运行 app 相关的命令，包括 app 一级命令和四个二级命令，启动 app 服务、停止 app 服务、重启 app 服务、查询 app 服务。基本上已经把一个 app 服务启动的状态变更都包含了。有了这些命令，我们对 app 的控制就方便很多了。特别是 daemon 运行模式，为线上运行提供了不少方便。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18390"><span data-slate-object="text" data-key="18391"><span data-slate-leaf="true" data-offset-key="18391:0" data-first-offset="true"><span data-slate-string="true">在实现这四个命令的过程中，我们使用了不少第三方库，gspt、go-daemon，这些库的使用你要能熟练掌握，特别是 go-daemon 库，我们已经不止一次使用到它了。确认一个进程是否已经结束，我们使用每秒做一次轮询的 CheckProcessExist 方法实现了检查机制，并仔细考虑了轮训的次数和效果，你可以多多体会这么设计的好处。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18392" id="sr-toc-8"><span data-slate-object="text" data-key="18393"><span data-slate-leaf="true" data-offset-key="18393:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18394"><span data-slate-object="text" data-key="18395"><span data-slate-leaf="true" data-offset-key="18395:0" data-first-offset="true"><span data-slate-string="true">我们在启动应用的时候，使用的地址格式为 “:8080”，其实这里也可以为 “localhost:8080”、“127.0.0.1:8080” 或者 “10.11.22.33:8080”（10.11.22.33 为本机绑定的 IP）。你了解 localhost、127.0.0.1、10.11.22.33 以及不填写 IP 的区别么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18396"><span data-slate-object="text" data-key="18397"><span data-slate-leaf="true" data-offset-key="18397:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区分享你的思考。感谢你的收听，如果你觉得今天的内容对你有所帮助，也欢迎分享给你身边的朋友，邀请他一起学习。我们下节课见～</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-9">精选留言 (2)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/b2/e0/bf56878a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>kkxue</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>使用了 syscall 包，windows 上就没法编译了吧</div><div><p>作者回复：是的，这个是一个问题，但是其实目前 docker 化比较流行，对平台的依赖其实没有那么重了</p></div><div><div>2021-11-18</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>宙斯</span></div></div><div>为什么不把 closeWait 直接定义为 2*closeWait 值呢</div><div><div>2021-11-14</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1j"><outline class="toc-level-h1" data-reactid=".1j.0" style="width: 175px;"><active data-reactid=".1j.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1j.0.1"><span data-reactid=".1j.0.1.0">24｜管理进程：如何设计完善的运行命令？</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.1" style="width: 155px;"><active data-reactid=".1j.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1j.1.1"><span data-reactid=".1j.1.1.0">运行命令的设计</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.2" style="width: 155px;"><active data-reactid=".1j.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1j.2.1"><span data-reactid=".1j.2.1.0">启动命令</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.3" style="width: 155px;"><active data-reactid=".1j.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1j.3.1"><span data-reactid=".1j.3.1.0">获取进程</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.4" style="width: 155px;"><active data-reactid=".1j.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1j.4.1"><span data-reactid=".1j.4.1.0">停止命令</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.5" style="width: 155px;"><active data-reactid=".1j.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1j.5.1"><span data-reactid=".1j.5.1.0">重启命令</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.6" style="width: 155px;"><active data-reactid=".1j.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1j.6.1"><span data-reactid=".1j.6.1.0">测试</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.7" style="width: 155px;"><active data-reactid=".1j.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1j.7.1"><span data-reactid=".1j.7.1.0">小结</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.8" style="width: 155px;"><active data-reactid=".1j.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1j.8.1"><span data-reactid=".1j.8.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.9" style="width: 165px;"><active data-reactid=".1j.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1j.9.1"><span data-reactid=".1j.9.1.0">精选留言 (2)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/440646" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>