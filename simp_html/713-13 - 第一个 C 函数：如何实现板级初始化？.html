
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 13 | 第一个 C 函数：如何实现板级初始化？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>13 | 第一个 C 函数：如何实现板级初始化？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">13 | 第一个 C 函数：如何实现板级初始化？</h1><div><span>LMOS</span> <span>2021-06-07</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c8/37/c8936cf69f68a569889e88ee2f539c37.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：19.41M</span><span> 时长：21:15</span></div></div><audio title="13 | 第一个C函数：如何实现板级初始化？" src="https://res001.geekbang.org/media/audio/e0/85/e0744a7d4161a289fbc7197cbc7e9585/ld/ld.m3u8" __idm_id__="942098"></audio></div><div><div><div><div data-slate-editor="true" data-key="10026" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="10027"><span data-slate-object="text" data-key="10028"><span data-slate-leaf="true" data-offset-key="10028:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10029"><span data-slate-object="text" data-key="10030"><span data-slate-leaf="true" data-offset-key="10030:0" data-first-offset="true"><span data-slate-string="true">前面三节课，我们为调用 Cosmos 的</span></span></span><span data-slate-object="text" data-key="10031"><span data-slate-leaf="true" data-offset-key="10031:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一个 C 函数 hal_start 做了大量工作。</span></span></span></span><span data-slate-object="text" data-key="10032"><span data-slate-leaf="true" data-offset-key="10032:0" data-first-offset="true"><span data-slate-string="true">这节课我们要让操作系统 Cosmos 里的第一个 C 函数真正跑起来啦，也就是说，我们会真正进入到我们的内核中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10033"><span data-slate-object="text" data-key="10034"><span data-slate-leaf="true" data-offset-key="10034:0" data-first-offset="true"><span data-slate-string="true">今天我们会继续在这个 hal_start 函数里，首先执行板级初始化，其实就是 hal 层（硬件抽象层，下同）初始化，其中执行了平台初始化，hal 层的内存初始化，中断初始化，最后进入到内核层的初始化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10035"><span data-slate-object="text" data-key="10036"><span data-slate-leaf="true" data-offset-key="10036:0" data-first-offset="true"><span data-slate-string="true">这节课的配套代码，你可以从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10037"><span data-slate-object="text" data-key="10038"><span data-slate-leaf="true" data-offset-key="10038:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="10039"><span data-slate-leaf="true" data-offset-key="10039:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10040" id="sr-toc-1"><span data-slate-object="text" data-key="10041"><span data-slate-leaf="true" data-offset-key="10041:0" data-first-offset="true"><span data-slate-string="true">第一个 C 函数</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10042"><span data-slate-object="text" data-key="10043"><span data-slate-leaf="true" data-offset-key="10043:0" data-first-offset="true"><span data-slate-string="true">任何软件工程，第一个函数总是简单的，因为它是总调用者，像是一个管理者，坐在那里发号施令，自己却是啥活也不干。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10044"><span data-slate-object="text" data-key="10045"><span data-slate-leaf="true" data-offset-key="10045:0" data-first-offset="true"><span data-slate-string="true">由于这是第一个 C 函数，也是初始化函数，我们还是要为它单独建立一个文件，以显示对它的尊重，依然在 Cosmos/hal/x86/ 下建立一个 hal_start.c 文件。写上这样一个函数。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="10046"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10047"><span data-slate-object="text" data-key="10048"><span data-slate-leaf="true" data-offset-key="10048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10049"><span data-slate-leaf="true" data-offset-key="10049:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10050"><span data-slate-leaf="true" data-offset-key="10050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_start</span></span></span></span><span data-slate-object="text" data-key="10051"><span data-slate-leaf="true" data-offset-key="10051:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10052"><span data-slate-leaf="true" data-offset-key="10052:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10053"><span data-slate-object="text" data-key="10054"><span data-slate-leaf="true" data-offset-key="10054:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10055"><span data-slate-object="text" data-key="10056"><span data-slate-leaf="true" data-offset-key="10056:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10057"><span data-slate-leaf="true" data-offset-key="10057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第一步：初始化 hal 层</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10058"><span data-slate-object="text" data-key="10059"><span data-slate-leaf="true" data-offset-key="10059:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10060"><span data-slate-leaf="true" data-offset-key="10060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第二步：初始化内核层</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10061"><span data-slate-object="text" data-key="10062"><span data-slate-leaf="true" data-offset-key="10062:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10063"><span data-slate-leaf="true" data-offset-key="10063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10064"><span data-slate-leaf="true" data-offset-key="10064:0" data-first-offset="true"><span data-slate-string="true">(;;);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10065"><span data-slate-object="text" data-key="10066"><span data-slate-leaf="true" data-offset-key="10066:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10067"><span data-slate-leaf="true" data-offset-key="10067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10068"><span data-slate-leaf="true" data-offset-key="10068:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10069"><span data-slate-object="text" data-key="10070"><span data-slate-leaf="true" data-offset-key="10070:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10071"><span data-slate-object="text" data-key="10072"><span data-slate-leaf="true" data-offset-key="10072:0" data-first-offset="true"><span data-slate-string="true">根据前面的设计，Cosmos 是有 hal 层和内核层之分，所以在上述代码中，要分两步走。第一步是初始化 hal 层；第二步，初始化内核层。只是这两步的函数我们还没有写。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10073"><span data-slate-object="text" data-key="10074"><span data-slate-leaf="true" data-offset-key="10074:0" data-first-offset="true"><span data-slate-string="true">然而最后的死循环却有点奇怪，其实它的目的很简单，就是避免这个函数返回，因为这个返回了就无处可去，避免走回头路。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10075" id="sr-toc-2"><span data-slate-object="text" data-key="10076"><span data-slate-leaf="true" data-offset-key="10076:0" data-first-offset="true"><span data-slate-string="true">hal 层初始化</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10077"><span data-slate-object="text" data-key="10078"><span data-slate-leaf="true" data-offset-key="10078:0" data-first-offset="true"><span data-slate-string="true">为了分离硬件的特性，我们设计了 hal 层，把硬件相关的操作集中在这个层，并向上提供接口，目的是让内核上层不用关注硬件相关的细节，也能方便以后移植和扩展。(关于 hal 层的设计，可以回顾</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10079"><span data-slate-object="text" data-key="10080"><span data-slate-leaf="true" data-offset-key="10080:0" data-first-offset="true"><span data-slate-string="true">第 3 节课</span></span></span></a><span data-slate-object="text" data-key="10081"><span data-slate-leaf="true" data-offset-key="10081:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10082"><span data-slate-object="text" data-key="10083"><span data-slate-leaf="true" data-offset-key="10083:0" data-first-offset="true"><span data-slate-string="true">也许今天我们是在 x86 平台上写 Cosmos，明天就要在 ARM 平台上开发 Cosmos，那时我们就可以写个 ARM 平台的 hal 层，来替换 Cosmos 中的 x86 平台的 hal 层。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10084"><span data-slate-object="text" data-key="10085"><span data-slate-leaf="true" data-offset-key="10085:0" data-first-offset="true"><span data-slate-string="true">下面我们在 Cosmos/hal/x86/ 下建立一个 halinit.c 文件，写出 hal 层的初始化函数。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="10086"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10087"><span data-slate-object="text" data-key="10088"><span data-slate-leaf="true" data-offset-key="10088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10089"><span data-slate-leaf="true" data-offset-key="10089:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10090"><span data-slate-leaf="true" data-offset-key="10090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_hal</span></span></span></span><span data-slate-object="text" data-key="10091"><span data-slate-leaf="true" data-offset-key="10091:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10092"><span data-slate-leaf="true" data-offset-key="10092:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10093"><span data-slate-object="text" data-key="10094"><span data-slate-leaf="true" data-offset-key="10094:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10095"><span data-slate-object="text" data-key="10096"><span data-slate-leaf="true" data-offset-key="10096:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10097"><span data-slate-leaf="true" data-offset-key="10097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化平台</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10098"><span data-slate-object="text" data-key="10099"><span data-slate-leaf="true" data-offset-key="10099:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10100"><span data-slate-leaf="true" data-offset-key="10100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化内存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10101"><span data-slate-object="text" data-key="10102"><span data-slate-leaf="true" data-offset-key="10102:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10103"><span data-slate-leaf="true" data-offset-key="10103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10104"><span data-slate-object="text" data-key="10105"><span data-slate-leaf="true" data-offset-key="10105:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10106"><span data-slate-leaf="true" data-offset-key="10106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10107"><span data-slate-leaf="true" data-offset-key="10107:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10108"><span data-slate-object="text" data-key="10109"><span data-slate-leaf="true" data-offset-key="10109:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10110"><span data-slate-object="text" data-key="10111"><span data-slate-leaf="true" data-offset-key="10111:0" data-first-offset="true"><span data-slate-string="true">这个函数也是一个调用者，没怎么干活。不过根据代码的注释能看出，它调用的函数多一点，但主要是完成初始化平台、初始化内存、初始化中断的功能函数。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10112" id="sr-toc-3"><span data-slate-object="text" data-key="10113"><span data-slate-leaf="true" data-offset-key="10113:0" data-first-offset="true"><span data-slate-string="true">初始化平台</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="10114"><span data-slate-object="text" data-key="10115"><span data-slate-leaf="true" data-offset-key="10115:0" data-first-offset="true"><span data-slate-string="true">我们先来写好平台初始化函数，因为它需要最先被调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10116"><span data-slate-object="text" data-key="10117"><span data-slate-leaf="true" data-offset-key="10117:0" data-first-offset="true"><span data-slate-string="true">这个函数主要负责完成两个任务，一是</span></span></span><span data-slate-object="text" data-key="10118"><span data-slate-leaf="true" data-offset-key="10118:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">把二级引导器建立的机器信息结构复制到 hal 层中的一个全局变量中</span></span></span></span><span data-slate-object="text" data-key="10119"><span data-slate-leaf="true" data-offset-key="10119:0" data-first-offset="true"><span data-slate-string="true">，方便内核中的其它代码使用里面的信息，之后二级引导器建立的数据所占用的内存都会被释放。二是要</span></span></span><span data-slate-object="text" data-key="10120"><span data-slate-leaf="true" data-offset-key="10120:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">初始化图形显示驱动</span></span></span></span><span data-slate-object="text" data-key="10121"><span data-slate-leaf="true" data-offset-key="10121:0" data-first-offset="true"><span data-slate-string="true">，内核在运行过程要在屏幕上输出信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10122"><span data-slate-object="text" data-key="10123"><span data-slate-leaf="true" data-offset-key="10123:0" data-first-offset="true"><span data-slate-string="true">下面我们在 Cosmos/hal/x86/ 下建立一个 halplatform.c 文件，写上如下代码。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10124"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10125"><span data-slate-object="text" data-key="10126"><span data-slate-leaf="true" data-offset-key="10126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="10127"><span data-slate-leaf="true" data-offset-key="10127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10128"><span data-slate-leaf="true" data-offset-key="10128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t_init</span></span></span></span></span><span data-slate-object="text" data-key="10129"><span data-slate-leaf="true" data-offset-key="10129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="10130"><span data-slate-leaf="true" data-offset-key="10130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span></span></span><span data-slate-object="text" data-key="10131"><span data-slate-leaf="true" data-offset-key="10131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *initp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10132"><span data-slate-object="text" data-key="10133"><span data-slate-leaf="true" data-offset-key="10133:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10134"><span data-slate-object="text" data-key="10135"><span data-slate-leaf="true" data-offset-key="10135:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10136"><span data-slate-leaf="true" data-offset-key="10136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清零</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10137"><span data-slate-object="text" data-key="10138"><span data-slate-leaf="true" data-offset-key="10138:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10139"><span data-slate-leaf="true" data-offset-key="10139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">memset</span></span></span></span><span data-slate-object="text" data-key="10140"><span data-slate-leaf="true" data-offset-key="10140:0" data-first-offset="true"><span data-slate-string="true">(initp, </span></span></span><span data-slate-object="text" data-key="10141"><span data-slate-leaf="true" data-offset-key="10141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10142"><span data-slate-leaf="true" data-offset-key="10142:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10143"><span data-slate-leaf="true" data-offset-key="10143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="10144"><span data-slate-leaf="true" data-offset-key="10144:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10145"><span data-slate-leaf="true" data-offset-key="10145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="10146"><span data-slate-leaf="true" data-offset-key="10146:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10147"><span data-slate-object="text" data-key="10148"><span data-slate-leaf="true" data-offset-key="10148:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10149"><span data-slate-leaf="true" data-offset-key="10149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10150"><span data-slate-leaf="true" data-offset-key="10150:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10151"><span data-slate-object="text" data-key="10152"><span data-slate-leaf="true" data-offset-key="10152:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10153"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10154"><span data-slate-object="text" data-key="10155"><span data-slate-leaf="true" data-offset-key="10155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="10156"><span data-slate-leaf="true" data-offset-key="10156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10157"><span data-slate-leaf="true" data-offset-key="10157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_machbstart</span></span></span></span></span><span data-slate-object="text" data-key="10158"><span data-slate-leaf="true" data-offset-key="10158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10159"><span data-slate-object="text" data-key="10160"><span data-slate-leaf="true" data-offset-key="10160:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10161"><span data-slate-object="text" data-key="10162"><span data-slate-leaf="true" data-offset-key="10162:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10163"><span data-slate-leaf="true" data-offset-key="10163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="10164"><span data-slate-leaf="true" data-offset-key="10164:0" data-first-offset="true"><span data-slate-string="true"> *kmbsp = &amp;kmachbsp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10165"><span data-slate-object="text" data-key="10166"><span data-slate-leaf="true" data-offset-key="10166:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10167"><span data-slate-leaf="true" data-offset-key="10167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="10168"><span data-slate-leaf="true" data-offset-key="10168:0" data-first-offset="true"><span data-slate-string="true"> *smbsp = MBSPADR;</span></span></span><span data-slate-object="text" data-key="10169"><span data-slate-leaf="true" data-offset-key="10169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 物理地址 1MB 处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10170"><span data-slate-object="text" data-key="10171"><span data-slate-leaf="true" data-offset-key="10171:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10172"><span data-slate-leaf="true" data-offset-key="10172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t_init</span></span></span></span><span data-slate-object="text" data-key="10173"><span data-slate-leaf="true" data-offset-key="10173:0" data-first-offset="true"><span data-slate-string="true">(kmbsp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10174"><span data-slate-object="text" data-key="10175"><span data-slate-leaf="true" data-offset-key="10175:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_db662165" data-attr-id="38041" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="10176"><span data-slate-leaf="true" data-offset-key="10176:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_db662165" data-attr-id="38041" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 复制，要把地址转换成虚拟地址</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10177"><span data-slate-object="text" data-key="10178"><span data-slate-leaf="true" data-offset-key="10178:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10179"><span data-slate-leaf="true" data-offset-key="10179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">memcopy</span></span></span></span><span data-slate-object="text" data-key="10180"><span data-slate-leaf="true" data-offset-key="10180:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="10181"><span data-slate-leaf="true" data-offset-key="10181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10182"><span data-slate-leaf="true" data-offset-key="10182:0" data-first-offset="true"><span data-slate-string="true"> *)</span></span></span><span data-slate-object="text" data-key="10183"><span data-slate-leaf="true" data-offset-key="10183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">phyadr_to_viradr</span></span></span></span><span data-slate-object="text" data-key="10184"><span data-slate-leaf="true" data-offset-key="10184:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="10185"><span data-slate-leaf="true" data-offset-key="10185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="10186"><span data-slate-leaf="true" data-offset-key="10186:0" data-first-offset="true"><span data-slate-string="true">)smbsp), (</span></span></span><span data-slate-object="text" data-key="10187"><span data-slate-leaf="true" data-offset-key="10187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10188"><span data-slate-leaf="true" data-offset-key="10188:0" data-first-offset="true"><span data-slate-string="true"> *)kmbsp, </span></span></span><span data-slate-object="text" data-key="10189"><span data-slate-leaf="true" data-offset-key="10189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="10190"><span data-slate-leaf="true" data-offset-key="10190:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10191"><span data-slate-leaf="true" data-offset-key="10191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="10192"><span data-slate-leaf="true" data-offset-key="10192:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10193"><span data-slate-object="text" data-key="10194"><span data-slate-leaf="true" data-offset-key="10194:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10195"><span data-slate-leaf="true" data-offset-key="10195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10196"><span data-slate-leaf="true" data-offset-key="10196:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10197"><span data-slate-object="text" data-key="10198"><span data-slate-leaf="true" data-offset-key="10198:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10199"><span data-slate-object="text" data-key="10200"><span data-slate-leaf="true" data-offset-key="10200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 平台初始化函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10201"><span data-slate-object="text" data-key="10202"><span data-slate-leaf="true" data-offset-key="10202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="10203"><span data-slate-leaf="true" data-offset-key="10203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10204"><span data-slate-leaf="true" data-offset-key="10204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_halplaltform</span></span></span></span></span><span data-slate-object="text" data-key="10205"><span data-slate-leaf="true" data-offset-key="10205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10206"><span data-slate-object="text" data-key="10207"><span data-slate-leaf="true" data-offset-key="10207:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10208"><span data-slate-object="text" data-key="10209"><span data-slate-leaf="true" data-offset-key="10209:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10210"><span data-slate-leaf="true" data-offset-key="10210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 复制机器信息结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10211"><span data-slate-object="text" data-key="10212"><span data-slate-leaf="true" data-offset-key="10212:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10213"><span data-slate-leaf="true" data-offset-key="10213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_machbstart</span></span></span></span><span data-slate-object="text" data-key="10214"><span data-slate-leaf="true" data-offset-key="10214:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10215"><span data-slate-object="text" data-key="10216"><span data-slate-leaf="true" data-offset-key="10216:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10217"><span data-slate-leaf="true" data-offset-key="10217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化图形显示驱动</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10218"><span data-slate-object="text" data-key="10219"><span data-slate-leaf="true" data-offset-key="10219:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10220"><span data-slate-leaf="true" data-offset-key="10220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bdvideo</span></span></span></span><span data-slate-object="text" data-key="10221"><span data-slate-leaf="true" data-offset-key="10221:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10222"><span data-slate-object="text" data-key="10223"><span data-slate-leaf="true" data-offset-key="10223:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10224"><span data-slate-leaf="true" data-offset-key="10224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10225"><span data-slate-leaf="true" data-offset-key="10225:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10226"><span data-slate-object="text" data-key="10227"><span data-slate-leaf="true" data-offset-key="10227:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10228"><span data-slate-object="text" data-key="10229"><span data-slate-leaf="true" data-offset-key="10229:0" data-first-offset="true"><span data-slate-string="true">这个代码中别的地方很好理解，就是 kmachbsp 你可能会有点奇怪，它是个结构体变量，结构体类型是 machbstart_t，这个结构和二级引导器所使用的一模一样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10230"><span data-slate-object="text" data-key="10231"><span data-slate-leaf="true" data-offset-key="10231:0" data-first-offset="true"><span data-slate-string="true">同时，它还是一个 hal 层的全局变量，我们想专门有个文件定义所有 hal 层的全局变量，于是我们在 Cosmos/hal/x86/ 下建立一个 halglobal.c 文件，写上如下代码。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10232"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10233"><span data-slate-object="text" data-key="10234"><span data-slate-leaf="true" data-offset-key="10234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 全局变量定义变量放在 data 段</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10235"><span data-slate-object="text" data-key="10236"><span data-slate-leaf="true" data-offset-key="10236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10237"><span data-slate-leaf="true" data-offset-key="10237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10238"><span data-slate-leaf="true" data-offset-key="10238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> HAL_DEFGLOB_VARIABLE(vartype,varname) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10239"><span data-slate-object="text" data-key="10240"><span data-slate-leaf="true" data-offset-key="10240:0" data-first-offset="true"><span data-slate-string="true">EXTERN  __attribute__((section(</span></span></span><span data-slate-object="text" data-key="10241"><span data-slate-leaf="true" data-offset-key="10241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">".data"</span></span></span></span><span data-slate-object="text" data-key="10242"><span data-slate-leaf="true" data-offset-key="10242:0" data-first-offset="true"><span data-slate-string="true">))) vartype varname</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10243"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10244"><span data-slate-object="text" data-key="10245"><span data-slate-leaf="true" data-offset-key="10245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HAL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="10246"><span data-slate-leaf="true" data-offset-key="10246:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10247"><span data-slate-leaf="true" data-offset-key="10247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="10248"><span data-slate-leaf="true" data-offset-key="10248:0" data-first-offset="true"><span data-slate-string="true">,kmachbsp);</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10249"><span data-slate-object="text" data-key="10250"><span data-slate-leaf="true" data-offset-key="10250:0" data-first-offset="true"><span data-slate-string="true">前面的 EXTERN，在 halglobal.c 文件中定义为空，而在其它文件中定义为 extern，告诉编译器这是外部文件的变量，避免发生错误。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10251"><span data-slate-object="text" data-key="10252"><span data-slate-leaf="true" data-offset-key="10252:0" data-first-offset="true"><span data-slate-string="true">下面，我们在 Cosmos/hal/x86/ 下的 bdvideo.c 文件中，写好 init_bdvideo 函数。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="10253"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10254"><span data-slate-object="text" data-key="10255"><span data-slate-leaf="true" data-offset-key="10255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10256"><span data-slate-leaf="true" data-offset-key="10256:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10257"><span data-slate-leaf="true" data-offset-key="10257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bdvideo</span></span></span></span><span data-slate-object="text" data-key="10258"><span data-slate-leaf="true" data-offset-key="10258:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10259"><span data-slate-leaf="true" data-offset-key="10259:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10260"><span data-slate-object="text" data-key="10261"><span data-slate-leaf="true" data-offset-key="10261:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10262"><span data-slate-object="text" data-key="10263"><span data-slate-leaf="true" data-offset-key="10263:0" data-first-offset="true"><span data-slate-string="true">    dftgraph_t *kghp = &amp;kdftgh;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10264"><span data-slate-object="text" data-key="10265"><span data-slate-leaf="true" data-offset-key="10265:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10266"><span data-slate-leaf="true" data-offset-key="10266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化图形数据结构，里面放有图形模式，分辨率，图形驱动函数指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10267"><span data-slate-object="text" data-key="10268"><span data-slate-leaf="true" data-offset-key="10268:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10269"><span data-slate-leaf="true" data-offset-key="10269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_dftgraph</span></span></span></span><span data-slate-object="text" data-key="10270"><span data-slate-leaf="true" data-offset-key="10270:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10271"><span data-slate-object="text" data-key="10272"><span data-slate-leaf="true" data-offset-key="10272:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10273"><span data-slate-leaf="true" data-offset-key="10273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始 bga 图形显卡的函数指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10274"><span data-slate-object="text" data-key="10275"><span data-slate-leaf="true" data-offset-key="10275:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10276"><span data-slate-leaf="true" data-offset-key="10276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_bga</span></span></span></span><span data-slate-object="text" data-key="10277"><span data-slate-leaf="true" data-offset-key="10277:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10278"><span data-slate-object="text" data-key="10279"><span data-slate-leaf="true" data-offset-key="10279:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10280"><span data-slate-leaf="true" data-offset-key="10280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始 vbe 图形显卡的函数指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10281"><span data-slate-object="text" data-key="10282"><span data-slate-leaf="true" data-offset-key="10282:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10283"><span data-slate-leaf="true" data-offset-key="10283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_vbe</span></span></span></span><span data-slate-object="text" data-key="10284"><span data-slate-leaf="true" data-offset-key="10284:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10285"><span data-slate-object="text" data-key="10286"><span data-slate-leaf="true" data-offset-key="10286:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10287"><span data-slate-leaf="true" data-offset-key="10287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清空屏幕 为黑色</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10288"><span data-slate-object="text" data-key="10289"><span data-slate-leaf="true" data-offset-key="10289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10290"><span data-slate-leaf="true" data-offset-key="10290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fill_graph</span></span></span></span><span data-slate-object="text" data-key="10291"><span data-slate-leaf="true" data-offset-key="10291:0" data-first-offset="true"><span data-slate-string="true">(kghp, </span></span></span><span data-slate-object="text" data-key="10292"><span data-slate-leaf="true" data-offset-key="10292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BGRA</span></span></span></span><span data-slate-object="text" data-key="10293"><span data-slate-leaf="true" data-offset-key="10293:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10294"><span data-slate-leaf="true" data-offset-key="10294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10295"><span data-slate-leaf="true" data-offset-key="10295:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10296"><span data-slate-leaf="true" data-offset-key="10296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10297"><span data-slate-leaf="true" data-offset-key="10297:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10298"><span data-slate-leaf="true" data-offset-key="10298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10299"><span data-slate-leaf="true" data-offset-key="10299:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10300"><span data-slate-object="text" data-key="10301"><span data-slate-leaf="true" data-offset-key="10301:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10302"><span data-slate-leaf="true" data-offset-key="10302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显示背景图片 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10303"><span data-slate-object="text" data-key="10304"><span data-slate-leaf="true" data-offset-key="10304:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10305"><span data-slate-leaf="true" data-offset-key="10305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_charsdxwflush</span></span></span></span><span data-slate-object="text" data-key="10306"><span data-slate-leaf="true" data-offset-key="10306:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10307"><span data-slate-leaf="true" data-offset-key="10307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10308"><span data-slate-leaf="true" data-offset-key="10308:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="10309"><span data-slate-leaf="true" data-offset-key="10309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10310"><span data-slate-leaf="true" data-offset-key="10310:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10311"><span data-slate-object="text" data-key="10312"><span data-slate-leaf="true" data-offset-key="10312:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10313"><span data-slate-leaf="true" data-offset-key="10313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_background</span></span></span></span><span data-slate-object="text" data-key="10314"><span data-slate-leaf="true" data-offset-key="10314:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10315"><span data-slate-object="text" data-key="10316"><span data-slate-leaf="true" data-offset-key="10316:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10317"><span data-slate-leaf="true" data-offset-key="10317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10318"><span data-slate-leaf="true" data-offset-key="10318:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10319"><span data-slate-object="text" data-key="10320"><span data-slate-leaf="true" data-offset-key="10320:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10321"><span data-slate-object="text" data-key="10322"><span data-slate-leaf="true" data-offset-key="10322:0" data-first-offset="true"><span data-slate-string="true">init_dftgraph () 函数初始了 dftgraph_t 结构体类型的变量 kdftgh，我们在 halglobal.c 文件中定义这个变量，结构类型我们这样来定义。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10323"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10324"><span data-slate-object="text" data-key="10325"><span data-slate-leaf="true" data-offset-key="10325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="10326"><span data-slate-leaf="true" data-offset-key="10326:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10327"><span data-slate-leaf="true" data-offset-key="10327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="10328"><span data-slate-leaf="true" data-offset-key="10328:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10329"><span data-slate-leaf="true" data-offset-key="10329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_DFTGRAPH</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10330"><span data-slate-object="text" data-key="10331"><span data-slate-leaf="true" data-offset-key="10331:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10332"><span data-slate-object="text" data-key="10333"><span data-slate-leaf="true" data-offset-key="10333:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10334"><span data-slate-leaf="true" data-offset-key="10334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10335"><span data-slate-leaf="true" data-offset-key="10335:0" data-first-offset="true"><span data-slate-string="true"> gh_mode;         </span></span></span><span data-slate-object="text" data-key="10336"><span data-slate-leaf="true" data-offset-key="10336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 图形模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10337"><span data-slate-object="text" data-key="10338"><span data-slate-leaf="true" data-offset-key="10338:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10339"><span data-slate-leaf="true" data-offset-key="10339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10340"><span data-slate-leaf="true" data-offset-key="10340:0" data-first-offset="true"><span data-slate-string="true"> gh_x;            </span></span></span><span data-slate-object="text" data-key="10341"><span data-slate-leaf="true" data-offset-key="10341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 水平像素点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10342"><span data-slate-object="text" data-key="10343"><span data-slate-leaf="true" data-offset-key="10343:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10344"><span data-slate-leaf="true" data-offset-key="10344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10345"><span data-slate-leaf="true" data-offset-key="10345:0" data-first-offset="true"><span data-slate-string="true"> gh_y;            </span></span></span><span data-slate-object="text" data-key="10346"><span data-slate-leaf="true" data-offset-key="10346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 垂直像素点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10347"><span data-slate-object="text" data-key="10348"><span data-slate-leaf="true" data-offset-key="10348:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10349"><span data-slate-leaf="true" data-offset-key="10349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10350"><span data-slate-leaf="true" data-offset-key="10350:0" data-first-offset="true"><span data-slate-string="true"> gh_framphyadr;   </span></span></span><span data-slate-object="text" data-key="10351"><span data-slate-leaf="true" data-offset-key="10351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显存物理地址 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10352"><span data-slate-object="text" data-key="10353"><span data-slate-leaf="true" data-offset-key="10353:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10354"><span data-slate-leaf="true" data-offset-key="10354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10355"><span data-slate-leaf="true" data-offset-key="10355:0" data-first-offset="true"><span data-slate-string="true"> gh_fvrmphyadr;   </span></span></span><span data-slate-object="text" data-key="10356"><span data-slate-leaf="true" data-offset-key="10356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显存虚拟地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10357"><span data-slate-object="text" data-key="10358"><span data-slate-leaf="true" data-offset-key="10358:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10359"><span data-slate-leaf="true" data-offset-key="10359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10360"><span data-slate-leaf="true" data-offset-key="10360:0" data-first-offset="true"><span data-slate-string="true"> gh_fvrmsz;       </span></span></span><span data-slate-object="text" data-key="10361"><span data-slate-leaf="true" data-offset-key="10361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显存大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10362"><span data-slate-object="text" data-key="10363"><span data-slate-leaf="true" data-offset-key="10363:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10364"><span data-slate-leaf="true" data-offset-key="10364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10365"><span data-slate-leaf="true" data-offset-key="10365:0" data-first-offset="true"><span data-slate-string="true"> gh_onepixbits;   </span></span></span><span data-slate-object="text" data-key="10366"><span data-slate-leaf="true" data-offset-key="10366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 一个像素字占用的数据位数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10367"><span data-slate-object="text" data-key="10368"><span data-slate-leaf="true" data-offset-key="10368:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10369"><span data-slate-leaf="true" data-offset-key="10369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10370"><span data-slate-leaf="true" data-offset-key="10370:0" data-first-offset="true"><span data-slate-string="true"> gh_onepixbyte;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10371"><span data-slate-object="text" data-key="10372"><span data-slate-leaf="true" data-offset-key="10372:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10373"><span data-slate-leaf="true" data-offset-key="10373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10374"><span data-slate-leaf="true" data-offset-key="10374:0" data-first-offset="true"><span data-slate-string="true"> gh_vbemodenr;    </span></span></span><span data-slate-object="text" data-key="10375"><span data-slate-leaf="true" data-offset-key="10375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//vbe 模式号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10376"><span data-slate-object="text" data-key="10377"><span data-slate-leaf="true" data-offset-key="10377:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10378"><span data-slate-leaf="true" data-offset-key="10378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10379"><span data-slate-leaf="true" data-offset-key="10379:0" data-first-offset="true"><span data-slate-string="true"> gh_bank;         </span></span></span><span data-slate-object="text" data-key="10380"><span data-slate-leaf="true" data-offset-key="10380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 显存的 bank 数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10381"><span data-slate-object="text" data-key="10382"><span data-slate-leaf="true" data-offset-key="10382:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10383"><span data-slate-leaf="true" data-offset-key="10383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10384"><span data-slate-leaf="true" data-offset-key="10384:0" data-first-offset="true"><span data-slate-string="true"> gh_curdipbnk;    </span></span></span><span data-slate-object="text" data-key="10385"><span data-slate-leaf="true" data-offset-key="10385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前 bank</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10386"><span data-slate-object="text" data-key="10387"><span data-slate-leaf="true" data-offset-key="10387:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10388"><span data-slate-leaf="true" data-offset-key="10388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10389"><span data-slate-leaf="true" data-offset-key="10389:0" data-first-offset="true"><span data-slate-string="true"> gh_nextbnk;      </span></span></span><span data-slate-object="text" data-key="10390"><span data-slate-leaf="true" data-offset-key="10390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 下一个 bank</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10391"><span data-slate-object="text" data-key="10392"><span data-slate-leaf="true" data-offset-key="10392:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10393"><span data-slate-leaf="true" data-offset-key="10393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10394"><span data-slate-leaf="true" data-offset-key="10394:0" data-first-offset="true"><span data-slate-string="true"> gh_banksz;       </span></span></span><span data-slate-object="text" data-key="10395"><span data-slate-leaf="true" data-offset-key="10395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//bank 大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10396"><span data-slate-object="text" data-key="10397"><span data-slate-leaf="true" data-offset-key="10397:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10398"><span data-slate-leaf="true" data-offset-key="10398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10399"><span data-slate-leaf="true" data-offset-key="10399:0" data-first-offset="true"><span data-slate-string="true"> gh_fontadr;      </span></span></span><span data-slate-object="text" data-key="10400"><span data-slate-leaf="true" data-offset-key="10400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字库地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10401"><span data-slate-object="text" data-key="10402"><span data-slate-leaf="true" data-offset-key="10402:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10403"><span data-slate-leaf="true" data-offset-key="10403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10404"><span data-slate-leaf="true" data-offset-key="10404:0" data-first-offset="true"><span data-slate-string="true"> gh_fontsz;       </span></span></span><span data-slate-object="text" data-key="10405"><span data-slate-leaf="true" data-offset-key="10405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字库大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10406"><span data-slate-object="text" data-key="10407"><span data-slate-leaf="true" data-offset-key="10407:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10408"><span data-slate-leaf="true" data-offset-key="10408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10409"><span data-slate-leaf="true" data-offset-key="10409:0" data-first-offset="true"><span data-slate-string="true"> gh_fnthight;     </span></span></span><span data-slate-object="text" data-key="10410"><span data-slate-leaf="true" data-offset-key="10410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字体高度</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10411"><span data-slate-object="text" data-key="10412"><span data-slate-leaf="true" data-offset-key="10412:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10413"><span data-slate-leaf="true" data-offset-key="10413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10414"><span data-slate-leaf="true" data-offset-key="10414:0" data-first-offset="true"><span data-slate-string="true"> gh_nxtcharsx;    </span></span></span><span data-slate-object="text" data-key="10415"><span data-slate-leaf="true" data-offset-key="10415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 下一字符显示的 x 坐标</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10416"><span data-slate-object="text" data-key="10417"><span data-slate-leaf="true" data-offset-key="10417:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10418"><span data-slate-leaf="true" data-offset-key="10418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10419"><span data-slate-leaf="true" data-offset-key="10419:0" data-first-offset="true"><span data-slate-string="true"> gh_nxtcharsy;    </span></span></span><span data-slate-object="text" data-key="10420"><span data-slate-leaf="true" data-offset-key="10420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 下一字符显示的 y 坐标</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10421"><span data-slate-object="text" data-key="10422"><span data-slate-leaf="true" data-offset-key="10422:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10423"><span data-slate-leaf="true" data-offset-key="10423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10424"><span data-slate-leaf="true" data-offset-key="10424:0" data-first-offset="true"><span data-slate-string="true"> gh_linesz;       </span></span></span><span data-slate-object="text" data-key="10425"><span data-slate-leaf="true" data-offset-key="10425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字符行高</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10426"><span data-slate-object="text" data-key="10427"><span data-slate-leaf="true" data-offset-key="10427:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10428"><span data-slate-leaf="true" data-offset-key="10428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixl_t</span></span></span></span><span data-slate-object="text" data-key="10429"><span data-slate-leaf="true" data-offset-key="10429:0" data-first-offset="true"><span data-slate-string="true"> gh_deffontpx;   </span></span></span><span data-slate-object="text" data-key="10430"><span data-slate-leaf="true" data-offset-key="10430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 默认字体大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10431"><span data-slate-object="text" data-key="10432"><span data-slate-leaf="true" data-offset-key="10432:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10433"><span data-slate-leaf="true" data-offset-key="10433:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10434"><span data-slate-leaf="true" data-offset-key="10434:0" data-first-offset="true"><span data-slate-string="true"> gh_chardxw;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10435"><span data-slate-object="text" data-key="10436"><span data-slate-leaf="true" data-offset-key="10436:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10437"><span data-slate-leaf="true" data-offset-key="10437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10438"><span data-slate-leaf="true" data-offset-key="10438:0" data-first-offset="true"><span data-slate-string="true"> gh_flush;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10439"><span data-slate-object="text" data-key="10440"><span data-slate-leaf="true" data-offset-key="10440:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10441"><span data-slate-leaf="true" data-offset-key="10441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10442"><span data-slate-leaf="true" data-offset-key="10442:0" data-first-offset="true"><span data-slate-string="true"> gh_framnr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10443"><span data-slate-object="text" data-key="10444"><span data-slate-leaf="true" data-offset-key="10444:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10445"><span data-slate-leaf="true" data-offset-key="10445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10446"><span data-slate-leaf="true" data-offset-key="10446:0" data-first-offset="true"><span data-slate-string="true"> gh_fshdata;      </span></span></span><span data-slate-object="text" data-key="10447"><span data-slate-leaf="true" data-offset-key="10447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 刷新相关的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10448"><span data-slate-object="text" data-key="10449"><span data-slate-leaf="true" data-offset-key="10449:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10450"><span data-slate-leaf="true" data-offset-key="10450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dftghops_t</span></span></span></span><span data-slate-object="text" data-key="10451"><span data-slate-leaf="true" data-offset-key="10451:0" data-first-offset="true"><span data-slate-string="true"> gh_opfun;   </span></span></span><span data-slate-object="text" data-key="10452"><span data-slate-leaf="true" data-offset-key="10452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 图形驱动操作函数指针结构体</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10453"><span data-slate-object="text" data-key="10454"><span data-slate-leaf="true" data-offset-key="10454:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="10455"><span data-slate-leaf="true" data-offset-key="10455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dftgraph_t</span></span></span></span><span data-slate-object="text" data-key="10456"><span data-slate-leaf="true" data-offset-key="10456:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10457"><span data-slate-object="text" data-key="10458"><span data-slate-leaf="true" data-offset-key="10458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="10459"><span data-slate-leaf="true" data-offset-key="10459:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10460"><span data-slate-leaf="true" data-offset-key="10460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="10461"><span data-slate-leaf="true" data-offset-key="10461:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10462"><span data-slate-leaf="true" data-offset-key="10462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_DFTGHOPS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10463"><span data-slate-object="text" data-key="10464"><span data-slate-leaf="true" data-offset-key="10464:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10465"><span data-slate-object="text" data-key="10466"><span data-slate-leaf="true" data-offset-key="10466:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10467"><span data-slate-leaf="true" data-offset-key="10467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读写显存数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10468"><span data-slate-object="text" data-key="10469"><span data-slate-leaf="true" data-offset-key="10469:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10470"><span data-slate-leaf="true" data-offset-key="10470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="10471"><span data-slate-leaf="true" data-offset-key="10471:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_read)(</span></span></span><span data-slate-object="text" data-key="10472"><span data-slate-leaf="true" data-offset-key="10472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10473"><span data-slate-leaf="true" data-offset-key="10473:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10474"><span data-slate-leaf="true" data-offset-key="10474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10475"><span data-slate-leaf="true" data-offset-key="10475:0" data-first-offset="true"><span data-slate-string="true">* outp,</span></span></span><span data-slate-object="text" data-key="10476"><span data-slate-leaf="true" data-offset-key="10476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="10477"><span data-slate-leaf="true" data-offset-key="10477:0" data-first-offset="true"><span data-slate-string="true"> rdsz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10478"><span data-slate-object="text" data-key="10479"><span data-slate-leaf="true" data-offset-key="10479:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10480"><span data-slate-leaf="true" data-offset-key="10480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="10481"><span data-slate-leaf="true" data-offset-key="10481:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_write)(</span></span></span><span data-slate-object="text" data-key="10482"><span data-slate-leaf="true" data-offset-key="10482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10483"><span data-slate-leaf="true" data-offset-key="10483:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10484"><span data-slate-leaf="true" data-offset-key="10484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10485"><span data-slate-leaf="true" data-offset-key="10485:0" data-first-offset="true"><span data-slate-string="true">* inp,</span></span></span><span data-slate-object="text" data-key="10486"><span data-slate-leaf="true" data-offset-key="10486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="10487"><span data-slate-leaf="true" data-offset-key="10487:0" data-first-offset="true"><span data-slate-string="true"> wesz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10488"><span data-slate-object="text" data-key="10489"><span data-slate-leaf="true" data-offset-key="10489:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10490"><span data-slate-leaf="true" data-offset-key="10490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10491"><span data-slate-leaf="true" data-offset-key="10491:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_ioctrl)(</span></span></span><span data-slate-object="text" data-key="10492"><span data-slate-leaf="true" data-offset-key="10492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10493"><span data-slate-leaf="true" data-offset-key="10493:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10494"><span data-slate-leaf="true" data-offset-key="10494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10495"><span data-slate-leaf="true" data-offset-key="10495:0" data-first-offset="true"><span data-slate-string="true">* outp,</span></span></span><span data-slate-object="text" data-key="10496"><span data-slate-leaf="true" data-offset-key="10496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10497"><span data-slate-leaf="true" data-offset-key="10497:0" data-first-offset="true"><span data-slate-string="true"> iocode);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10498"><span data-slate-object="text" data-key="10499"><span data-slate-leaf="true" data-offset-key="10499:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10500"><span data-slate-leaf="true" data-offset-key="10500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 刷新</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10501"><span data-slate-object="text" data-key="10502"><span data-slate-leaf="true" data-offset-key="10502:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10503"><span data-slate-leaf="true" data-offset-key="10503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10504"><span data-slate-leaf="true" data-offset-key="10504:0" data-first-offset="true"><span data-slate-string="true">   (*dgo_flush)(</span></span></span><span data-slate-object="text" data-key="10505"><span data-slate-leaf="true" data-offset-key="10505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10506"><span data-slate-leaf="true" data-offset-key="10506:0" data-first-offset="true"><span data-slate-string="true">* ghpdev);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10507"><span data-slate-object="text" data-key="10508"><span data-slate-leaf="true" data-offset-key="10508:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10509"><span data-slate-leaf="true" data-offset-key="10509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10510"><span data-slate-leaf="true" data-offset-key="10510:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_set_bank)(</span></span></span><span data-slate-object="text" data-key="10511"><span data-slate-leaf="true" data-offset-key="10511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10512"><span data-slate-leaf="true" data-offset-key="10512:0" data-first-offset="true"><span data-slate-string="true">* ghpdev, </span></span></span><span data-slate-object="text" data-key="10513"><span data-slate-leaf="true" data-offset-key="10513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10514"><span data-slate-leaf="true" data-offset-key="10514:0" data-first-offset="true"><span data-slate-string="true"> bnr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10515"><span data-slate-object="text" data-key="10516"><span data-slate-leaf="true" data-offset-key="10516:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10517"><span data-slate-leaf="true" data-offset-key="10517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读写像素</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10518"><span data-slate-object="text" data-key="10519"><span data-slate-leaf="true" data-offset-key="10519:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10520"><span data-slate-leaf="true" data-offset-key="10520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixl_t</span></span></span></span><span data-slate-object="text" data-key="10521"><span data-slate-leaf="true" data-offset-key="10521:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_readpix)(</span></span></span><span data-slate-object="text" data-key="10522"><span data-slate-leaf="true" data-offset-key="10522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10523"><span data-slate-leaf="true" data-offset-key="10523:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10524"><span data-slate-leaf="true" data-offset-key="10524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10525"><span data-slate-leaf="true" data-offset-key="10525:0" data-first-offset="true"><span data-slate-string="true"> x,</span></span></span><span data-slate-object="text" data-key="10526"><span data-slate-leaf="true" data-offset-key="10526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10527"><span data-slate-leaf="true" data-offset-key="10527:0" data-first-offset="true"><span data-slate-string="true"> y);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10528"><span data-slate-object="text" data-key="10529"><span data-slate-leaf="true" data-offset-key="10529:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10530"><span data-slate-leaf="true" data-offset-key="10530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10531"><span data-slate-leaf="true" data-offset-key="10531:0" data-first-offset="true"><span data-slate-string="true">   (*dgo_writepix)(</span></span></span><span data-slate-object="text" data-key="10532"><span data-slate-leaf="true" data-offset-key="10532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10533"><span data-slate-leaf="true" data-offset-key="10533:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10534"><span data-slate-leaf="true" data-offset-key="10534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixl_t</span></span></span></span><span data-slate-object="text" data-key="10535"><span data-slate-leaf="true" data-offset-key="10535:0" data-first-offset="true"><span data-slate-string="true"> pix,</span></span></span><span data-slate-object="text" data-key="10536"><span data-slate-leaf="true" data-offset-key="10536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10537"><span data-slate-leaf="true" data-offset-key="10537:0" data-first-offset="true"><span data-slate-string="true"> x,</span></span></span><span data-slate-object="text" data-key="10538"><span data-slate-leaf="true" data-offset-key="10538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10539"><span data-slate-leaf="true" data-offset-key="10539:0" data-first-offset="true"><span data-slate-string="true"> y);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10540"><span data-slate-object="text" data-key="10541"><span data-slate-leaf="true" data-offset-key="10541:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10542"><span data-slate-leaf="true" data-offset-key="10542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 直接读写像素 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10543"><span data-slate-object="text" data-key="10544"><span data-slate-leaf="true" data-offset-key="10544:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10545"><span data-slate-leaf="true" data-offset-key="10545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixl_t</span></span></span></span><span data-slate-object="text" data-key="10546"><span data-slate-leaf="true" data-offset-key="10546:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_dxreadpix)(</span></span></span><span data-slate-object="text" data-key="10547"><span data-slate-leaf="true" data-offset-key="10547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10548"><span data-slate-leaf="true" data-offset-key="10548:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10549"><span data-slate-leaf="true" data-offset-key="10549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10550"><span data-slate-leaf="true" data-offset-key="10550:0" data-first-offset="true"><span data-slate-string="true"> x,</span></span></span><span data-slate-object="text" data-key="10551"><span data-slate-leaf="true" data-offset-key="10551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10552"><span data-slate-leaf="true" data-offset-key="10552:0" data-first-offset="true"><span data-slate-string="true"> y);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10553"><span data-slate-object="text" data-key="10554"><span data-slate-leaf="true" data-offset-key="10554:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10555"><span data-slate-leaf="true" data-offset-key="10555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10556"><span data-slate-leaf="true" data-offset-key="10556:0" data-first-offset="true"><span data-slate-string="true">   (*dgo_dxwritepix)(</span></span></span><span data-slate-object="text" data-key="10557"><span data-slate-leaf="true" data-offset-key="10557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10558"><span data-slate-leaf="true" data-offset-key="10558:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10559"><span data-slate-leaf="true" data-offset-key="10559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pixl_t</span></span></span></span><span data-slate-object="text" data-key="10560"><span data-slate-leaf="true" data-offset-key="10560:0" data-first-offset="true"><span data-slate-string="true"> pix,</span></span></span><span data-slate-object="text" data-key="10561"><span data-slate-leaf="true" data-offset-key="10561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10562"><span data-slate-leaf="true" data-offset-key="10562:0" data-first-offset="true"><span data-slate-string="true"> x,</span></span></span><span data-slate-object="text" data-key="10563"><span data-slate-leaf="true" data-offset-key="10563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10564"><span data-slate-leaf="true" data-offset-key="10564:0" data-first-offset="true"><span data-slate-string="true"> y);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10565"><span data-slate-object="text" data-key="10566"><span data-slate-leaf="true" data-offset-key="10566:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10567"><span data-slate-leaf="true" data-offset-key="10567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 x，y 坐标和偏移</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10568"><span data-slate-object="text" data-key="10569"><span data-slate-leaf="true" data-offset-key="10569:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10570"><span data-slate-leaf="true" data-offset-key="10570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10571"><span data-slate-leaf="true" data-offset-key="10571:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_set_xy)(</span></span></span><span data-slate-object="text" data-key="10572"><span data-slate-leaf="true" data-offset-key="10572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10573"><span data-slate-leaf="true" data-offset-key="10573:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10574"><span data-slate-leaf="true" data-offset-key="10574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10575"><span data-slate-leaf="true" data-offset-key="10575:0" data-first-offset="true"><span data-slate-string="true"> x,</span></span></span><span data-slate-object="text" data-key="10576"><span data-slate-leaf="true" data-offset-key="10576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10577"><span data-slate-leaf="true" data-offset-key="10577:0" data-first-offset="true"><span data-slate-string="true"> y);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10578"><span data-slate-object="text" data-key="10579"><span data-slate-leaf="true" data-offset-key="10579:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10580"><span data-slate-leaf="true" data-offset-key="10580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10581"><span data-slate-leaf="true" data-offset-key="10581:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_set_vwh)(</span></span></span><span data-slate-object="text" data-key="10582"><span data-slate-leaf="true" data-offset-key="10582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10583"><span data-slate-leaf="true" data-offset-key="10583:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10584"><span data-slate-leaf="true" data-offset-key="10584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10585"><span data-slate-leaf="true" data-offset-key="10585:0" data-first-offset="true"><span data-slate-string="true"> vwt,</span></span></span><span data-slate-object="text" data-key="10586"><span data-slate-leaf="true" data-offset-key="10586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10587"><span data-slate-leaf="true" data-offset-key="10587:0" data-first-offset="true"><span data-slate-string="true"> vhi);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10588"><span data-slate-object="text" data-key="10589"><span data-slate-leaf="true" data-offset-key="10589:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10590"><span data-slate-leaf="true" data-offset-key="10590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10591"><span data-slate-leaf="true" data-offset-key="10591:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_set_xyoffset)(</span></span></span><span data-slate-object="text" data-key="10592"><span data-slate-leaf="true" data-offset-key="10592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10593"><span data-slate-leaf="true" data-offset-key="10593:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10594"><span data-slate-leaf="true" data-offset-key="10594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10595"><span data-slate-leaf="true" data-offset-key="10595:0" data-first-offset="true"><span data-slate-string="true"> xoff,</span></span></span><span data-slate-object="text" data-key="10596"><span data-slate-leaf="true" data-offset-key="10596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10597"><span data-slate-leaf="true" data-offset-key="10597:0" data-first-offset="true"><span data-slate-string="true"> yoff);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10598"><span data-slate-object="text" data-key="10599"><span data-slate-leaf="true" data-offset-key="10599:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10600"><span data-slate-leaf="true" data-offset-key="10600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 x，y 坐标和偏移</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10601"><span data-slate-object="text" data-key="10602"><span data-slate-leaf="true" data-offset-key="10602:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10603"><span data-slate-leaf="true" data-offset-key="10603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10604"><span data-slate-leaf="true" data-offset-key="10604:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_get_xy)(</span></span></span><span data-slate-object="text" data-key="10605"><span data-slate-leaf="true" data-offset-key="10605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10606"><span data-slate-leaf="true" data-offset-key="10606:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10607"><span data-slate-leaf="true" data-offset-key="10607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10608"><span data-slate-leaf="true" data-offset-key="10608:0" data-first-offset="true"><span data-slate-string="true">* rx,</span></span></span><span data-slate-object="text" data-key="10609"><span data-slate-leaf="true" data-offset-key="10609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10610"><span data-slate-leaf="true" data-offset-key="10610:0" data-first-offset="true"><span data-slate-string="true">* ry);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10611"><span data-slate-object="text" data-key="10612"><span data-slate-leaf="true" data-offset-key="10612:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10613"><span data-slate-leaf="true" data-offset-key="10613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10614"><span data-slate-leaf="true" data-offset-key="10614:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_get_vwh)(</span></span></span><span data-slate-object="text" data-key="10615"><span data-slate-leaf="true" data-offset-key="10615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10616"><span data-slate-leaf="true" data-offset-key="10616:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10617"><span data-slate-leaf="true" data-offset-key="10617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10618"><span data-slate-leaf="true" data-offset-key="10618:0" data-first-offset="true"><span data-slate-string="true">* rvwt,</span></span></span><span data-slate-object="text" data-key="10619"><span data-slate-leaf="true" data-offset-key="10619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10620"><span data-slate-leaf="true" data-offset-key="10620:0" data-first-offset="true"><span data-slate-string="true">* rvhi);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10621"><span data-slate-object="text" data-key="10622"><span data-slate-leaf="true" data-offset-key="10622:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10623"><span data-slate-leaf="true" data-offset-key="10623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="10624"><span data-slate-leaf="true" data-offset-key="10624:0" data-first-offset="true"><span data-slate-string="true"> (*dgo_get_xyoffset)(</span></span></span><span data-slate-object="text" data-key="10625"><span data-slate-leaf="true" data-offset-key="10625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10626"><span data-slate-leaf="true" data-offset-key="10626:0" data-first-offset="true"><span data-slate-string="true">* ghpdev,</span></span></span><span data-slate-object="text" data-key="10627"><span data-slate-leaf="true" data-offset-key="10627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10628"><span data-slate-leaf="true" data-offset-key="10628:0" data-first-offset="true"><span data-slate-string="true">* rxoff,</span></span></span><span data-slate-object="text" data-key="10629"><span data-slate-leaf="true" data-offset-key="10629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="10630"><span data-slate-leaf="true" data-offset-key="10630:0" data-first-offset="true"><span data-slate-string="true">* ryoff);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10631"><span data-slate-object="text" data-key="10632"><span data-slate-leaf="true" data-offset-key="10632:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="10633"><span data-slate-leaf="true" data-offset-key="10633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dftghops_t</span></span></span></span><span data-slate-object="text" data-key="10634"><span data-slate-leaf="true" data-offset-key="10634:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10635"><span data-slate-object="text" data-key="10636"><span data-slate-leaf="true" data-offset-key="10636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 刷新显存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10637"><span data-slate-object="text" data-key="10638"><span data-slate-leaf="true" data-offset-key="10638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="10639"><span data-slate-leaf="true" data-offset-key="10639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10640"><span data-slate-leaf="true" data-offset-key="10640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flush_videoram</span></span></span></span></span><span data-slate-object="text" data-key="10641"><span data-slate-leaf="true" data-offset-key="10641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="10642"><span data-slate-leaf="true" data-offset-key="10642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dftgraph_t</span></span></span></span></span></span><span data-slate-object="text" data-key="10643"><span data-slate-leaf="true" data-offset-key="10643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *kghp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10644"><span data-slate-object="text" data-key="10645"><span data-slate-leaf="true" data-offset-key="10645:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10646"><span data-slate-object="text" data-key="10647"><span data-slate-leaf="true" data-offset-key="10647:0" data-first-offset="true"><span data-slate-string="true">    kghp-&gt;gh_opfun.</span></span></span><span data-slate-object="text" data-key="10648"><span data-slate-leaf="true" data-offset-key="10648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dgo_flush</span></span></span></span><span data-slate-object="text" data-key="10649"><span data-slate-leaf="true" data-offset-key="10649:0" data-first-offset="true"><span data-slate-string="true">(kghp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10650"><span data-slate-object="text" data-key="10651"><span data-slate-leaf="true" data-offset-key="10651:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10652"><span data-slate-leaf="true" data-offset-key="10652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10653"><span data-slate-leaf="true" data-offset-key="10653:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10654"><span data-slate-object="text" data-key="10655"><span data-slate-leaf="true" data-offset-key="10655:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10656"><span data-slate-object="text" data-key="10657"><span data-slate-leaf="true" data-offset-key="10657:0" data-first-offset="true"><span data-slate-string="true">不难发现，我们正是把这些实际的图形驱动函数的地址填入了这个结构体中，然后通过这个结构体，我们就可以调用到相应的函数了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10658"><span data-slate-object="text" data-key="10659"><span data-slate-leaf="true" data-offset-key="10659:0" data-first-offset="true"><span data-slate-string="true">因为写这些函数都是体力活，我已经帮你搞定了，你直接使用就可以。上面的 flush_videoram 函数已经证明了这一想法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10660"><span data-slate-object="text" data-key="10661"><span data-slate-leaf="true" data-offset-key="10661:0" data-first-offset="true"><span data-slate-string="true">来，我们测试一下，看看结果，我们图形驱动程序初始化会显示背景图片 ——background.bmp，这是在打包映像文件时包含进去的，你自己可以随时替换，只要是满足 </span></span></span><span data-slate-object="text" data-key="10662"><span data-slate-leaf="true" data-offset-key="10662:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">1024*768，24 位的位图文件</span></span></span></span><span data-slate-object="text" data-key="10663"><span data-slate-leaf="true" data-offset-key="10663:0" data-first-offset="true"><span data-slate-string="true">就行了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10664"><span data-slate-object="text" data-key="10665"><span data-slate-leaf="true" data-offset-key="10665:0" data-first-offset="true"><span data-slate-string="true">下面我们要把这些函数调用起来：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="10666"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10667"><span data-slate-object="text" data-key="10668"><span data-slate-leaf="true" data-offset-key="10668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 halinit.c 文件中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10669"><span data-slate-object="text" data-key="10670"><span data-slate-leaf="true" data-offset-key="10670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10671"><span data-slate-leaf="true" data-offset-key="10671:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10672"><span data-slate-leaf="true" data-offset-key="10672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_hal</span></span></span></span><span data-slate-object="text" data-key="10673"><span data-slate-leaf="true" data-offset-key="10673:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10674"><span data-slate-leaf="true" data-offset-key="10674:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10675"><span data-slate-object="text" data-key="10676"><span data-slate-leaf="true" data-offset-key="10676:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10677"><span data-slate-object="text" data-key="10678"><span data-slate-leaf="true" data-offset-key="10678:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10679"><span data-slate-leaf="true" data-offset-key="10679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_halplaltform</span></span></span></span><span data-slate-object="text" data-key="10680"><span data-slate-leaf="true" data-offset-key="10680:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10681"><span data-slate-object="text" data-key="10682"><span data-slate-leaf="true" data-offset-key="10682:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10683"><span data-slate-leaf="true" data-offset-key="10683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10684"><span data-slate-leaf="true" data-offset-key="10684:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10685"><span data-slate-object="text" data-key="10686"><span data-slate-leaf="true" data-offset-key="10686:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10687"><span data-slate-object="text" data-key="10688"><span data-slate-leaf="true" data-offset-key="10688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 hal_start.c 文件中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10689"><span data-slate-object="text" data-key="10690"><span data-slate-leaf="true" data-offset-key="10690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10691"><span data-slate-leaf="true" data-offset-key="10691:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10692"><span data-slate-leaf="true" data-offset-key="10692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_start</span></span></span></span><span data-slate-object="text" data-key="10693"><span data-slate-leaf="true" data-offset-key="10693:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10694"><span data-slate-leaf="true" data-offset-key="10694:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10695"><span data-slate-object="text" data-key="10696"><span data-slate-leaf="true" data-offset-key="10696:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10697"><span data-slate-object="text" data-key="10698"><span data-slate-leaf="true" data-offset-key="10698:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10699"><span data-slate-leaf="true" data-offset-key="10699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_hal</span></span></span></span><span data-slate-object="text" data-key="10700"><span data-slate-leaf="true" data-offset-key="10700:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="10701"><span data-slate-leaf="true" data-offset-key="10701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 hal 层，其中会调用初始化平台函数，在那里会调用初始化图形驱动</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10702"><span data-slate-object="text" data-key="10703"><span data-slate-leaf="true" data-offset-key="10703:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10704"><span data-slate-leaf="true" data-offset-key="10704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10705"><span data-slate-leaf="true" data-offset-key="10705:0" data-first-offset="true"><span data-slate-string="true">(;;);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10706"><span data-slate-object="text" data-key="10707"><span data-slate-leaf="true" data-offset-key="10707:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10708"><span data-slate-leaf="true" data-offset-key="10708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10709"><span data-slate-leaf="true" data-offset-key="10709:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10710"><span data-slate-object="text" data-key="10711"><span data-slate-leaf="true" data-offset-key="10711:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10712"><span data-slate-object="text" data-key="10713"><span data-slate-leaf="true" data-offset-key="10713:0" data-first-offset="true"><span data-slate-string="true">接下来，让我们一起 make vboxtest，应该很有成就感。一幅风景图呈现在我们面前，上面有 Cosmos 的版本、编译时间、CPU 工作模式，内存大小等数据。这相当一个我们 Cosmos 的水印信息。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10714"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c0/83/c08ebf3fb25fddab6d4dbd24326aae83.jpg?wh=1044*921"></div><div>图形驱动测试</div></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10715" id="sr-toc-4"><span data-slate-object="text" data-key="10716"><span data-slate-leaf="true" data-offset-key="10716:0" data-first-offset="true"><span data-slate-string="true">初始化内存</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="10717"><span data-slate-object="text" data-key="10718"><span data-slate-leaf="true" data-offset-key="10718:0" data-first-offset="true"><span data-slate-string="true">首先，我们在 Cosmos/hal/x86/ 下建立一个 halmm.c 文件，用于初始化内存，为了后面的内存管理器作好准备。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10719"><span data-slate-object="text" data-key="10720"><span data-slate-leaf="true" data-offset-key="10720:0" data-first-offset="true"><span data-slate-string="true">hal 层的内存初始化比较容易，只要向内存管理器提供内存空间布局信息就可以。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10721"><span data-slate-object="text" data-key="10722"><span data-slate-leaf="true" data-offset-key="10722:0" data-first-offset="true"><span data-slate-string="true">你可能在想，不对啊，明明我们在二级引导器中已经获取了内存布局信息，是的，</span></span></span><span data-slate-object="text" data-key="10723"><span data-slate-leaf="true" data-offset-key="10723:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">但 Cosmos 的内存管理器需要保存更多的信息，最好是顺序的内存布局信息，这样可以增加额外的功能属性，同时降低代码的复杂度。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10724"><span data-slate-object="text" data-key="10725"><span data-slate-leaf="true" data-offset-key="10725:0" data-first-offset="true"><span data-slate-string="true">不难发现，BIOS 提供的结构无法满足前面这些要求。不过我们也有办法解决，只要以 BIOS 提供的结构为基础，设计一套新的数据结构就搞定了。这个结构可以这样设计。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10726"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10727"><span data-slate-object="text" data-key="10728"><span data-slate-leaf="true" data-offset-key="10728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10729"><span data-slate-leaf="true" data-offset-key="10729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10730"><span data-slate-leaf="true" data-offset-key="10730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_T_OSAPUSERRAM 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10731"><span data-slate-object="text" data-key="10732"><span data-slate-leaf="true" data-offset-key="10732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10733"><span data-slate-leaf="true" data-offset-key="10733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10734"><span data-slate-leaf="true" data-offset-key="10734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_T_RESERVRAM 2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10735"><span data-slate-object="text" data-key="10736"><span data-slate-leaf="true" data-offset-key="10736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10737"><span data-slate-leaf="true" data-offset-key="10737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10738"><span data-slate-leaf="true" data-offset-key="10738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_T_HWUSERRAM 8</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10739"><span data-slate-object="text" data-key="10740"><span data-slate-leaf="true" data-offset-key="10740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10741"><span data-slate-leaf="true" data-offset-key="10741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10742"><span data-slate-leaf="true" data-offset-key="10742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_T_ARACONRAM 0xf</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10743"><span data-slate-object="text" data-key="10744"><span data-slate-leaf="true" data-offset-key="10744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10745"><span data-slate-leaf="true" data-offset-key="10745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10746"><span data-slate-leaf="true" data-offset-key="10746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_T_BUGRAM 0xff</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10747"><span data-slate-object="text" data-key="10748"><span data-slate-leaf="true" data-offset-key="10748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10749"><span data-slate-leaf="true" data-offset-key="10749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10750"><span data-slate-leaf="true" data-offset-key="10750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_F_X86_32 (1&lt;&lt;0)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10751"><span data-slate-object="text" data-key="10752"><span data-slate-leaf="true" data-offset-key="10752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10753"><span data-slate-leaf="true" data-offset-key="10753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10754"><span data-slate-leaf="true" data-offset-key="10754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_F_X86_64 (1&lt;&lt;1)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10755"><span data-slate-object="text" data-key="10756"><span data-slate-leaf="true" data-offset-key="10756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10757"><span data-slate-leaf="true" data-offset-key="10757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10758"><span data-slate-leaf="true" data-offset-key="10758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_F_ARM_32 (1&lt;&lt;2)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10759"><span data-slate-object="text" data-key="10760"><span data-slate-leaf="true" data-offset-key="10760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10761"><span data-slate-leaf="true" data-offset-key="10761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10762"><span data-slate-leaf="true" data-offset-key="10762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_F_ARM_64 (1&lt;&lt;3)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10763"><span data-slate-object="text" data-key="10764"><span data-slate-leaf="true" data-offset-key="10764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="10765"><span data-slate-leaf="true" data-offset-key="10765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="10766"><span data-slate-leaf="true" data-offset-key="10766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> PMR_F_HAL_MASK 0xff</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10767"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10768"><span data-slate-object="text" data-key="10769"><span data-slate-leaf="true" data-offset-key="10769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="10770"><span data-slate-leaf="true" data-offset-key="10770:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10771"><span data-slate-leaf="true" data-offset-key="10771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="10772"><span data-slate-leaf="true" data-offset-key="10772:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10773"><span data-slate-leaf="true" data-offset-key="10773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_PHYMMARGE</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10774"><span data-slate-object="text" data-key="10775"><span data-slate-leaf="true" data-offset-key="10775:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10776"><span data-slate-object="text" data-key="10777"><span data-slate-leaf="true" data-offset-key="10777:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10778"><span data-slate-leaf="true" data-offset-key="10778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="10779"><span data-slate-leaf="true" data-offset-key="10779:0" data-first-offset="true"><span data-slate-string="true"> pmr_lock;</span></span></span><span data-slate-object="text" data-key="10780"><span data-slate-leaf="true" data-offset-key="10780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保护这个结构是自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10781"><span data-slate-object="text" data-key="10782"><span data-slate-leaf="true" data-offset-key="10782:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10783"><span data-slate-leaf="true" data-offset-key="10783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="10784"><span data-slate-leaf="true" data-offset-key="10784:0" data-first-offset="true"><span data-slate-string="true"> pmr_type;     </span></span></span><span data-slate-object="text" data-key="10785"><span data-slate-leaf="true" data-offset-key="10785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存地址空间类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10786"><span data-slate-object="text" data-key="10787"><span data-slate-leaf="true" data-offset-key="10787:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10788"><span data-slate-leaf="true" data-offset-key="10788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="10789"><span data-slate-leaf="true" data-offset-key="10789:0" data-first-offset="true"><span data-slate-string="true"> pmr_stype;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10790"><span data-slate-object="text" data-key="10791"><span data-slate-leaf="true" data-offset-key="10791:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10792"><span data-slate-leaf="true" data-offset-key="10792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="10793"><span data-slate-leaf="true" data-offset-key="10793:0" data-first-offset="true"><span data-slate-string="true"> pmr_dtype;    </span></span></span><span data-slate-object="text" data-key="10794"><span data-slate-leaf="true" data-offset-key="10794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存地址空间的子类型，见上面的宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10795"><span data-slate-object="text" data-key="10796"><span data-slate-leaf="true" data-offset-key="10796:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10797"><span data-slate-leaf="true" data-offset-key="10797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="10798"><span data-slate-leaf="true" data-offset-key="10798:0" data-first-offset="true"><span data-slate-string="true"> pmr_flgs;     </span></span></span><span data-slate-object="text" data-key="10799"><span data-slate-leaf="true" data-offset-key="10799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 结构的标志与状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10800"><span data-slate-object="text" data-key="10801"><span data-slate-leaf="true" data-offset-key="10801:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10802"><span data-slate-leaf="true" data-offset-key="10802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="10803"><span data-slate-leaf="true" data-offset-key="10803:0" data-first-offset="true"><span data-slate-string="true"> pmr_stus;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10804"><span data-slate-object="text" data-key="10805"><span data-slate-leaf="true" data-offset-key="10805:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10806"><span data-slate-leaf="true" data-offset-key="10806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10807"><span data-slate-leaf="true" data-offset-key="10807:0" data-first-offset="true"><span data-slate-string="true"> pmr_saddr;    </span></span></span><span data-slate-object="text" data-key="10808"><span data-slate-leaf="true" data-offset-key="10808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存空间的开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10809"><span data-slate-object="text" data-key="10810"><span data-slate-leaf="true" data-offset-key="10810:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10811"><span data-slate-leaf="true" data-offset-key="10811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10812"><span data-slate-leaf="true" data-offset-key="10812:0" data-first-offset="true"><span data-slate-string="true"> pmr_lsize;    </span></span></span><span data-slate-object="text" data-key="10813"><span data-slate-leaf="true" data-offset-key="10813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存空间的大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10814"><span data-slate-object="text" data-key="10815"><span data-slate-leaf="true" data-offset-key="10815:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10816"><span data-slate-leaf="true" data-offset-key="10816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10817"><span data-slate-leaf="true" data-offset-key="10817:0" data-first-offset="true"><span data-slate-string="true"> pmr_end;      </span></span></span><span data-slate-object="text" data-key="10818"><span data-slate-leaf="true" data-offset-key="10818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存空间的结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10819"><span data-slate-object="text" data-key="10820"><span data-slate-leaf="true" data-offset-key="10820:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10821"><span data-slate-leaf="true" data-offset-key="10821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10822"><span data-slate-leaf="true" data-offset-key="10822:0" data-first-offset="true"><span data-slate-string="true"> pmr_rrvmsaddr;</span></span></span><span data-slate-object="text" data-key="10823"><span data-slate-leaf="true" data-offset-key="10823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存保留空间的开始地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10824"><span data-slate-object="text" data-key="10825"><span data-slate-leaf="true" data-offset-key="10825:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10826"><span data-slate-leaf="true" data-offset-key="10826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10827"><span data-slate-leaf="true" data-offset-key="10827:0" data-first-offset="true"><span data-slate-string="true"> pmr_rrvmend;  </span></span></span><span data-slate-object="text" data-key="10828"><span data-slate-leaf="true" data-offset-key="10828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存保留空间的结束地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10829"><span data-slate-object="text" data-key="10830"><span data-slate-leaf="true" data-offset-key="10830:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10831"><span data-slate-leaf="true" data-offset-key="10831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10832"><span data-slate-leaf="true" data-offset-key="10832:0" data-first-offset="true"><span data-slate-string="true">* pmr_prip;     </span></span></span><span data-slate-object="text" data-key="10833"><span data-slate-leaf="true" data-offset-key="10833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 结构的私有数据指针，以后扩展所用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10834"><span data-slate-object="text" data-key="10835"><span data-slate-leaf="true" data-offset-key="10835:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10836"><span data-slate-leaf="true" data-offset-key="10836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10837"><span data-slate-leaf="true" data-offset-key="10837:0" data-first-offset="true"><span data-slate-string="true">* pmr_extp;     </span></span></span><span data-slate-object="text" data-key="10838"><span data-slate-leaf="true" data-offset-key="10838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 结构的扩展数据指针，以后扩展所用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10839"><span data-slate-object="text" data-key="10840"><span data-slate-leaf="true" data-offset-key="10840:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="10841"><span data-slate-leaf="true" data-offset-key="10841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">phymmarge_t</span></span></span></span><span data-slate-object="text" data-key="10842"><span data-slate-leaf="true" data-offset-key="10842:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10843"><span data-slate-object="text" data-key="10844"><span data-slate-leaf="true" data-offset-key="10844:0" data-first-offset="true"><span data-slate-string="true">有些情况下内核要另起炉灶，不想把所有的内存空间都交给内存管理器去管理，所以要保留一部分内存空间，这就是上面结构中那两个 pmr_rrvmsaddr、pmr_rrvmend 字段的作用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10845"><span data-slate-object="text" data-key="10846"><span data-slate-leaf="true" data-offset-key="10846:0" data-first-offset="true"><span data-slate-string="true">有了数据结构，我们还要写代码来操作它：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10847"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10848"><span data-slate-object="text" data-key="10849"><span data-slate-leaf="true" data-offset-key="10849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span></span><span data-slate-object="text" data-key="10850"><span data-slate-leaf="true" data-offset-key="10850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10851"><span data-slate-leaf="true" data-offset-key="10851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">initpmrge_core</span></span></span></span></span><span data-slate-object="text" data-key="10852"><span data-slate-leaf="true" data-offset-key="10852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="10853"><span data-slate-leaf="true" data-offset-key="10853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span></span></span><span data-slate-object="text" data-key="10854"><span data-slate-leaf="true" data-offset-key="10854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *e8sp, </span></span></span></span></span><span data-slate-object="text" data-key="10855"><span data-slate-leaf="true" data-offset-key="10855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span></span></span><span data-slate-object="text" data-key="10856"><span data-slate-leaf="true" data-offset-key="10856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> e8nr, </span></span></span></span></span><span data-slate-object="text" data-key="10857"><span data-slate-leaf="true" data-offset-key="10857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">phymmarge_t</span></span></span></span></span></span><span data-slate-object="text" data-key="10858"><span data-slate-leaf="true" data-offset-key="10858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *pmargesp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10859"><span data-slate-object="text" data-key="10860"><span data-slate-leaf="true" data-offset-key="10860:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10861"><span data-slate-object="text" data-key="10862"><span data-slate-leaf="true" data-offset-key="10862:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10863"><span data-slate-leaf="true" data-offset-key="10863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10864"><span data-slate-leaf="true" data-offset-key="10864:0" data-first-offset="true"><span data-slate-string="true"> retnr = </span></span></span><span data-slate-object="text" data-key="10865"><span data-slate-leaf="true" data-offset-key="10865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10866"><span data-slate-leaf="true" data-offset-key="10866:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10867"><span data-slate-object="text" data-key="10868"><span data-slate-leaf="true" data-offset-key="10868:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10869"><span data-slate-leaf="true" data-offset-key="10869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10870"><span data-slate-leaf="true" data-offset-key="10870:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="10871"><span data-slate-leaf="true" data-offset-key="10871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10872"><span data-slate-leaf="true" data-offset-key="10872:0" data-first-offset="true"><span data-slate-string="true"> i = </span></span></span><span data-slate-object="text" data-key="10873"><span data-slate-leaf="true" data-offset-key="10873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10874"><span data-slate-leaf="true" data-offset-key="10874:0" data-first-offset="true"><span data-slate-string="true">; i &lt;e8nr; i++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10875"><span data-slate-object="text" data-key="10876"><span data-slate-leaf="true" data-offset-key="10876:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10877"><span data-slate-object="text" data-key="10878"><span data-slate-leaf="true" data-offset-key="10878:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10879"><span data-slate-leaf="true" data-offset-key="10879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据一个 e820map_t 结构建立一个 phymmarge_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10880"><span data-slate-object="text" data-key="10881"><span data-slate-leaf="true" data-offset-key="10881:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10882"><span data-slate-leaf="true" data-offset-key="10882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10883"><span data-slate-leaf="true" data-offset-key="10883:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="10884"><span data-slate-leaf="true" data-offset-key="10884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_one_pmrge</span></span></span></span><span data-slate-object="text" data-key="10885"><span data-slate-leaf="true" data-offset-key="10885:0" data-first-offset="true"><span data-slate-string="true">(&amp;e8sp[i], &amp;pmargesp[i]) == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10886"><span data-slate-object="text" data-key="10887"><span data-slate-leaf="true" data-offset-key="10887:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10888"><span data-slate-object="text" data-key="10889"><span data-slate-leaf="true" data-offset-key="10889:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10890"><span data-slate-leaf="true" data-offset-key="10890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10891"><span data-slate-leaf="true" data-offset-key="10891:0" data-first-offset="true"><span data-slate-string="true"> retnr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10892"><span data-slate-object="text" data-key="10893"><span data-slate-leaf="true" data-offset-key="10893:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10894"><span data-slate-object="text" data-key="10895"><span data-slate-leaf="true" data-offset-key="10895:0" data-first-offset="true"><span data-slate-string="true">        retnr++;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10896"><span data-slate-object="text" data-key="10897"><span data-slate-leaf="true" data-offset-key="10897:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10898"><span data-slate-object="text" data-key="10899"><span data-slate-leaf="true" data-offset-key="10899:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10900"><span data-slate-leaf="true" data-offset-key="10900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10901"><span data-slate-leaf="true" data-offset-key="10901:0" data-first-offset="true"><span data-slate-string="true"> retnr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10902"><span data-slate-object="text" data-key="10903"><span data-slate-leaf="true" data-offset-key="10903:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10904"><span data-slate-object="text" data-key="10905"><span data-slate-leaf="true" data-offset-key="10905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="10906"><span data-slate-leaf="true" data-offset-key="10906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10907"><span data-slate-leaf="true" data-offset-key="10907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_phymmarge</span></span></span></span></span><span data-slate-object="text" data-key="10908"><span data-slate-leaf="true" data-offset-key="10908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10909"><span data-slate-object="text" data-key="10910"><span data-slate-leaf="true" data-offset-key="10910:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10911"><span data-slate-object="text" data-key="10912"><span data-slate-leaf="true" data-offset-key="10912:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10913"><span data-slate-leaf="true" data-offset-key="10913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">machbstart_t</span></span></span></span><span data-slate-object="text" data-key="10914"><span data-slate-leaf="true" data-offset-key="10914:0" data-first-offset="true"><span data-slate-string="true"> *mbsp = &amp;kmachbsp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10915"><span data-slate-object="text" data-key="10916"><span data-slate-leaf="true" data-offset-key="10916:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10917"><span data-slate-leaf="true" data-offset-key="10917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">phymmarge_t</span></span></span></span><span data-slate-object="text" data-key="10918"><span data-slate-leaf="true" data-offset-key="10918:0" data-first-offset="true"><span data-slate-string="true"> *pmarge_adr = </span></span></span><span data-slate-object="text" data-key="10919"><span data-slate-leaf="true" data-offset-key="10919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="10920"><span data-slate-leaf="true" data-offset-key="10920:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10921"><span data-slate-object="text" data-key="10922"><span data-slate-leaf="true" data-offset-key="10922:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10923"><span data-slate-leaf="true" data-offset-key="10923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10924"><span data-slate-leaf="true" data-offset-key="10924:0" data-first-offset="true"><span data-slate-string="true"> pmrgesz = </span></span></span><span data-slate-object="text" data-key="10925"><span data-slate-leaf="true" data-offset-key="10925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10926"><span data-slate-leaf="true" data-offset-key="10926:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10927"><span data-slate-object="text" data-key="10928"><span data-slate-leaf="true" data-offset-key="10928:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10929"><span data-slate-leaf="true" data-offset-key="10929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据 machbstart_t 机器信息结构计算获得 phymmarge_t 结构的开始地址和大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10930"><span data-slate-object="text" data-key="10931"><span data-slate-leaf="true" data-offset-key="10931:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10932"><span data-slate-leaf="true" data-offset-key="10932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ret_phymmarge_adrandsz</span></span></span></span><span data-slate-object="text" data-key="10933"><span data-slate-leaf="true" data-offset-key="10933:0" data-first-offset="true"><span data-slate-string="true">(mbsp, &amp;pmarge_adr, &amp;pmrgesz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10934"><span data-slate-object="text" data-key="10935"><span data-slate-leaf="true" data-offset-key="10935:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10936"><span data-slate-leaf="true" data-offset-key="10936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10937"><span data-slate-leaf="true" data-offset-key="10937:0" data-first-offset="true"><span data-slate-string="true"> tmppmrphyadr = mbsp-&gt;mb_nextwtpadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10938"><span data-slate-object="text" data-key="10939"><span data-slate-leaf="true" data-offset-key="10939:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10940"><span data-slate-leaf="true" data-offset-key="10940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span><span data-slate-object="text" data-key="10941"><span data-slate-leaf="true" data-offset-key="10941:0" data-first-offset="true"><span data-slate-string="true"> *e8p = (</span></span></span><span data-slate-object="text" data-key="10942"><span data-slate-leaf="true" data-offset-key="10942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">e820map_t</span></span></span></span><span data-slate-object="text" data-key="10943"><span data-slate-leaf="true" data-offset-key="10943:0" data-first-offset="true"><span data-slate-string="true"> *)((</span></span></span><span data-slate-object="text" data-key="10944"><span data-slate-leaf="true" data-offset-key="10944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="10945"><span data-slate-leaf="true" data-offset-key="10945:0" data-first-offset="true"><span data-slate-string="true">)(mbsp-&gt;mb_e820padr));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10946"><span data-slate-object="text" data-key="10947"><span data-slate-leaf="true" data-offset-key="10947:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10948"><span data-slate-leaf="true" data-offset-key="10948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 phymmarge_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10949"><span data-slate-object="text" data-key="10950"><span data-slate-leaf="true" data-offset-key="10950:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10951"><span data-slate-leaf="true" data-offset-key="10951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="10952"><span data-slate-leaf="true" data-offset-key="10952:0" data-first-offset="true"><span data-slate-string="true"> ipmgnr = </span></span></span><span data-slate-object="text" data-key="10953"><span data-slate-leaf="true" data-offset-key="10953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">initpmrge_core</span></span></span></span><span data-slate-object="text" data-key="10954"><span data-slate-leaf="true" data-offset-key="10954:0" data-first-offset="true"><span data-slate-string="true">(e8p, mbsp-&gt;mb_e820nr, pmarge_adr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10955"><span data-slate-object="text" data-key="10956"><span data-slate-leaf="true" data-offset-key="10956:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10957"><span data-slate-leaf="true" data-offset-key="10957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 phymmarge_t 结构的地址大小个数保存 machbstart_t 机器信息结构中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10958"><span data-slate-object="text" data-key="10959"><span data-slate-leaf="true" data-offset-key="10959:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_e820expadr = tmppmrphyadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10960"><span data-slate-object="text" data-key="10961"><span data-slate-leaf="true" data-offset-key="10961:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_e820exnr = ipmgnr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10962"><span data-slate-object="text" data-key="10963"><span data-slate-leaf="true" data-offset-key="10963:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_e820exsz = ipmgnr * </span></span></span><span data-slate-object="text" data-key="10964"><span data-slate-leaf="true" data-offset-key="10964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="10965"><span data-slate-leaf="true" data-offset-key="10965:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10966"><span data-slate-leaf="true" data-offset-key="10966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">phymmarge_t</span></span></span></span><span data-slate-object="text" data-key="10967"><span data-slate-leaf="true" data-offset-key="10967:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10968"><span data-slate-object="text" data-key="10969"><span data-slate-leaf="true" data-offset-key="10969:0" data-first-offset="true"><span data-slate-string="true">    mbsp-&gt;mb_nextwtpadr = </span></span></span><span data-slate-object="text" data-key="10970"><span data-slate-leaf="true" data-offset-key="10970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">PAGE_ALIGN</span></span></span></span><span data-slate-object="text" data-key="10971"><span data-slate-leaf="true" data-offset-key="10971:0" data-first-offset="true"><span data-slate-string="true">(mbsp-&gt;mb_e820expadr + mbsp-&gt;mb_e820exsz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10972"><span data-slate-object="text" data-key="10973"><span data-slate-leaf="true" data-offset-key="10973:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10974"><span data-slate-leaf="true" data-offset-key="10974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//phymmarge_t 结构中地址空间从低到高进行排序，我已经帮你写好了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10975"><span data-slate-object="text" data-key="10976"><span data-slate-leaf="true" data-offset-key="10976:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10977"><span data-slate-leaf="true" data-offset-key="10977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">phymmarge_sort</span></span></span></span><span data-slate-object="text" data-key="10978"><span data-slate-leaf="true" data-offset-key="10978:0" data-first-offset="true"><span data-slate-string="true">(pmarge_adr, ipmgnr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10979"><span data-slate-object="text" data-key="10980"><span data-slate-leaf="true" data-offset-key="10980:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10981"><span data-slate-leaf="true" data-offset-key="10981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10982"><span data-slate-leaf="true" data-offset-key="10982:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10983"><span data-slate-object="text" data-key="10984"><span data-slate-leaf="true" data-offset-key="10984:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10985"><span data-slate-object="text" data-key="10986"><span data-slate-leaf="true" data-offset-key="10986:0" data-first-offset="true"><span data-slate-string="true">结合上面的代码，你会发现这是根据 e820map_t 结构数组，建立了一个 phymmarge_t 结构数组，init_one_pmrge 函数正是把 e820map_t 结构中的信息复制到 phymmarge_t 结构中来。理解了这个原理，即使不看我的，你自己也会写。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10987"><span data-slate-object="text" data-key="10988"><span data-slate-leaf="true" data-offset-key="10988:0" data-first-offset="true"><span data-slate-string="true">下面我们把这些函数，用一个总管函数调动起来，这个总管函数叫什么名字好呢？当然是 init_halmm，如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="10989"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10990"><span data-slate-object="text" data-key="10991"><span data-slate-leaf="true" data-offset-key="10991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="10992"><span data-slate-leaf="true" data-offset-key="10992:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10993"><span data-slate-leaf="true" data-offset-key="10993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_halmm</span></span></span></span><span data-slate-object="text" data-key="10994"><span data-slate-leaf="true" data-offset-key="10994:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10995"><span data-slate-leaf="true" data-offset-key="10995:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10996"><span data-slate-object="text" data-key="10997"><span data-slate-leaf="true" data-offset-key="10997:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10998"><span data-slate-object="text" data-key="10999"><span data-slate-leaf="true" data-offset-key="10999:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11000"><span data-slate-leaf="true" data-offset-key="11000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_phymmarge</span></span></span></span><span data-slate-object="text" data-key="11001"><span data-slate-leaf="true" data-offset-key="11001:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11002"><span data-slate-object="text" data-key="11003"><span data-slate-leaf="true" data-offset-key="11003:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11004"><span data-slate-leaf="true" data-offset-key="11004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//init_memmgr();</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11005"><span data-slate-object="text" data-key="11006"><span data-slate-leaf="true" data-offset-key="11006:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11007"><span data-slate-leaf="true" data-offset-key="11007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11008"><span data-slate-leaf="true" data-offset-key="11008:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11009"><span data-slate-object="text" data-key="11010"><span data-slate-leaf="true" data-offset-key="11010:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11011"><span data-slate-object="text" data-key="11012"><span data-slate-leaf="true" data-offset-key="11012:0" data-first-offset="true"><span data-slate-string="true">这里 init_halmm 函数中还调用了 init_memmgr 函数，这个正是这我们内存管理器初始化函数，我会在内存管理的那节课展开讲。而 init_halmm 函数将要被 init_hal 函数调用。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="11013" id="sr-toc-5"><span data-slate-object="text" data-key="11014"><span data-slate-leaf="true" data-offset-key="11014:0" data-first-offset="true"><span data-slate-string="true">初始化中断</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="11015"><span data-slate-object="text" data-key="11016"><span data-slate-leaf="true" data-offset-key="11016:0" data-first-offset="true"><span data-slate-string="true">什么是中断呢？为了帮你快速理解，我们先来看两种情景：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11017"><div data-slate-type="list-line" data-slate-object="block" data-key="11018"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="11019"><span data-slate-leaf="true" data-offset-key="11019:0" data-first-offset="true"><span data-slate-string="true">你在开车时，突然汽车引擎坏了，你需要修复它才能继续驾驶汽车……</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11020"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="11021"><span data-slate-leaf="true" data-offset-key="11021:0" data-first-offset="true"><span data-slate-string="true">你在外旅游，你女朋友突然来电话了，你可以选择接电话或者不接电话，当然不接电话的后果很严重（笑）……</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11022"><span data-slate-object="text" data-key="11023"><span data-slate-leaf="true" data-offset-key="11023:0" data-first-offset="true"><span data-slate-string="true">在以上两种情景中，虽然不十分恰当，但都是在做一件事时，因为一些原因而要切换到另一件事上。其实计算机中的 CPU 也是一样，在做一件事时，因为一些原因要转而做另一件事，于是中断产生了……</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11024"><span data-slate-object="text" data-key="11025"><span data-slate-leaf="true" data-offset-key="11025:0" data-first-offset="true"><span data-slate-string="true">根据原因的类型不同，中断被分为两类。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11026"><span data-slate-object="text" data-key="11027"><span data-slate-leaf="true" data-offset-key="11027:0" data-first-offset="true"><span data-slate-string="true">异常，这是同步的，原因是错误和故障，就像汽车引擎坏了。不修复错误就不能继续运行，所以这时，CPU 会跳到这种错误的处理代码那里开始运行，运行完了会返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11028"><span data-slate-object="text" data-key="11029"><span data-slate-leaf="true" data-offset-key="11029:0" data-first-offset="true"><span data-slate-string="true">为啥说它是同步的呢？这是因为如果不修改程序中的错误，下次运行程序到这里同样会发生异常。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11030"><span data-slate-object="text" data-key="11031"><span data-slate-leaf="true" data-offset-key="11031:0" data-first-offset="true"><span data-slate-string="true">中断，这是异步的，我们通常说的中断就是这种类型，它是因为外部事件而产生的，就好像旅游时女朋友来电话了。通常设备需要 CPU 关注时，会给 CPU 发送一个中断信号，所以这时 CPU 会跳到处理这种事件的代码那里开始运行，运行完了会返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11032"><span data-slate-object="text" data-key="11033"><span data-slate-leaf="true" data-offset-key="11033:0" data-first-offset="true"><span data-slate-string="true">由于不确定何种设备何时发出这种中断信号，所以它是异步的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11034"><span data-slate-object="text" data-key="11035"><span data-slate-leaf="true" data-offset-key="11035:0" data-first-offset="true"><span data-slate-string="true">在 x86 CPU 上，最多支持 256 个中断，还记得前面所说的中断表和中断门描述符吗，这意味着我们要准备 256 个中断门描述符和 256 个中断处理程序的入口。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11036"><span data-slate-object="text" data-key="11037"><span data-slate-leaf="true" data-offset-key="11037:0" data-first-offset="true"><span data-slate-string="true">下面我们来定义它，如下所示：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11038"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11039"><span data-slate-object="text" data-key="11040"><span data-slate-leaf="true" data-offset-key="11040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11041"><span data-slate-leaf="true" data-offset-key="11041:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11042"><span data-slate-leaf="true" data-offset-key="11042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11043"><span data-slate-leaf="true" data-offset-key="11043:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11044"><span data-slate-leaf="true" data-offset-key="11044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_GATE</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11045"><span data-slate-object="text" data-key="11046"><span data-slate-leaf="true" data-offset-key="11046:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11047"><span data-slate-object="text" data-key="11048"><span data-slate-leaf="true" data-offset-key="11048:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11049"><span data-slate-leaf="true" data-offset-key="11049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11050"><span data-slate-leaf="true" data-offset-key="11050:0" data-first-offset="true"><span data-slate-string="true">   offset_low;     </span></span></span><span data-slate-object="text" data-key="11051"><span data-slate-leaf="true" data-offset-key="11051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 偏移 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11052"><span data-slate-object="text" data-key="11053"><span data-slate-leaf="true" data-offset-key="11053:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11054"><span data-slate-leaf="true" data-offset-key="11054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11055"><span data-slate-leaf="true" data-offset-key="11055:0" data-first-offset="true"><span data-slate-string="true">   selector;       </span></span></span><span data-slate-object="text" data-key="11056"><span data-slate-leaf="true" data-offset-key="11056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 段选择子 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11057"><span data-slate-object="text" data-key="11058"><span data-slate-leaf="true" data-offset-key="11058:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11059"><span data-slate-leaf="true" data-offset-key="11059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="11060"><span data-slate-leaf="true" data-offset-key="11060:0" data-first-offset="true"><span data-slate-string="true">    dcount;         </span></span></span><span data-slate-object="text" data-key="11061"><span data-slate-leaf="true" data-offset-key="11061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 该字段只在调用门描述符中有效。如果在利用调用门调用子程序时引起特权级的转换和堆栈的改变，需要将外层堆栈中的参数复制到内层堆栈。该双字计数字段就是用于说明这种情况发生时，要复制的双字参数的数量。*/</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11062"><span data-slate-object="text" data-key="11063"><span data-slate-leaf="true" data-offset-key="11063:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11064"><span data-slate-leaf="true" data-offset-key="11064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="11065"><span data-slate-leaf="true" data-offset-key="11065:0" data-first-offset="true"><span data-slate-string="true">    attr;           </span></span></span><span data-slate-object="text" data-key="11066"><span data-slate-leaf="true" data-offset-key="11066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* P(1) DPL(2) DT(1) TYPE(4) */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11067"><span data-slate-object="text" data-key="11068"><span data-slate-leaf="true" data-offset-key="11068:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11069"><span data-slate-leaf="true" data-offset-key="11069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11070"><span data-slate-leaf="true" data-offset-key="11070:0" data-first-offset="true"><span data-slate-string="true">   offset_high;    </span></span></span><span data-slate-object="text" data-key="11071"><span data-slate-leaf="true" data-offset-key="11071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 偏移的高位段 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11072"><span data-slate-object="text" data-key="11073"><span data-slate-leaf="true" data-offset-key="11073:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11074"><span data-slate-leaf="true" data-offset-key="11074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11075"><span data-slate-leaf="true" data-offset-key="11075:0" data-first-offset="true"><span data-slate-string="true">   offset_high_h;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11076"><span data-slate-object="text" data-key="11077"><span data-slate-leaf="true" data-offset-key="11077:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11078"><span data-slate-leaf="true" data-offset-key="11078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11079"><span data-slate-leaf="true" data-offset-key="11079:0" data-first-offset="true"><span data-slate-string="true">   offset_resv;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11080"><span data-slate-object="text" data-key="11081"><span data-slate-leaf="true" data-offset-key="11081:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_34df1aef" data-attr-id="34845" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">}__attribute__((packed)) </span></span></span></span><span data-slate-object="text" data-key="11082"><span data-slate-leaf="true" data-offset-key="11082:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_34df1aef" data-attr-id="34845" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">gate_t</span></span></span></span></span><span data-slate-object="text" data-key="11083"><span data-slate-leaf="true" data-offset-key="11083:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_34df1aef" data-attr-id="34845" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11084"><span data-slate-object="text" data-key="11085"><span data-slate-leaf="true" data-offset-key="11085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义中断表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11086"><span data-slate-object="text" data-key="11087"><span data-slate-leaf="true" data-offset-key="11087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HAL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="11088"><span data-slate-leaf="true" data-offset-key="11088:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="11089"><span data-slate-leaf="true" data-offset-key="11089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">gate_t</span></span></span></span><span data-slate-object="text" data-key="11090"><span data-slate-leaf="true" data-offset-key="11090:0" data-first-offset="true"><span data-slate-string="true">,x64_idt)[IDTMAX];</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11091"><span data-slate-object="text" data-key="11092"><span data-slate-leaf="true" data-offset-key="11092:0" data-first-offset="true"><span data-slate-string="true">说到这里你会发现，中断表其实是个 gate_t 结构的数组，由 CPU 的 IDTR 寄存器指向，IDTMAX 为 256。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11093"><span data-slate-object="text" data-key="11094"><span data-slate-leaf="true" data-offset-key="11094:0" data-first-offset="true"><span data-slate-string="true">但是光有数组还不行，还要设置其中的数据，下面我们就来设计这个函数，建立一个文件 halsgdidt.c，在其中写一个函数，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11095"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11096"><span data-slate-object="text" data-key="11097"><span data-slate-leaf="true" data-offset-key="11097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//vector 向量也是中断号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11098"><span data-slate-object="text" data-key="11099"><span data-slate-leaf="true" data-offset-key="11099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//desc_type 中断门类型，中断门，陷阱门</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11100"><span data-slate-object="text" data-key="11101"><span data-slate-leaf="true" data-offset-key="11101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//handler 中断处理程序的入口地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11102"><span data-slate-object="text" data-key="11103"><span data-slate-leaf="true" data-offset-key="11103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//privilege 中断门的权限级别</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11104"><span data-slate-object="text" data-key="11105"><span data-slate-leaf="true" data-offset-key="11105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="11106"><span data-slate-leaf="true" data-offset-key="11106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11107"><span data-slate-leaf="true" data-offset-key="11107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span></span><span data-slate-object="text" data-key="11108"><span data-slate-leaf="true" data-offset-key="11108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11109"><span data-slate-leaf="true" data-offset-key="11109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11110"><span data-slate-leaf="true" data-offset-key="11110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> vector, </span></span></span></span></span><span data-slate-object="text" data-key="11111"><span data-slate-leaf="true" data-offset-key="11111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11112"><span data-slate-leaf="true" data-offset-key="11112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> desc_type, </span></span></span></span></span><span data-slate-object="text" data-key="11113"><span data-slate-leaf="true" data-offset-key="11113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inthandler_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11114"><span data-slate-leaf="true" data-offset-key="11114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> handler, </span></span></span></span></span><span data-slate-object="text" data-key="11115"><span data-slate-leaf="true" data-offset-key="11115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11116"><span data-slate-leaf="true" data-offset-key="11116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> privilege)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11117"><span data-slate-object="text" data-key="11118"><span data-slate-leaf="true" data-offset-key="11118:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11119"><span data-slate-object="text" data-key="11120"><span data-slate-leaf="true" data-offset-key="11120:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11121"><span data-slate-leaf="true" data-offset-key="11121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">gate_t</span></span></span></span><span data-slate-object="text" data-key="11122"><span data-slate-leaf="true" data-offset-key="11122:0" data-first-offset="true"><span data-slate-string="true"> *p_gate = &amp;x64_idt[vector];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11123"><span data-slate-object="text" data-key="11124"><span data-slate-leaf="true" data-offset-key="11124:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11125"><span data-slate-leaf="true" data-offset-key="11125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11126"><span data-slate-leaf="true" data-offset-key="11126:0" data-first-offset="true"><span data-slate-string="true"> base = (</span></span></span><span data-slate-object="text" data-key="11127"><span data-slate-leaf="true" data-offset-key="11127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11128"><span data-slate-leaf="true" data-offset-key="11128:0" data-first-offset="true"><span data-slate-string="true">)handler;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11129"><span data-slate-object="text" data-key="11130"><span data-slate-leaf="true" data-offset-key="11130:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;offset_low = base &amp; </span></span></span><span data-slate-object="text" data-key="11131"><span data-slate-leaf="true" data-offset-key="11131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xFFFF</span></span></span></span><span data-slate-object="text" data-key="11132"><span data-slate-leaf="true" data-offset-key="11132:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11133"><span data-slate-object="text" data-key="11134"><span data-slate-leaf="true" data-offset-key="11134:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;selector = SELECTOR_KERNEL_CS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11135"><span data-slate-object="text" data-key="11136"><span data-slate-leaf="true" data-offset-key="11136:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;dcount = </span></span></span><span data-slate-object="text" data-key="11137"><span data-slate-leaf="true" data-offset-key="11137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11138"><span data-slate-leaf="true" data-offset-key="11138:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11139"><span data-slate-object="text" data-key="11140"><span data-slate-leaf="true" data-offset-key="11140:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;attr = (</span></span></span><span data-slate-object="text" data-key="11141"><span data-slate-leaf="true" data-offset-key="11141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="11142"><span data-slate-leaf="true" data-offset-key="11142:0" data-first-offset="true"><span data-slate-string="true">)(desc_type | (privilege &lt;&lt; </span></span></span><span data-slate-object="text" data-key="11143"><span data-slate-leaf="true" data-offset-key="11143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="11144"><span data-slate-leaf="true" data-offset-key="11144:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11145"><span data-slate-object="text" data-key="11146"><span data-slate-leaf="true" data-offset-key="11146:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;offset_high = (</span></span></span><span data-slate-object="text" data-key="11147"><span data-slate-leaf="true" data-offset-key="11147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11148"><span data-slate-leaf="true" data-offset-key="11148:0" data-first-offset="true"><span data-slate-string="true">)((base&gt;&gt; </span></span></span><span data-slate-object="text" data-key="11149"><span data-slate-leaf="true" data-offset-key="11149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="11150"><span data-slate-leaf="true" data-offset-key="11150:0" data-first-offset="true"><span data-slate-string="true">) &amp; </span></span></span><span data-slate-object="text" data-key="11151"><span data-slate-leaf="true" data-offset-key="11151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xFFFF</span></span></span></span><span data-slate-object="text" data-key="11152"><span data-slate-leaf="true" data-offset-key="11152:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11153"><span data-slate-object="text" data-key="11154"><span data-slate-leaf="true" data-offset-key="11154:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;offset_high_h = (</span></span></span><span data-slate-object="text" data-key="11155"><span data-slate-leaf="true" data-offset-key="11155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11156"><span data-slate-leaf="true" data-offset-key="11156:0" data-first-offset="true"><span data-slate-string="true">)((base&gt;&gt; </span></span></span><span data-slate-object="text" data-key="11157"><span data-slate-leaf="true" data-offset-key="11157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="11158"><span data-slate-leaf="true" data-offset-key="11158:0" data-first-offset="true"><span data-slate-string="true">) &amp; </span></span></span><span data-slate-object="text" data-key="11159"><span data-slate-leaf="true" data-offset-key="11159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xffffffff</span></span></span></span><span data-slate-object="text" data-key="11160"><span data-slate-leaf="true" data-offset-key="11160:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11161"><span data-slate-object="text" data-key="11162"><span data-slate-leaf="true" data-offset-key="11162:0" data-first-offset="true"><span data-slate-string="true">    p_gate-&gt;offset_resv = </span></span></span><span data-slate-object="text" data-key="11163"><span data-slate-leaf="true" data-offset-key="11163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11164"><span data-slate-leaf="true" data-offset-key="11164:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11165"><span data-slate-object="text" data-key="11166"><span data-slate-leaf="true" data-offset-key="11166:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11167"><span data-slate-leaf="true" data-offset-key="11167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11168"><span data-slate-leaf="true" data-offset-key="11168:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11169"><span data-slate-object="text" data-key="11170"><span data-slate-leaf="true" data-offset-key="11170:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11171"><span data-slate-object="text" data-key="11172"><span data-slate-leaf="true" data-offset-key="11172:0" data-first-offset="true"><span data-slate-string="true">上面的代码，正是按照要求，把这些数据填入中断门描述符中的。有了中断门之后，还差中断入口处理程序，中断入口处理程序只负责这三件事：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11173"><span data-slate-object="text" data-key="11174"><span data-slate-leaf="true" data-offset-key="11174:0" data-first-offset="true"><span data-slate-string="true">1. 保护 CPU 寄存器，即中断发生时的程序运行的上下文。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11175"><span data-slate-object="text" data-key="11176"><span data-slate-leaf="true" data-offset-key="11176:0" data-first-offset="true"><span data-slate-string="true">2. 调用中断处理程序，这个程序可以是修复异常的，可以是设备驱动程序中对设备响应的程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11177"><span data-slate-object="text" data-key="11178"><span data-slate-leaf="true" data-offset-key="11178:0" data-first-offset="true"><span data-slate-string="true">3. 恢复 CPU 寄存器，即恢复中断时程序运行的上下文，使程序继续运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11179"><span data-slate-object="text" data-key="11180"><span data-slate-leaf="true" data-offset-key="11180:0" data-first-offset="true"><span data-slate-string="true">以上这些操作又要用汇编代码才可以编写，我觉得这是内核中最重要的部分，所以我们建立一个文件，并用 kernel.asm 命名。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11181"><span data-slate-object="text" data-key="11182"><span data-slate-leaf="true" data-offset-key="11182:0" data-first-offset="true"><span data-slate-string="true">我们先来写好完成以上三个功能的汇编宏代码，避免写 256 遍同样的代码，代码如下所示。</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="11183"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div><div data-code-line-number="78"></div><div data-code-line-number="79"></div><div data-code-line-number="80"></div><div data-code-line-number="81"></div><div data-code-line-number="82"></div><div data-code-line-number="83"></div><div data-code-line-number="84"></div><div data-code-line-number="85"></div><div data-code-line-number="86"></div><div data-code-line-number="87"></div><div data-code-line-number="88"></div><div data-code-line-number="89"></div><div data-code-line-number="90"></div><div data-code-line-number="91"></div><div data-code-line-number="92"></div><div data-code-line-number="93"></div><div data-code-line-number="94"></div><div data-code-line-number="95"></div><div data-code-line-number="96"></div><div data-code-line-number="97"></div><div data-code-line-number="98"></div><div data-code-line-number="99"></div><div data-code-line-number="100"></div><div data-code-line-number="101"></div><div data-code-line-number="102"></div><div data-code-line-number="103"></div><div data-code-line-number="104"></div><div data-code-line-number="105"></div><div data-code-line-number="106"></div><div data-code-line-number="107"></div><div data-code-line-number="108"></div><div data-code-line-number="109"></div><div data-code-line-number="110"></div><div data-code-line-number="111"></div><div data-code-line-number="112"></div><div data-code-line-number="113"></div><div data-code-line-number="114"></div><div data-code-line-number="115"></div><div data-code-line-number="116"></div><div data-code-line-number="117"></div><div data-code-line-number="118"></div><div data-code-line-number="119"></div><div data-code-line-number="120"></div><div data-code-line-number="121"></div><div data-code-line-number="122"></div><div data-code-line-number="123"></div><div data-code-line-number="124"></div><div data-code-line-number="125"></div><div data-code-line-number="126"></div><div data-code-line-number="127"></div><div data-code-line-number="128"></div><div data-code-line-number="129"></div><div data-code-line-number="130"></div><div data-code-line-number="131"></div><div data-code-line-number="132"></div><div data-code-line-number="133"></div><div data-code-line-number="134"></div><div data-code-line-number="135"></div><div data-code-line-number="136"></div><div data-code-line-number="137"></div><div data-code-line-number="138"></div><div data-code-line-number="139"></div><div data-code-line-number="140"></div><div data-code-line-number="141"></div><div data-code-line-number="142"></div><div data-code-line-number="143"></div><div data-code-line-number="144"></div><div data-code-line-number="145"></div><div data-code-line-number="146"></div><div data-code-line-number="147"></div><div data-code-line-number="148"></div><div data-code-line-number="149"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11184"><span data-slate-object="text" data-key="11185"><span data-slate-leaf="true" data-offset-key="11185:0" data-first-offset="true"><span data-slate-string="true">// 保存中断后的寄存器</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11186"><span data-slate-object="text" data-key="11187"><span data-slate-leaf="true" data-offset-key="11187:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e6396149" data-attr-id="24120" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span></span><span data-slate-object="text" data-key="11188"><span data-slate-leaf="true" data-offset-key="11188:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e6396149" data-attr-id="24120" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  SAVEALL  0</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11189"><span data-slate-object="text" data-key="11190"><span data-slate-leaf="true" data-offset-key="11190:0" data-first-offset="true"><span data-slate-string="true">  push rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11191"><span data-slate-object="text" data-key="11192"><span data-slate-leaf="true" data-offset-key="11192:0" data-first-offset="true"><span data-slate-string="true">  push rbx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11193"><span data-slate-object="text" data-key="11194"><span data-slate-leaf="true" data-offset-key="11194:0" data-first-offset="true"><span data-slate-string="true">  push rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11195"><span data-slate-object="text" data-key="11196"><span data-slate-leaf="true" data-offset-key="11196:0" data-first-offset="true"><span data-slate-string="true">  push rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11197"><span data-slate-object="text" data-key="11198"><span data-slate-leaf="true" data-offset-key="11198:0" data-first-offset="true"><span data-slate-string="true">  push rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11199"><span data-slate-object="text" data-key="11200"><span data-slate-leaf="true" data-offset-key="11200:0" data-first-offset="true"><span data-slate-string="true">  push rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11201"><span data-slate-object="text" data-key="11202"><span data-slate-leaf="true" data-offset-key="11202:0" data-first-offset="true"><span data-slate-string="true">  push rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11203"><span data-slate-object="text" data-key="11204"><span data-slate-leaf="true" data-offset-key="11204:0" data-first-offset="true"><span data-slate-string="true">  push r8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11205"><span data-slate-object="text" data-key="11206"><span data-slate-leaf="true" data-offset-key="11206:0" data-first-offset="true"><span data-slate-string="true">  push r9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11207"><span data-slate-object="text" data-key="11208"><span data-slate-leaf="true" data-offset-key="11208:0" data-first-offset="true"><span data-slate-string="true">  push r10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11209"><span data-slate-object="text" data-key="11210"><span data-slate-leaf="true" data-offset-key="11210:0" data-first-offset="true"><span data-slate-string="true">  push r11</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11211"><span data-slate-object="text" data-key="11212"><span data-slate-leaf="true" data-offset-key="11212:0" data-first-offset="true"><span data-slate-string="true">  push r12</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11213"><span data-slate-object="text" data-key="11214"><span data-slate-leaf="true" data-offset-key="11214:0" data-first-offset="true"><span data-slate-string="true">  push r13</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11215"><span data-slate-object="text" data-key="11216"><span data-slate-leaf="true" data-offset-key="11216:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11217"><span data-slate-object="text" data-key="11218"><span data-slate-leaf="true" data-offset-key="11218:0" data-first-offset="true"><span data-slate-string="true">  push r15</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11219"><span data-slate-object="text" data-key="11220"><span data-slate-leaf="true" data-offset-key="11220:0" data-first-offset="true"><span data-slate-string="true">  xor r14,r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11221"><span data-slate-object="text" data-key="11222"><span data-slate-leaf="true" data-offset-key="11222:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,ds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11223"><span data-slate-object="text" data-key="11224"><span data-slate-leaf="true" data-offset-key="11224:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11225"><span data-slate-object="text" data-key="11226"><span data-slate-leaf="true" data-offset-key="11226:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,es</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11227"><span data-slate-object="text" data-key="11228"><span data-slate-leaf="true" data-offset-key="11228:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11229"><span data-slate-object="text" data-key="11230"><span data-slate-leaf="true" data-offset-key="11230:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,fs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11231"><span data-slate-object="text" data-key="11232"><span data-slate-leaf="true" data-offset-key="11232:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11233"><span data-slate-object="text" data-key="11234"><span data-slate-leaf="true" data-offset-key="11234:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,gs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11235"><span data-slate-object="text" data-key="11236"><span data-slate-leaf="true" data-offset-key="11236:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11237"><span data-slate-object="text" data-key="11238"><span data-slate-leaf="true" data-offset-key="11238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11239"><span data-slate-leaf="true" data-offset-key="11239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11240"><span data-slate-object="text" data-key="11241"><span data-slate-leaf="true" data-offset-key="11241:0" data-first-offset="true"><span data-slate-string="true">// 恢复中断后寄存器</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11242"><span data-slate-object="text" data-key="11243"><span data-slate-leaf="true" data-offset-key="11243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11244"><span data-slate-leaf="true" data-offset-key="11244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  RESTOREALL  0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11245"><span data-slate-object="text" data-key="11246"><span data-slate-leaf="true" data-offset-key="11246:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11247"><span data-slate-object="text" data-key="11248"><span data-slate-leaf="true" data-offset-key="11248:0" data-first-offset="true"><span data-slate-string="true">  mov gs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11249"><span data-slate-object="text" data-key="11250"><span data-slate-leaf="true" data-offset-key="11250:0" data-first-offset="true"><span data-slate-string="true">  pop r14 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11251"><span data-slate-object="text" data-key="11252"><span data-slate-leaf="true" data-offset-key="11252:0" data-first-offset="true"><span data-slate-string="true">  mov fs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11253"><span data-slate-object="text" data-key="11254"><span data-slate-leaf="true" data-offset-key="11254:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11255"><span data-slate-object="text" data-key="11256"><span data-slate-leaf="true" data-offset-key="11256:0" data-first-offset="true"><span data-slate-string="true">  mov es,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11257"><span data-slate-object="text" data-key="11258"><span data-slate-leaf="true" data-offset-key="11258:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11259"><span data-slate-object="text" data-key="11260"><span data-slate-leaf="true" data-offset-key="11260:0" data-first-offset="true"><span data-slate-string="true">  mov ds,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11261"><span data-slate-object="text" data-key="11262"><span data-slate-leaf="true" data-offset-key="11262:0" data-first-offset="true"><span data-slate-string="true">  pop r15</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11263"><span data-slate-object="text" data-key="11264"><span data-slate-leaf="true" data-offset-key="11264:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11265"><span data-slate-object="text" data-key="11266"><span data-slate-leaf="true" data-offset-key="11266:0" data-first-offset="true"><span data-slate-string="true">  pop r13</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11267"><span data-slate-object="text" data-key="11268"><span data-slate-leaf="true" data-offset-key="11268:0" data-first-offset="true"><span data-slate-string="true">  pop r12</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11269"><span data-slate-object="text" data-key="11270"><span data-slate-leaf="true" data-offset-key="11270:0" data-first-offset="true"><span data-slate-string="true">  pop r11</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11271"><span data-slate-object="text" data-key="11272"><span data-slate-leaf="true" data-offset-key="11272:0" data-first-offset="true"><span data-slate-string="true">  pop r10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11273"><span data-slate-object="text" data-key="11274"><span data-slate-leaf="true" data-offset-key="11274:0" data-first-offset="true"><span data-slate-string="true">  pop r9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11275"><span data-slate-object="text" data-key="11276"><span data-slate-leaf="true" data-offset-key="11276:0" data-first-offset="true"><span data-slate-string="true">  pop r8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11277"><span data-slate-object="text" data-key="11278"><span data-slate-leaf="true" data-offset-key="11278:0" data-first-offset="true"><span data-slate-string="true">  pop rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11279"><span data-slate-object="text" data-key="11280"><span data-slate-leaf="true" data-offset-key="11280:0" data-first-offset="true"><span data-slate-string="true">  pop rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11281"><span data-slate-object="text" data-key="11282"><span data-slate-leaf="true" data-offset-key="11282:0" data-first-offset="true"><span data-slate-string="true">  pop rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11283"><span data-slate-object="text" data-key="11284"><span data-slate-leaf="true" data-offset-key="11284:0" data-first-offset="true"><span data-slate-string="true">  pop rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11285"><span data-slate-object="text" data-key="11286"><span data-slate-leaf="true" data-offset-key="11286:0" data-first-offset="true"><span data-slate-string="true">  pop rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11287"><span data-slate-object="text" data-key="11288"><span data-slate-leaf="true" data-offset-key="11288:0" data-first-offset="true"><span data-slate-string="true">  pop rbx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11289"><span data-slate-object="text" data-key="11290"><span data-slate-leaf="true" data-offset-key="11290:0" data-first-offset="true"><span data-slate-string="true">  pop rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11291"><span data-slate-object="text" data-key="11292"><span data-slate-leaf="true" data-offset-key="11292:0" data-first-offset="true"><span data-slate-string="true">  iretq</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11293"><span data-slate-object="text" data-key="11294"><span data-slate-leaf="true" data-offset-key="11294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11295"><span data-slate-leaf="true" data-offset-key="11295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11296"><span data-slate-object="text" data-key="11297"><span data-slate-leaf="true" data-offset-key="11297:0" data-first-offset="true"><span data-slate-string="true">// 保存异常下的寄存器</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11298"><span data-slate-object="text" data-key="11299"><span data-slate-leaf="true" data-offset-key="11299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11300"><span data-slate-leaf="true" data-offset-key="11300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  SAVEALLFAULT 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11301"><span data-slate-object="text" data-key="11302"><span data-slate-leaf="true" data-offset-key="11302:0" data-first-offset="true"><span data-slate-string="true">  push rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11303"><span data-slate-object="text" data-key="11304"><span data-slate-leaf="true" data-offset-key="11304:0" data-first-offset="true"><span data-slate-string="true">  push rbx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11305"><span data-slate-object="text" data-key="11306"><span data-slate-leaf="true" data-offset-key="11306:0" data-first-offset="true"><span data-slate-string="true">  push rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11307"><span data-slate-object="text" data-key="11308"><span data-slate-leaf="true" data-offset-key="11308:0" data-first-offset="true"><span data-slate-string="true">  push rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11309"><span data-slate-object="text" data-key="11310"><span data-slate-leaf="true" data-offset-key="11310:0" data-first-offset="true"><span data-slate-string="true">  push rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11311"><span data-slate-object="text" data-key="11312"><span data-slate-leaf="true" data-offset-key="11312:0" data-first-offset="true"><span data-slate-string="true">  push rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11313"><span data-slate-object="text" data-key="11314"><span data-slate-leaf="true" data-offset-key="11314:0" data-first-offset="true"><span data-slate-string="true">  push rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11315"><span data-slate-object="text" data-key="11316"><span data-slate-leaf="true" data-offset-key="11316:0" data-first-offset="true"><span data-slate-string="true">  push r8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11317"><span data-slate-object="text" data-key="11318"><span data-slate-leaf="true" data-offset-key="11318:0" data-first-offset="true"><span data-slate-string="true">  push r9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11319"><span data-slate-object="text" data-key="11320"><span data-slate-leaf="true" data-offset-key="11320:0" data-first-offset="true"><span data-slate-string="true">  push r10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11321"><span data-slate-object="text" data-key="11322"><span data-slate-leaf="true" data-offset-key="11322:0" data-first-offset="true"><span data-slate-string="true">  push r11</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11323"><span data-slate-object="text" data-key="11324"><span data-slate-leaf="true" data-offset-key="11324:0" data-first-offset="true"><span data-slate-string="true">  push r12</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11325"><span data-slate-object="text" data-key="11326"><span data-slate-leaf="true" data-offset-key="11326:0" data-first-offset="true"><span data-slate-string="true">  push r13</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11327"><span data-slate-object="text" data-key="11328"><span data-slate-leaf="true" data-offset-key="11328:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11329"><span data-slate-object="text" data-key="11330"><span data-slate-leaf="true" data-offset-key="11330:0" data-first-offset="true"><span data-slate-string="true">  push r15</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11331"><span data-slate-object="text" data-key="11332"><span data-slate-leaf="true" data-offset-key="11332:0" data-first-offset="true"><span data-slate-string="true">  xor r14,r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11333"><span data-slate-object="text" data-key="11334"><span data-slate-leaf="true" data-offset-key="11334:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,ds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11335"><span data-slate-object="text" data-key="11336"><span data-slate-leaf="true" data-offset-key="11336:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11337"><span data-slate-object="text" data-key="11338"><span data-slate-leaf="true" data-offset-key="11338:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,es</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11339"><span data-slate-object="text" data-key="11340"><span data-slate-leaf="true" data-offset-key="11340:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11341"><span data-slate-object="text" data-key="11342"><span data-slate-leaf="true" data-offset-key="11342:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,fs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11343"><span data-slate-object="text" data-key="11344"><span data-slate-leaf="true" data-offset-key="11344:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11345"><span data-slate-object="text" data-key="11346"><span data-slate-leaf="true" data-offset-key="11346:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,gs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11347"><span data-slate-object="text" data-key="11348"><span data-slate-leaf="true" data-offset-key="11348:0" data-first-offset="true"><span data-slate-string="true">  push r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11349"><span data-slate-object="text" data-key="11350"><span data-slate-leaf="true" data-offset-key="11350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11351"><span data-slate-leaf="true" data-offset-key="11351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11352"><span data-slate-object="text" data-key="11353"><span data-slate-leaf="true" data-offset-key="11353:0" data-first-offset="true"><span data-slate-string="true">// 恢复异常下寄存器</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11354"><span data-slate-object="text" data-key="11355"><span data-slate-leaf="true" data-offset-key="11355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11356"><span data-slate-leaf="true" data-offset-key="11356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  RESTOREALLFAULT  0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11357"><span data-slate-object="text" data-key="11358"><span data-slate-leaf="true" data-offset-key="11358:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11359"><span data-slate-object="text" data-key="11360"><span data-slate-leaf="true" data-offset-key="11360:0" data-first-offset="true"><span data-slate-string="true">  mov gs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11361"><span data-slate-object="text" data-key="11362"><span data-slate-leaf="true" data-offset-key="11362:0" data-first-offset="true"><span data-slate-string="true">  pop r14 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11363"><span data-slate-object="text" data-key="11364"><span data-slate-leaf="true" data-offset-key="11364:0" data-first-offset="true"><span data-slate-string="true">  mov fs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11365"><span data-slate-object="text" data-key="11366"><span data-slate-leaf="true" data-offset-key="11366:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11367"><span data-slate-object="text" data-key="11368"><span data-slate-leaf="true" data-offset-key="11368:0" data-first-offset="true"><span data-slate-string="true">  mov es,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11369"><span data-slate-object="text" data-key="11370"><span data-slate-leaf="true" data-offset-key="11370:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11371"><span data-slate-object="text" data-key="11372"><span data-slate-leaf="true" data-offset-key="11372:0" data-first-offset="true"><span data-slate-string="true">  mov ds,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11373"><span data-slate-object="text" data-key="11374"><span data-slate-leaf="true" data-offset-key="11374:0" data-first-offset="true"><span data-slate-string="true">  pop r15</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11375"><span data-slate-object="text" data-key="11376"><span data-slate-leaf="true" data-offset-key="11376:0" data-first-offset="true"><span data-slate-string="true">  pop r14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11377"><span data-slate-object="text" data-key="11378"><span data-slate-leaf="true" data-offset-key="11378:0" data-first-offset="true"><span data-slate-string="true">  pop r13</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11379"><span data-slate-object="text" data-key="11380"><span data-slate-leaf="true" data-offset-key="11380:0" data-first-offset="true"><span data-slate-string="true">  pop r12</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11381"><span data-slate-object="text" data-key="11382"><span data-slate-leaf="true" data-offset-key="11382:0" data-first-offset="true"><span data-slate-string="true">  pop r11</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11383"><span data-slate-object="text" data-key="11384"><span data-slate-leaf="true" data-offset-key="11384:0" data-first-offset="true"><span data-slate-string="true">  pop r10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11385"><span data-slate-object="text" data-key="11386"><span data-slate-leaf="true" data-offset-key="11386:0" data-first-offset="true"><span data-slate-string="true">  pop r9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11387"><span data-slate-object="text" data-key="11388"><span data-slate-leaf="true" data-offset-key="11388:0" data-first-offset="true"><span data-slate-string="true">  pop r8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11389"><span data-slate-object="text" data-key="11390"><span data-slate-leaf="true" data-offset-key="11390:0" data-first-offset="true"><span data-slate-string="true">  pop rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11391"><span data-slate-object="text" data-key="11392"><span data-slate-leaf="true" data-offset-key="11392:0" data-first-offset="true"><span data-slate-string="true">  pop rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11393"><span data-slate-object="text" data-key="11394"><span data-slate-leaf="true" data-offset-key="11394:0" data-first-offset="true"><span data-slate-string="true">  pop rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11395"><span data-slate-object="text" data-key="11396"><span data-slate-leaf="true" data-offset-key="11396:0" data-first-offset="true"><span data-slate-string="true">  pop rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11397"><span data-slate-object="text" data-key="11398"><span data-slate-leaf="true" data-offset-key="11398:0" data-first-offset="true"><span data-slate-string="true">  pop rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11399"><span data-slate-object="text" data-key="11400"><span data-slate-leaf="true" data-offset-key="11400:0" data-first-offset="true"><span data-slate-string="true">  pop rbx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11401"><span data-slate-object="text" data-key="11402"><span data-slate-leaf="true" data-offset-key="11402:0" data-first-offset="true"><span data-slate-string="true">  pop rax</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11403"><span data-slate-object="text" data-key="11404"><span data-slate-leaf="true" data-offset-key="11404:0" data-first-offset="true"><span data-slate-string="true">  add rsp,8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11405"><span data-slate-object="text" data-key="11406"><span data-slate-leaf="true" data-offset-key="11406:0" data-first-offset="true"><span data-slate-string="true">  iretq</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11407"><span data-slate-object="text" data-key="11408"><span data-slate-leaf="true" data-offset-key="11408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11409"><span data-slate-leaf="true" data-offset-key="11409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11410"><span data-slate-object="text" data-key="11411"><span data-slate-leaf="true" data-offset-key="11411:0" data-first-offset="true"><span data-slate-string="true">// 没有错误码 CPU 异常</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11412"><span data-slate-object="text" data-key="11413"><span data-slate-leaf="true" data-offset-key="11413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11414"><span data-slate-leaf="true" data-offset-key="11414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  SRFTFAULT 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11415"><span data-slate-object="text" data-key="11416"><span data-slate-leaf="true" data-offset-key="11416:0" data-first-offset="true"><span data-slate-string="true">  push    _NOERRO_CODE</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11417"><span data-slate-object="text" data-key="11418"><span data-slate-leaf="true" data-offset-key="11418:0" data-first-offset="true"><span data-slate-string="true">  SAVEALLFAULT</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11419"><span data-slate-object="text" data-key="11420"><span data-slate-leaf="true" data-offset-key="11420:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,0x10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11421"><span data-slate-object="text" data-key="11422"><span data-slate-leaf="true" data-offset-key="11422:0" data-first-offset="true"><span data-slate-string="true">  mov ds,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11423"><span data-slate-object="text" data-key="11424"><span data-slate-leaf="true" data-offset-key="11424:0" data-first-offset="true"><span data-slate-string="true">  mov es,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11425"><span data-slate-object="text" data-key="11426"><span data-slate-leaf="true" data-offset-key="11426:0" data-first-offset="true"><span data-slate-string="true">  mov fs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11427"><span data-slate-object="text" data-key="11428"><span data-slate-leaf="true" data-offset-key="11428:0" data-first-offset="true"><span data-slate-string="true">  mov gs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11429"><span data-slate-object="text" data-key="11430"><span data-slate-leaf="true" data-offset-key="11430:0" data-first-offset="true"><span data-slate-string="true">  mov   rdi,%1 ;rdi, rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11431"><span data-slate-object="text" data-key="11432"><span data-slate-leaf="true" data-offset-key="11432:0" data-first-offset="true"><span data-slate-string="true">  mov   rsi,rsp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11433"><span data-slate-object="text" data-key="11434"><span data-slate-leaf="true" data-offset-key="11434:0" data-first-offset="true"><span data-slate-string="true">  call   hal_fault_allocator</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11435"><span data-slate-object="text" data-key="11436"><span data-slate-leaf="true" data-offset-key="11436:0" data-first-offset="true"><span data-slate-string="true">  RESTOREALLFAULT</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11437"><span data-slate-object="text" data-key="11438"><span data-slate-leaf="true" data-offset-key="11438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11439"><span data-slate-leaf="true" data-offset-key="11439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11440"><span data-slate-object="text" data-key="11441"><span data-slate-leaf="true" data-offset-key="11441:0" data-first-offset="true"><span data-slate-string="true">//CPU 异常</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11442"><span data-slate-object="text" data-key="11443"><span data-slate-leaf="true" data-offset-key="11443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11444"><span data-slate-leaf="true" data-offset-key="11444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  SRFTFAULT_ECODE 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11445"><span data-slate-object="text" data-key="11446"><span data-slate-leaf="true" data-offset-key="11446:0" data-first-offset="true"><span data-slate-string="true">  SAVEALLFAULT</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11447"><span data-slate-object="text" data-key="11448"><span data-slate-leaf="true" data-offset-key="11448:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,0x10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11449"><span data-slate-object="text" data-key="11450"><span data-slate-leaf="true" data-offset-key="11450:0" data-first-offset="true"><span data-slate-string="true">  mov ds,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11451"><span data-slate-object="text" data-key="11452"><span data-slate-leaf="true" data-offset-key="11452:0" data-first-offset="true"><span data-slate-string="true">  mov es,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11453"><span data-slate-object="text" data-key="11454"><span data-slate-leaf="true" data-offset-key="11454:0" data-first-offset="true"><span data-slate-string="true">  mov fs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11455"><span data-slate-object="text" data-key="11456"><span data-slate-leaf="true" data-offset-key="11456:0" data-first-offset="true"><span data-slate-string="true">  mov gs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11457"><span data-slate-object="text" data-key="11458"><span data-slate-leaf="true" data-offset-key="11458:0" data-first-offset="true"><span data-slate-string="true">  mov   rdi,%1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11459"><span data-slate-object="text" data-key="11460"><span data-slate-leaf="true" data-offset-key="11460:0" data-first-offset="true"><span data-slate-string="true">  mov   rsi,rsp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11461"><span data-slate-object="text" data-key="11462"><span data-slate-leaf="true" data-offset-key="11462:0" data-first-offset="true"><span data-slate-string="true">  call   hal_fault_allocator</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11463"><span data-slate-object="text" data-key="11464"><span data-slate-leaf="true" data-offset-key="11464:0" data-first-offset="true"><span data-slate-string="true">  RESTOREALLFAULT</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11465"><span data-slate-object="text" data-key="11466"><span data-slate-leaf="true" data-offset-key="11466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11467"><span data-slate-leaf="true" data-offset-key="11467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11468"><span data-slate-object="text" data-key="11469"><span data-slate-leaf="true" data-offset-key="11469:0" data-first-offset="true"><span data-slate-string="true">// 硬件中断</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11470"><span data-slate-object="text" data-key="11471"><span data-slate-leaf="true" data-offset-key="11471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11472"><span data-slate-leaf="true" data-offset-key="11472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro  HARWINT  1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11473"><span data-slate-object="text" data-key="11474"><span data-slate-leaf="true" data-offset-key="11474:0" data-first-offset="true"><span data-slate-string="true">  SAVEALL</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11475"><span data-slate-object="text" data-key="11476"><span data-slate-leaf="true" data-offset-key="11476:0" data-first-offset="true"><span data-slate-string="true">  mov r14w,0x10</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11477"><span data-slate-object="text" data-key="11478"><span data-slate-leaf="true" data-offset-key="11478:0" data-first-offset="true"><span data-slate-string="true">  mov ds,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11479"><span data-slate-object="text" data-key="11480"><span data-slate-leaf="true" data-offset-key="11480:0" data-first-offset="true"><span data-slate-string="true">  mov es,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11481"><span data-slate-object="text" data-key="11482"><span data-slate-leaf="true" data-offset-key="11482:0" data-first-offset="true"><span data-slate-string="true">  mov fs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11483"><span data-slate-object="text" data-key="11484"><span data-slate-leaf="true" data-offset-key="11484:0" data-first-offset="true"><span data-slate-string="true">  mov gs,r14w</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11485"><span data-slate-object="text" data-key="11486"><span data-slate-leaf="true" data-offset-key="11486:0" data-first-offset="true"><span data-slate-string="true">  mov  rdi, %1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11487"><span data-slate-object="text" data-key="11488"><span data-slate-leaf="true" data-offset-key="11488:0" data-first-offset="true"><span data-slate-string="true">  mov   rsi,rsp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11489"><span data-slate-object="text" data-key="11490"><span data-slate-leaf="true" data-offset-key="11490:0" data-first-offset="true"><span data-slate-string="true">  call    hal_intpt_allocator</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11491"><span data-slate-object="text" data-key="11492"><span data-slate-leaf="true" data-offset-key="11492:0" data-first-offset="true"><span data-slate-string="true">  RESTOREALL</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11493"><span data-slate-object="text" data-key="11494"><span data-slate-leaf="true" data-offset-key="11494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">%</span></span></span></span><span data-slate-object="text" data-key="11495"><span data-slate-leaf="true" data-offset-key="11495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endmacro</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11496"><span data-slate-object="text" data-key="11497"><span data-slate-leaf="true" data-offset-key="11497:0" data-first-offset="true"><span data-slate-string="true">别看前面的代码这么长，其实</span></span></span><span data-slate-object="text" data-key="11498"><span data-slate-leaf="true" data-offset-key="11498:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最重要的只有两个指令：push、pop</span></span></span></span><span data-slate-object="text" data-key="11499"><span data-slate-leaf="true" data-offset-key="11499:0" data-first-offset="true"><span data-slate-string="true">，这两个正是用来压入寄存器和弹出寄存器的，正好可以用来保存和恢复 CPU 所有的通用寄存器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11500"><span data-slate-object="text" data-key="11501"><span data-slate-leaf="true" data-offset-key="11501:0" data-first-offset="true"><span data-slate-string="true">有的 CPU 异常，CPU 自动把异常码压入到栈中，而有的 CPU 异常没有异常码，</span></span></span><span data-slate-object="text" data-key="11502"><span data-slate-leaf="true" data-offset-key="11502:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为了统一，我们对没有异常码的手动压入一个常数，维持栈的平衡。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11503"><span data-slate-object="text" data-key="11504"><span data-slate-leaf="true" data-offset-key="11504:0" data-first-offset="true"><span data-slate-string="true">有了中断异常处理的宏，我们还要它们变成中断异常的处理程序入口点函数。汇编函数其实就是一个标号加一段汇编代码，C 编译器把 C 语言函数编译成汇编代码后，也是标号加汇编代码，函数名就是标号。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11505"><span data-slate-object="text" data-key="11506"><span data-slate-leaf="true" data-offset-key="11506:0" data-first-offset="true"><span data-slate-string="true">下面我们在 kernel.asm 中写好它们：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="11507"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11508"><span data-slate-object="text" data-key="11509"><span data-slate-leaf="true" data-offset-key="11509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 除法错误异常 比如除 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11510"><span data-slate-object="text" data-key="11511"><span data-slate-leaf="true" data-offset-key="11511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_divide_error</span></span></span></span><span data-slate-object="text" data-key="11512"><span data-slate-leaf="true" data-offset-key="11512:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11513"><span data-slate-object="text" data-key="11514"><span data-slate-leaf="true" data-offset-key="11514:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11515"><span data-slate-leaf="true" data-offset-key="11515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT</span></span></span></span><span data-slate-object="text" data-key="11516"><span data-slate-leaf="true" data-offset-key="11516:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11517"><span data-slate-leaf="true" data-offset-key="11517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11518"><span data-slate-object="text" data-key="11519"><span data-slate-leaf="true" data-offset-key="11519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 单步执行异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11520"><span data-slate-object="text" data-key="11521"><span data-slate-leaf="true" data-offset-key="11521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_single_step_exception</span></span></span></span><span data-slate-object="text" data-key="11522"><span data-slate-leaf="true" data-offset-key="11522:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11523"><span data-slate-object="text" data-key="11524"><span data-slate-leaf="true" data-offset-key="11524:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11525"><span data-slate-leaf="true" data-offset-key="11525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT</span></span></span></span><span data-slate-object="text" data-key="11526"><span data-slate-leaf="true" data-offset-key="11526:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11527"><span data-slate-leaf="true" data-offset-key="11527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11528"><span data-slate-object="text" data-key="11529"><span data-slate-leaf="true" data-offset-key="11529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_nmi</span></span></span></span><span data-slate-object="text" data-key="11530"><span data-slate-leaf="true" data-offset-key="11530:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11531"><span data-slate-object="text" data-key="11532"><span data-slate-leaf="true" data-offset-key="11532:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11533"><span data-slate-leaf="true" data-offset-key="11533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT</span></span></span></span><span data-slate-object="text" data-key="11534"><span data-slate-leaf="true" data-offset-key="11534:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11535"><span data-slate-leaf="true" data-offset-key="11535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11536"><span data-slate-object="text" data-key="11537"><span data-slate-leaf="true" data-offset-key="11537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调试断点异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11538"><span data-slate-object="text" data-key="11539"><span data-slate-leaf="true" data-offset-key="11539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_breakpoint_exception</span></span></span></span><span data-slate-object="text" data-key="11540"><span data-slate-leaf="true" data-offset-key="11540:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11541"><span data-slate-object="text" data-key="11542"><span data-slate-leaf="true" data-offset-key="11542:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11543"><span data-slate-leaf="true" data-offset-key="11543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT</span></span></span></span><span data-slate-object="text" data-key="11544"><span data-slate-leaf="true" data-offset-key="11544:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11545"><span data-slate-leaf="true" data-offset-key="11545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11546"><span data-slate-object="text" data-key="11547"><span data-slate-leaf="true" data-offset-key="11547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 溢出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11548"><span data-slate-object="text" data-key="11549"><span data-slate-leaf="true" data-offset-key="11549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_overflow</span></span></span></span><span data-slate-object="text" data-key="11550"><span data-slate-leaf="true" data-offset-key="11550:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11551"><span data-slate-object="text" data-key="11552"><span data-slate-leaf="true" data-offset-key="11552:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11553"><span data-slate-leaf="true" data-offset-key="11553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT</span></span></span></span><span data-slate-object="text" data-key="11554"><span data-slate-leaf="true" data-offset-key="11554:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11555"><span data-slate-leaf="true" data-offset-key="11555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11556"><span data-slate-object="text" data-key="11557"><span data-slate-leaf="true" data-offset-key="11557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 段不存在异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11558"><span data-slate-object="text" data-key="11559"><span data-slate-leaf="true" data-offset-key="11559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_segment_not_present</span></span></span></span><span data-slate-object="text" data-key="11560"><span data-slate-leaf="true" data-offset-key="11560:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11561"><span data-slate-object="text" data-key="11562"><span data-slate-leaf="true" data-offset-key="11562:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11563"><span data-slate-leaf="true" data-offset-key="11563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT_ECODE</span></span></span></span><span data-slate-object="text" data-key="11564"><span data-slate-leaf="true" data-offset-key="11564:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11565"><span data-slate-leaf="true" data-offset-key="11565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11566"><span data-slate-object="text" data-key="11567"><span data-slate-leaf="true" data-offset-key="11567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 栈异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11568"><span data-slate-object="text" data-key="11569"><span data-slate-leaf="true" data-offset-key="11569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_stack_exception</span></span></span></span><span data-slate-object="text" data-key="11570"><span data-slate-leaf="true" data-offset-key="11570:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11571"><span data-slate-object="text" data-key="11572"><span data-slate-leaf="true" data-offset-key="11572:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11573"><span data-slate-leaf="true" data-offset-key="11573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT_ECODE</span></span></span></span><span data-slate-object="text" data-key="11574"><span data-slate-leaf="true" data-offset-key="11574:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11575"><span data-slate-leaf="true" data-offset-key="11575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">12</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11576"><span data-slate-object="text" data-key="11577"><span data-slate-leaf="true" data-offset-key="11577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通用异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11578"><span data-slate-object="text" data-key="11579"><span data-slate-leaf="true" data-offset-key="11579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_general_protection</span></span></span></span><span data-slate-object="text" data-key="11580"><span data-slate-leaf="true" data-offset-key="11580:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11581"><span data-slate-object="text" data-key="11582"><span data-slate-leaf="true" data-offset-key="11582:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11583"><span data-slate-leaf="true" data-offset-key="11583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT_ECODE</span></span></span></span><span data-slate-object="text" data-key="11584"><span data-slate-leaf="true" data-offset-key="11584:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11585"><span data-slate-leaf="true" data-offset-key="11585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">13</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11586"><span data-slate-object="text" data-key="11587"><span data-slate-leaf="true" data-offset-key="11587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 缺页异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11588"><span data-slate-object="text" data-key="11589"><span data-slate-leaf="true" data-offset-key="11589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exc_page_fault</span></span></span></span><span data-slate-object="text" data-key="11590"><span data-slate-leaf="true" data-offset-key="11590:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11591"><span data-slate-object="text" data-key="11592"><span data-slate-leaf="true" data-offset-key="11592:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11593"><span data-slate-leaf="true" data-offset-key="11593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT_ECODE</span></span></span></span><span data-slate-object="text" data-key="11594"><span data-slate-leaf="true" data-offset-key="11594:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11595"><span data-slate-leaf="true" data-offset-key="11595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">14</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11596"><span data-slate-object="text" data-key="11597"><span data-slate-leaf="true" data-offset-key="11597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_exc_general_intpfault</span></span></span></span><span data-slate-object="text" data-key="11598"><span data-slate-leaf="true" data-offset-key="11598:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11599"><span data-slate-object="text" data-key="11600"><span data-slate-leaf="true" data-offset-key="11600:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11601"><span data-slate-leaf="true" data-offset-key="11601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SRFTFAULT</span></span></span></span><span data-slate-object="text" data-key="11602"><span data-slate-leaf="true" data-offset-key="11602:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11603"><span data-slate-leaf="true" data-offset-key="11603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">256</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11604"><span data-slate-object="text" data-key="11605"><span data-slate-leaf="true" data-offset-key="11605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 硬件 1～7 号中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11606"><span data-slate-object="text" data-key="11607"><span data-slate-leaf="true" data-offset-key="11607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint00</span></span></span></span><span data-slate-object="text" data-key="11608"><span data-slate-leaf="true" data-offset-key="11608:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11609"><span data-slate-object="text" data-key="11610"><span data-slate-leaf="true" data-offset-key="11610:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11611"><span data-slate-leaf="true" data-offset-key="11611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11612"><span data-slate-leaf="true" data-offset-key="11612:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11613"><span data-slate-leaf="true" data-offset-key="11613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11614"><span data-slate-leaf="true" data-offset-key="11614:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11615"><span data-slate-leaf="true" data-offset-key="11615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11616"><span data-slate-leaf="true" data-offset-key="11616:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11617"><span data-slate-object="text" data-key="11618"><span data-slate-leaf="true" data-offset-key="11618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint01</span></span></span></span><span data-slate-object="text" data-key="11619"><span data-slate-leaf="true" data-offset-key="11619:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11620"><span data-slate-object="text" data-key="11621"><span data-slate-leaf="true" data-offset-key="11621:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11622"><span data-slate-leaf="true" data-offset-key="11622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11623"><span data-slate-leaf="true" data-offset-key="11623:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11624"><span data-slate-leaf="true" data-offset-key="11624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11625"><span data-slate-leaf="true" data-offset-key="11625:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11626"><span data-slate-leaf="true" data-offset-key="11626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="11627"><span data-slate-leaf="true" data-offset-key="11627:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11628"><span data-slate-object="text" data-key="11629"><span data-slate-leaf="true" data-offset-key="11629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint02</span></span></span></span><span data-slate-object="text" data-key="11630"><span data-slate-leaf="true" data-offset-key="11630:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11631"><span data-slate-object="text" data-key="11632"><span data-slate-leaf="true" data-offset-key="11632:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11633"><span data-slate-leaf="true" data-offset-key="11633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11634"><span data-slate-leaf="true" data-offset-key="11634:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11635"><span data-slate-leaf="true" data-offset-key="11635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11636"><span data-slate-leaf="true" data-offset-key="11636:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11637"><span data-slate-leaf="true" data-offset-key="11637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="11638"><span data-slate-leaf="true" data-offset-key="11638:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11639"><span data-slate-object="text" data-key="11640"><span data-slate-leaf="true" data-offset-key="11640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint03</span></span></span></span><span data-slate-object="text" data-key="11641"><span data-slate-leaf="true" data-offset-key="11641:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11642"><span data-slate-object="text" data-key="11643"><span data-slate-leaf="true" data-offset-key="11643:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11644"><span data-slate-leaf="true" data-offset-key="11644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11645"><span data-slate-leaf="true" data-offset-key="11645:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11646"><span data-slate-leaf="true" data-offset-key="11646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11647"><span data-slate-leaf="true" data-offset-key="11647:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11648"><span data-slate-leaf="true" data-offset-key="11648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="11649"><span data-slate-leaf="true" data-offset-key="11649:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11650"><span data-slate-object="text" data-key="11651"><span data-slate-leaf="true" data-offset-key="11651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint04</span></span></span></span><span data-slate-object="text" data-key="11652"><span data-slate-leaf="true" data-offset-key="11652:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11653"><span data-slate-object="text" data-key="11654"><span data-slate-leaf="true" data-offset-key="11654:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11655"><span data-slate-leaf="true" data-offset-key="11655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11656"><span data-slate-leaf="true" data-offset-key="11656:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11657"><span data-slate-leaf="true" data-offset-key="11657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11658"><span data-slate-leaf="true" data-offset-key="11658:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11659"><span data-slate-leaf="true" data-offset-key="11659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="11660"><span data-slate-leaf="true" data-offset-key="11660:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11661"><span data-slate-object="text" data-key="11662"><span data-slate-leaf="true" data-offset-key="11662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint05</span></span></span></span><span data-slate-object="text" data-key="11663"><span data-slate-leaf="true" data-offset-key="11663:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11664"><span data-slate-object="text" data-key="11665"><span data-slate-leaf="true" data-offset-key="11665:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11666"><span data-slate-leaf="true" data-offset-key="11666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11667"><span data-slate-leaf="true" data-offset-key="11667:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11668"><span data-slate-leaf="true" data-offset-key="11668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11669"><span data-slate-leaf="true" data-offset-key="11669:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11670"><span data-slate-leaf="true" data-offset-key="11670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="11671"><span data-slate-leaf="true" data-offset-key="11671:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11672"><span data-slate-object="text" data-key="11673"><span data-slate-leaf="true" data-offset-key="11673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint06</span></span></span></span><span data-slate-object="text" data-key="11674"><span data-slate-leaf="true" data-offset-key="11674:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11675"><span data-slate-object="text" data-key="11676"><span data-slate-leaf="true" data-offset-key="11676:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11677"><span data-slate-leaf="true" data-offset-key="11677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11678"><span data-slate-leaf="true" data-offset-key="11678:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11679"><span data-slate-leaf="true" data-offset-key="11679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11680"><span data-slate-leaf="true" data-offset-key="11680:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11681"><span data-slate-leaf="true" data-offset-key="11681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span><span data-slate-object="text" data-key="11682"><span data-slate-leaf="true" data-offset-key="11682:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11683"><span data-slate-object="text" data-key="11684"><span data-slate-leaf="true" data-offset-key="11684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hxi_hwint07</span></span></span></span><span data-slate-object="text" data-key="11685"><span data-slate-leaf="true" data-offset-key="11685:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11686"><span data-slate-object="text" data-key="11687"><span data-slate-leaf="true" data-offset-key="11687:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11688"><span data-slate-leaf="true" data-offset-key="11688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HARWINT</span></span></span></span><span data-slate-object="text" data-key="11689"><span data-slate-leaf="true" data-offset-key="11689:0" data-first-offset="true"><span data-slate-string="true">  (</span></span></span><span data-slate-object="text" data-key="11690"><span data-slate-leaf="true" data-offset-key="11690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INT_VECTOR_IRQ0</span></span></span></span><span data-slate-object="text" data-key="11691"><span data-slate-leaf="true" data-offset-key="11691:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="11692"><span data-slate-leaf="true" data-offset-key="11692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="11693"><span data-slate-leaf="true" data-offset-key="11693:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11694"><span data-slate-object="text" data-key="11695"><span data-slate-leaf="true" data-offset-key="11695:0" data-first-offset="true"><span data-slate-string="true">为了突出重点，这里没有全部展示代码 ，你只用搞清原理就行了。那有了中断处理程序的入口地址，下面我们就可以在 halsgdidt.c 文件写出函数设置中断门描述符了，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11696"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11697"><span data-slate-object="text" data-key="11698"><span data-slate-leaf="true" data-offset-key="11698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="11699"><span data-slate-leaf="true" data-offset-key="11699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11700"><span data-slate-leaf="true" data-offset-key="11700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_idt_descriptor</span></span></span></span></span><span data-slate-object="text" data-key="11701"><span data-slate-leaf="true" data-offset-key="11701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11702"><span data-slate-object="text" data-key="11703"><span data-slate-leaf="true" data-offset-key="11703:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11704"><span data-slate-object="text" data-key="11705"><span data-slate-leaf="true" data-offset-key="11705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 一开始把所有中断的处理程序设置为保留的通用处理程序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11706"><span data-slate-object="text" data-key="11707"><span data-slate-leaf="true" data-offset-key="11707:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11708"><span data-slate-leaf="true" data-offset-key="11708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="11709"><span data-slate-leaf="true" data-offset-key="11709:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="11710"><span data-slate-leaf="true" data-offset-key="11710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u16_t</span></span></span></span><span data-slate-object="text" data-key="11711"><span data-slate-leaf="true" data-offset-key="11711:0" data-first-offset="true"><span data-slate-string="true"> intindx = </span></span></span><span data-slate-object="text" data-key="11712"><span data-slate-leaf="true" data-offset-key="11712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11713"><span data-slate-leaf="true" data-offset-key="11713:0" data-first-offset="true"><span data-slate-string="true">; intindx &lt;= </span></span></span><span data-slate-object="text" data-key="11714"><span data-slate-leaf="true" data-offset-key="11714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">255</span></span></span></span><span data-slate-object="text" data-key="11715"><span data-slate-leaf="true" data-offset-key="11715:0" data-first-offset="true"><span data-slate-string="true">; intindx++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11716"><span data-slate-object="text" data-key="11717"><span data-slate-leaf="true" data-offset-key="11717:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11718"><span data-slate-object="text" data-key="11719"><span data-slate-leaf="true" data-offset-key="11719:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11720"><span data-slate-leaf="true" data-offset-key="11720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11721"><span data-slate-leaf="true" data-offset-key="11721:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="11722"><span data-slate-leaf="true" data-offset-key="11722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u8_t</span></span></span></span><span data-slate-object="text" data-key="11723"><span data-slate-leaf="true" data-offset-key="11723:0" data-first-offset="true"><span data-slate-string="true">)intindx, DA_386IGate, hxi_exc_general_intpfault, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11724"><span data-slate-object="text" data-key="11725"><span data-slate-leaf="true" data-offset-key="11725:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11726"><span data-slate-object="text" data-key="11727"><span data-slate-leaf="true" data-offset-key="11727:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11728"><span data-slate-leaf="true" data-offset-key="11728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11729"><span data-slate-leaf="true" data-offset-key="11729:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_DIVIDE, DA_386IGate, exc_divide_error, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11730"><span data-slate-object="text" data-key="11731"><span data-slate-leaf="true" data-offset-key="11731:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11732"><span data-slate-leaf="true" data-offset-key="11732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11733"><span data-slate-leaf="true" data-offset-key="11733:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_DEBUG, DA_386IGate, exc_single_step_exception, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11734"><span data-slate-object="text" data-key="11735"><span data-slate-leaf="true" data-offset-key="11735:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11736"><span data-slate-leaf="true" data-offset-key="11736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11737"><span data-slate-leaf="true" data-offset-key="11737:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_NMI, DA_386IGate, exc_nmi, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11738"><span data-slate-object="text" data-key="11739"><span data-slate-leaf="true" data-offset-key="11739:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11740"><span data-slate-leaf="true" data-offset-key="11740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11741"><span data-slate-leaf="true" data-offset-key="11741:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_BREAKPOINT, DA_386IGate, exc_breakpoint_exception, PRIVILEGE_USER);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11742"><span data-slate-object="text" data-key="11743"><span data-slate-leaf="true" data-offset-key="11743:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11744"><span data-slate-leaf="true" data-offset-key="11744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11745"><span data-slate-leaf="true" data-offset-key="11745:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_OVERFLOW, DA_386IGate, exc_overflow, PRIVILEGE_USER);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11746"><span data-slate-object="text" data-key="11747"><span data-slate-leaf="true" data-offset-key="11747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 篇幅所限，未全部展示</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11748"><span data-slate-object="text" data-key="11749"><span data-slate-leaf="true" data-offset-key="11749:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11750"><span data-slate-leaf="true" data-offset-key="11750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11751"><span data-slate-leaf="true" data-offset-key="11751:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_PAGE_FAULT, DA_386IGate, exc_page_fault, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11752"><span data-slate-object="text" data-key="11753"><span data-slate-leaf="true" data-offset-key="11753:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11754"><span data-slate-leaf="true" data-offset-key="11754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11755"><span data-slate-leaf="true" data-offset-key="11755:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_IRQ0 + </span></span></span><span data-slate-object="text" data-key="11756"><span data-slate-leaf="true" data-offset-key="11756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11757"><span data-slate-leaf="true" data-offset-key="11757:0" data-first-offset="true"><span data-slate-string="true">, DA_386IGate, hxi_hwint00, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11758"><span data-slate-object="text" data-key="11759"><span data-slate-leaf="true" data-offset-key="11759:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11760"><span data-slate-leaf="true" data-offset-key="11760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11761"><span data-slate-leaf="true" data-offset-key="11761:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_IRQ0 + </span></span></span><span data-slate-object="text" data-key="11762"><span data-slate-leaf="true" data-offset-key="11762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="11763"><span data-slate-leaf="true" data-offset-key="11763:0" data-first-offset="true"><span data-slate-string="true">, DA_386IGate, hxi_hwint01, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11764"><span data-slate-object="text" data-key="11765"><span data-slate-leaf="true" data-offset-key="11765:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11766"><span data-slate-leaf="true" data-offset-key="11766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11767"><span data-slate-leaf="true" data-offset-key="11767:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_IRQ0 + </span></span></span><span data-slate-object="text" data-key="11768"><span data-slate-leaf="true" data-offset-key="11768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="11769"><span data-slate-leaf="true" data-offset-key="11769:0" data-first-offset="true"><span data-slate-string="true">, DA_386IGate, hxi_hwint02, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11770"><span data-slate-object="text" data-key="11771"><span data-slate-leaf="true" data-offset-key="11771:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11772"><span data-slate-leaf="true" data-offset-key="11772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set_idt_desc</span></span></span></span><span data-slate-object="text" data-key="11773"><span data-slate-leaf="true" data-offset-key="11773:0" data-first-offset="true"><span data-slate-string="true">(INT_VECTOR_IRQ0 + </span></span></span><span data-slate-object="text" data-key="11774"><span data-slate-leaf="true" data-offset-key="11774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="11775"><span data-slate-leaf="true" data-offset-key="11775:0" data-first-offset="true"><span data-slate-string="true">, DA_386IGate, hxi_hwint03, PRIVILEGE_KRNL);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11776"><span data-slate-object="text" data-key="11777"><span data-slate-leaf="true" data-offset-key="11777:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11778"><span data-slate-leaf="true" data-offset-key="11778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 篇幅所限，未全部展示</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11779"><span data-slate-object="text" data-key="11780"><span data-slate-leaf="true" data-offset-key="11780:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="11781"><span data-slate-leaf="true" data-offset-key="11781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11782"><span data-slate-leaf="true" data-offset-key="11782:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11783"><span data-slate-object="text" data-key="11784"><span data-slate-leaf="true" data-offset-key="11784:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11785"><span data-slate-object="text" data-key="11786"><span data-slate-leaf="true" data-offset-key="11786:0" data-first-offset="true"><span data-slate-string="true">上面的代码已经很明显了，一开始把所有中断的处理程序设置为保留的通用处理程序，避免未知中断异常发生了 CPU 无处可去，然后对已知的中断和异常进一步设置，这会覆盖之前的通用处理程序，这样就可以确保万无一失。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11787"><span data-slate-object="text" data-key="11788"><span data-slate-leaf="true" data-offset-key="11788:0" data-first-offset="true"><span data-slate-string="true">下面我们把这些代码整理一下，安装到具体的调用路径上，让上层调用者调用到就好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11789"><span data-slate-object="text" data-key="11790"><span data-slate-leaf="true" data-offset-key="11790:0" data-first-offset="true"><span data-slate-string="true">我们依然在 halintupt.c 文件中写上 init_halintupt () 函数：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="11791"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11792"><span data-slate-object="text" data-key="11793"><span data-slate-leaf="true" data-offset-key="11793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11794"><span data-slate-leaf="true" data-offset-key="11794:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11795"><span data-slate-leaf="true" data-offset-key="11795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_halintupt</span></span></span></span><span data-slate-object="text" data-key="11796"><span data-slate-leaf="true" data-offset-key="11796:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="11797"><span data-slate-leaf="true" data-offset-key="11797:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11798"><span data-slate-object="text" data-key="11799"><span data-slate-leaf="true" data-offset-key="11799:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11800"><span data-slate-object="text" data-key="11801"><span data-slate-leaf="true" data-offset-key="11801:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11802"><span data-slate-leaf="true" data-offset-key="11802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_idt_descriptor</span></span></span></span><span data-slate-object="text" data-key="11803"><span data-slate-leaf="true" data-offset-key="11803:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11804"><span data-slate-object="text" data-key="11805"><span data-slate-leaf="true" data-offset-key="11805:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11806"><span data-slate-leaf="true" data-offset-key="11806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_intfltdsc</span></span></span></span><span data-slate-object="text" data-key="11807"><span data-slate-leaf="true" data-offset-key="11807:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11808"><span data-slate-object="text" data-key="11809"><span data-slate-leaf="true" data-offset-key="11809:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11810"><span data-slate-leaf="true" data-offset-key="11810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11811"><span data-slate-leaf="true" data-offset-key="11811:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11812"><span data-slate-object="text" data-key="11813"><span data-slate-leaf="true" data-offset-key="11813:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11814"><span data-slate-object="text" data-key="11815"><span data-slate-leaf="true" data-offset-key="11815:0" data-first-offset="true"><span data-slate-string="true">到此为止，CPU 体系层面的中断就初始化完成了。你会发现，我们在 init_halintupt () 函数中还调用了 </span></span></span><span data-slate-object="text" data-key="11816"><span data-slate-leaf="true" data-offset-key="11816:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">init_intfltdsc () 函数</span></span></span></span><span data-slate-object="text" data-key="11817"><span data-slate-leaf="true" data-offset-key="11817:0" data-first-offset="true"><span data-slate-string="true">，这个函数是干什么的呢？请往下看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11818"><span data-slate-object="text" data-key="11819"><span data-slate-leaf="true" data-offset-key="11819:0" data-first-offset="true"><span data-slate-string="true">我们先来设计一下 Cosmos 的中断处理框架，后面我们把中断和异常统称为中断，因为它们的处理方式相同。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11820"><span data-slate-object="text" data-key="11821"><span data-slate-leaf="true" data-offset-key="11821:0" data-first-offset="true"><span data-slate-string="true">前面我们只是解决了中断的 CPU 相关部分，而 CPU 只是响应中断，但是并不能解决产生中断的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11822"><span data-slate-object="text" data-key="11823"><span data-slate-leaf="true" data-offset-key="11823:0" data-first-offset="true"><span data-slate-string="true">比如缺页中断来了，我们要解决内存地址映射关系，程序才可以继续运行。再比如硬盘中断来了，我们要读取硬盘的数据，要处理这问题，就要写好相应的处理函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11824"><span data-slate-object="text" data-key="11825"><span data-slate-leaf="true" data-offset-key="11825:0" data-first-offset="true"><span data-slate-string="true">因为有些处理是内核所提供的，而有些处理函数是设备驱动提供的，想让它们和中断关联起来，就要好好设计</span></span></span><span data-slate-object="text" data-key="11826"><span data-slate-leaf="true" data-offset-key="11826:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">中断处理框架</span></span></span></span><span data-slate-object="text" data-key="11827"><span data-slate-leaf="true" data-offset-key="11827:0" data-first-offset="true"><span data-slate-string="true">了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11828"><span data-slate-object="text" data-key="11829"><span data-slate-leaf="true" data-offset-key="11829:0" data-first-offset="true"><span data-slate-string="true">下面我们来画幅图，描述中断框架的设计：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="11830"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/fd/7a/fd2cd9e5b63cd7e52cd68b65e81aee7a.jpg?wh=4705*2362"></div><div>中断框架设计图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11831"><span data-slate-object="text" data-key="11832"><span data-slate-leaf="true" data-offset-key="11832:0" data-first-offset="true"><span data-slate-string="true">可以看到，中断、异常分发器的左侧的东西我们已经处理完成，下面需要写好中断、异常分发器和中断异常描述符。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11833"><span data-slate-object="text" data-key="11834"><span data-slate-leaf="true" data-offset-key="11834:0" data-first-offset="true"><span data-slate-string="true">我们先来搞定中断异常描述，结合框架图，中断异常描述也是个表，它在 C 语言中就是个结构数组，让我们一起来写好这个数组：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11835"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11836"><span data-slate-object="text" data-key="11837"><span data-slate-leaf="true" data-offset-key="11837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11838"><span data-slate-leaf="true" data-offset-key="11838:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11839"><span data-slate-leaf="true" data-offset-key="11839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11840"><span data-slate-leaf="true" data-offset-key="11840:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11841"><span data-slate-leaf="true" data-offset-key="11841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_INTFLTDSC</span></span></span></span><span data-slate-object="text" data-key="11842"><span data-slate-leaf="true" data-offset-key="11842:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11843"><span data-slate-object="text" data-key="11844"><span data-slate-leaf="true" data-offset-key="11844:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11845"><span data-slate-leaf="true" data-offset-key="11845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="11846"><span data-slate-leaf="true" data-offset-key="11846:0" data-first-offset="true"><span data-slate-string="true">  i_lock;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11847"><span data-slate-object="text" data-key="11848"><span data-slate-leaf="true" data-offset-key="11848:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11849"><span data-slate-leaf="true" data-offset-key="11849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11850"><span data-slate-leaf="true" data-offset-key="11850:0" data-first-offset="true"><span data-slate-string="true">       i_flg;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11851"><span data-slate-object="text" data-key="11852"><span data-slate-leaf="true" data-offset-key="11852:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11853"><span data-slate-leaf="true" data-offset-key="11853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11854"><span data-slate-leaf="true" data-offset-key="11854:0" data-first-offset="true"><span data-slate-string="true">       i_stus;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11855"><span data-slate-object="text" data-key="11856"><span data-slate-leaf="true" data-offset-key="11856:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11857"><span data-slate-leaf="true" data-offset-key="11857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11858"><span data-slate-leaf="true" data-offset-key="11858:0" data-first-offset="true"><span data-slate-string="true">      i_prity;        </span></span></span><span data-slate-object="text" data-key="11859"><span data-slate-leaf="true" data-offset-key="11859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断优先级    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11860"><span data-slate-object="text" data-key="11861"><span data-slate-leaf="true" data-offset-key="11861:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11862"><span data-slate-leaf="true" data-offset-key="11862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11863"><span data-slate-leaf="true" data-offset-key="11863:0" data-first-offset="true"><span data-slate-string="true">      i_irqnr;        </span></span></span><span data-slate-object="text" data-key="11864"><span data-slate-leaf="true" data-offset-key="11864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断号    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11865"><span data-slate-object="text" data-key="11866"><span data-slate-leaf="true" data-offset-key="11866:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11867"><span data-slate-leaf="true" data-offset-key="11867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11868"><span data-slate-leaf="true" data-offset-key="11868:0" data-first-offset="true"><span data-slate-string="true">      i_deep;         </span></span></span><span data-slate-object="text" data-key="11869"><span data-slate-leaf="true" data-offset-key="11869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断嵌套深度    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11870"><span data-slate-object="text" data-key="11871"><span data-slate-leaf="true" data-offset-key="11871:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11872"><span data-slate-leaf="true" data-offset-key="11872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="11873"><span data-slate-leaf="true" data-offset-key="11873:0" data-first-offset="true"><span data-slate-string="true">       i_indx;         </span></span></span><span data-slate-object="text" data-key="11874"><span data-slate-leaf="true" data-offset-key="11874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断计数    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11875"><span data-slate-object="text" data-key="11876"><span data-slate-leaf="true" data-offset-key="11876:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11877"><span data-slate-leaf="true" data-offset-key="11877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11878"><span data-slate-leaf="true" data-offset-key="11878:0" data-first-offset="true"><span data-slate-string="true">    i_serlist;      </span></span></span><span data-slate-object="text" data-key="11879"><span data-slate-leaf="true" data-offset-key="11879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 也可以使用中断回调函数的方式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11880"><span data-slate-object="text" data-key="11881"><span data-slate-leaf="true" data-offset-key="11881:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11882"><span data-slate-leaf="true" data-offset-key="11882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11883"><span data-slate-leaf="true" data-offset-key="11883:0" data-first-offset="true"><span data-slate-string="true">      i_sernr;        </span></span></span><span data-slate-object="text" data-key="11884"><span data-slate-leaf="true" data-offset-key="11884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断回调函数个数   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11885"><span data-slate-object="text" data-key="11886"><span data-slate-leaf="true" data-offset-key="11886:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11887"><span data-slate-leaf="true" data-offset-key="11887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11888"><span data-slate-leaf="true" data-offset-key="11888:0" data-first-offset="true"><span data-slate-string="true">    i_serthrdlst;   </span></span></span><span data-slate-object="text" data-key="11889"><span data-slate-leaf="true" data-offset-key="11889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断线程链表头    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11890"><span data-slate-object="text" data-key="11891"><span data-slate-leaf="true" data-offset-key="11891:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11892"><span data-slate-leaf="true" data-offset-key="11892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11893"><span data-slate-leaf="true" data-offset-key="11893:0" data-first-offset="true"><span data-slate-string="true">      i_serthrdnr;    </span></span></span><span data-slate-object="text" data-key="11894"><span data-slate-leaf="true" data-offset-key="11894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断线程个数    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11895"><span data-slate-object="text" data-key="11896"><span data-slate-leaf="true" data-offset-key="11896:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11897"><span data-slate-leaf="true" data-offset-key="11897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11898"><span data-slate-leaf="true" data-offset-key="11898:0" data-first-offset="true"><span data-slate-string="true">*       i_onethread;    </span></span></span><span data-slate-object="text" data-key="11899"><span data-slate-leaf="true" data-offset-key="11899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 只有一个中断线程时直接用指针    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11900"><span data-slate-object="text" data-key="11901"><span data-slate-leaf="true" data-offset-key="11901:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11902"><span data-slate-leaf="true" data-offset-key="11902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11903"><span data-slate-leaf="true" data-offset-key="11903:0" data-first-offset="true"><span data-slate-string="true">*       i_rbtreeroot;   </span></span></span><span data-slate-object="text" data-key="11904"><span data-slate-leaf="true" data-offset-key="11904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果中断线程太多则按优先级组成红黑树</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11905"><span data-slate-object="text" data-key="11906"><span data-slate-leaf="true" data-offset-key="11906:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11907"><span data-slate-leaf="true" data-offset-key="11907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11908"><span data-slate-leaf="true" data-offset-key="11908:0" data-first-offset="true"><span data-slate-string="true">    i_serfisrlst;      </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11909"><span data-slate-object="text" data-key="11910"><span data-slate-leaf="true" data-offset-key="11910:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11911"><span data-slate-leaf="true" data-offset-key="11911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11912"><span data-slate-leaf="true" data-offset-key="11912:0" data-first-offset="true"><span data-slate-string="true">      i_serfisrnr;       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11913"><span data-slate-object="text" data-key="11914"><span data-slate-leaf="true" data-offset-key="11914:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11915"><span data-slate-leaf="true" data-offset-key="11915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11916"><span data-slate-leaf="true" data-offset-key="11916:0" data-first-offset="true"><span data-slate-string="true">*       i_msgmpool;     </span></span></span><span data-slate-object="text" data-key="11917"><span data-slate-leaf="true" data-offset-key="11917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 可能的中断消息池    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11918"><span data-slate-object="text" data-key="11919"><span data-slate-leaf="true" data-offset-key="11919:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11920"><span data-slate-leaf="true" data-offset-key="11920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11921"><span data-slate-leaf="true" data-offset-key="11921:0" data-first-offset="true"><span data-slate-string="true">*       i_privp;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11922"><span data-slate-object="text" data-key="11923"><span data-slate-leaf="true" data-offset-key="11923:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11924"><span data-slate-leaf="true" data-offset-key="11924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11925"><span data-slate-leaf="true" data-offset-key="11925:0" data-first-offset="true"><span data-slate-string="true">*       i_extp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11926"><span data-slate-object="text" data-key="11927"><span data-slate-leaf="true" data-offset-key="11927:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="11928"><span data-slate-leaf="true" data-offset-key="11928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="11929"><span data-slate-leaf="true" data-offset-key="11929:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11930"><span data-slate-object="text" data-key="11931"><span data-slate-leaf="true" data-offset-key="11931:0" data-first-offset="true"><span data-slate-string="true">上面结构中，记录了中断的优先级。因为有些中断可以稍后执行，而有的中断需要紧急执行，所以要设计一个优先级。其中还有中断号，中断计数等统计信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11932"><span data-slate-object="text" data-key="11933"><span data-slate-leaf="true" data-offset-key="11933:0" data-first-offset="true"><span data-slate-string="true">中断可以由线程的方式执行，也可以是一个回调函数，该函数的地址放另一个结构体中，这个结构体我已经帮你写好了，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11934"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11935"><span data-slate-object="text" data-key="11936"><span data-slate-leaf="true" data-offset-key="11936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span></span><span data-slate-object="text" data-key="11937"><span data-slate-leaf="true" data-offset-key="11937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11938"><span data-slate-leaf="true" data-offset-key="11938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="11939"><span data-slate-leaf="true" data-offset-key="11939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11940"><span data-slate-leaf="true" data-offset-key="11940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(*</span></span></span></span></span><span data-slate-object="text" data-key="11941"><span data-slate-leaf="true" data-offset-key="11941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intflthandle_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11942"><span data-slate-leaf="true" data-offset-key="11942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="11943"><span data-slate-leaf="true" data-offset-key="11943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="11944"><span data-slate-leaf="true" data-offset-key="11944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="11945"><span data-slate-leaf="true" data-offset-key="11945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ift_nr,</span></span></span></span></span><span data-slate-object="text" data-key="11946"><span data-slate-leaf="true" data-offset-key="11946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="11947"><span data-slate-leaf="true" data-offset-key="11947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* device,</span></span></span></span></span><span data-slate-object="text" data-key="11948"><span data-slate-leaf="true" data-offset-key="11948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="11949"><span data-slate-leaf="true" data-offset-key="11949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* sframe)</span></span></span></span></span><span data-slate-object="text" data-key="11950"><span data-slate-leaf="true" data-offset-key="11950:0" data-first-offset="true"><span data-slate-string="true">; </span></span></span><span data-slate-object="text" data-key="11951"><span data-slate-leaf="true" data-offset-key="11951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断处理函数的指针类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11952"><span data-slate-object="text" data-key="11953"><span data-slate-leaf="true" data-offset-key="11953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="11954"><span data-slate-leaf="true" data-offset-key="11954:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11955"><span data-slate-leaf="true" data-offset-key="11955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11956"><span data-slate-leaf="true" data-offset-key="11956:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11957"><span data-slate-leaf="true" data-offset-key="11957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_INTSERDSC</span></span></span></span><span data-slate-object="text" data-key="11958"><span data-slate-leaf="true" data-offset-key="11958:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11959"><span data-slate-object="text" data-key="11960"><span data-slate-leaf="true" data-offset-key="11960:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11961"><span data-slate-leaf="true" data-offset-key="11961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11962"><span data-slate-leaf="true" data-offset-key="11962:0" data-first-offset="true"><span data-slate-string="true">    s_list;        </span></span></span><span data-slate-object="text" data-key="11963"><span data-slate-leaf="true" data-offset-key="11963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在中断异常描述符中的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11964"><span data-slate-object="text" data-key="11965"><span data-slate-leaf="true" data-offset-key="11965:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11966"><span data-slate-leaf="true" data-offset-key="11966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="11967"><span data-slate-leaf="true" data-offset-key="11967:0" data-first-offset="true"><span data-slate-string="true">    s_indevlst;    </span></span></span><span data-slate-object="text" data-key="11968"><span data-slate-leaf="true" data-offset-key="11968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在设备描述描述符中的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11969"><span data-slate-object="text" data-key="11970"><span data-slate-leaf="true" data-offset-key="11970:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11971"><span data-slate-leaf="true" data-offset-key="11971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="11972"><span data-slate-leaf="true" data-offset-key="11972:0" data-first-offset="true"><span data-slate-string="true">       s_flg;        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11973"><span data-slate-object="text" data-key="11974"><span data-slate-leaf="true" data-offset-key="11974:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11975"><span data-slate-leaf="true" data-offset-key="11975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="11976"><span data-slate-leaf="true" data-offset-key="11976:0" data-first-offset="true"><span data-slate-string="true">* s_intfltp;    </span></span></span><span data-slate-object="text" data-key="11977"><span data-slate-leaf="true" data-offset-key="11977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向中断异常描述符 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11978"><span data-slate-object="text" data-key="11979"><span data-slate-leaf="true" data-offset-key="11979:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11980"><span data-slate-leaf="true" data-offset-key="11980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="11981"><span data-slate-leaf="true" data-offset-key="11981:0" data-first-offset="true"><span data-slate-string="true">*       s_device;      </span></span></span><span data-slate-object="text" data-key="11982"><span data-slate-leaf="true" data-offset-key="11982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向设备描述符</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11983"><span data-slate-object="text" data-key="11984"><span data-slate-leaf="true" data-offset-key="11984:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11985"><span data-slate-leaf="true" data-offset-key="11985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="11986"><span data-slate-leaf="true" data-offset-key="11986:0" data-first-offset="true"><span data-slate-string="true">      s_indx;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11987"><span data-slate-object="text" data-key="11988"><span data-slate-leaf="true" data-offset-key="11988:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11989"><span data-slate-leaf="true" data-offset-key="11989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intflthandle_t</span></span></span></span><span data-slate-object="text" data-key="11990"><span data-slate-leaf="true" data-offset-key="11990:0" data-first-offset="true"><span data-slate-string="true"> s_handle;   </span></span></span><span data-slate-object="text" data-key="11991"><span data-slate-leaf="true" data-offset-key="11991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断处理的回调函数指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11992"><span data-slate-object="text" data-key="11993"><span data-slate-leaf="true" data-offset-key="11993:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="11994"><span data-slate-leaf="true" data-offset-key="11994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="11995"><span data-slate-leaf="true" data-offset-key="11995:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11996"><span data-slate-object="text" data-key="11997"><span data-slate-leaf="true" data-offset-key="11997:0" data-first-offset="true"><span data-slate-string="true">如果内核或者设备驱动程序要安装一个中断处理函数，就要先申请一个 intserdsc_t 结构体，然后把中断函数的地址写入其中，最后把这个结构挂载到对应的 intfltdsc_t 结构中的 i_serlist 链表中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11998"><span data-slate-object="text" data-key="11999"><span data-slate-leaf="true" data-offset-key="11999:0" data-first-offset="true"><span data-slate-string="true">你可能要问了，为什么不能直接把中断处理函数放在 intfltdsc_t 结构中呢，还要多此一举搞个 intserdsc_t 结构体呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12000"><span data-slate-object="text" data-key="12001"><span data-slate-leaf="true" data-offset-key="12001:0" data-first-offset="true"><span data-slate-string="true">这是因为我们的计算机中可能有很多设备，每个设备都可能产生中断，但是中断控制器的中断信号线是有限的。你可以这样理解：中断控制器最多只能产生几十号中断号，而设备不止几十个，所以会有多个设备共享一根中断信号线。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12002"><span data-slate-object="text" data-key="12003"><span data-slate-leaf="true" data-offset-key="12003:0" data-first-offset="true"><span data-slate-string="true">这就导致一个中断发生后，无法确定是哪个设备产生的中断，所以我们干脆让设备驱动程序来决定，因为它是最了解设备的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12004"><span data-slate-object="text" data-key="12005"><span data-slate-leaf="true" data-offset-key="12005:0" data-first-offset="true"><span data-slate-string="true">这里我们让这个 intfltdsc_t 结构上的所有中断处理函数都依次执行，查看是不是自己的设备产生了中断，如果是就处理，不是则略过。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12006"><span data-slate-object="text" data-key="12007"><span data-slate-leaf="true" data-offset-key="12007:0" data-first-offset="true"><span data-slate-string="true">好，明白了这两个结构之后，我们就要开始初始化了。首先是在 halglobal.c 文件定义 intfltdsc_t 结构。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12008"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12009"><span data-slate-object="text" data-key="12010"><span data-slate-leaf="true" data-offset-key="12010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义 intfltdsc_t 结构数组大小为 256</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12011"><span data-slate-object="text" data-key="12012"><span data-slate-leaf="true" data-offset-key="12012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HAL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="12013"><span data-slate-leaf="true" data-offset-key="12013:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12014"><span data-slate-leaf="true" data-offset-key="12014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="12015"><span data-slate-leaf="true" data-offset-key="12015:0" data-first-offset="true"><span data-slate-string="true">,machintflt)[IDTMAX];</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12016"><span data-slate-object="text" data-key="12017"><span data-slate-leaf="true" data-offset-key="12017:0" data-first-offset="true"><span data-slate-string="true">下面我们再来实现中断、异常分发器函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12018"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12019"><span data-slate-object="text" data-key="12020"><span data-slate-leaf="true" data-offset-key="12020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断处理函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12021"><span data-slate-object="text" data-key="12022"><span data-slate-leaf="true" data-offset-key="12022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="12023"><span data-slate-leaf="true" data-offset-key="12023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12024"><span data-slate-leaf="true" data-offset-key="12024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_do_hwint</span></span></span></span></span><span data-slate-object="text" data-key="12025"><span data-slate-leaf="true" data-offset-key="12025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12026"><span data-slate-leaf="true" data-offset-key="12026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12027"><span data-slate-leaf="true" data-offset-key="12027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> intnumb, </span></span></span></span></span><span data-slate-object="text" data-key="12028"><span data-slate-leaf="true" data-offset-key="12028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12029"><span data-slate-leaf="true" data-offset-key="12029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *krnlsframp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12030"><span data-slate-object="text" data-key="12031"><span data-slate-leaf="true" data-offset-key="12031:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12032"><span data-slate-object="text" data-key="12033"><span data-slate-leaf="true" data-offset-key="12033:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12034"><span data-slate-leaf="true" data-offset-key="12034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="12035"><span data-slate-leaf="true" data-offset-key="12035:0" data-first-offset="true"><span data-slate-string="true"> *ifdscp = </span></span></span><span data-slate-object="text" data-key="12036"><span data-slate-leaf="true" data-offset-key="12036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12037"><span data-slate-leaf="true" data-offset-key="12037:0" data-first-offset="true"><span data-slate-string="true">;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12038"><span data-slate-object="text" data-key="12039"><span data-slate-leaf="true" data-offset-key="12039:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12040"><span data-slate-leaf="true" data-offset-key="12040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpuflg_t</span></span></span></span><span data-slate-object="text" data-key="12041"><span data-slate-leaf="true" data-offset-key="12041:0" data-first-offset="true"><span data-slate-string="true"> cpuflg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12042"><span data-slate-object="text" data-key="12043"><span data-slate-leaf="true" data-offset-key="12043:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12044"><span data-slate-leaf="true" data-offset-key="12044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据中断号获取中断异常描述符地址    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12045"><span data-slate-object="text" data-key="12046"><span data-slate-leaf="true" data-offset-key="12046:0" data-first-offset="true"><span data-slate-string="true">    ifdscp = </span></span></span><span data-slate-object="text" data-key="12047"><span data-slate-leaf="true" data-offset-key="12047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_intfltdsc</span></span></span></span><span data-slate-object="text" data-key="12048"><span data-slate-leaf="true" data-offset-key="12048:0" data-first-offset="true"><span data-slate-string="true">(intnumb);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12049"><span data-slate-object="text" data-key="12050"><span data-slate-leaf="true" data-offset-key="12050:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12051"><span data-slate-leaf="true" data-offset-key="12051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对断异常描述符加锁并中断    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12052"><span data-slate-object="text" data-key="12053"><span data-slate-leaf="true" data-offset-key="12053:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12054"><span data-slate-leaf="true" data-offset-key="12054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_spinlock_saveflg_cli</span></span></span></span><span data-slate-object="text" data-key="12055"><span data-slate-leaf="true" data-offset-key="12055:0" data-first-offset="true"><span data-slate-string="true">(&amp;ifdscp-&gt;i_lock, &amp;cpuflg);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12056"><span data-slate-object="text" data-key="12057"><span data-slate-leaf="true" data-offset-key="12057:0" data-first-offset="true"><span data-slate-string="true">    ifdscp-&gt;i_indx++;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12058"><span data-slate-object="text" data-key="12059"><span data-slate-leaf="true" data-offset-key="12059:0" data-first-offset="true"><span data-slate-string="true">    ifdscp-&gt;i_deep++;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12060"><span data-slate-object="text" data-key="12061"><span data-slate-leaf="true" data-offset-key="12061:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12062"><span data-slate-leaf="true" data-offset-key="12062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行中断处理的回调函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12063"><span data-slate-object="text" data-key="12064"><span data-slate-leaf="true" data-offset-key="12064:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12065"><span data-slate-leaf="true" data-offset-key="12065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_run_intflthandle</span></span></span></span><span data-slate-object="text" data-key="12066"><span data-slate-leaf="true" data-offset-key="12066:0" data-first-offset="true"><span data-slate-string="true">(intnumb, krnlsframp);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12067"><span data-slate-object="text" data-key="12068"><span data-slate-leaf="true" data-offset-key="12068:0" data-first-offset="true"><span data-slate-string="true">    ifdscp-&gt;i_deep--;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12069"><span data-slate-object="text" data-key="12070"><span data-slate-leaf="true" data-offset-key="12070:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12071"><span data-slate-leaf="true" data-offset-key="12071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁并恢复中断状态    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12072"><span data-slate-object="text" data-key="12073"><span data-slate-leaf="true" data-offset-key="12073:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12074"><span data-slate-leaf="true" data-offset-key="12074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_spinunlock_restflg_sti</span></span></span></span><span data-slate-object="text" data-key="12075"><span data-slate-leaf="true" data-offset-key="12075:0" data-first-offset="true"><span data-slate-string="true">(&amp;ifdscp-&gt;i_lock, &amp;cpuflg);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12076"><span data-slate-object="text" data-key="12077"><span data-slate-leaf="true" data-offset-key="12077:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12078"><span data-slate-leaf="true" data-offset-key="12078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12079"><span data-slate-leaf="true" data-offset-key="12079:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12080"><span data-slate-object="text" data-key="12081"><span data-slate-leaf="true" data-offset-key="12081:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12082"><span data-slate-object="text" data-key="12083"><span data-slate-leaf="true" data-offset-key="12083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 异常分发器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12084"><span data-slate-object="text" data-key="12085"><span data-slate-leaf="true" data-offset-key="12085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="12086"><span data-slate-leaf="true" data-offset-key="12086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12087"><span data-slate-leaf="true" data-offset-key="12087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_fault_allocator</span></span></span></span></span><span data-slate-object="text" data-key="12088"><span data-slate-leaf="true" data-offset-key="12088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12089"><span data-slate-leaf="true" data-offset-key="12089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12090"><span data-slate-leaf="true" data-offset-key="12090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> faultnumb, </span></span></span></span></span><span data-slate-object="text" data-key="12091"><span data-slate-leaf="true" data-offset-key="12091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12092"><span data-slate-leaf="true" data-offset-key="12092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *krnlsframp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12093"><span data-slate-object="text" data-key="12094"><span data-slate-leaf="true" data-offset-key="12094:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12095"><span data-slate-object="text" data-key="12096"><span data-slate-leaf="true" data-offset-key="12096:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12097"><span data-slate-leaf="true" data-offset-key="12097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 我们的异常处理回调函数也是放在中断异常描述符中的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12098"><span data-slate-object="text" data-key="12099"><span data-slate-leaf="true" data-offset-key="12099:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12100"><span data-slate-leaf="true" data-offset-key="12100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_do_hwint</span></span></span></span><span data-slate-object="text" data-key="12101"><span data-slate-leaf="true" data-offset-key="12101:0" data-first-offset="true"><span data-slate-string="true">(faultnumb, krnlsframp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12102"><span data-slate-object="text" data-key="12103"><span data-slate-leaf="true" data-offset-key="12103:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12104"><span data-slate-leaf="true" data-offset-key="12104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12105"><span data-slate-leaf="true" data-offset-key="12105:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12106"><span data-slate-object="text" data-key="12107"><span data-slate-leaf="true" data-offset-key="12107:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12108"><span data-slate-object="text" data-key="12109"><span data-slate-leaf="true" data-offset-key="12109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断分发器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12110"><span data-slate-object="text" data-key="12111"><span data-slate-leaf="true" data-offset-key="12111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="12112"><span data-slate-leaf="true" data-offset-key="12112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12113"><span data-slate-leaf="true" data-offset-key="12113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_hwint_allocator</span></span></span></span></span><span data-slate-object="text" data-key="12114"><span data-slate-leaf="true" data-offset-key="12114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12115"><span data-slate-leaf="true" data-offset-key="12115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12116"><span data-slate-leaf="true" data-offset-key="12116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> intnumb, </span></span></span></span></span><span data-slate-object="text" data-key="12117"><span data-slate-leaf="true" data-offset-key="12117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12118"><span data-slate-leaf="true" data-offset-key="12118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *krnlsframp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12119"><span data-slate-object="text" data-key="12120"><span data-slate-leaf="true" data-offset-key="12120:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12121"><span data-slate-object="text" data-key="12122"><span data-slate-leaf="true" data-offset-key="12122:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12123"><span data-slate-leaf="true" data-offset-key="12123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_do_hwint</span></span></span></span><span data-slate-object="text" data-key="12124"><span data-slate-leaf="true" data-offset-key="12124:0" data-first-offset="true"><span data-slate-string="true">(intnumb, krnlsframp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12125"><span data-slate-object="text" data-key="12126"><span data-slate-leaf="true" data-offset-key="12126:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12127"><span data-slate-leaf="true" data-offset-key="12127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12128"><span data-slate-leaf="true" data-offset-key="12128:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12129"><span data-slate-object="text" data-key="12130"><span data-slate-leaf="true" data-offset-key="12130:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12131"><span data-slate-object="text" data-key="12132"><span data-slate-leaf="true" data-offset-key="12132:0" data-first-offset="true"><span data-slate-string="true">前面的代码确实是按照我们的中断框架设计实现的，下面我们去实现 hal_run_intflthandle 函数，它负责调用中断处理的回调函数。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12133"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12134"><span data-slate-object="text" data-key="12135"><span data-slate-leaf="true" data-offset-key="12135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="12136"><span data-slate-leaf="true" data-offset-key="12136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12137"><span data-slate-leaf="true" data-offset-key="12137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_run_intflthandle</span></span></span></span></span><span data-slate-object="text" data-key="12138"><span data-slate-leaf="true" data-offset-key="12138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12139"><span data-slate-leaf="true" data-offset-key="12139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12140"><span data-slate-leaf="true" data-offset-key="12140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ifdnr, </span></span></span></span></span><span data-slate-object="text" data-key="12141"><span data-slate-leaf="true" data-offset-key="12141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12142"><span data-slate-leaf="true" data-offset-key="12142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *sframe)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12143"><span data-slate-object="text" data-key="12144"><span data-slate-leaf="true" data-offset-key="12144:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12145"><span data-slate-object="text" data-key="12146"><span data-slate-leaf="true" data-offset-key="12146:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12147"><span data-slate-leaf="true" data-offset-key="12147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="12148"><span data-slate-leaf="true" data-offset-key="12148:0" data-first-offset="true"><span data-slate-string="true"> *isdscp;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12149"><span data-slate-object="text" data-key="12150"><span data-slate-leaf="true" data-offset-key="12150:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12151"><span data-slate-leaf="true" data-offset-key="12151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="12152"><span data-slate-leaf="true" data-offset-key="12152:0" data-first-offset="true"><span data-slate-string="true"> *lst;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12153"><span data-slate-object="text" data-key="12154"><span data-slate-leaf="true" data-offset-key="12154:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12155"><span data-slate-leaf="true" data-offset-key="12155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据中断号获取中断异常描述符地址    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12156"><span data-slate-object="text" data-key="12157"><span data-slate-leaf="true" data-offset-key="12157:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12158"><span data-slate-leaf="true" data-offset-key="12158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="12159"><span data-slate-leaf="true" data-offset-key="12159:0" data-first-offset="true"><span data-slate-string="true"> *ifdscp = </span></span></span><span data-slate-object="text" data-key="12160"><span data-slate-leaf="true" data-offset-key="12160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_intfltdsc</span></span></span></span><span data-slate-object="text" data-key="12161"><span data-slate-leaf="true" data-offset-key="12161:0" data-first-offset="true"><span data-slate-string="true">(ifdnr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12162"><span data-slate-object="text" data-key="12163"><span data-slate-leaf="true" data-offset-key="12163:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12164"><span data-slate-leaf="true" data-offset-key="12164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历 i_serlist 链表    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12165"><span data-slate-object="text" data-key="12166"><span data-slate-leaf="true" data-offset-key="12166:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12167"><span data-slate-leaf="true" data-offset-key="12167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_for_each</span></span></span></span><span data-slate-object="text" data-key="12168"><span data-slate-leaf="true" data-offset-key="12168:0" data-first-offset="true"><span data-slate-string="true">(lst, &amp;ifdscp-&gt;i_serlist)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12169"><span data-slate-object="text" data-key="12170"><span data-slate-leaf="true" data-offset-key="12170:0" data-first-offset="true"><span data-slate-string="true">    {   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12171"><span data-slate-object="text" data-key="12172"><span data-slate-leaf="true" data-offset-key="12172:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12173"><span data-slate-leaf="true" data-offset-key="12173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 i_serlist 链表上对象即 intserdsc_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12174"><span data-slate-object="text" data-key="12175"><span data-slate-leaf="true" data-offset-key="12175:0" data-first-offset="true"><span data-slate-string="true">        isdscp = </span></span></span><span data-slate-object="text" data-key="12176"><span data-slate-leaf="true" data-offset-key="12176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_entry</span></span></span></span><span data-slate-object="text" data-key="12177"><span data-slate-leaf="true" data-offset-key="12177:0" data-first-offset="true"><span data-slate-string="true">(lst, </span></span></span><span data-slate-object="text" data-key="12178"><span data-slate-leaf="true" data-offset-key="12178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="12179"><span data-slate-leaf="true" data-offset-key="12179:0" data-first-offset="true"><span data-slate-string="true">, s_list);  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12180"><span data-slate-object="text" data-key="12181"><span data-slate-leaf="true" data-offset-key="12181:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12182"><span data-slate-leaf="true" data-offset-key="12182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用中断处理回调函数      </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12183"><span data-slate-object="text" data-key="12184"><span data-slate-leaf="true" data-offset-key="12184:0" data-first-offset="true"><span data-slate-string="true">        isdscp-&gt;</span></span></span><span data-slate-object="text" data-key="12185"><span data-slate-leaf="true" data-offset-key="12185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_handle</span></span></span></span><span data-slate-object="text" data-key="12186"><span data-slate-leaf="true" data-offset-key="12186:0" data-first-offset="true"><span data-slate-string="true">(ifdnr, isdscp-&gt;s_device, sframe);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12187"><span data-slate-object="text" data-key="12188"><span data-slate-leaf="true" data-offset-key="12188:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12189"><span data-slate-object="text" data-key="12190"><span data-slate-leaf="true" data-offset-key="12190:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12191"><span data-slate-leaf="true" data-offset-key="12191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12192"><span data-slate-leaf="true" data-offset-key="12192:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12193"><span data-slate-object="text" data-key="12194"><span data-slate-leaf="true" data-offset-key="12194:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12195"><span data-slate-object="text" data-key="12196"><span data-slate-leaf="true" data-offset-key="12196:0" data-first-offset="true"><span data-slate-string="true">上述代码已经很清楚了，循环遍历 intfltdsc_t 结构中，i_serlist 链表上所有挂载的 intserdsc_t 结构，然后调用 intserdsc_t 结构中的中断处理的回调函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12197"><span data-slate-object="text" data-key="12198"><span data-slate-leaf="true" data-offset-key="12198:0" data-first-offset="true"><span data-slate-string="true">我们 Cosmos 链表借用了 Linux 所用的链表，代码我已经帮你写好了，放在了 list.h 和 list_t.h 文件中，请自行查看。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="12199" id="sr-toc-6"><span data-slate-object="text" data-key="12200"><span data-slate-leaf="true" data-offset-key="12200:0" data-first-offset="true"><span data-slate-string="true">初始化中断控制器</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="12201"><span data-slate-object="text" data-key="12202"><span data-slate-leaf="true" data-offset-key="12202:0" data-first-offset="true"><span data-slate-string="true">我们把 CPU 端的中断搞定了以后，还有设备端的中断，这个可以交给设备驱动程序，但是 CPU 和设备之间的中断控制器，还需要我们出面解决。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12203"><span data-slate-object="text" data-key="12204"><span data-slate-leaf="true" data-offset-key="12204:0" data-first-offset="true"><span data-slate-string="true">多个设备的中断信号线都会连接到中断控制器上，中断控制器可以决定启用或者屏蔽哪些设备的中断，还可以决定设备中断之间的优先线，所以它才叫中断控制器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12205"><span data-slate-object="text" data-key="12206"><span data-slate-leaf="true" data-offset-key="12206:0" data-first-offset="true"><span data-slate-string="true">x86 平台上的中断控制器有多种，最开始是 8259A，然后是 IOAPIC，最新的是 MSI-X。为了简单的说明原理，我们选择了 8259A 中断控制器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12207"><span data-slate-object="text" data-key="12208"><span data-slate-leaf="true" data-offset-key="12208:0" data-first-offset="true"><span data-slate-string="true">8259A 在任何 x86 平台上都可以使用，x86 平台使用了两片 8259A 芯片，以级联的方式存在。它拥有 15 个中断源（即可以有 15 个中断信号接入）。让我们看看 8259A 在系统上的框架图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12209"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/4d/09/4d81f7feb668abf30c5cced619549709.jpg?wh=3808*2164"></div><div>8259A 在系统上的框架图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12210"><span data-slate-object="text" data-key="12211"><span data-slate-leaf="true" data-offset-key="12211:0" data-first-offset="true"><span data-slate-string="true">上面直接和 CPU 连接的是主 8259A，下面的是从 8259A，每一个 8259A 芯片都有两个 I/O 端口，我们可以通过它们对 8259A 进行编程。主 8259A 的端口地址是 0x20，0x21；从 8259A 的端口地址是 0xA0，0xA1。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12212"><span data-slate-object="text" data-key="12213"><span data-slate-leaf="true" data-offset-key="12213:0" data-first-offset="true"><span data-slate-string="true">下面我们来做代码初始化，我们程序员可以向 8259A 写两种命令字： ICW 和 OCW；ICW 这种命令字用来实现 8259a 芯片的初始化。而 OCW 这种命令用来向 8259A 发布命令，以对其进行控制。OCW 可以在 8259A 被初始化之后的任何时候被使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12214"><span data-slate-object="text" data-key="12215"><span data-slate-leaf="true" data-offset-key="12215:0" data-first-offset="true"><span data-slate-string="true">我已经把代码定好了，放在了 8259.c 文件中，如下所示：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="12216"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12217"><span data-slate-object="text" data-key="12218"><span data-slate-leaf="true" data-offset-key="12218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12219"><span data-slate-leaf="true" data-offset-key="12219:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12220"><span data-slate-leaf="true" data-offset-key="12220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_i8259</span></span></span></span><span data-slate-object="text" data-key="12221"><span data-slate-leaf="true" data-offset-key="12221:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12222"><span data-slate-leaf="true" data-offset-key="12222:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12223"><span data-slate-object="text" data-key="12224"><span data-slate-leaf="true" data-offset-key="12224:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12225"><span data-slate-object="text" data-key="12226"><span data-slate-leaf="true" data-offset-key="12226:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12227"><span data-slate-leaf="true" data-offset-key="12227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化主从 8259a</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12228"><span data-slate-object="text" data-key="12229"><span data-slate-leaf="true" data-offset-key="12229:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12230"><span data-slate-leaf="true" data-offset-key="12230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12231"><span data-slate-leaf="true" data-offset-key="12231:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12232"><span data-slate-leaf="true" data-offset-key="12232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZIOPT</span></span></span></span><span data-slate-object="text" data-key="12233"><span data-slate-leaf="true" data-offset-key="12233:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12234"><span data-slate-leaf="true" data-offset-key="12234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ICW1</span></span></span></span><span data-slate-object="text" data-key="12235"><span data-slate-leaf="true" data-offset-key="12235:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12236"><span data-slate-object="text" data-key="12237"><span data-slate-leaf="true" data-offset-key="12237:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12238"><span data-slate-leaf="true" data-offset-key="12238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12239"><span data-slate-leaf="true" data-offset-key="12239:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12240"><span data-slate-leaf="true" data-offset-key="12240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SIOPT</span></span></span></span><span data-slate-object="text" data-key="12241"><span data-slate-leaf="true" data-offset-key="12241:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12242"><span data-slate-leaf="true" data-offset-key="12242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ICW1</span></span></span></span><span data-slate-object="text" data-key="12243"><span data-slate-leaf="true" data-offset-key="12243:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12244"><span data-slate-object="text" data-key="12245"><span data-slate-leaf="true" data-offset-key="12245:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12246"><span data-slate-leaf="true" data-offset-key="12246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12247"><span data-slate-leaf="true" data-offset-key="12247:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12248"><span data-slate-leaf="true" data-offset-key="12248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZIOPT1</span></span></span></span><span data-slate-object="text" data-key="12249"><span data-slate-leaf="true" data-offset-key="12249:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12250"><span data-slate-leaf="true" data-offset-key="12250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZICW2</span></span></span></span><span data-slate-object="text" data-key="12251"><span data-slate-leaf="true" data-offset-key="12251:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12252"><span data-slate-object="text" data-key="12253"><span data-slate-leaf="true" data-offset-key="12253:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12254"><span data-slate-leaf="true" data-offset-key="12254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12255"><span data-slate-leaf="true" data-offset-key="12255:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12256"><span data-slate-leaf="true" data-offset-key="12256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SIOPT1</span></span></span></span><span data-slate-object="text" data-key="12257"><span data-slate-leaf="true" data-offset-key="12257:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12258"><span data-slate-leaf="true" data-offset-key="12258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SICW2</span></span></span></span><span data-slate-object="text" data-key="12259"><span data-slate-leaf="true" data-offset-key="12259:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12260"><span data-slate-object="text" data-key="12261"><span data-slate-leaf="true" data-offset-key="12261:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12262"><span data-slate-leaf="true" data-offset-key="12262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12263"><span data-slate-leaf="true" data-offset-key="12263:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12264"><span data-slate-leaf="true" data-offset-key="12264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZIOPT1</span></span></span></span><span data-slate-object="text" data-key="12265"><span data-slate-leaf="true" data-offset-key="12265:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12266"><span data-slate-leaf="true" data-offset-key="12266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZICW3</span></span></span></span><span data-slate-object="text" data-key="12267"><span data-slate-leaf="true" data-offset-key="12267:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12268"><span data-slate-object="text" data-key="12269"><span data-slate-leaf="true" data-offset-key="12269:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12270"><span data-slate-leaf="true" data-offset-key="12270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12271"><span data-slate-leaf="true" data-offset-key="12271:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12272"><span data-slate-leaf="true" data-offset-key="12272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SIOPT1</span></span></span></span><span data-slate-object="text" data-key="12273"><span data-slate-leaf="true" data-offset-key="12273:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12274"><span data-slate-leaf="true" data-offset-key="12274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SICW3</span></span></span></span><span data-slate-object="text" data-key="12275"><span data-slate-leaf="true" data-offset-key="12275:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12276"><span data-slate-object="text" data-key="12277"><span data-slate-leaf="true" data-offset-key="12277:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12278"><span data-slate-leaf="true" data-offset-key="12278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12279"><span data-slate-leaf="true" data-offset-key="12279:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12280"><span data-slate-leaf="true" data-offset-key="12280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZIOPT1</span></span></span></span><span data-slate-object="text" data-key="12281"><span data-slate-leaf="true" data-offset-key="12281:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12282"><span data-slate-leaf="true" data-offset-key="12282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ICW4</span></span></span></span><span data-slate-object="text" data-key="12283"><span data-slate-leaf="true" data-offset-key="12283:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12284"><span data-slate-object="text" data-key="12285"><span data-slate-leaf="true" data-offset-key="12285:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12286"><span data-slate-leaf="true" data-offset-key="12286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12287"><span data-slate-leaf="true" data-offset-key="12287:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12288"><span data-slate-leaf="true" data-offset-key="12288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SIOPT1</span></span></span></span><span data-slate-object="text" data-key="12289"><span data-slate-leaf="true" data-offset-key="12289:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12290"><span data-slate-leaf="true" data-offset-key="12290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ICW4</span></span></span></span><span data-slate-object="text" data-key="12291"><span data-slate-leaf="true" data-offset-key="12291:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12292"><span data-slate-object="text" data-key="12293"><span data-slate-leaf="true" data-offset-key="12293:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12294"><span data-slate-leaf="true" data-offset-key="12294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 屏蔽全部中断源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12295"><span data-slate-object="text" data-key="12296"><span data-slate-leaf="true" data-offset-key="12296:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12297"><span data-slate-leaf="true" data-offset-key="12297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12298"><span data-slate-leaf="true" data-offset-key="12298:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12299"><span data-slate-leaf="true" data-offset-key="12299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZIOPT1</span></span></span></span><span data-slate-object="text" data-key="12300"><span data-slate-leaf="true" data-offset-key="12300:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12301"><span data-slate-leaf="true" data-offset-key="12301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xff</span></span></span></span><span data-slate-object="text" data-key="12302"><span data-slate-leaf="true" data-offset-key="12302:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12303"><span data-slate-object="text" data-key="12304"><span data-slate-leaf="true" data-offset-key="12304:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12305"><span data-slate-leaf="true" data-offset-key="12305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out_u8_p</span></span></span></span><span data-slate-object="text" data-key="12306"><span data-slate-leaf="true" data-offset-key="12306:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12307"><span data-slate-leaf="true" data-offset-key="12307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SIOPT1</span></span></span></span><span data-slate-object="text" data-key="12308"><span data-slate-leaf="true" data-offset-key="12308:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="12309"><span data-slate-leaf="true" data-offset-key="12309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xff</span></span></span></span><span data-slate-object="text" data-key="12310"><span data-slate-leaf="true" data-offset-key="12310:0" data-first-offset="true"><span data-slate-string="true">);        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12311"><span data-slate-object="text" data-key="12312"><span data-slate-leaf="true" data-offset-key="12312:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12313"><span data-slate-leaf="true" data-offset-key="12313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12314"><span data-slate-leaf="true" data-offset-key="12314:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12315"><span data-slate-object="text" data-key="12316"><span data-slate-leaf="true" data-offset-key="12316:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12317"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12318"><span data-slate-object="text" data-key="12319"><span data-slate-leaf="true" data-offset-key="12319:0" data-first-offset="true"><span data-slate-string="true">如果你要了解 8259A 的细节，就是上述代码中为什么要写入这些数据，你可以自己在 Intel 官方网站上搜索 8259A 的数据手册，自行查看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12320"><span data-slate-object="text" data-key="12321"><span data-slate-leaf="true" data-offset-key="12321:0" data-first-offset="true"><span data-slate-string="true">这里你只要在 init_halintupt () 函数的最后，调用这个函数就行。你有没有想过，既然我们是研究操作系统不是要写硬件驱动，为什么要在初始化中断控制器后，屏蔽所有的中断源呢？因为我们 Cosmos 在初始化阶段还不能处理中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12322"><span data-slate-object="text" data-key="12323"><span data-slate-leaf="true" data-offset-key="12323:0" data-first-offset="true"><span data-slate-string="true">到此，我们的 Cosmos 的 hal 层初始化就结束了。关于内存管理器的初始化，我会在内存管理模块讲解，你先有个印象就行。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12324" id="sr-toc-7"><span data-slate-object="text" data-key="12325"><span data-slate-leaf="true" data-offset-key="12325:0" data-first-offset="true"><span data-slate-string="true">进入内核层</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12326"><span data-slate-object="text" data-key="12327"><span data-slate-leaf="true" data-offset-key="12327:0" data-first-offset="true"><span data-slate-string="true">hal 层的初始化已经完成，按照前面的设计，我们的 Cosmos 还有内核层，我们下面就要进入到内核层，建立一个文件，写上一个函数，作为本课程的结尾。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12328"><span data-slate-object="text" data-key="12329"><span data-slate-leaf="true" data-offset-key="12329:0" data-first-offset="true"><span data-slate-string="true">但是这个函数是个</span></span></span><span data-slate-object="text" data-key="12330"><span data-slate-leaf="true" data-offset-key="12330:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">空函数</span></span></span></span><span data-slate-object="text" data-key="12331"><span data-slate-leaf="true" data-offset-key="12331:0" data-first-offset="true"><span data-slate-string="true">，目前什么也不做，它是为 Cosmos 内核层初始化而存在的，但是由于课程只进行到这里，所以我只是写个空函数，为后面的课程做好准备。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12332"><span data-slate-object="text" data-key="12333"><span data-slate-leaf="true" data-offset-key="12333:0" data-first-offset="true"><span data-slate-string="true">由于内核层是从 hal 层进入的，必须在 hal_start () 函数中被调用，所以在此完成这个函数 ——init_krl ()。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="12334"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12335"><span data-slate-object="text" data-key="12336"><span data-slate-leaf="true" data-offset-key="12336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12337"><span data-slate-leaf="true" data-offset-key="12337:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12338"><span data-slate-leaf="true" data-offset-key="12338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krl</span></span></span></span><span data-slate-object="text" data-key="12339"><span data-slate-leaf="true" data-offset-key="12339:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12340"><span data-slate-leaf="true" data-offset-key="12340:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12341"><span data-slate-object="text" data-key="12342"><span data-slate-leaf="true" data-offset-key="12342:0" data-first-offset="true"><span data-slate-string="true">{ </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12343"><span data-slate-object="text" data-key="12344"><span data-slate-leaf="true" data-offset-key="12344:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12345"><span data-slate-leaf="true" data-offset-key="12345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 禁止函数返回    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12346"><span data-slate-object="text" data-key="12347"><span data-slate-leaf="true" data-offset-key="12347:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12348"><span data-slate-leaf="true" data-offset-key="12348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">die</span></span></span></span><span data-slate-object="text" data-key="12349"><span data-slate-leaf="true" data-offset-key="12349:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12350"><span data-slate-leaf="true" data-offset-key="12350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12351"><span data-slate-leaf="true" data-offset-key="12351:0" data-first-offset="true"><span data-slate-string="true">);    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12352"><span data-slate-object="text" data-key="12353"><span data-slate-leaf="true" data-offset-key="12353:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12354"><span data-slate-leaf="true" data-offset-key="12354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12355"><span data-slate-leaf="true" data-offset-key="12355:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12356"><span data-slate-object="text" data-key="12357"><span data-slate-leaf="true" data-offset-key="12357:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12358"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12359"><span data-slate-object="text" data-key="12360"><span data-slate-leaf="true" data-offset-key="12360:0" data-first-offset="true"><span data-slate-string="true">下面我们在 hal_start () 函数中调用它就行了，如下所示</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="12361"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12362"><span data-slate-object="text" data-key="12363"><span data-slate-leaf="true" data-offset-key="12363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12364"><span data-slate-leaf="true" data-offset-key="12364:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12365"><span data-slate-leaf="true" data-offset-key="12365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_start</span></span></span></span><span data-slate-object="text" data-key="12366"><span data-slate-leaf="true" data-offset-key="12366:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12367"><span data-slate-leaf="true" data-offset-key="12367:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12368"><span data-slate-object="text" data-key="12369"><span data-slate-leaf="true" data-offset-key="12369:0" data-first-offset="true"><span data-slate-string="true">{   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12370"><span data-slate-object="text" data-key="12371"><span data-slate-leaf="true" data-offset-key="12371:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12372"><span data-slate-leaf="true" data-offset-key="12372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 Cosmos 的 hal 层 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12373"><span data-slate-object="text" data-key="12374"><span data-slate-leaf="true" data-offset-key="12374:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12375"><span data-slate-leaf="true" data-offset-key="12375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_hal</span></span></span></span><span data-slate-object="text" data-key="12376"><span data-slate-leaf="true" data-offset-key="12376:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12377"><span data-slate-object="text" data-key="12378"><span data-slate-leaf="true" data-offset-key="12378:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12379"><span data-slate-leaf="true" data-offset-key="12379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 Cosmos 的内核层    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12380"><span data-slate-object="text" data-key="12381"><span data-slate-leaf="true" data-offset-key="12381:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12382"><span data-slate-leaf="true" data-offset-key="12382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krl</span></span></span></span><span data-slate-object="text" data-key="12383"><span data-slate-leaf="true" data-offset-key="12383:0" data-first-offset="true"><span data-slate-string="true">();    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12384"><span data-slate-object="text" data-key="12385"><span data-slate-leaf="true" data-offset-key="12385:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12386"><span data-slate-leaf="true" data-offset-key="12386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12387"><span data-slate-leaf="true" data-offset-key="12387:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12388"><span data-slate-object="text" data-key="12389"><span data-slate-leaf="true" data-offset-key="12389:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12390"><span data-slate-object="text" data-key="12391"><span data-slate-leaf="true" data-offset-key="12391:0" data-first-offset="true"><span data-slate-string="true">从上面的代码中，不难发现 Cosmos 的 hal 层初始化完成后，就自动进入了 Cosmos 内核层的初始化。至此本课程已经结束。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12392" id="sr-toc-8"><span data-slate-object="text" data-key="12393"><span data-slate-leaf="true" data-offset-key="12393:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12394"><span data-slate-object="text" data-key="12395"><span data-slate-leaf="true" data-offset-key="12395:0" data-first-offset="true"><span data-slate-string="true">写一个 C 函数是容易的，但是写操作系统的第一个 C 函数并不容易，好在我们一路坚持，没有放弃，才取得了这个阶段性的胜利。但温故而知新，对学过的东西要学而时习之，下面我们来回顾一下本课程的重点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12396"><span data-slate-object="text" data-key="12397"><span data-slate-leaf="true" data-offset-key="12397:0" data-first-offset="true"><span data-slate-string="true">1.Cosmos 的第一个 C 函数产生了，它十分简单但极其有意义，它的出现标志着 C 语言的运行环境已经完善。从此我们可以用 C 语言高效地开发操作系统了，由爬行时代进入了跑步前行的状态，可喜可贺。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12398"><span data-slate-object="text" data-key="12399"><span data-slate-leaf="true" data-offset-key="12399:0" data-first-offset="true"><span data-slate-string="true">2. 第一个 C 函数，干的第一件重要工作就是</span></span></span><span data-slate-object="text" data-key="12400"><span data-slate-leaf="true" data-offset-key="12400:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">调用 hal 层的初始化函数。</span></span></span></span><span data-slate-object="text" data-key="12401"><span data-slate-leaf="true" data-offset-key="12401:0" data-first-offset="true"><span data-slate-string="true">这个初始化函数首先初始化了平台，初始化了机器信息结构供内核的其它代码使用，还初始化了我们图形显示驱动、显示了背景图片；其次是初始化了内存管理相关的数据结构；接着初始了中断，中断处理框架是两层，所以最为复杂；最后初始化了中断控制器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12402"><span data-slate-object="text" data-key="12403"><span data-slate-leaf="true" data-offset-key="12403:0" data-first-offset="true"><span data-slate-string="true">3. 当 hal 层初始化完成了，我们就进入了内核层，由于到了课程的尾声，我们先暂停在这里。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12404"><span data-slate-object="text" data-key="12405"><span data-slate-leaf="true" data-offset-key="12405:0" data-first-offset="true"><span data-slate-string="true">在这节课里我帮你写了很多代码，那些代码非常简单和枯燥，但是必须要有它们才可以。综合我们前面讲过的知识，我相信你有能力看懂它们。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12406" id="sr-toc-9"><span data-slate-object="text" data-key="12407"><span data-slate-leaf="true" data-offset-key="12407:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12408"><span data-slate-object="text" data-key="12409"><span data-slate-leaf="true" data-offset-key="12409:0" data-first-offset="true"><span data-slate-string="true">请你梳理一下，Cosmos hal 层的函数调用关系。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12410"><span data-slate-object="text" data-key="12411"><span data-slate-leaf="true" data-offset-key="12411:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我交流互动，也欢迎把这节课转发给你的朋友和同事。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12412"><span data-slate-object="text" data-key="12413"><span data-slate-leaf="true" data-offset-key="12413:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，咱们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>16</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (28)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/46/6b/e766c18d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>老王</span></div></div><div>有了前面基础实验很快就做通了，只是实验步骤课程没有说
1. 下载最新源码
git clone https://gitee.com/lmos/cosmos.git
2 进入课程的目录 
cd   cosmos/lesson13/Cosmos 
3 编译
make all
这个过程中可能会报告错误
../hal/x86/kernel.asm:6: fatal: unable to open include file `kernel.inc'krnlbuidrule.mk:14: recipe for target'kernel.o' failed
make [2]: *** [kernel.o] Error 1
Makefile.x86:28: recipe for target 'all' failed
make [1]: *** [all] Error 2
Makefile:59: recipe for target 'all' failed
make: *** [all] Error 2
警告不管
解决错误即可
使用 find -name "kernel.inc" 搜索头文件的位置
./include/halinc/kernel.inc
把这个头文件拷贝到和 kernel.asm 相同的目录。或者是更改../hal/x86/kernel.asm
第 6 行 改为 % include "../include/halinc/kernel.inc"
再次 make 可以正常编译
4. 生成内核镜像文件
make cplmildr    （这一步会拷贝  initldrimh.bin  initldrkrl.bin initldrsve.bin 到源码顶层目录的 release 下 ）
make cprelease   （这一步会拷贝 Cosmos.bin 到源码顶层目录的 release 下 ）
make KIMG （这一步会调用 lmoskrlimg 把 initldrimh.bin initldrkrl.bin initldrsve.bin 
Cosmos.bin logo.bmp background.bmp   font.fnt 按一定的格式打包成 Cosmos.eki 镜像文件 ）
5. 拷贝 Cosmos.eki 镜像文件到虚拟磁盘
源码目录已经创建了磁盘文件 hd.img（如果没有这个文件可以按照前面的课程自己创建）
sudo mount -o loop ./hd.img ./hdisk/ (挂载虚拟磁盘到 hidsk 目录，hd.img hidsk 目录已经存在)
sudo cp release/Cosmos.eki  hdisk/boot  (拷贝编译好的镜像 Cosmos.eki 到虚拟磁盘中)
sudo umount hdisk  (卸载挂载目录 / 或者是目录和磁盘中的内容)
VBoxManage convertfromraw ./hd.img --format VDI ./hd.vdi (把 hd.img 转为 hd.vdi 格式，因为课程使用的虚拟机是 VirtualBox)
6. 参考前面课程使用 hd.vdi 启动系统
 
总结：
要想搞清楚整个程序的流程，除了分析代码本身，还需要深入分析 Makefile 和各个链接脚本</div><div><p>编辑回复：感谢老铁的分享，特别赞。</p></div><div><div>2021-06-07</div><div><div><i></i><span>8</span></div><div><i></i><span>33</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>稍微整理了一下：

一、HAL 层调用链
hal_start ()

A、先去处理 HAL 层的初始化
-&gt;init_hal ()

-&gt;-&gt;init_halplaltform () 初始化平台
-&gt;-&gt;-&gt;init_machbstart ()
主要是把二级引导器建立的机器信息结构，复制到了 hal 层一份给内核使用，同时也为释放二级引导器占用内存做好准备。
其做法就是拷贝了一份 mbsp 到 kmbsp，其中用到了虚拟地址转换 hyadr_to_viradr
-&gt;-&gt;-&gt;init_bdvideo ()
初始化图形机构
初始化 BGA 显卡 或 VBE 图形显卡信息【函数指针的使用】
清空屏幕
找到 "background.bmp"，并显示背景图片
-&gt;-&gt;-&gt;-&gt;hal_dspversion（）
输出版本号等信息【vsprintfk】
其中，用 ret_charsinfo 根据字体文件获取字符像素信息

-&gt;-&gt;move_img2maxpadr ()
将移动 initldrsve.bin 到最大地址

-&gt;-&gt;init_halmm () 初始化内存
-&gt;-&gt;-&gt;init_phymmarge
申请 phymmarge_t 内存
根据 e820map_t 结构数组，复制数据到 phymmarge_t 结构数组
按内存开始地址进行排序

-&gt;-&gt;init_halintupt (); 初始化中断
-&gt;-&gt;-&gt;init_descriptor (); 初始化 GDT 描述符 x64_gdt
-&gt;-&gt;-&gt;init_idt_descriptor (); 初始化 IDT 描述符 x64_idt，绑定了中断编号及中断处理函数
-&gt;-&gt;-&gt;init_intfltdsc (); 初始化中断异常表 machintflt，拷贝了中断相关信息
-&gt;-&gt;-&gt;init_i8259 (); 初始化 8529 芯片中断
-&gt;-&gt;-&gt;i8259_enabled_line (0); 好像是取消 mask，开启中断请求

最后，跳转去处理内核初始化
-&gt;init_krl ()

二、中断调用链，以硬件中断为例
A、kernel.inc 中，通过宏定义，进行了中断定义。以硬件中断为例，可以在 kernel.inc 中看到：
宏为 HARWINT，硬件中断分发器函数为 hal_hwint_allocator
% macro  HARWINT 1
    保存现场......
    mov   rdi, %1
    mov   rsi,rsp
    call    hal_hwint_allocator
    恢复现场......
% endmacro

B、而在 kernel.asm 中，定义了各种硬件中断编号，比如 hxi_hwint00，作为中断处理入口
ALIGN   16
hxi_hwint00:
    HARWINT (INT_VECTOR_IRQ0+0)

C、有硬件中断时，会先到达中断处理入口，然后调用到硬件中断分发器函数 hal_hwint_allocator
第一个参数为中断编号，在 rdi
第二个参数为中断发生时的栈指针，在 rsi
然后调用异常处理函数 hal_do_hwint

D、hal_do_hwint
加锁
调用中断回调函数 hal_run_intflthandle
释放锁

E、hal_run_intflthandle
先获取中断异常表 machintflt
然后调用 i_serlist 链表上所有挂载 intserdsc_t 结构中的中断处理的回调函数，是否处理由函数自己判断

F、中断处理完毕

G、异常处理类似，只是触发源头不太一样而已</div><div><p>作者回复：老哥 6666</p></div><div><div>2021-06-08</div><div><div><i></i><span>2</span></div><div><i></i><span>14</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>[hal_start] --&gt; [ init_hal ] --&gt; [ init_krl ]
[ init_hal ] --&gt; [ init_halplaltform ] --&gt; [ move_img2maxpadr ] --&gt; [ init_halmm ] --&gt; [ init_halintupt ]
[ init_krl ] --&gt; [ die ]
[ init_halplaltform ] --&gt; [ init_machbstart ] --&gt; [ init_bdvideo ]
[ init_halmm ] --&gt; [ init_phymmarge ]
[ init_halintupt ] --&gt; [ init_descriptor ] --&gt; [ init_idt_descriptor ] --&gt; [ init_intfltdsc ] --&gt; [ init_i8259 ] --&gt; [ i8259_enabled_line ]


如果有 graph-easy 的同学，直接 CV，然后：
```sh
graph-easy calltree.txt
```</div><div><p>作者回复：铁汁牛皮</p></div><div><div>2021-06-07</div><div><div><i></i><span>3</span></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/49/11/75a31d88.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>LunaElf</span></div></div><div>Cosmos hal 层函数调用关系：

1. `hal_start ()`
    1. `init_hal ()`
        1. `init_halplatform ()`
            1. `init_machbstart ()`
                1. `machbstart_t_init ()`
            2. `init_bdvideo ()`
        2. `init_halmm ()`
            1. `init_phymmarge ()`
                1. `initpmrge_core ()`
        3. `init_halintupt ()`
            1. `init_idt_descriptor ()`
                1. `set_idt_desc ()`
            2. `init_intfltdsc ()`
            3. `init_i8259 ()`
    2. `init_krl ()`

1. `hal_fault_allocator ()`
    1. `hal_do_hwint ()`
        1. `hal_run_intflthandle ()`

1. `hal_hwint_allocator ()`
    1. `hal_do_hwint ()`
        1. `hal_run_intflthandle ()`</div><div><p>作者回复: 66666</p></div><div><div>2021-10-19</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/84/4a/50940078.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 卢承灏</span></div></div><div>有一个问题，回过头来二刷的时候没想明白，如果中断传递的只是一个中断号，然后中断号是进行共用的，那在 hal_run_intflthandle 中的 list_for_each 中，每个设备注册的 handler 方法，怎么判断自己需不需要执行呢？ handler 传入的 s-&gt;device 也是从循环中的每一个 intserdsc_t 取出，和最开始的中断号看不出中什么关联。还希望大神们解答</div><div><p>作者回复：中断共享 需要设备驱动程序自己处理</p></div><div><div>2021-09-07</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/66/11/f7408e3e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 云师兄</span></div></div><div>太硬了啊，有点磕牙，不过再咬两口试试😬</div><div><p>编辑回复：哈哈哈，舌尖上的操作系统，老铁加油！</p></div><div><div>2021-06-09</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/24/ae/64/98ef557d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 然</span></div></div><div>很好奇 move_img2maxpadr (&amp;kmachbsp); 这个函数
功能：move_img2maxpadr (&amp;kmachbsp); 这个函数是把镜像文件搬到最大的物理地址处。
作用：我感觉是因为镜像文件是加载在 0x4000000 处，而空闲地址是从内核文件加载处开始计算的（0x2000000 + 内核大小）, 随着内存的分配，空闲地址不断向上增长，迟早会覆盖镜像文件，所以提前把镜像文件搬走了。</div><div><p>作者回复：对，你理解的很正确</p></div><div><div>2021-06-07</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/34/1d/405b113e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Victor</span></div></div><div>在 ubuntu 18.04 环境下 make 时报错：
root@ubuntu1804:~/LMOS/cosmos/lesson13/Cosmos# make all
Initldr: 清理全部已构建文件... ^_^
********* 正在开始编译构建系统 *************
AS -[M] 正在构建... ../ldrkrl/imginithead.asm
CC -[M] 正在构建... ../ldrkrl/inithead.c
CC -[M] 正在构建... ../ldrkrl/vgastr.c
AS -[M] 正在构建... ../ldrkrl/ldrkrl32.asm
CC -[M] 正在构建... ../ldrkrl/ldrkrlentry.c
CC -[M] 正在构建... ../ldrkrl/fs.c
CC -[M] 正在构建... ../ldrkrl/chkcpmm.c
CC -[M] 正在构建... ../ldrkrl/graph.c
CC -[M] 正在构建... ../ldrkrl/bstartparm.c
AS -[M] 正在构建... ../ldrkrl/realintsve.asm
OBJCOPY -[M] 正在构建... initldrimh.bin
OBJCOPY -[M] 正在构建... initldrkrl.bin
OBJCOPY -[M] 正在构建... initldrsve.bin
恭喜我，Initldr 编译构建完成！ ^_^
../hal/x86/kernel.asm:6: fatal: unable to open include file `kernel.inc'krnlbuidrule.mk:14: recipe for target'kernel.o' failed
make [2]: *** [kernel.o] Error 1
Makefile.x86:28: recipe for target 'all' failed
make [1]: *** [all] Error 2
Makefile:59: recipe for target 'all' failed
make: *** [all] Error 2</div><div><p>作者回复：是不是下载 的完整代码 </p></div><div><div>2021-06-07</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 艾恩凝</span></div></div><div>终于快走到内核了，上个月 24 号到现在，进度有点慢，先放下脚步，有些小地方理解不透，看到评论越来越少，我就知道，能坚持下来的人真的不多，可能自己菜，我一个科班出身的感觉都有点吃力，底层那些东西还是很生疏，这门课真的无敌，干货真的很多，需要自己慢慢体会，理解 + 实战 yyds</div><div><p>作者回复: 6666</p></div><div><div>2022-04-08</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/58/dc/7334e6ef.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 逝水</span></div></div><div>init_idt_descriptor 最后会调用 load_x64_idt，通过汇编调用 lidt 方法，将 x64_idt 的地址到 IDTR 寄存器，使得中断门描述符发挥作用。
想了半天内存中的 x64_idt 是怎么发挥作用的，原来这里调用了汇编。</div><div><p>作者回复：是的  是的 </p></div><div><div>2021-12-17</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f4/48/2242bed9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 吴建平</span></div></div><div>代码走查出一个安全问题，下面这个函数里，如果 for 里一个满足条件的都没找到，那么后面校验的时候
retemp-&gt;saddr 就空指针了。
e820map_t *ret_kmaxmpadrcmpsz_e820map (machbstart_t *mbsp, u64_t mappadr, u64_t cpsz)
{
    if (NULL == mbsp)
    {
        return NULL;
    }
    u64_t enr = mbsp-&gt;mb_e820nr;
    e820map_t *emp = (e820map_t *) phyadr_to_viradr ((adr_t) mbsp-&gt;mb_e820padr);
    e820map_t *retemp = NULL;
    u64_t maxadr = emp [0].saddr;
    for (u64_t i = 0; i &lt; enr; i++)
    {
        if (emp [i].type == RAM_USABLE)
        {
            if (emp [i].saddr &gt;= maxadr &amp;&amp;                              // 内存区首地址大于已知最大区域起始地址（初始化位第一个区首地址
               (mappadr &gt; (emp [i].saddr + emp [i].lsize)) &amp;&amp;            // 内存区尾地址小于内存映射最大地址
               (emp [i].lsize &gt;= cpsz))                                 // 内存区大小大于镜像文件大小
            {
                maxadr = emp [i].saddr;                                 // 已知最大区域起始地址
                retemp = &amp;emp [i];                                      // 更新最后满足条件内存区域
            }
        }
    }
    if ((mappadr &gt; (retemp-&gt;saddr + retemp-&gt;lsize)) &amp;&amp; (retemp-&gt;lsize &gt;= cpsz)) // 校验，但除非一个都不满足条件
    {
        return retemp;
    }
    return NULL;
}
</div><div><p>作者回复：对的 厉害了 找出了 BUG</p></div><div><div>2021-07-01</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/67/94/cc1cbccd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 寻道客小林</span></div></div><div>日拱一卒 - Day04 
有种本科时学 8051，lpc1114 的感觉，第一遍还是搞清楚流程，不要在乎细节，先建立一个整体的框架。</div><div><p>编辑回复：先抓主干，后看细节，你的学习方法很好。</p></div><div><div>2021-06-07</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/09/97/a13db556.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 徐旭</span></div></div><div>启动报错 INITKLDR DIE ERROR:S  , 不知道是不是 和 物理机 cpu (Intel (R) Core (TM) i7-10700F CPU @ 2.90GHz   2.90 GHz) 有关 (详情见截图:  http://t.csdn.cn/tN2Vz)</div><div><p>作者回复：应该不是 cpu 的问题 </p></div><div><div>2022-07-06</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/9f/be/14b2ad2e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>卖薪沽酒</span></div></div><div>不简单， 来来回回来到了 13 课程， 关于课后问题， 习惯用 ximd 梳理， 有兴趣的同学可以看看，一起加油 https://www.cnblogs.com/iwssea/p/16383412.html</div><div><p>作者回复：很强</p></div><div><div>2022-06-16</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/5f/09/2ec44412.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Qfeng</span></div></div><div>hal_start ()
    init_hal ()    // 初始化硬件抽象层
        init_halplaltform ()    // 初始化平台相关
            init_machbstart ()    // 将 grub 启动阶段得到的机器信息结构体 machbstart_t 拷贝一份到 hal 全局 machbstart_t 中，以便后续 hal 使用
            init_bdvideo ()    // 初始化显卡驱动（基于 hal 全局 machbstart_t 里面的信息）
        move_img2maxpadr ()
        init_halmm ()    // 初始化内存管理
            init_phymmarge ()  // 根据引导阶段获得的内存信息 -- e820map_t 结构数组，hal 扩张建立了自己的内存管理结构 -- phymmarge_t 结构数组，将 e820map_t 结构数组的信息拷贝了过来
        init_halintupt ()    //hal 中断初始化
            init_descriptor ()    // 设置中断 GDT 描述符
            init_idt_descriptor ()    // 设置中断 IDT 描述符：将中断处理程序的入口地址与对应的中断 / 异常类型 vector 绑定
            init_intfltdsc ()    // 初始化中断管理结构体：管理中断的类型，分发，处理优先级等
            init_i8259 ()    // 初始化中断控制器 i8259
            i8259_enabled_line ()
    init_krl ()    // 初始化内核：死循环

这节内容确实很多，不过有一条主线，就是前面引导器阶段收集准备好的机器信息结构体 -- MBSPADR ((machbstart_t*)(0x100000))，这里的 hal 初始化的信息都是来自于此，我理解这是引导器如此不可或缺的原因之一，他做了必不可少的准备工作。</div><div><p>作者回复：是的，你理解的很正确</p></div><div><div>2022-05-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/9f/be/14b2ad2e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>卖薪沽酒</span></div></div><div>我还在</div><div><p>作者回复：还在干什么</p></div><div><div>2022-05-09</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/ea/82/f44cbd20.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>申龙青</span></div></div><div>hal 层可以隔离不同芯片平台架构，那不同芯片平台架构下 BIOS 有区别，导致的 GRUB2 这套二级引导器是不是也不同？</div><div><p>作者回复：是的 也不同的</p></div><div><div>2021-12-31</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_03885e</span></div></div><div>其他的都好理解， 就是为什么出去旅游不带女朋友呢？</div><div><p>编辑回复：华生，你发现了盲点😄。</p></div><div><div>2021-12-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/a2/1b/7426e629.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>178</span></div></div><div>hal 层的初始化和二级引导器的初始化，之间有什么区别和联系，愚蠢的我居然认为是是同样的事做了两遍？</div><div><p>作者回复：当然 不是 </p></div><div><div>2021-12-01</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/a2/1b/7426e629.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>178</span></div></div><div>1. 新建 Cosmos 虚拟机（与第 10 课，同样类型的虚拟机，只是名不同）
2. 执行 make vboxtest
问题：只出现黑底百花的 Cosmos，为什么没有背景图片和打印机器信息呢，百撕不得骑姐</div><div><p>作者回复：可能是虚拟机设置有问题 </p></div><div><div>2021-11-28</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".17"><outline class="toc-level-h1" data-reactid=".17.0" style="width: 175px;"><active data-reactid=".17.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".17.0.1"><span data-reactid=".17.0.1.0">13 | 第一个 C 函数：如何实现板级初始化？</span></a></outline><outline class="toc-level-h2" data-reactid=".17.1" style="width: 165px;"><active data-reactid=".17.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".17.1.1"><span data-reactid=".17.1.1.0">第一个 C 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".17.2" style="width: 155px;"><active data-reactid=".17.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".17.2.1"><span data-reactid=".17.2.1.0">hal 层初始化</span></a></outline><outline class="toc-level-h4" data-reactid=".17.3" style="width: 145px;"><active data-reactid=".17.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".17.3.1"><span data-reactid=".17.3.1.0">初始化平台</span></a></outline><outline class="toc-level-h4" data-reactid=".17.4" style="width: 145px;"><active data-reactid=".17.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".17.4.1"><span data-reactid=".17.4.1.0">初始化内存</span></a></outline><outline class="toc-level-h4" data-reactid=".17.5" style="width: 145px;"><active data-reactid=".17.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".17.5.1"><span data-reactid=".17.5.1.0">初始化中断</span></a></outline><outline class="toc-level-h4" data-reactid=".17.6" style="width: 145px;"><active data-reactid=".17.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".17.6.1"><span data-reactid=".17.6.1.0">初始化中断控制器</span></a></outline><outline class="toc-level-h3" data-reactid=".17.7" style="width: 155px;"><active data-reactid=".17.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".17.7.1"><span data-reactid=".17.7.1.0">进入内核层</span></a></outline><outline class="toc-level-h2" data-reactid=".17.8" style="width: 165px;"><active data-reactid=".17.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".17.8.1"><span data-reactid=".17.8.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".17.9" style="width: 165px;"><active data-reactid=".17.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".17.9.1"><span data-reactid=".17.9.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".17.a" style="width: 165px;"><active data-reactid=".17.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".17.a.1"><span data-reactid=".17.a.1.0">精选留言 (28)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/381810" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>