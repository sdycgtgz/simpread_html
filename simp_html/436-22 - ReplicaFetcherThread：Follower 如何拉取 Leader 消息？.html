
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 22 | ReplicaFetcherThread：Follower 如何拉取 Leader 消息？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>22 | ReplicaFetcherThread：Follower 如何拉取 Leader 消息？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">学完了今天的课程之后，你不但能够说出 4 种 Leader 选举的场景，还能总结出它们的共性。对于面试来说，绝对是个加分项！</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">22 | ReplicaFetcherThread：Follower 如何拉取 Leader 消息？</h1><div><span>胡夕</span> <span> 2020-06-16</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/02/8e/02e5ce89b52ab7ef118f7fc3a7e5068e.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：16.91M</span><span> 时长：18:28</span></div></div><audio title="22 | ReplicaFetcherThread：Follower如何拉取Leader消息？" src="https://res001.geekbang.org//media/audio/9e/4a/9e6f81c79b024e1b5eb4a92a0373fd4a/ld/ld.m3u8" __idm_id__="57349"></audio></div><div><div><div><div data-slate-editor="true" data-key="4227" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="4228"><span data-slate-object="text" data-key="4229"><span data-slate-leaf="true" data-offset-key="4229:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。今天，我们继续学习 Follower 是如何拉取 Leader 消息的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4230"><span data-slate-object="text" data-key="4231"><span data-slate-leaf="true" data-offset-key="4231:0" data-first-offset="true"><span data-slate-string="true">要弄明白这个问题，在学习源码的时候，我们需要从父类 AbstractFetcherThread 开始学起，因为这是理解子类 ReplicaFetcherThread 的基础。上节课，我们已经学习了 AbstractFetcherThread 的定义，以及 processPartitionData、truncate、buildFetch 这三个方法的作用。现在，你应该掌握了拉取线程源码的处理逻辑以及支撑这些逻辑实现的代码结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4232"><span data-slate-object="text" data-key="4233"><span data-slate-leaf="true" data-offset-key="4233:0" data-first-offset="true"><span data-slate-string="true">不过，在上节课的末尾，我卖了个关子 —— 我把串联起这三个方法的 doWork 方法留到了今天这节课。等你今天学完 doWork 方法，以及这三个方法在子类 ReplicaFetcherThread 中的实现代码之后，你就能完整地理解 Follower 副本应用拉取线程（也就是 ReplicaFetcherThread 线程），从 Leader 副本获取消息并处理的流程了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4234"><span data-slate-object="text" data-key="4235"><span data-slate-leaf="true" data-offset-key="4235:0" data-first-offset="true"><span data-slate-string="true">那么，现在我们就开启 doWork 以及子类 ReplicaFetcherThread 代码的阅读。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4236" id="sr-toc-1"><span data-slate-object="text" data-key="4237"><span data-slate-leaf="true" data-offset-key="4237:0" data-first-offset="true"><span data-slate-string="true">AbstractFetcherThread 类：doWork 方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4238"><span data-slate-object="text" data-key="4239"><span data-slate-leaf="true" data-offset-key="4239:0" data-first-offset="true"><span data-slate-string="true">doWork 方法是 AbstractFetcherThread 类的核心方法，是线程的主逻辑运行方法，代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4240"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4241"><span data-slate-object="text" data-key="4242"><span data-slate-leaf="true" data-offset-key="4242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="4243"><span data-slate-leaf="true" data-offset-key="4243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="4244"><span data-slate-leaf="true" data-offset-key="4244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">doWork</span></span></span></span></span><span data-slate-object="text" data-key="4245"><span data-slate-leaf="true" data-offset-key="4245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4246"><span data-slate-leaf="true" data-offset-key="4246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="4247"><span data-slate-leaf="true" data-offset-key="4247:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4248"><span data-slate-object="text" data-key="4249"><span data-slate-leaf="true" data-offset-key="4249:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4250"><span data-slate-leaf="true" data-offset-key="4250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maybeTruncate</span></span></span></span><span data-slate-object="text" data-key="4251"><span data-slate-leaf="true" data-offset-key="4251:0" data-first-offset="true"><span data-slate-string="true">()   </span></span></span><span data-slate-object="text" data-key="4252"><span data-slate-leaf="true" data-offset-key="4252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行副本截断操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4253"><span data-slate-object="text" data-key="4254"><span data-slate-leaf="true" data-offset-key="4254:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4255"><span data-slate-leaf="true" data-offset-key="4255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maybeFetch</span></span></span></span><span data-slate-object="text" data-key="4256"><span data-slate-leaf="true" data-offset-key="4256:0" data-first-offset="true"><span data-slate-string="true">()      </span></span></span><span data-slate-object="text" data-key="4257"><span data-slate-leaf="true" data-offset-key="4257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行消息获取操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4258"><span data-slate-object="text" data-key="4259"><span data-slate-leaf="true" data-offset-key="4259:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4260"><span data-slate-object="text" data-key="4261"><span data-slate-leaf="true" data-offset-key="4261:0" data-first-offset="true"><span data-slate-string="true">怎么样，简单吧？AbstractFetcherThread 线程只要一直处于运行状态，就是会不断地重复这两个操作。获取消息这个逻辑容易理解，但是为什么 AbstractFetcherThread 线程总要不断尝试去做截断呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4262"><span data-slate-object="text" data-key="4263"><span data-slate-leaf="true" data-offset-key="4263:0" data-first-offset="true"><span data-slate-string="true">这是因为，分区的 Leader 可能会随时发生变化。每当有新 Leader 产生时，Follower 副本就必须主动执行截断操作，将自己的本地日志裁剪成与 Leader 一模一样的消息序列，甚至，Leader 副本本身也需要执行截断操作，将 LEO 调整到分区高水位处。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4264"><span data-slate-object="text" data-key="4265"><span data-slate-leaf="true" data-offset-key="4265:0" data-first-offset="true"><span data-slate-string="true">那么，具体到代码，这两个操作又是如何实现的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4266"><span data-slate-object="text" data-key="4267"><span data-slate-leaf="true" data-offset-key="4267:0" data-first-offset="true"><span data-slate-string="true">首先，我们看看 maybeTruncate 方法。它的代码不长，还不到 10 行：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4268"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4269"><span data-slate-object="text" data-key="4270"><span data-slate-leaf="true" data-offset-key="4270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="4271"><span data-slate-leaf="true" data-offset-key="4271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="4272"><span data-slate-leaf="true" data-offset-key="4272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maybeTruncate</span></span></span></span></span><span data-slate-object="text" data-key="4273"><span data-slate-leaf="true" data-offset-key="4273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4274"><span data-slate-leaf="true" data-offset-key="4274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="4275"><span data-slate-leaf="true" data-offset-key="4275:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4276"><span data-slate-object="text" data-key="4277"><span data-slate-leaf="true" data-offset-key="4277:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4278"><span data-slate-leaf="true" data-offset-key="4278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将所有处于截断中状态的分区依据有无 Leader Epoch 值进行分组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4279"><span data-slate-object="text" data-key="4280"><span data-slate-leaf="true" data-offset-key="4280:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4281"><span data-slate-leaf="true" data-offset-key="4281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4282"><span data-slate-leaf="true" data-offset-key="4282:0" data-first-offset="true"><span data-slate-string="true"> (partitionsWithEpochs, partitionsWithoutEpochs) = </span></span></span><span data-slate-object="text" data-key="4283"><span data-slate-leaf="true" data-offset-key="4283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchTruncatingPartitions</span></span></span></span><span data-slate-object="text" data-key="4284"><span data-slate-leaf="true" data-offset-key="4284:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4285"><span data-slate-object="text" data-key="4286"><span data-slate-leaf="true" data-offset-key="4286:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4287"><span data-slate-leaf="true" data-offset-key="4287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对于有 Leader Epoch 值的分区，将日志截断到 Leader Epoch 值对应的位移值处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4288"><span data-slate-object="text" data-key="4289"><span data-slate-leaf="true" data-offset-key="4289:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4290"><span data-slate-leaf="true" data-offset-key="4290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4291"><span data-slate-leaf="true" data-offset-key="4291:0" data-first-offset="true"><span data-slate-string="true"> (partitionsWithEpochs.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4292"><span data-slate-object="text" data-key="4293"><span data-slate-leaf="true" data-offset-key="4293:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4294"><span data-slate-leaf="true" data-offset-key="4294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">truncateToEpochEndOffsets</span></span></span></span><span data-slate-object="text" data-key="4295"><span data-slate-leaf="true" data-offset-key="4295:0" data-first-offset="true"><span data-slate-string="true">(partitionsWithEpochs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4296"><span data-slate-object="text" data-key="4297"><span data-slate-leaf="true" data-offset-key="4297:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4298"><span data-slate-object="text" data-key="4299"><span data-slate-leaf="true" data-offset-key="4299:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4300"><span data-slate-leaf="true" data-offset-key="4300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对于没有 Leader Epoch 值的分区，将日志截断到高水位值处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4301"><span data-slate-object="text" data-key="4302"><span data-slate-leaf="true" data-offset-key="4302:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4303"><span data-slate-leaf="true" data-offset-key="4303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4304"><span data-slate-leaf="true" data-offset-key="4304:0" data-first-offset="true"><span data-slate-string="true"> (partitionsWithoutEpochs.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4305"><span data-slate-object="text" data-key="4306"><span data-slate-leaf="true" data-offset-key="4306:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4307"><span data-slate-leaf="true" data-offset-key="4307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">truncateToHighWatermark</span></span></span></span><span data-slate-object="text" data-key="4308"><span data-slate-leaf="true" data-offset-key="4308:0" data-first-offset="true"><span data-slate-string="true">(partitionsWithoutEpochs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4309"><span data-slate-object="text" data-key="4310"><span data-slate-leaf="true" data-offset-key="4310:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4311"><span data-slate-object="text" data-key="4312"><span data-slate-leaf="true" data-offset-key="4312:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4313"><span data-slate-object="text" data-key="4314"><span data-slate-leaf="true" data-offset-key="4314:0" data-first-offset="true"><span data-slate-string="true">maybeTruncate 方法的逻辑特别简单。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4315"><span data-slate-object="text" data-key="4316"><span data-slate-leaf="true" data-offset-key="4316:0" data-first-offset="true"><span data-slate-string="true">首先，是对分区状态进行分组。既然是做截断操作的，那么该方法操作的就只能是处于截断中状态的分区。代码会判断这些分区是否存在对应的 Leader Epoch 值，并按照有无 Epoch 值进行分组。这就是 fetchTruncatingPartitions 方法做的事情。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4317"><span data-slate-object="text" data-key="4318"><span data-slate-leaf="true" data-offset-key="4318:0" data-first-offset="true"><span data-slate-string="true">我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="4319"><span data-slate-object="text" data-key="4320"><span data-slate-leaf="true" data-offset-key="4320:0" data-first-offset="true"><span data-slate-string="true">第 3 讲</span></span></span></a><span data-slate-object="text" data-key="4321"><span data-slate-leaf="true" data-offset-key="4321:0" data-first-offset="true"><span data-slate-string="true">提到过 Leader Epoch 机制，它是用来替换高水位值在日志截断中的作用。这里便是 Leader Epoch 机制典型的应用场景：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4322"><div data-slate-type="list-line" data-slate-object="block" data-key="4323"><span data-slate-object="text" data-key="4324"><span data-slate-leaf="true" data-offset-key="4324:0" data-first-offset="true"><span data-slate-string="true">当分区存在 Leader Epoch 值时，源码会将副本的本地日志截断到 Leader Epoch 对应的最新位移值处，即方法 truncateToEpochEndOffsets 的逻辑实现；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4325"><span data-slate-object="text" data-key="4326"><span data-slate-leaf="true" data-offset-key="4326:0" data-first-offset="true"><span data-slate-string="true">相反地，如果分区不存在对应的 Leader Epoch 记录，那么依然使用原来的高水位机制，调用方法 truncateToHighWatermark 将日志调整到高水位值处。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4327"><span data-slate-object="text" data-key="4328"><span data-slate-leaf="true" data-offset-key="4328:0" data-first-offset="true"><span data-slate-string="true">由于 Leader Epoch 机制属于比较高阶的知识内容，这里我们的重点是理解高水位值在截断操作中的应用，我就不再和你详细讲解 Leader Epoch 机制了。如果你希望深入理解这个机制，你可以研读一下 LeaderEpochFileCache 类的源码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4329"><span data-slate-object="text" data-key="4330"><span data-slate-leaf="true" data-offset-key="4330:0" data-first-offset="true"><span data-slate-string="true">因此，我们重点看下 truncateToHighWatermark 方法的实现代码。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="4331"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4332"><span data-slate-object="text" data-key="4333"><span data-slate-leaf="true" data-offset-key="4333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4334"><span data-slate-leaf="true" data-offset-key="4334:0" data-first-offset="true"><span data-slate-string="true">[server] def </span></span></span><span data-slate-object="text" data-key="4335"><span data-slate-leaf="true" data-offset-key="4335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">truncateToHighWatermark</span></span></span></span><span data-slate-object="text" data-key="4336"><span data-slate-leaf="true" data-offset-key="4336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4337"><span data-slate-object="text" data-key="4338"><span data-slate-leaf="true" data-offset-key="4338:0" data-first-offset="true"><span data-slate-string="true">  partitions: Set[TopicPartition]): Unit = inLock(partitionMapLock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4339"><span data-slate-object="text" data-key="4340"><span data-slate-leaf="true" data-offset-key="4340:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4341"><span data-slate-leaf="true" data-offset-key="4341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4342"><span data-slate-leaf="true" data-offset-key="4342:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4343"><span data-slate-leaf="true" data-offset-key="4343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchOffsets</span></span></span></span><span data-slate-object="text" data-key="4344"><span data-slate-leaf="true" data-offset-key="4344:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4345"><span data-slate-leaf="true" data-offset-key="4345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4346"><span data-slate-leaf="true" data-offset-key="4346:0" data-first-offset="true"><span data-slate-string="true"> mutable.HashMap.empty[TopicPartition, OffsetTruncationState]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4347"><span data-slate-object="text" data-key="4348"><span data-slate-leaf="true" data-offset-key="4348:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4349"><span data-slate-leaf="true" data-offset-key="4349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历每个要执行截断操作的分区对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4350"><span data-slate-object="text" data-key="4351"><span data-slate-leaf="true" data-offset-key="4351:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4352"><span data-slate-leaf="true" data-offset-key="4352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="4353"><span data-slate-leaf="true" data-offset-key="4353:0" data-first-offset="true"><span data-slate-string="true"> (tp &lt;- partitions) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4354"><span data-slate-object="text" data-key="4355"><span data-slate-leaf="true" data-offset-key="4355:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4356"><span data-slate-leaf="true" data-offset-key="4356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取分区的分区读取状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4357"><span data-slate-object="text" data-key="4358"><span data-slate-leaf="true" data-offset-key="4358:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4359"><span data-slate-leaf="true" data-offset-key="4359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4360"><span data-slate-leaf="true" data-offset-key="4360:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4361"><span data-slate-leaf="true" data-offset-key="4361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionState</span></span></span></span><span data-slate-object="text" data-key="4362"><span data-slate-leaf="true" data-offset-key="4362:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4363"><span data-slate-leaf="true" data-offset-key="4363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4364"><span data-slate-leaf="true" data-offset-key="4364:0" data-first-offset="true"><span data-slate-string="true"> partitionStates.stateValue(tp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4365"><span data-slate-object="text" data-key="4366"><span data-slate-leaf="true" data-offset-key="4366:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4367"><span data-slate-leaf="true" data-offset-key="4367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4368"><span data-slate-leaf="true" data-offset-key="4368:0" data-first-offset="true"><span data-slate-string="true"> (partitionState != </span></span></span><span data-slate-object="text" data-key="4369"><span data-slate-leaf="true" data-offset-key="4369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="4370"><span data-slate-leaf="true" data-offset-key="4370:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4371"><span data-slate-object="text" data-key="4372"><span data-slate-leaf="true" data-offset-key="4372:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4373"><span data-slate-leaf="true" data-offset-key="4373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取出高水位值。分区的最大可读取位移值就是高水位值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4374"><span data-slate-object="text" data-key="4375"><span data-slate-leaf="true" data-offset-key="4375:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4376"><span data-slate-leaf="true" data-offset-key="4376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4377"><span data-slate-leaf="true" data-offset-key="4377:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4378"><span data-slate-leaf="true" data-offset-key="4378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">highWatermark</span></span></span></span><span data-slate-object="text" data-key="4379"><span data-slate-leaf="true" data-offset-key="4379:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4380"><span data-slate-leaf="true" data-offset-key="4380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4381"><span data-slate-leaf="true" data-offset-key="4381:0" data-first-offset="true"><span data-slate-string="true"> partitionState.fetchOffset</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4382"><span data-slate-object="text" data-key="4383"><span data-slate-leaf="true" data-offset-key="4383:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4384"><span data-slate-leaf="true" data-offset-key="4384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4385"><span data-slate-leaf="true" data-offset-key="4385:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4386"><span data-slate-leaf="true" data-offset-key="4386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">truncationState</span></span></span></span><span data-slate-object="text" data-key="4387"><span data-slate-leaf="true" data-offset-key="4387:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4388"><span data-slate-leaf="true" data-offset-key="4388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4389"><span data-slate-leaf="true" data-offset-key="4389:0" data-first-offset="true"><span data-slate-string="true"> OffsetTruncationState(highWatermark, truncationCompleted = </span></span></span><span data-slate-object="text" data-key="4390"><span data-slate-leaf="true" data-offset-key="4390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="4391"><span data-slate-leaf="true" data-offset-key="4391:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4392"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4393"><span data-slate-object="text" data-key="4394"><span data-slate-leaf="true" data-offset-key="4394:0" data-first-offset="true"><span data-slate-string="true">      info(s</span></span></span><span data-slate-object="text" data-key="4395"><span data-slate-leaf="true" data-offset-key="4395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Truncating partition $tp to local high watermark $highWatermark"</span></span></span></span><span data-slate-object="text" data-key="4396"><span data-slate-leaf="true" data-offset-key="4396:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4397"><span data-slate-object="text" data-key="4398"><span data-slate-leaf="true" data-offset-key="4398:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4399"><span data-slate-leaf="true" data-offset-key="4399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行截断到高水位值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4400"><span data-slate-object="text" data-key="4401"><span data-slate-leaf="true" data-offset-key="4401:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4402"><span data-slate-leaf="true" data-offset-key="4402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4403"><span data-slate-leaf="true" data-offset-key="4403:0" data-first-offset="true"><span data-slate-string="true"> (doTruncate(tp, truncationState))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4404"><span data-slate-object="text" data-key="4405"><span data-slate-leaf="true" data-offset-key="4405:0" data-first-offset="true"><span data-slate-string="true">        fetchOffsets.put(tp, truncationState)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4406"><span data-slate-object="text" data-key="4407"><span data-slate-leaf="true" data-offset-key="4407:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4408"><span data-slate-object="text" data-key="4409"><span data-slate-leaf="true" data-offset-key="4409:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4410"><span data-slate-object="text" data-key="4411"><span data-slate-leaf="true" data-offset-key="4411:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4412"><span data-slate-leaf="true" data-offset-key="4412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新这组分区的分区读取状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4413"><span data-slate-object="text" data-key="4414"><span data-slate-leaf="true" data-offset-key="4414:0" data-first-offset="true"><span data-slate-string="true">  updateFetchOffsetAndMaybeMarkTruncationComplete(fetchOffsets)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4415"><span data-slate-object="text" data-key="4416"><span data-slate-leaf="true" data-offset-key="4416:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4417"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4418"><span data-slate-object="text" data-key="4419"><span data-slate-leaf="true" data-offset-key="4419:0" data-first-offset="true"><span data-slate-string="true">我来和你解释下 truncateToHighWatermark 方法的逻辑：首先，遍历给定的所有分区；然后，依次为每个分区获取当前的高水位值，并将其保存在前面提到的分区读取状态类中；之后调用 doTruncate 方法执行真正的日志截断操作。等到将给定的所有分区都执行了对应的操作之后，代码会更新这组分区的分区读取状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4420"><span data-slate-object="text" data-key="4421"><span data-slate-leaf="true" data-offset-key="4421:0" data-first-offset="true"><span data-slate-string="true">doTruncate 方法底层调用了抽象方法 truncate，而 truncate 方法是在 ReplicaFetcherThread 中实现的。我们一会儿再详细说它。至于 updateFetchOffsetAndMaybeMarkTruncationComplete 方法，是一个只有十几行代码的私有方法。我就把它当作课后思考题留给你，由你来思考一下它是做什么用的吧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4422"><span data-slate-object="text" data-key="4423"><span data-slate-leaf="true" data-offset-key="4423:0" data-first-offset="true"><span data-slate-string="true">说完了 maybeTruncate 方法，我们再看看 maybeFetch 方法，代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="4424"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4425"><span data-slate-object="text" data-key="4426"><span data-slate-leaf="true" data-offset-key="4426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4427"><span data-slate-leaf="true" data-offset-key="4427:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="4428"><span data-slate-leaf="true" data-offset-key="4428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maybeFetch</span></span></span></span><span data-slate-object="text" data-key="4429"><span data-slate-leaf="true" data-offset-key="4429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="4430"><span data-slate-leaf="true" data-offset-key="4430:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4431"><span data-slate-object="text" data-key="4432"><span data-slate-leaf="true" data-offset-key="4432:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4433"><span data-slate-leaf="true" data-offset-key="4433:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4434"><span data-slate-leaf="true" data-offset-key="4434:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4435"><span data-slate-leaf="true" data-offset-key="4435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchRequestOpt</span></span></span></span><span data-slate-object="text" data-key="4436"><span data-slate-leaf="true" data-offset-key="4436:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4437"><span data-slate-leaf="true" data-offset-key="4437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4438"><span data-slate-leaf="true" data-offset-key="4438:0" data-first-offset="true"><span data-slate-string="true"> inLock(partitionMapLock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4439"><span data-slate-object="text" data-key="4440"><span data-slate-leaf="true" data-offset-key="4440:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4441"><span data-slate-leaf="true" data-offset-key="4441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为 partitionStates 中的分区构造 FetchRequest</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4442"><span data-slate-object="text" data-key="4443"><span data-slate-leaf="true" data-offset-key="4443:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4444"><span data-slate-leaf="true" data-offset-key="4444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//partitionStates 中保存的是要去获取消息的分区以及对应的状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4445"><span data-slate-object="text" data-key="4446"><span data-slate-leaf="true" data-offset-key="4446:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="4447"><span data-slate-leaf="true" data-offset-key="4447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ResultWithPartitions</span></span></span></span><span data-slate-object="text" data-key="4448"><span data-slate-leaf="true" data-offset-key="4448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(fetchRequestOpt, partitionsWithError)</span></span></span></span><span data-slate-object="text" data-key="4449"><span data-slate-leaf="true" data-offset-key="4449:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4450"><span data-slate-object="text" data-key="4451"><span data-slate-leaf="true" data-offset-key="4451:0" data-first-offset="true"><span data-slate-string="true">      buildFetch(partitionStates.partitionStateMap.asScala)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4452"><span data-slate-object="text" data-key="4453"><span data-slate-leaf="true" data-offset-key="4453:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4454"><span data-slate-leaf="true" data-offset-key="4454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理出错的分区，处理方式主要是将这个分区加入到有序 Map 末尾</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4455"><span data-slate-object="text" data-key="4456"><span data-slate-leaf="true" data-offset-key="4456:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4457"><span data-slate-leaf="true" data-offset-key="4457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待后续重试</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4458"><span data-slate-object="text" data-key="4459"><span data-slate-leaf="true" data-offset-key="4459:0" data-first-offset="true"><span data-slate-string="true">    handlePartitionsWithErrors(partitionsWithError, </span></span></span><span data-slate-object="text" data-key="4460"><span data-slate-leaf="true" data-offset-key="4460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"maybeFetch"</span></span></span></span><span data-slate-object="text" data-key="4461"><span data-slate-leaf="true" data-offset-key="4461:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4462"><span data-slate-object="text" data-key="4463"><span data-slate-leaf="true" data-offset-key="4463:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4464"><span data-slate-leaf="true" data-offset-key="4464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前没有可读取的分区，则等待 fetchBackOffMs 时间等候后续重试</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4465"><span data-slate-object="text" data-key="4466"><span data-slate-leaf="true" data-offset-key="4466:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4467"><span data-slate-leaf="true" data-offset-key="4467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4468"><span data-slate-leaf="true" data-offset-key="4468:0" data-first-offset="true"><span data-slate-string="true"> (fetchRequestOpt.isEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4469"><span data-slate-object="text" data-key="4470"><span data-slate-leaf="true" data-offset-key="4470:0" data-first-offset="true"><span data-slate-string="true">      trace(s</span></span></span><span data-slate-object="text" data-key="4471"><span data-slate-leaf="true" data-offset-key="4471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"There are no active partitions. Back off for $fetchBackOffMs ms before sending a fetch request"</span></span></span></span><span data-slate-object="text" data-key="4472"><span data-slate-leaf="true" data-offset-key="4472:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4473"><span data-slate-object="text" data-key="4474"><span data-slate-leaf="true" data-offset-key="4474:0" data-first-offset="true"><span data-slate-string="true">      partitionMapCond.await(fetchBackOffMs, TimeUnit.MILLISECONDS)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4475"><span data-slate-object="text" data-key="4476"><span data-slate-leaf="true" data-offset-key="4476:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4477"><span data-slate-object="text" data-key="4478"><span data-slate-leaf="true" data-offset-key="4478:0" data-first-offset="true"><span data-slate-string="true">    fetchRequestOpt</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4479"><span data-slate-object="text" data-key="4480"><span data-slate-leaf="true" data-offset-key="4480:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4481"><span data-slate-object="text" data-key="4482"><span data-slate-leaf="true" data-offset-key="4482:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4483"><span data-slate-leaf="true" data-offset-key="4483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 发送 FETCH 请求给 Leader 副本，并处理 Response</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4484"><span data-slate-object="text" data-key="4485"><span data-slate-leaf="true" data-offset-key="4485:0" data-first-offset="true"><span data-slate-string="true">  fetchRequestOpt.foreach { </span></span></span><span data-slate-object="text" data-key="4486"><span data-slate-leaf="true" data-offset-key="4486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4487"><span data-slate-leaf="true" data-offset-key="4487:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4488"><span data-slate-leaf="true" data-offset-key="4488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaFetch</span></span></span></span><span data-slate-object="text" data-key="4489"><span data-slate-leaf="true" data-offset-key="4489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(sessionPartitions, fetchRequest)</span></span></span></span><span data-slate-object="text" data-key="4490"><span data-slate-leaf="true" data-offset-key="4490:0" data-first-offset="true"><span data-slate-string="true"> =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4491"><span data-slate-object="text" data-key="4492"><span data-slate-leaf="true" data-offset-key="4492:0" data-first-offset="true"><span data-slate-string="true">    processFetchRequest(sessionPartitions, fetchRequest)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4493"><span data-slate-object="text" data-key="4494"><span data-slate-leaf="true" data-offset-key="4494:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4495"><span data-slate-object="text" data-key="4496"><span data-slate-leaf="true" data-offset-key="4496:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4497"><span data-slate-object="text" data-key="4498"><span data-slate-leaf="true" data-offset-key="4498:0" data-first-offset="true"><span data-slate-string="true">同样地，maybeFetch 做的事情也基本可以分为 3 步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4499"><span data-slate-object="text" data-key="4500"><span data-slate-leaf="true" data-offset-key="4500:0" data-first-offset="true"><span data-slate-string="true">第 1 步，为 partitionStates 中的分区构造 FetchRequest 对象，严格来说是 FetchRequest.Builder 对象。构造了 Builder 对象之后，通过调用其 build 方法，就能创建出所需的 FetchRequest 请求对象。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4501"><span data-slate-object="text" data-key="4502"><span data-slate-leaf="true" data-offset-key="4502:0" data-first-offset="true"><span data-slate-string="true">这里的 partitionStates 中保存的是，要去获取消息的一组分区以及对应的状态信息。这一步的输出结果是两个对象：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4503"><div data-slate-type="list-line" data-slate-object="block" data-key="4504"><span data-slate-object="text" data-key="4505"><span data-slate-leaf="true" data-offset-key="4505:0" data-first-offset="true"><span data-slate-string="true">一个对象是 ReplicaFetch，即要读取的分区核心信息 + FetchRequest.Builder 对象。而这里的核心信息，就是指要读取哪个分区，从哪个位置开始读，最多读多少字节，等等。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4506"><span data-slate-object="text" data-key="4507"><span data-slate-leaf="true" data-offset-key="4507:0" data-first-offset="true"><span data-slate-string="true">另一个对象是一组出错分区。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4508"><span data-slate-object="text" data-key="4509"><span data-slate-leaf="true" data-offset-key="4509:0" data-first-offset="true"><span data-slate-string="true">第 2 步，处理这组出错分区。处理方式是将这组分区加入到有序 Map 末尾等待后续重试。如果发现当前没有任何可读取的分区，代码会阻塞等待一段时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4510"><span data-slate-object="text" data-key="4511"><span data-slate-leaf="true" data-offset-key="4511:0" data-first-offset="true"><span data-slate-string="true">第 3 步，发送 FETCH 请求给对应的 Leader 副本，并处理相应的 Response，也就是 processFetchRequest 方法要做的事情。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4512"><span data-slate-object="text" data-key="4513"><span data-slate-leaf="true" data-offset-key="4513:0" data-first-offset="true"><span data-slate-string="true">processFetchRequest 是 AbstractFetcherThread 所有方法中代码量最多的方法，逻辑也有些复杂。为了更好地理解它，我提取了其中的精华代码展示给你，并在每个关键步骤上都加了注释：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="4514"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div><div data-code-line-number="78"></div><div data-code-line-number="79"></div><div data-code-line-number="80"></div><div data-code-line-number="81"></div><div data-code-line-number="82"></div><div data-code-line-number="83"></div><div data-code-line-number="84"></div><div data-code-line-number="85"></div><div data-code-line-number="86"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4515"><span data-slate-object="text" data-key="4516"><span data-slate-leaf="true" data-offset-key="4516:0" data-first-offset="true"><span data-slate-string="true">private def processFetchRequest(sessionPartitions: </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4517"><span data-slate-object="text" data-key="4518"><span data-slate-leaf="true" data-offset-key="4518:0" data-first-offset="true"><span data-slate-string="true">  util.</span></span></span><span data-slate-object="text" data-key="4519"><span data-slate-leaf="true" data-offset-key="4519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="4520"><span data-slate-leaf="true" data-offset-key="4520:0" data-first-offset="true"><span data-slate-string="true">[TopicPartition, FetchRequest.PartitionData],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4521"><span data-slate-object="text" data-key="4522"><span data-slate-leaf="true" data-offset-key="4522:0" data-first-offset="true"><span data-slate-string="true">  fetchRequest: FetchRequest.Builder): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4523"><span data-slate-object="text" data-key="4524"><span data-slate-leaf="true" data-offset-key="4524:0" data-first-offset="true"><span data-slate-string="true">    val partitionsWithError = mutable.</span></span></span><span data-slate-object="text" data-key="4525"><span data-slate-leaf="true" data-offset-key="4525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="4526"><span data-slate-leaf="true" data-offset-key="4526:0" data-first-offset="true"><span data-slate-string="true">[TopicPartition]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4527"><span data-slate-object="text" data-key="4528"><span data-slate-leaf="true" data-offset-key="4528:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4529"><span data-slate-leaf="true" data-offset-key="4529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4530"><span data-slate-leaf="true" data-offset-key="4530:0" data-first-offset="true"><span data-slate-string="true"> responseData: </span></span></span><span data-slate-object="text" data-key="4531"><span data-slate-leaf="true" data-offset-key="4531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="4532"><span data-slate-leaf="true" data-offset-key="4532:0" data-first-offset="true"><span data-slate-string="true">[TopicPartition, FetchData] = </span></span></span><span data-slate-object="text" data-key="4533"><span data-slate-leaf="true" data-offset-key="4533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="4534"><span data-slate-leaf="true" data-offset-key="4534:0" data-first-offset="true"><span data-slate-string="true">.empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4535"><span data-slate-object="text" data-key="4536"><span data-slate-leaf="true" data-offset-key="4536:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4537"><span data-slate-leaf="true" data-offset-key="4537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="4538"><span data-slate-leaf="true" data-offset-key="4538:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4539"><span data-slate-object="text" data-key="4540"><span data-slate-leaf="true" data-offset-key="4540:0" data-first-offset="true"><span data-slate-string="true">      trace(s</span></span></span><span data-slate-object="text" data-key="4541"><span data-slate-leaf="true" data-offset-key="4541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Sending fetch request </span></span></span></span><span data-slate-object="text" data-key="4542"><span data-slate-leaf="true" data-offset-key="4542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$fetchRequest</span></span></span></span></span><span data-slate-object="text" data-key="4543"><span data-slate-leaf="true" data-offset-key="4543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="4544"><span data-slate-leaf="true" data-offset-key="4544:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4545"><span data-slate-object="text" data-key="4546"><span data-slate-leaf="true" data-offset-key="4546:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4547"><span data-slate-leaf="true" data-offset-key="4547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 给 Leader 发送 FETCH 请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4548"><span data-slate-object="text" data-key="4549"><span data-slate-leaf="true" data-offset-key="4549:0" data-first-offset="true"><span data-slate-string="true">      responseData = fetchFromLeader(fetchRequest)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4550"><span data-slate-object="text" data-key="4551"><span data-slate-leaf="true" data-offset-key="4551:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="4552"><span data-slate-leaf="true" data-offset-key="4552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="4553"><span data-slate-leaf="true" data-offset-key="4553:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4554"><span data-slate-object="text" data-key="4555"><span data-slate-leaf="true" data-offset-key="4555:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4556"><span data-slate-object="text" data-key="4557"><span data-slate-leaf="true" data-offset-key="4557:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4558"><span data-slate-object="text" data-key="4559"><span data-slate-leaf="true" data-offset-key="4559:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4560"><span data-slate-leaf="true" data-offset-key="4560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新请求发送速率指标</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4561"><span data-slate-object="text" data-key="4562"><span data-slate-leaf="true" data-offset-key="4562:0" data-first-offset="true"><span data-slate-string="true">    fetcherStats.requestRate.mark()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4563"><span data-slate-object="text" data-key="4564"><span data-slate-leaf="true" data-offset-key="4564:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4565"><span data-slate-leaf="true" data-offset-key="4565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4566"><span data-slate-leaf="true" data-offset-key="4566:0" data-first-offset="true"><span data-slate-string="true"> (responseData.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4567"><span data-slate-object="text" data-key="4568"><span data-slate-leaf="true" data-offset-key="4568:0" data-first-offset="true"><span data-slate-string="true">      inLock(partitionMapLock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4569"><span data-slate-object="text" data-key="4570"><span data-slate-leaf="true" data-offset-key="4570:0" data-first-offset="true"><span data-slate-string="true">        responseData.foreach { </span></span></span><span data-slate-object="text" data-key="4571"><span data-slate-leaf="true" data-offset-key="4571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4572"><span data-slate-leaf="true" data-offset-key="4572:0" data-first-offset="true"><span data-slate-string="true"> (topicPartition, partitionData) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4573"><span data-slate-object="text" data-key="4574"><span data-slate-leaf="true" data-offset-key="4574:0" data-first-offset="true"><span data-slate-string="true">          Option(partitionStates.stateValue(topicPartition)).foreach { currentFetchState =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4575"><span data-slate-object="text" data-key="4576"><span data-slate-leaf="true" data-offset-key="4576:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="4577"><span data-slate-leaf="true" data-offset-key="4577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取分区核心信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4578"><span data-slate-object="text" data-key="4579"><span data-slate-leaf="true" data-offset-key="4579:0" data-first-offset="true"><span data-slate-string="true">            val fetchPartitionData = sessionPartitions.</span></span></span><span data-slate-object="text" data-key="4580"><span data-slate-leaf="true" data-offset-key="4580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="4581"><span data-slate-leaf="true" data-offset-key="4581:0" data-first-offset="true"><span data-slate-string="true">(topicPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4582"><span data-slate-object="text" data-key="4583"><span data-slate-leaf="true" data-offset-key="4583:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="4584"><span data-slate-leaf="true" data-offset-key="4584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 Response 的条件：</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4585"><span data-slate-object="text" data-key="4586"><span data-slate-leaf="true" data-offset-key="4586:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="4587"><span data-slate-leaf="true" data-offset-key="4587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 1. 要获取的位移值和之前已保存的下一条待获取位移值相等</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4588"><span data-slate-object="text" data-key="4589"><span data-slate-leaf="true" data-offset-key="4589:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="4590"><span data-slate-leaf="true" data-offset-key="4590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 2. 当前分区处于可获取状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4591"><span data-slate-object="text" data-key="4592"><span data-slate-leaf="true" data-offset-key="4592:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="4593"><span data-slate-leaf="true" data-offset-key="4593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4594"><span data-slate-leaf="true" data-offset-key="4594:0" data-first-offset="true"><span data-slate-string="true"> (fetchPartitionData != </span></span></span><span data-slate-object="text" data-key="4595"><span data-slate-leaf="true" data-offset-key="4595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="4596"><span data-slate-leaf="true" data-offset-key="4596:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; fetchPartitionData.fetchOffset == currentFetchState.fetchOffset &amp;&amp; currentFetchState.isReadyForFetch) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4597"><span data-slate-object="text" data-key="4598"><span data-slate-leaf="true" data-offset-key="4598:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="4599"><span data-slate-leaf="true" data-offset-key="4599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 提取 Response 中的 Leader Epoch 值 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4600"><span data-slate-object="text" data-key="4601"><span data-slate-leaf="true" data-offset-key="4601:0" data-first-offset="true"><span data-slate-string="true">              val requestEpoch = </span></span></span><span data-slate-object="text" data-key="4602"><span data-slate-leaf="true" data-offset-key="4602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4603"><span data-slate-leaf="true" data-offset-key="4603:0" data-first-offset="true"><span data-slate-string="true"> (fetchPartitionData.currentLeaderEpoch.isPresent) Some(fetchPartitionData.currentLeaderEpoch.</span></span></span><span data-slate-object="text" data-key="4604"><span data-slate-leaf="true" data-offset-key="4604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="4605"><span data-slate-leaf="true" data-offset-key="4605:0" data-first-offset="true"><span data-slate-string="true">().toInt) </span></span></span><span data-slate-object="text" data-key="4606"><span data-slate-leaf="true" data-offset-key="4606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="4607"><span data-slate-leaf="true" data-offset-key="4607:0" data-first-offset="true"><span data-slate-string="true"> None</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4608"><span data-slate-object="text" data-key="4609"><span data-slate-leaf="true" data-offset-key="4609:0" data-first-offset="true"><span data-slate-string="true">              partitionData.error match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4610"><span data-slate-object="text" data-key="4611"><span data-slate-leaf="true" data-offset-key="4611:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4612"><span data-slate-leaf="true" data-offset-key="4612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果没有错误</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4613"><span data-slate-object="text" data-key="4614"><span data-slate-leaf="true" data-offset-key="4614:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4615"><span data-slate-leaf="true" data-offset-key="4615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4616"><span data-slate-leaf="true" data-offset-key="4616:0" data-first-offset="true"><span data-slate-string="true"> Errors.NONE =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4617"><span data-slate-object="text" data-key="4618"><span data-slate-leaf="true" data-offset-key="4618:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4619"><span data-slate-leaf="true" data-offset-key="4619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="4620"><span data-slate-leaf="true" data-offset-key="4620:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4621"><span data-slate-object="text" data-key="4622"><span data-slate-leaf="true" data-offset-key="4622:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="4623"><span data-slate-leaf="true" data-offset-key="4623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 交由子类完成 Response 的处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4624"><span data-slate-object="text" data-key="4625"><span data-slate-leaf="true" data-offset-key="4625:0" data-first-offset="true"><span data-slate-string="true">                    val logAppendInfoOpt = processPartitionData(topicPartition, currentFetchState.fetchOffset,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4626"><span data-slate-object="text" data-key="4627"><span data-slate-leaf="true" data-offset-key="4627:0" data-first-offset="true"><span data-slate-string="true">                      partitionData)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4628"><span data-slate-object="text" data-key="4629"><span data-slate-leaf="true" data-offset-key="4629:0" data-first-offset="true"><span data-slate-string="true">                    logAppendInfoOpt.foreach {logAppendInfo =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4630"><span data-slate-object="text" data-key="4631"><span data-slate-leaf="true" data-offset-key="4631:0" data-first-offset="true"><span data-slate-string="true">                      val validBytes = logAppendInfo.validBytes</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4632"><span data-slate-object="text" data-key="4633"><span data-slate-leaf="true" data-offset-key="4633:0" data-first-offset="true"><span data-slate-string="true">                      val nextOffset = </span></span></span><span data-slate-object="text" data-key="4634"><span data-slate-leaf="true" data-offset-key="4634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4635"><span data-slate-leaf="true" data-offset-key="4635:0" data-first-offset="true"><span data-slate-string="true"> (validBytes&gt; </span></span></span><span data-slate-object="text" data-key="4636"><span data-slate-leaf="true" data-offset-key="4636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4637"><span data-slate-leaf="true" data-offset-key="4637:0" data-first-offset="true"><span data-slate-string="true">) logAppendInfo.lastOffset + </span></span></span><span data-slate-object="text" data-key="4638"><span data-slate-leaf="true" data-offset-key="4638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="4639"><span data-slate-leaf="true" data-offset-key="4639:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4640"><span data-slate-leaf="true" data-offset-key="4640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="4641"><span data-slate-leaf="true" data-offset-key="4641:0" data-first-offset="true"><span data-slate-string="true"> currentFetchState.fetchOffset</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4642"><span data-slate-object="text" data-key="4643"><span data-slate-leaf="true" data-offset-key="4643:0" data-first-offset="true"><span data-slate-string="true">                      val lag = Math.max(</span></span></span><span data-slate-object="text" data-key="4644"><span data-slate-leaf="true" data-offset-key="4644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4645"><span data-slate-leaf="true" data-offset-key="4645:0" data-first-offset="true"><span data-slate-string="true">L, partitionData.highWatermark - nextOffset)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4646"><span data-slate-object="text" data-key="4647"><span data-slate-leaf="true" data-offset-key="4647:0" data-first-offset="true"><span data-slate-string="true">fetcherLagStats.getAndMaybePut(topicPartition).lag = lag</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4648"><span data-slate-object="text" data-key="4649"><span data-slate-leaf="true" data-offset-key="4649:0" data-first-offset="true"><span data-slate-string="true">                      </span></span></span><span data-slate-object="text" data-key="4650"><span data-slate-leaf="true" data-offset-key="4650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4651"><span data-slate-leaf="true" data-offset-key="4651:0" data-first-offset="true"><span data-slate-string="true"> (validBytes&gt; </span></span></span><span data-slate-object="text" data-key="4652"><span data-slate-leaf="true" data-offset-key="4652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4653"><span data-slate-leaf="true" data-offset-key="4653:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; partitionStates.contains(topicPartition)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4654"><span data-slate-object="text" data-key="4655"><span data-slate-leaf="true" data-offset-key="4655:0" data-first-offset="true"><span data-slate-string="true">                        val newFetchState = PartitionFetchState(nextOffset, Some(lag), currentFetchState.currentLeaderEpoch, state = Fetching)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4656"><span data-slate-object="text" data-key="4657"><span data-slate-leaf="true" data-offset-key="4657:0" data-first-offset="true"><span data-slate-string="true">                        </span></span></span><span data-slate-object="text" data-key="4658"><span data-slate-leaf="true" data-offset-key="4658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将该分区放置在有序 Map 读取顺序的末尾，保证公平性</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4659"><span data-slate-object="text" data-key="4660"><span data-slate-leaf="true" data-offset-key="4660:0" data-first-offset="true"><span data-slate-string="true">                        partitionStates.updateAndMoveToEnd(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4661"><span data-slate-object="text" data-key="4662"><span data-slate-leaf="true" data-offset-key="4662:0" data-first-offset="true"><span data-slate-string="true">                          topicPartition, newFetchState)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4663"><span data-slate-object="text" data-key="4664"><span data-slate-leaf="true" data-offset-key="4664:0" data-first-offset="true"><span data-slate-string="true">                        fetcherStats.byteRate.mark(validBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4665"><span data-slate-object="text" data-key="4666"><span data-slate-leaf="true" data-offset-key="4666:0" data-first-offset="true"><span data-slate-string="true">                      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4667"><span data-slate-object="text" data-key="4668"><span data-slate-leaf="true" data-offset-key="4668:0" data-first-offset="true"><span data-slate-string="true">                    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4669"><span data-slate-object="text" data-key="4670"><span data-slate-leaf="true" data-offset-key="4670:0" data-first-offset="true"><span data-slate-string="true">                  } </span></span></span><span data-slate-object="text" data-key="4671"><span data-slate-leaf="true" data-offset-key="4671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="4672"><span data-slate-leaf="true" data-offset-key="4672:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4673"><span data-slate-object="text" data-key="4674"><span data-slate-leaf="true" data-offset-key="4674:0" data-first-offset="true"><span data-slate-string="true">                    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4675"><span data-slate-object="text" data-key="4676"><span data-slate-leaf="true" data-offset-key="4676:0" data-first-offset="true"><span data-slate-string="true">                  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4677"><span data-slate-object="text" data-key="4678"><span data-slate-leaf="true" data-offset-key="4678:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4679"><span data-slate-leaf="true" data-offset-key="4679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果读取位移值越界，通常是因为 Leader 发生变更</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4680"><span data-slate-object="text" data-key="4681"><span data-slate-leaf="true" data-offset-key="4681:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4682"><span data-slate-leaf="true" data-offset-key="4682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4683"><span data-slate-leaf="true" data-offset-key="4683:0" data-first-offset="true"><span data-slate-string="true"> Errors.OFFSET_OUT_OF_RANGE =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4684"><span data-slate-object="text" data-key="4685"><span data-slate-leaf="true" data-offset-key="4685:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4686"><span data-slate-leaf="true" data-offset-key="4686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调整越界，主要办法是做截断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4687"><span data-slate-object="text" data-key="4688"><span data-slate-leaf="true" data-offset-key="4688:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4689"><span data-slate-leaf="true" data-offset-key="4689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4690"><span data-slate-leaf="true" data-offset-key="4690:0" data-first-offset="true"><span data-slate-string="true"> (handleOutOfRangeError(topicPartition, currentFetchState, requestEpoch))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4691"><span data-slate-object="text" data-key="4692"><span data-slate-leaf="true" data-offset-key="4692:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="4693"><span data-slate-leaf="true" data-offset-key="4693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果依然不能成功，加入到出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4694"><span data-slate-object="text" data-key="4695"><span data-slate-leaf="true" data-offset-key="4695:0" data-first-offset="true"><span data-slate-string="true">                    partitionsWithError += topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4696"><span data-slate-object="text" data-key="4697"><span data-slate-leaf="true" data-offset-key="4697:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4698"><span data-slate-leaf="true" data-offset-key="4698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果 Leader Epoch 值比 Leader 所在 Broker 上的 Epoch 值要新</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4699"><span data-slate-object="text" data-key="4700"><span data-slate-leaf="true" data-offset-key="4700:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4701"><span data-slate-leaf="true" data-offset-key="4701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4702"><span data-slate-leaf="true" data-offset-key="4702:0" data-first-offset="true"><span data-slate-string="true"> Errors.UNKNOWN_LEADER_EPOCH =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4703"><span data-slate-object="text" data-key="4704"><span data-slate-leaf="true" data-offset-key="4704:0" data-first-offset="true"><span data-slate-string="true">                  debug(s</span></span></span><span data-slate-object="text" data-key="4705"><span data-slate-leaf="true" data-offset-key="4705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Remote broker has a smaller leader epoch for partition </span></span></span></span><span data-slate-object="text" data-key="4706"><span data-slate-leaf="true" data-offset-key="4706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topicPartition</span></span></span></span></span><span data-slate-object="text" data-key="4707"><span data-slate-leaf="true" data-offset-key="4707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> than "</span></span></span></span><span data-slate-object="text" data-key="4708"><span data-slate-leaf="true" data-offset-key="4708:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4709"><span data-slate-object="text" data-key="4710"><span data-slate-leaf="true" data-offset-key="4710:0" data-first-offset="true"><span data-slate-string="true">                    s</span></span></span><span data-slate-object="text" data-key="4711"><span data-slate-leaf="true" data-offset-key="4711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"this replica's current leader epoch of </span></span></span></span><span data-slate-object="text" data-key="4712"><span data-slate-leaf="true" data-offset-key="4712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${currentFetchState.currentLeaderEpoch}</span></span></span></span></span><span data-slate-object="text" data-key="4713"><span data-slate-leaf="true" data-offset-key="4713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="4714"><span data-slate-leaf="true" data-offset-key="4714:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4715"><span data-slate-object="text" data-key="4716"><span data-slate-leaf="true" data-offset-key="4716:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4717"><span data-slate-leaf="true" data-offset-key="4717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入到出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4718"><span data-slate-object="text" data-key="4719"><span data-slate-leaf="true" data-offset-key="4719:0" data-first-offset="true"><span data-slate-string="true">                  partitionsWithError += topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4720"><span data-slate-object="text" data-key="4721"><span data-slate-leaf="true" data-offset-key="4721:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4722"><span data-slate-leaf="true" data-offset-key="4722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果 Leader Epoch 值比 Leader 所在 Broker 上的 Epoch 值要旧</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4723"><span data-slate-object="text" data-key="4724"><span data-slate-leaf="true" data-offset-key="4724:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4725"><span data-slate-leaf="true" data-offset-key="4725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4726"><span data-slate-leaf="true" data-offset-key="4726:0" data-first-offset="true"><span data-slate-string="true"> Errors.FENCED_LEADER_EPOCH =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4727"><span data-slate-object="text" data-key="4728"><span data-slate-leaf="true" data-offset-key="4728:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4729"><span data-slate-leaf="true" data-offset-key="4729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4730"><span data-slate-leaf="true" data-offset-key="4730:0" data-first-offset="true"><span data-slate-string="true"> (onPartitionFenced(topicPartition, requestEpoch)) partitionsWithError += topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4731"><span data-slate-object="text" data-key="4732"><span data-slate-leaf="true" data-offset-key="4732:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4733"><span data-slate-leaf="true" data-offset-key="4733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果 Leader 发生变更</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4734"><span data-slate-object="text" data-key="4735"><span data-slate-leaf="true" data-offset-key="4735:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4736"><span data-slate-leaf="true" data-offset-key="4736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4737"><span data-slate-leaf="true" data-offset-key="4737:0" data-first-offset="true"><span data-slate-string="true"> Errors.NOT_LEADER_FOR_PARTITION =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4738"><span data-slate-object="text" data-key="4739"><span data-slate-leaf="true" data-offset-key="4739:0" data-first-offset="true"><span data-slate-string="true">                  debug(s</span></span></span><span data-slate-object="text" data-key="4740"><span data-slate-leaf="true" data-offset-key="4740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Remote broker is not the leader for partition </span></span></span></span><span data-slate-object="text" data-key="4741"><span data-slate-leaf="true" data-offset-key="4741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topicPartition</span></span></span></span></span><span data-slate-object="text" data-key="4742"><span data-slate-leaf="true" data-offset-key="4742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, which could indicate "</span></span></span></span><span data-slate-object="text" data-key="4743"><span data-slate-leaf="true" data-offset-key="4743:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4744"><span data-slate-object="text" data-key="4745"><span data-slate-leaf="true" data-offset-key="4745:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="4746"><span data-slate-leaf="true" data-offset-key="4746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"that the partition is being moved"</span></span></span></span><span data-slate-object="text" data-key="4747"><span data-slate-leaf="true" data-offset-key="4747:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4748"><span data-slate-object="text" data-key="4749"><span data-slate-leaf="true" data-offset-key="4749:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4750"><span data-slate-leaf="true" data-offset-key="4750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入到出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4751"><span data-slate-object="text" data-key="4752"><span data-slate-leaf="true" data-offset-key="4752:0" data-first-offset="true"><span data-slate-string="true">                  partitionsWithError += topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4753"><span data-slate-object="text" data-key="4754"><span data-slate-leaf="true" data-offset-key="4754:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="4755"><span data-slate-leaf="true" data-offset-key="4755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4756"><span data-slate-leaf="true" data-offset-key="4756:0" data-first-offset="true"><span data-slate-string="true"> _ =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4757"><span data-slate-object="text" data-key="4758"><span data-slate-leaf="true" data-offset-key="4758:0" data-first-offset="true"><span data-slate-string="true">                  error(s</span></span></span><span data-slate-object="text" data-key="4759"><span data-slate-leaf="true" data-offset-key="4759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Error for partition </span></span></span></span><span data-slate-object="text" data-key="4760"><span data-slate-leaf="true" data-offset-key="4760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topicPartition</span></span></span></span></span><span data-slate-object="text" data-key="4761"><span data-slate-leaf="true" data-offset-key="4761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> at offset </span></span></span></span><span data-slate-object="text" data-key="4762"><span data-slate-leaf="true" data-offset-key="4762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${currentFetchState.fetchOffset}</span></span></span></span></span><span data-slate-object="text" data-key="4763"><span data-slate-leaf="true" data-offset-key="4763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="4764"><span data-slate-leaf="true" data-offset-key="4764:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4765"><span data-slate-object="text" data-key="4766"><span data-slate-leaf="true" data-offset-key="4766:0" data-first-offset="true"><span data-slate-string="true">                    partitionData.error.exception)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4767"><span data-slate-object="text" data-key="4768"><span data-slate-leaf="true" data-offset-key="4768:0" data-first-offset="true"><span data-slate-string="true">                  </span></span></span><span data-slate-object="text" data-key="4769"><span data-slate-leaf="true" data-offset-key="4769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入到出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4770"><span data-slate-object="text" data-key="4771"><span data-slate-leaf="true" data-offset-key="4771:0" data-first-offset="true"><span data-slate-string="true">                  partitionsWithError += topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4772"><span data-slate-object="text" data-key="4773"><span data-slate-leaf="true" data-offset-key="4773:0" data-first-offset="true"><span data-slate-string="true">              }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4774"><span data-slate-object="text" data-key="4775"><span data-slate-leaf="true" data-offset-key="4775:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4776"><span data-slate-object="text" data-key="4777"><span data-slate-leaf="true" data-offset-key="4777:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4778"><span data-slate-object="text" data-key="4779"><span data-slate-leaf="true" data-offset-key="4779:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4780"><span data-slate-object="text" data-key="4781"><span data-slate-leaf="true" data-offset-key="4781:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4782"><span data-slate-object="text" data-key="4783"><span data-slate-leaf="true" data-offset-key="4783:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4784"><span data-slate-object="text" data-key="4785"><span data-slate-leaf="true" data-offset-key="4785:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4786"><span data-slate-leaf="true" data-offset-key="4786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4787"><span data-slate-leaf="true" data-offset-key="4787:0" data-first-offset="true"><span data-slate-string="true"> (partitionsWithError.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4788"><span data-slate-object="text" data-key="4789"><span data-slate-leaf="true" data-offset-key="4789:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4790"><span data-slate-leaf="true" data-offset-key="4790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4791"><span data-slate-object="text" data-key="4792"><span data-slate-leaf="true" data-offset-key="4792:0" data-first-offset="true"><span data-slate-string="true">      handlePartitionsWithErrors(partitionsWithError, </span></span></span><span data-slate-object="text" data-key="4793"><span data-slate-leaf="true" data-offset-key="4793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"processFetchRequest"</span></span></span></span><span data-slate-object="text" data-key="4794"><span data-slate-leaf="true" data-offset-key="4794:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4795"><span data-slate-object="text" data-key="4796"><span data-slate-leaf="true" data-offset-key="4796:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4797"><span data-slate-object="text" data-key="4798"><span data-slate-leaf="true" data-offset-key="4798:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4799"><span data-slate-object="text" data-key="4800"><span data-slate-leaf="true" data-offset-key="4800:0" data-first-offset="true"><span data-slate-string="true">为了方便你记忆，我先用一张流程图来说明下 processFetchRequest 方法的执行逻辑：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4801"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/38/49/387568fa5477ba71fc6bbe2868d76349.png?wh=2955*5845"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4802"><span data-slate-object="text" data-key="4803"><span data-slate-leaf="true" data-offset-key="4803:0" data-first-offset="true"><span data-slate-string="true">结合着代码注释和流程图，我再和你解释下 processFetchRequest 的核心逻辑吧。这样你肯定就能明白拉取线程是如何执行拉取动作的了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4804"><span data-slate-object="text" data-key="4805"><span data-slate-leaf="true" data-offset-key="4805:0" data-first-offset="true"><span data-slate-string="true">我们可以把这个逻辑，分为以下 3 大部分。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4806"><span data-slate-object="text" data-key="4807"><span data-slate-leaf="true" data-offset-key="4807:0" data-first-offset="true"><span data-slate-string="true">第 1 步，调用 fetchFromLeader 方法给 Leader 发送 FETCH 请求，并阻塞等待 Response 的返回，然后更新 FETCH 请求发送速率的监控指标。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4808"><span data-slate-object="text" data-key="4809"><span data-slate-leaf="true" data-offset-key="4809:0" data-first-offset="true"><span data-slate-string="true">第 2 步，拿到 Response 之后，代码从中取出分区的核心信息，然后比较要读取的位移值，和当前 AbstractFetcherThread 线程缓存的、该分区下一条待读取的位移值是否相等，以及当前分区是否处于可获取状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4810"><span data-slate-object="text" data-key="4811"><span data-slate-leaf="true" data-offset-key="4811:0" data-first-offset="true"><span data-slate-string="true">如果不满足这两个条件，说明这个 Request 可能是一个之前等待了许久都未处理的请求，压根就不用处理了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4812"><span data-slate-object="text" data-key="4813"><span data-slate-leaf="true" data-offset-key="4813:0" data-first-offset="true"><span data-slate-string="true">相反，如果满足这两个条件且 Response 没有错误，代码会提取 Response 中的 Leader Epoch 值，然后交由子类实现具体的 Response 处理，也就是调用 processPartitionData 方法。之后将该分区放置在有序 Map 的末尾以保证公平性。而如果该 Response 有错误，那么就调用对应错误的定制化处理逻辑，然后将出错分区加入到出错分区列表中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4814"><span data-slate-object="text" data-key="4815"><span data-slate-leaf="true" data-offset-key="4815:0" data-first-offset="true"><span data-slate-string="true">第 3 步，调用 handlePartitionsWithErrors 方法，统一处理上一步处理过程中出现错误的分区。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4816" id="sr-toc-2"><span data-slate-object="text" data-key="4817"><span data-slate-leaf="true" data-offset-key="4817:0" data-first-offset="true"><span data-slate-string="true">子类：ReplicaFetcherThread</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4818"><span data-slate-object="text" data-key="4819"><span data-slate-leaf="true" data-offset-key="4819:0" data-first-offset="true"><span data-slate-string="true">到此，AbstractFetcherThread 类的学习我们就完成了。接下来，我们再看下 Follower 副本侧使用的 ReplicaFetcherThread 子类。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4820"><span data-slate-object="text" data-key="4821"><span data-slate-leaf="true" data-offset-key="4821:0" data-first-offset="true"><span data-slate-string="true">前面说过了，ReplicaFetcherThread 继承了 AbstractFetcherThread 类。ReplicaFetcherThread 是 Follower 副本端创建的线程，用于向 Leader 副本拉取消息数据。我们依然从类定义和重要方法两个维度来学习这个子类的源码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4822"><span data-slate-object="text" data-key="4823"><span data-slate-leaf="true" data-offset-key="4823:0" data-first-offset="true"><span data-slate-string="true">ReplicaFetcherThread 类的源码位于 server 包下的同名 scala 文件中。这是一个 300 多行的小文件，因为大部分的处理逻辑都在父类 AbstractFetcherThread 中定义过了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="4824" id="sr-toc-3"><span data-slate-object="text" data-key="4825"><span data-slate-leaf="true" data-offset-key="4825:0" data-first-offset="true"><span data-slate-string="true">类定义及字段</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="4826"><span data-slate-object="text" data-key="4827"><span data-slate-leaf="true" data-offset-key="4827:0" data-first-offset="true"><span data-slate-string="true">我们先学习下 ReplicaFetcherThread 类的定义和字段：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="4828"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4829"><span data-slate-object="text" data-key="4830"><span data-slate-leaf="true" data-offset-key="4830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="4831"><span data-slate-leaf="true" data-offset-key="4831:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4832"><span data-slate-leaf="true" data-offset-key="4832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaFetcherThread</span></span></span></span><span data-slate-object="text" data-key="4833"><span data-slate-leaf="true" data-offset-key="4833:0" data-first-offset="true"><span data-slate-string="true">(name: String,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4834"><span data-slate-object="text" data-key="4835"><span data-slate-leaf="true" data-offset-key="4835:0" data-first-offset="true"><span data-slate-string="true">                           fetcherId: Int,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4836"><span data-slate-object="text" data-key="4837"><span data-slate-leaf="true" data-offset-key="4837:0" data-first-offset="true"><span data-slate-string="true">                           sourceBroker: BrokerEndPoint,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4838"><span data-slate-object="text" data-key="4839"><span data-slate-leaf="true" data-offset-key="4839:0" data-first-offset="true"><span data-slate-string="true">                           brokerConfig: KafkaConfig,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4840"><span data-slate-object="text" data-key="4841"><span data-slate-leaf="true" data-offset-key="4841:0" data-first-offset="true"><span data-slate-string="true">                           failedPartitions: FailedPartitions,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4842"><span data-slate-object="text" data-key="4843"><span data-slate-leaf="true" data-offset-key="4843:0" data-first-offset="true"><span data-slate-string="true">                           replicaMgr: ReplicaManager,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4844"><span data-slate-object="text" data-key="4845"><span data-slate-leaf="true" data-offset-key="4845:0" data-first-offset="true"><span data-slate-string="true">                           metrics: Metrics,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4846"><span data-slate-object="text" data-key="4847"><span data-slate-leaf="true" data-offset-key="4847:0" data-first-offset="true"><span data-slate-string="true">                           time: Time,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4848"><span data-slate-object="text" data-key="4849"><span data-slate-leaf="true" data-offset-key="4849:0" data-first-offset="true"><span data-slate-string="true">                           quota: ReplicaQuota,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4850"><span data-slate-object="text" data-key="4851"><span data-slate-leaf="true" data-offset-key="4851:0" data-first-offset="true"><span data-slate-string="true">                           leaderEndpointBlockingSend: Option[BlockingSend] = None)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4852"><span data-slate-object="text" data-key="4853"><span data-slate-leaf="true" data-offset-key="4853:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4854"><span data-slate-leaf="true" data-offset-key="4854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="4855"><span data-slate-leaf="true" data-offset-key="4855:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4856"><span data-slate-leaf="true" data-offset-key="4856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractFetcherThread</span></span></span></span><span data-slate-object="text" data-key="4857"><span data-slate-leaf="true" data-offset-key="4857:0" data-first-offset="true"><span data-slate-string="true">(name = name,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4858"><span data-slate-object="text" data-key="4859"><span data-slate-leaf="true" data-offset-key="4859:0" data-first-offset="true"><span data-slate-string="true">                                clientId = name,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4860"><span data-slate-object="text" data-key="4861"><span data-slate-leaf="true" data-offset-key="4861:0" data-first-offset="true"><span data-slate-string="true">                                sourceBroker = sourceBroker,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4862"><span data-slate-object="text" data-key="4863"><span data-slate-leaf="true" data-offset-key="4863:0" data-first-offset="true"><span data-slate-string="true">                                failedPartitions,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4864"><span data-slate-object="text" data-key="4865"><span data-slate-leaf="true" data-offset-key="4865:0" data-first-offset="true"><span data-slate-string="true">                                fetchBackOffMs = brokerConfig.replicaFetchBackoffMs,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4866"><span data-slate-object="text" data-key="4867"><span data-slate-leaf="true" data-offset-key="4867:0" data-first-offset="true"><span data-slate-string="true">                                isInterruptible = </span></span></span><span data-slate-object="text" data-key="4868"><span data-slate-leaf="true" data-offset-key="4868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="4869"><span data-slate-leaf="true" data-offset-key="4869:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4870"><span data-slate-object="text" data-key="4871"><span data-slate-leaf="true" data-offset-key="4871:0" data-first-offset="true"><span data-slate-string="true">                                replicaMgr.brokerTopicStats) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4872"><span data-slate-object="text" data-key="4873"><span data-slate-leaf="true" data-offset-key="4873:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4874"><span data-slate-leaf="true" data-offset-key="4874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 副本 Id 就是副本所在 Broker 的 Id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4875"><span data-slate-object="text" data-key="4876"><span data-slate-leaf="true" data-offset-key="4876:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4877"><span data-slate-leaf="true" data-offset-key="4877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4878"><span data-slate-leaf="true" data-offset-key="4878:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4879"><span data-slate-leaf="true" data-offset-key="4879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4880"><span data-slate-leaf="true" data-offset-key="4880:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4881"><span data-slate-leaf="true" data-offset-key="4881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicaId</span></span></span></span><span data-slate-object="text" data-key="4882"><span data-slate-leaf="true" data-offset-key="4882:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4883"><span data-slate-leaf="true" data-offset-key="4883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4884"><span data-slate-leaf="true" data-offset-key="4884:0" data-first-offset="true"><span data-slate-string="true"> brokerConfig.brokerId</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4885"><span data-slate-object="text" data-key="4886"><span data-slate-leaf="true" data-offset-key="4886:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4887"><span data-slate-object="text" data-key="4888"><span data-slate-leaf="true" data-offset-key="4888:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4889"><span data-slate-leaf="true" data-offset-key="4889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于执行请求发送的类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4890"><span data-slate-object="text" data-key="4891"><span data-slate-leaf="true" data-offset-key="4891:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4892"><span data-slate-leaf="true" data-offset-key="4892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4893"><span data-slate-leaf="true" data-offset-key="4893:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4894"><span data-slate-leaf="true" data-offset-key="4894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4895"><span data-slate-leaf="true" data-offset-key="4895:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4896"><span data-slate-leaf="true" data-offset-key="4896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">leaderEndpoint</span></span></span></span><span data-slate-object="text" data-key="4897"><span data-slate-leaf="true" data-offset-key="4897:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4898"><span data-slate-leaf="true" data-offset-key="4898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4899"><span data-slate-leaf="true" data-offset-key="4899:0" data-first-offset="true"><span data-slate-string="true"> leaderEndpointBlockingSend.getOrElse(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4900"><span data-slate-object="text" data-key="4901"><span data-slate-leaf="true" data-offset-key="4901:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4902"><span data-slate-leaf="true" data-offset-key="4902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="4903"><span data-slate-leaf="true" data-offset-key="4903:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4904"><span data-slate-leaf="true" data-offset-key="4904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaFetcherBlockingSend</span></span></span></span><span data-slate-object="text" data-key="4905"><span data-slate-leaf="true" data-offset-key="4905:0" data-first-offset="true"><span data-slate-string="true">(sourceBroker, brokerConfig, metrics, time, fetcherId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4906"><span data-slate-object="text" data-key="4907"><span data-slate-leaf="true" data-offset-key="4907:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="4908"><span data-slate-leaf="true" data-offset-key="4908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"broker-$replicaId-fetcher-$fetcherId"</span></span></span></span><span data-slate-object="text" data-key="4909"><span data-slate-leaf="true" data-offset-key="4909:0" data-first-offset="true"><span data-slate-string="true">, logContext))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4910"><span data-slate-object="text" data-key="4911"><span data-slate-leaf="true" data-offset-key="4911:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4912"><span data-slate-leaf="true" data-offset-key="4912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Follower 发送的 FETCH 请求被处理返回前的最长等待时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4913"><span data-slate-object="text" data-key="4914"><span data-slate-leaf="true" data-offset-key="4914:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4915"><span data-slate-leaf="true" data-offset-key="4915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4916"><span data-slate-leaf="true" data-offset-key="4916:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4917"><span data-slate-leaf="true" data-offset-key="4917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4918"><span data-slate-leaf="true" data-offset-key="4918:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4919"><span data-slate-leaf="true" data-offset-key="4919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maxWait</span></span></span></span><span data-slate-object="text" data-key="4920"><span data-slate-leaf="true" data-offset-key="4920:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4921"><span data-slate-leaf="true" data-offset-key="4921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4922"><span data-slate-leaf="true" data-offset-key="4922:0" data-first-offset="true"><span data-slate-string="true"> brokerConfig.replicaFetchWaitMaxMs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4923"><span data-slate-object="text" data-key="4924"><span data-slate-leaf="true" data-offset-key="4924:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4925"><span data-slate-leaf="true" data-offset-key="4925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每个 FETCH Response 返回前必须要累积的最少字节数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4926"><span data-slate-object="text" data-key="4927"><span data-slate-leaf="true" data-offset-key="4927:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4928"><span data-slate-leaf="true" data-offset-key="4928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4929"><span data-slate-leaf="true" data-offset-key="4929:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4930"><span data-slate-leaf="true" data-offset-key="4930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4931"><span data-slate-leaf="true" data-offset-key="4931:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4932"><span data-slate-leaf="true" data-offset-key="4932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">minBytes</span></span></span></span><span data-slate-object="text" data-key="4933"><span data-slate-leaf="true" data-offset-key="4933:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4934"><span data-slate-leaf="true" data-offset-key="4934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4935"><span data-slate-leaf="true" data-offset-key="4935:0" data-first-offset="true"><span data-slate-string="true"> brokerConfig.replicaFetchMinBytes</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4936"><span data-slate-object="text" data-key="4937"><span data-slate-leaf="true" data-offset-key="4937:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4938"><span data-slate-leaf="true" data-offset-key="4938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每个合法 FETCH Response 的最大字节数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4939"><span data-slate-object="text" data-key="4940"><span data-slate-leaf="true" data-offset-key="4940:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4941"><span data-slate-leaf="true" data-offset-key="4941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4942"><span data-slate-leaf="true" data-offset-key="4942:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4943"><span data-slate-leaf="true" data-offset-key="4943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4944"><span data-slate-leaf="true" data-offset-key="4944:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4945"><span data-slate-leaf="true" data-offset-key="4945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">maxBytes</span></span></span></span><span data-slate-object="text" data-key="4946"><span data-slate-leaf="true" data-offset-key="4946:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4947"><span data-slate-leaf="true" data-offset-key="4947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4948"><span data-slate-leaf="true" data-offset-key="4948:0" data-first-offset="true"><span data-slate-string="true"> brokerConfig.replicaFetchResponseMaxBytes</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4949"><span data-slate-object="text" data-key="4950"><span data-slate-leaf="true" data-offset-key="4950:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4951"><span data-slate-leaf="true" data-offset-key="4951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 单个分区能够获取到的最大字节数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4952"><span data-slate-object="text" data-key="4953"><span data-slate-leaf="true" data-offset-key="4953:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4954"><span data-slate-leaf="true" data-offset-key="4954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="4955"><span data-slate-leaf="true" data-offset-key="4955:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4956"><span data-slate-leaf="true" data-offset-key="4956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4957"><span data-slate-leaf="true" data-offset-key="4957:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4958"><span data-slate-leaf="true" data-offset-key="4958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchSize</span></span></span></span><span data-slate-object="text" data-key="4959"><span data-slate-leaf="true" data-offset-key="4959:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4960"><span data-slate-leaf="true" data-offset-key="4960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4961"><span data-slate-leaf="true" data-offset-key="4961:0" data-first-offset="true"><span data-slate-string="true"> brokerConfig.replicaFetchMaxBytes</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4962"><span data-slate-object="text" data-key="4963"><span data-slate-leaf="true" data-offset-key="4963:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4964"><span data-slate-leaf="true" data-offset-key="4964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 维持某个 Broker 连接上获取会话状态的类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4965"><span data-slate-object="text" data-key="4966"><span data-slate-leaf="true" data-offset-key="4966:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4967"><span data-slate-leaf="true" data-offset-key="4967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="4968"><span data-slate-leaf="true" data-offset-key="4968:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4969"><span data-slate-leaf="true" data-offset-key="4969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchSessionHandler</span></span></span></span><span data-slate-object="text" data-key="4970"><span data-slate-leaf="true" data-offset-key="4970:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4971"><span data-slate-leaf="true" data-offset-key="4971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="4972"><span data-slate-leaf="true" data-offset-key="4972:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4973"><span data-slate-leaf="true" data-offset-key="4973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="4974"><span data-slate-leaf="true" data-offset-key="4974:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4975"><span data-slate-leaf="true" data-offset-key="4975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">FetchSessionHandler</span></span></span></span><span data-slate-object="text" data-key="4976"><span data-slate-leaf="true" data-offset-key="4976:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4977"><span data-slate-object="text" data-key="4978"><span data-slate-leaf="true" data-offset-key="4978:0" data-first-offset="true"><span data-slate-string="true">    logContext, sourceBroker.id)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4979"><span data-slate-object="text" data-key="4980"><span data-slate-leaf="true" data-offset-key="4980:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4981"><span data-slate-object="text" data-key="4982"><span data-slate-leaf="true" data-offset-key="4982:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4983"><span data-slate-object="text" data-key="4984"><span data-slate-leaf="true" data-offset-key="4984:0" data-first-offset="true"><span data-slate-string="true">ReplicaFetcherThread 类的定义代码虽然有些长，但你会发现没那么难懂，因为构造函数中的大部分字段我们上节课都学习过了。现在，我们只要学习 ReplicaFetcherThread 类特有的几个字段就可以了。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4985"><div data-slate-type="list-line" data-slate-object="block" data-key="4986"><span data-slate-object="text" data-key="4987"><span data-slate-leaf="true" data-offset-key="4987:0" data-first-offset="true"><span data-slate-string="true">fetcherId：Follower 拉取的线程 Id，也就是线程的编号。单台 Broker 上，允许存在多个 ReplicaFetcherThread 线程。Broker 端参数 num.replica.fetchers，决定了 Kafka 到底创建多少个 Follower 拉取线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4988"><span data-slate-object="text" data-key="4989"><span data-slate-leaf="true" data-offset-key="4989:0" data-first-offset="true"><span data-slate-string="true">brokerConfig：KafkaConfig 类实例。虽然我们没有正式学习过它的源码，但之前学过的很多组件代码中都有它的身影。它封装了 Broker 端所有的参数信息。同样地，ReplicaFetcherThread 类也是通过它来获取 Broker 端指定参数的值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4990"><span data-slate-object="text" data-key="4991"><span data-slate-leaf="true" data-offset-key="4991:0" data-first-offset="true"><span data-slate-string="true">replicaMgr：副本管理器。该线程类通过副本管理器来获取分区对象、副本对象以及它们下面的日志对象。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4992"><span data-slate-object="text" data-key="4993"><span data-slate-leaf="true" data-offset-key="4993:0" data-first-offset="true"><span data-slate-string="true">quota：用做限流。限流属于高阶用法，如果你想深入理解这部分内容的话，可以自行阅读 ReplicationQuotaManager 类的源码。现在，只要你下次在源码中碰到 quota 字样的，知道它是用作 Follower 副本拉取速度控制就行了。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4994"><span data-slate-object="text" data-key="4995"><span data-slate-leaf="true" data-offset-key="4995:0" data-first-offset="true"><span data-slate-string="true">leaderEndpointBlockingSend：这是用于实现同步发送请求的类。所谓的同步发送，是指该线程使用它给指定 Broker 发送请求，然后线程处于阻塞状态，直到接收到 Broker 返回的 Response。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4996"><span data-slate-object="text" data-key="4997"><span data-slate-leaf="true" data-offset-key="4997:0" data-first-offset="true"><span data-slate-string="true">除了构造函数中定义的字段之外，ReplicaFetcherThread 类还定义了与消息获取息息相关的 4 个字段。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4998"><div data-slate-type="list-line" data-slate-object="block" data-key="4999"><span data-slate-object="text" data-key="5000"><span data-slate-leaf="true" data-offset-key="5000:0" data-first-offset="true"><span data-slate-string="true">maxWait：Follower 发送的 FETCH 请求被处理返回前的最长等待时间。它是 Broker 端参数 replica.fetch.wait.max.ms 的值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5001"><span data-slate-object="text" data-key="5002"><span data-slate-leaf="true" data-offset-key="5002:0" data-first-offset="true"><span data-slate-string="true">minBytes：每个 FETCH Response 返回前必须要累积的最少字节数。它是 Broker 端参数 replica.fetch.min.bytes 的值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5003"><span data-slate-object="text" data-key="5004"><span data-slate-leaf="true" data-offset-key="5004:0" data-first-offset="true"><span data-slate-string="true">maxBytes：每个合法 FETCH Response 的最大字节数。它是 Broker 端参数 replica.fetch.response.max.bytes 的值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5005"><span data-slate-object="text" data-key="5006"><span data-slate-leaf="true" data-offset-key="5006:0" data-first-offset="true"><span data-slate-string="true">fetchSize：单个分区能够获取到的最大字节数。它是 Broker 端参数 replica.fetch.max.bytes 的值。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5007"><span data-slate-object="text" data-key="5008"><span data-slate-leaf="true" data-offset-key="5008:0" data-first-offset="true"><span data-slate-string="true">这 4 个参数都是 FETCH 请求的参数，主要控制了 Follower 副本拉取 Leader 副本消息的行为，比如一次请求到底能够获取多少字节的数据，或者当未达到累积阈值时，FETCH 请求等待多长时间等。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="5009" id="sr-toc-4"><span data-slate-object="text" data-key="5010"><span data-slate-leaf="true" data-offset-key="5010:0" data-first-offset="true"><span data-slate-string="true">重要方法</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="5011"><span data-slate-object="text" data-key="5012"><span data-slate-leaf="true" data-offset-key="5012:0" data-first-offset="true"><span data-slate-string="true">接下来，我们继续学习 ReplicaFetcherThread 的 3 个重要方法：processPartitionData、buildFetch 和 truncate。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5013"><span data-slate-object="text" data-key="5014"><span data-slate-leaf="true" data-offset-key="5014:0" data-first-offset="true"><span data-slate-string="true">为什么是这 3 个方法呢？因为它们代表了 Follower 副本拉取线程要做的最重要的三件事：处理拉取的消息、构建拉取消息的请求，以及执行截断日志操作。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="5015" id="sr-toc-5"><span data-slate-object="text" data-key="5016"><span data-slate-leaf="true" data-offset-key="5016:0" data-first-offset="true"><span data-slate-string="true">processPartitionData 方法</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="5017"><span data-slate-object="text" data-key="5018"><span data-slate-leaf="true" data-offset-key="5018:0" data-first-offset="true"><span data-slate-string="true">我们先来看 processPartitionData 方法。AbstractFetcherThread 线程从 Leader 副本拉取回消息后，需要调用 processPartitionData 方法进行后续动作。该方法的代码很长，我给其中的关键步骤添加了注释：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="5019"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5020"><span data-slate-object="text" data-key="5021"><span data-slate-leaf="true" data-offset-key="5021:0" data-first-offset="true"><span data-slate-string="true">override def </span></span></span><span data-slate-object="text" data-key="5022"><span data-slate-leaf="true" data-offset-key="5022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processPartitionData</span></span></span></span><span data-slate-object="text" data-key="5023"><span data-slate-leaf="true" data-offset-key="5023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5024"><span data-slate-object="text" data-key="5025"><span data-slate-leaf="true" data-offset-key="5025:0" data-first-offset="true"><span data-slate-string="true">  topicPartition: TopicPartition,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5026"><span data-slate-object="text" data-key="5027"><span data-slate-leaf="true" data-offset-key="5027:0" data-first-offset="true"><span data-slate-string="true">  fetchOffset: Long,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5028"><span data-slate-object="text" data-key="5029"><span data-slate-leaf="true" data-offset-key="5029:0" data-first-offset="true"><span data-slate-string="true">  partitionData: FetchData): Option[LogAppendInfo] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5030"><span data-slate-object="text" data-key="5031"><span data-slate-leaf="true" data-offset-key="5031:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5032"><span data-slate-leaf="true" data-offset-key="5032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5033"><span data-slate-leaf="true" data-offset-key="5033:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5034"><span data-slate-leaf="true" data-offset-key="5034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logTrace</span></span></span></span><span data-slate-object="text" data-key="5035"><span data-slate-leaf="true" data-offset-key="5035:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5036"><span data-slate-leaf="true" data-offset-key="5036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5037"><span data-slate-leaf="true" data-offset-key="5037:0" data-first-offset="true"><span data-slate-string="true"> isTraceEnabled</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5038"><span data-slate-object="text" data-key="5039"><span data-slate-leaf="true" data-offset-key="5039:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5040"><span data-slate-leaf="true" data-offset-key="5040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从副本管理器获取指定主题分区对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5041"><span data-slate-object="text" data-key="5042"><span data-slate-leaf="true" data-offset-key="5042:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5043"><span data-slate-leaf="true" data-offset-key="5043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5044"><span data-slate-leaf="true" data-offset-key="5044:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5045"><span data-slate-leaf="true" data-offset-key="5045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partition</span></span></span></span><span data-slate-object="text" data-key="5046"><span data-slate-leaf="true" data-offset-key="5046:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5047"><span data-slate-leaf="true" data-offset-key="5047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5048"><span data-slate-leaf="true" data-offset-key="5048:0" data-first-offset="true"><span data-slate-string="true"> replicaMgr.nonOfflinePartition(topicPartition).get</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5049"><span data-slate-object="text" data-key="5050"><span data-slate-leaf="true" data-offset-key="5050:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5051"><span data-slate-leaf="true" data-offset-key="5051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取日志对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5052"><span data-slate-object="text" data-key="5053"><span data-slate-leaf="true" data-offset-key="5053:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5054"><span data-slate-leaf="true" data-offset-key="5054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5055"><span data-slate-leaf="true" data-offset-key="5055:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5056"><span data-slate-leaf="true" data-offset-key="5056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">log</span></span></span></span><span data-slate-object="text" data-key="5057"><span data-slate-leaf="true" data-offset-key="5057:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5058"><span data-slate-leaf="true" data-offset-key="5058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5059"><span data-slate-leaf="true" data-offset-key="5059:0" data-first-offset="true"><span data-slate-string="true"> partition.localLogOrException</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5060"><span data-slate-object="text" data-key="5061"><span data-slate-leaf="true" data-offset-key="5061:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5062"><span data-slate-leaf="true" data-offset-key="5062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将获取到的数据转换成符合格式要求的消息集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5063"><span data-slate-object="text" data-key="5064"><span data-slate-leaf="true" data-offset-key="5064:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5065"><span data-slate-leaf="true" data-offset-key="5065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5066"><span data-slate-leaf="true" data-offset-key="5066:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5067"><span data-slate-leaf="true" data-offset-key="5067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">records</span></span></span></span><span data-slate-object="text" data-key="5068"><span data-slate-leaf="true" data-offset-key="5068:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5069"><span data-slate-leaf="true" data-offset-key="5069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5070"><span data-slate-leaf="true" data-offset-key="5070:0" data-first-offset="true"><span data-slate-string="true"> toMemoryRecords(partitionData.records)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5071"><span data-slate-object="text" data-key="5072"><span data-slate-leaf="true" data-offset-key="5072:0" data-first-offset="true"><span data-slate-string="true">  maybeWarnIfOversizedRecords(records, topicPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5073"><span data-slate-object="text" data-key="5074"><span data-slate-leaf="true" data-offset-key="5074:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5075"><span data-slate-leaf="true" data-offset-key="5075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 要读取的起始位移值如果不是本地日志 LEO 值则视为异常情况</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5076"><span data-slate-object="text" data-key="5077"><span data-slate-leaf="true" data-offset-key="5077:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5078"><span data-slate-leaf="true" data-offset-key="5078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5079"><span data-slate-leaf="true" data-offset-key="5079:0" data-first-offset="true"><span data-slate-string="true"> (fetchOffset != log.logEndOffset)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5080"><span data-slate-object="text" data-key="5081"><span data-slate-leaf="true" data-offset-key="5081:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5082"><span data-slate-leaf="true" data-offset-key="5082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="5083"><span data-slate-leaf="true" data-offset-key="5083:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5084"><span data-slate-leaf="true" data-offset-key="5084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="5085"><span data-slate-leaf="true" data-offset-key="5085:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5086"><span data-slate-leaf="true" data-offset-key="5086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">IllegalStateException</span></span></span></span><span data-slate-object="text" data-key="5087"><span data-slate-leaf="true" data-offset-key="5087:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="5088"><span data-slate-leaf="true" data-offset-key="5088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Offset mismatch for partition %s: fetched offset = %d, log end offset = %d."</span></span></span></span><span data-slate-object="text" data-key="5089"><span data-slate-leaf="true" data-offset-key="5089:0" data-first-offset="true"><span data-slate-string="true">.format(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5090"><span data-slate-object="text" data-key="5091"><span data-slate-leaf="true" data-offset-key="5091:0" data-first-offset="true"><span data-slate-string="true">      topicPartition, fetchOffset, log.logEndOffset))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5092"><span data-slate-object="text" data-key="5093"><span data-slate-leaf="true" data-offset-key="5093:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5094"><span data-slate-leaf="true" data-offset-key="5094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5095"><span data-slate-leaf="true" data-offset-key="5095:0" data-first-offset="true"><span data-slate-string="true"> (logTrace)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5096"><span data-slate-object="text" data-key="5097"><span data-slate-leaf="true" data-offset-key="5097:0" data-first-offset="true"><span data-slate-string="true">    trace(</span></span></span><span data-slate-object="text" data-key="5098"><span data-slate-leaf="true" data-offset-key="5098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Follower has replica log end offset %d for partition %s. Received %d messages and leader hw %d"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5099"><span data-slate-object="text" data-key="5100"><span data-slate-leaf="true" data-offset-key="5100:0" data-first-offset="true"><span data-slate-string="true">      .format(log.logEndOffset, topicPartition, records.sizeInBytes, partitionData.highWatermark))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5101"><span data-slate-object="text" data-key="5102"><span data-slate-leaf="true" data-offset-key="5102:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5103"><span data-slate-leaf="true" data-offset-key="5103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 写入 Follower 副本本地日志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5104"><span data-slate-object="text" data-key="5105"><span data-slate-leaf="true" data-offset-key="5105:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5106"><span data-slate-leaf="true" data-offset-key="5106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5107"><span data-slate-leaf="true" data-offset-key="5107:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5108"><span data-slate-leaf="true" data-offset-key="5108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logAppendInfo</span></span></span></span><span data-slate-object="text" data-key="5109"><span data-slate-leaf="true" data-offset-key="5109:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5110"><span data-slate-leaf="true" data-offset-key="5110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5111"><span data-slate-leaf="true" data-offset-key="5111:0" data-first-offset="true"><span data-slate-string="true"> partition.appendRecordsToFollowerOrFutureReplica(records, isFuture = </span></span></span><span data-slate-object="text" data-key="5112"><span data-slate-leaf="true" data-offset-key="5112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="5113"><span data-slate-leaf="true" data-offset-key="5113:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5114"><span data-slate-object="text" data-key="5115"><span data-slate-leaf="true" data-offset-key="5115:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5116"><span data-slate-leaf="true" data-offset-key="5116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5117"><span data-slate-leaf="true" data-offset-key="5117:0" data-first-offset="true"><span data-slate-string="true"> (logTrace)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5118"><span data-slate-object="text" data-key="5119"><span data-slate-leaf="true" data-offset-key="5119:0" data-first-offset="true"><span data-slate-string="true">    trace(</span></span></span><span data-slate-object="text" data-key="5120"><span data-slate-leaf="true" data-offset-key="5120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Follower has replica log end offset %d after appending %d bytes of messages for partition %s"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5121"><span data-slate-object="text" data-key="5122"><span data-slate-leaf="true" data-offset-key="5122:0" data-first-offset="true"><span data-slate-string="true">      .format(log.logEndOffset, records.sizeInBytes, topicPartition))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5123"><span data-slate-object="text" data-key="5124"><span data-slate-leaf="true" data-offset-key="5124:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5125"><span data-slate-leaf="true" data-offset-key="5125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5126"><span data-slate-leaf="true" data-offset-key="5126:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5127"><span data-slate-leaf="true" data-offset-key="5127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">leaderLogStartOffset</span></span></span></span><span data-slate-object="text" data-key="5128"><span data-slate-leaf="true" data-offset-key="5128:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5129"><span data-slate-leaf="true" data-offset-key="5129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5130"><span data-slate-leaf="true" data-offset-key="5130:0" data-first-offset="true"><span data-slate-string="true"> partitionData.logStartOffset</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5131"><span data-slate-object="text" data-key="5132"><span data-slate-leaf="true" data-offset-key="5132:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5133"><span data-slate-leaf="true" data-offset-key="5133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 Follower 副本的高水位值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5134"><span data-slate-object="text" data-key="5135"><span data-slate-leaf="true" data-offset-key="5135:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5136"><span data-slate-leaf="true" data-offset-key="5136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5137"><span data-slate-leaf="true" data-offset-key="5137:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5138"><span data-slate-leaf="true" data-offset-key="5138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">followerHighWatermark</span></span></span></span><span data-slate-object="text" data-key="5139"><span data-slate-leaf="true" data-offset-key="5139:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5140"><span data-slate-leaf="true" data-offset-key="5140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5141"><span data-slate-leaf="true" data-offset-key="5141:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5142"><span data-slate-object="text" data-key="5143"><span data-slate-leaf="true" data-offset-key="5143:0" data-first-offset="true"><span data-slate-string="true">    log.updateHighWatermark(partitionData.highWatermark)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5144"><span data-slate-object="text" data-key="5145"><span data-slate-leaf="true" data-offset-key="5145:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5146"><span data-slate-leaf="true" data-offset-key="5146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 尝试更新 Follower 副本的 Log Start Offset 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5147"><span data-slate-object="text" data-key="5148"><span data-slate-leaf="true" data-offset-key="5148:0" data-first-offset="true"><span data-slate-string="true">  log.maybeIncrementLogStartOffset(leaderLogStartOffset, LeaderOffsetIncremented)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5149"><span data-slate-object="text" data-key="5150"><span data-slate-leaf="true" data-offset-key="5150:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5151"><span data-slate-leaf="true" data-offset-key="5151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5152"><span data-slate-leaf="true" data-offset-key="5152:0" data-first-offset="true"><span data-slate-string="true"> (logTrace)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5153"><span data-slate-object="text" data-key="5154"><span data-slate-leaf="true" data-offset-key="5154:0" data-first-offset="true"><span data-slate-string="true">    trace(s</span></span></span><span data-slate-object="text" data-key="5155"><span data-slate-leaf="true" data-offset-key="5155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Follower set replica high watermark for partition $topicPartition to $followerHighWatermark"</span></span></span></span><span data-slate-object="text" data-key="5156"><span data-slate-leaf="true" data-offset-key="5156:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5157"><span data-slate-object="text" data-key="5158"><span data-slate-leaf="true" data-offset-key="5158:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5159"><span data-slate-leaf="true" data-offset-key="5159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 副本消息拉取限流</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5160"><span data-slate-object="text" data-key="5161"><span data-slate-leaf="true" data-offset-key="5161:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5162"><span data-slate-leaf="true" data-offset-key="5162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5163"><span data-slate-leaf="true" data-offset-key="5163:0" data-first-offset="true"><span data-slate-string="true"> (quota.isThrottled(topicPartition))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5164"><span data-slate-object="text" data-key="5165"><span data-slate-leaf="true" data-offset-key="5165:0" data-first-offset="true"><span data-slate-string="true">    quota.record(records.sizeInBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5166"><span data-slate-object="text" data-key="5167"><span data-slate-leaf="true" data-offset-key="5167:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5168"><span data-slate-leaf="true" data-offset-key="5168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新统计指标值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5169"><span data-slate-object="text" data-key="5170"><span data-slate-leaf="true" data-offset-key="5170:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5171"><span data-slate-leaf="true" data-offset-key="5171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5172"><span data-slate-leaf="true" data-offset-key="5172:0" data-first-offset="true"><span data-slate-string="true"> (partition.isReassigning &amp;&amp; partition.isAddingLocalReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5173"><span data-slate-object="text" data-key="5174"><span data-slate-leaf="true" data-offset-key="5174:0" data-first-offset="true"><span data-slate-string="true">    brokerTopicStats.updateReassignmentBytesIn(records.sizeInBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5175"><span data-slate-object="text" data-key="5176"><span data-slate-leaf="true" data-offset-key="5176:0" data-first-offset="true"><span data-slate-string="true">  brokerTopicStats.updateReplicationBytesIn(records.sizeInBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5177"><span data-slate-object="text" data-key="5178"><span data-slate-leaf="true" data-offset-key="5178:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5179"><span data-slate-leaf="true" data-offset-key="5179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回日志写入结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5180"><span data-slate-object="text" data-key="5181"><span data-slate-leaf="true" data-offset-key="5181:0" data-first-offset="true"><span data-slate-string="true">  logAppendInfo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5182"><span data-slate-object="text" data-key="5183"><span data-slate-leaf="true" data-offset-key="5183:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5184"><span data-slate-object="text" data-key="5185"><span data-slate-leaf="true" data-offset-key="5185:0" data-first-offset="true"><span data-slate-string="true">在详细解释前，我使用一张流程图帮助你直观地理解这个方法到底做了什么事情。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5186"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/d0/26/d0342f40ff5470086fb904983dbd3f26.png?wh=1905*4245"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5187"><span data-slate-object="text" data-key="5188"><span data-slate-leaf="true" data-offset-key="5188:0" data-first-offset="true"><span data-slate-string="true">processPartitionData 方法中的 process，实际上就是写入 Follower 副本本地日志的意思。因此，这个方法的主体逻辑，就是调用分区对象 Partition 的 appendRecordsToFollowerOrFutureReplica 写入获取到的消息。如果你沿着这个写入方法一路追下去，就会发现它调用的是我们在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5189"><span data-slate-object="text" data-key="5190"><span data-slate-leaf="true" data-offset-key="5190:0" data-first-offset="true"><span data-slate-string="true">第 2 讲</span></span></span></a><span data-slate-object="text" data-key="5191"><span data-slate-leaf="true" data-offset-key="5191:0" data-first-offset="true"><span data-slate-string="true">中讲到过的 appendAsFollower 方法。你看一切都能串联起来，源码也没什么大不了的，对吧？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5192"><span data-slate-object="text" data-key="5193"><span data-slate-leaf="true" data-offset-key="5193:0" data-first-offset="true"><span data-slate-string="true">当然，仅仅写入日志还不够。我们还要做一些更新操作。比如，需要更新 Follower 副本的高水位值，即将 FETCH 请求 Response 中包含的高水位值作为新的高水位值，同时代码还要尝试更新 Follower 副本的 Log Start Offset 值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5194"><span data-slate-object="text" data-key="5195"><span data-slate-leaf="true" data-offset-key="5195:0" data-first-offset="true"><span data-slate-string="true">那为什么 Log Start Offset 值也可能发生变化呢？这是因为 Leader 的 Log Start Offset 可能发生变化，比如用户手动执行了删除消息的操作等。Follower 副本的日志需要和 Leader 保持严格的一致，因此，如果 Leader 的该值发生变化，Follower 自然也要发生变化，以保持一致。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5196"><span data-slate-object="text" data-key="5197"><span data-slate-leaf="true" data-offset-key="5197:0" data-first-offset="true"><span data-slate-string="true">除此之外，processPartitionData 方法还会更新其他一些统计指标值，最后将写入结果返回。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="5198" id="sr-toc-6"><span data-slate-object="text" data-key="5199"><span data-slate-leaf="true" data-offset-key="5199:0" data-first-offset="true"><span data-slate-string="true">buildFetch 方法</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="5200"><span data-slate-object="text" data-key="5201"><span data-slate-leaf="true" data-offset-key="5201:0" data-first-offset="true"><span data-slate-string="true">接下来， 我们看下 buildFetch 方法。此方法的主要目的是，构建发送给 Leader 副本所在 Broker 的 FETCH 请求。它的代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="5202"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5203"><span data-slate-object="text" data-key="5204"><span data-slate-leaf="true" data-offset-key="5204:0" data-first-offset="true"><span data-slate-string="true">override def </span></span></span><span data-slate-object="text" data-key="5205"><span data-slate-leaf="true" data-offset-key="5205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">buildFetch</span></span></span></span><span data-slate-object="text" data-key="5206"><span data-slate-leaf="true" data-offset-key="5206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5207"><span data-slate-object="text" data-key="5208"><span data-slate-leaf="true" data-offset-key="5208:0" data-first-offset="true"><span data-slate-string="true">  partitionMap: Map[TopicPartition, PartitionFetchState]): ResultWithPartitions[Option[ReplicaFetch]] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5209"><span data-slate-object="text" data-key="5210"><span data-slate-leaf="true" data-offset-key="5210:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5211"><span data-slate-leaf="true" data-offset-key="5211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5212"><span data-slate-leaf="true" data-offset-key="5212:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5213"><span data-slate-leaf="true" data-offset-key="5213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionsWithError</span></span></span></span><span data-slate-object="text" data-key="5214"><span data-slate-leaf="true" data-offset-key="5214:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5215"><span data-slate-leaf="true" data-offset-key="5215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5216"><span data-slate-leaf="true" data-offset-key="5216:0" data-first-offset="true"><span data-slate-string="true"> mutable.Set[TopicPartition]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5217"><span data-slate-object="text" data-key="5218"><span data-slate-leaf="true" data-offset-key="5218:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5219"><span data-slate-leaf="true" data-offset-key="5219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5220"><span data-slate-leaf="true" data-offset-key="5220:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5221"><span data-slate-leaf="true" data-offset-key="5221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">builder</span></span></span></span><span data-slate-object="text" data-key="5222"><span data-slate-leaf="true" data-offset-key="5222:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5223"><span data-slate-leaf="true" data-offset-key="5223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5224"><span data-slate-leaf="true" data-offset-key="5224:0" data-first-offset="true"><span data-slate-string="true"> fetchSessionHandler.newBuilder(partitionMap.size, </span></span></span><span data-slate-object="text" data-key="5225"><span data-slate-leaf="true" data-offset-key="5225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="5226"><span data-slate-leaf="true" data-offset-key="5226:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5227"><span data-slate-object="text" data-key="5228"><span data-slate-leaf="true" data-offset-key="5228:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5229"><span data-slate-leaf="true" data-offset-key="5229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历每个分区，将处于可获取状态的分区添加到 builder 后续统一处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5230"><span data-slate-object="text" data-key="5231"><span data-slate-leaf="true" data-offset-key="5231:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5232"><span data-slate-leaf="true" data-offset-key="5232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对于有错误的分区加入到出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5233"><span data-slate-object="text" data-key="5234"><span data-slate-leaf="true" data-offset-key="5234:0" data-first-offset="true"><span data-slate-string="true">  partitionMap.foreach { </span></span></span><span data-slate-object="text" data-key="5235"><span data-slate-leaf="true" data-offset-key="5235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="5236"><span data-slate-leaf="true" data-offset-key="5236:0" data-first-offset="true"><span data-slate-string="true"> (topicPartition, fetchState) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5237"><span data-slate-object="text" data-key="5238"><span data-slate-leaf="true" data-offset-key="5238:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5239"><span data-slate-leaf="true" data-offset-key="5239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5240"><span data-slate-leaf="true" data-offset-key="5240:0" data-first-offset="true"><span data-slate-string="true"> (fetchState.isReadyForFetch &amp;&amp; !shouldFollowerThrottle(quota, fetchState, topicPartition)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5241"><span data-slate-object="text" data-key="5242"><span data-slate-leaf="true" data-offset-key="5242:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="5243"><span data-slate-leaf="true" data-offset-key="5243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="5244"><span data-slate-leaf="true" data-offset-key="5244:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5245"><span data-slate-object="text" data-key="5246"><span data-slate-leaf="true" data-offset-key="5246:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5247"><span data-slate-leaf="true" data-offset-key="5247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5248"><span data-slate-leaf="true" data-offset-key="5248:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5249"><span data-slate-leaf="true" data-offset-key="5249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logStartOffset</span></span></span></span><span data-slate-object="text" data-key="5250"><span data-slate-leaf="true" data-offset-key="5250:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5251"><span data-slate-leaf="true" data-offset-key="5251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5252"><span data-slate-leaf="true" data-offset-key="5252:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5253"><span data-slate-leaf="true" data-offset-key="5253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="5254"><span data-slate-leaf="true" data-offset-key="5254:0" data-first-offset="true"><span data-slate-string="true">.logStartOffset(topicPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5255"><span data-slate-object="text" data-key="5256"><span data-slate-leaf="true" data-offset-key="5256:0" data-first-offset="true"><span data-slate-string="true">        builder.add(topicPartition, </span></span></span><span data-slate-object="text" data-key="5257"><span data-slate-leaf="true" data-offset-key="5257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="5258"><span data-slate-leaf="true" data-offset-key="5258:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5259"><span data-slate-leaf="true" data-offset-key="5259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">FetchRequest</span></span></span></span><span data-slate-object="text" data-key="5260"><span data-slate-leaf="true" data-offset-key="5260:0" data-first-offset="true"><span data-slate-string="true">.PartitionData(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5261"><span data-slate-object="text" data-key="5262"><span data-slate-leaf="true" data-offset-key="5262:0" data-first-offset="true"><span data-slate-string="true">          fetchState.fetchOffset, logStartOffset, fetchSize, Optional.of(fetchState.currentLeaderEpoch)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5263"><span data-slate-object="text" data-key="5264"><span data-slate-leaf="true" data-offset-key="5264:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="5265"><span data-slate-leaf="true" data-offset-key="5265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="5266"><span data-slate-leaf="true" data-offset-key="5266:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5267"><span data-slate-object="text" data-key="5268"><span data-slate-leaf="true" data-offset-key="5268:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5269"><span data-slate-leaf="true" data-offset-key="5269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="5270"><span data-slate-leaf="true" data-offset-key="5270:0" data-first-offset="true"><span data-slate-string="true"> _: KafkaStorageException =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5271"><span data-slate-object="text" data-key="5272"><span data-slate-leaf="true" data-offset-key="5272:0" data-first-offset="true"><span data-slate-string="true">          partitionsWithError += topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5273"><span data-slate-object="text" data-key="5274"><span data-slate-leaf="true" data-offset-key="5274:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5275"><span data-slate-object="text" data-key="5276"><span data-slate-leaf="true" data-offset-key="5276:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5277"><span data-slate-object="text" data-key="5278"><span data-slate-leaf="true" data-offset-key="5278:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5279"><span data-slate-object="text" data-key="5280"><span data-slate-leaf="true" data-offset-key="5280:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5281"><span data-slate-leaf="true" data-offset-key="5281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5282"><span data-slate-leaf="true" data-offset-key="5282:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5283"><span data-slate-leaf="true" data-offset-key="5283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchData</span></span></span></span><span data-slate-object="text" data-key="5284"><span data-slate-leaf="true" data-offset-key="5284:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5285"><span data-slate-leaf="true" data-offset-key="5285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5286"><span data-slate-leaf="true" data-offset-key="5286:0" data-first-offset="true"><span data-slate-string="true"> builder.build()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5287"><span data-slate-object="text" data-key="5288"><span data-slate-leaf="true" data-offset-key="5288:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5289"><span data-slate-leaf="true" data-offset-key="5289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5290"><span data-slate-leaf="true" data-offset-key="5290:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5291"><span data-slate-leaf="true" data-offset-key="5291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fetchRequestOpt</span></span></span></span><span data-slate-object="text" data-key="5292"><span data-slate-leaf="true" data-offset-key="5292:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5293"><span data-slate-leaf="true" data-offset-key="5293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5294"><span data-slate-leaf="true" data-offset-key="5294:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5295"><span data-slate-leaf="true" data-offset-key="5295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5296"><span data-slate-leaf="true" data-offset-key="5296:0" data-first-offset="true"><span data-slate-string="true"> (fetchData.sessionPartitions.isEmpty &amp;&amp; fetchData.toForget.isEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5297"><span data-slate-object="text" data-key="5298"><span data-slate-leaf="true" data-offset-key="5298:0" data-first-offset="true"><span data-slate-string="true">    None</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5299"><span data-slate-object="text" data-key="5300"><span data-slate-leaf="true" data-offset-key="5300:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="5301"><span data-slate-leaf="true" data-offset-key="5301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="5302"><span data-slate-leaf="true" data-offset-key="5302:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5303"><span data-slate-object="text" data-key="5304"><span data-slate-leaf="true" data-offset-key="5304:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5305"><span data-slate-leaf="true" data-offset-key="5305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构造 FETCH 请求的 Builder 对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5306"><span data-slate-object="text" data-key="5307"><span data-slate-leaf="true" data-offset-key="5307:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5308"><span data-slate-leaf="true" data-offset-key="5308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="5309"><span data-slate-leaf="true" data-offset-key="5309:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5310"><span data-slate-leaf="true" data-offset-key="5310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestBuilder</span></span></span></span><span data-slate-object="text" data-key="5311"><span data-slate-leaf="true" data-offset-key="5311:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5312"><span data-slate-leaf="true" data-offset-key="5312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="5313"><span data-slate-leaf="true" data-offset-key="5313:0" data-first-offset="true"><span data-slate-string="true"> FetchRequest.Builder</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5314"><span data-slate-object="text" data-key="5315"><span data-slate-leaf="true" data-offset-key="5315:0" data-first-offset="true"><span data-slate-string="true">      .forReplica(fetchRequestVersion, replicaId, maxWait, minBytes, fetchData.toSend)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5316"><span data-slate-object="text" data-key="5317"><span data-slate-leaf="true" data-offset-key="5317:0" data-first-offset="true"><span data-slate-string="true">      .setMaxBytes(maxBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5318"><span data-slate-object="text" data-key="5319"><span data-slate-leaf="true" data-offset-key="5319:0" data-first-offset="true"><span data-slate-string="true">      .toForget(fetchData.toForget)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5320"><span data-slate-object="text" data-key="5321"><span data-slate-leaf="true" data-offset-key="5321:0" data-first-offset="true"><span data-slate-string="true">      .metadata(fetchData.metadata)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5322"><span data-slate-object="text" data-key="5323"><span data-slate-leaf="true" data-offset-key="5323:0" data-first-offset="true"><span data-slate-string="true">    Some(ReplicaFetch(fetchData.sessionPartitions(), requestBuilder))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5324"><span data-slate-object="text" data-key="5325"><span data-slate-leaf="true" data-offset-key="5325:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5326"><span data-slate-object="text" data-key="5327"><span data-slate-leaf="true" data-offset-key="5327:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5328"><span data-slate-leaf="true" data-offset-key="5328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回 Builder 对象以及出错分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5329"><span data-slate-object="text" data-key="5330"><span data-slate-leaf="true" data-offset-key="5330:0" data-first-offset="true"><span data-slate-string="true">  ResultWithPartitions(fetchRequestOpt, partitionsWithError)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5331"><span data-slate-object="text" data-key="5332"><span data-slate-leaf="true" data-offset-key="5332:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5333"><span data-slate-object="text" data-key="5334"><span data-slate-leaf="true" data-offset-key="5334:0" data-first-offset="true"><span data-slate-string="true">同样，我使用一张图来展示其完整流程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5335"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/b3/89/b321756cdc623fe790aa94deae40f989.png?wh=1845*4460"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5336"><span data-slate-object="text" data-key="5337"><span data-slate-leaf="true" data-offset-key="5337:0" data-first-offset="true"><span data-slate-string="true">这个方法的逻辑比 processPartitionData 简单。前面说到过，它就是构造 FETCH 请求的 Builder 对象然后返回。有了 Builder 对象，我们就可以分分钟构造出 FETCH 请求了，仅需要调用 builder.build () 即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5338"><span data-slate-object="text" data-key="5339"><span data-slate-leaf="true" data-offset-key="5339:0" data-first-offset="true"><span data-slate-string="true">当然，这个方法的一个副产品是汇总出错分区，这样的话，调用方后续可以统一处理这些出错分区。值得一提的是，在构造 Builder 的过程中，源码会用到 ReplicaFetcherThread 类定义的那些与消息获取相关的字段，如 maxWait、minBytes 和 maxBytes。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="5340" id="sr-toc-7"><span data-slate-object="text" data-key="5341"><span data-slate-leaf="true" data-offset-key="5341:0" data-first-offset="true"><span data-slate-string="true">truncate 方法</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="5342"><span data-slate-object="text" data-key="5343"><span data-slate-leaf="true" data-offset-key="5343:0" data-first-offset="true"><span data-slate-string="true">最后，我们看下 truncate 方法的实现。这个方法的主要目的是对给定分区执行日志截断操作。代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="5344"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5345"><span data-slate-object="text" data-key="5346"><span data-slate-leaf="true" data-offset-key="5346:0" data-first-offset="true"><span data-slate-string="true">override def truncate(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5347"><span data-slate-object="text" data-key="5348"><span data-slate-leaf="true" data-offset-key="5348:0" data-first-offset="true"><span data-slate-string="true">  tp: TopicPartition, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5349"><span data-slate-object="text" data-key="5350"><span data-slate-leaf="true" data-offset-key="5350:0" data-first-offset="true"><span data-slate-string="true">  offsetTruncationState: OffsetTruncationState): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5351"><span data-slate-object="text" data-key="5352"><span data-slate-leaf="true" data-offset-key="5352:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5353"><span data-slate-leaf="true" data-offset-key="5353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 拿到分区对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5354"><span data-slate-object="text" data-key="5355"><span data-slate-leaf="true" data-offset-key="5355:0" data-first-offset="true"><span data-slate-string="true">  val partition = replicaMgr.nonOfflinePartition(tp).</span></span></span><span data-slate-object="text" data-key="5356"><span data-slate-leaf="true" data-offset-key="5356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5357"><span data-slate-object="text" data-key="5358"><span data-slate-leaf="true" data-offset-key="5358:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5359"><span data-slate-leaf="true" data-offset-key="5359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 拿到分区本地日志 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5360"><span data-slate-object="text" data-key="5361"><span data-slate-leaf="true" data-offset-key="5361:0" data-first-offset="true"><span data-slate-string="true">  val log = partition.localLogOrException</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5362"><span data-slate-object="text" data-key="5363"><span data-slate-leaf="true" data-offset-key="5363:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5364"><span data-slate-leaf="true" data-offset-key="5364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行截断操作，截断到的位置由 offsetTruncationState 的 offset 指定</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5365"><span data-slate-object="text" data-key="5366"><span data-slate-leaf="true" data-offset-key="5366:0" data-first-offset="true"><span data-slate-string="true">  partition.truncateTo(offsetTruncationState.offset, isFuture = </span></span></span><span data-slate-object="text" data-key="5367"><span data-slate-leaf="true" data-offset-key="5367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="5368"><span data-slate-leaf="true" data-offset-key="5368:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5369"><span data-slate-object="text" data-key="5370"><span data-slate-leaf="true" data-offset-key="5370:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5371"><span data-slate-leaf="true" data-offset-key="5371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5372"><span data-slate-leaf="true" data-offset-key="5372:0" data-first-offset="true"><span data-slate-string="true"> (offsetTruncationState.offset &lt; log.highWatermark)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5373"><span data-slate-object="text" data-key="5374"><span data-slate-leaf="true" data-offset-key="5374:0" data-first-offset="true"><span data-slate-string="true">    warn(s</span></span></span><span data-slate-object="text" data-key="5375"><span data-slate-leaf="true" data-offset-key="5375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Truncating </span></span></span></span><span data-slate-object="text" data-key="5376"><span data-slate-leaf="true" data-offset-key="5376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$tp</span></span></span></span></span><span data-slate-object="text" data-key="5377"><span data-slate-leaf="true" data-offset-key="5377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> to offset </span></span></span></span><span data-slate-object="text" data-key="5378"><span data-slate-leaf="true" data-offset-key="5378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${offsetTruncationState.offset}</span></span></span></span></span><span data-slate-object="text" data-key="5379"><span data-slate-leaf="true" data-offset-key="5379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> below high watermark "</span></span></span></span><span data-slate-object="text" data-key="5380"><span data-slate-leaf="true" data-offset-key="5380:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5381"><span data-slate-object="text" data-key="5382"><span data-slate-leaf="true" data-offset-key="5382:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="5383"><span data-slate-leaf="true" data-offset-key="5383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="5384"><span data-slate-leaf="true" data-offset-key="5384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${log.highWatermark}</span></span></span></span></span><span data-slate-object="text" data-key="5385"><span data-slate-leaf="true" data-offset-key="5385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="5386"><span data-slate-leaf="true" data-offset-key="5386:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5387"><span data-slate-object="text" data-key="5388"><span data-slate-leaf="true" data-offset-key="5388:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5389"><span data-slate-leaf="true" data-offset-key="5389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5390"><span data-slate-leaf="true" data-offset-key="5390:0" data-first-offset="true"><span data-slate-string="true"> (offsetTruncationState.truncationCompleted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5391"><span data-slate-object="text" data-key="5392"><span data-slate-leaf="true" data-offset-key="5392:0" data-first-offset="true"><span data-slate-string="true">    replicaMgr.replicaAlterLogDirsManager</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5393"><span data-slate-object="text" data-key="5394"><span data-slate-leaf="true" data-offset-key="5394:0" data-first-offset="true"><span data-slate-string="true">      .markPartitionsForTruncation(brokerConfig.brokerId, tp,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5395"><span data-slate-object="text" data-key="5396"><span data-slate-leaf="true" data-offset-key="5396:0" data-first-offset="true"><span data-slate-string="true">      offsetTruncationState.offset)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5397"><span data-slate-object="text" data-key="5398"><span data-slate-leaf="true" data-offset-key="5398:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5399"><span data-slate-object="text" data-key="5400"><span data-slate-leaf="true" data-offset-key="5400:0" data-first-offset="true"><span data-slate-string="true">总体来说，truncate 方法利用给定的 offsetTruncationState 的 offset 值，对给定分区的本地日志进行截断操作。该操作由 Partition 对象的 truncateTo 方法完成，但实际上底层调用的是 Log 的 truncateTo 方法。truncateTo 方法的主要作用，是将日志截断到小于给定值的最大位移值处。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5401" id="sr-toc-8"><span data-slate-object="text" data-key="5402"><span data-slate-leaf="true" data-offset-key="5402:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5403"><span data-slate-object="text" data-key="5404"><span data-slate-leaf="true" data-offset-key="5404:0" data-first-offset="true"><span data-slate-string="true">好了，我们总结一下。就像我在开头时所说，AbstractFetcherThread 线程的 doWork 方法把上一讲提到的 3 个重要方法全部连接在一起，共同完整了拉取线程要执行的逻辑，即日志截断（truncate）+ 日志获取（buildFetch）+ 日志处理（processPartitionData），而其子类 ReplicaFetcherThread 类是真正实现该 3 个方法的地方。如果用一句话归纳起来，那就是：Follower 副本利用 ReplicaFetcherThread 线程实时地从 Leader 副本拉取消息并写入到本地日志，从而实现了与 Leader 副本之间的同步。以下是一些要点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5405"><div data-slate-type="list-line" data-slate-object="block" data-key="5406"><span data-slate-object="text" data-key="5407"><span data-slate-leaf="true" data-offset-key="5407:0" data-first-offset="true"><span data-slate-string="true">doWork 方法：拉取线程工作入口方法，联结所有重要的子功能方法，如执行截断操作，获取 Leader 副本消息以及写入本地日志。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5408"><span data-slate-object="text" data-key="5409"><span data-slate-leaf="true" data-offset-key="5409:0" data-first-offset="true"><span data-slate-string="true">truncate 方法：根据 Leader 副本返回的位移值和 Epoch 值执行本地日志的截断操作。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5410"><span data-slate-object="text" data-key="5411"><span data-slate-leaf="true" data-offset-key="5411:0" data-first-offset="true"><span data-slate-string="true">buildFetch 方法：为一组特定分区构建 FetchRequest 对象所需的数据结构。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5412"><span data-slate-object="text" data-key="5413"><span data-slate-leaf="true" data-offset-key="5413:0" data-first-offset="true"><span data-slate-string="true">processPartitionData 方法：处理从 Leader 副本获取到的消息，主要是写入到本地日志中。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="5414"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/eb/52/ebd9a667369fc304bce3yybdd439a152.jpg?wh=2251*2293"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5415"><span data-slate-object="text" data-key="5416"><span data-slate-leaf="true" data-offset-key="5416:0" data-first-offset="true"><span data-slate-string="true">实际上，今天的内容中多次出现副本管理器的身影。如果你仔细查看代码，你会发现 Follower 副本正是利用它来获取对应分区 Partition 对象的，然后依靠该对象执行消息写入。那么，副本管理器还有哪些其他功能呢？下一讲我将一一为你揭晓。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5417" id="sr-toc-9"><span data-slate-object="text" data-key="5418"><span data-slate-leaf="true" data-offset-key="5418:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5419"><span data-slate-object="text" data-key="5420"><span data-slate-leaf="true" data-offset-key="5420:0" data-first-offset="true"><span data-slate-string="true">你可以去查阅下源码，说说 updateFetchOffsetAndMaybeMarkTruncationComplete 方法是做什么用的吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5421"><span data-slate-object="text" data-key="5422"><span data-slate-leaf="true" data-offset-key="5422:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (6)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，我们重点学习了 DelayedOperation 类源码以及 Broker 是如何处理延时请求的。课后我请你简单描述下 handlePartitionsWithErrors 方法的实现原理。我的看法是这样的：这个方法接收一组分区，为它们调用 delayPartitions 方法执行延时处理。delayPartitions 方法会遍历每个给定的分区，并把这些分区依次加入到待读取分区列表的末端，从而实现延时重试操作。简单来说，Kafka 处理出错分区的思路就是将这些分区放入到轮询名单的末尾期待稍后重试。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-06-23</div><div><div><i></i><span></span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 伯安知心</span></div></div><div>updateFetchOffsetAndMaybeMarkTruncationComplete 方法只有在 truncateToEpochEndOffsets 和 truncateToHighWatermark 中结尾执行，简单来说就是 truncate 之后，更新标记截断完成，更新 partitionStates 值，如果它们的 offsetTruncationState 指示截断已完成，则可能将它们标记为截断已完成</div><div><p>作者回复: 👍</p></div><div><div>2020-06-16</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/4f/37/ad1ca21d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 在路上</span></div></div><div>图片里的房子我看了十分钟，这得学多少 kafka 才能拥有啊？</div><div><p>作者回复：阁下脑回路真是新奇，“害的” 我也看了半天图片：）</p></div><div><div>2020-11-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/55/eb/a441eda8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 梁聪明</span></div></div><div>updateFetchOffsetAndMaybeMarkTruncationComplete 方法：更新已经完成截断的分区状态为 Fetching</div><div><div>2020-08-31</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div> // 循环遍历所有分区，更新它们的取值偏移量，如果它们的 offsetTruncationState 表示截断完成，可以将它们标记为截断完成
  private def updateFetchOffsetAndMaybeMarkTruncationComplete (fetchOffsets: Map [TopicPartition, OffsetTruncationState]): Unit = {
    val newStates: Map [TopicPartition, PartitionFetchState] = partitionStates.partitionStateMap.asScala
      .map { case (topicPartition, currentFetchState) =&gt;
        val maybeTruncationComplete = fetchOffsets.get (topicPartition) match {
          case Some (offsetTruncationState) =&gt;
            val state = if (offsetTruncationState.truncationCompleted) Fetching else Truncating
            PartitionFetchState (offsetTruncationState.offset, currentFetchState.lag,
              currentFetchState.currentLeaderEpoch, currentFetchState.delay, state)
          case None =&gt; currentFetchState
        }
        (topicPartition, maybeTruncationComplete)
      }
    partitionStates.set (newStates.asJava)
  }     
ps (一边听着老师的语音一边看文档，更能提高注意力，后面的同学们可以尝试一下！)</div><div><div>2020-08-28</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/3a/89/272a4ecd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 哲</span></div></div><div>您好 
这块有个小问题想咨询一下
就是有没有参数去控制
consumer 的 fetch 频率
replica 的 fetch 频率  </div><div><p>作者回复: Replica 这端有两个参数可以使用：leader.replication.throttled.rate 和 follower.replication.throttled.rate

Consumer 端可以自己控制啊，比如人为地增加 sleep 等</p></div><div><div>2020-08-14</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".d"><outline class="toc-level-h1" data-reactid=".d.0" style="width: 175px;"><active data-reactid=".d.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".d.0.1"><span data-reactid=".d.0.1.0">22 | ReplicaFetcherThread：Follower 如何拉取 Leader 消息？</span></a></outline><outline class="toc-level-h2" data-reactid=".d.1" style="width: 165px;"><active data-reactid=".d.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".d.1.1"><span data-reactid=".d.1.1.0">AbstractFetcherThread 类：doWork 方法</span></a></outline><outline class="toc-level-h2" data-reactid=".d.2" style="width: 165px;"><active data-reactid=".d.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".d.2.1"><span data-reactid=".d.2.1.0">子类：ReplicaFetcherThread</span></a></outline><outline class="toc-level-h3" data-reactid=".d.3" style="width: 155px;"><active data-reactid=".d.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".d.3.1"><span data-reactid=".d.3.1.0">类定义及字段</span></a></outline><outline class="toc-level-h3" data-reactid=".d.4" style="width: 155px;"><active data-reactid=".d.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".d.4.1"><span data-reactid=".d.4.1.0">重要方法</span></a></outline><outline class="toc-level-h4" data-reactid=".d.5" style="width: 145px;"><active data-reactid=".d.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".d.5.1"><span data-reactid=".d.5.1.0">processPartitionData 方法</span></a></outline><outline class="toc-level-h4" data-reactid=".d.6" style="width: 145px;"><active data-reactid=".d.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".d.6.1"><span data-reactid=".d.6.1.0">buildFetch 方法</span></a></outline><outline class="toc-level-h4" data-reactid=".d.7" style="width: 145px;"><active data-reactid=".d.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".d.7.1"><span data-reactid=".d.7.1.0">truncate 方法</span></a></outline><outline class="toc-level-h2" data-reactid=".d.8" style="width: 165px;"><active data-reactid=".d.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".d.8.1"><span data-reactid=".d.8.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".d.9" style="width: 165px;"><active data-reactid=".d.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".d.9.1"><span data-reactid=".d.9.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".d.a" style="width: 165px;"><active data-reactid=".d.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".d.a.1"><span data-reactid=".d.a.1.0">精选留言 (6)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/248311" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>