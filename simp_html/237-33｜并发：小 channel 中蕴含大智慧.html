
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 33｜并发：小 channel 中蕴含大智慧</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>33｜并发：小 channel 中蕴含大智慧</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">今天，我会讲解 Go 语言提供的另一种分支控制结构：switch 语句。和 if 分支语句相比，在一些执行分支较多的场景下，使用 switch 分支控制语</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 33｜并发：小 channel 中蕴含大智慧</h1><div><span>Tony Bai</span> <span>2022-01-12</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/36/50/367c31ec3cbe25dedbda64e94c9d1350.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：Tony Bai</span><span> 大小：23.23M</span><span> 时长：25:26</span></div></div><audio title="33｜并发：小channel中蕴含大智慧" src="https://res001.geekbang.org/media/audio/a1/87/a124864bf06473714d4fe60920b76887/ld/ld.m3u8" __idm_id__="253967"></audio></div><div><div><div><div data-slate-editor="true" data-key="15798" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="15799"><span data-slate-object="text" data-key="15800"><span data-slate-leaf="true" data-offset-key="15800:0" data-first-offset="true"><span data-slate-string="true">你好，我是 Tony Bai。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15801"><span data-slate-object="text" data-key="15802"><span data-slate-leaf="true" data-offset-key="15802:0" data-first-offset="true"><span data-slate-string="true">通过上两节课的学习，我们知道了 Go 语言实现了基于 CSP（Communicating Sequential Processes）理论的并发方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15803"><span data-slate-object="text" data-key="15804"><span data-slate-leaf="true" data-offset-key="15804:0" data-first-offset="true"><span data-slate-string="true">Go 语言的 CSP 模型的实现包含两个主要组成部分：一个是 Goroutine，它是 Go 应用并发设计的基本构建与执行单元；另一个就是 channel，它在并发模型中扮演着重要的角色。channel 既可以用来实现 Goroutine 间的通信，还可以实现 Goroutine 间的同步。它就好比 Go 并发设计这门 “武功” 的秘籍口诀，可以说，学会在 Go 并发设计时灵活运用 channel，才能说真正掌握了 Go 并发设计的真谛。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15805"><span data-slate-object="text" data-key="15806"><span data-slate-leaf="true" data-offset-key="15806:0" data-first-offset="true"><span data-slate-string="true">所以，在这一讲中，我们就来系统学习 channel 这一并发原语的基础语法与常见使用方法。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15807" id="sr-toc-1"><span data-slate-object="text" data-key="15808"><span data-slate-leaf="true" data-offset-key="15808:0" data-first-offset="true"><span data-slate-string="true">作为一等公民的 channel</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15809"><span data-slate-object="text" data-key="15810"><span data-slate-leaf="true" data-offset-key="15810:0" data-first-offset="true"><span data-slate-string="true">Go 对并发的原生支持可不是仅仅停留在口号上的，Go 在语法层面将并发原语 channel 作为一等公民对待。在前面的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15811"><span data-slate-object="text" data-key="15812"><span data-slate-leaf="true" data-offset-key="15812:0" data-first-offset="true"><span data-slate-string="true">第 21 讲</span></span></span></a><span data-slate-object="text" data-key="15813"><span data-slate-leaf="true" data-offset-key="15813:0" data-first-offset="true"><span data-slate-string="true">中我们已经学过 “一等公民” 这个概念了，如果你记不太清了可以回去复习一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15814"><span data-slate-object="text" data-key="15815"><span data-slate-leaf="true" data-offset-key="15815:0" data-first-offset="true"><span data-slate-string="true">那 channel 作为一等公民意味着什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15816"><span data-slate-object="text" data-key="15817"><span data-slate-leaf="true" data-offset-key="15817:0" data-first-offset="true"><span data-slate-string="true">这意味着我们可以</span></span></span><span data-slate-object="text" data-key="15818"><span data-slate-leaf="true" data-offset-key="15818:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">像使用普通变量那样使用 channel</span></span></span></span><span data-slate-object="text" data-key="15819"><span data-slate-leaf="true" data-offset-key="15819:0" data-first-offset="true"><span data-slate-string="true">，比如，定义 channel 类型变量、给 channel 变量赋值、将 channel 作为参数传递给函数 / 方法、将 channel 作为返回值从函数 / 方法中返回，甚至将 channel 发送到其他 channel 中。这就大大简化了 channel 原语的使用，提升了我们开发者在做并发设计和实现时的体验。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15820" id="sr-toc-2"><span data-slate-object="text" data-key="15821"><span data-slate-leaf="true" data-offset-key="15821:0" data-first-offset="true"><span data-slate-string="true">创建 channel</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15822"><span data-slate-object="text" data-key="15823"><span data-slate-leaf="true" data-offset-key="15823:0" data-first-offset="true"><span data-slate-string="true">和切片、结构体、map 等一样，channel 也是一种复合数据类型。也就是说，我们在声明一个 channel 类型变量时，必须给出其具体的元素类型，比如下面的代码这样：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15824"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15825"><span data-slate-object="text" data-key="15826"><span data-slate-leaf="true" data-offset-key="15826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="15827"><span data-slate-leaf="true" data-offset-key="15827:0" data-first-offset="true"><span data-slate-string="true"> ch </span></span></span><span data-slate-object="text" data-key="15828"><span data-slate-leaf="true" data-offset-key="15828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="15829"><span data-slate-leaf="true" data-offset-key="15829:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15830"><span data-slate-leaf="true" data-offset-key="15830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15831"><span data-slate-object="text" data-key="15832"><span data-slate-leaf="true" data-offset-key="15832:0" data-first-offset="true"><span data-slate-string="true">这句代码里，我们声明了一个元素为 int 类型的 channel 类型变量 ch。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15833"><span data-slate-object="text" data-key="15834"><span data-slate-leaf="true" data-offset-key="15834:0" data-first-offset="true"><span data-slate-string="true">如果 channel 类型变量在声明时没有被赋予初值，那么它的默认值为 nil。并且，和其他复合数据类型支持使用复合类型字面值作为变量初始值不同，为 channel 类型变量赋初值的唯一方法就是使用 </span></span></span><span data-slate-object="text" data-key="15835"><span data-slate-leaf="true" data-offset-key="15835:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="15836"><span data-slate-leaf="true" data-offset-key="15836:0" data-first-offset="true"><span data-slate-string="true"> 这个 Go 预定义的函数，比如下面代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15837"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15838"><span data-slate-object="text" data-key="15839"><span data-slate-leaf="true" data-offset-key="15839:0" data-first-offset="true"><span data-slate-string="true">ch1 := </span></span></span><span data-slate-object="text" data-key="15840"><span data-slate-leaf="true" data-offset-key="15840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="15841"><span data-slate-leaf="true" data-offset-key="15841:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15842"><span data-slate-leaf="true" data-offset-key="15842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="15843"><span data-slate-leaf="true" data-offset-key="15843:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15844"><span data-slate-leaf="true" data-offset-key="15844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15845"><span data-slate-leaf="true" data-offset-key="15845:0" data-first-offset="true"><span data-slate-string="true">)   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15846"><span data-slate-object="text" data-key="15847"><span data-slate-leaf="true" data-offset-key="15847:0" data-first-offset="true"><span data-slate-string="true">ch2 := </span></span></span><span data-slate-object="text" data-key="15848"><span data-slate-leaf="true" data-offset-key="15848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="15849"><span data-slate-leaf="true" data-offset-key="15849:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15850"><span data-slate-leaf="true" data-offset-key="15850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="15851"><span data-slate-leaf="true" data-offset-key="15851:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15852"><span data-slate-leaf="true" data-offset-key="15852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15853"><span data-slate-leaf="true" data-offset-key="15853:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="15854"><span data-slate-leaf="true" data-offset-key="15854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="15855"><span data-slate-leaf="true" data-offset-key="15855:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15856"><span data-slate-object="text" data-key="15857"><span data-slate-leaf="true" data-offset-key="15857:0" data-first-offset="true"><span data-slate-string="true">这里，我们声明了两个元素类型为 int 的 channel 类型变量 ch1 和 ch2，并给这两个变量赋了初值。但我们看到，两个变量的赋初值操作使用的 make 调用的形式有所不同。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15858"><span data-slate-object="text" data-key="15859"><span data-slate-leaf="true" data-offset-key="15859:0" data-first-offset="true"><span data-slate-string="true">第一行我们通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15860"><span data-slate-object="text" data-key="15861"><span data-slate-leaf="true" data-offset-key="15861:0" data-first-offset="true"><span data-slate-string="true"> make(chan T)</span></span></span></span><span data-slate-object="text" data-key="15862"><span data-slate-leaf="true" data-offset-key="15862:0" data-first-offset="true"><span data-slate-string="true"> 创建的、元素类型为 T 的 channel 类型，是</span></span></span><span data-slate-object="text" data-key="15863"><span data-slate-leaf="true" data-offset-key="15863:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">无缓冲 channel</span></span></span></span><span data-slate-object="text" data-key="15864"><span data-slate-leaf="true" data-offset-key="15864:0" data-first-offset="true"><span data-slate-string="true">，而第二行中通过带有 capacity 参数的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15865"><span data-slate-object="text" data-key="15866"><span data-slate-leaf="true" data-offset-key="15866:0" data-first-offset="true"><span data-slate-string="true"> make(chan T, capacity)</span></span></span></span><span data-slate-object="text" data-key="15867"><span data-slate-leaf="true" data-offset-key="15867:0" data-first-offset="true"><span data-slate-string="true"> 创建的元素类型为 T、缓冲区长度为 capacity 的 channel 类型，是</span></span></span><span data-slate-object="text" data-key="15868"><span data-slate-leaf="true" data-offset-key="15868:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">带缓冲 channel</span></span></span></span><span data-slate-object="text" data-key="15869"><span data-slate-leaf="true" data-offset-key="15869:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15870"><span data-slate-object="text" data-key="15871"><span data-slate-leaf="true" data-offset-key="15871:0" data-first-offset="true"><span data-slate-string="true">这两种类型的变量关于发送（send）与接收（receive）的特性是不同的，我们接下来就基于这两种类型的 channel，看看 channel 类型变量如何进行发送和接收数据元素。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15872" id="sr-toc-3"><span data-slate-object="text" data-key="15873"><span data-slate-leaf="true" data-offset-key="15873:0" data-first-offset="true"><span data-slate-string="true">发送与接收</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15874"><span data-slate-object="text" data-key="15875"><span data-slate-leaf="true" data-offset-key="15875:0" data-first-offset="true"><span data-slate-string="true">Go 提供了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15876"><span data-slate-object="text" data-key="15877"><span data-slate-leaf="true" data-offset-key="15877:0" data-first-offset="true"><span data-slate-string="true"> &lt;-</span></span></span></span><span data-slate-object="text" data-key="15878"><span data-slate-leaf="true" data-offset-key="15878:0" data-first-offset="true"><span data-slate-string="true"> 操作符用于对 channel 类型变量进行发送与接收操作：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15879"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15880"><span data-slate-object="text" data-key="15881"><span data-slate-leaf="true" data-offset-key="15881:0" data-first-offset="true"><span data-slate-string="true">ch1 &lt;- </span></span></span><span data-slate-object="text" data-key="15882"><span data-slate-leaf="true" data-offset-key="15882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">13</span></span></span></span><span data-slate-object="text" data-key="15883"><span data-slate-leaf="true" data-offset-key="15883:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15884"><span data-slate-leaf="true" data-offset-key="15884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将整型字面值 13 发送到无缓冲 channel 类型变量 ch1 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15885"><span data-slate-object="text" data-key="15886"><span data-slate-leaf="true" data-offset-key="15886:0" data-first-offset="true"><span data-slate-string="true">n := &lt;- ch1  </span></span></span><span data-slate-object="text" data-key="15887"><span data-slate-leaf="true" data-offset-key="15887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从无缓冲 channel 类型变量 ch1 中接收一个整型值存储到整型变量 n 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15888"><span data-slate-object="text" data-key="15889"><span data-slate-leaf="true" data-offset-key="15889:0" data-first-offset="true"><span data-slate-string="true">ch2 &lt;- </span></span></span><span data-slate-object="text" data-key="15890"><span data-slate-leaf="true" data-offset-key="15890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17</span></span></span></span><span data-slate-object="text" data-key="15891"><span data-slate-leaf="true" data-offset-key="15891:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15892"><span data-slate-leaf="true" data-offset-key="15892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将整型字面值 17 发送到带缓冲 channel 类型变量 ch2 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15893"><span data-slate-object="text" data-key="15894"><span data-slate-leaf="true" data-offset-key="15894:0" data-first-offset="true"><span data-slate-string="true">m := &lt;- ch2  </span></span></span><span data-slate-object="text" data-key="15895"><span data-slate-leaf="true" data-offset-key="15895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从带缓冲 channel 类型变量 ch2 中接收一个整型值存储到整型变量 m 中</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15896"><span data-slate-object="text" data-key="15897"><span data-slate-leaf="true" data-offset-key="15897:0" data-first-offset="true"><span data-slate-string="true">这里我要提醒你一句，在理解 channel 的发送与接收操作时，你一定要始终牢记：</span></span></span><span data-slate-object="text" data-key="15898"><span data-slate-leaf="true" data-offset-key="15898:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">channel 是用于 Goroutine 间通信的</span></span></span></span><span data-slate-object="text" data-key="15899"><span data-slate-leaf="true" data-offset-key="15899:0" data-first-offset="true"><span data-slate-string="true">，所以绝大多数对 channel 的读写都被分别放在了不同的 Goroutine 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15900"><span data-slate-object="text" data-key="15901"><span data-slate-leaf="true" data-offset-key="15901:0" data-first-offset="true"><span data-slate-string="true">现在，我们先来看看无缓冲 channel 类型变量（如 ch1）的发送与接收。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15902"><span data-slate-object="text" data-key="15903"><span data-slate-leaf="true" data-offset-key="15903:0" data-first-offset="true"><span data-slate-string="true">由于无缓冲 channel 的运行时层实现不带有缓冲区，所以 Goroutine 对无缓冲 channel 的接收和发送操作是同步的。也就是说，对同一个无缓冲 channel，只有对它进行接收操作的 Goroutine 和对它进行发送操作的 Goroutine 都存在的情况下，通信才能得以进行，否则单方面的操作会让对应的 Goroutine 陷入挂起状态，比如下面示例代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15904"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15905"><span data-slate-object="text" data-key="15906"><span data-slate-leaf="true" data-offset-key="15906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15907"><span data-slate-leaf="true" data-offset-key="15907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15908"><span data-slate-leaf="true" data-offset-key="15908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="15909"><span data-slate-leaf="true" data-offset-key="15909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15910"><span data-slate-leaf="true" data-offset-key="15910:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15911"><span data-slate-object="text" data-key="15912"><span data-slate-leaf="true" data-offset-key="15912:0" data-first-offset="true"><span data-slate-string="true">    ch1 := </span></span></span><span data-slate-object="text" data-key="15913"><span data-slate-leaf="true" data-offset-key="15913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="15914"><span data-slate-leaf="true" data-offset-key="15914:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15915"><span data-slate-leaf="true" data-offset-key="15915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="15916"><span data-slate-leaf="true" data-offset-key="15916:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15917"><span data-slate-leaf="true" data-offset-key="15917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15918"><span data-slate-leaf="true" data-offset-key="15918:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15919"><span data-slate-object="text" data-key="15920"><span data-slate-leaf="true" data-offset-key="15920:0" data-first-offset="true"><span data-slate-string="true">    ch1 &lt;- </span></span></span><span data-slate-object="text" data-key="15921"><span data-slate-leaf="true" data-offset-key="15921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">13</span></span></span></span><span data-slate-object="text" data-key="15922"><span data-slate-leaf="true" data-offset-key="15922:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15923"><span data-slate-leaf="true" data-offset-key="15923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// fatal error: all goroutines are asleep - deadlock!</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15924"><span data-slate-object="text" data-key="15925"><span data-slate-leaf="true" data-offset-key="15925:0" data-first-offset="true"><span data-slate-string="true">    n := &lt;-ch1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15926"><span data-slate-object="text" data-key="15927"><span data-slate-leaf="true" data-offset-key="15927:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15928"><span data-slate-leaf="true" data-offset-key="15928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="15929"><span data-slate-leaf="true" data-offset-key="15929:0" data-first-offset="true"><span data-slate-string="true">(n)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15930"><span data-slate-object="text" data-key="15931"><span data-slate-leaf="true" data-offset-key="15931:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15932"><span data-slate-object="text" data-key="15933"><span data-slate-leaf="true" data-offset-key="15933:0" data-first-offset="true"><span data-slate-string="true">在这个示例中，我们创建了一个无缓冲的 channel 类型变量 ch1，对 ch1 的读写都放在了一个 Goroutine 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15934"><span data-slate-object="text" data-key="15935"><span data-slate-leaf="true" data-offset-key="15935:0" data-first-offset="true"><span data-slate-string="true">运行这个示例，我们就会得到 fatal error，提示我们所有 Goroutine 都处于休眠状态，程序处于死锁状态。要想解除这种错误状态，我们只需要将接收操作，或者发送操作放到另外一个 Goroutine 中就可以了，比如下面代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15936"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15937"><span data-slate-object="text" data-key="15938"><span data-slate-leaf="true" data-offset-key="15938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15939"><span data-slate-leaf="true" data-offset-key="15939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15940"><span data-slate-leaf="true" data-offset-key="15940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="15941"><span data-slate-leaf="true" data-offset-key="15941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15942"><span data-slate-leaf="true" data-offset-key="15942:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15943"><span data-slate-object="text" data-key="15944"><span data-slate-leaf="true" data-offset-key="15944:0" data-first-offset="true"><span data-slate-string="true">    ch1 := </span></span></span><span data-slate-object="text" data-key="15945"><span data-slate-leaf="true" data-offset-key="15945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="15946"><span data-slate-leaf="true" data-offset-key="15946:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15947"><span data-slate-leaf="true" data-offset-key="15947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="15948"><span data-slate-leaf="true" data-offset-key="15948:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15949"><span data-slate-leaf="true" data-offset-key="15949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15950"><span data-slate-leaf="true" data-offset-key="15950:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15951"><span data-slate-object="text" data-key="15952"><span data-slate-leaf="true" data-offset-key="15952:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15953"><span data-slate-leaf="true" data-offset-key="15953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="15954"><span data-slate-leaf="true" data-offset-key="15954:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15955"><span data-slate-leaf="true" data-offset-key="15955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15956"><span data-slate-leaf="true" data-offset-key="15956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15957"><span data-slate-leaf="true" data-offset-key="15957:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15958"><span data-slate-object="text" data-key="15959"><span data-slate-leaf="true" data-offset-key="15959:0" data-first-offset="true"><span data-slate-string="true">        ch1 &lt;- </span></span></span><span data-slate-object="text" data-key="15960"><span data-slate-leaf="true" data-offset-key="15960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">13</span></span></span></span><span data-slate-object="text" data-key="15961"><span data-slate-leaf="true" data-offset-key="15961:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15962"><span data-slate-leaf="true" data-offset-key="15962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将发送操作放入一个新 goroutine 中执行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15963"><span data-slate-object="text" data-key="15964"><span data-slate-leaf="true" data-offset-key="15964:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15965"><span data-slate-object="text" data-key="15966"><span data-slate-leaf="true" data-offset-key="15966:0" data-first-offset="true"><span data-slate-string="true">    n := &lt;-ch1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15967"><span data-slate-object="text" data-key="15968"><span data-slate-leaf="true" data-offset-key="15968:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15969"><span data-slate-leaf="true" data-offset-key="15969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="15970"><span data-slate-leaf="true" data-offset-key="15970:0" data-first-offset="true"><span data-slate-string="true">(n)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15971"><span data-slate-object="text" data-key="15972"><span data-slate-leaf="true" data-offset-key="15972:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15973"><span data-slate-object="text" data-key="15974"><span data-slate-leaf="true" data-offset-key="15974:0" data-first-offset="true"><span data-slate-string="true">由此，我们可以得出结论：</span></span></span><span data-slate-object="text" data-key="15975"><span data-slate-leaf="true" data-offset-key="15975:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">对无缓冲 channel 类型的发送与接收操作，一定要放在两个不同的 Goroutine 中进行，否则会导致 deadlock</span></span></span></span><span data-slate-object="text" data-key="15976"><span data-slate-leaf="true" data-offset-key="15976:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15977"><span data-slate-object="text" data-key="15978"><span data-slate-leaf="true" data-offset-key="15978:0" data-first-offset="true"><span data-slate-string="true">接下来，我们再来看看带缓冲 channel 的发送与接收操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15979"><span data-slate-object="text" data-key="15980"><span data-slate-leaf="true" data-offset-key="15980:0" data-first-offset="true"><span data-slate-string="true">和无缓冲 channel 相反，带缓冲 channel 的运行时层实现带有缓冲区，因此，对带缓冲 channel 的发送操作在缓冲区未满、接收操作在缓冲区非空的情况下是</span></span></span><span data-slate-object="text" data-key="15981"><span data-slate-leaf="true" data-offset-key="15981:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">异步</span></span></span></span><span data-slate-object="text" data-key="15982"><span data-slate-leaf="true" data-offset-key="15982:0" data-first-offset="true"><span data-slate-string="true">的（发送或接收不需要阻塞等待）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15983"><span data-slate-object="text" data-key="15984"><span data-slate-leaf="true" data-offset-key="15984:0" data-first-offset="true"><span data-slate-string="true">也就是说，对一个带缓冲 channel 来说，在缓冲区未满的情况下，对它进行发送操作的 Goroutine 并不会阻塞挂起；在缓冲区有数据的情况下，对它进行接收操作的 Goroutine 也不会阻塞挂起。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15985"><span data-slate-object="text" data-key="15986"><span data-slate-leaf="true" data-offset-key="15986:0" data-first-offset="true"><span data-slate-string="true">但当缓冲区满了的情况下，对它进行发送操作的 Goroutine 就会阻塞挂起；当缓冲区为空的情况下，对它进行接收操作的 Goroutine 也会阻塞挂起。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15987"><span data-slate-object="text" data-key="15988"><span data-slate-leaf="true" data-offset-key="15988:0" data-first-offset="true"><span data-slate-string="true">如果光看文字还不是很好理解，你可以再看看下面几个关于带缓冲 channel 的操作的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15989"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15990"><span data-slate-object="text" data-key="15991"><span data-slate-leaf="true" data-offset-key="15991:0" data-first-offset="true"><span data-slate-string="true">ch2 := </span></span></span><span data-slate-object="text" data-key="15992"><span data-slate-leaf="true" data-offset-key="15992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="15993"><span data-slate-leaf="true" data-offset-key="15993:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15994"><span data-slate-leaf="true" data-offset-key="15994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="15995"><span data-slate-leaf="true" data-offset-key="15995:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15996"><span data-slate-leaf="true" data-offset-key="15996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="15997"><span data-slate-leaf="true" data-offset-key="15997:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="15998"><span data-slate-leaf="true" data-offset-key="15998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15999"><span data-slate-leaf="true" data-offset-key="15999:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16000"><span data-slate-object="text" data-key="16001"><span data-slate-leaf="true" data-offset-key="16001:0" data-first-offset="true"><span data-slate-string="true">n := &lt;-ch2 </span></span></span><span data-slate-object="text" data-key="16002"><span data-slate-leaf="true" data-offset-key="16002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 由于此时 ch2 的缓冲区中无数据，因此对其进行接收操作将导致 goroutine 挂起</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16003"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16004"><span data-slate-object="text" data-key="16005"><span data-slate-leaf="true" data-offset-key="16005:0" data-first-offset="true"><span data-slate-string="true">ch3 := </span></span></span><span data-slate-object="text" data-key="16006"><span data-slate-leaf="true" data-offset-key="16006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16007"><span data-slate-leaf="true" data-offset-key="16007:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16008"><span data-slate-leaf="true" data-offset-key="16008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16009"><span data-slate-leaf="true" data-offset-key="16009:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16010"><span data-slate-leaf="true" data-offset-key="16010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16011"><span data-slate-leaf="true" data-offset-key="16011:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16012"><span data-slate-leaf="true" data-offset-key="16012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16013"><span data-slate-leaf="true" data-offset-key="16013:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16014"><span data-slate-object="text" data-key="16015"><span data-slate-leaf="true" data-offset-key="16015:0" data-first-offset="true"><span data-slate-string="true">ch3 &lt;- </span></span></span><span data-slate-object="text" data-key="16016"><span data-slate-leaf="true" data-offset-key="16016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17</span></span></span></span><span data-slate-object="text" data-key="16017"><span data-slate-leaf="true" data-offset-key="16017:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16018"><span data-slate-leaf="true" data-offset-key="16018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 ch3 发送一个整型数 17</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16019"><span data-slate-object="text" data-key="16020"><span data-slate-leaf="true" data-offset-key="16020:0" data-first-offset="true"><span data-slate-string="true">ch3 &lt;- </span></span></span><span data-slate-object="text" data-key="16021"><span data-slate-leaf="true" data-offset-key="16021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">27</span></span></span></span><span data-slate-object="text" data-key="16022"><span data-slate-leaf="true" data-offset-key="16022:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16023"><span data-slate-leaf="true" data-offset-key="16023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 由于此时 ch3 中缓冲区已满，再向 ch3 发送数据也将导致 goroutine 挂起</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16024"><span data-slate-object="text" data-key="16025"><span data-slate-leaf="true" data-offset-key="16025:0" data-first-offset="true"><span data-slate-string="true">也正是因为带缓冲 channel 与无缓冲 channel 在发送与接收行为上的差异，在具体使用上，它们有各自的 “用武之地”，这个我们等会再细说，现在我们先继续把 channel 的基本语法讲完。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16026"><span data-slate-object="text" data-key="16027"><span data-slate-leaf="true" data-offset-key="16027:0" data-first-offset="true"><span data-slate-string="true">使用操作符</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16028"><span data-slate-object="text" data-key="16029"><span data-slate-leaf="true" data-offset-key="16029:0" data-first-offset="true"><span data-slate-string="true"> &lt;-</span></span></span></span><span data-slate-object="text" data-key="16030"><span data-slate-leaf="true" data-offset-key="16030:0" data-first-offset="true"><span data-slate-string="true">，我们还可以声明</span></span></span><span data-slate-object="text" data-key="16031"><span data-slate-leaf="true" data-offset-key="16031:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">只发送 channel 类型</span></span></span></span><span data-slate-object="text" data-key="16032"><span data-slate-leaf="true" data-offset-key="16032:0" data-first-offset="true"><span data-slate-string="true">（send-only）和</span></span></span><span data-slate-object="text" data-key="16033"><span data-slate-leaf="true" data-offset-key="16033:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">只接收 channel 类型</span></span></span></span><span data-slate-object="text" data-key="16034"><span data-slate-leaf="true" data-offset-key="16034:0" data-first-offset="true"><span data-slate-string="true">（recv-only），我们接着看下面这个例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16035"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16036"><span data-slate-object="text" data-key="16037"><span data-slate-leaf="true" data-offset-key="16037:0" data-first-offset="true"><span data-slate-string="true">ch1 := </span></span></span><span data-slate-object="text" data-key="16038"><span data-slate-leaf="true" data-offset-key="16038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16039"><span data-slate-leaf="true" data-offset-key="16039:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16040"><span data-slate-leaf="true" data-offset-key="16040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16041"><span data-slate-leaf="true" data-offset-key="16041:0" data-first-offset="true"><span data-slate-string="true">&lt;- </span></span></span><span data-slate-object="text" data-key="16042"><span data-slate-leaf="true" data-offset-key="16042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16043"><span data-slate-leaf="true" data-offset-key="16043:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16044"><span data-slate-leaf="true" data-offset-key="16044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16045"><span data-slate-leaf="true" data-offset-key="16045:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="16046"><span data-slate-leaf="true" data-offset-key="16046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 只发送 channel 类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16047"><span data-slate-object="text" data-key="16048"><span data-slate-leaf="true" data-offset-key="16048:0" data-first-offset="true"><span data-slate-string="true">ch2 := </span></span></span><span data-slate-object="text" data-key="16049"><span data-slate-leaf="true" data-offset-key="16049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16050"><span data-slate-leaf="true" data-offset-key="16050:0" data-first-offset="true"><span data-slate-string="true">(&lt;-</span></span></span><span data-slate-object="text" data-key="16051"><span data-slate-leaf="true" data-offset-key="16051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16052"><span data-slate-leaf="true" data-offset-key="16052:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16053"><span data-slate-leaf="true" data-offset-key="16053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16054"><span data-slate-leaf="true" data-offset-key="16054:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16055"><span data-slate-leaf="true" data-offset-key="16055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16056"><span data-slate-leaf="true" data-offset-key="16056:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="16057"><span data-slate-leaf="true" data-offset-key="16057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 只接收 channel 类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16058"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16059"><span data-slate-object="text" data-key="16060"><span data-slate-leaf="true" data-offset-key="16060:0" data-first-offset="true"><span data-slate-string="true">&lt;-ch1       </span></span></span><span data-slate-object="text" data-key="16061"><span data-slate-leaf="true" data-offset-key="16061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// invalid operation: &lt;-ch1 (receive from send-only type chan&lt;- int)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16062"><span data-slate-object="text" data-key="16063"><span data-slate-leaf="true" data-offset-key="16063:0" data-first-offset="true"><span data-slate-string="true">ch2 &lt;- </span></span></span><span data-slate-object="text" data-key="16064"><span data-slate-leaf="true" data-offset-key="16064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">13</span></span></span></span><span data-slate-object="text" data-key="16065"><span data-slate-leaf="true" data-offset-key="16065:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="16066"><span data-slate-leaf="true" data-offset-key="16066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// invalid operation: ch2 &lt;- 13 (send to receive-only type &lt;-chan int)</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16067"><span data-slate-object="text" data-key="16068"><span data-slate-leaf="true" data-offset-key="16068:0" data-first-offset="true"><span data-slate-string="true">你可以从这个例子中看到，试图从一个只发送 channel 类型变量中接收数据，或者向一个只接收 channel 类型发送数据，都会导致编译错误。通常只发送 channel 类型和只接收 channel 类型，会被用作函数的参数类型或返回值，用于限制对 channel 内的操作，或者是明确可对 channel 进行的操作的类型，比如下面这个例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16069"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16070"><span data-slate-object="text" data-key="16071"><span data-slate-leaf="true" data-offset-key="16071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16072"><span data-slate-leaf="true" data-offset-key="16072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16073"><span data-slate-leaf="true" data-offset-key="16073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">produce</span></span></span></span></span><span data-slate-object="text" data-key="16074"><span data-slate-leaf="true" data-offset-key="16074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ch </span></span></span></span></span><span data-slate-object="text" data-key="16075"><span data-slate-leaf="true" data-offset-key="16075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="16076"><span data-slate-leaf="true" data-offset-key="16076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;- </span></span></span></span></span><span data-slate-object="text" data-key="16077"><span data-slate-leaf="true" data-offset-key="16077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16078"><span data-slate-leaf="true" data-offset-key="16078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16079"><span data-slate-leaf="true" data-offset-key="16079:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16080"><span data-slate-object="text" data-key="16081"><span data-slate-leaf="true" data-offset-key="16081:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16082"><span data-slate-leaf="true" data-offset-key="16082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16083"><span data-slate-leaf="true" data-offset-key="16083:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="16084"><span data-slate-leaf="true" data-offset-key="16084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16085"><span data-slate-leaf="true" data-offset-key="16085:0" data-first-offset="true"><span data-slate-string="true">; i &lt; </span></span></span><span data-slate-object="text" data-key="16086"><span data-slate-leaf="true" data-offset-key="16086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="16087"><span data-slate-leaf="true" data-offset-key="16087:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16088"><span data-slate-object="text" data-key="16089"><span data-slate-leaf="true" data-offset-key="16089:0" data-first-offset="true"><span data-slate-string="true">        ch &lt;- i + </span></span></span><span data-slate-object="text" data-key="16090"><span data-slate-leaf="true" data-offset-key="16090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16091"><span data-slate-object="text" data-key="16092"><span data-slate-leaf="true" data-offset-key="16092:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16093"><span data-slate-object="text" data-key="16094"><span data-slate-leaf="true" data-offset-key="16094:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16095"><span data-slate-object="text" data-key="16096"><span data-slate-leaf="true" data-offset-key="16096:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16097"><span data-slate-leaf="true" data-offset-key="16097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="16098"><span data-slate-leaf="true" data-offset-key="16098:0" data-first-offset="true"><span data-slate-string="true">(ch)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16099"><span data-slate-object="text" data-key="16100"><span data-slate-leaf="true" data-offset-key="16100:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16101"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16102"><span data-slate-object="text" data-key="16103"><span data-slate-leaf="true" data-offset-key="16103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16104"><span data-slate-leaf="true" data-offset-key="16104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16105"><span data-slate-leaf="true" data-offset-key="16105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">consume</span></span></span></span></span><span data-slate-object="text" data-key="16106"><span data-slate-leaf="true" data-offset-key="16106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ch &lt;-</span></span></span></span></span><span data-slate-object="text" data-key="16107"><span data-slate-leaf="true" data-offset-key="16107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="16108"><span data-slate-leaf="true" data-offset-key="16108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="16109"><span data-slate-leaf="true" data-offset-key="16109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16110"><span data-slate-leaf="true" data-offset-key="16110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16111"><span data-slate-leaf="true" data-offset-key="16111:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16112"><span data-slate-object="text" data-key="16113"><span data-slate-leaf="true" data-offset-key="16113:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16114"><span data-slate-leaf="true" data-offset-key="16114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16115"><span data-slate-leaf="true" data-offset-key="16115:0" data-first-offset="true"><span data-slate-string="true"> n := </span></span></span><span data-slate-object="text" data-key="16116"><span data-slate-leaf="true" data-offset-key="16116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="16117"><span data-slate-leaf="true" data-offset-key="16117:0" data-first-offset="true"><span data-slate-string="true"> ch {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16118"><span data-slate-object="text" data-key="16119"><span data-slate-leaf="true" data-offset-key="16119:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16120"><span data-slate-leaf="true" data-offset-key="16120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="16121"><span data-slate-leaf="true" data-offset-key="16121:0" data-first-offset="true"><span data-slate-string="true">(n)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16122"><span data-slate-object="text" data-key="16123"><span data-slate-leaf="true" data-offset-key="16123:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16124"><span data-slate-object="text" data-key="16125"><span data-slate-leaf="true" data-offset-key="16125:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16126"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16127"><span data-slate-object="text" data-key="16128"><span data-slate-leaf="true" data-offset-key="16128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16129"><span data-slate-leaf="true" data-offset-key="16129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16130"><span data-slate-leaf="true" data-offset-key="16130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16131"><span data-slate-leaf="true" data-offset-key="16131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16132"><span data-slate-leaf="true" data-offset-key="16132:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16133"><span data-slate-object="text" data-key="16134"><span data-slate-leaf="true" data-offset-key="16134:0" data-first-offset="true"><span data-slate-string="true">    ch := </span></span></span><span data-slate-object="text" data-key="16135"><span data-slate-leaf="true" data-offset-key="16135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16136"><span data-slate-leaf="true" data-offset-key="16136:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16137"><span data-slate-leaf="true" data-offset-key="16137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16138"><span data-slate-leaf="true" data-offset-key="16138:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16139"><span data-slate-leaf="true" data-offset-key="16139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16140"><span data-slate-leaf="true" data-offset-key="16140:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16141"><span data-slate-leaf="true" data-offset-key="16141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16142"><span data-slate-leaf="true" data-offset-key="16142:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16143"><span data-slate-object="text" data-key="16144"><span data-slate-leaf="true" data-offset-key="16144:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16145"><span data-slate-leaf="true" data-offset-key="16145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="16146"><span data-slate-leaf="true" data-offset-key="16146:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16147"><span data-slate-object="text" data-key="16148"><span data-slate-leaf="true" data-offset-key="16148:0" data-first-offset="true"><span data-slate-string="true">    wg.Add(</span></span></span><span data-slate-object="text" data-key="16149"><span data-slate-leaf="true" data-offset-key="16149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="16150"><span data-slate-leaf="true" data-offset-key="16150:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16151"><span data-slate-object="text" data-key="16152"><span data-slate-leaf="true" data-offset-key="16152:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16153"><span data-slate-leaf="true" data-offset-key="16153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16154"><span data-slate-leaf="true" data-offset-key="16154:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16155"><span data-slate-leaf="true" data-offset-key="16155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16156"><span data-slate-leaf="true" data-offset-key="16156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16157"><span data-slate-leaf="true" data-offset-key="16157:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16158"><span data-slate-object="text" data-key="16159"><span data-slate-leaf="true" data-offset-key="16159:0" data-first-offset="true"><span data-slate-string="true">        produce(ch)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16160"><span data-slate-object="text" data-key="16161"><span data-slate-leaf="true" data-offset-key="16161:0" data-first-offset="true"><span data-slate-string="true">        wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16162"><span data-slate-object="text" data-key="16163"><span data-slate-leaf="true" data-offset-key="16163:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16164"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16165"><span data-slate-object="text" data-key="16166"><span data-slate-leaf="true" data-offset-key="16166:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16167"><span data-slate-leaf="true" data-offset-key="16167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16168"><span data-slate-leaf="true" data-offset-key="16168:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16169"><span data-slate-leaf="true" data-offset-key="16169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16170"><span data-slate-leaf="true" data-offset-key="16170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16171"><span data-slate-leaf="true" data-offset-key="16171:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16172"><span data-slate-object="text" data-key="16173"><span data-slate-leaf="true" data-offset-key="16173:0" data-first-offset="true"><span data-slate-string="true">        consume(ch)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16174"><span data-slate-object="text" data-key="16175"><span data-slate-leaf="true" data-offset-key="16175:0" data-first-offset="true"><span data-slate-string="true">        wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16176"><span data-slate-object="text" data-key="16177"><span data-slate-leaf="true" data-offset-key="16177:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16178"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16179"><span data-slate-object="text" data-key="16180"><span data-slate-leaf="true" data-offset-key="16180:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16181"><span data-slate-object="text" data-key="16182"><span data-slate-leaf="true" data-offset-key="16182:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16183"><span data-slate-object="text" data-key="16184"><span data-slate-leaf="true" data-offset-key="16184:0" data-first-offset="true"><span data-slate-string="true">在这个例子中，我们启动了两个 Goroutine，分别代表生产者（produce）与消费者（consume）。生产者只能向 channel 中发送数据，我们使用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16185"><span data-slate-object="text" data-key="16186"><span data-slate-leaf="true" data-offset-key="16186:0" data-first-offset="true"><span data-slate-string="true"> chan&lt;- int</span></span></span></span><span data-slate-object="text" data-key="16187"><span data-slate-leaf="true" data-offset-key="16187:0" data-first-offset="true"><span data-slate-string="true"> 作为 produce 函数的参数类型；消费者只能从 channel 中接收数据，我们使用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16188"><span data-slate-object="text" data-key="16189"><span data-slate-leaf="true" data-offset-key="16189:0" data-first-offset="true"><span data-slate-string="true"> &lt;-chan int</span></span></span></span><span data-slate-object="text" data-key="16190"><span data-slate-leaf="true" data-offset-key="16190:0" data-first-offset="true"><span data-slate-string="true"> 作为 consume 函数的参数类型。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16191"><span data-slate-object="text" data-key="16192"><span data-slate-leaf="true" data-offset-key="16192:0" data-first-offset="true"><span data-slate-string="true">在消费者函数 consume 中，我们使用了 for range 循环语句来从 channel 中接收数据，for range 会阻塞在对 channel 的接收操作上，直到 channel 中有数据可接收或 channel 被关闭循环，才会继续向下执行。channel 被关闭后，for range 循环也就结束了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16193" id="sr-toc-4"><span data-slate-object="text" data-key="16194"><span data-slate-leaf="true" data-offset-key="16194:0" data-first-offset="true"><span data-slate-string="true">关闭 channel</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16195"><span data-slate-object="text" data-key="16196"><span data-slate-leaf="true" data-offset-key="16196:0" data-first-offset="true"><span data-slate-string="true">在上面的例子中，produce 函数在发送完数据后，调用 Go 内置的 close 函数关闭了 channel。channel 关闭后，所有等待从这个 channel 接收数据的操作都将返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16197"><span data-slate-object="text" data-key="16198"><span data-slate-leaf="true" data-offset-key="16198:0" data-first-offset="true"><span data-slate-string="true">这里我们继续看一下采用不同接收语法形式的语句，在 channel 被关闭后的返回值的情况：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16199"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16200"><span data-slate-object="text" data-key="16201"><span data-slate-leaf="true" data-offset-key="16201:0" data-first-offset="true"><span data-slate-string="true">n := &lt;- ch      </span></span></span><span data-slate-object="text" data-key="16202"><span data-slate-leaf="true" data-offset-key="16202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当 ch 被关闭后，n 将被赋值为 ch 元素类型的零值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16203"><span data-slate-object="text" data-key="16204"><span data-slate-leaf="true" data-offset-key="16204:0" data-first-offset="true"><span data-slate-string="true">m, ok := &lt;-ch   </span></span></span><span data-slate-object="text" data-key="16205"><span data-slate-leaf="true" data-offset-key="16205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当 ch 被关闭后，m 将被赋值为 ch 元素类型的零值，ok 值为 false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16206"><span data-slate-object="text" data-key="16207"><span data-slate-leaf="true" data-offset-key="16207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16208"><span data-slate-leaf="true" data-offset-key="16208:0" data-first-offset="true"><span data-slate-string="true"> v := </span></span></span><span data-slate-object="text" data-key="16209"><span data-slate-leaf="true" data-offset-key="16209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="16210"><span data-slate-leaf="true" data-offset-key="16210:0" data-first-offset="true"><span data-slate-string="true"> ch { </span></span></span><span data-slate-object="text" data-key="16211"><span data-slate-leaf="true" data-offset-key="16211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当 ch 被关闭后，for range 循环结束</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16212"><span data-slate-object="text" data-key="16213"><span data-slate-leaf="true" data-offset-key="16213:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16214"><span data-slate-object="text" data-key="16215"><span data-slate-leaf="true" data-offset-key="16215:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16216"><span data-slate-object="text" data-key="16217"><span data-slate-leaf="true" data-offset-key="16217:0" data-first-offset="true"><span data-slate-string="true">我们看到，通过 “comma, ok” 惯用法或 for range 语句，我们可以准确地判定 channel 是否被关闭。而单纯采用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16218"><span data-slate-object="text" data-key="16219"><span data-slate-leaf="true" data-offset-key="16219:0" data-first-offset="true"><span data-slate-string="true"> n := &lt;-ch</span></span></span></span><span data-slate-object="text" data-key="16220"><span data-slate-leaf="true" data-offset-key="16220:0" data-first-offset="true"><span data-slate-string="true"> 形式的语句，我们就无法判定从 ch 返回的元素类型零值，究竟是不是因为 channel 被关闭后才返回的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16221"><span data-slate-object="text" data-key="16222"><span data-slate-leaf="true" data-offset-key="16222:0" data-first-offset="true"><span data-slate-string="true">另外，从前面 produce 的示例程序中，我们也可以看到，channel 是在 produce 函数中被关闭的，这也是 channel 的一个使用惯例，那就是</span></span></span><span data-slate-object="text" data-key="16223"><span data-slate-leaf="true" data-offset-key="16223:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">发送端负责关闭 channel</span></span></span></span><span data-slate-object="text" data-key="16224"><span data-slate-leaf="true" data-offset-key="16224:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16225"><span data-slate-object="text" data-key="16226"><span data-slate-leaf="true" data-offset-key="16226:0" data-first-offset="true"><span data-slate-string="true">这里为什么要在发送端关闭 channel 呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16227"><span data-slate-object="text" data-key="16228"><span data-slate-leaf="true" data-offset-key="16228:0" data-first-offset="true"><span data-slate-string="true">这是因为发送端没有像接受端那样的、可以安全判断 channel 是否被关闭了的方法。同时，一旦向一个已经关闭的 channel 执行发送操作，这个操作就会引发 panic，比如下面这个示例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16229"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16230"><span data-slate-object="text" data-key="16231"><span data-slate-leaf="true" data-offset-key="16231:0" data-first-offset="true"><span data-slate-string="true">ch := </span></span></span><span data-slate-object="text" data-key="16232"><span data-slate-leaf="true" data-offset-key="16232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16233"><span data-slate-leaf="true" data-offset-key="16233:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16234"><span data-slate-leaf="true" data-offset-key="16234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16235"><span data-slate-leaf="true" data-offset-key="16235:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16236"><span data-slate-leaf="true" data-offset-key="16236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16237"><span data-slate-leaf="true" data-offset-key="16237:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16238"><span data-slate-leaf="true" data-offset-key="16238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16239"><span data-slate-leaf="true" data-offset-key="16239:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16240"><span data-slate-object="text" data-key="16241"><span data-slate-leaf="true" data-offset-key="16241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="16242"><span data-slate-leaf="true" data-offset-key="16242:0" data-first-offset="true"><span data-slate-string="true">(ch)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16243"><span data-slate-object="text" data-key="16244"><span data-slate-leaf="true" data-offset-key="16244:0" data-first-offset="true"><span data-slate-string="true">ch &lt;- </span></span></span><span data-slate-object="text" data-key="16245"><span data-slate-leaf="true" data-offset-key="16245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">13</span></span></span></span><span data-slate-object="text" data-key="16246"><span data-slate-leaf="true" data-offset-key="16246:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16247"><span data-slate-leaf="true" data-offset-key="16247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// panic: send on closed channel</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16248" id="sr-toc-5"><span data-slate-object="text" data-key="16249"><span data-slate-leaf="true" data-offset-key="16249:0" data-first-offset="true"><span data-slate-string="true">select</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16250"><span data-slate-object="text" data-key="16251"><span data-slate-leaf="true" data-offset-key="16251:0" data-first-offset="true"><span data-slate-string="true">当涉及同时对多个 channel 进行操作时，我们会结合 Go 为 CSP 并发模型提供的另外一个原语 </span></span></span><span data-slate-object="text" data-key="16252"><span data-slate-leaf="true" data-offset-key="16252:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="16253"><span data-slate-leaf="true" data-offset-key="16253:0" data-first-offset="true"><span data-slate-string="true">，一起使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16254"><span data-slate-object="text" data-key="16255"><span data-slate-leaf="true" data-offset-key="16255:0" data-first-offset="true"><span data-slate-string="true">通过 select，我们可以同时在多个 channel 上进行发送 / 接收操作：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16256"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16257"><span data-slate-object="text" data-key="16258"><span data-slate-leaf="true" data-offset-key="16258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="16259"><span data-slate-leaf="true" data-offset-key="16259:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16260"><span data-slate-object="text" data-key="16261"><span data-slate-leaf="true" data-offset-key="16261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16262"><span data-slate-leaf="true" data-offset-key="16262:0" data-first-offset="true"><span data-slate-string="true"> x := &lt;-ch1:     </span></span></span><span data-slate-object="text" data-key="16263"><span data-slate-leaf="true" data-offset-key="16263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 channel ch1 接收数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16264"><span data-slate-object="text" data-key="16265"><span data-slate-leaf="true" data-offset-key="16265:0" data-first-offset="true"><span data-slate-string="true">  ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16266"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16267"><span data-slate-object="text" data-key="16268"><span data-slate-leaf="true" data-offset-key="16268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16269"><span data-slate-leaf="true" data-offset-key="16269:0" data-first-offset="true"><span data-slate-string="true"> y, ok := &lt;-ch2: </span></span></span><span data-slate-object="text" data-key="16270"><span data-slate-leaf="true" data-offset-key="16270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 channel ch2 接收数据，并根据 ok 值判断 ch2 是否已经关闭</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16271"><span data-slate-object="text" data-key="16272"><span data-slate-leaf="true" data-offset-key="16272:0" data-first-offset="true"><span data-slate-string="true">  ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16273"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16274"><span data-slate-object="text" data-key="16275"><span data-slate-leaf="true" data-offset-key="16275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16276"><span data-slate-leaf="true" data-offset-key="16276:0" data-first-offset="true"><span data-slate-string="true"> ch3 &lt;- z:       </span></span></span><span data-slate-object="text" data-key="16277"><span data-slate-leaf="true" data-offset-key="16277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 z 值发送到 channel ch3 中:</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16278"><span data-slate-object="text" data-key="16279"><span data-slate-leaf="true" data-offset-key="16279:0" data-first-offset="true"><span data-slate-string="true">  ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16280"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16281"><span data-slate-object="text" data-key="16282"><span data-slate-leaf="true" data-offset-key="16282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="16283"><span data-slate-leaf="true" data-offset-key="16283:0" data-first-offset="true"><span data-slate-string="true">:             </span></span></span><span data-slate-object="text" data-key="16284"><span data-slate-leaf="true" data-offset-key="16284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当上面 case 中的 channel 通信均无法实施时，执行该默认分支</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16285"><span data-slate-object="text" data-key="16286"><span data-slate-leaf="true" data-offset-key="16286:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16287"><span data-slate-object="text" data-key="16288"><span data-slate-leaf="true" data-offset-key="16288:0" data-first-offset="true"><span data-slate-string="true">当 select 语句中没有 default 分支，而且所有 case 中的 channel 操作都阻塞了的时候，整个 select 语句都将被阻塞，直到某一个 case 上的 channel 变成可发送，或者某个 case 上的 channel 变成可接收，select 语句才可以继续进行下去。关于 select 语句的妙用，我们在后面还会细讲，这里我们先简单了解它的基本语法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16289"><span data-slate-object="text" data-key="16290"><span data-slate-leaf="true" data-offset-key="16290:0" data-first-offset="true"><span data-slate-string="true">看到这里你应该能感受到，channel 和 select 两种原语的操作都十分简单，它们都遵循了 Go 语言</span></span></span><span data-slate-object="text" data-key="16291"><span data-slate-leaf="true" data-offset-key="16291:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “追求简单”</span></span></span></span><span data-slate-object="text" data-key="16292"><span data-slate-leaf="true" data-offset-key="16292:0" data-first-offset="true"><span data-slate-string="true"> 的设计哲学，但它们却为 Go 并发程序带来了强大的表达能力。学习了这些基础用法后，接下来我们再深一层，看看 Go 并发原语 channel 的一些惯用法。同样地，这里我们也分成无缓冲 channel 和带缓冲 channel 两种情况来分析。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16293" id="sr-toc-6"><span data-slate-object="text" data-key="16294"><span data-slate-leaf="true" data-offset-key="16294:0" data-first-offset="true"><span data-slate-string="true">无缓冲 channel 的惯用法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16295"><span data-slate-object="text" data-key="16296"><span data-slate-leaf="true" data-offset-key="16296:0" data-first-offset="true"><span data-slate-string="true">无缓冲 channel 兼具通信和同步特性，在并发程序中应用颇为广泛。现在我们来看看几个无缓冲 channel 的典型应用：</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16297" id="sr-toc-7"><span data-slate-object="text" data-key="16298"><span data-slate-leaf="true" data-offset-key="16298:0" data-first-offset="true"><span data-slate-string="true">第一种用法：用作信号传递</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16299"><span data-slate-object="text" data-key="16300"><span data-slate-leaf="true" data-offset-key="16300:0" data-first-offset="true"><span data-slate-string="true">无缓冲 channel 用作信号传递的时候，有两种情况，分别是 1 对 1 通知信号和 1 对 n 通知信号。我们先来分析下 1 对 1 通知信号这种情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16301"><span data-slate-object="text" data-key="16302"><span data-slate-leaf="true" data-offset-key="16302:0" data-first-offset="true"><span data-slate-string="true">我们直接来看具体的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16303"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16304"><span data-slate-object="text" data-key="16305"><span data-slate-leaf="true" data-offset-key="16305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16306"><span data-slate-leaf="true" data-offset-key="16306:0" data-first-offset="true"><span data-slate-string="true"> signal </span></span></span><span data-slate-object="text" data-key="16307"><span data-slate-leaf="true" data-offset-key="16307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16308"><span data-slate-leaf="true" data-offset-key="16308:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16309"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16310"><span data-slate-object="text" data-key="16311"><span data-slate-leaf="true" data-offset-key="16311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16312"><span data-slate-leaf="true" data-offset-key="16312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16313"><span data-slate-leaf="true" data-offset-key="16313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="16314"><span data-slate-leaf="true" data-offset-key="16314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16315"><span data-slate-leaf="true" data-offset-key="16315:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16316"><span data-slate-object="text" data-key="16317"><span data-slate-leaf="true" data-offset-key="16317:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16318"><span data-slate-leaf="true" data-offset-key="16318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="16319"><span data-slate-leaf="true" data-offset-key="16319:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16320"><span data-slate-leaf="true" data-offset-key="16320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker is working..."</span></span></span></span><span data-slate-object="text" data-key="16321"><span data-slate-leaf="true" data-offset-key="16321:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16322"><span data-slate-object="text" data-key="16323"><span data-slate-leaf="true" data-offset-key="16323:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="16324"><span data-slate-leaf="true" data-offset-key="16324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16325"><span data-slate-leaf="true" data-offset-key="16325:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16326"><span data-slate-object="text" data-key="16327"><span data-slate-leaf="true" data-offset-key="16327:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16328"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16329"><span data-slate-object="text" data-key="16330"><span data-slate-leaf="true" data-offset-key="16330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16331"><span data-slate-leaf="true" data-offset-key="16331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16332"><span data-slate-leaf="true" data-offset-key="16332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spawn</span></span></span></span></span><span data-slate-object="text" data-key="16333"><span data-slate-leaf="true" data-offset-key="16333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(f </span></span></span></span></span><span data-slate-object="text" data-key="16334"><span data-slate-leaf="true" data-offset-key="16334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span></span><span data-slate-object="text" data-key="16335"><span data-slate-leaf="true" data-offset-key="16335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16336"><span data-slate-leaf="true" data-offset-key="16336:0" data-first-offset="true"><span data-slate-string="true">) &lt;-</span></span></span><span data-slate-object="text" data-key="16337"><span data-slate-leaf="true" data-offset-key="16337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16338"><span data-slate-leaf="true" data-offset-key="16338:0" data-first-offset="true"><span data-slate-string="true"> signal {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16339"><span data-slate-object="text" data-key="16340"><span data-slate-leaf="true" data-offset-key="16340:0" data-first-offset="true"><span data-slate-string="true">    c := </span></span></span><span data-slate-object="text" data-key="16341"><span data-slate-leaf="true" data-offset-key="16341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16342"><span data-slate-leaf="true" data-offset-key="16342:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16343"><span data-slate-leaf="true" data-offset-key="16343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16344"><span data-slate-leaf="true" data-offset-key="16344:0" data-first-offset="true"><span data-slate-string="true"> signal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16345"><span data-slate-object="text" data-key="16346"><span data-slate-leaf="true" data-offset-key="16346:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16347"><span data-slate-leaf="true" data-offset-key="16347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16348"><span data-slate-leaf="true" data-offset-key="16348:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16349"><span data-slate-leaf="true" data-offset-key="16349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16350"><span data-slate-leaf="true" data-offset-key="16350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16351"><span data-slate-leaf="true" data-offset-key="16351:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16352"><span data-slate-object="text" data-key="16353"><span data-slate-leaf="true" data-offset-key="16353:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16354"><span data-slate-leaf="true" data-offset-key="16354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="16355"><span data-slate-leaf="true" data-offset-key="16355:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16356"><span data-slate-leaf="true" data-offset-key="16356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker start to work..."</span></span></span></span><span data-slate-object="text" data-key="16357"><span data-slate-leaf="true" data-offset-key="16357:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16358"><span data-slate-object="text" data-key="16359"><span data-slate-leaf="true" data-offset-key="16359:0" data-first-offset="true"><span data-slate-string="true">        f()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16360"><span data-slate-object="text" data-key="16361"><span data-slate-leaf="true" data-offset-key="16361:0" data-first-offset="true"><span data-slate-string="true">        c &lt;- signal{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16362"><span data-slate-object="text" data-key="16363"><span data-slate-leaf="true" data-offset-key="16363:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16364"><span data-slate-object="text" data-key="16365"><span data-slate-leaf="true" data-offset-key="16365:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16366"><span data-slate-leaf="true" data-offset-key="16366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16367"><span data-slate-leaf="true" data-offset-key="16367:0" data-first-offset="true"><span data-slate-string="true"> c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16368"><span data-slate-object="text" data-key="16369"><span data-slate-leaf="true" data-offset-key="16369:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16370"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16371"><span data-slate-object="text" data-key="16372"><span data-slate-leaf="true" data-offset-key="16372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16373"><span data-slate-leaf="true" data-offset-key="16373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16374"><span data-slate-leaf="true" data-offset-key="16374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16375"><span data-slate-leaf="true" data-offset-key="16375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16376"><span data-slate-leaf="true" data-offset-key="16376:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16377"><span data-slate-object="text" data-key="16378"><span data-slate-leaf="true" data-offset-key="16378:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16379"><span data-slate-leaf="true" data-offset-key="16379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="16380"><span data-slate-leaf="true" data-offset-key="16380:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16381"><span data-slate-leaf="true" data-offset-key="16381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start a worker..."</span></span></span></span><span data-slate-object="text" data-key="16382"><span data-slate-leaf="true" data-offset-key="16382:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16383"><span data-slate-object="text" data-key="16384"><span data-slate-leaf="true" data-offset-key="16384:0" data-first-offset="true"><span data-slate-string="true">    c := spawn(worker)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16385"><span data-slate-object="text" data-key="16386"><span data-slate-leaf="true" data-offset-key="16386:0" data-first-offset="true"><span data-slate-string="true">    &lt;-c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16387"><span data-slate-object="text" data-key="16388"><span data-slate-leaf="true" data-offset-key="16388:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="16389"><span data-slate-leaf="true" data-offset-key="16389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker work done!"</span></span></span></span><span data-slate-object="text" data-key="16390"><span data-slate-leaf="true" data-offset-key="16390:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16391"><span data-slate-object="text" data-key="16392"><span data-slate-leaf="true" data-offset-key="16392:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16393"><span data-slate-object="text" data-key="16394"><span data-slate-leaf="true" data-offset-key="16394:0" data-first-offset="true"><span data-slate-string="true">在这个例子中，spawn 函数返回的 channel，被用于承载新 Goroutine 退出的</span></span></span><span data-slate-object="text" data-key="16395"><span data-slate-leaf="true" data-offset-key="16395:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “通知信号”</span></span></span></span><span data-slate-object="text" data-key="16396"><span data-slate-leaf="true" data-offset-key="16396:0" data-first-offset="true"><span data-slate-string="true">，这个信号专门用作通知 main goroutine。main goroutine 在调用 spawn 函数后一直阻塞在对这个 “通知信号” 的接收动作上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16397"><span data-slate-object="text" data-key="16398"><span data-slate-leaf="true" data-offset-key="16398:0" data-first-offset="true"><span data-slate-string="true">我们来运行一下这个例子：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="16399"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16400"><span data-slate-object="text" data-key="16401"><span data-slate-leaf="true" data-offset-key="16401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16402"><span data-slate-leaf="true" data-offset-key="16402:0" data-first-offset="true"><span data-slate-string="true"> a worker...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16403"><span data-slate-object="text" data-key="16404"><span data-slate-leaf="true" data-offset-key="16404:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16405"><span data-slate-leaf="true" data-offset-key="16405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16406"><span data-slate-leaf="true" data-offset-key="16406:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16407"><span data-slate-leaf="true" data-offset-key="16407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16408"><span data-slate-leaf="true" data-offset-key="16408:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16409"><span data-slate-object="text" data-key="16410"><span data-slate-leaf="true" data-offset-key="16410:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16411"><span data-slate-leaf="true" data-offset-key="16411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16412"><span data-slate-leaf="true" data-offset-key="16412:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16413"><span data-slate-object="text" data-key="16414"><span data-slate-leaf="true" data-offset-key="16414:0" data-first-offset="true"><span data-slate-string="true">worker work done</span></span></span><span data-slate-object="text" data-key="16415"><span data-slate-leaf="true" data-offset-key="16415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">!</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16416"><span data-slate-object="text" data-key="16417"><span data-slate-leaf="true" data-offset-key="16417:0" data-first-offset="true"><span data-slate-string="true">有些时候，无缓冲 channel 还被用来实现 </span></span></span><span data-slate-object="text" data-key="16418"><span data-slate-leaf="true" data-offset-key="16418:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">1 对 n 的信号通知</span></span></span></span><span data-slate-object="text" data-key="16419"><span data-slate-leaf="true" data-offset-key="16419:0" data-first-offset="true"><span data-slate-string="true">机制。这样的信号通知机制，常被用于协调多个 Goroutine 一起工作，比如下面的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16420"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16421"><span data-slate-object="text" data-key="16422"><span data-slate-leaf="true" data-offset-key="16422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16423"><span data-slate-leaf="true" data-offset-key="16423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16424"><span data-slate-leaf="true" data-offset-key="16424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="16425"><span data-slate-leaf="true" data-offset-key="16425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="16426"><span data-slate-leaf="true" data-offset-key="16426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16427"><span data-slate-leaf="true" data-offset-key="16427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16428"><span data-slate-leaf="true" data-offset-key="16428:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16429"><span data-slate-object="text" data-key="16430"><span data-slate-leaf="true" data-offset-key="16430:0" data-first-offset="true"><span data-slate-string="true">    fmt.Printf(</span></span></span><span data-slate-object="text" data-key="16431"><span data-slate-leaf="true" data-offset-key="16431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: is working...\n"</span></span></span></span><span data-slate-object="text" data-key="16432"><span data-slate-leaf="true" data-offset-key="16432:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16433"><span data-slate-object="text" data-key="16434"><span data-slate-leaf="true" data-offset-key="16434:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="16435"><span data-slate-leaf="true" data-offset-key="16435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16436"><span data-slate-leaf="true" data-offset-key="16436:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16437"><span data-slate-object="text" data-key="16438"><span data-slate-leaf="true" data-offset-key="16438:0" data-first-offset="true"><span data-slate-string="true">    fmt.Printf(</span></span></span><span data-slate-object="text" data-key="16439"><span data-slate-leaf="true" data-offset-key="16439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: works done\n"</span></span></span></span><span data-slate-object="text" data-key="16440"><span data-slate-leaf="true" data-offset-key="16440:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16441"><span data-slate-object="text" data-key="16442"><span data-slate-leaf="true" data-offset-key="16442:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16443"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16444"><span data-slate-object="text" data-key="16445"><span data-slate-leaf="true" data-offset-key="16445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16446"><span data-slate-leaf="true" data-offset-key="16446:0" data-first-offset="true"><span data-slate-string="true"> signal </span></span></span><span data-slate-object="text" data-key="16447"><span data-slate-leaf="true" data-offset-key="16447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16448"><span data-slate-leaf="true" data-offset-key="16448:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16449"><span data-slate-object="text" data-key="16450"><span data-slate-leaf="true" data-offset-key="16450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16451"><span data-slate-leaf="true" data-offset-key="16451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16452"><span data-slate-leaf="true" data-offset-key="16452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spawnGroup</span></span></span></span></span><span data-slate-object="text" data-key="16453"><span data-slate-leaf="true" data-offset-key="16453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(f </span></span></span></span></span><span data-slate-object="text" data-key="16454"><span data-slate-leaf="true" data-offset-key="16454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span></span><span data-slate-object="text" data-key="16455"><span data-slate-leaf="true" data-offset-key="16455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="16456"><span data-slate-leaf="true" data-offset-key="16456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16457"><span data-slate-leaf="true" data-offset-key="16457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16458"><span data-slate-leaf="true" data-offset-key="16458:0" data-first-offset="true"><span data-slate-string="true">, num </span></span></span><span data-slate-object="text" data-key="16459"><span data-slate-leaf="true" data-offset-key="16459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16460"><span data-slate-leaf="true" data-offset-key="16460:0" data-first-offset="true"><span data-slate-string="true">, groupSignal &lt;-</span></span></span><span data-slate-object="text" data-key="16461"><span data-slate-leaf="true" data-offset-key="16461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16462"><span data-slate-leaf="true" data-offset-key="16462:0" data-first-offset="true"><span data-slate-string="true"> signal) &lt;-</span></span></span><span data-slate-object="text" data-key="16463"><span data-slate-leaf="true" data-offset-key="16463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16464"><span data-slate-leaf="true" data-offset-key="16464:0" data-first-offset="true"><span data-slate-string="true"> signal {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16465"><span data-slate-object="text" data-key="16466"><span data-slate-leaf="true" data-offset-key="16466:0" data-first-offset="true"><span data-slate-string="true">    c := </span></span></span><span data-slate-object="text" data-key="16467"><span data-slate-leaf="true" data-offset-key="16467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16468"><span data-slate-leaf="true" data-offset-key="16468:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16469"><span data-slate-leaf="true" data-offset-key="16469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16470"><span data-slate-leaf="true" data-offset-key="16470:0" data-first-offset="true"><span data-slate-string="true"> signal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16471"><span data-slate-object="text" data-key="16472"><span data-slate-leaf="true" data-offset-key="16472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16473"><span data-slate-leaf="true" data-offset-key="16473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="16474"><span data-slate-leaf="true" data-offset-key="16474:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16475"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16476"><span data-slate-object="text" data-key="16477"><span data-slate-leaf="true" data-offset-key="16477:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16478"><span data-slate-leaf="true" data-offset-key="16478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16479"><span data-slate-leaf="true" data-offset-key="16479:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="16480"><span data-slate-leaf="true" data-offset-key="16480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16481"><span data-slate-leaf="true" data-offset-key="16481:0" data-first-offset="true"><span data-slate-string="true">; i &lt; num; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16482"><span data-slate-object="text" data-key="16483"><span data-slate-leaf="true" data-offset-key="16483:0" data-first-offset="true"><span data-slate-string="true">        wg.Add(</span></span></span><span data-slate-object="text" data-key="16484"><span data-slate-leaf="true" data-offset-key="16484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16485"><span data-slate-leaf="true" data-offset-key="16485:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16486"><span data-slate-object="text" data-key="16487"><span data-slate-leaf="true" data-offset-key="16487:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16488"><span data-slate-leaf="true" data-offset-key="16488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16489"><span data-slate-leaf="true" data-offset-key="16489:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16490"><span data-slate-leaf="true" data-offset-key="16490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16491"><span data-slate-leaf="true" data-offset-key="16491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="16492"><span data-slate-leaf="true" data-offset-key="16492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16493"><span data-slate-leaf="true" data-offset-key="16493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16494"><span data-slate-leaf="true" data-offset-key="16494:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16495"><span data-slate-object="text" data-key="16496"><span data-slate-leaf="true" data-offset-key="16496:0" data-first-offset="true"><span data-slate-string="true">            &lt;-groupSignal</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16497"><span data-slate-object="text" data-key="16498"><span data-slate-leaf="true" data-offset-key="16498:0" data-first-offset="true"><span data-slate-string="true">            fmt.Printf(</span></span></span><span data-slate-object="text" data-key="16499"><span data-slate-leaf="true" data-offset-key="16499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: start to work...\n"</span></span></span></span><span data-slate-object="text" data-key="16500"><span data-slate-leaf="true" data-offset-key="16500:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16501"><span data-slate-object="text" data-key="16502"><span data-slate-leaf="true" data-offset-key="16502:0" data-first-offset="true"><span data-slate-string="true">            f(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16503"><span data-slate-object="text" data-key="16504"><span data-slate-leaf="true" data-offset-key="16504:0" data-first-offset="true"><span data-slate-string="true">            wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16505"><span data-slate-object="text" data-key="16506"><span data-slate-leaf="true" data-offset-key="16506:0" data-first-offset="true"><span data-slate-string="true">        }(i + </span></span></span><span data-slate-object="text" data-key="16507"><span data-slate-leaf="true" data-offset-key="16507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16508"><span data-slate-leaf="true" data-offset-key="16508:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16509"><span data-slate-object="text" data-key="16510"><span data-slate-leaf="true" data-offset-key="16510:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16511"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16512"><span data-slate-object="text" data-key="16513"><span data-slate-leaf="true" data-offset-key="16513:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16514"><span data-slate-leaf="true" data-offset-key="16514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16515"><span data-slate-leaf="true" data-offset-key="16515:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16516"><span data-slate-leaf="true" data-offset-key="16516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16517"><span data-slate-leaf="true" data-offset-key="16517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16518"><span data-slate-leaf="true" data-offset-key="16518:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16519"><span data-slate-object="text" data-key="16520"><span data-slate-leaf="true" data-offset-key="16520:0" data-first-offset="true"><span data-slate-string="true">        wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16521"><span data-slate-object="text" data-key="16522"><span data-slate-leaf="true" data-offset-key="16522:0" data-first-offset="true"><span data-slate-string="true">        c &lt;- signal{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16523"><span data-slate-object="text" data-key="16524"><span data-slate-leaf="true" data-offset-key="16524:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16525"><span data-slate-object="text" data-key="16526"><span data-slate-leaf="true" data-offset-key="16526:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16527"><span data-slate-leaf="true" data-offset-key="16527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16528"><span data-slate-leaf="true" data-offset-key="16528:0" data-first-offset="true"><span data-slate-string="true"> c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16529"><span data-slate-object="text" data-key="16530"><span data-slate-leaf="true" data-offset-key="16530:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16531"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16532"><span data-slate-object="text" data-key="16533"><span data-slate-leaf="true" data-offset-key="16533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16534"><span data-slate-leaf="true" data-offset-key="16534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16535"><span data-slate-leaf="true" data-offset-key="16535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16536"><span data-slate-leaf="true" data-offset-key="16536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16537"><span data-slate-leaf="true" data-offset-key="16537:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16538"><span data-slate-object="text" data-key="16539"><span data-slate-leaf="true" data-offset-key="16539:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="16540"><span data-slate-leaf="true" data-offset-key="16540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start a group of workers..."</span></span></span></span><span data-slate-object="text" data-key="16541"><span data-slate-leaf="true" data-offset-key="16541:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16542"><span data-slate-object="text" data-key="16543"><span data-slate-leaf="true" data-offset-key="16543:0" data-first-offset="true"><span data-slate-string="true">    groupSignal := </span></span></span><span data-slate-object="text" data-key="16544"><span data-slate-leaf="true" data-offset-key="16544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16545"><span data-slate-leaf="true" data-offset-key="16545:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16546"><span data-slate-leaf="true" data-offset-key="16546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16547"><span data-slate-leaf="true" data-offset-key="16547:0" data-first-offset="true"><span data-slate-string="true"> signal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16548"><span data-slate-object="text" data-key="16549"><span data-slate-leaf="true" data-offset-key="16549:0" data-first-offset="true"><span data-slate-string="true">    c := spawnGroup(worker, </span></span></span><span data-slate-object="text" data-key="16550"><span data-slate-leaf="true" data-offset-key="16550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16551"><span data-slate-leaf="true" data-offset-key="16551:0" data-first-offset="true"><span data-slate-string="true">, groupSignal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16552"><span data-slate-object="text" data-key="16553"><span data-slate-leaf="true" data-offset-key="16553:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="16554"><span data-slate-leaf="true" data-offset-key="16554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16555"><span data-slate-leaf="true" data-offset-key="16555:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16556"><span data-slate-object="text" data-key="16557"><span data-slate-leaf="true" data-offset-key="16557:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="16558"><span data-slate-leaf="true" data-offset-key="16558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"the group of workers start to work..."</span></span></span></span><span data-slate-object="text" data-key="16559"><span data-slate-leaf="true" data-offset-key="16559:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16560"><span data-slate-object="text" data-key="16561"><span data-slate-leaf="true" data-offset-key="16561:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16562"><span data-slate-leaf="true" data-offset-key="16562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="16563"><span data-slate-leaf="true" data-offset-key="16563:0" data-first-offset="true"><span data-slate-string="true">(groupSignal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16564"><span data-slate-object="text" data-key="16565"><span data-slate-leaf="true" data-offset-key="16565:0" data-first-offset="true"><span data-slate-string="true">    &lt;-c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16566"><span data-slate-object="text" data-key="16567"><span data-slate-leaf="true" data-offset-key="16567:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="16568"><span data-slate-leaf="true" data-offset-key="16568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"the group of workers work done!"</span></span></span></span><span data-slate-object="text" data-key="16569"><span data-slate-leaf="true" data-offset-key="16569:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16570"><span data-slate-object="text" data-key="16571"><span data-slate-leaf="true" data-offset-key="16571:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16572"><span data-slate-object="text" data-key="16573"><span data-slate-leaf="true" data-offset-key="16573:0" data-first-offset="true"><span data-slate-string="true">这个例子中，main goroutine 创建了一组 5 个 worker goroutine，这些 Goroutine 启动后会阻塞在名为 groupSignal 的无缓冲 channel 上。main goroutine 通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16574"><span data-slate-object="text" data-key="16575"><span data-slate-leaf="true" data-offset-key="16575:0" data-first-offset="true"><span data-slate-string="true"> close(groupSignal)</span></span></span></span><span data-slate-object="text" data-key="16576"><span data-slate-leaf="true" data-offset-key="16576:0" data-first-offset="true"><span data-slate-string="true"> 向所有 worker goroutine 广播 “开始工作” 的信号，收到 groupSignal 后，所有 worker goroutine 会</span></span></span><span data-slate-object="text" data-key="16577"><span data-slate-leaf="true" data-offset-key="16577:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “同时”</span></span></span></span><span data-slate-object="text" data-key="16578"><span data-slate-leaf="true" data-offset-key="16578:0" data-first-offset="true"><span data-slate-string="true"> 开始工作，就像起跑线上的运动员听到了裁判员发出的起跑信号枪声。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16579"><span data-slate-object="text" data-key="16580"><span data-slate-leaf="true" data-offset-key="16580:0" data-first-offset="true"><span data-slate-string="true">这个例子的运行结果如下：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="16581"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16582"><span data-slate-object="text" data-key="16583"><span data-slate-leaf="true" data-offset-key="16583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16584"><span data-slate-leaf="true" data-offset-key="16584:0" data-first-offset="true"><span data-slate-string="true"> a </span></span></span><span data-slate-object="text" data-key="16585"><span data-slate-leaf="true" data-offset-key="16585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group</span></span></span></span><span data-slate-object="text" data-key="16586"><span data-slate-leaf="true" data-offset-key="16586:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16587"><span data-slate-leaf="true" data-offset-key="16587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">of</span></span></span></span><span data-slate-object="text" data-key="16588"><span data-slate-leaf="true" data-offset-key="16588:0" data-first-offset="true"><span data-slate-string="true"> workers...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16589"><span data-slate-object="text" data-key="16590"><span data-slate-leaf="true" data-offset-key="16590:0" data-first-offset="true"><span data-slate-string="true">the </span></span></span><span data-slate-object="text" data-key="16591"><span data-slate-leaf="true" data-offset-key="16591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group</span></span></span></span><span data-slate-object="text" data-key="16592"><span data-slate-leaf="true" data-offset-key="16592:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16593"><span data-slate-leaf="true" data-offset-key="16593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">of</span></span></span></span><span data-slate-object="text" data-key="16594"><span data-slate-leaf="true" data-offset-key="16594:0" data-first-offset="true"><span data-slate-string="true"> workers </span></span></span><span data-slate-object="text" data-key="16595"><span data-slate-leaf="true" data-offset-key="16595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16596"><span data-slate-leaf="true" data-offset-key="16596:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16597"><span data-slate-leaf="true" data-offset-key="16597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16598"><span data-slate-leaf="true" data-offset-key="16598:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16599"><span data-slate-object="text" data-key="16600"><span data-slate-leaf="true" data-offset-key="16600:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16601"><span data-slate-leaf="true" data-offset-key="16601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="16602"><span data-slate-leaf="true" data-offset-key="16602:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16603"><span data-slate-leaf="true" data-offset-key="16603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16604"><span data-slate-leaf="true" data-offset-key="16604:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16605"><span data-slate-leaf="true" data-offset-key="16605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16606"><span data-slate-leaf="true" data-offset-key="16606:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16607"><span data-slate-object="text" data-key="16608"><span data-slate-leaf="true" data-offset-key="16608:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16609"><span data-slate-leaf="true" data-offset-key="16609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="16610"><span data-slate-leaf="true" data-offset-key="16610:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16611"><span data-slate-leaf="true" data-offset-key="16611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16612"><span data-slate-leaf="true" data-offset-key="16612:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16613"><span data-slate-object="text" data-key="16614"><span data-slate-leaf="true" data-offset-key="16614:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16615"><span data-slate-leaf="true" data-offset-key="16615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="16616"><span data-slate-leaf="true" data-offset-key="16616:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16617"><span data-slate-leaf="true" data-offset-key="16617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16618"><span data-slate-leaf="true" data-offset-key="16618:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16619"><span data-slate-leaf="true" data-offset-key="16619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16620"><span data-slate-leaf="true" data-offset-key="16620:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16621"><span data-slate-object="text" data-key="16622"><span data-slate-leaf="true" data-offset-key="16622:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16623"><span data-slate-leaf="true" data-offset-key="16623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="16624"><span data-slate-leaf="true" data-offset-key="16624:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16625"><span data-slate-leaf="true" data-offset-key="16625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16626"><span data-slate-leaf="true" data-offset-key="16626:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16627"><span data-slate-object="text" data-key="16628"><span data-slate-leaf="true" data-offset-key="16628:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16629"><span data-slate-leaf="true" data-offset-key="16629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16630"><span data-slate-leaf="true" data-offset-key="16630:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16631"><span data-slate-leaf="true" data-offset-key="16631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16632"><span data-slate-leaf="true" data-offset-key="16632:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16633"><span data-slate-leaf="true" data-offset-key="16633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16634"><span data-slate-leaf="true" data-offset-key="16634:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16635"><span data-slate-object="text" data-key="16636"><span data-slate-leaf="true" data-offset-key="16636:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16637"><span data-slate-leaf="true" data-offset-key="16637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16638"><span data-slate-leaf="true" data-offset-key="16638:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16639"><span data-slate-leaf="true" data-offset-key="16639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16640"><span data-slate-leaf="true" data-offset-key="16640:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16641"><span data-slate-object="text" data-key="16642"><span data-slate-leaf="true" data-offset-key="16642:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16643"><span data-slate-leaf="true" data-offset-key="16643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16644"><span data-slate-leaf="true" data-offset-key="16644:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16645"><span data-slate-leaf="true" data-offset-key="16645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16646"><span data-slate-leaf="true" data-offset-key="16646:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16647"><span data-slate-leaf="true" data-offset-key="16647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16648"><span data-slate-leaf="true" data-offset-key="16648:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16649"><span data-slate-object="text" data-key="16650"><span data-slate-leaf="true" data-offset-key="16650:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16651"><span data-slate-leaf="true" data-offset-key="16651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16652"><span data-slate-leaf="true" data-offset-key="16652:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16653"><span data-slate-leaf="true" data-offset-key="16653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16654"><span data-slate-leaf="true" data-offset-key="16654:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16655"><span data-slate-object="text" data-key="16656"><span data-slate-leaf="true" data-offset-key="16656:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16657"><span data-slate-leaf="true" data-offset-key="16657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="16658"><span data-slate-leaf="true" data-offset-key="16658:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16659"><span data-slate-leaf="true" data-offset-key="16659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="16660"><span data-slate-leaf="true" data-offset-key="16660:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16661"><span data-slate-leaf="true" data-offset-key="16661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="16662"><span data-slate-leaf="true" data-offset-key="16662:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16663"><span data-slate-object="text" data-key="16664"><span data-slate-leaf="true" data-offset-key="16664:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16665"><span data-slate-leaf="true" data-offset-key="16665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="16666"><span data-slate-leaf="true" data-offset-key="16666:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16667"><span data-slate-leaf="true" data-offset-key="16667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16668"><span data-slate-leaf="true" data-offset-key="16668:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16669"><span data-slate-object="text" data-key="16670"><span data-slate-leaf="true" data-offset-key="16670:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16671"><span data-slate-leaf="true" data-offset-key="16671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="16672"><span data-slate-leaf="true" data-offset-key="16672:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16673"><span data-slate-object="text" data-key="16674"><span data-slate-leaf="true" data-offset-key="16674:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16675"><span data-slate-leaf="true" data-offset-key="16675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="16676"><span data-slate-leaf="true" data-offset-key="16676:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16677"><span data-slate-object="text" data-key="16678"><span data-slate-leaf="true" data-offset-key="16678:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16679"><span data-slate-leaf="true" data-offset-key="16679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16680"><span data-slate-leaf="true" data-offset-key="16680:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16681"><span data-slate-object="text" data-key="16682"><span data-slate-leaf="true" data-offset-key="16682:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16683"><span data-slate-leaf="true" data-offset-key="16683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16684"><span data-slate-leaf="true" data-offset-key="16684:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16685"><span data-slate-object="text" data-key="16686"><span data-slate-leaf="true" data-offset-key="16686:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="16687"><span data-slate-leaf="true" data-offset-key="16687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="16688"><span data-slate-leaf="true" data-offset-key="16688:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16689"><span data-slate-object="text" data-key="16690"><span data-slate-leaf="true" data-offset-key="16690:0" data-first-offset="true"><span data-slate-string="true">the </span></span></span><span data-slate-object="text" data-key="16691"><span data-slate-leaf="true" data-offset-key="16691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group</span></span></span></span><span data-slate-object="text" data-key="16692"><span data-slate-leaf="true" data-offset-key="16692:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16693"><span data-slate-leaf="true" data-offset-key="16693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">of</span></span></span></span><span data-slate-object="text" data-key="16694"><span data-slate-leaf="true" data-offset-key="16694:0" data-first-offset="true"><span data-slate-string="true"> workers work done</span></span></span><span data-slate-object="text" data-key="16695"><span data-slate-leaf="true" data-offset-key="16695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">!</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16696"><span data-slate-object="text" data-key="16697"><span data-slate-leaf="true" data-offset-key="16697:0" data-first-offset="true"><span data-slate-string="true">我们可以看到，关闭一个无缓冲 channel 会让所有阻塞在这个 channel 上的接收操作返回，从而实现了一种 1 对 n 的</span></span></span><span data-slate-object="text" data-key="16698"><span data-slate-leaf="true" data-offset-key="16698:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “广播”</span></span></span></span><span data-slate-object="text" data-key="16699"><span data-slate-leaf="true" data-offset-key="16699:0" data-first-offset="true"><span data-slate-string="true"> 机制。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16700" id="sr-toc-8"><span data-slate-object="text" data-key="16701"><span data-slate-leaf="true" data-offset-key="16701:0" data-first-offset="true"><span data-slate-string="true">第二种用法：用于替代锁机制</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16702"><span data-slate-object="text" data-key="16703"><span data-slate-leaf="true" data-offset-key="16703:0" data-first-offset="true"><span data-slate-string="true">无缓冲 channel 具有同步特性，这让它在某些场合可以替代锁，让我们的程序更加清晰，可读性也更好。我们可以对比下两个方案，直观地感受一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16704"><span data-slate-object="text" data-key="16705"><span data-slate-leaf="true" data-offset-key="16705:0" data-first-offset="true"><span data-slate-string="true">首先我们看一个传统的、基于 “共享内存”+“互斥锁” 的 Goroutine 安全的计数器的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16706"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16707"><span data-slate-object="text" data-key="16708"><span data-slate-leaf="true" data-offset-key="16708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16709"><span data-slate-leaf="true" data-offset-key="16709:0" data-first-offset="true"><span data-slate-string="true"> counter </span></span></span><span data-slate-object="text" data-key="16710"><span data-slate-leaf="true" data-offset-key="16710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16711"><span data-slate-leaf="true" data-offset-key="16711:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16712"><span data-slate-object="text" data-key="16713"><span data-slate-leaf="true" data-offset-key="16713:0" data-first-offset="true"><span data-slate-string="true">    sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16714"><span data-slate-object="text" data-key="16715"><span data-slate-leaf="true" data-offset-key="16715:0" data-first-offset="true"><span data-slate-string="true">    i </span></span></span><span data-slate-object="text" data-key="16716"><span data-slate-leaf="true" data-offset-key="16716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16717"><span data-slate-object="text" data-key="16718"><span data-slate-leaf="true" data-offset-key="16718:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16719"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16720"><span data-slate-object="text" data-key="16721"><span data-slate-leaf="true" data-offset-key="16721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="16722"><span data-slate-leaf="true" data-offset-key="16722:0" data-first-offset="true"><span data-slate-string="true"> cter counter</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16723"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16724"><span data-slate-object="text" data-key="16725"><span data-slate-leaf="true" data-offset-key="16725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16726"><span data-slate-leaf="true" data-offset-key="16726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16727"><span data-slate-leaf="true" data-offset-key="16727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Increase</span></span></span></span></span><span data-slate-object="text" data-key="16728"><span data-slate-leaf="true" data-offset-key="16728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16729"><span data-slate-leaf="true" data-offset-key="16729:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16730"><span data-slate-leaf="true" data-offset-key="16730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16731"><span data-slate-leaf="true" data-offset-key="16731:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16732"><span data-slate-object="text" data-key="16733"><span data-slate-leaf="true" data-offset-key="16733:0" data-first-offset="true"><span data-slate-string="true">    cter.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16734"><span data-slate-object="text" data-key="16735"><span data-slate-leaf="true" data-offset-key="16735:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16736"><span data-slate-leaf="true" data-offset-key="16736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="16737"><span data-slate-leaf="true" data-offset-key="16737:0" data-first-offset="true"><span data-slate-string="true"> cter.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16738"><span data-slate-object="text" data-key="16739"><span data-slate-leaf="true" data-offset-key="16739:0" data-first-offset="true"><span data-slate-string="true">    cter.i++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16740"><span data-slate-object="text" data-key="16741"><span data-slate-leaf="true" data-offset-key="16741:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16742"><span data-slate-leaf="true" data-offset-key="16742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16743"><span data-slate-leaf="true" data-offset-key="16743:0" data-first-offset="true"><span data-slate-string="true"> cter.i</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16744"><span data-slate-object="text" data-key="16745"><span data-slate-leaf="true" data-offset-key="16745:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16746"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16747"><span data-slate-object="text" data-key="16748"><span data-slate-leaf="true" data-offset-key="16748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16749"><span data-slate-leaf="true" data-offset-key="16749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16750"><span data-slate-leaf="true" data-offset-key="16750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16751"><span data-slate-leaf="true" data-offset-key="16751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16752"><span data-slate-leaf="true" data-offset-key="16752:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16753"><span data-slate-object="text" data-key="16754"><span data-slate-leaf="true" data-offset-key="16754:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16755"><span data-slate-leaf="true" data-offset-key="16755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="16756"><span data-slate-leaf="true" data-offset-key="16756:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16757"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16758"><span data-slate-object="text" data-key="16759"><span data-slate-leaf="true" data-offset-key="16759:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16760"><span data-slate-leaf="true" data-offset-key="16760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16761"><span data-slate-leaf="true" data-offset-key="16761:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="16762"><span data-slate-leaf="true" data-offset-key="16762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16763"><span data-slate-leaf="true" data-offset-key="16763:0" data-first-offset="true"><span data-slate-string="true">; i &lt; </span></span></span><span data-slate-object="text" data-key="16764"><span data-slate-leaf="true" data-offset-key="16764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="16765"><span data-slate-leaf="true" data-offset-key="16765:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16766"><span data-slate-object="text" data-key="16767"><span data-slate-leaf="true" data-offset-key="16767:0" data-first-offset="true"><span data-slate-string="true">        wg.Add(</span></span></span><span data-slate-object="text" data-key="16768"><span data-slate-leaf="true" data-offset-key="16768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16769"><span data-slate-leaf="true" data-offset-key="16769:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16770"><span data-slate-object="text" data-key="16771"><span data-slate-leaf="true" data-offset-key="16771:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16772"><span data-slate-leaf="true" data-offset-key="16772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16773"><span data-slate-leaf="true" data-offset-key="16773:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16774"><span data-slate-leaf="true" data-offset-key="16774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16775"><span data-slate-leaf="true" data-offset-key="16775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="16776"><span data-slate-leaf="true" data-offset-key="16776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16777"><span data-slate-leaf="true" data-offset-key="16777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16778"><span data-slate-leaf="true" data-offset-key="16778:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16779"><span data-slate-object="text" data-key="16780"><span data-slate-leaf="true" data-offset-key="16780:0" data-first-offset="true"><span data-slate-string="true">            v := Increase()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16781"><span data-slate-object="text" data-key="16782"><span data-slate-leaf="true" data-offset-key="16782:0" data-first-offset="true"><span data-slate-string="true">            fmt.Printf(</span></span></span><span data-slate-object="text" data-key="16783"><span data-slate-leaf="true" data-offset-key="16783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"goroutine-%d: current counter value is %d\n"</span></span></span></span><span data-slate-object="text" data-key="16784"><span data-slate-leaf="true" data-offset-key="16784:0" data-first-offset="true"><span data-slate-string="true">, i, v)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16785"><span data-slate-object="text" data-key="16786"><span data-slate-leaf="true" data-offset-key="16786:0" data-first-offset="true"><span data-slate-string="true">            wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16787"><span data-slate-object="text" data-key="16788"><span data-slate-leaf="true" data-offset-key="16788:0" data-first-offset="true"><span data-slate-string="true">        }(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16789"><span data-slate-object="text" data-key="16790"><span data-slate-leaf="true" data-offset-key="16790:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16791"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16792"><span data-slate-object="text" data-key="16793"><span data-slate-leaf="true" data-offset-key="16793:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16794"><span data-slate-object="text" data-key="16795"><span data-slate-leaf="true" data-offset-key="16795:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16796"><span data-slate-object="text" data-key="16797"><span data-slate-leaf="true" data-offset-key="16797:0" data-first-offset="true"><span data-slate-string="true">在这个示例中，我们使用了一个带有互斥锁保护的全局变量作为计数器，所有要操作计数器的 Goroutine 共享这个全局变量，并在互斥锁的同步下对计数器进行自增操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16798"><span data-slate-object="text" data-key="16799"><span data-slate-leaf="true" data-offset-key="16799:0" data-first-offset="true"><span data-slate-string="true">接下来我们再看更符合 Go 设计惯例的实现，也就是使用无缓冲 channel 替代锁后的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16800"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16801"><span data-slate-object="text" data-key="16802"><span data-slate-leaf="true" data-offset-key="16802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16803"><span data-slate-leaf="true" data-offset-key="16803:0" data-first-offset="true"><span data-slate-string="true"> counter </span></span></span><span data-slate-object="text" data-key="16804"><span data-slate-leaf="true" data-offset-key="16804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16805"><span data-slate-leaf="true" data-offset-key="16805:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16806"><span data-slate-object="text" data-key="16807"><span data-slate-leaf="true" data-offset-key="16807:0" data-first-offset="true"><span data-slate-string="true">    c </span></span></span><span data-slate-object="text" data-key="16808"><span data-slate-leaf="true" data-offset-key="16808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16809"><span data-slate-leaf="true" data-offset-key="16809:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16810"><span data-slate-leaf="true" data-offset-key="16810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16811"><span data-slate-object="text" data-key="16812"><span data-slate-leaf="true" data-offset-key="16812:0" data-first-offset="true"><span data-slate-string="true">    i </span></span></span><span data-slate-object="text" data-key="16813"><span data-slate-leaf="true" data-offset-key="16813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16814"><span data-slate-object="text" data-key="16815"><span data-slate-leaf="true" data-offset-key="16815:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16816"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16817"><span data-slate-object="text" data-key="16818"><span data-slate-leaf="true" data-offset-key="16818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16819"><span data-slate-leaf="true" data-offset-key="16819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16820"><span data-slate-leaf="true" data-offset-key="16820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewCounter</span></span></span></span></span><span data-slate-object="text" data-key="16821"><span data-slate-leaf="true" data-offset-key="16821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16822"><span data-slate-leaf="true" data-offset-key="16822:0" data-first-offset="true"><span data-slate-string="true"> *counter {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16823"><span data-slate-object="text" data-key="16824"><span data-slate-leaf="true" data-offset-key="16824:0" data-first-offset="true"><span data-slate-string="true">    cter := &amp;counter{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16825"><span data-slate-object="text" data-key="16826"><span data-slate-leaf="true" data-offset-key="16826:0" data-first-offset="true"><span data-slate-string="true">        c: </span></span></span><span data-slate-object="text" data-key="16827"><span data-slate-leaf="true" data-offset-key="16827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16828"><span data-slate-leaf="true" data-offset-key="16828:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="16829"><span data-slate-leaf="true" data-offset-key="16829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="16830"><span data-slate-leaf="true" data-offset-key="16830:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16831"><span data-slate-leaf="true" data-offset-key="16831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16832"><span data-slate-leaf="true" data-offset-key="16832:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16833"><span data-slate-object="text" data-key="16834"><span data-slate-leaf="true" data-offset-key="16834:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16835"><span data-slate-object="text" data-key="16836"><span data-slate-leaf="true" data-offset-key="16836:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16837"><span data-slate-leaf="true" data-offset-key="16837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16838"><span data-slate-leaf="true" data-offset-key="16838:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16839"><span data-slate-leaf="true" data-offset-key="16839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16840"><span data-slate-leaf="true" data-offset-key="16840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16841"><span data-slate-leaf="true" data-offset-key="16841:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16842"><span data-slate-object="text" data-key="16843"><span data-slate-leaf="true" data-offset-key="16843:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16844"><span data-slate-leaf="true" data-offset-key="16844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16845"><span data-slate-leaf="true" data-offset-key="16845:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16846"><span data-slate-object="text" data-key="16847"><span data-slate-leaf="true" data-offset-key="16847:0" data-first-offset="true"><span data-slate-string="true">            cter.i++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16848"><span data-slate-object="text" data-key="16849"><span data-slate-leaf="true" data-offset-key="16849:0" data-first-offset="true"><span data-slate-string="true">            cter.c &lt;- cter.i</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16850"><span data-slate-object="text" data-key="16851"><span data-slate-leaf="true" data-offset-key="16851:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16852"><span data-slate-object="text" data-key="16853"><span data-slate-leaf="true" data-offset-key="16853:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16854"><span data-slate-object="text" data-key="16855"><span data-slate-leaf="true" data-offset-key="16855:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16856"><span data-slate-leaf="true" data-offset-key="16856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16857"><span data-slate-leaf="true" data-offset-key="16857:0" data-first-offset="true"><span data-slate-string="true"> cter</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16858"><span data-slate-object="text" data-key="16859"><span data-slate-leaf="true" data-offset-key="16859:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16860"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16861"><span data-slate-object="text" data-key="16862"><span data-slate-leaf="true" data-offset-key="16862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16863"><span data-slate-leaf="true" data-offset-key="16863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16864"><span data-slate-leaf="true" data-offset-key="16864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(cter *counter)</span></span></span></span></span><span data-slate-object="text" data-key="16865"><span data-slate-leaf="true" data-offset-key="16865:0" data-first-offset="true"><span data-slate-string="true"> Increase() </span></span></span><span data-slate-object="text" data-key="16866"><span data-slate-leaf="true" data-offset-key="16866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="16867"><span data-slate-leaf="true" data-offset-key="16867:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16868"><span data-slate-object="text" data-key="16869"><span data-slate-leaf="true" data-offset-key="16869:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16870"><span data-slate-leaf="true" data-offset-key="16870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16871"><span data-slate-leaf="true" data-offset-key="16871:0" data-first-offset="true"><span data-slate-string="true"> &lt;-cter.c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16872"><span data-slate-object="text" data-key="16873"><span data-slate-leaf="true" data-offset-key="16873:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16874"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16875"><span data-slate-object="text" data-key="16876"><span data-slate-leaf="true" data-offset-key="16876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16877"><span data-slate-leaf="true" data-offset-key="16877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16878"><span data-slate-leaf="true" data-offset-key="16878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16879"><span data-slate-leaf="true" data-offset-key="16879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16880"><span data-slate-leaf="true" data-offset-key="16880:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16881"><span data-slate-object="text" data-key="16882"><span data-slate-leaf="true" data-offset-key="16882:0" data-first-offset="true"><span data-slate-string="true">    cter := NewCounter()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16883"><span data-slate-object="text" data-key="16884"><span data-slate-leaf="true" data-offset-key="16884:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16885"><span data-slate-leaf="true" data-offset-key="16885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="16886"><span data-slate-leaf="true" data-offset-key="16886:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16887"><span data-slate-object="text" data-key="16888"><span data-slate-leaf="true" data-offset-key="16888:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16889"><span data-slate-leaf="true" data-offset-key="16889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16890"><span data-slate-leaf="true" data-offset-key="16890:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="16891"><span data-slate-leaf="true" data-offset-key="16891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16892"><span data-slate-leaf="true" data-offset-key="16892:0" data-first-offset="true"><span data-slate-string="true">; i &lt; </span></span></span><span data-slate-object="text" data-key="16893"><span data-slate-leaf="true" data-offset-key="16893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="16894"><span data-slate-leaf="true" data-offset-key="16894:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16895"><span data-slate-object="text" data-key="16896"><span data-slate-leaf="true" data-offset-key="16896:0" data-first-offset="true"><span data-slate-string="true">        wg.Add(</span></span></span><span data-slate-object="text" data-key="16897"><span data-slate-leaf="true" data-offset-key="16897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16898"><span data-slate-leaf="true" data-offset-key="16898:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16899"><span data-slate-object="text" data-key="16900"><span data-slate-leaf="true" data-offset-key="16900:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16901"><span data-slate-leaf="true" data-offset-key="16901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16902"><span data-slate-leaf="true" data-offset-key="16902:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16903"><span data-slate-leaf="true" data-offset-key="16903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16904"><span data-slate-leaf="true" data-offset-key="16904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="16905"><span data-slate-leaf="true" data-offset-key="16905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="16906"><span data-slate-leaf="true" data-offset-key="16906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="16907"><span data-slate-leaf="true" data-offset-key="16907:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16908"><span data-slate-object="text" data-key="16909"><span data-slate-leaf="true" data-offset-key="16909:0" data-first-offset="true"><span data-slate-string="true">            v := cter.Increase()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16910"><span data-slate-object="text" data-key="16911"><span data-slate-leaf="true" data-offset-key="16911:0" data-first-offset="true"><span data-slate-string="true">            fmt.Printf(</span></span></span><span data-slate-object="text" data-key="16912"><span data-slate-leaf="true" data-offset-key="16912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"goroutine-%d: current counter value is %d\n"</span></span></span></span><span data-slate-object="text" data-key="16913"><span data-slate-leaf="true" data-offset-key="16913:0" data-first-offset="true"><span data-slate-string="true">, i, v)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16914"><span data-slate-object="text" data-key="16915"><span data-slate-leaf="true" data-offset-key="16915:0" data-first-offset="true"><span data-slate-string="true">            wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16916"><span data-slate-object="text" data-key="16917"><span data-slate-leaf="true" data-offset-key="16917:0" data-first-offset="true"><span data-slate-string="true">        }(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16918"><span data-slate-object="text" data-key="16919"><span data-slate-leaf="true" data-offset-key="16919:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16920"><span data-slate-object="text" data-key="16921"><span data-slate-leaf="true" data-offset-key="16921:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16922"><span data-slate-object="text" data-key="16923"><span data-slate-leaf="true" data-offset-key="16923:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16924"><span data-slate-object="text" data-key="16925"><span data-slate-leaf="true" data-offset-key="16925:0" data-first-offset="true"><span data-slate-string="true">在这个实现中，我们将计数器操作全部交给一个独立的 Goroutine 去处理，并通过无缓冲 channel 的同步阻塞特性，实现了计数器的控制。这样其他 Goroutine 通过 Increase 函数试图增加计数器值的动作，实质上就转化为了一次无缓冲 channel 的接收动作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16926"><span data-slate-object="text" data-key="16927"><span data-slate-leaf="true" data-offset-key="16927:0" data-first-offset="true"><span data-slate-string="true">这种并发设计逻辑更符合 Go 语言所倡导的</span></span></span><span data-slate-object="text" data-key="16928"><span data-slate-leaf="true" data-offset-key="16928:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “不要通过共享内存来通信，而是通过通信来共享内存”</span></span></span></span><span data-slate-object="text" data-key="16929"><span data-slate-leaf="true" data-offset-key="16929:0" data-first-offset="true"><span data-slate-string="true"> 的原则。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16930"><span data-slate-object="text" data-key="16931"><span data-slate-leaf="true" data-offset-key="16931:0" data-first-offset="true"><span data-slate-string="true">运行这个示例，我们可以得出与互斥锁方案相同的结果：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="16932"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16933"><span data-slate-object="text" data-key="16934"><span data-slate-leaf="true" data-offset-key="16934:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16935"><span data-slate-leaf="true" data-offset-key="16935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">9</span></span></span></span><span data-slate-object="text" data-key="16936"><span data-slate-leaf="true" data-offset-key="16936:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16937"><span data-slate-leaf="true" data-offset-key="16937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16938"><span data-slate-leaf="true" data-offset-key="16938:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16939"><span data-slate-leaf="true" data-offset-key="16939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16940"><span data-slate-object="text" data-key="16941"><span data-slate-leaf="true" data-offset-key="16941:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16942"><span data-slate-leaf="true" data-offset-key="16942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16943"><span data-slate-leaf="true" data-offset-key="16943:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16944"><span data-slate-leaf="true" data-offset-key="16944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16945"><span data-slate-leaf="true" data-offset-key="16945:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16946"><span data-slate-leaf="true" data-offset-key="16946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16947"><span data-slate-object="text" data-key="16948"><span data-slate-leaf="true" data-offset-key="16948:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16949"><span data-slate-leaf="true" data-offset-key="16949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span><span data-slate-object="text" data-key="16950"><span data-slate-leaf="true" data-offset-key="16950:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16951"><span data-slate-leaf="true" data-offset-key="16951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16952"><span data-slate-leaf="true" data-offset-key="16952:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16953"><span data-slate-leaf="true" data-offset-key="16953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16954"><span data-slate-object="text" data-key="16955"><span data-slate-leaf="true" data-offset-key="16955:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16956"><span data-slate-leaf="true" data-offset-key="16956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="16957"><span data-slate-leaf="true" data-offset-key="16957:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16958"><span data-slate-leaf="true" data-offset-key="16958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16959"><span data-slate-leaf="true" data-offset-key="16959:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16960"><span data-slate-leaf="true" data-offset-key="16960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16961"><span data-slate-object="text" data-key="16962"><span data-slate-leaf="true" data-offset-key="16962:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16963"><span data-slate-leaf="true" data-offset-key="16963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span><span data-slate-object="text" data-key="16964"><span data-slate-leaf="true" data-offset-key="16964:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16965"><span data-slate-leaf="true" data-offset-key="16965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16966"><span data-slate-leaf="true" data-offset-key="16966:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16967"><span data-slate-leaf="true" data-offset-key="16967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">9</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16968"><span data-slate-object="text" data-key="16969"><span data-slate-leaf="true" data-offset-key="16969:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16970"><span data-slate-leaf="true" data-offset-key="16970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="16971"><span data-slate-leaf="true" data-offset-key="16971:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16972"><span data-slate-leaf="true" data-offset-key="16972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16973"><span data-slate-leaf="true" data-offset-key="16973:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16974"><span data-slate-leaf="true" data-offset-key="16974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16975"><span data-slate-object="text" data-key="16976"><span data-slate-leaf="true" data-offset-key="16976:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16977"><span data-slate-leaf="true" data-offset-key="16977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="16978"><span data-slate-leaf="true" data-offset-key="16978:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16979"><span data-slate-leaf="true" data-offset-key="16979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16980"><span data-slate-leaf="true" data-offset-key="16980:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16981"><span data-slate-leaf="true" data-offset-key="16981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16982"><span data-slate-object="text" data-key="16983"><span data-slate-leaf="true" data-offset-key="16983:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16984"><span data-slate-leaf="true" data-offset-key="16984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="16985"><span data-slate-leaf="true" data-offset-key="16985:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16986"><span data-slate-leaf="true" data-offset-key="16986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16987"><span data-slate-leaf="true" data-offset-key="16987:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16988"><span data-slate-leaf="true" data-offset-key="16988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16989"><span data-slate-object="text" data-key="16990"><span data-slate-leaf="true" data-offset-key="16990:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16991"><span data-slate-leaf="true" data-offset-key="16991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="16992"><span data-slate-leaf="true" data-offset-key="16992:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="16993"><span data-slate-leaf="true" data-offset-key="16993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="16994"><span data-slate-leaf="true" data-offset-key="16994:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16995"><span data-slate-leaf="true" data-offset-key="16995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16996"><span data-slate-object="text" data-key="16997"><span data-slate-leaf="true" data-offset-key="16997:0" data-first-offset="true"><span data-slate-string="true">goroutine-</span></span></span><span data-slate-object="text" data-key="16998"><span data-slate-leaf="true" data-offset-key="16998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="16999"><span data-slate-leaf="true" data-offset-key="16999:0" data-first-offset="true"><span data-slate-string="true">: current counter value </span></span></span><span data-slate-object="text" data-key="17000"><span data-slate-leaf="true" data-offset-key="17000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17001"><span data-slate-leaf="true" data-offset-key="17001:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17002"><span data-slate-leaf="true" data-offset-key="17002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17003" id="sr-toc-9"><span data-slate-object="text" data-key="17004"><span data-slate-leaf="true" data-offset-key="17004:0" data-first-offset="true"><span data-slate-string="true">带缓冲 channel 的惯用法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17005"><span data-slate-object="text" data-key="17006"><span data-slate-leaf="true" data-offset-key="17006:0" data-first-offset="true"><span data-slate-string="true">带缓冲的 channel 与无缓冲的 channel 的最大不同之处，就在于它的</span></span></span><span data-slate-object="text" data-key="17007"><span data-slate-leaf="true" data-offset-key="17007:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">异步性</span></span></span></span><span data-slate-object="text" data-key="17008"><span data-slate-leaf="true" data-offset-key="17008:0" data-first-offset="true"><span data-slate-string="true">。也就是说，对一个带缓冲 channel，在缓冲区未满的情况下，对它进行发送操作的 Goroutine 不会阻塞挂起；在缓冲区有数据的情况下，对它进行接收操作的 Goroutine 也不会阻塞挂起。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17009"><span data-slate-object="text" data-key="17010"><span data-slate-leaf="true" data-offset-key="17010:0" data-first-offset="true"><span data-slate-string="true">这种特性让带缓冲的 channel 有着与无缓冲 channel 不同的应用场合。接下来我们一个个来分析。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17011" id="sr-toc-10"><span data-slate-object="text" data-key="17012"><span data-slate-leaf="true" data-offset-key="17012:0" data-first-offset="true"><span data-slate-string="true">第一种用法：用作消息队列</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17013"><span data-slate-object="text" data-key="17014"><span data-slate-leaf="true" data-offset-key="17014:0" data-first-offset="true"><span data-slate-string="true">channel 经常被 Go 初学者视为在多个 Goroutine 之间通信的消息队列，这是因为，channel 的原生特性与我们认知中的消息队列十分相似，包括 Goroutine 安全、有 FIFO（first-in, first out）保证等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17015"><span data-slate-object="text" data-key="17016"><span data-slate-leaf="true" data-offset-key="17016:0" data-first-offset="true"><span data-slate-string="true">其实，和无缓冲 channel 更多用于信号 / 事件管道相比，可自行设置容量、异步收发的带缓冲 channel 更适合被用作为消息队列，并且，带缓冲 channel 在数据收发的性能上要明显好于无缓冲 channel。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17017"><span data-slate-object="text" data-key="17018"><span data-slate-leaf="true" data-offset-key="17018:0" data-first-offset="true"><span data-slate-string="true">我们可以通过对 channel 读写的基本测试来印证这一点。下面是一些关于无缓冲 channel 和带缓冲 channel 收发性能测试的结果（Go 1.17, MacBook Pro 8 核）。基准测试的代码比较多，我就不全部贴出来了，你可以到</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17019"><span data-slate-object="text" data-key="17020"><span data-slate-leaf="true" data-offset-key="17020:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="17021"><span data-slate-leaf="true" data-offset-key="17021:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17022"><div data-slate-type="list-line" data-slate-object="block" data-key="17023"><span data-slate-object="text" data-key="17024"><span data-slate-leaf="true" data-offset-key="17024:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">单接收单发送性能的基准测试</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17025"><span data-slate-object="text" data-key="17026"><span data-slate-leaf="true" data-offset-key="17026:0" data-first-offset="true"><span data-slate-string="true">我们先来看看针对一个 channel 只有一个发送 Goroutine 和一个接收 Goroutine 的情况，两种 channel 的收发性能比对数据：</span></span></span></div></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="17027"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17028"><span data-slate-object="text" data-key="17029"><span data-slate-leaf="true" data-offset-key="17029:0" data-first-offset="true"><span data-slate-string="true">// 无缓冲 channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17030"><span data-slate-object="text" data-key="17031"><span data-slate-leaf="true" data-offset-key="17031:0" data-first-offset="true"><span data-slate-string="true">// go-channel-operation-benchmark/unbuffered-chan</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17032"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17033"><span data-slate-object="text" data-key="17034"><span data-slate-leaf="true" data-offset-key="17034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="17035"><span data-slate-leaf="true" data-offset-key="17035:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17036"><span data-slate-leaf="true" data-offset-key="17036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="17037"><span data-slate-leaf="true" data-offset-key="17037:0" data-first-offset="true"><span data-slate-string="true"> -bench . one_to_one_test.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17038"><span data-slate-object="text" data-key="17039"><span data-slate-leaf="true" data-offset-key="17039:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17040"><span data-slate-object="text" data-key="17041"><span data-slate-leaf="true" data-offset-key="17041:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17042"><span data-slate-object="text" data-key="17043"><span data-slate-leaf="true" data-offset-key="17043:0" data-first-offset="true"><span data-slate-string="true">cpu: Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17044"><span data-slate-object="text" data-key="17045"><span data-slate-leaf="true" data-offset-key="17045:0" data-first-offset="true"><span data-slate-string="true">BenchmarkUnbufferedChan1To1Send-8      6037778         199.7 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17046"><span data-slate-object="text" data-key="17047"><span data-slate-leaf="true" data-offset-key="17047:0" data-first-offset="true"><span data-slate-string="true">BenchmarkUnbufferedChan1To1Recv-8      6286850         194.5 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17048"><span data-slate-object="text" data-key="17049"><span data-slate-leaf="true" data-offset-key="17049:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17050"><span data-slate-object="text" data-key="17051"><span data-slate-leaf="true" data-offset-key="17051:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  2.833s</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17052"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17053"><span data-slate-object="text" data-key="17054"><span data-slate-leaf="true" data-offset-key="17054:0" data-first-offset="true"><span data-slate-string="true">// 带缓冲 channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17055"><span data-slate-object="text" data-key="17056"><span data-slate-leaf="true" data-offset-key="17056:0" data-first-offset="true"><span data-slate-string="true">// go-channel-operation-benchmark/buffered-chan</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17057"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17058"><span data-slate-object="text" data-key="17059"><span data-slate-leaf="true" data-offset-key="17059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="17060"><span data-slate-leaf="true" data-offset-key="17060:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17061"><span data-slate-leaf="true" data-offset-key="17061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="17062"><span data-slate-leaf="true" data-offset-key="17062:0" data-first-offset="true"><span data-slate-string="true"> -bench . one_to_one_cap_10_test.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17063"><span data-slate-object="text" data-key="17064"><span data-slate-leaf="true" data-offset-key="17064:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17065"><span data-slate-object="text" data-key="17066"><span data-slate-leaf="true" data-offset-key="17066:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17067"><span data-slate-object="text" data-key="17068"><span data-slate-leaf="true" data-offset-key="17068:0" data-first-offset="true"><span data-slate-string="true">cpu: Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17069"><span data-slate-object="text" data-key="17070"><span data-slate-leaf="true" data-offset-key="17070:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChan1To1SendCap10-8     17089879          66.16 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17071"><span data-slate-object="text" data-key="17072"><span data-slate-leaf="true" data-offset-key="17072:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChan1To1RecvCap10-8     18043450          65.57 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17073"><span data-slate-object="text" data-key="17074"><span data-slate-leaf="true" data-offset-key="17074:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17075"><span data-slate-object="text" data-key="17076"><span data-slate-leaf="true" data-offset-key="17076:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  2.460s</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17077"><span data-slate-object="text" data-key="17078"><span data-slate-leaf="true" data-offset-key="17078:0" data-first-offset="true"><span data-slate-string="true">然后我们将 channel 的缓存由 10 改为 100，再看看带缓冲 channel 的 1 对 1 基准测试结果：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="17079"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17080"><span data-slate-object="text" data-key="17081"><span data-slate-leaf="true" data-offset-key="17081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="17082"><span data-slate-leaf="true" data-offset-key="17082:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17083"><span data-slate-leaf="true" data-offset-key="17083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="17084"><span data-slate-leaf="true" data-offset-key="17084:0" data-first-offset="true"><span data-slate-string="true"> -bench . one_to_one_cap_100_test.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17085"><span data-slate-object="text" data-key="17086"><span data-slate-leaf="true" data-offset-key="17086:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17087"><span data-slate-object="text" data-key="17088"><span data-slate-leaf="true" data-offset-key="17088:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17089"><span data-slate-object="text" data-key="17090"><span data-slate-leaf="true" data-offset-key="17090:0" data-first-offset="true"><span data-slate-string="true">cpu: Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17091"><span data-slate-object="text" data-key="17092"><span data-slate-leaf="true" data-offset-key="17092:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChan1To1SendCap100-8     23089318          53.06 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17093"><span data-slate-object="text" data-key="17094"><span data-slate-leaf="true" data-offset-key="17094:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChan1To1RecvCap100-8     23474095          51.33 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17095"><span data-slate-object="text" data-key="17096"><span data-slate-leaf="true" data-offset-key="17096:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17097"><span data-slate-object="text" data-key="17098"><span data-slate-leaf="true" data-offset-key="17098:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  2.542s</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="17099"><div data-slate-type="list-line" data-slate-object="block" data-key="17100"><span data-slate-object="text" data-key="17101"><span data-slate-leaf="true" data-offset-key="17101:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">多接收多发送性能基准测试</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17102"><span data-slate-object="text" data-key="17103"><span data-slate-leaf="true" data-offset-key="17103:0" data-first-offset="true"><span data-slate-string="true">我们再来看看，针对一个 channel 有多个发送 Goroutine 和多个接收 Goroutine 的情况，两种 channel 的收发性能比对数据（这里建立 10 个发送 Goroutine 和 10 个接收 Goroutine）：</span></span></span></div></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="17104"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17105"><span data-slate-object="text" data-key="17106"><span data-slate-leaf="true" data-offset-key="17106:0" data-first-offset="true"><span data-slate-string="true">// 无缓冲 channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17107"><span data-slate-object="text" data-key="17108"><span data-slate-leaf="true" data-offset-key="17108:0" data-first-offset="true"><span data-slate-string="true">// go-channel-operation-benchmark/unbuffered-chan</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17109"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17110"><span data-slate-object="text" data-key="17111"><span data-slate-leaf="true" data-offset-key="17111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="17112"><span data-slate-leaf="true" data-offset-key="17112:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17113"><span data-slate-leaf="true" data-offset-key="17113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="17114"><span data-slate-leaf="true" data-offset-key="17114:0" data-first-offset="true"><span data-slate-string="true"> -bench .  multi_to_multi_test.go </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17115"><span data-slate-object="text" data-key="17116"><span data-slate-leaf="true" data-offset-key="17116:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17117"><span data-slate-object="text" data-key="17118"><span data-slate-leaf="true" data-offset-key="17118:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17119"><span data-slate-object="text" data-key="17120"><span data-slate-leaf="true" data-offset-key="17120:0" data-first-offset="true"><span data-slate-string="true">cpu: Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17121"><span data-slate-object="text" data-key="17122"><span data-slate-leaf="true" data-offset-key="17122:0" data-first-offset="true"><span data-slate-string="true">BenchmarkUnbufferedChanNToNSend-8       293930        3779 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17123"><span data-slate-object="text" data-key="17124"><span data-slate-leaf="true" data-offset-key="17124:0" data-first-offset="true"><span data-slate-string="true">BenchmarkUnbufferedChanNToNRecv-8       280904        4190 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17125"><span data-slate-object="text" data-key="17126"><span data-slate-leaf="true" data-offset-key="17126:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17127"><span data-slate-object="text" data-key="17128"><span data-slate-leaf="true" data-offset-key="17128:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  2.387s</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17129"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17130"><span data-slate-object="text" data-key="17131"><span data-slate-leaf="true" data-offset-key="17131:0" data-first-offset="true"><span data-slate-string="true">// 带缓冲 channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17132"><span data-slate-object="text" data-key="17133"><span data-slate-leaf="true" data-offset-key="17133:0" data-first-offset="true"><span data-slate-string="true">// go-channel-operation-benchmark/buffered-chan</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17134"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17135"><span data-slate-object="text" data-key="17136"><span data-slate-leaf="true" data-offset-key="17136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="17137"><span data-slate-leaf="true" data-offset-key="17137:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17138"><span data-slate-leaf="true" data-offset-key="17138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="17139"><span data-slate-leaf="true" data-offset-key="17139:0" data-first-offset="true"><span data-slate-string="true"> -bench . multi_to_multi_cap_10_test.go </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17140"><span data-slate-object="text" data-key="17141"><span data-slate-leaf="true" data-offset-key="17141:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17142"><span data-slate-object="text" data-key="17143"><span data-slate-leaf="true" data-offset-key="17143:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17144"><span data-slate-object="text" data-key="17145"><span data-slate-leaf="true" data-offset-key="17145:0" data-first-offset="true"><span data-slate-string="true">cpu: Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17146"><span data-slate-object="text" data-key="17147"><span data-slate-leaf="true" data-offset-key="17147:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChanNToNSendCap10-8       736540        1609 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17148"><span data-slate-object="text" data-key="17149"><span data-slate-leaf="true" data-offset-key="17149:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChanNToNRecvCap10-8       795416        1616 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17150"><span data-slate-object="text" data-key="17151"><span data-slate-leaf="true" data-offset-key="17151:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17152"><span data-slate-object="text" data-key="17153"><span data-slate-leaf="true" data-offset-key="17153:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  2.514s</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17154"><span data-slate-object="text" data-key="17155"><span data-slate-leaf="true" data-offset-key="17155:0" data-first-offset="true"><span data-slate-string="true">这里我们也将 channel 的缓存由 10 改为 100 后，看看带缓冲 channel 的多对多基准测试结果：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="17156"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17157"><span data-slate-object="text" data-key="17158"><span data-slate-leaf="true" data-offset-key="17158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="17159"><span data-slate-leaf="true" data-offset-key="17159:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17160"><span data-slate-leaf="true" data-offset-key="17160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="17161"><span data-slate-leaf="true" data-offset-key="17161:0" data-first-offset="true"><span data-slate-string="true"> -bench . multi_to_multi_cap_100_test.go </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17162"><span data-slate-object="text" data-key="17163"><span data-slate-leaf="true" data-offset-key="17163:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17164"><span data-slate-object="text" data-key="17165"><span data-slate-leaf="true" data-offset-key="17165:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17166"><span data-slate-object="text" data-key="17167"><span data-slate-leaf="true" data-offset-key="17167:0" data-first-offset="true"><span data-slate-string="true">cpu: Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17168"><span data-slate-object="text" data-key="17169"><span data-slate-leaf="true" data-offset-key="17169:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChanNToNSendCap100-8      1236453         966.4 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17170"><span data-slate-object="text" data-key="17171"><span data-slate-leaf="true" data-offset-key="17171:0" data-first-offset="true"><span data-slate-string="true">BenchmarkBufferedChanNToNRecvCap100-8      1279766         969.4 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17172"><span data-slate-object="text" data-key="17173"><span data-slate-leaf="true" data-offset-key="17173:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17174"><span data-slate-object="text" data-key="17175"><span data-slate-leaf="true" data-offset-key="17175:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  4.309s</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17176"><span data-slate-object="text" data-key="17177"><span data-slate-leaf="true" data-offset-key="17177:0" data-first-offset="true"><span data-slate-string="true">综合前面这些结果数据，我们可以得出几个初步结论：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17178"><div data-slate-type="list-line" data-slate-object="block" data-key="17179"><span data-slate-object="text" data-key="17180"><span data-slate-leaf="true" data-offset-key="17180:0" data-first-offset="true"><span data-slate-string="true">无论是 1 收 1 发还是多收多发，带缓冲 channel 的收发性能都要好于无缓冲 channel；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17181"><span data-slate-object="text" data-key="17182"><span data-slate-leaf="true" data-offset-key="17182:0" data-first-offset="true"><span data-slate-string="true">对于带缓冲 channel 而言，发送与接收的 Goroutine 数量越多，收发性能会有所下降；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17183"><span data-slate-object="text" data-key="17184"><span data-slate-leaf="true" data-offset-key="17184:0" data-first-offset="true"><span data-slate-string="true">对于带缓冲 channel 而言，选择适当容量会在一定程度上提升收发性能。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17185"><span data-slate-object="text" data-key="17186"><span data-slate-leaf="true" data-offset-key="17186:0" data-first-offset="true"><span data-slate-string="true">不过你要注意的是，Go 支持 channel 的初衷是将它作为 Goroutine 间的通信手段，它并不是专门用于消息队列场景的。如果你的项目需要专业消息队列的功能特性，比如支持优先级、支持权重、支持离线持久化等，那么 channel 就不合适了，可以使用第三方的专业的消息队列实现。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17187" id="sr-toc-11"><span data-slate-object="text" data-key="17188"><span data-slate-leaf="true" data-offset-key="17188:0" data-first-offset="true"><span data-slate-string="true">第二种用法：用作计数信号量（counting semaphore）</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17189"><span data-slate-object="text" data-key="17190"><span data-slate-leaf="true" data-offset-key="17190:0" data-first-offset="true"><span data-slate-string="true">Go 并发设计的一个惯用法，就是将带缓冲 channel 用作计数信号量（counting semaphore）。带缓冲 channel 中的当前数据个数代表的是，当前同时处于活动状态（处理业务）的 Goroutine 的数量，而带缓冲 channel 的容量（capacity），就代表了允许同时处于活动状态的 Goroutine 的最大数量。向带缓冲 channel 的一个发送操作表示获取一个信号量，而从 channel 的一个接收操作则表示释放一个信号量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17191"><span data-slate-object="text" data-key="17192"><span data-slate-leaf="true" data-offset-key="17192:0" data-first-offset="true"><span data-slate-string="true">这里我们来看一个将带缓冲 channel 用作计数信号量的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17193"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17194"><span data-slate-object="text" data-key="17195"><span data-slate-leaf="true" data-offset-key="17195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17196"><span data-slate-leaf="true" data-offset-key="17196:0" data-first-offset="true"><span data-slate-string="true"> active = </span></span></span><span data-slate-object="text" data-key="17197"><span data-slate-leaf="true" data-offset-key="17197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17198"><span data-slate-leaf="true" data-offset-key="17198:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17199"><span data-slate-leaf="true" data-offset-key="17199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17200"><span data-slate-leaf="true" data-offset-key="17200:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17201"><span data-slate-leaf="true" data-offset-key="17201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17202"><span data-slate-leaf="true" data-offset-key="17202:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="17203"><span data-slate-leaf="true" data-offset-key="17203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="17204"><span data-slate-leaf="true" data-offset-key="17204:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17205"><span data-slate-object="text" data-key="17206"><span data-slate-leaf="true" data-offset-key="17206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17207"><span data-slate-leaf="true" data-offset-key="17207:0" data-first-offset="true"><span data-slate-string="true"> jobs = </span></span></span><span data-slate-object="text" data-key="17208"><span data-slate-leaf="true" data-offset-key="17208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17209"><span data-slate-leaf="true" data-offset-key="17209:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17210"><span data-slate-leaf="true" data-offset-key="17210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17211"><span data-slate-leaf="true" data-offset-key="17211:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17212"><span data-slate-leaf="true" data-offset-key="17212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="17213"><span data-slate-leaf="true" data-offset-key="17213:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17214"><span data-slate-leaf="true" data-offset-key="17214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="17215"><span data-slate-leaf="true" data-offset-key="17215:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17216"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17217"><span data-slate-object="text" data-key="17218"><span data-slate-leaf="true" data-offset-key="17218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17219"><span data-slate-leaf="true" data-offset-key="17219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17220"><span data-slate-leaf="true" data-offset-key="17220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="17221"><span data-slate-leaf="true" data-offset-key="17221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17222"><span data-slate-leaf="true" data-offset-key="17222:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17223"><span data-slate-object="text" data-key="17224"><span data-slate-leaf="true" data-offset-key="17224:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17225"><span data-slate-leaf="true" data-offset-key="17225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17226"><span data-slate-leaf="true" data-offset-key="17226:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17227"><span data-slate-leaf="true" data-offset-key="17227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17228"><span data-slate-leaf="true" data-offset-key="17228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17229"><span data-slate-leaf="true" data-offset-key="17229:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17230"><span data-slate-object="text" data-key="17231"><span data-slate-leaf="true" data-offset-key="17231:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17232"><span data-slate-leaf="true" data-offset-key="17232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17233"><span data-slate-leaf="true" data-offset-key="17233:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="17234"><span data-slate-leaf="true" data-offset-key="17234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17235"><span data-slate-leaf="true" data-offset-key="17235:0" data-first-offset="true"><span data-slate-string="true">; i &lt; </span></span></span><span data-slate-object="text" data-key="17236"><span data-slate-leaf="true" data-offset-key="17236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span><span data-slate-object="text" data-key="17237"><span data-slate-leaf="true" data-offset-key="17237:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17238"><span data-slate-object="text" data-key="17239"><span data-slate-leaf="true" data-offset-key="17239:0" data-first-offset="true"><span data-slate-string="true">            jobs &lt;- (i + </span></span></span><span data-slate-object="text" data-key="17240"><span data-slate-leaf="true" data-offset-key="17240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17241"><span data-slate-leaf="true" data-offset-key="17241:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17242"><span data-slate-object="text" data-key="17243"><span data-slate-leaf="true" data-offset-key="17243:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17244"><span data-slate-object="text" data-key="17245"><span data-slate-leaf="true" data-offset-key="17245:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17246"><span data-slate-leaf="true" data-offset-key="17246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="17247"><span data-slate-leaf="true" data-offset-key="17247:0" data-first-offset="true"><span data-slate-string="true">(jobs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17248"><span data-slate-object="text" data-key="17249"><span data-slate-leaf="true" data-offset-key="17249:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17250"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17251"><span data-slate-object="text" data-key="17252"><span data-slate-leaf="true" data-offset-key="17252:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17253"><span data-slate-leaf="true" data-offset-key="17253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17254"><span data-slate-leaf="true" data-offset-key="17254:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17255"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17256"><span data-slate-object="text" data-key="17257"><span data-slate-leaf="true" data-offset-key="17257:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17258"><span data-slate-leaf="true" data-offset-key="17258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17259"><span data-slate-leaf="true" data-offset-key="17259:0" data-first-offset="true"><span data-slate-string="true"> j := </span></span></span><span data-slate-object="text" data-key="17260"><span data-slate-leaf="true" data-offset-key="17260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="17261"><span data-slate-leaf="true" data-offset-key="17261:0" data-first-offset="true"><span data-slate-string="true"> jobs {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17262"><span data-slate-object="text" data-key="17263"><span data-slate-leaf="true" data-offset-key="17263:0" data-first-offset="true"><span data-slate-string="true">        wg.Add(</span></span></span><span data-slate-object="text" data-key="17264"><span data-slate-leaf="true" data-offset-key="17264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17265"><span data-slate-leaf="true" data-offset-key="17265:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17266"><span data-slate-object="text" data-key="17267"><span data-slate-leaf="true" data-offset-key="17267:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17268"><span data-slate-leaf="true" data-offset-key="17268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17269"><span data-slate-leaf="true" data-offset-key="17269:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17270"><span data-slate-leaf="true" data-offset-key="17270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17271"><span data-slate-leaf="true" data-offset-key="17271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(j </span></span></span></span></span><span data-slate-object="text" data-key="17272"><span data-slate-leaf="true" data-offset-key="17272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17273"><span data-slate-leaf="true" data-offset-key="17273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17274"><span data-slate-leaf="true" data-offset-key="17274:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17275"><span data-slate-object="text" data-key="17276"><span data-slate-leaf="true" data-offset-key="17276:0" data-first-offset="true"><span data-slate-string="true">            active &lt;- </span></span></span><span data-slate-object="text" data-key="17277"><span data-slate-leaf="true" data-offset-key="17277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="17278"><span data-slate-leaf="true" data-offset-key="17278:0" data-first-offset="true"><span data-slate-string="true">{}{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17279"><span data-slate-object="text" data-key="17280"><span data-slate-leaf="true" data-offset-key="17280:0" data-first-offset="true"><span data-slate-string="true">            log.Printf(</span></span></span><span data-slate-object="text" data-key="17281"><span data-slate-leaf="true" data-offset-key="17281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"handle job: %d\n"</span></span></span></span><span data-slate-object="text" data-key="17282"><span data-slate-leaf="true" data-offset-key="17282:0" data-first-offset="true"><span data-slate-string="true">, j)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17283"><span data-slate-object="text" data-key="17284"><span data-slate-leaf="true" data-offset-key="17284:0" data-first-offset="true"><span data-slate-string="true">            time.Sleep(</span></span></span><span data-slate-object="text" data-key="17285"><span data-slate-leaf="true" data-offset-key="17285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="17286"><span data-slate-leaf="true" data-offset-key="17286:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17287"><span data-slate-object="text" data-key="17288"><span data-slate-leaf="true" data-offset-key="17288:0" data-first-offset="true"><span data-slate-string="true">            &lt;-active</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17289"><span data-slate-object="text" data-key="17290"><span data-slate-leaf="true" data-offset-key="17290:0" data-first-offset="true"><span data-slate-string="true">            wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17291"><span data-slate-object="text" data-key="17292"><span data-slate-leaf="true" data-offset-key="17292:0" data-first-offset="true"><span data-slate-string="true">        }(j)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17293"><span data-slate-object="text" data-key="17294"><span data-slate-leaf="true" data-offset-key="17294:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17295"><span data-slate-object="text" data-key="17296"><span data-slate-leaf="true" data-offset-key="17296:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17297"><span data-slate-object="text" data-key="17298"><span data-slate-leaf="true" data-offset-key="17298:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17299"><span data-slate-object="text" data-key="17300"><span data-slate-leaf="true" data-offset-key="17300:0" data-first-offset="true"><span data-slate-string="true">我们看到，这个示例创建了一组 Goroutine 来处理 job，同一时间允许最多 3 个 Goroutine 处于活动状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17301"><span data-slate-object="text" data-key="17302"><span data-slate-leaf="true" data-offset-key="17302:0" data-first-offset="true"><span data-slate-string="true">为了达成这一目标，我们看到这个示例使用了一个容量（capacity）为 3 的带缓冲 channel: </span></span></span><span data-slate-object="text" data-key="17303"><span data-slate-leaf="true" data-offset-key="17303:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">active</span></span></span></span><span data-slate-object="text" data-key="17304"><span data-slate-leaf="true" data-offset-key="17304:0" data-first-offset="true"><span data-slate-string="true"> 作为计数信号量，这意味着允许同时处于</span></span></span><span data-slate-object="text" data-key="17305"><span data-slate-leaf="true" data-offset-key="17305:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">活动状态</span></span></span></span><span data-slate-object="text" data-key="17306"><span data-slate-leaf="true" data-offset-key="17306:0" data-first-offset="true"><span data-slate-string="true">的最大 Goroutine 数量为 3。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17307"><span data-slate-object="text" data-key="17308"><span data-slate-leaf="true" data-offset-key="17308:0" data-first-offset="true"><span data-slate-string="true">我们运行一下这个示例：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="17309"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17310"><span data-slate-object="text" data-key="17311"><span data-slate-leaf="true" data-offset-key="17311:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:55 handle job: 1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17312"><span data-slate-object="text" data-key="17313"><span data-slate-leaf="true" data-offset-key="17313:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:55 handle job: 4</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17314"><span data-slate-object="text" data-key="17315"><span data-slate-leaf="true" data-offset-key="17315:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:55 handle job: 8</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17316"><span data-slate-object="text" data-key="17317"><span data-slate-leaf="true" data-offset-key="17317:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:57 handle job: 5</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17318"><span data-slate-object="text" data-key="17319"><span data-slate-leaf="true" data-offset-key="17319:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:57 handle job: 7</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17320"><span data-slate-object="text" data-key="17321"><span data-slate-leaf="true" data-offset-key="17321:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:57 handle job: 6</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17322"><span data-slate-object="text" data-key="17323"><span data-slate-leaf="true" data-offset-key="17323:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:59 handle job: 3</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17324"><span data-slate-object="text" data-key="17325"><span data-slate-leaf="true" data-offset-key="17325:0" data-first-offset="true"><span data-slate-string="true">2022/01/02 10:08:59 handle job: 2</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17326"><span data-slate-object="text" data-key="17327"><span data-slate-leaf="true" data-offset-key="17327:0" data-first-offset="true"><span data-slate-string="true">从示例运行结果中的时间戳中，我们可以看到，虽然我们创建了很多 Goroutine，但由于计数信号量的存在，同一时间内处于活动状态（正在处理 job）的 Goroutine 的数量最多为 3 个。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17328" id="sr-toc-12"><span data-slate-object="text" data-key="17329"><span data-slate-leaf="true" data-offset-key="17329:0" data-first-offset="true"><span data-slate-string="true">len (channel) 的应用</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17330"><span data-slate-object="text" data-key="17331"><span data-slate-leaf="true" data-offset-key="17331:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17332"><span data-slate-leaf="true" data-offset-key="17332:0" data-first-offset="true"><span data-slate-string="true"> 是 Go 语言的一个内置函数，它支持接收数组、切片、map、字符串和 channel 类型的参数，并返回对应类型的 “长度”，也就是一个整型值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17333"><span data-slate-object="text" data-key="17334"><span data-slate-leaf="true" data-offset-key="17334:0" data-first-offset="true"><span data-slate-string="true">针对 channel ch 的类型不同，len (ch) 有如下两种语义：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17335"><div data-slate-type="list-line" data-slate-object="block" data-key="17336"><span data-slate-object="text" data-key="17337"><span data-slate-leaf="true" data-offset-key="17337:0" data-first-offset="true"><span data-slate-string="true">当 ch 为无缓冲 channel 时，len (ch) 总是返回 0；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17338"><span data-slate-object="text" data-key="17339"><span data-slate-leaf="true" data-offset-key="17339:0" data-first-offset="true"><span data-slate-string="true">当 ch 为带缓冲 channel 时，len (ch) 返回当前 channel ch 中尚未被读取的元素个数。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17340"><span data-slate-object="text" data-key="17341"><span data-slate-leaf="true" data-offset-key="17341:0" data-first-offset="true"><span data-slate-string="true">这样一来，针对带缓冲 channel 的 len 调用似乎才是有意义的。那我们是否可以使用 len 函数来实现带缓冲 channel 的 “判满”、“判有” 和 “判空” 逻辑呢？就像下面示例中伪代码这样：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17342"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17343"><span data-slate-object="text" data-key="17344"><span data-slate-leaf="true" data-offset-key="17344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17345"><span data-slate-leaf="true" data-offset-key="17345:0" data-first-offset="true"><span data-slate-string="true"> ch </span></span></span><span data-slate-object="text" data-key="17346"><span data-slate-leaf="true" data-offset-key="17346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17347"><span data-slate-leaf="true" data-offset-key="17347:0" data-first-offset="true"><span data-slate-string="true"> T = </span></span></span><span data-slate-object="text" data-key="17348"><span data-slate-leaf="true" data-offset-key="17348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17349"><span data-slate-leaf="true" data-offset-key="17349:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17350"><span data-slate-leaf="true" data-offset-key="17350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17351"><span data-slate-leaf="true" data-offset-key="17351:0" data-first-offset="true"><span data-slate-string="true"> T, capacity)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17352"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17353"><span data-slate-object="text" data-key="17354"><span data-slate-leaf="true" data-offset-key="17354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17355"><span data-slate-object="text" data-key="17356"><span data-slate-leaf="true" data-offset-key="17356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17357"><span data-slate-leaf="true" data-offset-key="17357:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17358"><span data-slate-leaf="true" data-offset-key="17358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17359"><span data-slate-leaf="true" data-offset-key="17359:0" data-first-offset="true"><span data-slate-string="true">(ch) == </span></span></span><span data-slate-object="text" data-key="17360"><span data-slate-leaf="true" data-offset-key="17360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17361"><span data-slate-leaf="true" data-offset-key="17361:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17362"><span data-slate-object="text" data-key="17363"><span data-slate-leaf="true" data-offset-key="17363:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17364"><span data-slate-leaf="true" data-offset-key="17364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 此时 channel ch 空了？</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17365"><span data-slate-object="text" data-key="17366"><span data-slate-leaf="true" data-offset-key="17366:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17367"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17368"><span data-slate-object="text" data-key="17369"><span data-slate-leaf="true" data-offset-key="17369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判有</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17370"><span data-slate-object="text" data-key="17371"><span data-slate-leaf="true" data-offset-key="17371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17372"><span data-slate-leaf="true" data-offset-key="17372:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17373"><span data-slate-leaf="true" data-offset-key="17373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17374"><span data-slate-leaf="true" data-offset-key="17374:0" data-first-offset="true"><span data-slate-string="true">(ch) &gt; </span></span></span><span data-slate-object="text" data-key="17375"><span data-slate-leaf="true" data-offset-key="17375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17376"><span data-slate-leaf="true" data-offset-key="17376:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17377"><span data-slate-object="text" data-key="17378"><span data-slate-leaf="true" data-offset-key="17378:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17379"><span data-slate-leaf="true" data-offset-key="17379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 此时 channel ch 中有数据？</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17380"><span data-slate-object="text" data-key="17381"><span data-slate-leaf="true" data-offset-key="17381:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17382"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17383"><span data-slate-object="text" data-key="17384"><span data-slate-leaf="true" data-offset-key="17384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判满</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17385"><span data-slate-object="text" data-key="17386"><span data-slate-leaf="true" data-offset-key="17386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17387"><span data-slate-leaf="true" data-offset-key="17387:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17388"><span data-slate-leaf="true" data-offset-key="17388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17389"><span data-slate-leaf="true" data-offset-key="17389:0" data-first-offset="true"><span data-slate-string="true">(ch) == </span></span></span><span data-slate-object="text" data-key="17390"><span data-slate-leaf="true" data-offset-key="17390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cap</span></span></span></span><span data-slate-object="text" data-key="17391"><span data-slate-leaf="true" data-offset-key="17391:0" data-first-offset="true"><span data-slate-string="true">(ch) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17392"><span data-slate-object="text" data-key="17393"><span data-slate-leaf="true" data-offset-key="17393:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17394"><span data-slate-leaf="true" data-offset-key="17394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 此时 channel ch 满了？</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17395"><span data-slate-object="text" data-key="17396"><span data-slate-leaf="true" data-offset-key="17396:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17397"><span data-slate-object="text" data-key="17398"><span data-slate-leaf="true" data-offset-key="17398:0" data-first-offset="true"><span data-slate-string="true">你可以看到，我在上面代码注释的 “空了”、“有数据” 和 “满了” 的后面都</span></span></span><span data-slate-object="text" data-key="17399"><span data-slate-leaf="true" data-offset-key="17399:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">打上了问号</span></span></span></span><span data-slate-object="text" data-key="17400"><span data-slate-leaf="true" data-offset-key="17400:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">。</span></span></span></span><span data-slate-object="text" data-key="17401"><span data-slate-leaf="true" data-offset-key="17401:0" data-first-offset="true"><span data-slate-string="true">这是为什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17402"><span data-slate-object="text" data-key="17403"><span data-slate-leaf="true" data-offset-key="17403:0" data-first-offset="true"><span data-slate-string="true">这是因为，channel 原语用于多个 Goroutine 间的通信，一旦多个 Goroutine 共同对 channel 进行收发操作，len (channel) 就会在多个 Goroutine 间形成 “竞态”。单纯地依靠 len (channel) 来判断 channel 中元素状态，是不能保证在后续对 channel 的收发时 channel 状态是不变的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17404"><span data-slate-object="text" data-key="17405"><span data-slate-leaf="true" data-offset-key="17405:0" data-first-offset="true"><span data-slate-string="true">我们以判空为例看看：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17406"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/39/9a/39b77d5624701d2df79ff0b8865d339a.jpg?wh=1920x1047"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17407"><span data-slate-object="text" data-key="17408"><span data-slate-leaf="true" data-offset-key="17408:0" data-first-offset="true"><span data-slate-string="true">从上图可以看到，Goroutine1 使用 len (channel) 判空后，就会尝试从 channel 中接收数据。但在它真正从 channel 读数据之前，另外一个 Goroutine2 已经将数据读了出去，所以，Goroutine1 后面的</span></span></span><span data-slate-object="text" data-key="17409"><span data-slate-leaf="true" data-offset-key="17409:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">读取就会阻塞在 channel 上</span></span></span></span><span data-slate-object="text" data-key="17410"><span data-slate-leaf="true" data-offset-key="17410:0" data-first-offset="true"><span data-slate-string="true">，导致后面逻辑的失效。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17411"><span data-slate-object="text" data-key="17412"><span data-slate-leaf="true" data-offset-key="17412:0" data-first-offset="true"><span data-slate-string="true">因此，</span></span></span><span data-slate-object="text" data-key="17413"><span data-slate-leaf="true" data-offset-key="17413:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为了不阻塞在 channel 上</span></span></span></span><span data-slate-object="text" data-key="17414"><span data-slate-leaf="true" data-offset-key="17414:0" data-first-offset="true"><span data-slate-string="true">，常见的方法是将 “判空与读取” 放在一个 “事务” 中，将 “判满与写入” 放在一个 “事务” 中，而这类 “事务” 我们可以通过 select 实现。我们来看下面示例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17415"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17416"><span data-slate-object="text" data-key="17417"><span data-slate-leaf="true" data-offset-key="17417:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17418"><span data-slate-leaf="true" data-offset-key="17418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17419"><span data-slate-leaf="true" data-offset-key="17419:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">producer</span></span></span></span></span><span data-slate-object="text" data-key="17420"><span data-slate-leaf="true" data-offset-key="17420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c </span></span></span></span></span><span data-slate-object="text" data-key="17421"><span data-slate-leaf="true" data-offset-key="17421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="17422"><span data-slate-leaf="true" data-offset-key="17422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;- </span></span></span></span></span><span data-slate-object="text" data-key="17423"><span data-slate-leaf="true" data-offset-key="17423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17424"><span data-slate-leaf="true" data-offset-key="17424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17425"><span data-slate-leaf="true" data-offset-key="17425:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17426"><span data-slate-object="text" data-key="17427"><span data-slate-leaf="true" data-offset-key="17427:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17428"><span data-slate-leaf="true" data-offset-key="17428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17429"><span data-slate-leaf="true" data-offset-key="17429:0" data-first-offset="true"><span data-slate-string="true"> i </span></span></span><span data-slate-object="text" data-key="17430"><span data-slate-leaf="true" data-offset-key="17430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="17431"><span data-slate-leaf="true" data-offset-key="17431:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="17432"><span data-slate-leaf="true" data-offset-key="17432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17433"><span data-slate-object="text" data-key="17434"><span data-slate-leaf="true" data-offset-key="17434:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17435"><span data-slate-leaf="true" data-offset-key="17435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17436"><span data-slate-leaf="true" data-offset-key="17436:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17437"><span data-slate-object="text" data-key="17438"><span data-slate-leaf="true" data-offset-key="17438:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(</span></span></span><span data-slate-object="text" data-key="17439"><span data-slate-leaf="true" data-offset-key="17439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="17440"><span data-slate-leaf="true" data-offset-key="17440:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17441"><span data-slate-object="text" data-key="17442"><span data-slate-leaf="true" data-offset-key="17442:0" data-first-offset="true"><span data-slate-string="true">        ok := trySend(c, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17443"><span data-slate-object="text" data-key="17444"><span data-slate-leaf="true" data-offset-key="17444:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17445"><span data-slate-leaf="true" data-offset-key="17445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17446"><span data-slate-leaf="true" data-offset-key="17446:0" data-first-offset="true"><span data-slate-string="true"> ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17447"><span data-slate-object="text" data-key="17448"><span data-slate-leaf="true" data-offset-key="17448:0" data-first-offset="true"><span data-slate-string="true">            fmt.Printf(</span></span></span><span data-slate-object="text" data-key="17449"><span data-slate-leaf="true" data-offset-key="17449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[producer]: send [%d] to channel\n"</span></span></span></span><span data-slate-object="text" data-key="17450"><span data-slate-leaf="true" data-offset-key="17450:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17451"><span data-slate-object="text" data-key="17452"><span data-slate-leaf="true" data-offset-key="17452:0" data-first-offset="true"><span data-slate-string="true">            i++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17453"><span data-slate-object="text" data-key="17454"><span data-slate-leaf="true" data-offset-key="17454:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17455"><span data-slate-leaf="true" data-offset-key="17455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17456"><span data-slate-object="text" data-key="17457"><span data-slate-leaf="true" data-offset-key="17457:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17458"><span data-slate-object="text" data-key="17459"><span data-slate-leaf="true" data-offset-key="17459:0" data-first-offset="true"><span data-slate-string="true">        fmt.Printf(</span></span></span><span data-slate-object="text" data-key="17460"><span data-slate-leaf="true" data-offset-key="17460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[producer]: try send [%d], but channel is full\n"</span></span></span></span><span data-slate-object="text" data-key="17461"><span data-slate-leaf="true" data-offset-key="17461:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17462"><span data-slate-object="text" data-key="17463"><span data-slate-leaf="true" data-offset-key="17463:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17464"><span data-slate-object="text" data-key="17465"><span data-slate-leaf="true" data-offset-key="17465:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17466"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17467"><span data-slate-object="text" data-key="17468"><span data-slate-leaf="true" data-offset-key="17468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17469"><span data-slate-leaf="true" data-offset-key="17469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17470"><span data-slate-leaf="true" data-offset-key="17470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">tryRecv</span></span></span></span></span><span data-slate-object="text" data-key="17471"><span data-slate-leaf="true" data-offset-key="17471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c &lt;-</span></span></span></span></span><span data-slate-object="text" data-key="17472"><span data-slate-leaf="true" data-offset-key="17472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="17473"><span data-slate-leaf="true" data-offset-key="17473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="17474"><span data-slate-leaf="true" data-offset-key="17474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17475"><span data-slate-leaf="true" data-offset-key="17475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17476"><span data-slate-leaf="true" data-offset-key="17476:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="17477"><span data-slate-leaf="true" data-offset-key="17477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="17478"><span data-slate-leaf="true" data-offset-key="17478:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17479"><span data-slate-leaf="true" data-offset-key="17479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="17480"><span data-slate-leaf="true" data-offset-key="17480:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17481"><span data-slate-object="text" data-key="17482"><span data-slate-leaf="true" data-offset-key="17482:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17483"><span data-slate-leaf="true" data-offset-key="17483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="17484"><span data-slate-leaf="true" data-offset-key="17484:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17485"><span data-slate-object="text" data-key="17486"><span data-slate-leaf="true" data-offset-key="17486:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17487"><span data-slate-leaf="true" data-offset-key="17487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17488"><span data-slate-leaf="true" data-offset-key="17488:0" data-first-offset="true"><span data-slate-string="true"> i := &lt;-c:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17489"><span data-slate-object="text" data-key="17490"><span data-slate-leaf="true" data-offset-key="17490:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17491"><span data-slate-leaf="true" data-offset-key="17491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17492"><span data-slate-leaf="true" data-offset-key="17492:0" data-first-offset="true"><span data-slate-string="true"> i, </span></span></span><span data-slate-object="text" data-key="17493"><span data-slate-leaf="true" data-offset-key="17493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17494"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17495"><span data-slate-object="text" data-key="17496"><span data-slate-leaf="true" data-offset-key="17496:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17497"><span data-slate-leaf="true" data-offset-key="17497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="17498"><span data-slate-leaf="true" data-offset-key="17498:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17499"><span data-slate-object="text" data-key="17500"><span data-slate-leaf="true" data-offset-key="17500:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17501"><span data-slate-leaf="true" data-offset-key="17501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17502"><span data-slate-leaf="true" data-offset-key="17502:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17503"><span data-slate-leaf="true" data-offset-key="17503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17504"><span data-slate-leaf="true" data-offset-key="17504:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17505"><span data-slate-leaf="true" data-offset-key="17505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17506"><span data-slate-object="text" data-key="17507"><span data-slate-leaf="true" data-offset-key="17507:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17508"><span data-slate-object="text" data-key="17509"><span data-slate-leaf="true" data-offset-key="17509:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17510"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17511"><span data-slate-object="text" data-key="17512"><span data-slate-leaf="true" data-offset-key="17512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17513"><span data-slate-leaf="true" data-offset-key="17513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17514"><span data-slate-leaf="true" data-offset-key="17514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">trySend</span></span></span></span></span><span data-slate-object="text" data-key="17515"><span data-slate-leaf="true" data-offset-key="17515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c </span></span></span></span></span><span data-slate-object="text" data-key="17516"><span data-slate-leaf="true" data-offset-key="17516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="17517"><span data-slate-leaf="true" data-offset-key="17517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;- </span></span></span></span></span><span data-slate-object="text" data-key="17518"><span data-slate-leaf="true" data-offset-key="17518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17519"><span data-slate-leaf="true" data-offset-key="17519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, i </span></span></span></span></span><span data-slate-object="text" data-key="17520"><span data-slate-leaf="true" data-offset-key="17520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17521"><span data-slate-leaf="true" data-offset-key="17521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17522"><span data-slate-leaf="true" data-offset-key="17522:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17523"><span data-slate-leaf="true" data-offset-key="17523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="17524"><span data-slate-leaf="true" data-offset-key="17524:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17525"><span data-slate-object="text" data-key="17526"><span data-slate-leaf="true" data-offset-key="17526:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17527"><span data-slate-leaf="true" data-offset-key="17527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="17528"><span data-slate-leaf="true" data-offset-key="17528:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17529"><span data-slate-object="text" data-key="17530"><span data-slate-leaf="true" data-offset-key="17530:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17531"><span data-slate-leaf="true" data-offset-key="17531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17532"><span data-slate-leaf="true" data-offset-key="17532:0" data-first-offset="true"><span data-slate-string="true"> c &lt;- i:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17533"><span data-slate-object="text" data-key="17534"><span data-slate-leaf="true" data-offset-key="17534:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17535"><span data-slate-leaf="true" data-offset-key="17535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17536"><span data-slate-leaf="true" data-offset-key="17536:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17537"><span data-slate-leaf="true" data-offset-key="17537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17538"><span data-slate-object="text" data-key="17539"><span data-slate-leaf="true" data-offset-key="17539:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17540"><span data-slate-leaf="true" data-offset-key="17540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="17541"><span data-slate-leaf="true" data-offset-key="17541:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17542"><span data-slate-object="text" data-key="17543"><span data-slate-leaf="true" data-offset-key="17543:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17544"><span data-slate-leaf="true" data-offset-key="17544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17545"><span data-slate-leaf="true" data-offset-key="17545:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17546"><span data-slate-leaf="true" data-offset-key="17546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17547"><span data-slate-object="text" data-key="17548"><span data-slate-leaf="true" data-offset-key="17548:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17549"><span data-slate-object="text" data-key="17550"><span data-slate-leaf="true" data-offset-key="17550:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17551"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17552"><span data-slate-object="text" data-key="17553"><span data-slate-leaf="true" data-offset-key="17553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17554"><span data-slate-leaf="true" data-offset-key="17554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17555"><span data-slate-leaf="true" data-offset-key="17555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">consumer</span></span></span></span></span><span data-slate-object="text" data-key="17556"><span data-slate-leaf="true" data-offset-key="17556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c &lt;-</span></span></span></span></span><span data-slate-object="text" data-key="17557"><span data-slate-leaf="true" data-offset-key="17557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="17558"><span data-slate-leaf="true" data-offset-key="17558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="17559"><span data-slate-leaf="true" data-offset-key="17559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="17560"><span data-slate-leaf="true" data-offset-key="17560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17561"><span data-slate-leaf="true" data-offset-key="17561:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17562"><span data-slate-object="text" data-key="17563"><span data-slate-leaf="true" data-offset-key="17563:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17564"><span data-slate-leaf="true" data-offset-key="17564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17565"><span data-slate-leaf="true" data-offset-key="17565:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17566"><span data-slate-object="text" data-key="17567"><span data-slate-leaf="true" data-offset-key="17567:0" data-first-offset="true"><span data-slate-string="true">        i, ok := tryRecv(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17568"><span data-slate-object="text" data-key="17569"><span data-slate-leaf="true" data-offset-key="17569:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17570"><span data-slate-leaf="true" data-offset-key="17570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17571"><span data-slate-leaf="true" data-offset-key="17571:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17572"><span data-slate-object="text" data-key="17573"><span data-slate-leaf="true" data-offset-key="17573:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(</span></span></span><span data-slate-object="text" data-key="17574"><span data-slate-leaf="true" data-offset-key="17574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[consumer]: try to recv from channel, but the channel is empty"</span></span></span></span><span data-slate-object="text" data-key="17575"><span data-slate-leaf="true" data-offset-key="17575:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17576"><span data-slate-object="text" data-key="17577"><span data-slate-leaf="true" data-offset-key="17577:0" data-first-offset="true"><span data-slate-string="true">            time.Sleep(</span></span></span><span data-slate-object="text" data-key="17578"><span data-slate-leaf="true" data-offset-key="17578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17579"><span data-slate-leaf="true" data-offset-key="17579:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17580"><span data-slate-object="text" data-key="17581"><span data-slate-leaf="true" data-offset-key="17581:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17582"><span data-slate-leaf="true" data-offset-key="17582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17583"><span data-slate-object="text" data-key="17584"><span data-slate-leaf="true" data-offset-key="17584:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17585"><span data-slate-object="text" data-key="17586"><span data-slate-leaf="true" data-offset-key="17586:0" data-first-offset="true"><span data-slate-string="true">        fmt.Printf(</span></span></span><span data-slate-object="text" data-key="17587"><span data-slate-leaf="true" data-offset-key="17587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[consumer]: recv [%d] from channel\n"</span></span></span></span><span data-slate-object="text" data-key="17588"><span data-slate-leaf="true" data-offset-key="17588:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17589"><span data-slate-object="text" data-key="17590"><span data-slate-leaf="true" data-offset-key="17590:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17591"><span data-slate-leaf="true" data-offset-key="17591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17592"><span data-slate-leaf="true" data-offset-key="17592:0" data-first-offset="true"><span data-slate-string="true"> i &gt;= </span></span></span><span data-slate-object="text" data-key="17593"><span data-slate-leaf="true" data-offset-key="17593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="17594"><span data-slate-leaf="true" data-offset-key="17594:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17595"><span data-slate-object="text" data-key="17596"><span data-slate-leaf="true" data-offset-key="17596:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(</span></span></span><span data-slate-object="text" data-key="17597"><span data-slate-leaf="true" data-offset-key="17597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[consumer]: exit"</span></span></span></span><span data-slate-object="text" data-key="17598"><span data-slate-leaf="true" data-offset-key="17598:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17599"><span data-slate-object="text" data-key="17600"><span data-slate-leaf="true" data-offset-key="17600:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17601"><span data-slate-leaf="true" data-offset-key="17601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17602"><span data-slate-object="text" data-key="17603"><span data-slate-leaf="true" data-offset-key="17603:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17604"><span data-slate-object="text" data-key="17605"><span data-slate-leaf="true" data-offset-key="17605:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17606"><span data-slate-object="text" data-key="17607"><span data-slate-leaf="true" data-offset-key="17607:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17608"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17609"><span data-slate-object="text" data-key="17610"><span data-slate-leaf="true" data-offset-key="17610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17611"><span data-slate-leaf="true" data-offset-key="17611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17612"><span data-slate-leaf="true" data-offset-key="17612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="17613"><span data-slate-leaf="true" data-offset-key="17613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17614"><span data-slate-leaf="true" data-offset-key="17614:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17615"><span data-slate-object="text" data-key="17616"><span data-slate-leaf="true" data-offset-key="17616:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17617"><span data-slate-leaf="true" data-offset-key="17617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17618"><span data-slate-leaf="true" data-offset-key="17618:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17619"><span data-slate-object="text" data-key="17620"><span data-slate-leaf="true" data-offset-key="17620:0" data-first-offset="true"><span data-slate-string="true">    c := </span></span></span><span data-slate-object="text" data-key="17621"><span data-slate-leaf="true" data-offset-key="17621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17622"><span data-slate-leaf="true" data-offset-key="17622:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17623"><span data-slate-leaf="true" data-offset-key="17623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17624"><span data-slate-leaf="true" data-offset-key="17624:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17625"><span data-slate-leaf="true" data-offset-key="17625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="17626"><span data-slate-leaf="true" data-offset-key="17626:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17627"><span data-slate-leaf="true" data-offset-key="17627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="17628"><span data-slate-leaf="true" data-offset-key="17628:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17629"><span data-slate-object="text" data-key="17630"><span data-slate-leaf="true" data-offset-key="17630:0" data-first-offset="true"><span data-slate-string="true">    wg.Add(</span></span></span><span data-slate-object="text" data-key="17631"><span data-slate-leaf="true" data-offset-key="17631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="17632"><span data-slate-leaf="true" data-offset-key="17632:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17633"><span data-slate-object="text" data-key="17634"><span data-slate-leaf="true" data-offset-key="17634:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17635"><span data-slate-leaf="true" data-offset-key="17635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17636"><span data-slate-leaf="true" data-offset-key="17636:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17637"><span data-slate-leaf="true" data-offset-key="17637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17638"><span data-slate-leaf="true" data-offset-key="17638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17639"><span data-slate-leaf="true" data-offset-key="17639:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17640"><span data-slate-object="text" data-key="17641"><span data-slate-leaf="true" data-offset-key="17641:0" data-first-offset="true"><span data-slate-string="true">        producer(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17642"><span data-slate-object="text" data-key="17643"><span data-slate-leaf="true" data-offset-key="17643:0" data-first-offset="true"><span data-slate-string="true">        wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17644"><span data-slate-object="text" data-key="17645"><span data-slate-leaf="true" data-offset-key="17645:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17646"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17647"><span data-slate-object="text" data-key="17648"><span data-slate-leaf="true" data-offset-key="17648:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17649"><span data-slate-leaf="true" data-offset-key="17649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17650"><span data-slate-leaf="true" data-offset-key="17650:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17651"><span data-slate-leaf="true" data-offset-key="17651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17652"><span data-slate-leaf="true" data-offset-key="17652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17653"><span data-slate-leaf="true" data-offset-key="17653:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17654"><span data-slate-object="text" data-key="17655"><span data-slate-leaf="true" data-offset-key="17655:0" data-first-offset="true"><span data-slate-string="true">        consumer(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17656"><span data-slate-object="text" data-key="17657"><span data-slate-leaf="true" data-offset-key="17657:0" data-first-offset="true"><span data-slate-string="true">        wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17658"><span data-slate-object="text" data-key="17659"><span data-slate-leaf="true" data-offset-key="17659:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17660"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17661"><span data-slate-object="text" data-key="17662"><span data-slate-leaf="true" data-offset-key="17662:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17663"><span data-slate-object="text" data-key="17664"><span data-slate-leaf="true" data-offset-key="17664:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17665"><span data-slate-object="text" data-key="17666"><span data-slate-leaf="true" data-offset-key="17666:0" data-first-offset="true"><span data-slate-string="true">我们看到，由于用到了 select 原语的 default 分支语义，当 channel 空的时候，tryRecv 不会阻塞；当 channel 满的时候，trySend 也不会阻塞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17667"><span data-slate-object="text" data-key="17668"><span data-slate-leaf="true" data-offset-key="17668:0" data-first-offset="true"><span data-slate-string="true">这个示例的运行结果也证明了这一点，无论是使用 tryRecv 的 consumer 还是使用 trySend 的 producer 都不会阻塞：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="17669"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17670"><span data-slate-object="text" data-key="17671"><span data-slate-leaf="true" data-offset-key="17671:0" data-first-offset="true"><span data-slate-string="true">[consumer]: </span></span></span><span data-slate-object="text" data-key="17672"><span data-slate-leaf="true" data-offset-key="17672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17673"><span data-slate-leaf="true" data-offset-key="17673:0" data-first-offset="true"><span data-slate-string="true"> to recv </span></span></span><span data-slate-object="text" data-key="17674"><span data-slate-leaf="true" data-offset-key="17674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17675"><span data-slate-leaf="true" data-offset-key="17675:0" data-first-offset="true"><span data-slate-string="true"> channel, but the channel </span></span></span><span data-slate-object="text" data-key="17676"><span data-slate-leaf="true" data-offset-key="17676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17677"><span data-slate-leaf="true" data-offset-key="17677:0" data-first-offset="true"><span data-slate-string="true"> empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17678"><span data-slate-object="text" data-key="17679"><span data-slate-leaf="true" data-offset-key="17679:0" data-first-offset="true"><span data-slate-string="true">[consumer]: </span></span></span><span data-slate-object="text" data-key="17680"><span data-slate-leaf="true" data-offset-key="17680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17681"><span data-slate-leaf="true" data-offset-key="17681:0" data-first-offset="true"><span data-slate-string="true"> to recv </span></span></span><span data-slate-object="text" data-key="17682"><span data-slate-leaf="true" data-offset-key="17682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17683"><span data-slate-leaf="true" data-offset-key="17683:0" data-first-offset="true"><span data-slate-string="true"> channel, but the channel </span></span></span><span data-slate-object="text" data-key="17684"><span data-slate-leaf="true" data-offset-key="17684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17685"><span data-slate-leaf="true" data-offset-key="17685:0" data-first-offset="true"><span data-slate-string="true"> empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17686"><span data-slate-object="text" data-key="17687"><span data-slate-leaf="true" data-offset-key="17687:0" data-first-offset="true"><span data-slate-string="true">[producer]: send [</span></span></span><span data-slate-object="text" data-key="17688"><span data-slate-leaf="true" data-offset-key="17688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17689"><span data-slate-leaf="true" data-offset-key="17689:0" data-first-offset="true"><span data-slate-string="true">] to channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17690"><span data-slate-object="text" data-key="17691"><span data-slate-leaf="true" data-offset-key="17691:0" data-first-offset="true"><span data-slate-string="true">[consumer]: recv [</span></span></span><span data-slate-object="text" data-key="17692"><span data-slate-leaf="true" data-offset-key="17692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17693"><span data-slate-leaf="true" data-offset-key="17693:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="17694"><span data-slate-leaf="true" data-offset-key="17694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17695"><span data-slate-leaf="true" data-offset-key="17695:0" data-first-offset="true"><span data-slate-string="true"> channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17696"><span data-slate-object="text" data-key="17697"><span data-slate-leaf="true" data-offset-key="17697:0" data-first-offset="true"><span data-slate-string="true">[consumer]: </span></span></span><span data-slate-object="text" data-key="17698"><span data-slate-leaf="true" data-offset-key="17698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17699"><span data-slate-leaf="true" data-offset-key="17699:0" data-first-offset="true"><span data-slate-string="true"> to recv </span></span></span><span data-slate-object="text" data-key="17700"><span data-slate-leaf="true" data-offset-key="17700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17701"><span data-slate-leaf="true" data-offset-key="17701:0" data-first-offset="true"><span data-slate-string="true"> channel, but the channel </span></span></span><span data-slate-object="text" data-key="17702"><span data-slate-leaf="true" data-offset-key="17702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17703"><span data-slate-leaf="true" data-offset-key="17703:0" data-first-offset="true"><span data-slate-string="true"> empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17704"><span data-slate-object="text" data-key="17705"><span data-slate-leaf="true" data-offset-key="17705:0" data-first-offset="true"><span data-slate-string="true">[consumer]: </span></span></span><span data-slate-object="text" data-key="17706"><span data-slate-leaf="true" data-offset-key="17706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17707"><span data-slate-leaf="true" data-offset-key="17707:0" data-first-offset="true"><span data-slate-string="true"> to recv </span></span></span><span data-slate-object="text" data-key="17708"><span data-slate-leaf="true" data-offset-key="17708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17709"><span data-slate-leaf="true" data-offset-key="17709:0" data-first-offset="true"><span data-slate-string="true"> channel, but the channel </span></span></span><span data-slate-object="text" data-key="17710"><span data-slate-leaf="true" data-offset-key="17710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17711"><span data-slate-leaf="true" data-offset-key="17711:0" data-first-offset="true"><span data-slate-string="true"> empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17712"><span data-slate-object="text" data-key="17713"><span data-slate-leaf="true" data-offset-key="17713:0" data-first-offset="true"><span data-slate-string="true">[producer]: send [</span></span></span><span data-slate-object="text" data-key="17714"><span data-slate-leaf="true" data-offset-key="17714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="17715"><span data-slate-leaf="true" data-offset-key="17715:0" data-first-offset="true"><span data-slate-string="true">] to channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17716"><span data-slate-object="text" data-key="17717"><span data-slate-leaf="true" data-offset-key="17717:0" data-first-offset="true"><span data-slate-string="true">[consumer]: recv [</span></span></span><span data-slate-object="text" data-key="17718"><span data-slate-leaf="true" data-offset-key="17718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="17719"><span data-slate-leaf="true" data-offset-key="17719:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="17720"><span data-slate-leaf="true" data-offset-key="17720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17721"><span data-slate-leaf="true" data-offset-key="17721:0" data-first-offset="true"><span data-slate-string="true"> channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17722"><span data-slate-object="text" data-key="17723"><span data-slate-leaf="true" data-offset-key="17723:0" data-first-offset="true"><span data-slate-string="true">[consumer]: </span></span></span><span data-slate-object="text" data-key="17724"><span data-slate-leaf="true" data-offset-key="17724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17725"><span data-slate-leaf="true" data-offset-key="17725:0" data-first-offset="true"><span data-slate-string="true"> to recv </span></span></span><span data-slate-object="text" data-key="17726"><span data-slate-leaf="true" data-offset-key="17726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17727"><span data-slate-leaf="true" data-offset-key="17727:0" data-first-offset="true"><span data-slate-string="true"> channel, but the channel </span></span></span><span data-slate-object="text" data-key="17728"><span data-slate-leaf="true" data-offset-key="17728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17729"><span data-slate-leaf="true" data-offset-key="17729:0" data-first-offset="true"><span data-slate-string="true"> empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17730"><span data-slate-object="text" data-key="17731"><span data-slate-leaf="true" data-offset-key="17731:0" data-first-offset="true"><span data-slate-string="true">[consumer]: </span></span></span><span data-slate-object="text" data-key="17732"><span data-slate-leaf="true" data-offset-key="17732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17733"><span data-slate-leaf="true" data-offset-key="17733:0" data-first-offset="true"><span data-slate-string="true"> to recv </span></span></span><span data-slate-object="text" data-key="17734"><span data-slate-leaf="true" data-offset-key="17734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17735"><span data-slate-leaf="true" data-offset-key="17735:0" data-first-offset="true"><span data-slate-string="true"> channel, but the channel </span></span></span><span data-slate-object="text" data-key="17736"><span data-slate-leaf="true" data-offset-key="17736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17737"><span data-slate-leaf="true" data-offset-key="17737:0" data-first-offset="true"><span data-slate-string="true"> empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17738"><span data-slate-object="text" data-key="17739"><span data-slate-leaf="true" data-offset-key="17739:0" data-first-offset="true"><span data-slate-string="true">[producer]: send [</span></span></span><span data-slate-object="text" data-key="17740"><span data-slate-leaf="true" data-offset-key="17740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="17741"><span data-slate-leaf="true" data-offset-key="17741:0" data-first-offset="true"><span data-slate-string="true">] to channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17742"><span data-slate-object="text" data-key="17743"><span data-slate-leaf="true" data-offset-key="17743:0" data-first-offset="true"><span data-slate-string="true">[consumer]: recv [</span></span></span><span data-slate-object="text" data-key="17744"><span data-slate-leaf="true" data-offset-key="17744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="17745"><span data-slate-leaf="true" data-offset-key="17745:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="17746"><span data-slate-leaf="true" data-offset-key="17746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="17747"><span data-slate-leaf="true" data-offset-key="17747:0" data-first-offset="true"><span data-slate-string="true"> channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17748"><span data-slate-object="text" data-key="17749"><span data-slate-leaf="true" data-offset-key="17749:0" data-first-offset="true"><span data-slate-string="true">[consumer]: exit</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17750"><span data-slate-object="text" data-key="17751"><span data-slate-leaf="true" data-offset-key="17751:0" data-first-offset="true"><span data-slate-string="true">[producer]: send [</span></span></span><span data-slate-object="text" data-key="17752"><span data-slate-leaf="true" data-offset-key="17752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="17753"><span data-slate-leaf="true" data-offset-key="17753:0" data-first-offset="true"><span data-slate-string="true">] to channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17754"><span data-slate-object="text" data-key="17755"><span data-slate-leaf="true" data-offset-key="17755:0" data-first-offset="true"><span data-slate-string="true">[producer]: send [</span></span></span><span data-slate-object="text" data-key="17756"><span data-slate-leaf="true" data-offset-key="17756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="17757"><span data-slate-leaf="true" data-offset-key="17757:0" data-first-offset="true"><span data-slate-string="true">] to channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17758"><span data-slate-object="text" data-key="17759"><span data-slate-leaf="true" data-offset-key="17759:0" data-first-offset="true"><span data-slate-string="true">[producer]: send [</span></span></span><span data-slate-object="text" data-key="17760"><span data-slate-leaf="true" data-offset-key="17760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span><span data-slate-object="text" data-key="17761"><span data-slate-leaf="true" data-offset-key="17761:0" data-first-offset="true"><span data-slate-string="true">] to channel</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17762"><span data-slate-object="text" data-key="17763"><span data-slate-leaf="true" data-offset-key="17763:0" data-first-offset="true"><span data-slate-string="true">[producer]: </span></span></span><span data-slate-object="text" data-key="17764"><span data-slate-leaf="true" data-offset-key="17764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17765"><span data-slate-leaf="true" data-offset-key="17765:0" data-first-offset="true"><span data-slate-string="true"> send [</span></span></span><span data-slate-object="text" data-key="17766"><span data-slate-leaf="true" data-offset-key="17766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="17767"><span data-slate-leaf="true" data-offset-key="17767:0" data-first-offset="true"><span data-slate-string="true">], but channel </span></span></span><span data-slate-object="text" data-key="17768"><span data-slate-leaf="true" data-offset-key="17768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17769"><span data-slate-leaf="true" data-offset-key="17769:0" data-first-offset="true"><span data-slate-string="true"> full</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17770"><span data-slate-object="text" data-key="17771"><span data-slate-leaf="true" data-offset-key="17771:0" data-first-offset="true"><span data-slate-string="true">[producer]: </span></span></span><span data-slate-object="text" data-key="17772"><span data-slate-leaf="true" data-offset-key="17772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17773"><span data-slate-leaf="true" data-offset-key="17773:0" data-first-offset="true"><span data-slate-string="true"> send [</span></span></span><span data-slate-object="text" data-key="17774"><span data-slate-leaf="true" data-offset-key="17774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="17775"><span data-slate-leaf="true" data-offset-key="17775:0" data-first-offset="true"><span data-slate-string="true">], but channel </span></span></span><span data-slate-object="text" data-key="17776"><span data-slate-leaf="true" data-offset-key="17776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17777"><span data-slate-leaf="true" data-offset-key="17777:0" data-first-offset="true"><span data-slate-string="true"> full</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17778"><span data-slate-object="text" data-key="17779"><span data-slate-leaf="true" data-offset-key="17779:0" data-first-offset="true"><span data-slate-string="true">[producer]: </span></span></span><span data-slate-object="text" data-key="17780"><span data-slate-leaf="true" data-offset-key="17780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="17781"><span data-slate-leaf="true" data-offset-key="17781:0" data-first-offset="true"><span data-slate-string="true"> send [</span></span></span><span data-slate-object="text" data-key="17782"><span data-slate-leaf="true" data-offset-key="17782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="17783"><span data-slate-leaf="true" data-offset-key="17783:0" data-first-offset="true"><span data-slate-string="true">], but channel </span></span></span><span data-slate-object="text" data-key="17784"><span data-slate-leaf="true" data-offset-key="17784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="17785"><span data-slate-leaf="true" data-offset-key="17785:0" data-first-offset="true"><span data-slate-string="true"> full</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17786"><span data-slate-object="text" data-key="17787"><span data-slate-leaf="true" data-offset-key="17787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">... </span></span></span></span><span data-slate-object="text" data-key="17788"><span data-slate-leaf="true" data-offset-key="17788:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17789"><span data-slate-object="text" data-key="17790"><span data-slate-leaf="true" data-offset-key="17790:0" data-first-offset="true"><span data-slate-string="true">这种方法适用于大多数场合，但是这种方法有一个 “问题”，那就是它改变了 channel 的状态，会让 channel 接收了一个元素或发送一个元素到 channel。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17791"><span data-slate-object="text" data-key="17792"><span data-slate-leaf="true" data-offset-key="17792:0" data-first-offset="true"><span data-slate-string="true">有些时候我们不想这么做，我们想在不改变 channel 状态的前提下，单纯地侦测 channel 的状态，而又不会因 channel 满或空阻塞在 channel 上。但很遗憾，目前没有一种方法可以在实现这样的功能的同时，适用于所有场合。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17793"><span data-slate-object="text" data-key="17794"><span data-slate-leaf="true" data-offset-key="17794:0" data-first-offset="true"><span data-slate-string="true">但是在特定的场景下，我们可以用 len (channel) 来实现。比如下面这两种场景：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17795"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/b3/37/b31d081fcced758b8f99c938a0b75237.jpg?wh=1920x1047"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17796"><span data-slate-object="text" data-key="17797"><span data-slate-leaf="true" data-offset-key="17797:0" data-first-offset="true"><span data-slate-string="true">上图中的情景 (a) 是一个 “多发送单接收” 的场景，也就是有多个发送者，但</span></span></span><span data-slate-object="text" data-key="17798"><span data-slate-leaf="true" data-offset-key="17798:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">有且只有一个接收者</span></span></span></span><span data-slate-object="text" data-key="17799"><span data-slate-leaf="true" data-offset-key="17799:0" data-first-offset="true"><span data-slate-string="true">。在这样的场景下，我们可以在接收 goroutine 中使用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17800"><span data-slate-object="text" data-key="17801"><span data-slate-leaf="true" data-offset-key="17801:0" data-first-offset="true"><span data-slate-string="true"> len (channel) 是否大于 0</span></span></span></span><span data-slate-object="text" data-key="17802"><span data-slate-leaf="true" data-offset-key="17802:0" data-first-offset="true"><span data-slate-string="true"> 来判断是否 channel 中有数据需要接收。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17803"><span data-slate-object="text" data-key="17804"><span data-slate-leaf="true" data-offset-key="17804:0" data-first-offset="true"><span data-slate-string="true">而情景 (b) 呢，是一个 “多接收单发送” 的场景，也就是有多个接收者，但</span></span></span><span data-slate-object="text" data-key="17805"><span data-slate-leaf="true" data-offset-key="17805:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">有且只有一个发送者</span></span></span></span><span data-slate-object="text" data-key="17806"><span data-slate-leaf="true" data-offset-key="17806:0" data-first-offset="true"><span data-slate-string="true">。在这样的场景下，我们可以在发送 Goroutine 中使用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17807"><span data-slate-object="text" data-key="17808"><span data-slate-leaf="true" data-offset-key="17808:0" data-first-offset="true"><span data-slate-string="true"> len (channel) 是否小于 cap (channel)</span></span></span></span><span data-slate-object="text" data-key="17809"><span data-slate-leaf="true" data-offset-key="17809:0" data-first-offset="true"><span data-slate-string="true"> 来判断是否可以执行向 channel 的发送操作。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17810" id="sr-toc-13"><span data-slate-object="text" data-key="17811"><span data-slate-leaf="true" data-offset-key="17811:0" data-first-offset="true"><span data-slate-string="true">nil channel 的妙用</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17812"><span data-slate-object="text" data-key="17813"><span data-slate-leaf="true" data-offset-key="17813:0" data-first-offset="true"><span data-slate-string="true">如果一个 channel 类型变量的值为 nil，我们称它为 </span></span></span><span data-slate-object="text" data-key="17814"><span data-slate-leaf="true" data-offset-key="17814:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">nil channel</span></span></span></span><span data-slate-object="text" data-key="17815"><span data-slate-leaf="true" data-offset-key="17815:0" data-first-offset="true"><span data-slate-string="true">。nil channel 有一个特性，那就是对 nil channel 的读写都会发生阻塞。比如下面示例代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17816"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17817"><span data-slate-object="text" data-key="17818"><span data-slate-leaf="true" data-offset-key="17818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17819"><span data-slate-leaf="true" data-offset-key="17819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17820"><span data-slate-leaf="true" data-offset-key="17820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="17821"><span data-slate-leaf="true" data-offset-key="17821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17822"><span data-slate-leaf="true" data-offset-key="17822:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17823"><span data-slate-object="text" data-key="17824"><span data-slate-leaf="true" data-offset-key="17824:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17825"><span data-slate-leaf="true" data-offset-key="17825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17826"><span data-slate-leaf="true" data-offset-key="17826:0" data-first-offset="true"><span data-slate-string="true"> c </span></span></span><span data-slate-object="text" data-key="17827"><span data-slate-leaf="true" data-offset-key="17827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17828"><span data-slate-leaf="true" data-offset-key="17828:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17829"><span data-slate-leaf="true" data-offset-key="17829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17830"><span data-slate-object="text" data-key="17831"><span data-slate-leaf="true" data-offset-key="17831:0" data-first-offset="true"><span data-slate-string="true">  &lt;-c </span></span></span><span data-slate-object="text" data-key="17832"><span data-slate-leaf="true" data-offset-key="17832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 阻塞</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17833"><span data-slate-object="text" data-key="17834"><span data-slate-leaf="true" data-offset-key="17834:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17835"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17836"><span data-slate-object="text" data-key="17837"><span data-slate-leaf="true" data-offset-key="17837:0" data-first-offset="true"><span data-slate-string="true">或者：</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17838"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17839"><span data-slate-object="text" data-key="17840"><span data-slate-leaf="true" data-offset-key="17840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17841"><span data-slate-leaf="true" data-offset-key="17841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17842"><span data-slate-leaf="true" data-offset-key="17842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="17843"><span data-slate-leaf="true" data-offset-key="17843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17844"><span data-slate-leaf="true" data-offset-key="17844:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17845"><span data-slate-object="text" data-key="17846"><span data-slate-leaf="true" data-offset-key="17846:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17847"><span data-slate-leaf="true" data-offset-key="17847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17848"><span data-slate-leaf="true" data-offset-key="17848:0" data-first-offset="true"><span data-slate-string="true"> c </span></span></span><span data-slate-object="text" data-key="17849"><span data-slate-leaf="true" data-offset-key="17849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17850"><span data-slate-leaf="true" data-offset-key="17850:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17851"><span data-slate-leaf="true" data-offset-key="17851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17852"><span data-slate-object="text" data-key="17853"><span data-slate-leaf="true" data-offset-key="17853:0" data-first-offset="true"><span data-slate-string="true">  c&lt;</span></span></span><span data-slate-object="text" data-key="17854"><span data-slate-leaf="true" data-offset-key="17854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="17855"><span data-slate-leaf="true" data-offset-key="17855:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17856"><span data-slate-leaf="true" data-offset-key="17856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 阻塞</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17857"><span data-slate-object="text" data-key="17858"><span data-slate-leaf="true" data-offset-key="17858:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17859"><span data-slate-object="text" data-key="17860"><span data-slate-leaf="true" data-offset-key="17860:0" data-first-offset="true"><span data-slate-string="true">你会看到，无论上面的哪段代码被执行，main goroutine 都会阻塞在对 nil channel 的操作上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17861"><span data-slate-object="text" data-key="17862"><span data-slate-leaf="true" data-offset-key="17862:0" data-first-offset="true"><span data-slate-string="true">不过，nil channel 的这个特性可不是一无是处，有些时候应用 nil channel 的这个特性可以得到事半功倍的效果。我们来看一个例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17863"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17864"><span data-slate-object="text" data-key="17865"><span data-slate-leaf="true" data-offset-key="17865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17866"><span data-slate-leaf="true" data-offset-key="17866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17867"><span data-slate-leaf="true" data-offset-key="17867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="17868"><span data-slate-leaf="true" data-offset-key="17868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17869"><span data-slate-leaf="true" data-offset-key="17869:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17870"><span data-slate-object="text" data-key="17871"><span data-slate-leaf="true" data-offset-key="17871:0" data-first-offset="true"><span data-slate-string="true">    ch1, ch2 := </span></span></span><span data-slate-object="text" data-key="17872"><span data-slate-leaf="true" data-offset-key="17872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17873"><span data-slate-leaf="true" data-offset-key="17873:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17874"><span data-slate-leaf="true" data-offset-key="17874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17875"><span data-slate-leaf="true" data-offset-key="17875:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17876"><span data-slate-leaf="true" data-offset-key="17876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="17877"><span data-slate-leaf="true" data-offset-key="17877:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="17878"><span data-slate-leaf="true" data-offset-key="17878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17879"><span data-slate-leaf="true" data-offset-key="17879:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17880"><span data-slate-leaf="true" data-offset-key="17880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17881"><span data-slate-leaf="true" data-offset-key="17881:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17882"><span data-slate-leaf="true" data-offset-key="17882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="17883"><span data-slate-leaf="true" data-offset-key="17883:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17884"><span data-slate-object="text" data-key="17885"><span data-slate-leaf="true" data-offset-key="17885:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17886"><span data-slate-leaf="true" data-offset-key="17886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17887"><span data-slate-leaf="true" data-offset-key="17887:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17888"><span data-slate-leaf="true" data-offset-key="17888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17889"><span data-slate-leaf="true" data-offset-key="17889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17890"><span data-slate-leaf="true" data-offset-key="17890:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17891"><span data-slate-object="text" data-key="17892"><span data-slate-leaf="true" data-offset-key="17892:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(time.Second * </span></span></span><span data-slate-object="text" data-key="17893"><span data-slate-leaf="true" data-offset-key="17893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="17894"><span data-slate-leaf="true" data-offset-key="17894:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17895"><span data-slate-object="text" data-key="17896"><span data-slate-leaf="true" data-offset-key="17896:0" data-first-offset="true"><span data-slate-string="true">        ch1 &lt;- </span></span></span><span data-slate-object="text" data-key="17897"><span data-slate-leaf="true" data-offset-key="17897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17898"><span data-slate-object="text" data-key="17899"><span data-slate-leaf="true" data-offset-key="17899:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17900"><span data-slate-leaf="true" data-offset-key="17900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="17901"><span data-slate-leaf="true" data-offset-key="17901:0" data-first-offset="true"><span data-slate-string="true">(ch1)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17902"><span data-slate-object="text" data-key="17903"><span data-slate-leaf="true" data-offset-key="17903:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17904"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17905"><span data-slate-object="text" data-key="17906"><span data-slate-leaf="true" data-offset-key="17906:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17907"><span data-slate-leaf="true" data-offset-key="17907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17908"><span data-slate-leaf="true" data-offset-key="17908:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17909"><span data-slate-leaf="true" data-offset-key="17909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17910"><span data-slate-leaf="true" data-offset-key="17910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="17911"><span data-slate-leaf="true" data-offset-key="17911:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17912"><span data-slate-object="text" data-key="17913"><span data-slate-leaf="true" data-offset-key="17913:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(time.Second * </span></span></span><span data-slate-object="text" data-key="17914"><span data-slate-leaf="true" data-offset-key="17914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="17915"><span data-slate-leaf="true" data-offset-key="17915:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17916"><span data-slate-object="text" data-key="17917"><span data-slate-leaf="true" data-offset-key="17917:0" data-first-offset="true"><span data-slate-string="true">        ch2 &lt;- </span></span></span><span data-slate-object="text" data-key="17918"><span data-slate-leaf="true" data-offset-key="17918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17919"><span data-slate-object="text" data-key="17920"><span data-slate-leaf="true" data-offset-key="17920:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17921"><span data-slate-leaf="true" data-offset-key="17921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="17922"><span data-slate-leaf="true" data-offset-key="17922:0" data-first-offset="true"><span data-slate-string="true">(ch2)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17923"><span data-slate-object="text" data-key="17924"><span data-slate-leaf="true" data-offset-key="17924:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17925"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17926"><span data-slate-object="text" data-key="17927"><span data-slate-leaf="true" data-offset-key="17927:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17928"><span data-slate-leaf="true" data-offset-key="17928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17929"><span data-slate-leaf="true" data-offset-key="17929:0" data-first-offset="true"><span data-slate-string="true"> ok1, ok2 </span></span></span><span data-slate-object="text" data-key="17930"><span data-slate-leaf="true" data-offset-key="17930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17931"><span data-slate-object="text" data-key="17932"><span data-slate-leaf="true" data-offset-key="17932:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17933"><span data-slate-leaf="true" data-offset-key="17933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17934"><span data-slate-leaf="true" data-offset-key="17934:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17935"><span data-slate-object="text" data-key="17936"><span data-slate-leaf="true" data-offset-key="17936:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17937"><span data-slate-leaf="true" data-offset-key="17937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="17938"><span data-slate-leaf="true" data-offset-key="17938:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17939"><span data-slate-object="text" data-key="17940"><span data-slate-leaf="true" data-offset-key="17940:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17941"><span data-slate-leaf="true" data-offset-key="17941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17942"><span data-slate-leaf="true" data-offset-key="17942:0" data-first-offset="true"><span data-slate-string="true"> x := &lt;-ch1:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17943"><span data-slate-object="text" data-key="17944"><span data-slate-leaf="true" data-offset-key="17944:0" data-first-offset="true"><span data-slate-string="true">            ok1 = </span></span></span><span data-slate-object="text" data-key="17945"><span data-slate-leaf="true" data-offset-key="17945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17946"><span data-slate-object="text" data-key="17947"><span data-slate-leaf="true" data-offset-key="17947:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(x)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17948"><span data-slate-object="text" data-key="17949"><span data-slate-leaf="true" data-offset-key="17949:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17950"><span data-slate-leaf="true" data-offset-key="17950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17951"><span data-slate-leaf="true" data-offset-key="17951:0" data-first-offset="true"><span data-slate-string="true"> x := &lt;-ch2:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17952"><span data-slate-object="text" data-key="17953"><span data-slate-leaf="true" data-offset-key="17953:0" data-first-offset="true"><span data-slate-string="true">            ok2 = </span></span></span><span data-slate-object="text" data-key="17954"><span data-slate-leaf="true" data-offset-key="17954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17955"><span data-slate-object="text" data-key="17956"><span data-slate-leaf="true" data-offset-key="17956:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(x)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17957"><span data-slate-object="text" data-key="17958"><span data-slate-leaf="true" data-offset-key="17958:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17959"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17960"><span data-slate-object="text" data-key="17961"><span data-slate-leaf="true" data-offset-key="17961:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17962"><span data-slate-leaf="true" data-offset-key="17962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17963"><span data-slate-leaf="true" data-offset-key="17963:0" data-first-offset="true"><span data-slate-string="true"> ok1 &amp;&amp; ok2 {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17964"><span data-slate-object="text" data-key="17965"><span data-slate-leaf="true" data-offset-key="17965:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17966"><span data-slate-leaf="true" data-offset-key="17966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17967"><span data-slate-object="text" data-key="17968"><span data-slate-leaf="true" data-offset-key="17968:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17969"><span data-slate-object="text" data-key="17970"><span data-slate-leaf="true" data-offset-key="17970:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17971"><span data-slate-object="text" data-key="17972"><span data-slate-leaf="true" data-offset-key="17972:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="17973"><span data-slate-leaf="true" data-offset-key="17973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"program end"</span></span></span></span><span data-slate-object="text" data-key="17974"><span data-slate-leaf="true" data-offset-key="17974:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17975"><span data-slate-object="text" data-key="17976"><span data-slate-leaf="true" data-offset-key="17976:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17977"><span data-slate-object="text" data-key="17978"><span data-slate-leaf="true" data-offset-key="17978:0" data-first-offset="true"><span data-slate-string="true">在这个示例中，我们期望程序在接收完 ch1 和 ch2 两个 channel 上的数据后就退出。但实际的运行情况却是这样的：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="17979"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17980"><span data-slate-object="text" data-key="17981"><span data-slate-leaf="true" data-offset-key="17981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17982"><span data-slate-object="text" data-key="17983"><span data-slate-leaf="true" data-offset-key="17983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17984"><span data-slate-object="text" data-key="17985"><span data-slate-leaf="true" data-offset-key="17985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17986"><span data-slate-object="text" data-key="17987"><span data-slate-leaf="true" data-offset-key="17987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17988"><span data-slate-object="text" data-key="17989"><span data-slate-leaf="true" data-offset-key="17989:0" data-first-offset="true"><span data-slate-string="true">... ... </span></span></span><span data-slate-object="text" data-key="17990"><span data-slate-leaf="true" data-offset-key="17990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 循环输出 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17991"><span data-slate-object="text" data-key="17992"><span data-slate-leaf="true" data-offset-key="17992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17993"><span data-slate-object="text" data-key="17994"><span data-slate-leaf="true" data-offset-key="17994:0" data-first-offset="true"><span data-slate-string="true">program end</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17995"><span data-slate-object="text" data-key="17996"><span data-slate-leaf="true" data-offset-key="17996:0" data-first-offset="true"><span data-slate-string="true">我们原本期望上面这个在依次输出 5 和 7 两个数字后退出，但实际运行的输出结果却是在输出 5 之后，程序输出了许多的 0 值，之后才输出 7 并退出。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17997"><span data-slate-object="text" data-key="17998"><span data-slate-leaf="true" data-offset-key="17998:0" data-first-offset="true"><span data-slate-string="true">这是怎么回事呢？我们简单分析一下这段代码的运行过程：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17999"><div data-slate-type="list-line" data-slate-object="block" data-key="18000"><span data-slate-object="text" data-key="18001"><span data-slate-leaf="true" data-offset-key="18001:0" data-first-offset="true"><span data-slate-string="true">前 5s，select 一直处于阻塞状态；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18002"><span data-slate-object="text" data-key="18003"><span data-slate-leaf="true" data-offset-key="18003:0" data-first-offset="true"><span data-slate-string="true">第 5s，ch1 返回一个 5 后被 close，select 语句的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18004"><span data-slate-object="text" data-key="18005"><span data-slate-leaf="true" data-offset-key="18005:0" data-first-offset="true"><span data-slate-string="true"> case x := &lt;-ch1</span></span></span></span><span data-slate-object="text" data-key="18006"><span data-slate-leaf="true" data-offset-key="18006:0" data-first-offset="true"><span data-slate-string="true"> 这个分支被选出执行，程序输出 5，并回到 for 循环并重新 select；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18007"><span data-slate-object="text" data-key="18008"><span data-slate-leaf="true" data-offset-key="18008:0" data-first-offset="true"><span data-slate-string="true">由于 ch1 被关闭，从一个已关闭的 channel 接收数据将永远不会被阻塞，于是新一轮 select 又把</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18009"><span data-slate-object="text" data-key="18010"><span data-slate-leaf="true" data-offset-key="18010:0" data-first-offset="true"><span data-slate-string="true"> case x := &lt;-ch1</span></span></span></span><span data-slate-object="text" data-key="18011"><span data-slate-leaf="true" data-offset-key="18011:0" data-first-offset="true"><span data-slate-string="true"> 这个分支选出并执行。由于 ch1 处于关闭状态，从这个 channel 获取数据，我们会得到这个 channel 对应类型的零值，这里就是 0。于是程序再次输出 0；程序按这个逻辑循环执行，一直输出 0 值；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18012"><span data-slate-object="text" data-key="18013"><span data-slate-leaf="true" data-offset-key="18013:0" data-first-offset="true"><span data-slate-string="true">2s 后，ch2 被写入了一个数值 7。这样在某一轮 select 的过程中，分支</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18014"><span data-slate-object="text" data-key="18015"><span data-slate-leaf="true" data-offset-key="18015:0" data-first-offset="true"><span data-slate-string="true"> case x := &lt;-ch2</span></span></span></span><span data-slate-object="text" data-key="18016"><span data-slate-leaf="true" data-offset-key="18016:0" data-first-offset="true"><span data-slate-string="true"> 被选中得以执行，程序输出 7 之后满足退出条件，于是程序终止。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18017"><span data-slate-object="text" data-key="18018"><span data-slate-leaf="true" data-offset-key="18018:0" data-first-offset="true"><span data-slate-string="true">那我们可以怎么改进一下这个程序，让它能按照我们的预期输出呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18019"><span data-slate-object="text" data-key="18020"><span data-slate-leaf="true" data-offset-key="18020:0" data-first-offset="true"><span data-slate-string="true">是时候让 nil channel 登场了！用 nil channel 改进后的示例代码是这样的：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18021"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18022"><span data-slate-object="text" data-key="18023"><span data-slate-leaf="true" data-offset-key="18023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18024"><span data-slate-leaf="true" data-offset-key="18024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18025"><span data-slate-leaf="true" data-offset-key="18025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="18026"><span data-slate-leaf="true" data-offset-key="18026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18027"><span data-slate-leaf="true" data-offset-key="18027:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18028"><span data-slate-object="text" data-key="18029"><span data-slate-leaf="true" data-offset-key="18029:0" data-first-offset="true"><span data-slate-string="true">    ch1, ch2 := </span></span></span><span data-slate-object="text" data-key="18030"><span data-slate-leaf="true" data-offset-key="18030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="18031"><span data-slate-leaf="true" data-offset-key="18031:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18032"><span data-slate-leaf="true" data-offset-key="18032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="18033"><span data-slate-leaf="true" data-offset-key="18033:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18034"><span data-slate-leaf="true" data-offset-key="18034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="18035"><span data-slate-leaf="true" data-offset-key="18035:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="18036"><span data-slate-leaf="true" data-offset-key="18036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="18037"><span data-slate-leaf="true" data-offset-key="18037:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18038"><span data-slate-leaf="true" data-offset-key="18038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="18039"><span data-slate-leaf="true" data-offset-key="18039:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18040"><span data-slate-leaf="true" data-offset-key="18040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="18041"><span data-slate-leaf="true" data-offset-key="18041:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18042"><span data-slate-object="text" data-key="18043"><span data-slate-leaf="true" data-offset-key="18043:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18044"><span data-slate-leaf="true" data-offset-key="18044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="18045"><span data-slate-leaf="true" data-offset-key="18045:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18046"><span data-slate-leaf="true" data-offset-key="18046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18047"><span data-slate-leaf="true" data-offset-key="18047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18048"><span data-slate-leaf="true" data-offset-key="18048:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18049"><span data-slate-object="text" data-key="18050"><span data-slate-leaf="true" data-offset-key="18050:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(time.Second * </span></span></span><span data-slate-object="text" data-key="18051"><span data-slate-leaf="true" data-offset-key="18051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="18052"><span data-slate-leaf="true" data-offset-key="18052:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18053"><span data-slate-object="text" data-key="18054"><span data-slate-leaf="true" data-offset-key="18054:0" data-first-offset="true"><span data-slate-string="true">        ch1 &lt;- </span></span></span><span data-slate-object="text" data-key="18055"><span data-slate-leaf="true" data-offset-key="18055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18056"><span data-slate-object="text" data-key="18057"><span data-slate-leaf="true" data-offset-key="18057:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18058"><span data-slate-leaf="true" data-offset-key="18058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="18059"><span data-slate-leaf="true" data-offset-key="18059:0" data-first-offset="true"><span data-slate-string="true">(ch1)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18060"><span data-slate-object="text" data-key="18061"><span data-slate-leaf="true" data-offset-key="18061:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18062"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18063"><span data-slate-object="text" data-key="18064"><span data-slate-leaf="true" data-offset-key="18064:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18065"><span data-slate-leaf="true" data-offset-key="18065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="18066"><span data-slate-leaf="true" data-offset-key="18066:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18067"><span data-slate-leaf="true" data-offset-key="18067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18068"><span data-slate-leaf="true" data-offset-key="18068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18069"><span data-slate-leaf="true" data-offset-key="18069:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18070"><span data-slate-object="text" data-key="18071"><span data-slate-leaf="true" data-offset-key="18071:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(time.Second * </span></span></span><span data-slate-object="text" data-key="18072"><span data-slate-leaf="true" data-offset-key="18072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="18073"><span data-slate-leaf="true" data-offset-key="18073:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18074"><span data-slate-object="text" data-key="18075"><span data-slate-leaf="true" data-offset-key="18075:0" data-first-offset="true"><span data-slate-string="true">        ch2 &lt;- </span></span></span><span data-slate-object="text" data-key="18076"><span data-slate-leaf="true" data-offset-key="18076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18077"><span data-slate-object="text" data-key="18078"><span data-slate-leaf="true" data-offset-key="18078:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18079"><span data-slate-leaf="true" data-offset-key="18079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="18080"><span data-slate-leaf="true" data-offset-key="18080:0" data-first-offset="true"><span data-slate-string="true">(ch2)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18081"><span data-slate-object="text" data-key="18082"><span data-slate-leaf="true" data-offset-key="18082:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18083"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18084"><span data-slate-object="text" data-key="18085"><span data-slate-leaf="true" data-offset-key="18085:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18086"><span data-slate-leaf="true" data-offset-key="18086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18087"><span data-slate-leaf="true" data-offset-key="18087:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18088"><span data-slate-object="text" data-key="18089"><span data-slate-leaf="true" data-offset-key="18089:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18090"><span data-slate-leaf="true" data-offset-key="18090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18091"><span data-slate-leaf="true" data-offset-key="18091:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18092"><span data-slate-object="text" data-key="18093"><span data-slate-leaf="true" data-offset-key="18093:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18094"><span data-slate-leaf="true" data-offset-key="18094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18095"><span data-slate-leaf="true" data-offset-key="18095:0" data-first-offset="true"><span data-slate-string="true"> x, ok := &lt;-ch1:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18096"><span data-slate-object="text" data-key="18097"><span data-slate-leaf="true" data-offset-key="18097:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18098"><span data-slate-leaf="true" data-offset-key="18098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18099"><span data-slate-leaf="true" data-offset-key="18099:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18100"><span data-slate-object="text" data-key="18101"><span data-slate-leaf="true" data-offset-key="18101:0" data-first-offset="true"><span data-slate-string="true">                ch1 = </span></span></span><span data-slate-object="text" data-key="18102"><span data-slate-leaf="true" data-offset-key="18102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18103"><span data-slate-object="text" data-key="18104"><span data-slate-leaf="true" data-offset-key="18104:0" data-first-offset="true"><span data-slate-string="true">            } </span></span></span><span data-slate-object="text" data-key="18105"><span data-slate-leaf="true" data-offset-key="18105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="18106"><span data-slate-leaf="true" data-offset-key="18106:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18107"><span data-slate-object="text" data-key="18108"><span data-slate-leaf="true" data-offset-key="18108:0" data-first-offset="true"><span data-slate-string="true">                fmt.Println(x)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18109"><span data-slate-object="text" data-key="18110"><span data-slate-leaf="true" data-offset-key="18110:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18111"><span data-slate-object="text" data-key="18112"><span data-slate-leaf="true" data-offset-key="18112:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18113"><span data-slate-leaf="true" data-offset-key="18113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18114"><span data-slate-leaf="true" data-offset-key="18114:0" data-first-offset="true"><span data-slate-string="true"> x, ok := &lt;-ch2:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18115"><span data-slate-object="text" data-key="18116"><span data-slate-leaf="true" data-offset-key="18116:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18117"><span data-slate-leaf="true" data-offset-key="18117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18118"><span data-slate-leaf="true" data-offset-key="18118:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18119"><span data-slate-object="text" data-key="18120"><span data-slate-leaf="true" data-offset-key="18120:0" data-first-offset="true"><span data-slate-string="true">                ch2 = </span></span></span><span data-slate-object="text" data-key="18121"><span data-slate-leaf="true" data-offset-key="18121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18122"><span data-slate-object="text" data-key="18123"><span data-slate-leaf="true" data-offset-key="18123:0" data-first-offset="true"><span data-slate-string="true">            } </span></span></span><span data-slate-object="text" data-key="18124"><span data-slate-leaf="true" data-offset-key="18124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="18125"><span data-slate-leaf="true" data-offset-key="18125:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18126"><span data-slate-object="text" data-key="18127"><span data-slate-leaf="true" data-offset-key="18127:0" data-first-offset="true"><span data-slate-string="true">                fmt.Println(x)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18128"><span data-slate-object="text" data-key="18129"><span data-slate-leaf="true" data-offset-key="18129:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18130"><span data-slate-object="text" data-key="18131"><span data-slate-leaf="true" data-offset-key="18131:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18132"><span data-slate-object="text" data-key="18133"><span data-slate-leaf="true" data-offset-key="18133:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18134"><span data-slate-leaf="true" data-offset-key="18134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18135"><span data-slate-leaf="true" data-offset-key="18135:0" data-first-offset="true"><span data-slate-string="true"> ch1 == </span></span></span><span data-slate-object="text" data-key="18136"><span data-slate-leaf="true" data-offset-key="18136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18137"><span data-slate-leaf="true" data-offset-key="18137:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; ch2 == </span></span></span><span data-slate-object="text" data-key="18138"><span data-slate-leaf="true" data-offset-key="18138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18139"><span data-slate-leaf="true" data-offset-key="18139:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18140"><span data-slate-object="text" data-key="18141"><span data-slate-leaf="true" data-offset-key="18141:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18142"><span data-slate-leaf="true" data-offset-key="18142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18143"><span data-slate-object="text" data-key="18144"><span data-slate-leaf="true" data-offset-key="18144:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18145"><span data-slate-object="text" data-key="18146"><span data-slate-leaf="true" data-offset-key="18146:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18147"><span data-slate-object="text" data-key="18148"><span data-slate-leaf="true" data-offset-key="18148:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="18149"><span data-slate-leaf="true" data-offset-key="18149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"program end"</span></span></span></span><span data-slate-object="text" data-key="18150"><span data-slate-leaf="true" data-offset-key="18150:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18151"><span data-slate-object="text" data-key="18152"><span data-slate-leaf="true" data-offset-key="18152:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18153"><span data-slate-object="text" data-key="18154"><span data-slate-leaf="true" data-offset-key="18154:0" data-first-offset="true"><span data-slate-string="true">这里，改进后的示例程序的最关键的一个变化，就是在判断 ch1 或 ch2 被关闭后，显式地将 ch1 或 ch2 置为 nil。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18155"><span data-slate-object="text" data-key="18156"><span data-slate-leaf="true" data-offset-key="18156:0" data-first-offset="true"><span data-slate-string="true">而我们前面已经知道了，</span></span></span><span data-slate-object="text" data-key="18157"><span data-slate-leaf="true" data-offset-key="18157:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">对一个 nil channel 执行获取操作，这个操作将阻塞</span></span></span></span><span data-slate-object="text" data-key="18158"><span data-slate-leaf="true" data-offset-key="18158:0" data-first-offset="true"><span data-slate-string="true">。于是，这里已经被置为 nil 的 c1 或 c2 的分支，将再也不会被 select 选中执行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18159"><span data-slate-object="text" data-key="18160"><span data-slate-leaf="true" data-offset-key="18160:0" data-first-offset="true"><span data-slate-string="true">改进后的示例的运行结果如下，与我们预期相符：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="18161"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18162"><span data-slate-object="text" data-key="18163"><span data-slate-leaf="true" data-offset-key="18163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18164"><span data-slate-object="text" data-key="18165"><span data-slate-leaf="true" data-offset-key="18165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18166"><span data-slate-object="text" data-key="18167"><span data-slate-leaf="true" data-offset-key="18167:0" data-first-offset="true"><span data-slate-string="true">program </span></span></span><span data-slate-object="text" data-key="18168"><span data-slate-leaf="true" data-offset-key="18168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">end</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18169" id="sr-toc-14"><span data-slate-object="text" data-key="18170"><span data-slate-leaf="true" data-offset-key="18170:0" data-first-offset="true"><span data-slate-string="true">与 select 结合使用的一些惯用法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18171"><span data-slate-object="text" data-key="18172"><span data-slate-leaf="true" data-offset-key="18172:0" data-first-offset="true"><span data-slate-string="true">channel 和 select 的结合使用能形成强大的表达能力，我们在前面的例子中已经或多或少见识过了。这里我再强调几种 channel 与 select 结合的惯用法。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18173" id="sr-toc-15"><span data-slate-object="text" data-key="18174"><span data-slate-leaf="true" data-offset-key="18174:0" data-first-offset="true"><span data-slate-string="true">第一种用法：利用 default 分支避免阻塞</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18175"><span data-slate-object="text" data-key="18176"><span data-slate-leaf="true" data-offset-key="18176:0" data-first-offset="true"><span data-slate-string="true">select 语句的 default 分支的语义，就是在其他非 default 分支因通信未就绪，而无法被选择的时候执行的，这就给 default 分支赋予了一种 “避免阻塞” 的特性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18177"><span data-slate-object="text" data-key="18178"><span data-slate-leaf="true" data-offset-key="18178:0" data-first-offset="true"><span data-slate-string="true">其实在前面的</span></span></span><span data-slate-object="text" data-key="18179"><span data-slate-leaf="true" data-offset-key="18179:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “len (channel) 的应用”</span></span></span></span><span data-slate-object="text" data-key="18180"><span data-slate-leaf="true" data-offset-key="18180:0" data-first-offset="true"><span data-slate-string="true"> 小节的例子中，我们就已经用到了 “利用 default 分支” 实现的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18181"><span data-slate-object="text" data-key="18182"><span data-slate-leaf="true" data-offset-key="18182:0" data-first-offset="true"><span data-slate-string="true"> trySend</span></span></span></span><span data-slate-object="text" data-key="18183"><span data-slate-leaf="true" data-offset-key="18183:0" data-first-offset="true"><span data-slate-string="true"> 和</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18184"><span data-slate-object="text" data-key="18185"><span data-slate-leaf="true" data-offset-key="18185:0" data-first-offset="true"><span data-slate-string="true"> tryRecv</span></span></span></span><span data-slate-object="text" data-key="18186"><span data-slate-leaf="true" data-offset-key="18186:0" data-first-offset="true"><span data-slate-string="true"> 两个函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18187"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18188"><span data-slate-object="text" data-key="18189"><span data-slate-leaf="true" data-offset-key="18189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18190"><span data-slate-leaf="true" data-offset-key="18190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18191"><span data-slate-leaf="true" data-offset-key="18191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">tryRecv</span></span></span></span></span><span data-slate-object="text" data-key="18192"><span data-slate-leaf="true" data-offset-key="18192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c &lt;-</span></span></span></span></span><span data-slate-object="text" data-key="18193"><span data-slate-leaf="true" data-offset-key="18193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="18194"><span data-slate-leaf="true" data-offset-key="18194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="18195"><span data-slate-leaf="true" data-offset-key="18195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="18196"><span data-slate-leaf="true" data-offset-key="18196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="18197"><span data-slate-leaf="true" data-offset-key="18197:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="18198"><span data-slate-leaf="true" data-offset-key="18198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="18199"><span data-slate-leaf="true" data-offset-key="18199:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18200"><span data-slate-leaf="true" data-offset-key="18200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="18201"><span data-slate-leaf="true" data-offset-key="18201:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18202"><span data-slate-object="text" data-key="18203"><span data-slate-leaf="true" data-offset-key="18203:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18204"><span data-slate-leaf="true" data-offset-key="18204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18205"><span data-slate-leaf="true" data-offset-key="18205:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18206"><span data-slate-object="text" data-key="18207"><span data-slate-leaf="true" data-offset-key="18207:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18208"><span data-slate-leaf="true" data-offset-key="18208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18209"><span data-slate-leaf="true" data-offset-key="18209:0" data-first-offset="true"><span data-slate-string="true"> i := &lt;-c:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18210"><span data-slate-object="text" data-key="18211"><span data-slate-leaf="true" data-offset-key="18211:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18212"><span data-slate-leaf="true" data-offset-key="18212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18213"><span data-slate-leaf="true" data-offset-key="18213:0" data-first-offset="true"><span data-slate-string="true"> i, </span></span></span><span data-slate-object="text" data-key="18214"><span data-slate-leaf="true" data-offset-key="18214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18215"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18216"><span data-slate-object="text" data-key="18217"><span data-slate-leaf="true" data-offset-key="18217:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18218"><span data-slate-leaf="true" data-offset-key="18218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="18219"><span data-slate-leaf="true" data-offset-key="18219:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18220"><span data-slate-leaf="true" data-offset-key="18220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//channel 为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18221"><span data-slate-object="text" data-key="18222"><span data-slate-leaf="true" data-offset-key="18222:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18223"><span data-slate-leaf="true" data-offset-key="18223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18224"><span data-slate-leaf="true" data-offset-key="18224:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18225"><span data-slate-leaf="true" data-offset-key="18225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18226"><span data-slate-leaf="true" data-offset-key="18226:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18227"><span data-slate-leaf="true" data-offset-key="18227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18228"><span data-slate-object="text" data-key="18229"><span data-slate-leaf="true" data-offset-key="18229:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18230"><span data-slate-object="text" data-key="18231"><span data-slate-leaf="true" data-offset-key="18231:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18232"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18233"><span data-slate-object="text" data-key="18234"><span data-slate-leaf="true" data-offset-key="18234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18235"><span data-slate-leaf="true" data-offset-key="18235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18236"><span data-slate-leaf="true" data-offset-key="18236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">trySend</span></span></span></span></span><span data-slate-object="text" data-key="18237"><span data-slate-leaf="true" data-offset-key="18237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c </span></span></span></span></span><span data-slate-object="text" data-key="18238"><span data-slate-leaf="true" data-offset-key="18238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span></span></span><span data-slate-object="text" data-key="18239"><span data-slate-leaf="true" data-offset-key="18239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;- </span></span></span></span></span><span data-slate-object="text" data-key="18240"><span data-slate-leaf="true" data-offset-key="18240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="18241"><span data-slate-leaf="true" data-offset-key="18241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, i </span></span></span></span></span><span data-slate-object="text" data-key="18242"><span data-slate-leaf="true" data-offset-key="18242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="18243"><span data-slate-leaf="true" data-offset-key="18243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="18244"><span data-slate-leaf="true" data-offset-key="18244:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18245"><span data-slate-leaf="true" data-offset-key="18245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="18246"><span data-slate-leaf="true" data-offset-key="18246:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18247"><span data-slate-object="text" data-key="18248"><span data-slate-leaf="true" data-offset-key="18248:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18249"><span data-slate-leaf="true" data-offset-key="18249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18250"><span data-slate-leaf="true" data-offset-key="18250:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18251"><span data-slate-object="text" data-key="18252"><span data-slate-leaf="true" data-offset-key="18252:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18253"><span data-slate-leaf="true" data-offset-key="18253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18254"><span data-slate-leaf="true" data-offset-key="18254:0" data-first-offset="true"><span data-slate-string="true"> c &lt;- i:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18255"><span data-slate-object="text" data-key="18256"><span data-slate-leaf="true" data-offset-key="18256:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18257"><span data-slate-leaf="true" data-offset-key="18257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18258"><span data-slate-leaf="true" data-offset-key="18258:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18259"><span data-slate-leaf="true" data-offset-key="18259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18260"><span data-slate-object="text" data-key="18261"><span data-slate-leaf="true" data-offset-key="18261:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18262"><span data-slate-leaf="true" data-offset-key="18262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="18263"><span data-slate-leaf="true" data-offset-key="18263:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18264"><span data-slate-leaf="true" data-offset-key="18264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//channel 满了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18265"><span data-slate-object="text" data-key="18266"><span data-slate-leaf="true" data-offset-key="18266:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18267"><span data-slate-leaf="true" data-offset-key="18267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18268"><span data-slate-leaf="true" data-offset-key="18268:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18269"><span data-slate-leaf="true" data-offset-key="18269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18270"><span data-slate-object="text" data-key="18271"><span data-slate-leaf="true" data-offset-key="18271:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18272"><span data-slate-object="text" data-key="18273"><span data-slate-leaf="true" data-offset-key="18273:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18274"><span data-slate-object="text" data-key="18275"><span data-slate-leaf="true" data-offset-key="18275:0" data-first-offset="true"><span data-slate-string="true">而且，无论是无缓冲 channel 还是带缓冲 channel，这两个函数都能适用，并且不会阻塞在空 channel 或元素个数已经达到容量的 channel 上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18276"><span data-slate-object="text" data-key="18277"><span data-slate-leaf="true" data-offset-key="18277:0" data-first-offset="true"><span data-slate-string="true">在 Go 标准库中，这个惯用法也有应用，比如：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18278"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18279"><span data-slate-object="text" data-key="18280"><span data-slate-leaf="true" data-offset-key="18280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/time/sleep.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18281"><span data-slate-object="text" data-key="18282"><span data-slate-leaf="true" data-offset-key="18282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18283"><span data-slate-leaf="true" data-offset-key="18283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18284"><span data-slate-leaf="true" data-offset-key="18284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendTime</span></span></span></span></span><span data-slate-object="text" data-key="18285"><span data-slate-leaf="true" data-offset-key="18285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c </span></span></span></span></span><span data-slate-object="text" data-key="18286"><span data-slate-leaf="true" data-offset-key="18286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="18287"><span data-slate-leaf="true" data-offset-key="18287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{}, seq </span></span></span></span></span><span data-slate-object="text" data-key="18288"><span data-slate-leaf="true" data-offset-key="18288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uintptr</span></span></span></span></span></span><span data-slate-object="text" data-key="18289"><span data-slate-leaf="true" data-offset-key="18289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="18290"><span data-slate-leaf="true" data-offset-key="18290:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18291"><span data-slate-object="text" data-key="18292"><span data-slate-leaf="true" data-offset-key="18292:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18293"><span data-slate-leaf="true" data-offset-key="18293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 无阻塞的向 c 发送当前时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18294"><span data-slate-object="text" data-key="18295"><span data-slate-leaf="true" data-offset-key="18295:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18296"><span data-slate-leaf="true" data-offset-key="18296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18297"><span data-slate-leaf="true" data-offset-key="18297:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18298"><span data-slate-object="text" data-key="18299"><span data-slate-leaf="true" data-offset-key="18299:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18300"><span data-slate-leaf="true" data-offset-key="18300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18301"><span data-slate-leaf="true" data-offset-key="18301:0" data-first-offset="true"><span data-slate-string="true"> c.(</span></span></span><span data-slate-object="text" data-key="18302"><span data-slate-leaf="true" data-offset-key="18302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="18303"><span data-slate-leaf="true" data-offset-key="18303:0" data-first-offset="true"><span data-slate-string="true"> Time) &lt;- Now():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18304"><span data-slate-object="text" data-key="18305"><span data-slate-leaf="true" data-offset-key="18305:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18306"><span data-slate-leaf="true" data-offset-key="18306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="18307"><span data-slate-leaf="true" data-offset-key="18307:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18308"><span data-slate-object="text" data-key="18309"><span data-slate-leaf="true" data-offset-key="18309:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18310"><span data-slate-object="text" data-key="18311"><span data-slate-leaf="true" data-offset-key="18311:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18312" id="sr-toc-16"><span data-slate-object="text" data-key="18313"><span data-slate-leaf="true" data-offset-key="18313:0" data-first-offset="true"><span data-slate-string="true">第二种用法：实现超时机制</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18314"><span data-slate-object="text" data-key="18315"><span data-slate-leaf="true" data-offset-key="18315:0" data-first-offset="true"><span data-slate-string="true">带超时机制的 select，是 Go 中常见的一种 select 和 channel 的组合用法。通过超时事件，我们既可以避免长期陷入某种操作的等待中，也可以做一些异常处理工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18316"><span data-slate-object="text" data-key="18317"><span data-slate-leaf="true" data-offset-key="18317:0" data-first-offset="true"><span data-slate-string="true">比如，下面示例代码实现了一次具有 30s 超时的 select：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18318"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18319"><span data-slate-object="text" data-key="18320"><span data-slate-leaf="true" data-offset-key="18320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18321"><span data-slate-leaf="true" data-offset-key="18321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18322"><span data-slate-leaf="true" data-offset-key="18322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="18323"><span data-slate-leaf="true" data-offset-key="18323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18324"><span data-slate-leaf="true" data-offset-key="18324:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18325"><span data-slate-object="text" data-key="18326"><span data-slate-leaf="true" data-offset-key="18326:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18327"><span data-slate-leaf="true" data-offset-key="18327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18328"><span data-slate-leaf="true" data-offset-key="18328:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18329"><span data-slate-object="text" data-key="18330"><span data-slate-leaf="true" data-offset-key="18330:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18331"><span data-slate-leaf="true" data-offset-key="18331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18332"><span data-slate-leaf="true" data-offset-key="18332:0" data-first-offset="true"><span data-slate-string="true"> &lt;-c:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18333"><span data-slate-object="text" data-key="18334"><span data-slate-leaf="true" data-offset-key="18334:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="18335"><span data-slate-leaf="true" data-offset-key="18335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ... do some stuff</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18336"><span data-slate-object="text" data-key="18337"><span data-slate-leaf="true" data-offset-key="18337:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18338"><span data-slate-leaf="true" data-offset-key="18338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18339"><span data-slate-leaf="true" data-offset-key="18339:0" data-first-offset="true"><span data-slate-string="true"> &lt;-time.After(</span></span></span><span data-slate-object="text" data-key="18340"><span data-slate-leaf="true" data-offset-key="18340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">30</span></span></span></span><span data-slate-object="text" data-key="18341"><span data-slate-leaf="true" data-offset-key="18341:0" data-first-offset="true"><span data-slate-string="true"> *time.Second):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18342"><span data-slate-object="text" data-key="18343"><span data-slate-leaf="true" data-offset-key="18343:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18344"><span data-slate-leaf="true" data-offset-key="18344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18345"><span data-slate-object="text" data-key="18346"><span data-slate-leaf="true" data-offset-key="18346:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18347"><span data-slate-object="text" data-key="18348"><span data-slate-leaf="true" data-offset-key="18348:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18349"><span data-slate-object="text" data-key="18350"><span data-slate-leaf="true" data-offset-key="18350:0" data-first-offset="true"><span data-slate-string="true">不过，在应用带有超时机制的 select 时，我们要特别注意 </span></span></span><span data-slate-object="text" data-key="18351"><span data-slate-leaf="true" data-offset-key="18351:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">timer 使用后的释放</span></span></span></span><span data-slate-object="text" data-key="18352"><span data-slate-leaf="true" data-offset-key="18352:0" data-first-offset="true"><span data-slate-string="true">，尤其在大量创建 timer 的时候。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18353"><span data-slate-object="text" data-key="18354"><span data-slate-leaf="true" data-offset-key="18354:0" data-first-offset="true"><span data-slate-string="true">Go 语言标准库提供的 timer 实际上是由 Go 运行时自行维护的，而不是操作系统级的定时器资源，它的使用代价要比操作系统级的低许多。但即便如此，作为 time.Timer 的使用者，我们也要尽量减少在使用 Timer 时给 Go 运行时和 Go 垃圾回收带来的压力，要及时调用 timer 的 Stop 方法回收 Timer 资源。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18355" id="sr-toc-17"><span data-slate-object="text" data-key="18356"><span data-slate-leaf="true" data-offset-key="18356:0" data-first-offset="true"><span data-slate-string="true">第三种用法：实现心跳机制</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18357"><span data-slate-object="text" data-key="18358"><span data-slate-leaf="true" data-offset-key="18358:0" data-first-offset="true"><span data-slate-string="true">结合 time 包的 Ticker，我们可以实现带有心跳机制的 select。这种机制让我们可以在监听 channel 的同时，执行一些</span></span></span><span data-slate-object="text" data-key="18359"><span data-slate-leaf="true" data-offset-key="18359:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">周期性的任务</span></span></span></span><span data-slate-object="text" data-key="18360"><span data-slate-leaf="true" data-offset-key="18360:0" data-first-offset="true"><span data-slate-string="true">，比如下面这段代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18361"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18362"><span data-slate-object="text" data-key="18363"><span data-slate-leaf="true" data-offset-key="18363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18364"><span data-slate-leaf="true" data-offset-key="18364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18365"><span data-slate-leaf="true" data-offset-key="18365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="18366"><span data-slate-leaf="true" data-offset-key="18366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18367"><span data-slate-leaf="true" data-offset-key="18367:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18368"><span data-slate-object="text" data-key="18369"><span data-slate-leaf="true" data-offset-key="18369:0" data-first-offset="true"><span data-slate-string="true">  heartbeat := time.NewTicker(</span></span></span><span data-slate-object="text" data-key="18370"><span data-slate-leaf="true" data-offset-key="18370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">30</span></span></span></span><span data-slate-object="text" data-key="18371"><span data-slate-leaf="true" data-offset-key="18371:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18372"><span data-slate-object="text" data-key="18373"><span data-slate-leaf="true" data-offset-key="18373:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18374"><span data-slate-leaf="true" data-offset-key="18374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="18375"><span data-slate-leaf="true" data-offset-key="18375:0" data-first-offset="true"><span data-slate-string="true"> heartbeat.Stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18376"><span data-slate-object="text" data-key="18377"><span data-slate-leaf="true" data-offset-key="18377:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18378"><span data-slate-leaf="true" data-offset-key="18378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18379"><span data-slate-leaf="true" data-offset-key="18379:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18380"><span data-slate-object="text" data-key="18381"><span data-slate-leaf="true" data-offset-key="18381:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18382"><span data-slate-leaf="true" data-offset-key="18382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18383"><span data-slate-leaf="true" data-offset-key="18383:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18384"><span data-slate-object="text" data-key="18385"><span data-slate-leaf="true" data-offset-key="18385:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18386"><span data-slate-leaf="true" data-offset-key="18386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18387"><span data-slate-leaf="true" data-offset-key="18387:0" data-first-offset="true"><span data-slate-string="true"> &lt;-c:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18388"><span data-slate-object="text" data-key="18389"><span data-slate-leaf="true" data-offset-key="18389:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18390"><span data-slate-leaf="true" data-offset-key="18390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ... do some stuff</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18391"><span data-slate-object="text" data-key="18392"><span data-slate-leaf="true" data-offset-key="18392:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18393"><span data-slate-leaf="true" data-offset-key="18393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18394"><span data-slate-leaf="true" data-offset-key="18394:0" data-first-offset="true"><span data-slate-string="true"> &lt;- heartbeat.C:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18395"><span data-slate-object="text" data-key="18396"><span data-slate-leaf="true" data-offset-key="18396:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18397"><span data-slate-leaf="true" data-offset-key="18397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//... do heartbeat stuff</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18398"><span data-slate-object="text" data-key="18399"><span data-slate-leaf="true" data-offset-key="18399:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18400"><span data-slate-object="text" data-key="18401"><span data-slate-leaf="true" data-offset-key="18401:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18402"><span data-slate-object="text" data-key="18403"><span data-slate-leaf="true" data-offset-key="18403:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18404"><span data-slate-object="text" data-key="18405"><span data-slate-leaf="true" data-offset-key="18405:0" data-first-offset="true"><span data-slate-string="true">这里我们使用 time.NewTicker，创建了一个 Ticker 类型实例 heartbeat。这个实例包含一个 channel 类型的字段 C，这个字段会按一定时间间隔持续产生事件，就像 “心跳” 一样。这样 for 循环在 channel c 无数据接收时，会每隔特定时间完成一次迭代，然后回到 for 循环进行下一次迭代。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18406"><span data-slate-object="text" data-key="18407"><span data-slate-leaf="true" data-offset-key="18407:0" data-first-offset="true"><span data-slate-string="true">和 timer 一样，我们在使用完 ticker 之后，也不要忘记调用它的 Stop 方法，避免心跳事件在 ticker 的 channel（上面示例中的 heartbeat.C）中持续产生。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18408" id="sr-toc-18"><span data-slate-object="text" data-key="18409"><span data-slate-leaf="true" data-offset-key="18409:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18410"><span data-slate-object="text" data-key="18411"><span data-slate-leaf="true" data-offset-key="18411:0" data-first-offset="true"><span data-slate-string="true">好了，今天的课讲到这里就结束了，现在我们一起来回顾一下吧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18412"><span data-slate-object="text" data-key="18413"><span data-slate-leaf="true" data-offset-key="18413:0" data-first-offset="true"><span data-slate-string="true">在这一讲中，我们系统学习了 Go CSP 并发方案中除 Goroutine 之外的另一个重要组成部分：channel。Go 为了原生支持并发，把 channel 视作一等公民身份，这就大幅提升了开发人员使用 channel 进行并发设计和实现的体验。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18414"><span data-slate-object="text" data-key="18415"><span data-slate-leaf="true" data-offset-key="18415:0" data-first-offset="true"><span data-slate-string="true">通过预定义函数 make，我们可以创建两类 channel：无缓冲 channel 与带缓冲的 channel。这两类 channel 具有不同的收发特性，可以适用于不同的应用场合：无缓冲 channel 兼具通信与同步特性，常用于作为信号通知或替代同步锁；而带缓冲 channel 的异步性，让它更适合用来实现基于内存的消息队列、计数信号量等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18416"><span data-slate-object="text" data-key="18417"><span data-slate-leaf="true" data-offset-key="18417:0" data-first-offset="true"><span data-slate-string="true">此外，你也要牢记值为 nil 的 channel 的阻塞特性，有些时候它也能帮上大忙。而面对已关闭的 channel 你也一定要小心，尤其要避免向已关闭的 channel 发送数据，那会导致 panic。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18418"><span data-slate-object="text" data-key="18419"><span data-slate-leaf="true" data-offset-key="18419:0" data-first-offset="true"><span data-slate-string="true">最后，select 是 Go 为了支持同时操作多个 channel，而引入的另外一个并发原语，select 与 channel 有几种常用的固定搭配，你也要好好掌握和理解。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18420" id="sr-toc-19"><span data-slate-object="text" data-key="18421"><span data-slate-leaf="true" data-offset-key="18421:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18422"><span data-slate-object="text" data-key="18423"><span data-slate-leaf="true" data-offset-key="18423:0" data-first-offset="true"><span data-slate-string="true">channel 作为 Go 并发设计的重要组成部分，需要你掌握的细节非常多。而且，channel 的应用模式也非常多，我们这一讲仅挑了几个常见的模式做了讲解。在日常开发中你还见过哪些实用的 channel 使用模式呢？欢迎在留言区分享。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18424"><span data-slate-object="text" data-key="18425"><span data-slate-leaf="true" data-offset-key="18425:0" data-first-offset="true"><span data-slate-string="true">如果你觉得有收获，也欢迎你把这节课分享给更多对 Go 并发感兴趣的朋友。我是 Tony Bai，我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>30</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-20">精选留言 (29)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>张申傲</span></div></div><div>这节课信息量有点大，需要多看几遍好好消化。请问老师一个问题：如果程序中没有手动 close channel，那么 channel 会在什么时候关闭呢？是否需要借助 defer 去释放 channel 资源呢？</div><div><p>作者回复: channel 一旦没有人引用了，就会被 gc 掉，不关闭也 ok。但是如果有 goroutine 一直在读 channel，那么 channel 一直存在，不会关闭。直到程序退出。</p></div><div><div>2022-02-20</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 罗杰</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>这节课比较绕，要静下心好好学习</div><div><p>作者回复: 👍</p></div><div><div>2022-01-12</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/70/6d/11ea66f0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>peison</span></div></div><div>请问计数信号量的例子中，因为 jobs 的容量是 10，这里执行的循环不会导致阻塞，close (jobs) 应该会被执行到，那么下面的 for range 为什么不会终止，而可以继续运行？
go func () {
		for i := 0; i &lt; 8; i++ {
			jobs &lt;- (i + 1)
		}
		close (jobs) 
	}()</div><div><p>作者回复：好问题！
channel 内部数据是排队的，即便被 close，依然可以从 closed channel 中读取到尚未被消费的元素，直到没有可读的元素为止，才真正会变成 closed 状态。没数据后，如果再读就会得到元素类型的零值了，对于没数据且 closed 状态的 channel，for range 会终止。</p></div><div><div>2022-04-15</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 木木</span></div></div><div>go 的并发原语选择真的是非常精炼：简洁又强大，一个 ch 就负责了线程通信、同步的多种功能；一个 select 又实现了对阻塞、非阻塞的控制以及事件循环模式。</div><div><p>作者回复: 👍</p></div><div><div>2022-03-18</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/32/40/d56f476c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>ibin</span></div></div><div>白老师，你好，下面这段可以模拟 close (groupSignal)
for i := 0;i &lt; 5; i++ {
		groupSignal&lt;-signal (struct {}{})
}
为什么 close (groupSignal) 可以给每个 groupSignal 都发送了 {}</div><div><p>作者回复: close 一个 channel 后，所有阻塞在这个 channel 接收操作的 goroutine 都会收到通知，这是 Go 语言的 channel 语义就这么定义的。</p></div><div><div>2022-01-12</div><div><div><i></i><span>4</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>0mfg</span></div></div><div>白老师好，请教个问题。对于无缓冲通道的结论，“对无缓冲 channel 类型的发送与接收操作，一定要放在两个不同的 Goroutine 中进行，否则会导致 deadlock。” 尝试了如下写法，发送在主 goroutine，接收在新 goroutine 发现还是 deadlock，请问具体原因是啥？谢谢

package main

import "fmt"

func main ()  {
	ch := make (chan int)
	ch &lt;- 13
	go func () {
		n := &lt;- ch
		fmt.Println (n)
	}()
}</div><div><p>作者回复: main goroutine 在执行 ch &lt;-13 时就阻塞住了。还没执行到创建下面那个 goroutine 呢。</p></div><div><div>2022-01-12</div><div><div><i></i><span>4</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/d4/d9/c3296187.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>airmy 丶</span></div></div><div>请问下老师：为什么 "1 对 n 的信号通知机制" 这个例子中，wg.Wait () 一定需要新起一个协程执行呢？而且在本地测试确实只能在新的协程中执行才不会报错，否则会报出: goroutine x [chan receive] 这样的错误。</div><div><p>作者回复: Wait 方法的语义就是等待例子中 for 循环创建的所有子 goroutine，直到每个子 goroutine 都调用完 wg.Done 才返回。如果不再一个新 goroutine 执行，wg.Wait 就会阻塞住 main goroutine，这也将导致后续所有 goroutine 都阻塞住，然后 go 运行时检测到所有 goroutine 都阻塞住了，于是报错退出。</p></div><div><div>2022-05-18</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/b1/54/6d663b95.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 瓜牛</span></div></div><div>为啥有时需要手动调用 close 关闭 channel，有时又不需要？</div><div><p>作者回复：首先明确一点: channel 如果不 close，也不会存在资源泄露的问题。

是否需要 close channel 完全看需要。

至于如何知道何时需要，看文中对 close channel 的语义的描述，以及如何基于这种语义的一些妙用。</p></div><div><div>2022-04-20</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/16/48/01567df1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 郑泽洲</span></div></div><div>这节课需要反复读，举的例子和示例代码都非常好，值得深入思考，只要思考到位，对 channel 认识就能加深一步👍🏻</div><div><p>作者回复: 👍</p></div><div><div>2022-02-19</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/53/a8/abc96f70.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>return</span></div></div><div>太干了，看了几天才看完， 面面俱到了， 各种坑也指点出来了。
收获非常大， 从瞎用 channel，到现在 心里有底，知道该怎么用 channel 了。
非常感谢老师，老师讲的太赞了。
</div><div><p>作者回复: 👍</p></div><div><div>2022-01-20</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lesserror</span></div></div><div>channel 是 Go 并发设计的核心之一，要反复阅读理解。大白老师这里总结的很不错。有以下疑问，麻烦解答。

1. 无缓冲 channel 的惯用法 -&gt; 第一种用法：用作信号传递 。下面的示例代码： c &lt;- signal (struct {}{}) 改成 c &lt;- signal {}  会不会更好一些呢？

2. 无缓冲 channel 替代锁那里。计数器操作全部交给一个独立的 Goroutine 去处理。我的理解是这个 Goroutine 其实最后还是处于阻塞的状态下。最后主 Goroutine 结束运行了。这个 Goroutine 不得不退出了，这么理解对吗？</div><div><p>作者回复: 1. 👍
2. 是的。main goroutine 更关注 "worker" goroutine 的状态，所以只等待了 worker goroutine 的退出。</p></div><div><div>2022-01-16</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/8c/60/58b6c39e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>zzy</span></div></div><div>在 1 对 n 的信号通知 的代码中，并没有看到向 groupSingal 中发送值，接收端不是应该一直阻塞吗？感觉没法走下去</div><div><p>作者回复: 1 对 n 的信号通知使用的是 channel 的关闭机制。close groupSignal 后，所有处于从 groupSignal recv 的 goroutine 都会从对 groupSignal 的 recv 中返回。不会阻塞。</p></div><div><div>2022-07-31</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>每天晒白牙</span></div></div><div>感觉只发送 channel 和只接收 channel 类型定义符号，交换一下更好理解，也更形象吧

make (chan&lt;- int, 1) 这个代表只接收
make (&lt;-chan int, 1) 这个代表只发送</div><div><p>作者回复：由于箭头都是向左的，即 &lt;-，所以我区分只发送和只接收型的 channel 的 tip 是以 chan 这个关键字为中心，将 chan 关键字看成一个 “管子”。当 &lt;- 在 chan 的右边，即 chan &lt;- 好似向管子里写，这样就是只发送型。当 &lt;- 在 chan 的左边，即 &lt;- chan ，好似从管子里取，这样就是只接收型。</p></div><div><div>2022-07-20</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/67/97/96e3f59b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>fgr_SHU</span></div></div><div>2s 后，ch2 被写入了一个数值 7。这样在某一轮 select 的过程中，分支 case x := &lt;-ch2 被选中得以执行，程序输出 7 之后满足退出条件，于是程序终止

具体是哪一轮呢？</div><div><p>作者回复：不确定，具有随机性。</p></div><div><div>2022-07-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3d/70/3d8aa6fc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>小虎</span></div></div><div>“无缓冲 channel 替代锁” 这个示例说到 “这种并发设计逻辑更符合 Go 语言所倡导的 “不要通过共享内存来通信，而是通过通信来共享内存” 的原则。”，没太想明白为什么符合这个原则，goroutine 中调用了 cter.Increase ()，这不是共享了 cter 这个变量吗？</div><div><p>作者回复：这个示例要共享的内存是 “counter 结构中的 i”，而不是 i 的外围结构 counter。cter.Increase 是改变共享内存的方法，里面可以采用共享内存的方式，比如通过 lock 进行同步，也可以通过通信的方式，比如基于 channel.</p></div><div><div>2022-07-13</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/GJXKh8OG00U5ial64plAIibbIuwkzhPc8uYic9Hibl8SbqvhnS2JImHgCD4JGvTktiaVnCjHQWbA5wicaxRUN5aTEWnQ/132"></div></div><div><div><div><span>Geek_a6104e</span></div></div><div>我们原本期望上面这个在依次输出 5 和 7 两个数字后退出，但实际运行的输出结果却是在输出 5 之后，程序输出了许多的 0 值，之后才输出 7 并退出。 使用 comma,ok 语句接收通道 ch 的值 如果 ok 为 true 才打印 这种方式也行 不需要使用 nil 的 channel</div><div><p>作者回复：程序的目的是不让 go 运行时将已经关闭的 channel 再次选出，使用 comma, ok 虽然可以在 ok=false 不打印，但是 select 会多次选择该 closed channel，不符合我们的原意。</p></div><div><div>2022-07-08</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2c/06/35/82915b9b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>五彩斑斓的輝</span></div></div><div>白老师，想问问 go runtime 是如何保证在一发多收的情况下，收到的不会相同的？</div><div><p>作者回复：大致是：在多个阻塞在 channel 上收的 goroutine 中选一个出来恢复 running，然后这个 goroutine 就会将 channel 中数据读出来了。其他 goroutine 还在 blocking 中。</p></div><div><div>2022-06-08</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>0mfg</span></div></div><div>白老师好，1 对 n 的信号通知的示例代码中，signal 是不是没有定义，应该和 1 对 1 的信号通知示例代码一样 type signal struct {} 先定义吧，但是如果先定义的话，c &lt;- signal (struct {}{}) 这句 goland 又提示重复的类型转换了，请教一下老师原本写教程时的想法哈，谢谢</div><div><p>作者回复：你说的没错，需要 type signal struct {} 先定义 。例子之间具有相似性，这块没贴出来。

另外 c &lt;- signal (struct {}{}) 直接用 c &lt;- signal {} 就行了。

稍后让编辑老师帮忙改一下，感谢指出。</p></div><div><div>2022-05-10</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/98/b1/f89a84d0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Casper</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>百老师，在本文中的带缓冲 channel 当作消息队列处理部分，给定的性能测试代码中，func init () {c1 = make (chan string)
	for i := 0; i &lt; 10; i++ {
		go func () {
			for {
				&lt;-c1 //read
			}
		}()
		go func () {
			for {
				c1 &lt;- "hello"  //send
			}
		}()
	}

	c2 = make (chan string)
	for i := 0; i &lt; 10; i++ {
		go func () {
			for {
				c2 &lt;- "hello"
			}
		}()
		go func () {
			for {
				&lt;-c2
			}
		}()
	}
}
channel c1 其实一致处在接收和发送数据中，在做性能测试的时候，其实是通过后面的 send 函数调用来发送值，用这个发送动作来进行性能测试。我这么理解正确吗？希望能得到老师的回复，谢谢白老师。</div><div><p>作者回复：嗯，用在 “队列场景” 中，要评估 channel 作为 queue 的收发性能，肯定是用收或发在单位时间内的次数来衡量的。</p></div><div><div>2022-04-22</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/2b/80/2535381c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>莫鸣之名</span></div></div><div>看不懂了，得慢慢啃才行😂</div><div><p>作者回复：别急，慢慢来，💪</p></div><div><div>2022-04-20</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".17"><outline class="toc-level-h1" data-reactid=".17.0" style="width: 175px;"><active data-reactid=".17.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".17.0.1"><span data-reactid=".17.0.1.0"> 33｜并发：小 channel 中蕴含大智慧</span></a></outline><outline class="toc-level-h2" data-reactid=".17.1" style="width: 165px;"><active data-reactid=".17.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".17.1.1"><span data-reactid=".17.1.1.0">作为一等公民的 channel</span></a></outline><outline class="toc-level-h3" data-reactid=".17.2" style="width: 155px;"><active data-reactid=".17.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".17.2.1"><span data-reactid=".17.2.1.0">创建 channel</span></a></outline><outline class="toc-level-h3" data-reactid=".17.3" style="width: 155px;"><active data-reactid=".17.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".17.3.1"><span data-reactid=".17.3.1.0">发送与接收</span></a></outline><outline class="toc-level-h3" data-reactid=".17.4" style="width: 155px;"><active data-reactid=".17.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".17.4.1"><span data-reactid=".17.4.1.0">关闭 channel</span></a></outline><outline class="toc-level-h3" data-reactid=".17.5" style="width: 155px;"><active data-reactid=".17.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".17.5.1"><span data-reactid=".17.5.1.0">select</span></a></outline><outline class="toc-level-h2" data-reactid=".17.6" style="width: 165px;"><active data-reactid=".17.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".17.6.1"><span data-reactid=".17.6.1.0">无缓冲 channel 的惯用法</span></a></outline><outline class="toc-level-h3" data-reactid=".17.7" style="width: 155px;"><active data-reactid=".17.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".17.7.1"><span data-reactid=".17.7.1.0">第一种用法：用作信号传递</span></a></outline><outline class="toc-level-h3" data-reactid=".17.8" style="width: 155px;"><active data-reactid=".17.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".17.8.1"><span data-reactid=".17.8.1.0">第二种用法：用于替代锁机制</span></a></outline><outline class="toc-level-h2" data-reactid=".17.9" style="width: 165px;"><active data-reactid=".17.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".17.9.1"><span data-reactid=".17.9.1.0">带缓冲 channel 的惯用法</span></a></outline><outline class="toc-level-h3" data-reactid=".17.a" style="width: 155px;"><active data-reactid=".17.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".17.a.1"><span data-reactid=".17.a.1.0">第一种用法：用作消息队列</span></a></outline><outline class="toc-level-h3" data-reactid=".17.b" style="width: 155px;"><active data-reactid=".17.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".17.b.1"><span data-reactid=".17.b.1.0">第二种用法：用作计数信号量（counting semaphore）</span></a></outline><outline class="toc-level-h3" data-reactid=".17.c" style="width: 155px;"><active data-reactid=".17.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".17.c.1"><span data-reactid=".17.c.1.0">len (channel) 的应用</span></a></outline><outline class="toc-level-h2" data-reactid=".17.d" style="width: 165px;"><active data-reactid=".17.d.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".17.d.1"><span data-reactid=".17.d.1.0">nil channel 的妙用</span></a></outline><outline class="toc-level-h2" data-reactid=".17.e" style="width: 165px;"><active data-reactid=".17.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".17.e.1"><span data-reactid=".17.e.1.0">与 select 结合使用的一些惯用法</span></a></outline><outline class="toc-level-h3" data-reactid=".17.f" style="width: 155px;"><active data-reactid=".17.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".17.f.1"><span data-reactid=".17.f.1.0">第一种用法：利用 default 分支避免阻塞</span></a></outline><outline class="toc-level-h3" data-reactid=".17.g" style="width: 155px;"><active data-reactid=".17.g.0"></active><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".17.g.1"><span data-reactid=".17.g.1.0">第二种用法：实现超时机制</span></a></outline><outline class="toc-level-h3" data-reactid=".17.h" style="width: 155px;"><active data-reactid=".17.h.0"></active><a class="toc-outline-theme-github" href="#sr-toc-17" data-reactid=".17.h.1"><span data-reactid=".17.h.1.0">第三种用法：实现心跳机制</span></a></outline><outline class="toc-level-h2" data-reactid=".17.i" style="width: 165px;"><active data-reactid=".17.i.0"></active><a class="toc-outline-theme-github" href="#sr-toc-18" data-reactid=".17.i.1"><span data-reactid=".17.i.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".17.j" style="width: 165px;"><active data-reactid=".17.j.0"></active><a class="toc-outline-theme-github" href="#sr-toc-19" data-reactid=".17.j.1"><span data-reactid=".17.j.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".17.k" style="width: 165px;"><active data-reactid=".17.k.0"></active><a class="toc-outline-theme-github" href="#sr-toc-20" data-reactid=".17.k.1"><span data-reactid=".17.k.1.0">精选留言 (29)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/477365" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>