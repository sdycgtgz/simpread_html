
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 41 | 服务接口：如何搭建沟通桥梁？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>41 | 服务接口：如何搭建沟通桥梁？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我们通过动手写个驱动程序体会 Linux 驱动相关的内容。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">41 | 服务接口：如何搭建沟通桥梁？</h1><div><span>LMOS</span> <span>2021-08-11</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/34/e3/345623bd810902ba2fdb7yy2fbf632e3.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：11.90M</span><span> 时长：13:01</span></div></div><audio title="41 | 服务接口：如何搭建沟通桥梁？" src="https://res001.geekbang.org/media/audio/3e/c5/3e9e4e79a5718c292eea6d3c69c747c5/ld/ld.m3u8" __idm_id__="958475"></audio></div><div><div><div><div data-slate-editor="true" data-key="12270" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="12271"><span data-slate-object="text" data-key="12272"><span data-slate-leaf="true" data-offset-key="12272:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12273"><span data-slate-object="text" data-key="12274"><span data-slate-leaf="true" data-offset-key="12274:0" data-first-offset="true"><span data-slate-string="true">一路走来，咱们的 Cosmos 系统已经有内存管理，进程、文件、I/O 了，这些重要的组件已经建立了，也就是说它们可以向应用程序提供服务了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12275"><span data-slate-object="text" data-key="12276"><span data-slate-leaf="true" data-offset-key="12276:0" data-first-offset="true"><span data-slate-string="true">但就好像你去各政府部门办理业务证件一样，首先是前台工作人员接待你，对你的业务需求进行初级预判，然后后台人员进行审核并进行业务办理，最后由前台人员回复，并且给你开好相关业务证件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12277"><span data-slate-object="text" data-key="12278"><span data-slate-leaf="true" data-offset-key="12278:0" data-first-offset="true"><span data-slate-string="true">今天，我们就来实现 Cosmos 下的 “前台工作人员”，我们称之为服务接口，也可以说是 Cosmos 的 API。代码你可以从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12279"><span data-slate-object="text" data-key="12280"><span data-slate-leaf="true" data-offset-key="12280:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="12281"><span data-slate-leaf="true" data-offset-key="12281:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12282" id="sr-toc-1"><span data-slate-object="text" data-key="12283"><span data-slate-leaf="true" data-offset-key="12283:0" data-first-offset="true"><span data-slate-string="true">服务接口的结构</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12284"><span data-slate-object="text" data-key="12285"><span data-slate-leaf="true" data-offset-key="12285:0" data-first-offset="true"><span data-slate-string="true">我们先来设计一下服务接口的整体结构，即 Cosmos 的 API 结构。因为 Cosmos 的 API 数量很多，所以我们先来分个类，它们分别是进程类、内存类、文件类和时间类的 API。这些 API 还会被上层 C 库封装，方便应用程序调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12286"><span data-slate-object="text" data-key="12287"><span data-slate-leaf="true" data-offset-key="12287:0" data-first-offset="true"><span data-slate-string="true">为了帮你理解它们之间的关系，我为你准备了一幅图，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="12288"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/05/55/051a8aa336a0d8a547a610cb0d296e55.jpg?wh=3459x3694"></div><div>API 框架</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12289"><span data-slate-object="text" data-key="12290"><span data-slate-leaf="true" data-offset-key="12290:0" data-first-offset="true"><span data-slate-string="true">结合上图可以看到，我们的应用程序库分为时间库、进程库、内存库、文件库这几种类型。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12291"><span data-slate-object="text" data-key="12292"><span data-slate-leaf="true" data-offset-key="12292:0" data-first-offset="true"><span data-slate-string="true">通常情况下，应用程序中调用的是一些库函数。库函数是对系统服务的封装，有的库函数是直接调用相应的系统服务；而有的库函数为了完成特定的功能，则调用了几个相应的系统服务；还有一些库函数完成的功能不需要调用相应的系统调用，这时前台接待人员也就是 “库函数”，可以自行处理。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12293" id="sr-toc-2"><span data-slate-object="text" data-key="12294"><span data-slate-leaf="true" data-offset-key="12294:0" data-first-offset="true"><span data-slate-string="true">如何进入内核</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12295"><span data-slate-object="text" data-key="12296"><span data-slate-leaf="true" data-offset-key="12296:0" data-first-offset="true"><span data-slate-string="true">由上图我们还可以看出，应用程序和库函数都在用户空间中，而系统服务却在内核空间中，想要让代码控制流从用户空间进入到内核空间中，如何穿过 CPU 保护模式的 “铜墙铁壁” 才是关键。下面我们就一起来探索这个问题。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12297" id="sr-toc-3"><span data-slate-object="text" data-key="12298"><span data-slate-leaf="true" data-offset-key="12298:0" data-first-offset="true"><span data-slate-string="true">软中断指令</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12299"><span data-slate-object="text" data-key="12300"><span data-slate-leaf="true" data-offset-key="12300:0" data-first-offset="true"><span data-slate-string="true">请你回忆下，CPU 长模式下如何处理中断的（不熟悉的可以回看</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12301"><span data-slate-object="text" data-key="12302"><span data-slate-leaf="true" data-offset-key="12302:0" data-first-offset="true"><span data-slate-string="true">第 5 课</span></span></span></a><span data-slate-object="text" data-key="12303"><span data-slate-leaf="true" data-offset-key="12303:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12304"><span data-slate-object="text" data-key="12305"><span data-slate-leaf="true" data-offset-key="12305:0" data-first-offset="true"><span data-slate-string="true">第 13 课</span></span></span></a><span data-slate-object="text" data-key="12306"><span data-slate-leaf="true" data-offset-key="12306:0" data-first-offset="true"><span data-slate-string="true">）？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12307"><span data-slate-object="text" data-key="12308"><span data-slate-leaf="true" data-offset-key="12308:0" data-first-offset="true"><span data-slate-string="true">设备向 CPU 发送一个中断信号，CPU 接受到这个电子信号后，在允许响应中断的情况下，就会中断当前正在运行的程序，</span></span><span data-slate-leaf="true" data-offset-key="12308:1"><span data-slate-object="annotation" data-annotation-key="gkann_671ea986" data-attr-id="43359" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">自动切换到相应的 CPU R0 特权级，并跳转到中断门描述符中相应的地址上运行中断处理代码。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12309"><span data-slate-object="text" data-key="12310"><span data-slate-leaf="true" data-offset-key="12310:0" data-first-offset="true"><span data-slate-string="true">当然，这里的中断处理代码就是操作系统内核的代码，这样 CPU 的控制权就转到操作系统内核的手中了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12311"><span data-slate-object="text" data-key="12312"><span data-slate-leaf="true" data-offset-key="12312:0" data-first-offset="true"><span data-slate-string="true">其实，</span></span><span data-slate-leaf="true" data-offset-key="12312:1"><span data-slate-object="annotation" data-annotation-key="gkann_406cb844" data-attr-id="38129" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">应用软件也可以给 CPU 发送中断。</span></span></span><span data-slate-leaf="true" data-offset-key="12312:2"><span data-slate-string="true">现代 CPU 设计时都会设计这样一条指令，一旦执行该指令，CPU 就要中断当前正在运行的程序，自动跳转到相应的固定地址上运行代码。当然这里的代码也就是操作系统内核的代码，就这样 CPU 的控制权同样会回到操作系统内核的手中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12313"><span data-slate-object="text" data-key="12314"><span data-slate-leaf="true" data-offset-key="12314:0" data-first-offset="true"><span data-slate-string="true">因为这条指令模拟了中断的电子信号，所以称为</span></span></span><span data-slate-object="text" data-key="12315"><span data-slate-leaf="true" data-offset-key="12315:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">软中断指令</span></span></span></span><span data-slate-object="text" data-key="12316"><span data-slate-leaf="true" data-offset-key="12316:0" data-first-offset="true"><span data-slate-string="true">。在 x86 CPU 上这条指令是 int 指令。例如 int255。int 指令后面需要跟一个常数，这个常数表示 CPU 从中断表描述符表中取得</span></span></span><span data-slate-object="text" data-key="12317"><span data-slate-leaf="true" data-offset-key="12317:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第几个中断描述符</span></span></span></span><span data-slate-object="text" data-key="12318"><span data-slate-leaf="true" data-offset-key="12318:0" data-first-offset="true"><span data-slate-string="true">进入内核。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12319" id="sr-toc-4"><span data-slate-object="text" data-key="12320"><span data-slate-leaf="true" data-offset-key="12320:0" data-first-offset="true"><span data-slate-string="true">传递参数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12321"><span data-slate-object="text" data-key="12322"><span data-slate-leaf="true" data-offset-key="12322:0" data-first-offset="true"><span data-slate-string="true">虽然 int 指令提供了应用程序进入操作系统内核函数的底层机制，但是我们还需要解决参数传递的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12323"><span data-slate-object="text" data-key="12324"><span data-slate-leaf="true" data-offset-key="12324:0" data-first-offset="true"><span data-slate-string="true">因为你必须要告诉操作系统你要干什么，系统才能做出相应的反馈。比如你要分配内存，分配多大的内存，这些信息必须要以参数的形式传递给操作系统内核。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12325"><span data-slate-object="text" data-key="12326"><span data-slate-leaf="true" data-offset-key="12326:0" data-first-offset="true"><span data-slate-string="true">因为应用程序运行在用户空间时，用的是用户栈，当它切换到内核空间时，用的是内核栈。所以参数的传递，就需要硬性地规定一下，要么所有的参数都用寄存器传递，要么所有的参数都保存在用户栈中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12327"><span data-slate-object="text" data-key="12328"><span data-slate-leaf="true" data-offset-key="12328:0" data-first-offset="true"><span data-slate-string="true">显然，第一种用寄存器传递所有参数的方法要简单得多，事实上有很多操作系统就是用寄存器传递参数的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12329"><span data-slate-object="text" data-key="12330"><span data-slate-leaf="true" data-offset-key="12330:0" data-first-offset="true"><span data-slate-string="true">我们使用 RBX、RCX、RDX、RDI、RSI 这 5 个寄存器来传递参数，事实上一个系统服务接口函数不会超过 5 个参数，所以这是足够的。而 RAX 寄存器中保存着一个整数，称为</span></span></span><span data-slate-object="text" data-key="12331"><span data-slate-leaf="true" data-offset-key="12331:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">系统服务号</span></span></span></span><span data-slate-object="text" data-key="12332"><span data-slate-leaf="true" data-offset-key="12332:0" data-first-offset="true"><span data-slate-string="true">。在系统服务分发器中，会根据这个系统服务号调用相应的函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12333"><span data-slate-object="text" data-key="12334"><span data-slate-leaf="true" data-offset-key="12334:0" data-first-offset="true"><span data-slate-string="true">因为 C 编译器不能处理这种参数传递形式，另外 C 编译器也不支持 int 指令，所以要用汇编代码来处理这种问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12335"><span data-slate-object="text" data-key="12336"><span data-slate-leaf="true" data-offset-key="12336:0" data-first-offset="true"><span data-slate-string="true">下面我们来建立一个 cosmos/include/libinc/lapinrentry.h 文件，在这里写上后面的代码。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12337"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12338"><span data-slate-object="text" data-key="12339"><span data-slate-leaf="true" data-offset-key="12339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 传递一个参数所用的宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12340"><span data-slate-object="text" data-key="12341"><span data-slate-leaf="true" data-offset-key="12341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12342"><span data-slate-leaf="true" data-offset-key="12342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12343"><span data-slate-leaf="true" data-offset-key="12343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> API_ENTRY_PARE1(intnr,rets,pval1) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12344"><span data-slate-object="text" data-key="12345"><span data-slate-leaf="true" data-offset-key="12345:0" data-first-offset="true"><span data-slate-string="true">__asm__ __volatile__(\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12346"><span data-slate-object="text" data-key="12347"><span data-slate-leaf="true" data-offset-key="12347:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12348"><span data-slate-leaf="true" data-offset-key="12348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[inr],%%rax\n\t"</span></span></span></span><span data-slate-object="text" data-key="12349"><span data-slate-leaf="true" data-offset-key="12349:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12350"><span data-slate-leaf="true" data-offset-key="12350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 系统服务号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12351"><span data-slate-object="text" data-key="12352"><span data-slate-leaf="true" data-offset-key="12352:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12353"><span data-slate-leaf="true" data-offset-key="12353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[prv1],%%rbx\n\t"</span></span></span></span><span data-slate-object="text" data-key="12354"><span data-slate-leaf="true" data-offset-key="12354:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12355"><span data-slate-leaf="true" data-offset-key="12355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第一个参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12356"><span data-slate-object="text" data-key="12357"><span data-slate-leaf="true" data-offset-key="12357:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12358"><span data-slate-leaf="true" data-offset-key="12358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"int $255 \n\t"</span></span></span></span><span data-slate-object="text" data-key="12359"><span data-slate-leaf="true" data-offset-key="12359:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12360"><span data-slate-leaf="true" data-offset-key="12360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 触发中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12361"><span data-slate-object="text" data-key="12362"><span data-slate-leaf="true" data-offset-key="12362:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12363"><span data-slate-leaf="true" data-offset-key="12363:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %%rax,%[retval] \n\t"</span></span></span></span><span data-slate-object="text" data-key="12364"><span data-slate-leaf="true" data-offset-key="12364:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12365"><span data-slate-leaf="true" data-offset-key="12365:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理返回结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12366"><span data-slate-object="text" data-key="12367"><span data-slate-leaf="true" data-offset-key="12367:0" data-first-offset="true"><span data-slate-string="true">         :[retval] </span></span></span><span data-slate-object="text" data-key="12368"><span data-slate-leaf="true" data-offset-key="12368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=r"</span></span></span></span><span data-slate-object="text" data-key="12369"><span data-slate-leaf="true" data-offset-key="12369:0" data-first-offset="true"><span data-slate-string="true"> (rets)\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12370"><span data-slate-object="text" data-key="12371"><span data-slate-leaf="true" data-offset-key="12371:0" data-first-offset="true"><span data-slate-string="true">         :[inr] </span></span></span><span data-slate-object="text" data-key="12372"><span data-slate-leaf="true" data-offset-key="12372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="12373"><span data-slate-leaf="true" data-offset-key="12373:0" data-first-offset="true"><span data-slate-string="true"> (intnr),[prv1]</span></span></span><span data-slate-object="text" data-key="12374"><span data-slate-leaf="true" data-offset-key="12374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="12375"><span data-slate-leaf="true" data-offset-key="12375:0" data-first-offset="true"><span data-slate-string="true"> (pval1)\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12376"><span data-slate-object="text" data-key="12377"><span data-slate-leaf="true" data-offset-key="12377:0" data-first-offset="true"><span data-slate-string="true">         :</span></span></span><span data-slate-object="text" data-key="12378"><span data-slate-leaf="true" data-offset-key="12378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rax"</span></span></span></span><span data-slate-object="text" data-key="12379"><span data-slate-leaf="true" data-offset-key="12379:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12380"><span data-slate-leaf="true" data-offset-key="12380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rbx"</span></span></span></span><span data-slate-object="text" data-key="12381"><span data-slate-leaf="true" data-offset-key="12381:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12382"><span data-slate-leaf="true" data-offset-key="12382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cc"</span></span></span></span><span data-slate-object="text" data-key="12383"><span data-slate-leaf="true" data-offset-key="12383:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12384"><span data-slate-leaf="true" data-offset-key="12384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="12385"><span data-slate-leaf="true" data-offset-key="12385:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12386"><span data-slate-object="text" data-key="12387"><span data-slate-leaf="true" data-offset-key="12387:0" data-first-offset="true"><span data-slate-string="true">    )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12388"><span data-slate-object="text" data-key="12389"><span data-slate-leaf="true" data-offset-key="12389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 传递四个参数所用的宏    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12390"><span data-slate-object="text" data-key="12391"><span data-slate-leaf="true" data-offset-key="12391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="12392"><span data-slate-leaf="true" data-offset-key="12392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="12393"><span data-slate-leaf="true" data-offset-key="12393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> API_ENTRY_PARE4(intnr,rets,pval1,pval2,pval3,pval4) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12394"><span data-slate-object="text" data-key="12395"><span data-slate-leaf="true" data-offset-key="12395:0" data-first-offset="true"><span data-slate-string="true">__asm__ __volatile__(\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12396"><span data-slate-object="text" data-key="12397"><span data-slate-leaf="true" data-offset-key="12397:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12398"><span data-slate-leaf="true" data-offset-key="12398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[inr],%%rax \n\t"</span></span></span></span><span data-slate-object="text" data-key="12399"><span data-slate-leaf="true" data-offset-key="12399:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12400"><span data-slate-leaf="true" data-offset-key="12400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 系统服务号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12401"><span data-slate-object="text" data-key="12402"><span data-slate-leaf="true" data-offset-key="12402:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12403"><span data-slate-leaf="true" data-offset-key="12403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[prv1],%%rbx \n\t"</span></span></span></span><span data-slate-object="text" data-key="12404"><span data-slate-leaf="true" data-offset-key="12404:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12405"><span data-slate-leaf="true" data-offset-key="12405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第一个参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12406"><span data-slate-object="text" data-key="12407"><span data-slate-leaf="true" data-offset-key="12407:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12408"><span data-slate-leaf="true" data-offset-key="12408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[prv2],%%rcx \n\t"</span></span></span></span><span data-slate-object="text" data-key="12409"><span data-slate-leaf="true" data-offset-key="12409:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12410"><span data-slate-leaf="true" data-offset-key="12410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第二个参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12411"><span data-slate-object="text" data-key="12412"><span data-slate-leaf="true" data-offset-key="12412:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12413"><span data-slate-leaf="true" data-offset-key="12413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[prv3],%%rdx \n\t"</span></span></span></span><span data-slate-object="text" data-key="12414"><span data-slate-leaf="true" data-offset-key="12414:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12415"><span data-slate-leaf="true" data-offset-key="12415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第三个参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12416"><span data-slate-object="text" data-key="12417"><span data-slate-leaf="true" data-offset-key="12417:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12418"><span data-slate-leaf="true" data-offset-key="12418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %[prv4],%%rsi \n\t"</span></span></span></span><span data-slate-object="text" data-key="12419"><span data-slate-leaf="true" data-offset-key="12419:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12420"><span data-slate-leaf="true" data-offset-key="12420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第四个参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12421"><span data-slate-object="text" data-key="12422"><span data-slate-leaf="true" data-offset-key="12422:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12423"><span data-slate-leaf="true" data-offset-key="12423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"int $255 \n\t"</span></span></span></span><span data-slate-object="text" data-key="12424"><span data-slate-leaf="true" data-offset-key="12424:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12425"><span data-slate-leaf="true" data-offset-key="12425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 触发中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12426"><span data-slate-object="text" data-key="12427"><span data-slate-leaf="true" data-offset-key="12427:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="12428"><span data-slate-leaf="true" data-offset-key="12428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movq %%rax,%[retval] \n\t"</span></span></span></span><span data-slate-object="text" data-key="12429"><span data-slate-leaf="true" data-offset-key="12429:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span><span data-slate-object="text" data-key="12430"><span data-slate-leaf="true" data-offset-key="12430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理返回结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12431"><span data-slate-object="text" data-key="12432"><span data-slate-leaf="true" data-offset-key="12432:0" data-first-offset="true"><span data-slate-string="true">         :[retval] </span></span></span><span data-slate-object="text" data-key="12433"><span data-slate-leaf="true" data-offset-key="12433:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=r"</span></span></span></span><span data-slate-object="text" data-key="12434"><span data-slate-leaf="true" data-offset-key="12434:0" data-first-offset="true"><span data-slate-string="true"> (rets)\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12435"><span data-slate-object="text" data-key="12436"><span data-slate-leaf="true" data-offset-key="12436:0" data-first-offset="true"><span data-slate-string="true">         :[inr] </span></span></span><span data-slate-object="text" data-key="12437"><span data-slate-leaf="true" data-offset-key="12437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="12438"><span data-slate-leaf="true" data-offset-key="12438:0" data-first-offset="true"><span data-slate-string="true"> (intnr),[prv1]</span></span></span><span data-slate-object="text" data-key="12439"><span data-slate-leaf="true" data-offset-key="12439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g"</span></span></span></span><span data-slate-object="text" data-key="12440"><span data-slate-leaf="true" data-offset-key="12440:0" data-first-offset="true"><span data-slate-string="true"> (pval1),\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12441"><span data-slate-object="text" data-key="12442"><span data-slate-leaf="true" data-offset-key="12442:0" data-first-offset="true"><span data-slate-string="true">         [prv2] </span></span></span><span data-slate-object="text" data-key="12443"><span data-slate-leaf="true" data-offset-key="12443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g"</span></span></span></span><span data-slate-object="text" data-key="12444"><span data-slate-leaf="true" data-offset-key="12444:0" data-first-offset="true"><span data-slate-string="true"> (pval2),[prv3]</span></span></span><span data-slate-object="text" data-key="12445"><span data-slate-leaf="true" data-offset-key="12445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g"</span></span></span></span><span data-slate-object="text" data-key="12446"><span data-slate-leaf="true" data-offset-key="12446:0" data-first-offset="true"><span data-slate-string="true"> (pval3),\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12447"><span data-slate-object="text" data-key="12448"><span data-slate-leaf="true" data-offset-key="12448:0" data-first-offset="true"><span data-slate-string="true">         [prv4] </span></span></span><span data-slate-object="text" data-key="12449"><span data-slate-leaf="true" data-offset-key="12449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g"</span></span></span></span><span data-slate-object="text" data-key="12450"><span data-slate-leaf="true" data-offset-key="12450:0" data-first-offset="true"><span data-slate-string="true"> (pval4)\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12451"><span data-slate-object="text" data-key="12452"><span data-slate-leaf="true" data-offset-key="12452:0" data-first-offset="true"><span data-slate-string="true">         :</span></span></span><span data-slate-object="text" data-key="12453"><span data-slate-leaf="true" data-offset-key="12453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rax"</span></span></span></span><span data-slate-object="text" data-key="12454"><span data-slate-leaf="true" data-offset-key="12454:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12455"><span data-slate-leaf="true" data-offset-key="12455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rbx"</span></span></span></span><span data-slate-object="text" data-key="12456"><span data-slate-leaf="true" data-offset-key="12456:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12457"><span data-slate-leaf="true" data-offset-key="12457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rcx"</span></span></span></span><span data-slate-object="text" data-key="12458"><span data-slate-leaf="true" data-offset-key="12458:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12459"><span data-slate-leaf="true" data-offset-key="12459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rdx"</span></span></span></span><span data-slate-object="text" data-key="12460"><span data-slate-leaf="true" data-offset-key="12460:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12461"><span data-slate-leaf="true" data-offset-key="12461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rsi"</span></span></span></span><span data-slate-object="text" data-key="12462"><span data-slate-leaf="true" data-offset-key="12462:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12463"><span data-slate-leaf="true" data-offset-key="12463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cc"</span></span></span></span><span data-slate-object="text" data-key="12464"><span data-slate-leaf="true" data-offset-key="12464:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="12465"><span data-slate-leaf="true" data-offset-key="12465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="12466"><span data-slate-leaf="true" data-offset-key="12466:0" data-first-offset="true"><span data-slate-string="true">\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12467"><span data-slate-object="text" data-key="12468"><span data-slate-leaf="true" data-offset-key="12468:0" data-first-offset="true"><span data-slate-string="true">    )</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12469"><span data-slate-object="text" data-key="12470"><span data-slate-leaf="true" data-offset-key="12470:0" data-first-offset="true"><span data-slate-string="true">上述代码中只展示了两个宏。其实是有四个，在代码文件中我已经帮你写好了，主要功能是用来解决传递参数和触发中断问题，并且还需要处理系统返回的结果。这些都是用 C 语言中嵌入汇编代码的方式来实现的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12471"><span data-slate-object="text" data-key="12472"><span data-slate-leaf="true" data-offset-key="12472:0" data-first-offset="true"><span data-slate-string="true">下面我们用它来写一个系统服务接口，代码如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="12473"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12474"><span data-slate-object="text" data-key="12475"><span data-slate-leaf="true" data-offset-key="12475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 请求分配内存服务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12476"><span data-slate-object="text" data-key="12477"><span data-slate-leaf="true" data-offset-key="12477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12478"><span data-slate-leaf="true" data-offset-key="12478:0" data-first-offset="true"><span data-slate-string="true">* </span></span></span><span data-slate-object="text" data-key="12479"><span data-slate-leaf="true" data-offset-key="12479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">api_mallocblk</span></span></span></span><span data-slate-object="text" data-key="12480"><span data-slate-leaf="true" data-offset-key="12480:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12481"><span data-slate-leaf="true" data-offset-key="12481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t blksz</span></span></span></span><span data-slate-object="text" data-key="12482"><span data-slate-leaf="true" data-offset-key="12482:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12483"><span data-slate-object="text" data-key="12484"><span data-slate-leaf="true" data-offset-key="12484:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12485"><span data-slate-object="text" data-key="12486"><span data-slate-leaf="true" data-offset-key="12486:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12487"><span data-slate-leaf="true" data-offset-key="12487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12488"><span data-slate-leaf="true" data-offset-key="12488:0" data-first-offset="true"><span data-slate-string="true">* retadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12489"><span data-slate-object="text" data-key="12490"><span data-slate-leaf="true" data-offset-key="12490:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12491"><span data-slate-leaf="true" data-offset-key="12491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把系统服务号，返回变量和请求分配的内存大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12492"><span data-slate-object="text" data-key="12493"><span data-slate-leaf="true" data-offset-key="12493:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12494"><span data-slate-leaf="true" data-offset-key="12494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">API_ENTRY_PARE1</span></span></span></span><span data-slate-object="text" data-key="12495"><span data-slate-leaf="true" data-offset-key="12495:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12496"><span data-slate-leaf="true" data-offset-key="12496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INR_MM_ALLOC</span></span></span></span><span data-slate-object="text" data-key="12497"><span data-slate-leaf="true" data-offset-key="12497:0" data-first-offset="true"><span data-slate-string="true">,retadr,blksz);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12498"><span data-slate-object="text" data-key="12499"><span data-slate-leaf="true" data-offset-key="12499:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12500"><span data-slate-leaf="true" data-offset-key="12500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12501"><span data-slate-leaf="true" data-offset-key="12501:0" data-first-offset="true"><span data-slate-string="true"> retadr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12502"><span data-slate-object="text" data-key="12503"><span data-slate-leaf="true" data-offset-key="12503:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12504"><span data-slate-object="text" data-key="12505"><span data-slate-leaf="true" data-offset-key="12505:0" data-first-offset="true"><span data-slate-string="true">上述代码可以被库函数调用，也可以由应用程序直接调用，它用 API_ENTRY_PARE1 宏传递参数和触发中断进入 Cosmos 内核，最终将由内存管理模块相应分配内存服务的请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12506"><span data-slate-object="text" data-key="12507"><span data-slate-leaf="true" data-offset-key="12507:0" data-first-offset="true"><span data-slate-string="true">到这里，我们已经解决了如何进入内核和传递参数的问题了，下面我们看看进入内核之后要做些什么。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12508" id="sr-toc-5"><span data-slate-object="text" data-key="12509"><span data-slate-leaf="true" data-offset-key="12509:0" data-first-offset="true"><span data-slate-string="true">系统服务分发器</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12510"><span data-slate-object="text" data-key="12511"><span data-slate-leaf="true" data-offset-key="12511:0" data-first-offset="true"><span data-slate-string="true">由于执行了 int 指令后，CPU 会停止当前代码执行，转而执行对应的中断处理代码。再加上随着系统功能的增加，系统服务也会增加，但是中断的数量却是有限的，所以我们不能每个系统服务都占用一个中断描述符。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12512"><span data-slate-object="text" data-key="12513"><span data-slate-leaf="true" data-offset-key="12513:0" data-first-offset="true"><span data-slate-string="true">那这个问题怎么解决呢？其实我们可以只使用一个中断描述符，然后通过系统服务号来区分是哪个服务。这其实就是</span></span></span><span data-slate-object="text" data-key="12514"><span data-slate-leaf="true" data-offset-key="12514:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">系统服务器分发器</span></span></span></span><span data-slate-object="text" data-key="12515"><span data-slate-leaf="true" data-offset-key="12515:0" data-first-offset="true"><span data-slate-string="true">完成的工作。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12516" id="sr-toc-6"><span data-slate-object="text" data-key="12517"><span data-slate-leaf="true" data-offset-key="12517:0" data-first-offset="true"><span data-slate-string="true">实现系统服务分发器</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12518"><span data-slate-object="text" data-key="12519"><span data-slate-leaf="true" data-offset-key="12519:0" data-first-offset="true"><span data-slate-string="true">其实系统服务分发器就是一个函数，它由中断处理代码调用，在它的内部根据系统服务号来调用相应的服务。下面我们一起在 cosmos/kernel/krlservice.c 文件中写好这个函数，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12520"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12521"><span data-slate-object="text" data-key="12522"><span data-slate-leaf="true" data-offset-key="12522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span></span><span data-slate-object="text" data-key="12523"><span data-slate-leaf="true" data-offset-key="12523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12524"><span data-slate-leaf="true" data-offset-key="12524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlservice</span></span></span></span></span><span data-slate-object="text" data-key="12525"><span data-slate-leaf="true" data-offset-key="12525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12526"><span data-slate-leaf="true" data-offset-key="12526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12527"><span data-slate-leaf="true" data-offset-key="12527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> inr, </span></span></span></span></span><span data-slate-object="text" data-key="12528"><span data-slate-leaf="true" data-offset-key="12528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12529"><span data-slate-leaf="true" data-offset-key="12529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* sframe)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12530"><span data-slate-object="text" data-key="12531"><span data-slate-leaf="true" data-offset-key="12531:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12532"><span data-slate-object="text" data-key="12533"><span data-slate-leaf="true" data-offset-key="12533:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12534"><span data-slate-leaf="true" data-offset-key="12534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12535"><span data-slate-leaf="true" data-offset-key="12535:0" data-first-offset="true"><span data-slate-string="true">(INR_MAX &lt;= inr)</span></span></span><span data-slate-object="text" data-key="12536"><span data-slate-leaf="true" data-offset-key="12536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断服务号是否大于最大服务号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12537"><span data-slate-object="text" data-key="12538"><span data-slate-leaf="true" data-offset-key="12538:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12539"><span data-slate-object="text" data-key="12540"><span data-slate-leaf="true" data-offset-key="12540:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12541"><span data-slate-leaf="true" data-offset-key="12541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12542"><span data-slate-leaf="true" data-offset-key="12542:0" data-first-offset="true"><span data-slate-string="true"> SYSSTUSERR;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12543"><span data-slate-object="text" data-key="12544"><span data-slate-leaf="true" data-offset-key="12544:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12545"><span data-slate-object="text" data-key="12546"><span data-slate-leaf="true" data-offset-key="12546:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12547"><span data-slate-leaf="true" data-offset-key="12547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12548"><span data-slate-leaf="true" data-offset-key="12548:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12549"><span data-slate-leaf="true" data-offset-key="12549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12550"><span data-slate-leaf="true" data-offset-key="12550:0" data-first-offset="true"><span data-slate-string="true"> == osservicetab[inr])</span></span></span><span data-slate-object="text" data-key="12551"><span data-slate-leaf="true" data-offset-key="12551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断是否有服务接口函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12552"><span data-slate-object="text" data-key="12553"><span data-slate-leaf="true" data-offset-key="12553:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12554"><span data-slate-object="text" data-key="12555"><span data-slate-leaf="true" data-offset-key="12555:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12556"><span data-slate-leaf="true" data-offset-key="12556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12557"><span data-slate-leaf="true" data-offset-key="12557:0" data-first-offset="true"><span data-slate-string="true"> SYSSTUSERR;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12558"><span data-slate-object="text" data-key="12559"><span data-slate-leaf="true" data-offset-key="12559:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12560"><span data-slate-object="text" data-key="12561"><span data-slate-leaf="true" data-offset-key="12561:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12562"><span data-slate-leaf="true" data-offset-key="12562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12563"><span data-slate-leaf="true" data-offset-key="12563:0" data-first-offset="true"><span data-slate-string="true"> osservicetab[inr](inr, (</span></span></span><span data-slate-object="text" data-key="12564"><span data-slate-leaf="true" data-offset-key="12564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stkparame_t</span></span></span></span><span data-slate-object="text" data-key="12565"><span data-slate-leaf="true" data-offset-key="12565:0" data-first-offset="true"><span data-slate-string="true">*)sframe);</span></span></span><span data-slate-object="text" data-key="12566"><span data-slate-leaf="true" data-offset-key="12566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用对应的服务接口函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12567"><span data-slate-object="text" data-key="12568"><span data-slate-leaf="true" data-offset-key="12568:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12569"><span data-slate-object="text" data-key="12570"><span data-slate-leaf="true" data-offset-key="12570:0" data-first-offset="true"><span data-slate-string="true">上面的系统服务分发器函数现在就写好了。其实逻辑非常简单，就是先对服务号进行判断，如果大于系统中最大的服务号，就返回一个错误状态表示服务失败。然后判断是否有服务接口函数。最后这两个检查通过之后，就可以调用相应的服务接口了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12571"><span data-slate-object="text" data-key="12572"><span data-slate-leaf="true" data-offset-key="12572:0" data-first-offset="true"><span data-slate-string="true">那么 krlservice 函数是谁调用的呢？答案是中断处理的框架函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12573"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12574"><span data-slate-object="text" data-key="12575"><span data-slate-leaf="true" data-offset-key="12575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span></span><span data-slate-object="text" data-key="12576"><span data-slate-leaf="true" data-offset-key="12576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12577"><span data-slate-leaf="true" data-offset-key="12577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_syscl_allocator</span></span></span></span></span><span data-slate-object="text" data-key="12578"><span data-slate-leaf="true" data-offset-key="12578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12579"><span data-slate-leaf="true" data-offset-key="12579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12580"><span data-slate-leaf="true" data-offset-key="12580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> inr,</span></span></span></span></span><span data-slate-object="text" data-key="12581"><span data-slate-leaf="true" data-offset-key="12581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="12582"><span data-slate-leaf="true" data-offset-key="12582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* krnlsframp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12583"><span data-slate-object="text" data-key="12584"><span data-slate-leaf="true" data-offset-key="12584:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12585"><span data-slate-object="text" data-key="12586"><span data-slate-leaf="true" data-offset-key="12586:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12587"><span data-slate-leaf="true" data-offset-key="12587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12588"><span data-slate-leaf="true" data-offset-key="12588:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12589"><span data-slate-leaf="true" data-offset-key="12589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlservice</span></span></span></span><span data-slate-object="text" data-key="12590"><span data-slate-leaf="true" data-offset-key="12590:0" data-first-offset="true"><span data-slate-string="true">(inr,krnlsframp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12591"><span data-slate-object="text" data-key="12592"><span data-slate-leaf="true" data-offset-key="12592:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12593"><span data-slate-object="text" data-key="12594"><span data-slate-leaf="true" data-offset-key="12594:0" data-first-offset="true"><span data-slate-string="true">hal_syscl_allocator 函数则是由我们系统中断处理的第一层汇编代码调用的，这个汇编代码主要是将进程的用户态 CPU 寄存器保存在内核栈中，代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="12595"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12596"><span data-slate-object="text" data-key="12597"><span data-slate-leaf="true" data-offset-key="12597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cosmos/include/halinc/kernel.inc</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12598"><span data-slate-object="text" data-key="12599"><span data-slate-leaf="true" data-offset-key="12599:0" data-first-offset="true"><span data-slate-string="true">%</span></span></span><span data-slate-object="text" data-key="12600"><span data-slate-leaf="true" data-offset-key="12600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">macro</span></span></span></span><span data-slate-object="text" data-key="12601"><span data-slate-leaf="true" data-offset-key="12601:0" data-first-offset="true"><span data-slate-string="true">  EXI_SCALL  </span></span></span><span data-slate-object="text" data-key="12602"><span data-slate-leaf="true" data-offset-key="12602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12603"><span data-slate-object="text" data-key="12604"><span data-slate-leaf="true" data-offset-key="12604:0" data-first-offset="true"><span data-slate-string="true">  push rbx</span></span></span><span data-slate-object="text" data-key="12605"><span data-slate-leaf="true" data-offset-key="12605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存通用寄存器到内核栈</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12606"><span data-slate-object="text" data-key="12607"><span data-slate-leaf="true" data-offset-key="12607:0" data-first-offset="true"><span data-slate-string="true">  push rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12608"><span data-slate-object="text" data-key="12609"><span data-slate-leaf="true" data-offset-key="12609:0" data-first-offset="true"><span data-slate-string="true">  push rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12610"><span data-slate-object="text" data-key="12611"><span data-slate-leaf="true" data-offset-key="12611:0" data-first-offset="true"><span data-slate-string="true">  push rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12612"><span data-slate-object="text" data-key="12613"><span data-slate-leaf="true" data-offset-key="12613:0" data-first-offset="true"><span data-slate-string="true">  push rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12614"><span data-slate-object="text" data-key="12615"><span data-slate-leaf="true" data-offset-key="12615:0" data-first-offset="true"><span data-slate-string="true">  push rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12616"><span data-slate-object="text" data-key="12617"><span data-slate-leaf="true" data-offset-key="12617:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12618"><span data-slate-leaf="true" data-offset-key="12618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除了一些代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12619"><span data-slate-object="text" data-key="12620"><span data-slate-leaf="true" data-offset-key="12620:0" data-first-offset="true"><span data-slate-string="true">  mov  rdi, rax </span></span></span><span data-slate-object="text" data-key="12621"><span data-slate-leaf="true" data-offset-key="12621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 hal_syscl_allocator 函数第一个参数 inr</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12622"><span data-slate-object="text" data-key="12623"><span data-slate-leaf="true" data-offset-key="12623:0" data-first-offset="true"><span data-slate-string="true">  mov rsi, rsp </span></span></span><span data-slate-object="text" data-key="12624"><span data-slate-leaf="true" data-offset-key="12624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 hal_syscl_allocator 函数第二个参数 krnlsframp</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12625"><span data-slate-object="text" data-key="12626"><span data-slate-leaf="true" data-offset-key="12626:0" data-first-offset="true"><span data-slate-string="true">  call hal_syscl_allocator </span></span></span><span data-slate-object="text" data-key="12627"><span data-slate-leaf="true" data-offset-key="12627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 hal_syscl_allocator 函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12628"><span data-slate-object="text" data-key="12629"><span data-slate-leaf="true" data-offset-key="12629:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12630"><span data-slate-leaf="true" data-offset-key="12630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除了一些代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12631"><span data-slate-object="text" data-key="12632"><span data-slate-leaf="true" data-offset-key="12632:0" data-first-offset="true"><span data-slate-string="true">  pop rdi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12633"><span data-slate-object="text" data-key="12634"><span data-slate-leaf="true" data-offset-key="12634:0" data-first-offset="true"><span data-slate-string="true">  pop rsi</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12635"><span data-slate-object="text" data-key="12636"><span data-slate-leaf="true" data-offset-key="12636:0" data-first-offset="true"><span data-slate-string="true">  pop rbp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12637"><span data-slate-object="text" data-key="12638"><span data-slate-leaf="true" data-offset-key="12638:0" data-first-offset="true"><span data-slate-string="true">  pop rdx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12639"><span data-slate-object="text" data-key="12640"><span data-slate-leaf="true" data-offset-key="12640:0" data-first-offset="true"><span data-slate-string="true">  pop rcx</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12641"><span data-slate-object="text" data-key="12642"><span data-slate-leaf="true" data-offset-key="12642:0" data-first-offset="true"><span data-slate-string="true">  pop rbx</span></span></span><span data-slate-object="text" data-key="12643"><span data-slate-leaf="true" data-offset-key="12643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从内核栈中恢复通用寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12644"><span data-slate-object="text" data-key="12645"><span data-slate-leaf="true" data-offset-key="12645:0" data-first-offset="true"><span data-slate-string="true">  iretq </span></span></span><span data-slate-object="text" data-key="12646"><span data-slate-leaf="true" data-offset-key="12646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12647"><span data-slate-object="text" data-key="12648"><span data-slate-leaf="true" data-offset-key="12648:0" data-first-offset="true"><span data-slate-string="true">%endmacro</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12649"><span data-slate-object="text" data-key="12650"><span data-slate-leaf="true" data-offset-key="12650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cosmos/hal/x86/kernel.asm</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12651"><span data-slate-object="text" data-key="12652"><span data-slate-leaf="true" data-offset-key="12652:0" data-first-offset="true"><span data-slate-string="true">exi_sys_call:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12653"><span data-slate-object="text" data-key="12654"><span data-slate-leaf="true" data-offset-key="12654:0" data-first-offset="true"><span data-slate-string="true">  EXI_SCALL</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12655"><span data-slate-object="text" data-key="12656"><span data-slate-leaf="true" data-offset-key="12656:0" data-first-offset="true"><span data-slate-string="true">上述代码中的 exi_sys_call 标号的地址保存在第 255 个中断门描述符中。这样执行了 int $255 之后，CPU 就会自动跳转到 exi_sys_call 标号处运行，从而进入内核开始运行，最终调用 krlservice 函数，开始执行系统服务。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12657" id="sr-toc-7"><span data-slate-object="text" data-key="12658"><span data-slate-leaf="true" data-offset-key="12658:0" data-first-offset="true"><span data-slate-string="true">系统服务表</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12659"><span data-slate-object="text" data-key="12660"><span data-slate-leaf="true" data-offset-key="12660:0" data-first-offset="true"><span data-slate-string="true">从上面的代码可以看出，我们不可能每个系统服务都占用一个中断描述符，所以要设计一个叫做系统服务表的东西，用来存放各种系统服务的入口函数，它能在 krlservice 函数中根据服务号，调用相应系统服务表中相应的服务入口函数。怎么实现系统服务表呢？如果你想到函数指针数组，这说明你和我想到一块了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12661"><span data-slate-object="text" data-key="12662"><span data-slate-leaf="true" data-offset-key="12662:0" data-first-offset="true"><span data-slate-string="true">下面我们一起来定义这个函数指针数组，它是全局的，我们放在 cosmos/kernel/krlglobal.c 中，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12663"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12664"><span data-slate-object="text" data-key="12665"><span data-slate-leaf="true" data-offset-key="12665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="12666"><span data-slate-leaf="true" data-offset-key="12666:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12667"><span data-slate-leaf="true" data-offset-key="12667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12668"><span data-slate-leaf="true" data-offset-key="12668:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12669"><span data-slate-leaf="true" data-offset-key="12669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_STKPARAME</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12670"><span data-slate-object="text" data-key="12671"><span data-slate-leaf="true" data-offset-key="12671:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12672"><span data-slate-object="text" data-key="12673"><span data-slate-leaf="true" data-offset-key="12673:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12674"><span data-slate-leaf="true" data-offset-key="12674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12675"><span data-slate-leaf="true" data-offset-key="12675:0" data-first-offset="true"><span data-slate-string="true"> gs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12676"><span data-slate-object="text" data-key="12677"><span data-slate-leaf="true" data-offset-key="12677:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12678"><span data-slate-leaf="true" data-offset-key="12678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12679"><span data-slate-leaf="true" data-offset-key="12679:0" data-first-offset="true"><span data-slate-string="true"> fs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12680"><span data-slate-object="text" data-key="12681"><span data-slate-leaf="true" data-offset-key="12681:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12682"><span data-slate-leaf="true" data-offset-key="12682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12683"><span data-slate-leaf="true" data-offset-key="12683:0" data-first-offset="true"><span data-slate-string="true"> es;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12684"><span data-slate-object="text" data-key="12685"><span data-slate-leaf="true" data-offset-key="12685:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12686"><span data-slate-leaf="true" data-offset-key="12686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12687"><span data-slate-leaf="true" data-offset-key="12687:0" data-first-offset="true"><span data-slate-string="true"> ds;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12688"><span data-slate-object="text" data-key="12689"><span data-slate-leaf="true" data-offset-key="12689:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12690"><span data-slate-leaf="true" data-offset-key="12690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12691"><span data-slate-leaf="true" data-offset-key="12691:0" data-first-offset="true"><span data-slate-string="true"> r15;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12692"><span data-slate-object="text" data-key="12693"><span data-slate-leaf="true" data-offset-key="12693:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12694"><span data-slate-leaf="true" data-offset-key="12694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12695"><span data-slate-leaf="true" data-offset-key="12695:0" data-first-offset="true"><span data-slate-string="true"> r14;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12696"><span data-slate-object="text" data-key="12697"><span data-slate-leaf="true" data-offset-key="12697:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12698"><span data-slate-leaf="true" data-offset-key="12698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12699"><span data-slate-leaf="true" data-offset-key="12699:0" data-first-offset="true"><span data-slate-string="true"> r13;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12700"><span data-slate-object="text" data-key="12701"><span data-slate-leaf="true" data-offset-key="12701:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12702"><span data-slate-leaf="true" data-offset-key="12702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12703"><span data-slate-leaf="true" data-offset-key="12703:0" data-first-offset="true"><span data-slate-string="true"> r12;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12704"><span data-slate-object="text" data-key="12705"><span data-slate-leaf="true" data-offset-key="12705:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12706"><span data-slate-leaf="true" data-offset-key="12706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12707"><span data-slate-leaf="true" data-offset-key="12707:0" data-first-offset="true"><span data-slate-string="true"> r11;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12708"><span data-slate-object="text" data-key="12709"><span data-slate-leaf="true" data-offset-key="12709:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12710"><span data-slate-leaf="true" data-offset-key="12710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12711"><span data-slate-leaf="true" data-offset-key="12711:0" data-first-offset="true"><span data-slate-string="true"> r10;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12712"><span data-slate-object="text" data-key="12713"><span data-slate-leaf="true" data-offset-key="12713:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12714"><span data-slate-leaf="true" data-offset-key="12714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12715"><span data-slate-leaf="true" data-offset-key="12715:0" data-first-offset="true"><span data-slate-string="true"> r9;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12716"><span data-slate-object="text" data-key="12717"><span data-slate-leaf="true" data-offset-key="12717:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12718"><span data-slate-leaf="true" data-offset-key="12718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12719"><span data-slate-leaf="true" data-offset-key="12719:0" data-first-offset="true"><span data-slate-string="true"> r8;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12720"><span data-slate-object="text" data-key="12721"><span data-slate-leaf="true" data-offset-key="12721:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12722"><span data-slate-leaf="true" data-offset-key="12722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12723"><span data-slate-leaf="true" data-offset-key="12723:0" data-first-offset="true"><span data-slate-string="true"> parmv5;</span></span></span><span data-slate-object="text" data-key="12724"><span data-slate-leaf="true" data-offset-key="12724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rdi;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12725"><span data-slate-object="text" data-key="12726"><span data-slate-leaf="true" data-offset-key="12726:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12727"><span data-slate-leaf="true" data-offset-key="12727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12728"><span data-slate-leaf="true" data-offset-key="12728:0" data-first-offset="true"><span data-slate-string="true"> parmv4;</span></span></span><span data-slate-object="text" data-key="12729"><span data-slate-leaf="true" data-offset-key="12729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rsi;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12730"><span data-slate-object="text" data-key="12731"><span data-slate-leaf="true" data-offset-key="12731:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12732"><span data-slate-leaf="true" data-offset-key="12732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12733"><span data-slate-leaf="true" data-offset-key="12733:0" data-first-offset="true"><span data-slate-string="true"> rbp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12734"><span data-slate-object="text" data-key="12735"><span data-slate-leaf="true" data-offset-key="12735:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12736"><span data-slate-leaf="true" data-offset-key="12736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12737"><span data-slate-leaf="true" data-offset-key="12737:0" data-first-offset="true"><span data-slate-string="true"> parmv3;</span></span></span><span data-slate-object="text" data-key="12738"><span data-slate-leaf="true" data-offset-key="12738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rdx;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12739"><span data-slate-object="text" data-key="12740"><span data-slate-leaf="true" data-offset-key="12740:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12741"><span data-slate-leaf="true" data-offset-key="12741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12742"><span data-slate-leaf="true" data-offset-key="12742:0" data-first-offset="true"><span data-slate-string="true"> parmv2;</span></span></span><span data-slate-object="text" data-key="12743"><span data-slate-leaf="true" data-offset-key="12743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rcx;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12744"><span data-slate-object="text" data-key="12745"><span data-slate-leaf="true" data-offset-key="12745:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12746"><span data-slate-leaf="true" data-offset-key="12746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12747"><span data-slate-leaf="true" data-offset-key="12747:0" data-first-offset="true"><span data-slate-string="true"> parmv1;</span></span></span><span data-slate-object="text" data-key="12748"><span data-slate-leaf="true" data-offset-key="12748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//rbx;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12749"><span data-slate-object="text" data-key="12750"><span data-slate-leaf="true" data-offset-key="12750:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12751"><span data-slate-leaf="true" data-offset-key="12751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12752"><span data-slate-leaf="true" data-offset-key="12752:0" data-first-offset="true"><span data-slate-string="true"> rvsrip;    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12753"><span data-slate-object="text" data-key="12754"><span data-slate-leaf="true" data-offset-key="12754:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12755"><span data-slate-leaf="true" data-offset-key="12755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12756"><span data-slate-leaf="true" data-offset-key="12756:0" data-first-offset="true"><span data-slate-string="true"> rvscs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12757"><span data-slate-object="text" data-key="12758"><span data-slate-leaf="true" data-offset-key="12758:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12759"><span data-slate-leaf="true" data-offset-key="12759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12760"><span data-slate-leaf="true" data-offset-key="12760:0" data-first-offset="true"><span data-slate-string="true"> rvsrflags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12761"><span data-slate-object="text" data-key="12762"><span data-slate-leaf="true" data-offset-key="12762:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12763"><span data-slate-leaf="true" data-offset-key="12763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12764"><span data-slate-leaf="true" data-offset-key="12764:0" data-first-offset="true"><span data-slate-string="true"> rvsrsp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12765"><span data-slate-object="text" data-key="12766"><span data-slate-leaf="true" data-offset-key="12766:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12767"><span data-slate-leaf="true" data-offset-key="12767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u64_t</span></span></span></span><span data-slate-object="text" data-key="12768"><span data-slate-leaf="true" data-offset-key="12768:0" data-first-offset="true"><span data-slate-string="true"> rvsss;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12769"><span data-slate-object="text" data-key="12770"><span data-slate-leaf="true" data-offset-key="12770:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="12771"><span data-slate-leaf="true" data-offset-key="12771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stkparame_t</span></span></span></span><span data-slate-object="text" data-key="12772"><span data-slate-leaf="true" data-offset-key="12772:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12773"><span data-slate-object="text" data-key="12774"><span data-slate-leaf="true" data-offset-key="12774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 服务函数类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12775"><span data-slate-object="text" data-key="12776"><span data-slate-leaf="true" data-offset-key="12776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span></span><span data-slate-object="text" data-key="12777"><span data-slate-leaf="true" data-offset-key="12777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12778"><span data-slate-leaf="true" data-offset-key="12778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span></span><span data-slate-object="text" data-key="12779"><span data-slate-leaf="true" data-offset-key="12779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12780"><span data-slate-leaf="true" data-offset-key="12780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(*</span></span></span></span></span><span data-slate-object="text" data-key="12781"><span data-slate-leaf="true" data-offset-key="12781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">syscall_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12782"><span data-slate-leaf="true" data-offset-key="12782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="12783"><span data-slate-leaf="true" data-offset-key="12783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12784"><span data-slate-leaf="true" data-offset-key="12784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12785"><span data-slate-leaf="true" data-offset-key="12785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> inr,</span></span></span></span></span><span data-slate-object="text" data-key="12786"><span data-slate-leaf="true" data-offset-key="12786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stkparame_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12787"><span data-slate-leaf="true" data-offset-key="12787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* stkparm)</span></span></span></span></span><span data-slate-object="text" data-key="12788"><span data-slate-leaf="true" data-offset-key="12788:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12789"><span data-slate-object="text" data-key="12790"><span data-slate-leaf="true" data-offset-key="12790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cosmos/kernel/krlglobal.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12791"><span data-slate-object="text" data-key="12792"><span data-slate-leaf="true" data-offset-key="12792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KRL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="12793"><span data-slate-leaf="true" data-offset-key="12793:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12794"><span data-slate-leaf="true" data-offset-key="12794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">syscall_t</span></span></span></span><span data-slate-object="text" data-key="12795"><span data-slate-leaf="true" data-offset-key="12795:0" data-first-offset="true"><span data-slate-string="true">,osservicetab)[INR_MAX]={};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12796"><span data-slate-object="text" data-key="12797"><span data-slate-leaf="true" data-offset-key="12797:0" data-first-offset="true"><span data-slate-string="true">我们知道，执行 int 指令后会 CPU 会进入中断处理流程。中断处理流程的第一步就是把 CPU 的一寄存器压入内核栈中，前面系统传递参数正是通过寄存器传递的，而寄存器就保存在内核栈中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12798"><span data-slate-object="text" data-key="12799"><span data-slate-leaf="true" data-offset-key="12799:0" data-first-offset="true"><span data-slate-string="true">所以我们需要定义一个 stkparame_t 结构，用来提取内核栈中的参数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12800"><span data-slate-object="text" data-key="12801"><span data-slate-leaf="true" data-offset-key="12801:0" data-first-offset="true"><span data-slate-string="true">接着是第二步，我们可以查看一下 hal_syscl_allocator 函数的第二个参数，正是传递的 RSP 寄存器的值，只要把这个值转换成 stkparame_t 结构的地址，就能提取内核栈中的参数了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12802"><span data-slate-object="text" data-key="12803"><span data-slate-leaf="true" data-offset-key="12803:0" data-first-offset="true"><span data-slate-string="true">但是目前 osservicetab 数组中为空，什么也没有，这是因为我们还没有实现相应服务接口函数。下面我们就来实现它。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12804" id="sr-toc-8"><span data-slate-object="text" data-key="12805"><span data-slate-leaf="true" data-offset-key="12805:0" data-first-offset="true"><span data-slate-string="true">系统服务实例</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12806"><span data-slate-object="text" data-key="12807"><span data-slate-leaf="true" data-offset-key="12807:0" data-first-offset="true"><span data-slate-string="true">现在我们已经搞清楚了实现系统服务的所有机制，下面我们就要去实现 Cosmos 的系统服务了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12808"><span data-slate-object="text" data-key="12809"><span data-slate-leaf="true" data-offset-key="12809:0" data-first-offset="true"><span data-slate-string="true">其实我已经帮你实现了大多数系统服务了，我没有介绍所有系统服务的实现过程 ，但是每个系统服务的实现原理是相同的。如果每个系统服务都写一遍将非常浪费，所以我选择一个系统服务做为例子，来带你了解实现过程。相信以你的智慧和能力，一定能够举一反三。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12810"><span data-slate-object="text" data-key="12811"><span data-slate-leaf="true" data-offset-key="12811:0" data-first-offset="true"><span data-slate-string="true">我们下面就来实现系统时间系统服务，应用程序也是经常要获取时间数据的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12812" id="sr-toc-9"><span data-slate-object="text" data-key="12813"><span data-slate-leaf="true" data-offset-key="12813:0" data-first-offset="true"><span data-slate-string="true">时间库</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12814"><span data-slate-object="text" data-key="12815"><span data-slate-leaf="true" data-offset-key="12815:0" data-first-offset="true"><span data-slate-string="true">根据前面所讲，应用程序开发者往往不是直接调用系统 API（应用程序编程接口，我们称为服务接口），而是经常调用某个库来达到目的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12816"><span data-slate-object="text" data-key="12817"><span data-slate-leaf="true" data-offset-key="12817:0" data-first-offset="true"><span data-slate-string="true">所以，我们要先来实现一个时间的库函数。首先，我们需要建立一个 cosmos/lib/libtime.c 文件，在里面写上后面这段代码。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12818"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12819"><span data-slate-object="text" data-key="12820"><span data-slate-leaf="true" data-offset-key="12820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 时间库函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12821"><span data-slate-object="text" data-key="12822"><span data-slate-leaf="true" data-offset-key="12822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span></span><span data-slate-object="text" data-key="12823"><span data-slate-leaf="true" data-offset-key="12823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12824"><span data-slate-leaf="true" data-offset-key="12824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">time</span></span></span></span></span><span data-slate-object="text" data-key="12825"><span data-slate-leaf="true" data-offset-key="12825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12826"><span data-slate-leaf="true" data-offset-key="12826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">times_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12827"><span data-slate-leaf="true" data-offset-key="12827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *ttime)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12828"><span data-slate-object="text" data-key="12829"><span data-slate-leaf="true" data-offset-key="12829:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12830"><span data-slate-object="text" data-key="12831"><span data-slate-leaf="true" data-offset-key="12831:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12832"><span data-slate-leaf="true" data-offset-key="12832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span><span data-slate-object="text" data-key="12833"><span data-slate-leaf="true" data-offset-key="12833:0" data-first-offset="true"><span data-slate-string="true"> rets = </span></span></span><span data-slate-object="text" data-key="12834"><span data-slate-leaf="true" data-offset-key="12834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">api_time</span></span></span></span><span data-slate-object="text" data-key="12835"><span data-slate-leaf="true" data-offset-key="12835:0" data-first-offset="true"><span data-slate-string="true">(ttime);</span></span></span><span data-slate-object="text" data-key="12836"><span data-slate-leaf="true" data-offset-key="12836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用时间 API</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12837"><span data-slate-object="text" data-key="12838"><span data-slate-leaf="true" data-offset-key="12838:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12839"><span data-slate-leaf="true" data-offset-key="12839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12840"><span data-slate-leaf="true" data-offset-key="12840:0" data-first-offset="true"><span data-slate-string="true"> rets;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12841"><span data-slate-object="text" data-key="12842"><span data-slate-leaf="true" data-offset-key="12842:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12843"><span data-slate-object="text" data-key="12844"><span data-slate-leaf="true" data-offset-key="12844:0" data-first-offset="true"><span data-slate-string="true">time 库函数非常简单，就是对系统 API 的封装、应用程序需要传递一个 times_t 结构的地址，这是这个系统 API 的要求， 这个结构也是由系统定义的，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12845"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12846"><span data-slate-object="text" data-key="12847"><span data-slate-leaf="true" data-offset-key="12847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="12848"><span data-slate-leaf="true" data-offset-key="12848:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12849"><span data-slate-leaf="true" data-offset-key="12849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12850"><span data-slate-leaf="true" data-offset-key="12850:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12851"><span data-slate-leaf="true" data-offset-key="12851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_TIME</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12852"><span data-slate-object="text" data-key="12853"><span data-slate-leaf="true" data-offset-key="12853:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12854"><span data-slate-object="text" data-key="12855"><span data-slate-leaf="true" data-offset-key="12855:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12856"><span data-slate-leaf="true" data-offset-key="12856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12857"><span data-slate-leaf="true" data-offset-key="12857:0" data-first-offset="true"><span data-slate-string="true">      year;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12858"><span data-slate-object="text" data-key="12859"><span data-slate-leaf="true" data-offset-key="12859:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12860"><span data-slate-leaf="true" data-offset-key="12860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12861"><span data-slate-leaf="true" data-offset-key="12861:0" data-first-offset="true"><span data-slate-string="true">      mon;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12862"><span data-slate-object="text" data-key="12863"><span data-slate-leaf="true" data-offset-key="12863:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12864"><span data-slate-leaf="true" data-offset-key="12864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12865"><span data-slate-leaf="true" data-offset-key="12865:0" data-first-offset="true"><span data-slate-string="true">      day;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12866"><span data-slate-object="text" data-key="12867"><span data-slate-leaf="true" data-offset-key="12867:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12868"><span data-slate-leaf="true" data-offset-key="12868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12869"><span data-slate-leaf="true" data-offset-key="12869:0" data-first-offset="true"><span data-slate-string="true">      date;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12870"><span data-slate-object="text" data-key="12871"><span data-slate-leaf="true" data-offset-key="12871:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12872"><span data-slate-leaf="true" data-offset-key="12872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12873"><span data-slate-leaf="true" data-offset-key="12873:0" data-first-offset="true"><span data-slate-string="true">      hour;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12874"><span data-slate-object="text" data-key="12875"><span data-slate-leaf="true" data-offset-key="12875:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12876"><span data-slate-leaf="true" data-offset-key="12876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12877"><span data-slate-leaf="true" data-offset-key="12877:0" data-first-offset="true"><span data-slate-string="true">      min;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12878"><span data-slate-object="text" data-key="12879"><span data-slate-leaf="true" data-offset-key="12879:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12880"><span data-slate-leaf="true" data-offset-key="12880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="12881"><span data-slate-leaf="true" data-offset-key="12881:0" data-first-offset="true"><span data-slate-string="true">      sec;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12882"><span data-slate-object="text" data-key="12883"><span data-slate-leaf="true" data-offset-key="12883:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="12884"><span data-slate-leaf="true" data-offset-key="12884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">times_t</span></span></span></span><span data-slate-object="text" data-key="12885"><span data-slate-leaf="true" data-offset-key="12885:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12886"><span data-slate-object="text" data-key="12887"><span data-slate-leaf="true" data-offset-key="12887:0" data-first-offset="true"><span data-slate-string="true">我们可以看到，上述结构中定义了年、月、日、时、分、秒。系统内核会将时间信息填入这个结构中，然后返回，这样一来，时间数据就可以返回给应用程序了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12888" id="sr-toc-10"><span data-slate-object="text" data-key="12889"><span data-slate-leaf="true" data-offset-key="12889:0" data-first-offset="true"><span data-slate-string="true">时间 API 接口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12890"><span data-slate-object="text" data-key="12891"><span data-slate-leaf="true" data-offset-key="12891:0" data-first-offset="true"><span data-slate-string="true">时间库函数已经写好了，在库中需要调用时间 API 接口，因为库和 API 接口函数不同层次的，有时应用程序也会直接调用 API 接口函数，所以我们要分为不同模块。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12892"><span data-slate-object="text" data-key="12893"><span data-slate-leaf="true" data-offset-key="12893:0" data-first-offset="true"><span data-slate-string="true">下面我们建立一个 cosmos/lib/lapitime.c 文件，并在里面实现 api_time 函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12894"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12895"><span data-slate-object="text" data-key="12896"><span data-slate-leaf="true" data-offset-key="12896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span></span><span data-slate-object="text" data-key="12897"><span data-slate-leaf="true" data-offset-key="12897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12898"><span data-slate-leaf="true" data-offset-key="12898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">api_time</span></span></span></span></span><span data-slate-object="text" data-key="12899"><span data-slate-leaf="true" data-offset-key="12899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12900"><span data-slate-leaf="true" data-offset-key="12900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">buf_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12901"><span data-slate-leaf="true" data-offset-key="12901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ttime)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12902"><span data-slate-object="text" data-key="12903"><span data-slate-leaf="true" data-offset-key="12903:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12904"><span data-slate-object="text" data-key="12905"><span data-slate-leaf="true" data-offset-key="12905:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12906"><span data-slate-leaf="true" data-offset-key="12906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span><span data-slate-object="text" data-key="12907"><span data-slate-leaf="true" data-offset-key="12907:0" data-first-offset="true"><span data-slate-string="true"> rets;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12908"><span data-slate-object="text" data-key="12909"><span data-slate-leaf="true" data-offset-key="12909:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12910"><span data-slate-leaf="true" data-offset-key="12910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">API_ENTRY_PARE1</span></span></span></span><span data-slate-object="text" data-key="12911"><span data-slate-leaf="true" data-offset-key="12911:0" data-first-offset="true"><span data-slate-string="true">(INR_TIME,rets,ttime);</span></span></span><span data-slate-object="text" data-key="12912"><span data-slate-leaf="true" data-offset-key="12912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理参数，执行 int 指令 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12913"><span data-slate-object="text" data-key="12914"><span data-slate-leaf="true" data-offset-key="12914:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12915"><span data-slate-leaf="true" data-offset-key="12915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12916"><span data-slate-leaf="true" data-offset-key="12916:0" data-first-offset="true"><span data-slate-string="true"> rets;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12917"><span data-slate-object="text" data-key="12918"><span data-slate-leaf="true" data-offset-key="12918:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12919"><span data-slate-object="text" data-key="12920"><span data-slate-leaf="true" data-offset-key="12920:0" data-first-offset="true"><span data-slate-string="true">INR_TIME 是系统服务号，它经过 API_ENTRY_PARE1 宏处理，把 INR_TIME 和 ttime、rets 关联到相应的寄存器，如果不明白可以参考前面的参数传递中使用寄存器的情况。最后就是执行 int 指令进入内核，开始运行时间服务代码。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12921" id="sr-toc-11"><span data-slate-object="text" data-key="12922"><span data-slate-leaf="true" data-offset-key="12922:0" data-first-offset="true"><span data-slate-string="true">内核态时间服务接口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12923"><span data-slate-object="text" data-key="12924"><span data-slate-leaf="true" data-offset-key="12924:0" data-first-offset="true"><span data-slate-string="true">当执行 int 指令后，就进入了内核模式下开始执行内核代码了。系统服务分发器会根据服务号从系统服务表中取出相应的函数并调用。因为我们这里要响应的是时间服务，所以取用的自然就是时间服务的接口函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12925"><span data-slate-object="text" data-key="12926"><span data-slate-leaf="true" data-offset-key="12926:0" data-first-offset="true"><span data-slate-string="true">下面我们来建立一个 cosmos/kernel/krltime.c 文件，写出这个时间服务的接口函数，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12927"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12928"><span data-slate-object="text" data-key="12929"><span data-slate-leaf="true" data-offset-key="12929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysstus_t</span></span></span></span></span><span data-slate-object="text" data-key="12930"><span data-slate-leaf="true" data-offset-key="12930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="12931"><span data-slate-leaf="true" data-offset-key="12931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsvetabl_time</span></span></span></span></span><span data-slate-object="text" data-key="12932"><span data-slate-leaf="true" data-offset-key="12932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="12933"><span data-slate-leaf="true" data-offset-key="12933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12934"><span data-slate-leaf="true" data-offset-key="12934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> inr, </span></span></span></span></span><span data-slate-object="text" data-key="12935"><span data-slate-leaf="true" data-offset-key="12935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stkparame_t</span></span></span></span></span></span><span data-slate-object="text" data-key="12936"><span data-slate-leaf="true" data-offset-key="12936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *stkparv)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12937"><span data-slate-object="text" data-key="12938"><span data-slate-leaf="true" data-offset-key="12938:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12939"><span data-slate-object="text" data-key="12940"><span data-slate-leaf="true" data-offset-key="12940:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12941"><span data-slate-leaf="true" data-offset-key="12941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12942"><span data-slate-leaf="true" data-offset-key="12942:0" data-first-offset="true"><span data-slate-string="true"> (inr != INR_TIME)</span></span></span><span data-slate-object="text" data-key="12943"><span data-slate-leaf="true" data-offset-key="12943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断是否时间服务号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12944"><span data-slate-object="text" data-key="12945"><span data-slate-leaf="true" data-offset-key="12945:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12946"><span data-slate-object="text" data-key="12947"><span data-slate-leaf="true" data-offset-key="12947:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12948"><span data-slate-leaf="true" data-offset-key="12948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12949"><span data-slate-leaf="true" data-offset-key="12949:0" data-first-offset="true"><span data-slate-string="true"> SYSSTUSERR;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12950"><span data-slate-object="text" data-key="12951"><span data-slate-leaf="true" data-offset-key="12951:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12952"><span data-slate-object="text" data-key="12953"><span data-slate-leaf="true" data-offset-key="12953:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12954"><span data-slate-leaf="true" data-offset-key="12954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用真正时间服务函数 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12955"><span data-slate-object="text" data-key="12956"><span data-slate-leaf="true" data-offset-key="12956:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12957"><span data-slate-leaf="true" data-offset-key="12957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12958"><span data-slate-leaf="true" data-offset-key="12958:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12959"><span data-slate-leaf="true" data-offset-key="12959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsve_time</span></span></span></span><span data-slate-object="text" data-key="12960"><span data-slate-leaf="true" data-offset-key="12960:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="12961"><span data-slate-leaf="true" data-offset-key="12961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">time_t</span></span></span></span><span data-slate-object="text" data-key="12962"><span data-slate-leaf="true" data-offset-key="12962:0" data-first-offset="true"><span data-slate-string="true"> *)stkparv-&gt;parmv1);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12963"><span data-slate-object="text" data-key="12964"><span data-slate-leaf="true" data-offset-key="12964:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12965"><span data-slate-object="text" data-key="12966"><span data-slate-leaf="true" data-offset-key="12966:0" data-first-offset="true"><span data-slate-string="true">每个服务接口函数的参数形式都是固定的，我们在前面已经讲过了，但是这个 krlsvetabl_time 函数一定要放在系统服务表中才可以，系统服务表其实是个函数指针数组。虽然前面已经提过了，但是那时 osservicetab 数组是空的，现在我们要把 krlsvetabl_time 函数放进去，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12967"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12968"><span data-slate-object="text" data-key="12969"><span data-slate-leaf="true" data-offset-key="12969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KRL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="12970"><span data-slate-leaf="true" data-offset-key="12970:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="12971"><span data-slate-leaf="true" data-offset-key="12971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">syscall_t</span></span></span></span><span data-slate-object="text" data-key="12972"><span data-slate-leaf="true" data-offset-key="12972:0" data-first-offset="true"><span data-slate-string="true">, osservicetab)[INR_MAX] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12973"><span data-slate-object="text" data-key="12974"><span data-slate-leaf="true" data-offset-key="12974:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12975"><span data-slate-leaf="true" data-offset-key="12975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12976"><span data-slate-leaf="true" data-offset-key="12976:0" data-first-offset="true"><span data-slate-string="true">, krlsvetabl_mallocblk,</span></span></span><span data-slate-object="text" data-key="12977"><span data-slate-leaf="true" data-offset-key="12977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存分配服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12978"><span data-slate-object="text" data-key="12979"><span data-slate-leaf="true" data-offset-key="12979:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_mfreeblk, </span></span></span><span data-slate-object="text" data-key="12980"><span data-slate-leaf="true" data-offset-key="12980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 内存释放服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12981"><span data-slate-object="text" data-key="12982"><span data-slate-leaf="true" data-offset-key="12982:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_exel_thread,</span></span></span><span data-slate-object="text" data-key="12983"><span data-slate-leaf="true" data-offset-key="12983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12984"><span data-slate-object="text" data-key="12985"><span data-slate-leaf="true" data-offset-key="12985:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_exit_thread,</span></span></span><span data-slate-object="text" data-key="12986"><span data-slate-leaf="true" data-offset-key="12986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程退出服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12987"><span data-slate-object="text" data-key="12988"><span data-slate-leaf="true" data-offset-key="12988:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_retn_threadhand,</span></span></span><span data-slate-object="text" data-key="12989"><span data-slate-leaf="true" data-offset-key="12989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取进程 id 服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12990"><span data-slate-object="text" data-key="12991"><span data-slate-leaf="true" data-offset-key="12991:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_retn_threadstats,</span></span></span><span data-slate-object="text" data-key="12992"><span data-slate-leaf="true" data-offset-key="12992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取进程状态服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12993"><span data-slate-object="text" data-key="12994"><span data-slate-leaf="true" data-offset-key="12994:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_set_threadstats,</span></span></span><span data-slate-object="text" data-key="12995"><span data-slate-leaf="true" data-offset-key="12995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置进程状态服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12996"><span data-slate-object="text" data-key="12997"><span data-slate-leaf="true" data-offset-key="12997:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_open, krlsvetabl_close,</span></span></span><span data-slate-object="text" data-key="12998"><span data-slate-leaf="true" data-offset-key="12998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 文件打开、关闭服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12999"><span data-slate-object="text" data-key="13000"><span data-slate-leaf="true" data-offset-key="13000:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_read, krlsvetabl_write,</span></span></span><span data-slate-object="text" data-key="13001"><span data-slate-leaf="true" data-offset-key="13001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 文件读、写服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13002"><span data-slate-object="text" data-key="13003"><span data-slate-leaf="true" data-offset-key="13003:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_ioctrl, krlsvetabl_lseek,</span></span></span><span data-slate-object="text" data-key="13004"><span data-slate-leaf="true" data-offset-key="13004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 文件随机读写和控制服务接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13005"><span data-slate-object="text" data-key="13006"><span data-slate-leaf="true" data-offset-key="13006:0" data-first-offset="true"><span data-slate-string="true">    krlsvetabl_time};</span></span></span><span data-slate-object="text" data-key="13007"><span data-slate-leaf="true" data-offset-key="13007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取时间服务接口</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13008"><span data-slate-object="text" data-key="13009"><span data-slate-leaf="true" data-offset-key="13009:0" data-first-offset="true"><span data-slate-string="true">我们的获取时间服务接口占最后一个，第 0 个要保留，其它的服务接口函数我已经帮你实现好了，可以自己查看代码。这样就能调用到 krlsvetabl_time 函数完成服务功能了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13010" id="sr-toc-12"><span data-slate-object="text" data-key="13011"><span data-slate-leaf="true" data-offset-key="13011:0" data-first-offset="true"><span data-slate-string="true">实现时间服务</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13012"><span data-slate-object="text" data-key="13013"><span data-slate-leaf="true" data-offset-key="13013:0" data-first-offset="true"><span data-slate-string="true">上面我们只实现了时间服务的接口函数，这个函数还需要调用真正完成功能的函数，下面我们来实现它。想在该函数中完成获取时间数据的功能，我们依然要在 cosmos/kernel/krltime.c 文件中来实现，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="13014"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13015"><span data-slate-object="text" data-key="13016"><span data-slate-leaf="true" data-offset-key="13016:0" data-first-offset="true"><span data-slate-string="true">sysstus_t </span></span></span><span data-slate-object="text" data-key="13017"><span data-slate-leaf="true" data-offset-key="13017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsve_time</span></span></span></span><span data-slate-object="text" data-key="13018"><span data-slate-leaf="true" data-offset-key="13018:0" data-first-offset="true"><span data-slate-string="true">(time_t *time)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13019"><span data-slate-object="text" data-key="13020"><span data-slate-leaf="true" data-offset-key="13020:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13021"><span data-slate-object="text" data-key="13022"><span data-slate-leaf="true" data-offset-key="13022:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13023"><span data-slate-leaf="true" data-offset-key="13023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13024"><span data-slate-leaf="true" data-offset-key="13024:0" data-first-offset="true"><span data-slate-string="true"> (time == NULL)</span></span></span><span data-slate-object="text" data-key="13025"><span data-slate-leaf="true" data-offset-key="13025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对参数进行判断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13026"><span data-slate-object="text" data-key="13027"><span data-slate-leaf="true" data-offset-key="13027:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13028"><span data-slate-object="text" data-key="13029"><span data-slate-leaf="true" data-offset-key="13029:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13030"><span data-slate-leaf="true" data-offset-key="13030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13031"><span data-slate-leaf="true" data-offset-key="13031:0" data-first-offset="true"><span data-slate-string="true"> SYSSTUSERR;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13032"><span data-slate-object="text" data-key="13033"><span data-slate-leaf="true" data-offset-key="13033:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13034"><span data-slate-object="text" data-key="13035"><span data-slate-leaf="true" data-offset-key="13035:0" data-first-offset="true"><span data-slate-string="true">    ktime_t *initp = &amp;osktime;</span></span></span><span data-slate-object="text" data-key="13036"><span data-slate-leaf="true" data-offset-key="13036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 操作系统保存时间的结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13037"><span data-slate-object="text" data-key="13038"><span data-slate-leaf="true" data-offset-key="13038:0" data-first-offset="true"><span data-slate-string="true">    cpuflg_t cpufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13039"><span data-slate-object="text" data-key="13040"><span data-slate-leaf="true" data-offset-key="13040:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13041"><span data-slate-leaf="true" data-offset-key="13041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="13042"><span data-slate-leaf="true" data-offset-key="13042:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="13043"><span data-slate-leaf="true" data-offset-key="13043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13044"><span data-slate-leaf="true" data-offset-key="13044:0" data-first-offset="true"><span data-slate-string="true">kt_lock, &amp;cpufg);</span></span></span><span data-slate-object="text" data-key="13045"><span data-slate-leaf="true" data-offset-key="13045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13046"><span data-slate-object="text" data-key="13047"><span data-slate-leaf="true" data-offset-key="13047:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13048"><span data-slate-leaf="true" data-offset-key="13048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13049"><span data-slate-leaf="true" data-offset-key="13049:0" data-first-offset="true"><span data-slate-string="true">year = initp</span></span></span><span data-slate-object="text" data-key="13050"><span data-slate-leaf="true" data-offset-key="13050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13051"><span data-slate-leaf="true" data-offset-key="13051:0" data-first-offset="true"><span data-slate-string="true">kt_year;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13052"><span data-slate-object="text" data-key="13053"><span data-slate-leaf="true" data-offset-key="13053:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13054"><span data-slate-leaf="true" data-offset-key="13054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13055"><span data-slate-leaf="true" data-offset-key="13055:0" data-first-offset="true"><span data-slate-string="true">mon = initp</span></span></span><span data-slate-object="text" data-key="13056"><span data-slate-leaf="true" data-offset-key="13056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13057"><span data-slate-leaf="true" data-offset-key="13057:0" data-first-offset="true"><span data-slate-string="true">kt_mon;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13058"><span data-slate-object="text" data-key="13059"><span data-slate-leaf="true" data-offset-key="13059:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13060"><span data-slate-leaf="true" data-offset-key="13060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13061"><span data-slate-leaf="true" data-offset-key="13061:0" data-first-offset="true"><span data-slate-string="true">day = initp</span></span></span><span data-slate-object="text" data-key="13062"><span data-slate-leaf="true" data-offset-key="13062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13063"><span data-slate-leaf="true" data-offset-key="13063:0" data-first-offset="true"><span data-slate-string="true">kt_day;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13064"><span data-slate-object="text" data-key="13065"><span data-slate-leaf="true" data-offset-key="13065:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13066"><span data-slate-leaf="true" data-offset-key="13066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13067"><span data-slate-leaf="true" data-offset-key="13067:0" data-first-offset="true"><span data-slate-string="true">date = initp</span></span></span><span data-slate-object="text" data-key="13068"><span data-slate-leaf="true" data-offset-key="13068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13069"><span data-slate-leaf="true" data-offset-key="13069:0" data-first-offset="true"><span data-slate-string="true">kt_date;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13070"><span data-slate-object="text" data-key="13071"><span data-slate-leaf="true" data-offset-key="13071:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13072"><span data-slate-leaf="true" data-offset-key="13072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13073"><span data-slate-leaf="true" data-offset-key="13073:0" data-first-offset="true"><span data-slate-string="true">hour = initp</span></span></span><span data-slate-object="text" data-key="13074"><span data-slate-leaf="true" data-offset-key="13074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13075"><span data-slate-leaf="true" data-offset-key="13075:0" data-first-offset="true"><span data-slate-string="true">kt_hour;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13076"><span data-slate-object="text" data-key="13077"><span data-slate-leaf="true" data-offset-key="13077:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13078"><span data-slate-leaf="true" data-offset-key="13078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13079"><span data-slate-leaf="true" data-offset-key="13079:0" data-first-offset="true"><span data-slate-string="true">min = initp</span></span></span><span data-slate-object="text" data-key="13080"><span data-slate-leaf="true" data-offset-key="13080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13081"><span data-slate-leaf="true" data-offset-key="13081:0" data-first-offset="true"><span data-slate-string="true">kt_min;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13082"><span data-slate-object="text" data-key="13083"><span data-slate-leaf="true" data-offset-key="13083:0" data-first-offset="true"><span data-slate-string="true">    time</span></span></span><span data-slate-object="text" data-key="13084"><span data-slate-leaf="true" data-offset-key="13084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13085"><span data-slate-leaf="true" data-offset-key="13085:0" data-first-offset="true"><span data-slate-string="true">sec = initp</span></span></span><span data-slate-object="text" data-key="13086"><span data-slate-leaf="true" data-offset-key="13086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13087"><span data-slate-leaf="true" data-offset-key="13087:0" data-first-offset="true"><span data-slate-string="true">kt_sec;</span></span></span><span data-slate-object="text" data-key="13088"><span data-slate-leaf="true" data-offset-key="13088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把时间数据写入到参数指向的内存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13089"><span data-slate-object="text" data-key="13090"><span data-slate-leaf="true" data-offset-key="13090:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13091"><span data-slate-leaf="true" data-offset-key="13091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="13092"><span data-slate-leaf="true" data-offset-key="13092:0" data-first-offset="true"><span data-slate-string="true">(&amp;initp</span></span></span><span data-slate-object="text" data-key="13093"><span data-slate-leaf="true" data-offset-key="13093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="13094"><span data-slate-leaf="true" data-offset-key="13094:0" data-first-offset="true"><span data-slate-string="true">kt_lock, &amp;cpufg);</span></span></span><span data-slate-object="text" data-key="13095"><span data-slate-leaf="true" data-offset-key="13095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13096"><span data-slate-object="text" data-key="13097"><span data-slate-leaf="true" data-offset-key="13097:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13098"><span data-slate-leaf="true" data-offset-key="13098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13099"><span data-slate-leaf="true" data-offset-key="13099:0" data-first-offset="true"><span data-slate-string="true"> SYSSTUSOK;</span></span></span><span data-slate-object="text" data-key="13100"><span data-slate-leaf="true" data-offset-key="13100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回正确的状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13101"><span data-slate-object="text" data-key="13102"><span data-slate-leaf="true" data-offset-key="13102:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13103"><span data-slate-object="text" data-key="13104"><span data-slate-leaf="true" data-offset-key="13104:0" data-first-offset="true"><span data-slate-string="true">krlsve_time 函数，只是把系统的时间数据读取出来，写入用户应用程序传入缓冲区中，由于 osktime 这个结构实例会由其它代码自动更新，所以要加锁访问。好了，这样一个简单的系统服务函数就实现了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13105" id="sr-toc-13"><span data-slate-object="text" data-key="13106"><span data-slate-leaf="true" data-offset-key="13106:0" data-first-offset="true"><span data-slate-string="true">系统服务函数的执行过程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13107"><span data-slate-object="text" data-key="13108"><span data-slate-leaf="true" data-offset-key="13108:0" data-first-offset="true"><span data-slate-string="true">我们已经实现了一个获取时间的系统服务函数，我想你应该能自己实现其它更多的系统服务函数了。下面我来帮你梳理一下，从库函数到进入中断再到系统服务分发器，最后到系统服务函数的全过程，我给你准备了一幅图，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13109"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/ea/ff/ea47e5ba68cbf0f30a44286b7b401cff.jpg?wh=4254x3373"></div><div>系统服务流程示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13110"><span data-slate-object="text" data-key="13111"><span data-slate-leaf="true" data-offset-key="13111:0" data-first-offset="true"><span data-slate-string="true">上图中应用程序在用户空间中运行，调用库函数，库函数调用 API 函数执行 INT 指令，进入中断门，从而运行内核代码。最后内核代码一步步执行了相关服务功能，返回到用户空间继续运行应用程序。这就是应用程序调用一个系统服务的全部过程。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13112" id="sr-toc-14"><span data-slate-object="text" data-key="13113"><span data-slate-leaf="true" data-offset-key="13113:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13114"><span data-slate-object="text" data-key="13115"><span data-slate-leaf="true" data-offset-key="13115:0" data-first-offset="true"><span data-slate-string="true">这节课程又到了尾声，今天我们以获取时间的系统服务为例，一起学习了如何建立一个系统服务接口和具体服务函数实现细节。下面我梳理一下本节课的重点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13116"><span data-slate-object="text" data-key="13117"><span data-slate-leaf="true" data-offset-key="13117:0" data-first-offset="true"><span data-slate-string="true">1. 首先，我们从全局了解了 Cosmos 服务接口的结构，它是分层封装的，由库、API 接口、系统服务分发器、系统服务接口、系统服务组成的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13118"><span data-slate-object="text" data-key="13119"><span data-slate-leaf="true" data-offset-key="13119:0" data-first-offset="true"><span data-slate-string="true">2. 接着，我们学习了如何使用 int 指令触发中断，使应用程序通过中断进入内核开始执行相关的服务，同时解决了如何给内核传递参数的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13120"><span data-slate-object="text" data-key="13121"><span data-slate-leaf="true" data-offset-key="13121:0" data-first-offset="true"><span data-slate-string="true">3. 然后，我们一起实现了系统分发器和系统服务表，这是实现系统服务的重要机制。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13122"><span data-slate-object="text" data-key="13123"><span data-slate-leaf="true" data-offset-key="13123:0" data-first-offset="true"><span data-slate-string="true">4. 最后，我们从库函数开始一步步实现了获取时间的系统服务，了解了实现一个系统的全部过程和细节。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13124" id="sr-toc-15"><span data-slate-object="text" data-key="13125"><span data-slate-leaf="true" data-offset-key="13125:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13126"><span data-slate-object="text" data-key="13127"><span data-slate-leaf="true" data-offset-key="13127:0" data-first-offset="true"><span data-slate-string="true">请问 int 指令后面的常数能不能大于 255，为什么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13128"><span data-slate-object="text" data-key="13129"><span data-slate-leaf="true" data-offset-key="13129:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我交流互动，也推荐你把这节课分享给自己的朋友，跟他一起动手做做这节课的实验。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13130"><span data-slate-object="text" data-key="13131"><span data-slate-leaf="true" data-offset-key="13131:0" data-first-offset="true"><span data-slate-string="true">我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-16">精选留言 (9)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>一、数据结构
1、全局数据结构，保存系统时间，通过硬件中断更新时间
KRL_DEFGLOB_VARIABLE (ktime_t,osktime);

2、中断向量表，绑定中断编号 32 和 hxi_hwint00，特权级别设置为 PRIVILEGE_KRNL
set_idt_desc (INT_VECTOR_IRQ0 + 0, DA_386IGate, hxi_hwint00, PRIVILEGE_KRNL);

3、中断向量表，绑定中断编号 255 和 exi_sys_call，特权级别设置为 PRIVILEGE_USER
set_idt_desc (INT_VECTOR_SYSCALL, DA_386IGate, exi_sys_call, PRIVILEGE_USER);

4、全局变量 osservicetab，保存了全部系统调用入口
KRL_DEFGLOB_VARIABLE (syscall_t, osservicetab)

5、全局变量 osdrvetytabl，保存了全部驱动入口函数
驱动初始化时，设置了处理函数
osdrvetytabl-&gt;systick_entry
krlnew_devhandle (devp, systick_handle, 0x20)

二、8254 产生硬件
1、8254 产生硬件中断 0x20

2、CPU 收到中断，通过中断处理表 IDT，通过中断门门检查后，会找到中断处理入口 hxi_hwint00，实际触发了 HARWINT
然后调用了 hal_hwint_allocator
调用硬件中断处理函数 hal_do_hwint

3、hal_do_hwint
调用中断回调函数 hal_do_hwint-&gt;hal_run_intflthandle

4、hal_run_intflthandle
先获取 intfltdsc_t 中断异常表
然后调用 intfltdsc_t 中，i_serlist 上所有挂载 intserdsc_t 结构中的中断处理的回调函数 s_handle

5、8254 回调函数为 systick_handle

6、systick_handle-&gt;krlupdate_times_from_cmos
从 CMOS 读取时间信息，放到全局 osktime 中

三、时间 API 调用
1、用户态
time-&gt;api_time-&gt;API_ENTRY_PARE1 (INR_TIME, rets, ttime)
-&gt; 功能编号为 INR_TIME
-&gt; 设置返回值
-&gt; 设置参数
-&gt; 触发 int 255

2、产生 255 中断

3、内核态
CPU 收到中断，通过中断处理表 IDT，通过中断门门检查后，会找到中断处理入口 exi_sys_call，实际触发了 EXI_SCALL
调用了 hal_syscl_allocator
第一个参数为功能编号 rax，在 rdi
第二个参数为中断发生时的栈指针 rsp，在 rsi，指向内核栈
通过强制类型转换，将内核栈地址，转换为 stkparame_t，这样就可以获得参数了

然后找到系统调用处理函数 krlservice
-&gt;osservicetab [inr](inr, (stkparame_t*) sframe)，也就是调用了 krlsvetabl_time
-&gt;-&gt;krlsve_time，把系统的时间数据读取出来，写入应用程序传入缓冲区中【用户内存】

4、在中断处理到最后，内核代码会执行 RESTOREALL，返回到用户空间继续运行应用程序。

5、用户态
应用程序就可以在用户态，读取到返回结果了</div><div><p>作者回复：对的 大佬 666</p></div><div><div>2021-08-16</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div></div><div>在第五课中找到 
产生中断后，CPU 首先会检查中断号是否大于最后一个中断门描述符，x86 CPU 最大支持 256 个中断源（即中断号：0~255）

在第十三课中找到
在 x86 CPU 上，最多支持 256 个中断，还记得前面所说的中断表和中断门描述符吗，这意味着我们要准备 256 个中断门描述符和 256 个中断处理程序的入口。

所以本课的答案就一目了然了。</div><div><p>作者回复：哈哈  阅读加理解  正确</p></div><div><div>2021-08-11</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>每个中断向量都是一个 4 字节的值，中断向量表最多可以存放 256 个中断向量，所以 int 指令后面的常数不能大于 255，因为目前压根就不支持 257 号中断。</div><div><p>作者回复：是的 是的 </p></div><div><div>2021-08-11</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 苏流郁宓</span></div></div><div>那 arm 架构呢？基于 linux 内核进行二次开发的安卓系统，它的 int 指令后面的常数也是不能大于 255 吗？</div><div><p>作者回复：这是 x86 的情况</p></div><div><div>2021-08-12</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/21/7e/fb725950.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 罗 乾 林</span></div></div><div>不能，INT imm8 ，机器码为 2 字节【CD ib】最大 255 </div><div><p>作者回复：哈哈  </p></div><div><div>2021-08-11</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/32/75/37f1a9b8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>UJoy</span></div></div><div>申请内存: 
用户态 -&gt;int 255 [参数 1]-&gt;krlservice-&gt; krlsvetabl_mallocblk-&gt;krlsve_mallocblk-&gt;....-&gt; kmsob_new [内存对象] 这个返回的内核态的虚拟地址吧 【应该要返回用户态的虚拟地址吧】？</div><div><p>作者回复：这是什么代码 </p></div><div><div>2022-07-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/ef/18/6a620733.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>王子玉</span></div></div><div>请问 hal_syscl_allocator 的参数在栈上还是在寄存器啊  mov rdi,rax  mov rsi,rsp 是把参数放到寄存器 可是怎么控制 hal_syscl_allocator 到寄存器取参啊</div><div><p>作者回复：取参数 c 编译器自动处理的</p></div><div><div>2022-01-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/cabLXAUXiavXnEckAgo971o4l1CxP4L9wOV2eUGTyKBUicTib6gJyKV9iatM4GG1scz5Ym17GOzXWQEGzhE31tXUtQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>日就月将</span></div></div><div>老师，自己制作的 app 文件怎么在 Cosmos 中使用啊，已经编译成了. app 文件。但是输入 xxx.app 之后没有反应。</div><div><p>作者回复：用 41.1 的代码</p></div><div><div>2021-11-03</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>苏流郁宓</span></div></div><div>认为不能大于 255</div><div><p>作者回复：是的</p></div><div><div>2021-08-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".v"><outline class="toc-level-h1" data-reactid=".v.0" style="width: 175px;"><active data-reactid=".v.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".v.0.1"><span data-reactid=".v.0.1.0">41 | 服务接口：如何搭建沟通桥梁？</span></a></outline><outline class="toc-level-h2" data-reactid=".v.1" style="width: 165px;"><active data-reactid=".v.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".v.1.1"><span data-reactid=".v.1.1.0">服务接口的结构</span></a></outline><outline class="toc-level-h2" data-reactid=".v.2" style="width: 165px;"><active data-reactid=".v.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".v.2.1"><span data-reactid=".v.2.1.0">如何进入内核</span></a></outline><outline class="toc-level-h3" data-reactid=".v.3" style="width: 155px;"><active data-reactid=".v.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".v.3.1"><span data-reactid=".v.3.1.0">软中断指令</span></a></outline><outline class="toc-level-h3" data-reactid=".v.4" style="width: 155px;"><active data-reactid=".v.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".v.4.1"><span data-reactid=".v.4.1.0">传递参数</span></a></outline><outline class="toc-level-h2" data-reactid=".v.5" style="width: 165px;"><active data-reactid=".v.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".v.5.1"><span data-reactid=".v.5.1.0">系统服务分发器</span></a></outline><outline class="toc-level-h3" data-reactid=".v.6" style="width: 155px;"><active data-reactid=".v.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".v.6.1"><span data-reactid=".v.6.1.0">实现系统服务分发器</span></a></outline><outline class="toc-level-h3" data-reactid=".v.7" style="width: 155px;"><active data-reactid=".v.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".v.7.1"><span data-reactid=".v.7.1.0">系统服务表</span></a></outline><outline class="toc-level-h2" data-reactid=".v.8" style="width: 165px;"><active data-reactid=".v.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".v.8.1"><span data-reactid=".v.8.1.0">系统服务实例</span></a></outline><outline class="toc-level-h3" data-reactid=".v.9" style="width: 155px;"><active data-reactid=".v.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".v.9.1"><span data-reactid=".v.9.1.0">时间库</span></a></outline><outline class="toc-level-h3" data-reactid=".v.a" style="width: 155px;"><active data-reactid=".v.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".v.a.1"><span data-reactid=".v.a.1.0">时间 API 接口</span></a></outline><outline class="toc-level-h3" data-reactid=".v.b" style="width: 155px;"><active data-reactid=".v.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".v.b.1"><span data-reactid=".v.b.1.0">内核态时间服务接口</span></a></outline><outline class="toc-level-h3" data-reactid=".v.c" style="width: 155px;"><active data-reactid=".v.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".v.c.1"><span data-reactid=".v.c.1.0">实现时间服务</span></a></outline><outline class="toc-level-h3" data-reactid=".v.d" style="width: 155px;"><active data-reactid=".v.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".v.d.1"><span data-reactid=".v.d.1.0">系统服务函数的执行过程</span></a></outline><outline class="toc-level-h2" data-reactid=".v.e" style="width: 165px;"><active data-reactid=".v.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".v.e.1"><span data-reactid=".v.e.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".v.f" style="width: 165px;"><active data-reactid=".v.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".v.f.1"><span data-reactid=".v.f.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".v.g" style="width: 165px;"><active data-reactid=".v.g.0"></active><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".v.g.1"><span data-reactid=".v.g.1.0">精选留言 (9)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/406633" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>