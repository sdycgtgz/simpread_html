
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 42 | 瞧一瞧 Linux：如何实现系统 API？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>42 | 瞧一瞧 Linux：如何实现系统 API？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我们通过动手写个驱动程序体会 Linux 驱动相关的内容。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">42 | 瞧一瞧 Linux：如何实现系统 API？</h1><div><span>LMOS</span> <span>2021-08-13</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/dd/cc/dd167df59324e0d057f5f4b8dbff57cc.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：12.43M</span><span> 时长：13:37</span></div></div><audio title="42 | 瞧一瞧Linux：如何实现系统API？" src="https://res001.geekbang.org/media/audio/0f/1a/0ff6395f2a69a3c3d89b93005281351a/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="13136" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="13137"><span data-slate-object="text" data-key="13138"><span data-slate-leaf="true" data-offset-key="13138:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13139"><span data-slate-object="text" data-key="13140"><span data-slate-leaf="true" data-offset-key="13140:0" data-first-offset="true"><span data-slate-string="true">上节课，我们通过实现一个获取时间的系统服务，学习了 Cosmos 里如何建立一个系统服务接口。Cosmos 为应用程序提供服务的过程大致是这样的：应用程序先设置服务参数，然后通过 int 指令进入内核，由 Cosmos 内核运行相应的服务函数，最后为应用程序提供所需服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13141"><span data-slate-object="text" data-key="13142"><span data-slate-leaf="true" data-offset-key="13142:0" data-first-offset="true"><span data-slate-string="true">不知道你是否好奇过业内成熟的 Linux 内核，又是怎样为应用程序提供服务的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13143"><span data-slate-object="text" data-key="13144"><span data-slate-leaf="true" data-offset-key="13144:0" data-first-offset="true"><span data-slate-string="true">这节课我们就来看看 Linux 内核是如何实现这一过程的，我们首先了解一下 Linux 内核有多少 API 接口，然后了解一下 Linux 内核 API 接口的架构，最后，我们动手为 Linux 内核增加一个全新的 API，并实现相应的功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13145"><span data-slate-object="text" data-key="13146"><span data-slate-leaf="true" data-offset-key="13146:0" data-first-offset="true"><span data-slate-string="true">下面让我们开始吧！这节课的配套代码你可以从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13147"><span data-slate-object="text" data-key="13148"><span data-slate-leaf="true" data-offset-key="13148:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="13149"><span data-slate-leaf="true" data-offset-key="13149:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13150" id="sr-toc-1"><span data-slate-object="text" data-key="13151"><span data-slate-leaf="true" data-offset-key="13151:0" data-first-offset="true"><span data-slate-string="true">Linux 内核 API 接口的架构</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13152"><span data-slate-object="text" data-key="13153"><span data-slate-leaf="true" data-offset-key="13153:0" data-first-offset="true"><span data-slate-string="true">在上节课中，我们已经熟悉了我们自己的 Cosmos 内核服务接口的架构，由应用程序调用库函数，再由库函数调用 API 入口函数，进入内核函数执行系统服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13154"><span data-slate-object="text" data-key="13155"><span data-slate-leaf="true" data-offset-key="13155:0" data-first-offset="true"><span data-slate-string="true">其实对于 Linux 内核也是一样，应用程序会调用库函数，在库函数中调用 API 入口函数，触发中断进入 Linux 内核执行系统调用，完成相应的功能服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13156"><span data-slate-object="text" data-key="13157"><span data-slate-leaf="true" data-offset-key="13157:0" data-first-offset="true"><span data-slate-string="true">在 Linux 内核之上，使用最广泛的 C 库是 glibc，其中包括 C 标准库的实现，也包括所有和系统 API 对应的库接口函数。几乎所有 C 程序都要调用 glibc 的库函数，所以 </span></span></span><span data-slate-object="text" data-key="13158"><span data-slate-leaf="true" data-offset-key="13158:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">glibc 是 Linux 内核上 C 程序运行的基础。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13159"><span data-slate-object="text" data-key="13160"><span data-slate-leaf="true" data-offset-key="13160:0" data-first-offset="true"><span data-slate-string="true">下面我们以 open 库函数为例分析一下，看看 open 是如何进入 Linux 内核调用相关的系统调用的。glibc 虽然开源了，但是并没有在 Linux 内核代码之中，你需要从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13161"><span data-slate-object="text" data-key="13162"><span data-slate-leaf="true" data-offset-key="13162:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="13163"><span data-slate-leaf="true" data-offset-key="13163:0" data-first-offset="true"><span data-slate-string="true">下载并解压，open 函数代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13164"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13165"><span data-slate-object="text" data-key="13166"><span data-slate-leaf="true" data-offset-key="13166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//glibc/intl/loadmsgcat.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13167"><span data-slate-object="text" data-key="13168"><span data-slate-leaf="true" data-offset-key="13168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13169"><span data-slate-leaf="true" data-offset-key="13169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ifdef</span></span></span></span></span><span data-slate-object="text" data-key="13170"><span data-slate-leaf="true" data-offset-key="13170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> _LIBC</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13171"><span data-slate-object="text" data-key="13172"><span data-slate-leaf="true" data-offset-key="13172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># </span></span></span></span><span data-slate-object="text" data-key="13173"><span data-slate-leaf="true" data-offset-key="13173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13174"><span data-slate-leaf="true" data-offset-key="13174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> open(name, flags)  __open_nocancel (name, flags)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13175"><span data-slate-object="text" data-key="13176"><span data-slate-leaf="true" data-offset-key="13176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># </span></span></span></span><span data-slate-object="text" data-key="13177"><span data-slate-leaf="true" data-offset-key="13177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13178"><span data-slate-leaf="true" data-offset-key="13178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> close(fd)      __close_nocancel_nostatus (fd)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13179"><span data-slate-object="text" data-key="13180"><span data-slate-leaf="true" data-offset-key="13180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13181"><span data-slate-leaf="true" data-offset-key="13181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13182"><span data-slate-object="text" data-key="13183"><span data-slate-leaf="true" data-offset-key="13183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//glibc/sysdeps/unix/sysv/linux/open_nocancel.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13184"><span data-slate-object="text" data-key="13185"><span data-slate-leaf="true" data-offset-key="13185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13186"><span data-slate-leaf="true" data-offset-key="13186:0" data-first-offset="true"><span data-slate-string="true"> __open_nocancel (</span></span></span><span data-slate-object="text" data-key="13187"><span data-slate-leaf="true" data-offset-key="13187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="13188"><span data-slate-leaf="true" data-offset-key="13188:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13189"><span data-slate-leaf="true" data-offset-key="13189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="13190"><span data-slate-leaf="true" data-offset-key="13190:0" data-first-offset="true"><span data-slate-string="true"> *file, </span></span></span><span data-slate-object="text" data-key="13191"><span data-slate-leaf="true" data-offset-key="13191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13192"><span data-slate-leaf="true" data-offset-key="13192:0" data-first-offset="true"><span data-slate-string="true"> oflag, ...)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13193"><span data-slate-object="text" data-key="13194"><span data-slate-leaf="true" data-offset-key="13194:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13195"><span data-slate-object="text" data-key="13196"><span data-slate-leaf="true" data-offset-key="13196:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13197"><span data-slate-leaf="true" data-offset-key="13197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13198"><span data-slate-leaf="true" data-offset-key="13198:0" data-first-offset="true"><span data-slate-string="true"> mode = </span></span></span><span data-slate-object="text" data-key="13199"><span data-slate-leaf="true" data-offset-key="13199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13200"><span data-slate-leaf="true" data-offset-key="13200:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13201"><span data-slate-object="text" data-key="13202"><span data-slate-leaf="true" data-offset-key="13202:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13203"><span data-slate-leaf="true" data-offset-key="13203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13204"><span data-slate-leaf="true" data-offset-key="13204:0" data-first-offset="true"><span data-slate-string="true"> (__OPEN_NEEDS_MODE (oflag))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13205"><span data-slate-object="text" data-key="13206"><span data-slate-leaf="true" data-offset-key="13206:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13207"><span data-slate-object="text" data-key="13208"><span data-slate-leaf="true" data-offset-key="13208:0" data-first-offset="true"><span data-slate-string="true">      va_list arg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13209"><span data-slate-object="text" data-key="13210"><span data-slate-leaf="true" data-offset-key="13210:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13211"><span data-slate-leaf="true" data-offset-key="13211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">va_start</span></span></span></span><span data-slate-object="text" data-key="13212"><span data-slate-leaf="true" data-offset-key="13212:0" data-first-offset="true"><span data-slate-string="true"> (arg, oflag);</span></span></span><span data-slate-object="text" data-key="13213"><span data-slate-leaf="true" data-offset-key="13213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解决可变参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13214"><span data-slate-object="text" data-key="13215"><span data-slate-leaf="true" data-offset-key="13215:0" data-first-offset="true"><span data-slate-string="true">      mode = </span></span></span><span data-slate-object="text" data-key="13216"><span data-slate-leaf="true" data-offset-key="13216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">va_arg</span></span></span></span><span data-slate-object="text" data-key="13217"><span data-slate-leaf="true" data-offset-key="13217:0" data-first-offset="true"><span data-slate-string="true"> (arg, </span></span></span><span data-slate-object="text" data-key="13218"><span data-slate-leaf="true" data-offset-key="13218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13219"><span data-slate-leaf="true" data-offset-key="13219:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13220"><span data-slate-object="text" data-key="13221"><span data-slate-leaf="true" data-offset-key="13221:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13222"><span data-slate-leaf="true" data-offset-key="13222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">va_end</span></span></span></span><span data-slate-object="text" data-key="13223"><span data-slate-leaf="true" data-offset-key="13223:0" data-first-offset="true"><span data-slate-string="true"> (arg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13224"><span data-slate-object="text" data-key="13225"><span data-slate-leaf="true" data-offset-key="13225:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13226"><span data-slate-object="text" data-key="13227"><span data-slate-leaf="true" data-offset-key="13227:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13228"><span data-slate-leaf="true" data-offset-key="13228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13229"><span data-slate-leaf="true" data-offset-key="13229:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13230"><span data-slate-leaf="true" data-offset-key="13230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">INLINE_SYSCALL_CALL</span></span></span></span><span data-slate-object="text" data-key="13231"><span data-slate-leaf="true" data-offset-key="13231:0" data-first-offset="true"><span data-slate-string="true"> (openat, AT_FDCWD, file, oflag, mode);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13232"><span data-slate-object="text" data-key="13233"><span data-slate-leaf="true" data-offset-key="13233:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13234"><span data-slate-object="text" data-key="13235"><span data-slate-leaf="true" data-offset-key="13235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//glibc/sysdeps/unix/sysdep.h</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13236"><span data-slate-object="text" data-key="13237"><span data-slate-leaf="true" data-offset-key="13237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这是为了解决不同参数数量的问题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13238"><span data-slate-object="text" data-key="13239"><span data-slate-leaf="true" data-offset-key="13239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13240"><span data-slate-leaf="true" data-offset-key="13240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13241"><span data-slate-leaf="true" data-offset-key="13241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL0(name) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13242"><span data-slate-object="text" data-key="13243"><span data-slate-leaf="true" data-offset-key="13243:0" data-first-offset="true"><span data-slate-string="true">  INLINE_SYSCALL (name, 0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13244"><span data-slate-object="text" data-key="13245"><span data-slate-leaf="true" data-offset-key="13245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13246"><span data-slate-leaf="true" data-offset-key="13246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13247"><span data-slate-leaf="true" data-offset-key="13247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL1(name, a1) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13248"><span data-slate-object="text" data-key="13249"><span data-slate-leaf="true" data-offset-key="13249:0" data-first-offset="true"><span data-slate-string="true">  INLINE_SYSCALL (name, 1, a1)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13250"><span data-slate-object="text" data-key="13251"><span data-slate-leaf="true" data-offset-key="13251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13252"><span data-slate-leaf="true" data-offset-key="13252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13253"><span data-slate-leaf="true" data-offset-key="13253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL2(name, a1, a2) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13254"><span data-slate-object="text" data-key="13255"><span data-slate-leaf="true" data-offset-key="13255:0" data-first-offset="true"><span data-slate-string="true">  INLINE_SYSCALL (name, 2, a1, a2)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13256"><span data-slate-object="text" data-key="13257"><span data-slate-leaf="true" data-offset-key="13257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13258"><span data-slate-leaf="true" data-offset-key="13258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13259"><span data-slate-leaf="true" data-offset-key="13259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL3(name, a1, a2, a3) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13260"><span data-slate-object="text" data-key="13261"><span data-slate-leaf="true" data-offset-key="13261:0" data-first-offset="true"><span data-slate-string="true">  INLINE_SYSCALL (name, 3, a1, a2, a3)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13262"><span data-slate-object="text" data-key="13263"><span data-slate-leaf="true" data-offset-key="13263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13264"><span data-slate-leaf="true" data-offset-key="13264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13265"><span data-slate-leaf="true" data-offset-key="13265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL_NARGS_X(a,b,c,d,e,f,g,h,n,...) n</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13266"><span data-slate-object="text" data-key="13267"><span data-slate-leaf="true" data-offset-key="13267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13268"><span data-slate-leaf="true" data-offset-key="13268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13269"><span data-slate-leaf="true" data-offset-key="13269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL_NARGS(...) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13270"><span data-slate-object="text" data-key="13271"><span data-slate-leaf="true" data-offset-key="13271:0" data-first-offset="true"><span data-slate-string="true">  __INLINE_SYSCALL_NARGS_X (__VA_ARGS__,7,6,5,4,3,2,1,0,)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13272"><span data-slate-object="text" data-key="13273"><span data-slate-leaf="true" data-offset-key="13273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13274"><span data-slate-leaf="true" data-offset-key="13274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13275"><span data-slate-leaf="true" data-offset-key="13275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __INLINE_SYSCALL_DISP(b,...) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13276"><span data-slate-object="text" data-key="13277"><span data-slate-leaf="true" data-offset-key="13277:0" data-first-offset="true"><span data-slate-string="true">  __SYSCALL_CONCAT (b,__INLINE_SYSCALL_NARGS(__VA_ARGS__))(__VA_ARGS__)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13278"><span data-slate-object="text" data-key="13279"><span data-slate-leaf="true" data-offset-key="13279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13280"><span data-slate-leaf="true" data-offset-key="13280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13281"><span data-slate-leaf="true" data-offset-key="13281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> INLINE_SYSCALL_CALL(...) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13282"><span data-slate-object="text" data-key="13283"><span data-slate-leaf="true" data-offset-key="13283:0" data-first-offset="true"><span data-slate-string="true">  __INLINE_SYSCALL_DISP (__INLINE_SYSCALL, __VA_ARGS__)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13284"><span data-slate-object="text" data-key="13285"><span data-slate-leaf="true" data-offset-key="13285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//glibc/sysdeps/unix/sysv/linux/sysdep.h</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13286"><span data-slate-object="text" data-key="13287"><span data-slate-leaf="true" data-offset-key="13287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关键是这个宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13288"><span data-slate-object="text" data-key="13289"><span data-slate-leaf="true" data-offset-key="13289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13290"><span data-slate-leaf="true" data-offset-key="13290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13291"><span data-slate-leaf="true" data-offset-key="13291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> INLINE_SYSCALL(name, nr, args...)       \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13292"><span data-slate-object="text" data-key="13293"><span data-slate-leaf="true" data-offset-key="13293:0" data-first-offset="true"><span data-slate-string="true">  ({                  \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13294"><span data-slate-object="text" data-key="13295"><span data-slate-leaf="true" data-offset-key="13295:0" data-first-offset="true"><span data-slate-string="true">    long int sc_ret = INTERNAL_SYSCALL (name, nr, args);    \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13296"><span data-slate-object="text" data-key="13297"><span data-slate-leaf="true" data-offset-key="13297:0" data-first-offset="true"><span data-slate-string="true">    __glibc_unlikely (INTERNAL_SYSCALL_ERROR_P (sc_ret))    \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13298"><span data-slate-object="text" data-key="13299"><span data-slate-leaf="true" data-offset-key="13299:0" data-first-offset="true"><span data-slate-string="true">    ? SYSCALL_ERROR_LABEL (INTERNAL_SYSCALL_ERRNO (sc_ret))   \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13300"><span data-slate-object="text" data-key="13301"><span data-slate-leaf="true" data-offset-key="13301:0" data-first-offset="true"><span data-slate-string="true">    : sc_ret;               \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13302"><span data-slate-object="text" data-key="13303"><span data-slate-leaf="true" data-offset-key="13303:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13304"><span data-slate-object="text" data-key="13305"><span data-slate-leaf="true" data-offset-key="13305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13306"><span data-slate-leaf="true" data-offset-key="13306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13307"><span data-slate-leaf="true" data-offset-key="13307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> INTERNAL_SYSCALL(name, nr, args...)       \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13308"><span data-slate-object="text" data-key="13309"><span data-slate-leaf="true" data-offset-key="13309:0" data-first-offset="true"><span data-slate-string="true">  internal_syscall##nr (SYS_ify (name), args)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13310"><span data-slate-object="text" data-key="13311"><span data-slate-leaf="true" data-offset-key="13311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13312"><span data-slate-leaf="true" data-offset-key="13312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13313"><span data-slate-leaf="true" data-offset-key="13313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> INTERNAL_SYSCALL_NCS(number, nr, args...)     \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13314"><span data-slate-object="text" data-key="13315"><span data-slate-leaf="true" data-offset-key="13315:0" data-first-offset="true"><span data-slate-string="true">  internal_syscall##nr (number, args)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13316"><span data-slate-object="text" data-key="13317"><span data-slate-leaf="true" data-offset-key="13317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这是需要 6 个参数的宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13318"><span data-slate-object="text" data-key="13319"><span data-slate-leaf="true" data-offset-key="13319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13320"><span data-slate-leaf="true" data-offset-key="13320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13321"><span data-slate-leaf="true" data-offset-key="13321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> internal_syscall6(number, arg1, arg2, arg3, arg4, arg5, arg6) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13322"><span data-slate-object="text" data-key="13323"><span data-slate-leaf="true" data-offset-key="13323:0" data-first-offset="true"><span data-slate-string="true">({                  \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13324"><span data-slate-object="text" data-key="13325"><span data-slate-leaf="true" data-offset-key="13325:0" data-first-offset="true"><span data-slate-string="true">    unsigned long int resultvar;          \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13326"><span data-slate-object="text" data-key="13327"><span data-slate-leaf="true" data-offset-key="13327:0" data-first-offset="true"><span data-slate-string="true">    TYPEFY (arg6, __arg6) = ARGIFY (arg6);        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13328"><span data-slate-object="text" data-key="13329"><span data-slate-leaf="true" data-offset-key="13329:0" data-first-offset="true"><span data-slate-string="true">    TYPEFY (arg5, __arg5) = ARGIFY (arg5);        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13330"><span data-slate-object="text" data-key="13331"><span data-slate-leaf="true" data-offset-key="13331:0" data-first-offset="true"><span data-slate-string="true">    TYPEFY (arg4, __arg4) = ARGIFY (arg4);        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13332"><span data-slate-object="text" data-key="13333"><span data-slate-leaf="true" data-offset-key="13333:0" data-first-offset="true"><span data-slate-string="true">    TYPEFY (arg3, __arg3) = ARGIFY (arg3);        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13334"><span data-slate-object="text" data-key="13335"><span data-slate-leaf="true" data-offset-key="13335:0" data-first-offset="true"><span data-slate-string="true">    TYPEFY (arg2, __arg2) = ARGIFY (arg2);        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13336"><span data-slate-object="text" data-key="13337"><span data-slate-leaf="true" data-offset-key="13337:0" data-first-offset="true"><span data-slate-string="true">    TYPEFY (arg1, __arg1) = ARGIFY (arg1);        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13338"><span data-slate-object="text" data-key="13339"><span data-slate-leaf="true" data-offset-key="13339:0" data-first-offset="true"><span data-slate-string="true">    register TYPEFY (arg6, _a6) asm (</span></span></span><span data-slate-object="text" data-key="13340"><span data-slate-leaf="true" data-offset-key="13340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r9"</span></span></span></span><span data-slate-object="text" data-key="13341"><span data-slate-leaf="true" data-offset-key="13341:0" data-first-offset="true"><span data-slate-string="true">) = __arg6;      \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13342"><span data-slate-object="text" data-key="13343"><span data-slate-leaf="true" data-offset-key="13343:0" data-first-offset="true"><span data-slate-string="true">    register TYPEFY (arg5, _a5) asm (</span></span></span><span data-slate-object="text" data-key="13344"><span data-slate-leaf="true" data-offset-key="13344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r8"</span></span></span></span><span data-slate-object="text" data-key="13345"><span data-slate-leaf="true" data-offset-key="13345:0" data-first-offset="true"><span data-slate-string="true">) = __arg5;      \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13346"><span data-slate-object="text" data-key="13347"><span data-slate-leaf="true" data-offset-key="13347:0" data-first-offset="true"><span data-slate-string="true">    register TYPEFY (arg4, _a4) asm (</span></span></span><span data-slate-object="text" data-key="13348"><span data-slate-leaf="true" data-offset-key="13348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r10"</span></span></span></span><span data-slate-object="text" data-key="13349"><span data-slate-leaf="true" data-offset-key="13349:0" data-first-offset="true"><span data-slate-string="true">) = __arg4;     \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13350"><span data-slate-object="text" data-key="13351"><span data-slate-leaf="true" data-offset-key="13351:0" data-first-offset="true"><span data-slate-string="true">    register TYPEFY (arg3, _a3) asm (</span></span></span><span data-slate-object="text" data-key="13352"><span data-slate-leaf="true" data-offset-key="13352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rdx"</span></span></span></span><span data-slate-object="text" data-key="13353"><span data-slate-leaf="true" data-offset-key="13353:0" data-first-offset="true"><span data-slate-string="true">) = __arg3;     \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13354"><span data-slate-object="text" data-key="13355"><span data-slate-leaf="true" data-offset-key="13355:0" data-first-offset="true"><span data-slate-string="true">    register TYPEFY (arg2, _a2) asm (</span></span></span><span data-slate-object="text" data-key="13356"><span data-slate-leaf="true" data-offset-key="13356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rsi"</span></span></span></span><span data-slate-object="text" data-key="13357"><span data-slate-leaf="true" data-offset-key="13357:0" data-first-offset="true"><span data-slate-string="true">) = __arg2;     \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13358"><span data-slate-object="text" data-key="13359"><span data-slate-leaf="true" data-offset-key="13359:0" data-first-offset="true"><span data-slate-string="true">    register TYPEFY (arg1, _a1) asm (</span></span></span><span data-slate-object="text" data-key="13360"><span data-slate-leaf="true" data-offset-key="13360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rdi"</span></span></span></span><span data-slate-object="text" data-key="13361"><span data-slate-leaf="true" data-offset-key="13361:0" data-first-offset="true"><span data-slate-string="true">) = __arg1;     \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13362"><span data-slate-object="text" data-key="13363"><span data-slate-leaf="true" data-offset-key="13363:0" data-first-offset="true"><span data-slate-string="true">    asm volatile (              \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13364"><span data-slate-object="text" data-key="13365"><span data-slate-leaf="true" data-offset-key="13365:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13366"><span data-slate-leaf="true" data-offset-key="13366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"syscall\n\t"</span></span></span></span><span data-slate-object="text" data-key="13367"><span data-slate-leaf="true" data-offset-key="13367:0" data-first-offset="true"><span data-slate-string="true">             \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13368"><span data-slate-object="text" data-key="13369"><span data-slate-leaf="true" data-offset-key="13369:0" data-first-offset="true"><span data-slate-string="true">    : </span></span></span><span data-slate-object="text" data-key="13370"><span data-slate-leaf="true" data-offset-key="13370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=a"</span></span></span></span><span data-slate-object="text" data-key="13371"><span data-slate-leaf="true" data-offset-key="13371:0" data-first-offset="true"><span data-slate-string="true"> (resultvar)              \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13372"><span data-slate-object="text" data-key="13373"><span data-slate-leaf="true" data-offset-key="13373:0" data-first-offset="true"><span data-slate-string="true">    : </span></span></span><span data-slate-object="text" data-key="13374"><span data-slate-leaf="true" data-offset-key="13374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"0"</span></span></span></span><span data-slate-object="text" data-key="13375"><span data-slate-leaf="true" data-offset-key="13375:0" data-first-offset="true"><span data-slate-string="true"> (number), </span></span></span><span data-slate-object="text" data-key="13376"><span data-slate-leaf="true" data-offset-key="13376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="13377"><span data-slate-leaf="true" data-offset-key="13377:0" data-first-offset="true"><span data-slate-string="true"> (_a1), </span></span></span><span data-slate-object="text" data-key="13378"><span data-slate-leaf="true" data-offset-key="13378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="13379"><span data-slate-leaf="true" data-offset-key="13379:0" data-first-offset="true"><span data-slate-string="true"> (_a2), </span></span></span><span data-slate-object="text" data-key="13380"><span data-slate-leaf="true" data-offset-key="13380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="13381"><span data-slate-leaf="true" data-offset-key="13381:0" data-first-offset="true"><span data-slate-string="true"> (_a3), </span></span></span><span data-slate-object="text" data-key="13382"><span data-slate-leaf="true" data-offset-key="13382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="13383"><span data-slate-leaf="true" data-offset-key="13383:0" data-first-offset="true"><span data-slate-string="true"> (_a4),   \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13384"><span data-slate-object="text" data-key="13385"><span data-slate-leaf="true" data-offset-key="13385:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13386"><span data-slate-leaf="true" data-offset-key="13386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="13387"><span data-slate-leaf="true" data-offset-key="13387:0" data-first-offset="true"><span data-slate-string="true"> (_a5), </span></span></span><span data-slate-object="text" data-key="13388"><span data-slate-leaf="true" data-offset-key="13388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"r"</span></span></span></span><span data-slate-object="text" data-key="13389"><span data-slate-leaf="true" data-offset-key="13389:0" data-first-offset="true"><span data-slate-string="true"> (_a6)            \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13390"><span data-slate-object="text" data-key="13391"><span data-slate-leaf="true" data-offset-key="13391:0" data-first-offset="true"><span data-slate-string="true">    : </span></span></span><span data-slate-object="text" data-key="13392"><span data-slate-leaf="true" data-offset-key="13392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="13393"><span data-slate-leaf="true" data-offset-key="13393:0" data-first-offset="true"><span data-slate-string="true">, REGISTERS_CLOBBERED_BY_SYSCALL);      \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13394"><span data-slate-object="text" data-key="13395"><span data-slate-leaf="true" data-offset-key="13395:0" data-first-offset="true"><span data-slate-string="true">    (long int) resultvar;           \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13396"><span data-slate-object="text" data-key="13397"><span data-slate-leaf="true" data-offset-key="13397:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13398"><span data-slate-object="text" data-key="13399"><span data-slate-leaf="true" data-offset-key="13399:0" data-first-offset="true"><span data-slate-string="true">上述代码中，我们可以清楚地看到，open 只是宏，实际工作的是 __open_nocancel 函数，其中会用 INLINE_SYSCALL_CALL 宏经过一系列替换，最终根据参数的个数替换成相应的 internal_syscall##nr 宏。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13400"><span data-slate-object="text" data-key="13401"><span data-slate-leaf="true" data-offset-key="13401:0" data-first-offset="true"><span data-slate-string="true">比如有 6 个参数，就会替换成 internal_syscall6。其中 number 是系统调用号，参数通过寄存器传递的。但是这里我们没有发现 int 指令，这是因为这里用到的指令是最新处理器为其设计的系统调用指令 syscall。这个指令和 int 指令一样，都可以让 CPU 跳转到特定的地址上，只不过不经过中断门，系统调用返回时要用 sysexit 指令。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13402"><span data-slate-object="text" data-key="13403"><span data-slate-leaf="true" data-offset-key="13403:0" data-first-offset="true"><span data-slate-string="true">好了，我们已经了解了这个 open 函数的调用流程，如果用一幅图来展示 Linux 内核 API 的架构，就会呈现后面这个样子。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13404"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/03/8f/03yy161484ed15837f58a4283b960c8f.jpg?wh=3363x2822"></div><div>LinuxAPI 框架</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13405"><span data-slate-object="text" data-key="13406"><span data-slate-leaf="true" data-offset-key="13406:0" data-first-offset="true"><span data-slate-string="true">有了前面代码流程分析和结构示意图，我想你会对 Linux 内核 API 的框架结构加深了解。上图中的系统调用表和许多 sys_xxxx 函数你可能不太明白，别担心，我们后面就会讲到。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13407"><span data-slate-object="text" data-key="13408"><span data-slate-leaf="true" data-offset-key="13408:0" data-first-offset="true"><span data-slate-string="true">那么 Linux 系统有多少个 API 呢？我们一起去看看吧。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13409" id="sr-toc-2"><span data-slate-object="text" data-key="13410"><span data-slate-leaf="true" data-offset-key="13410:0" data-first-offset="true"><span data-slate-string="true">Linux 内核有多少 API 接口</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13411"><span data-slate-object="text" data-key="13412"><span data-slate-leaf="true" data-offset-key="13412:0" data-first-offset="true"><span data-slate-string="true">Linux 作为比较成熟的操作系统，功能完善，它以众多 API 接口的方式向应用程序提供文件、网络、进程、时间等待服务，并且完美执行了国际 posix 标准。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13413"><span data-slate-object="text" data-key="13414"><span data-slate-leaf="true" data-offset-key="13414:0" data-first-offset="true"><span data-slate-string="true">Linux 从最初几十个 API 接口，现在已经发展到了几百个 API 接口，从这里你可以预见到 Linux 内核功能增加的速度与数量。那么现在的 Linux 内核究竟有多少个 API 接口呢？我们还是要来看看最新发布的 Linux 内核版本，才能准确知道。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13415"><span data-slate-object="text" data-key="13416"><span data-slate-leaf="true" data-offset-key="13416:0" data-first-offset="true"><span data-slate-string="true">具体我们需要对 Linux 代码进行编译，在编译的过程中，根据 syscall_32.tbl 和 syscall_64.tbl 生成自己的 syscalls_32.h 和 syscalls_64.h 文件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13417"><span data-slate-object="text" data-key="13418"><span data-slate-leaf="true" data-offset-key="13418:0" data-first-offset="true"><span data-slate-string="true">生成方式在 arch/x86/entry/syscalls/Makefile 文件中。这里面会使用两个脚本，即 syscallhdr.sh、syscalltbl.sh，它们最终生成的 syscalls_32.h 和 syscalls_64.h 两个文件中就保存了</span></span></span><span data-slate-object="text" data-key="13419"><span data-slate-leaf="true" data-offset-key="13419:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">系统调用号和系统调用实现函数之间的对应关系</span></span></span></span><span data-slate-object="text" data-key="13420"><span data-slate-leaf="true" data-offset-key="13420:0" data-first-offset="true"><span data-slate-string="true">，在里面可以看到 Linux 内核的系统调用号，即 API 号，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13421"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13422"><span data-slate-object="text" data-key="13423"><span data-slate-leaf="true" data-offset-key="13423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//linux/arch/x86/include/generated/asm/syscalls_64.h</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13424"><span data-slate-object="text" data-key="13425"><span data-slate-leaf="true" data-offset-key="13425:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13426"><span data-slate-leaf="true" data-offset-key="13426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13427"><span data-slate-leaf="true" data-offset-key="13427:0" data-first-offset="true"><span data-slate-string="true">, sys_read)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13428"><span data-slate-object="text" data-key="13429"><span data-slate-leaf="true" data-offset-key="13429:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13430"><span data-slate-leaf="true" data-offset-key="13430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="13431"><span data-slate-leaf="true" data-offset-key="13431:0" data-first-offset="true"><span data-slate-string="true">, sys_write)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13432"><span data-slate-object="text" data-key="13433"><span data-slate-leaf="true" data-offset-key="13433:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13434"><span data-slate-leaf="true" data-offset-key="13434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="13435"><span data-slate-leaf="true" data-offset-key="13435:0" data-first-offset="true"><span data-slate-string="true">, sys_open)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13436"><span data-slate-object="text" data-key="13437"><span data-slate-leaf="true" data-offset-key="13437:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13438"><span data-slate-leaf="true" data-offset-key="13438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="13439"><span data-slate-leaf="true" data-offset-key="13439:0" data-first-offset="true"><span data-slate-string="true">, sys_close)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13440"><span data-slate-object="text" data-key="13441"><span data-slate-leaf="true" data-offset-key="13441:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13442"><span data-slate-leaf="true" data-offset-key="13442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="13443"><span data-slate-leaf="true" data-offset-key="13443:0" data-first-offset="true"><span data-slate-string="true">, sys_newstat)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13444"><span data-slate-object="text" data-key="13445"><span data-slate-leaf="true" data-offset-key="13445:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13446"><span data-slate-leaf="true" data-offset-key="13446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="13447"><span data-slate-leaf="true" data-offset-key="13447:0" data-first-offset="true"><span data-slate-string="true">, sys_newfstat)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13448"><span data-slate-object="text" data-key="13449"><span data-slate-leaf="true" data-offset-key="13449:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13450"><span data-slate-leaf="true" data-offset-key="13450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span><span data-slate-object="text" data-key="13451"><span data-slate-leaf="true" data-offset-key="13451:0" data-first-offset="true"><span data-slate-string="true">, sys_newlstat)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13452"><span data-slate-object="text" data-key="13453"><span data-slate-leaf="true" data-offset-key="13453:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13454"><span data-slate-leaf="true" data-offset-key="13454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">7</span></span></span></span><span data-slate-object="text" data-key="13455"><span data-slate-leaf="true" data-offset-key="13455:0" data-first-offset="true"><span data-slate-string="true">, sys_poll)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13456"><span data-slate-object="text" data-key="13457"><span data-slate-leaf="true" data-offset-key="13457:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13458"><span data-slate-leaf="true" data-offset-key="13458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span><span data-slate-object="text" data-key="13459"><span data-slate-leaf="true" data-offset-key="13459:0" data-first-offset="true"><span data-slate-string="true">, sys_lseek)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13460"><span data-slate-object="text" data-key="13461"><span data-slate-leaf="true" data-offset-key="13461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13462"><span data-slate-object="text" data-key="13463"><span data-slate-leaf="true" data-offset-key="13463:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13464"><span data-slate-leaf="true" data-offset-key="13464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">435</span></span></span></span><span data-slate-object="text" data-key="13465"><span data-slate-leaf="true" data-offset-key="13465:0" data-first-offset="true"><span data-slate-string="true">, sys_clone3)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13466"><span data-slate-object="text" data-key="13467"><span data-slate-leaf="true" data-offset-key="13467:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13468"><span data-slate-leaf="true" data-offset-key="13468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">436</span></span></span></span><span data-slate-object="text" data-key="13469"><span data-slate-leaf="true" data-offset-key="13469:0" data-first-offset="true"><span data-slate-string="true">, sys_close_range)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13470"><span data-slate-object="text" data-key="13471"><span data-slate-leaf="true" data-offset-key="13471:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13472"><span data-slate-leaf="true" data-offset-key="13472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">437</span></span></span></span><span data-slate-object="text" data-key="13473"><span data-slate-leaf="true" data-offset-key="13473:0" data-first-offset="true"><span data-slate-string="true">, sys_openat2)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13474"><span data-slate-object="text" data-key="13475"><span data-slate-leaf="true" data-offset-key="13475:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13476"><span data-slate-leaf="true" data-offset-key="13476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">438</span></span></span></span><span data-slate-object="text" data-key="13477"><span data-slate-leaf="true" data-offset-key="13477:0" data-first-offset="true"><span data-slate-string="true">, sys_pidfd_getfd)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13478"><span data-slate-object="text" data-key="13479"><span data-slate-leaf="true" data-offset-key="13479:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13480"><span data-slate-leaf="true" data-offset-key="13480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">439</span></span></span></span><span data-slate-object="text" data-key="13481"><span data-slate-leaf="true" data-offset-key="13481:0" data-first-offset="true"><span data-slate-string="true">, sys_faccessat2)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13482"><span data-slate-object="text" data-key="13483"><span data-slate-leaf="true" data-offset-key="13483:0" data-first-offset="true"><span data-slate-string="true">__SYSCALL_COMMON(</span></span></span><span data-slate-object="text" data-key="13484"><span data-slate-leaf="true" data-offset-key="13484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">440</span></span></span></span><span data-slate-object="text" data-key="13485"><span data-slate-leaf="true" data-offset-key="13485:0" data-first-offset="true"><span data-slate-string="true">, sys_process_madvise)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13486"><span data-slate-object="text" data-key="13487"><span data-slate-leaf="true" data-offset-key="13487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//linux/arch/x86/include/generated/uapi/asm/unistd_64.h</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13488"><span data-slate-object="text" data-key="13489"><span data-slate-leaf="true" data-offset-key="13489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13490"><span data-slate-leaf="true" data-offset-key="13490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13491"><span data-slate-leaf="true" data-offset-key="13491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_read 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13492"><span data-slate-object="text" data-key="13493"><span data-slate-leaf="true" data-offset-key="13493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13494"><span data-slate-leaf="true" data-offset-key="13494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13495"><span data-slate-leaf="true" data-offset-key="13495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_write 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13496"><span data-slate-object="text" data-key="13497"><span data-slate-leaf="true" data-offset-key="13497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13498"><span data-slate-leaf="true" data-offset-key="13498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13499"><span data-slate-leaf="true" data-offset-key="13499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_open 2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13500"><span data-slate-object="text" data-key="13501"><span data-slate-leaf="true" data-offset-key="13501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13502"><span data-slate-leaf="true" data-offset-key="13502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13503"><span data-slate-leaf="true" data-offset-key="13503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_close 3</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13504"><span data-slate-object="text" data-key="13505"><span data-slate-leaf="true" data-offset-key="13505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13506"><span data-slate-leaf="true" data-offset-key="13506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13507"><span data-slate-leaf="true" data-offset-key="13507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_stat 4</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13508"><span data-slate-object="text" data-key="13509"><span data-slate-leaf="true" data-offset-key="13509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13510"><span data-slate-leaf="true" data-offset-key="13510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13511"><span data-slate-leaf="true" data-offset-key="13511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_fstat 5</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13512"><span data-slate-object="text" data-key="13513"><span data-slate-leaf="true" data-offset-key="13513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13514"><span data-slate-leaf="true" data-offset-key="13514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13515"><span data-slate-leaf="true" data-offset-key="13515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_lstat 6</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13516"><span data-slate-object="text" data-key="13517"><span data-slate-leaf="true" data-offset-key="13517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13518"><span data-slate-leaf="true" data-offset-key="13518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13519"><span data-slate-leaf="true" data-offset-key="13519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_poll 7</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13520"><span data-slate-object="text" data-key="13521"><span data-slate-leaf="true" data-offset-key="13521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13522"><span data-slate-leaf="true" data-offset-key="13522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13523"><span data-slate-leaf="true" data-offset-key="13523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_lseek 8</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13524"><span data-slate-object="text" data-key="13525"><span data-slate-leaf="true" data-offset-key="13525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13526"><span data-slate-object="text" data-key="13527"><span data-slate-leaf="true" data-offset-key="13527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13528"><span data-slate-leaf="true" data-offset-key="13528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13529"><span data-slate-leaf="true" data-offset-key="13529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_clone3 435</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13530"><span data-slate-object="text" data-key="13531"><span data-slate-leaf="true" data-offset-key="13531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13532"><span data-slate-leaf="true" data-offset-key="13532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13533"><span data-slate-leaf="true" data-offset-key="13533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_close_range 436</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13534"><span data-slate-object="text" data-key="13535"><span data-slate-leaf="true" data-offset-key="13535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13536"><span data-slate-leaf="true" data-offset-key="13536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13537"><span data-slate-leaf="true" data-offset-key="13537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_openat2 437</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13538"><span data-slate-object="text" data-key="13539"><span data-slate-leaf="true" data-offset-key="13539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13540"><span data-slate-leaf="true" data-offset-key="13540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13541"><span data-slate-leaf="true" data-offset-key="13541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_pidfd_getfd 438</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13542"><span data-slate-object="text" data-key="13543"><span data-slate-leaf="true" data-offset-key="13543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13544"><span data-slate-leaf="true" data-offset-key="13544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13545"><span data-slate-leaf="true" data-offset-key="13545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_faccessat2 439</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13546"><span data-slate-object="text" data-key="13547"><span data-slate-leaf="true" data-offset-key="13547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13548"><span data-slate-leaf="true" data-offset-key="13548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13549"><span data-slate-leaf="true" data-offset-key="13549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_process_madvise 440</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13550"><span data-slate-object="text" data-key="13551"><span data-slate-leaf="true" data-offset-key="13551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13552"><span data-slate-leaf="true" data-offset-key="13552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ifdef</span></span></span></span></span><span data-slate-object="text" data-key="13553"><span data-slate-leaf="true" data-offset-key="13553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __KERNEL__</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13554"><span data-slate-object="text" data-key="13555"><span data-slate-leaf="true" data-offset-key="13555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13556"><span data-slate-leaf="true" data-offset-key="13556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13557"><span data-slate-leaf="true" data-offset-key="13557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __NR_syscall_max 440</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13558"><span data-slate-object="text" data-key="13559"><span data-slate-leaf="true" data-offset-key="13559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13560"><span data-slate-leaf="true" data-offset-key="13560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13561"><span data-slate-object="text" data-key="13562"><span data-slate-leaf="true" data-offset-key="13562:0" data-first-offset="true"><span data-slate-string="true">上述代码中，已经定义了 __NR_syscall_max 为 440，这说明 Linux 内核一共有 441 个系统调用，而系统调用号从 0 开始到 440 结束，所以最后一个系统调用是 sys_process_madvise。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13563"><span data-slate-object="text" data-key="13564"><span data-slate-leaf="true" data-offset-key="13564:0" data-first-offset="true"><span data-slate-string="true">其实，__SYSCALL_COMMON 除了表示系统调用号和系统调用函数之间的关系，还会在 Linux 内核的系统调用表中进行相应的展开，究竟展开成什么样子呢？我们一起接着看一看 Linux 内核的系统调用表。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13565" id="sr-toc-3"><span data-slate-object="text" data-key="13566"><span data-slate-leaf="true" data-offset-key="13566:0" data-first-offset="true"><span data-slate-string="true">Linux 系统调用表</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13567"><span data-slate-object="text" data-key="13568"><span data-slate-leaf="true" data-offset-key="13568:0" data-first-offset="true"><span data-slate-string="true">Linux 内核有 400 多个系统调用，它使用了一个函数指针数组，存放所有的系统调用函数的地址，通过数组下标就能索引到相应的系统调用。这个数组叫 sys_call_table，即 Linux 系统调用表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13569"><span data-slate-object="text" data-key="13570"><span data-slate-leaf="true" data-offset-key="13570:0" data-first-offset="true"><span data-slate-string="true">sys_call_table 到底长什么样？我们来看一看代码才知道，同时也解答一下前面留下的疑问，这里还是要说明一下，__SYSCALL_COMMON 首先会替换成 __SYSCALL_64，因为我们编译的 Linux 内核是 x86_64 架构的，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13571"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13572"><span data-slate-object="text" data-key="13573"><span data-slate-leaf="true" data-offset-key="13573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13574"><span data-slate-leaf="true" data-offset-key="13574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13575"><span data-slate-leaf="true" data-offset-key="13575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __SYSCALL_COMMON(nr, sym) __SYSCALL_64(nr, sym)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13576"><span data-slate-object="text" data-key="13577"><span data-slate-leaf="true" data-offset-key="13577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第一次定义__SYSCALL_64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13578"><span data-slate-object="text" data-key="13579"><span data-slate-leaf="true" data-offset-key="13579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13580"><span data-slate-leaf="true" data-offset-key="13580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13581"><span data-slate-leaf="true" data-offset-key="13581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __SYSCALL_64(nr, sym) extern asmlinkage long sym(unsigned long, unsigned long, unsigned long, unsigned long, unsigned long, unsigned long) ;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13582"><span data-slate-object="text" data-key="13583"><span data-slate-leaf="true" data-offset-key="13583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13584"><span data-slate-leaf="true" data-offset-key="13584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="13585"><span data-slate-leaf="true" data-offset-key="13585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13586"><span data-slate-leaf="true" data-offset-key="13586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;asm/syscalls_64.h&gt;</span></span></span></span></span><span data-slate-object="text" data-key="13587"><span data-slate-leaf="true" data-offset-key="13587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第一次包含 syscalls_64.h 文件，其中的宏会被展开一次，例如__SYSCALL_COMMON (2, sys_open) 会被展开成：</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13588"><span data-slate-object="text" data-key="13589"><span data-slate-leaf="true" data-offset-key="13589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span></span><span data-slate-object="text" data-key="13590"><span data-slate-leaf="true" data-offset-key="13590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> asmlinkage </span></span></span></span><span data-slate-object="text" data-key="13591"><span data-slate-leaf="true" data-offset-key="13591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="13592"><span data-slate-leaf="true" data-offset-key="13592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13593"><span data-slate-leaf="true" data-offset-key="13593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sys_open</span></span></span></span></span><span data-slate-object="text" data-key="13594"><span data-slate-leaf="true" data-offset-key="13594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="13595"><span data-slate-leaf="true" data-offset-key="13595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13596"><span data-slate-leaf="true" data-offset-key="13596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13597"><span data-slate-leaf="true" data-offset-key="13597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13598"><span data-slate-leaf="true" data-offset-key="13598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13599"><span data-slate-leaf="true" data-offset-key="13599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13600"><span data-slate-leaf="true" data-offset-key="13600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13601"><span data-slate-leaf="true" data-offset-key="13601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13602"><span data-slate-leaf="true" data-offset-key="13602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13603"><span data-slate-leaf="true" data-offset-key="13603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13604"><span data-slate-leaf="true" data-offset-key="13604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13605"><span data-slate-leaf="true" data-offset-key="13605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13606"><span data-slate-leaf="true" data-offset-key="13606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13607"><span data-slate-leaf="true" data-offset-key="13607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13608"><span data-slate-leaf="true" data-offset-key="13608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13609"><span data-slate-leaf="true" data-offset-key="13609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13610"><span data-slate-leaf="true" data-offset-key="13610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13611"><span data-slate-leaf="true" data-offset-key="13611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13612"><span data-slate-leaf="true" data-offset-key="13612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13613"><span data-slate-leaf="true" data-offset-key="13613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13614"><span data-slate-leaf="true" data-offset-key="13614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13615"><span data-slate-leaf="true" data-offset-key="13615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13616"><span data-slate-leaf="true" data-offset-key="13616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13617"><span data-slate-leaf="true" data-offset-key="13617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13618"><span data-slate-leaf="true" data-offset-key="13618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="13619"><span data-slate-leaf="true" data-offset-key="13619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13620"><span data-slate-leaf="true" data-offset-key="13620:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13621"><span data-slate-object="text" data-key="13622"><span data-slate-leaf="true" data-offset-key="13622:0" data-first-offset="true"><span data-slate-string="true">这表示申明</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13623"><span data-slate-object="text" data-key="13624"><span data-slate-leaf="true" data-offset-key="13624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消__SYSCALL_64 定义</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13625"><span data-slate-object="text" data-key="13626"><span data-slate-leaf="true" data-offset-key="13626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13627"><span data-slate-leaf="true" data-offset-key="13627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">undef</span></span></span></span></span><span data-slate-object="text" data-key="13628"><span data-slate-leaf="true" data-offset-key="13628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __SYSCALL_64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13629"><span data-slate-object="text" data-key="13630"><span data-slate-leaf="true" data-offset-key="13630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第二次重新定义__SYSCALL_64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13631"><span data-slate-object="text" data-key="13632"><span data-slate-leaf="true" data-offset-key="13632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13633"><span data-slate-leaf="true" data-offset-key="13633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="13634"><span data-slate-leaf="true" data-offset-key="13634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __SYSCALL_64(nr, sym) [ nr ] = sym,</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13635"></div><div data-slate-type="code-line" data-slate-object="block" data-key="13636"><span data-slate-object="text" data-key="13637"><span data-slate-leaf="true" data-offset-key="13637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span></span><span data-slate-object="text" data-key="13638"><span data-slate-leaf="true" data-offset-key="13638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> asmlinkage </span></span></span></span><span data-slate-object="text" data-key="13639"><span data-slate-leaf="true" data-offset-key="13639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="13640"><span data-slate-leaf="true" data-offset-key="13640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13641"><span data-slate-leaf="true" data-offset-key="13641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sys_ni_syscall</span></span></span></span></span><span data-slate-object="text" data-key="13642"><span data-slate-leaf="true" data-offset-key="13642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="13643"><span data-slate-leaf="true" data-offset-key="13643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13644"><span data-slate-leaf="true" data-offset-key="13644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13645"><span data-slate-leaf="true" data-offset-key="13645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13646"><span data-slate-leaf="true" data-offset-key="13646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13647"><span data-slate-leaf="true" data-offset-key="13647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13648"><span data-slate-leaf="true" data-offset-key="13648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13649"><span data-slate-leaf="true" data-offset-key="13649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13650"><span data-slate-leaf="true" data-offset-key="13650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13651"><span data-slate-leaf="true" data-offset-key="13651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13652"><span data-slate-leaf="true" data-offset-key="13652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13653"><span data-slate-leaf="true" data-offset-key="13653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13654"><span data-slate-leaf="true" data-offset-key="13654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13655"><span data-slate-leaf="true" data-offset-key="13655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13656"><span data-slate-leaf="true" data-offset-key="13656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13657"><span data-slate-leaf="true" data-offset-key="13657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13658"><span data-slate-leaf="true" data-offset-key="13658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13659"><span data-slate-leaf="true" data-offset-key="13659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13660"><span data-slate-leaf="true" data-offset-key="13660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13661"><span data-slate-leaf="true" data-offset-key="13661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13662"><span data-slate-leaf="true" data-offset-key="13662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="13663"><span data-slate-leaf="true" data-offset-key="13663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="13664"><span data-slate-leaf="true" data-offset-key="13664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13665"><span data-slate-leaf="true" data-offset-key="13665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="13666"><span data-slate-leaf="true" data-offset-key="13666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="13667"><span data-slate-leaf="true" data-offset-key="13667:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13668"><span data-slate-object="text" data-key="13669"><span data-slate-leaf="true" data-offset-key="13669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="13670"><span data-slate-leaf="true" data-offset-key="13670:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13671"><span data-slate-leaf="true" data-offset-key="13671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sys_call_ptr_t</span></span></span></span><span data-slate-object="text" data-key="13672"><span data-slate-leaf="true" data-offset-key="13672:0" data-first-offset="true"><span data-slate-string="true"> sys_call_table[] ____cacheline_aligned = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13673"><span data-slate-object="text" data-key="13674"><span data-slate-leaf="true" data-offset-key="13674:0" data-first-offset="true"><span data-slate-string="true">    [</span></span></span><span data-slate-object="text" data-key="13675"><span data-slate-leaf="true" data-offset-key="13675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13676"><span data-slate-leaf="true" data-offset-key="13676:0" data-first-offset="true"><span data-slate-string="true"> ... __NR_syscall_max] = &amp;sys_ni_syscall,</span></span></span><span data-slate-object="text" data-key="13677"><span data-slate-leaf="true" data-offset-key="13677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 默认系统调用函数，什么都不干</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13678"><span data-slate-object="text" data-key="13679"><span data-slate-leaf="true" data-offset-key="13679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13680"><span data-slate-leaf="true" data-offset-key="13680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="13681"><span data-slate-leaf="true" data-offset-key="13681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13682"><span data-slate-leaf="true" data-offset-key="13682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;asm/syscalls_64.h&gt;</span></span></span></span></span><span data-slate-object="text" data-key="13683"><span data-slate-leaf="true" data-offset-key="13683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 包含前面生成文件</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13684"><span data-slate-object="text" data-key="13685"><span data-slate-leaf="true" data-offset-key="13685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第二次包含 syscalls_64.h 文件，其中的宏会被再展开一次，例如__SYSCALL_COMMON (2, sys_open) 会被展开成：</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13686"><span data-slate-object="text" data-key="13687"><span data-slate-leaf="true" data-offset-key="13687:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13688"><span data-slate-leaf="true" data-offset-key="13688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="13689"><span data-slate-leaf="true" data-offset-key="13689:0" data-first-offset="true"><span data-slate-string="true">] = sys_open, 用于初始化这个数组，即表示数组的第二个元素填入 sys_open</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13690"><span data-slate-object="text" data-key="13691"><span data-slate-leaf="true" data-offset-key="13691:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13692"><span data-slate-object="text" data-key="13693"><span data-slate-leaf="true" data-offset-key="13693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13694"><span data-slate-leaf="true" data-offset-key="13694:0" data-first-offset="true"><span data-slate-string="true"> syscall_table_size = </span></span></span><span data-slate-object="text" data-key="13695"><span data-slate-leaf="true" data-offset-key="13695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="13696"><span data-slate-leaf="true" data-offset-key="13696:0" data-first-offset="true"><span data-slate-string="true">(sys_call_table);</span></span></span><span data-slate-object="text" data-key="13697"><span data-slate-leaf="true" data-offset-key="13697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 系统调用表的大小</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13698"><span data-slate-object="text" data-key="13699"><span data-slate-leaf="true" data-offset-key="13699:0" data-first-offset="true"><span data-slate-string="true">上述代码中，通过两次包含 syscalls_64.h 文件，并在其中分别定义不同的 __SYSCALL_64 宏，完成了系统调用函数的申明和系统调用表的初始化，不得不说这是一个非常巧妙的方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13700"><span data-slate-object="text" data-key="13701"><span data-slate-leaf="true" data-offset-key="13701:0" data-first-offset="true"><span data-slate-string="true">sys_call_table 数组，第一次全部初始化为默认系统调用函数 sys_ni_syscall，这个函数什么都不干，这是为了</span></span></span><span data-slate-object="text" data-key="13702"><span data-slate-leaf="true" data-offset-key="13702:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">防止数组有些元素中没有函数地址，从而导致调用失败。</span></span></span></span><span data-slate-object="text" data-key="13703"><span data-slate-leaf="true" data-offset-key="13703:0" data-first-offset="true"><span data-slate-string="true">这在内核中是非常危险的。我单独提示你这点，其实也是希望你留意这种编程技巧，这在内核编码中并不罕见，考虑到内核编程代码的安全性，加一道防线可以有备无患。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13704" id="sr-toc-4"><span data-slate-object="text" data-key="13705"><span data-slate-leaf="true" data-offset-key="13705:0" data-first-offset="true"><span data-slate-string="true">Linux 系统调用实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13706"><span data-slate-object="text" data-key="13707"><span data-slate-leaf="true" data-offset-key="13707:0" data-first-offset="true"><span data-slate-string="true">前面我们已经了解了 Linux 系统调用的架构和 Linux 系统调用表，也清楚了 Linux 系统调用的个数和定义一个 Linux 系统调用的方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13708"><span data-slate-object="text" data-key="13709"><span data-slate-leaf="true" data-offset-key="13709:0" data-first-offset="true"><span data-slate-string="true">为了让你更好地理解 Linux 系统是如何工作的，我们为现有的 Linux 写一个系统调用。这个系统调用的功能并不复杂，就是返回你机器的 CPU 数量，即你的机器是多少核心的处理器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13710"><span data-slate-object="text" data-key="13711"><span data-slate-leaf="true" data-offset-key="13711:0" data-first-offset="true"><span data-slate-string="true">为 Linux 增加一个系统调用，其实有很多步骤，不过也别慌，下面我将一步一步为你讲解。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13712" id="sr-toc-5"><span data-slate-object="text" data-key="13713"><span data-slate-leaf="true" data-offset-key="13713:0" data-first-offset="true"><span data-slate-string="true">下载 Linux 源码</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13714"><span data-slate-object="text" data-key="13715"><span data-slate-leaf="true" data-offset-key="13715:0" data-first-offset="true"><span data-slate-string="true">想为 Linux 系统增加一个系统调用，首先你得有 Linux 内核源代码，如果你机器上没有 Linux 内核源代码，你就要去</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13716"><span data-slate-object="text" data-key="13717"><span data-slate-leaf="true" data-offset-key="13717:0" data-first-offset="true"><span data-slate-string="true">内核官网</span></span></span></a><span data-slate-object="text" data-key="13718"><span data-slate-leaf="true" data-offset-key="13718:0" data-first-offset="true"><span data-slate-string="true">下载，或者你也可以到 GitHub 上 git clone 一份内核代码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13719"><span data-slate-object="text" data-key="13720"><span data-slate-leaf="true" data-offset-key="13720:0" data-first-offset="true"><span data-slate-string="true">如果你使用了 git clone 的方式，可以用如下方式操作。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13721"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13722"><span data-slate-object="text" data-key="13723"><span data-slate-leaf="true" data-offset-key="13723:0" data-first-offset="true"><span data-slate-string="true">git </span></span></span><span data-slate-object="text" data-key="13724"><span data-slate-leaf="true" data-offset-key="13724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clone</span></span></span></span><span data-slate-object="text" data-key="13725"><span data-slate-leaf="true" data-offset-key="13725:0" data-first-offset="true"><span data-slate-string="true"> git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git/</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13726"><span data-slate-object="text" data-key="13727"><span data-slate-leaf="true" data-offset-key="13727:0" data-first-offset="true"><span data-slate-string="true">如果你想尽量保持与我的 Linux 内核版本相同，降低出现各种未知问题的概率，那么请你使用 </span></span></span><span data-slate-object="text" data-key="13728"><span data-slate-leaf="true" data-offset-key="13728:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">5.10.13 版本</span></span></span></span><span data-slate-object="text" data-key="13729"><span data-slate-leaf="true" data-offset-key="13729:0" data-first-offset="true"><span data-slate-string="true">的内核。另外别忘了，如果你下载的 Linux 内核是压缩包，请记得先解压到一个可以访问的目录下。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13730" id="sr-toc-6"><span data-slate-object="text" data-key="13731"><span data-slate-leaf="true" data-offset-key="13731:0" data-first-offset="true"><span data-slate-string="true">申明系统调用</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13732"><span data-slate-object="text" data-key="13733"><span data-slate-leaf="true" data-offset-key="13733:0" data-first-offset="true"><span data-slate-string="true">根据前面的知识点，可以得知 Linux 内核的系统调用的申明文件和信息，具体实现是这样的：由一个 makefile 在编译 Linux 系统内核时调用了一个脚本，这个脚本文件会读取另一个叫 syscall_64.tbl 文件，根据其中信息生成相应的文件 syscall_64.h。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13734"><span data-slate-object="text" data-key="13735"><span data-slate-leaf="true" data-offset-key="13735:0" data-first-offset="true"><span data-slate-string="true">请注意，我这里是以 x86_64 架构为例进行说明的，这里我们并不关注 syscall_64.h 的生成原理，只关注 syscall_64.tbl 文件中的内容。下面我们还是结合代码看一下吧。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13736"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13737"><span data-slate-object="text" data-key="13738"><span data-slate-leaf="true" data-offset-key="13738:0" data-first-offset="true"><span data-slate-string="true">//linux-5.10.13/arch/x86/entry/syscalls/syscall_64.tbl</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13739"><span data-slate-object="text" data-key="13740"><span data-slate-leaf="true" data-offset-key="13740:0" data-first-offset="true"><span data-slate-string="true">0  common  </span></span></span><span data-slate-object="text" data-key="13741"><span data-slate-leaf="true" data-offset-key="13741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">read</span></span></span></span><span data-slate-object="text" data-key="13742"><span data-slate-leaf="true" data-offset-key="13742:0" data-first-offset="true"><span data-slate-string="true">      sys_read</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13743"><span data-slate-object="text" data-key="13744"><span data-slate-leaf="true" data-offset-key="13744:0" data-first-offset="true"><span data-slate-string="true">1  common  write      sys_write</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13745"><span data-slate-object="text" data-key="13746"><span data-slate-leaf="true" data-offset-key="13746:0" data-first-offset="true"><span data-slate-string="true">2  common  open      sys_open</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13747"><span data-slate-object="text" data-key="13748"><span data-slate-leaf="true" data-offset-key="13748:0" data-first-offset="true"><span data-slate-string="true">3  common  close      sys_close</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13749"><span data-slate-object="text" data-key="13750"><span data-slate-leaf="true" data-offset-key="13750:0" data-first-offset="true"><span data-slate-string="true">4  common  </span></span></span><span data-slate-object="text" data-key="13751"><span data-slate-leaf="true" data-offset-key="13751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stat</span></span></span></span><span data-slate-object="text" data-key="13752"><span data-slate-leaf="true" data-offset-key="13752:0" data-first-offset="true"><span data-slate-string="true">      sys_newstat</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13753"><span data-slate-object="text" data-key="13754"><span data-slate-leaf="true" data-offset-key="13754:0" data-first-offset="true"><span data-slate-string="true">5  common  fstat      sys_newfstat</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13755"><span data-slate-object="text" data-key="13756"><span data-slate-leaf="true" data-offset-key="13756:0" data-first-offset="true"><span data-slate-string="true">6  common  lstat      sys_newlstat</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13757"><span data-slate-object="text" data-key="13758"><span data-slate-leaf="true" data-offset-key="13758:0" data-first-offset="true"><span data-slate-string="true">7  common  poll      sys_poll</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13759"><span data-slate-object="text" data-key="13760"><span data-slate-leaf="true" data-offset-key="13760:0" data-first-offset="true"><span data-slate-string="true">8  common  lseek      sys_lseek</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13761"><span data-slate-object="text" data-key="13762"><span data-slate-leaf="true" data-offset-key="13762:0" data-first-offset="true"><span data-slate-string="true">9  common  mmap      sys_mmap</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13763"><span data-slate-object="text" data-key="13764"><span data-slate-leaf="true" data-offset-key="13764:0" data-first-offset="true"><span data-slate-string="true">10  common  mprotect    sys_mprotect</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13765"><span data-slate-object="text" data-key="13766"><span data-slate-leaf="true" data-offset-key="13766:0" data-first-offset="true"><span data-slate-string="true">11  common  munmap      sys_munmap</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13767"><span data-slate-object="text" data-key="13768"><span data-slate-leaf="true" data-offset-key="13768:0" data-first-offset="true"><span data-slate-string="true">12  common  brk          sys_brk</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13769"><span data-slate-object="text" data-key="13770"><span data-slate-leaf="true" data-offset-key="13770:0" data-first-offset="true"><span data-slate-string="true">//……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13771"><span data-slate-object="text" data-key="13772"><span data-slate-leaf="true" data-offset-key="13772:0" data-first-offset="true"><span data-slate-string="true">435  common  clone3      sys_clone3</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13773"><span data-slate-object="text" data-key="13774"><span data-slate-leaf="true" data-offset-key="13774:0" data-first-offset="true"><span data-slate-string="true">436  common  close_range    sys_close_range</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13775"><span data-slate-object="text" data-key="13776"><span data-slate-leaf="true" data-offset-key="13776:0" data-first-offset="true"><span data-slate-string="true">437  common  openat2      sys_openat2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13777"><span data-slate-object="text" data-key="13778"><span data-slate-leaf="true" data-offset-key="13778:0" data-first-offset="true"><span data-slate-string="true">438  common  pidfd_getfd    sys_pidfd_getfd</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13779"><span data-slate-object="text" data-key="13780"><span data-slate-leaf="true" data-offset-key="13780:0" data-first-offset="true"><span data-slate-string="true">439  common  faccessat2    sys_faccessat2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13781"><span data-slate-object="text" data-key="13782"><span data-slate-leaf="true" data-offset-key="13782:0" data-first-offset="true"><span data-slate-string="true">440  common  process_madvise    sys_process_madvise</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13783"><span data-slate-object="text" data-key="13784"><span data-slate-leaf="true" data-offset-key="13784:0" data-first-offset="true"><span data-slate-string="true">上面这些代码可以分成四列，分别是系统调用号、架构、服务名，以及其相对应的服务入口函数。例如系统调用 open 的结构，如下表所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13785"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/77/f4/777e8e56b151b5812c48e06d861408f4.jpg?wh=1483x541"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13786"><span data-slate-object="text" data-key="13787"><span data-slate-leaf="true" data-offset-key="13787:0" data-first-offset="true"><span data-slate-string="true">那我们要如何申明自己的系统调用呢？第一步就需要在 syscall_64.tbl 文件中增加一项，如下所示。</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="13788"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13789"><span data-slate-object="text" data-key="13790"><span data-slate-leaf="true" data-offset-key="13790:0" data-first-offset="true"><span data-slate-string="true">441  common  get_cpus    sys_get_cpus</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13791"><span data-slate-object="text" data-key="13792"><span data-slate-leaf="true" data-offset-key="13792:0" data-first-offset="true"><span data-slate-string="true">我们自己的系统调用的系统调用号是 441，架构是 common ，服务名称是 get_cpus，服务入口函数则是 sys_get_cpus。请注意系统调用号要唯一，不能和其它系统调用号冲突。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13793"><span data-slate-object="text" data-key="13794"><span data-slate-leaf="true" data-offset-key="13794:0" data-first-offset="true"><span data-slate-string="true">写好这个，我们还需要把 sys_get_cpus 函数在 syscalls.h 文件中申明一下，供其它内核模块引用。具体代码如下所示。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13795"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13796"><span data-slate-object="text" data-key="13797"><span data-slate-leaf="true" data-offset-key="13797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//linux-5.10.13/include/linux/syscalls.h</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13798"><span data-slate-object="text" data-key="13799"><span data-slate-leaf="true" data-offset-key="13799:0" data-first-offset="true"><span data-slate-string="true">asmlinkage </span></span></span><span data-slate-object="text" data-key="13800"><span data-slate-leaf="true" data-offset-key="13800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13801"><span data-slate-leaf="true" data-offset-key="13801:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13802"><span data-slate-leaf="true" data-offset-key="13802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sys_get_cpus</span></span></span></span><span data-slate-object="text" data-key="13803"><span data-slate-leaf="true" data-offset-key="13803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="13804"><span data-slate-leaf="true" data-offset-key="13804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="13805"><span data-slate-leaf="true" data-offset-key="13805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span><span data-slate-object="text" data-key="13806"><span data-slate-leaf="true" data-offset-key="13806:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13807"><span data-slate-object="text" data-key="13808"><span data-slate-leaf="true" data-offset-key="13808:0" data-first-offset="true"><span data-slate-string="true">这一步做好之后，我们就完成了一个 Linux 系统调用的所有申明工作。下面我们就去定义这个系统调用的服务入口函数。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13809" id="sr-toc-7"><span data-slate-object="text" data-key="13810"><span data-slate-leaf="true" data-offset-key="13810:0" data-first-offset="true"><span data-slate-string="true">定义系统调用</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13811"><span data-slate-object="text" data-key="13812"><span data-slate-leaf="true" data-offset-key="13812:0" data-first-offset="true"><span data-slate-string="true">我们现在来定义自己的第一个 Linux 系统调用，为了降低工程复杂度，我们不打算新建一个 C 模块文件，而是直接在 Linux 内核代码目录下挑一个已经存在的 C 模块文件，并在其中定义我们自己的系统调用函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13813"><span data-slate-object="text" data-key="13814"><span data-slate-leaf="true" data-offset-key="13814:0" data-first-offset="true"><span data-slate-string="true">定义一个系统调用函数，需要使用专门的宏。根据参数不同选用不同的宏，这个宏的细节我们无须关注。对于我们这个无参数的系统调用函数，应该使用 SYSCALL_DEFINE0 宏来定义，代码如下所示。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="13815"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13816"><span data-slate-object="text" data-key="13817"><span data-slate-leaf="true" data-offset-key="13817:0" data-first-offset="true"><span data-slate-string="true">//linux-5.10.13/include/linux/syscalls.h</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13818"><span data-slate-object="text" data-key="13819"><span data-slate-leaf="true" data-offset-key="13819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#ifndef SYSCALL_DEFINE0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13820"><span data-slate-object="text" data-key="13821"><span data-slate-leaf="true" data-offset-key="13821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#define SYSCALL_DEFINE0(sname)                  \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13822"><span data-slate-object="text" data-key="13823"><span data-slate-leaf="true" data-offset-key="13823:0" data-first-offset="true"><span data-slate-string="true">    SYSCALL_METADATA(_</span></span></span><span data-slate-object="text" data-key="13824"><span data-slate-leaf="true" data-offset-key="13824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">##sname, 0);              \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13825"><span data-slate-object="text" data-key="13826"><span data-slate-leaf="true" data-offset-key="13826:0" data-first-offset="true"><span data-slate-string="true">    asmlinkage long sys_</span></span></span><span data-slate-object="text" data-key="13827"><span data-slate-leaf="true" data-offset-key="13827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">##sname(void);          \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13828"><span data-slate-object="text" data-key="13829"><span data-slate-leaf="true" data-offset-key="13829:0" data-first-offset="true"><span data-slate-string="true">    ALLOW_ERROR_INJECTION(sys_</span></span></span><span data-slate-object="text" data-key="13830"><span data-slate-leaf="true" data-offset-key="13830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">##sname, ERRNO);      \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13831"><span data-slate-object="text" data-key="13832"><span data-slate-leaf="true" data-offset-key="13832:0" data-first-offset="true"><span data-slate-string="true">    asmlinkage long sys_</span></span></span><span data-slate-object="text" data-key="13833"><span data-slate-leaf="true" data-offset-key="13833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">##sname(void)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13834"><span data-slate-object="text" data-key="13835"><span data-slate-leaf="true" data-offset-key="13835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#endif /* SYSCALL_DEFINE0 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13836"><span data-slate-object="text" data-key="13837"><span data-slate-leaf="true" data-offset-key="13837:0" data-first-offset="true"><span data-slate-string="true">//linux-5.10.13/kernel/sys.c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13838"><span data-slate-object="text" data-key="13839"><span data-slate-leaf="true" data-offset-key="13839:0" data-first-offset="true"><span data-slate-string="true">SYSCALL_DEFINE0(get_cpus)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13840"><span data-slate-object="text" data-key="13841"><span data-slate-leaf="true" data-offset-key="13841:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13842"><span data-slate-object="text" data-key="13843"><span data-slate-leaf="true" data-offset-key="13843:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13844"><span data-slate-leaf="true" data-offset-key="13844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13845"><span data-slate-leaf="true" data-offset-key="13845:0" data-first-offset="true"><span data-slate-string="true"> num_present_cpus ();// 获取系统中有多少 CPU</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13846"><span data-slate-object="text" data-key="13847"><span data-slate-leaf="true" data-offset-key="13847:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13848"><span data-slate-object="text" data-key="13849"><span data-slate-leaf="true" data-offset-key="13849:0" data-first-offset="true"><span data-slate-string="true">上述代码中 SYSCALL_DEFINE0 会将 get_cpus 转换成 sys_get_cpus 函数。这个函数中，调用了一个 Linux 内核中另一个函数 num_present_cpus，从名字就能推断出作用了，它负责返回系统 CPU 的数量。 这正是我们要达到的结果。这个结果最终会返回给调用这个系统调用的应用程序。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13850" id="sr-toc-8"><span data-slate-object="text" data-key="13851"><span data-slate-leaf="true" data-offset-key="13851:0" data-first-offset="true"><span data-slate-string="true">编译 Linux 内核</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13852"><span data-slate-object="text" data-key="13853"><span data-slate-leaf="true" data-offset-key="13853:0" data-first-offset="true"><span data-slate-string="true">现在我们的 Linux 系统调用的代码，已经写好了，不过这跟编写内核模块还是不一样的。编写内核模块，我们只需要把内核模块动态加载到内核中，就可以直接使用了。系统调用发生在内核中，与内核是一体的，它无法独立成为可以加载的内核模块。所以我们需要重新编译内核，然后使用我们新编译的内核。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13854"><span data-slate-object="text" data-key="13855"><span data-slate-leaf="true" data-offset-key="13855:0" data-first-offset="true"><span data-slate-string="true">要编译内核首先是要配置内核，内核的配置操作非常简单，我们只需要源代码目录下执行 “make menuconfig” 指令，就会出现如下所示的界面。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13856"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/66/96/66597887b59b30d73ff300249e47e296.jpg?wh=836x679" style="width: auto;"></div><div> 配置 Linux</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13857"><span data-slate-object="text" data-key="13858"><span data-slate-leaf="true" data-offset-key="13858:0" data-first-offset="true"><span data-slate-string="true">图中这些菜单都可以进入子菜单或者手动选择。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13859"><span data-slate-object="text" data-key="13860"><span data-slate-leaf="true" data-offset-key="13860:0" data-first-offset="true"><span data-slate-string="true">但是手动选择配置项非常麻烦且危险，</span></span></span><span data-slate-object="text" data-key="13861"><span data-slate-leaf="true" data-offset-key="13861:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如果不是资深的内核玩家，不建议手动配置！</span></span></span></span><span data-slate-object="text" data-key="13862"><span data-slate-leaf="true" data-offset-key="13862:0" data-first-offset="true"><span data-slate-string="true">但是我们可以选择加载一个已经存在的配置文件，这个配置文件可以加载你机器上 boot 目录下的 config 开头的文件，加载之后选择 Save，就能保存配置并退出以上界面。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13863"><span data-slate-object="text" data-key="13864"><span data-slate-leaf="true" data-offset-key="13864:0" data-first-offset="true"><span data-slate-string="true">然后输入如下指令，就可以喝点茶、听听音乐，等待机器自行完成编译，编译的时间取决于机器的性能，快则十几分钟，慢则几个小时。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="13865"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13866"><span data-slate-object="text" data-key="13867"><span data-slate-leaf="true" data-offset-key="13867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="13868"><span data-slate-leaf="true" data-offset-key="13868:0" data-first-offset="true"><span data-slate-string="true"> -j8 bzImage &amp;&amp; </span></span></span><span data-slate-object="text" data-key="13869"><span data-slate-leaf="true" data-offset-key="13869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="13870"><span data-slate-leaf="true" data-offset-key="13870:0" data-first-offset="true"><span data-slate-string="true"> -j8 modules</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13871"><span data-slate-object="text" data-key="13872"><span data-slate-leaf="true" data-offset-key="13872:0" data-first-offset="true"><span data-slate-string="true">上述代码指令干了哪些事儿呢？我来说一说，首先要编译内核，然后再编译内核模块，j8 表示开启 8 线程并行编译，这个你可以根据自己的机器 CPU 核心数量进行调整。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13873"><span data-slate-object="text" data-key="13874"><span data-slate-leaf="true" data-offset-key="13874:0" data-first-offset="true"><span data-slate-string="true">编译过程结束之后就可以开始安装新内核了，你只需要在源代码目录下，执行如下指令。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="13875"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13876"><span data-slate-object="text" data-key="13877"><span data-slate-leaf="true" data-offset-key="13877:0" data-first-offset="true"><span data-slate-string="true">sudo </span></span></span><span data-slate-object="text" data-key="13878"><span data-slate-leaf="true" data-offset-key="13878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="13879"><span data-slate-leaf="true" data-offset-key="13879:0" data-first-offset="true"><span data-slate-string="true"> modules_install &amp;&amp; sudo </span></span></span><span data-slate-object="text" data-key="13880"><span data-slate-leaf="true" data-offset-key="13880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="13881"><span data-slate-leaf="true" data-offset-key="13881:0" data-first-offset="true"><span data-slate-string="true"> install</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13882"><span data-slate-object="text" data-key="13883"><span data-slate-leaf="true" data-offset-key="13883:0" data-first-offset="true"><span data-slate-string="true">上述代码指令先安装好内核模块，然后再安装内核，最后会调用 update-grub，自动生成启动选项，重启计算机就可以选择启动我们自己修改的 Linux 内核了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13884" id="sr-toc-9"><span data-slate-object="text" data-key="13885"><span data-slate-leaf="true" data-offset-key="13885:0" data-first-offset="true"><span data-slate-string="true">编写应用测试</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13886"><span data-slate-object="text" data-key="13887"><span data-slate-leaf="true" data-offset-key="13887:0" data-first-offset="true"><span data-slate-string="true">相信经过上述过程，你应该已经成功启动了修改过的新内核。不过我们还不确定我们增加的系统调用是不是正常的，所以我们还要写个应用程序测试一下，其实就是去调用一下我们增加的系统调用，看看结果是不是预期的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13888"><span data-slate-object="text" data-key="13889"><span data-slate-leaf="true" data-offset-key="13889:0" data-first-offset="true"><span data-slate-string="true">我们应用程序代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13890"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13891"><span data-slate-object="text" data-key="13892"><span data-slate-leaf="true" data-offset-key="13892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13893"><span data-slate-leaf="true" data-offset-key="13893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="13894"><span data-slate-leaf="true" data-offset-key="13894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13895"><span data-slate-leaf="true" data-offset-key="13895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;stdio.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13896"><span data-slate-object="text" data-key="13897"><span data-slate-leaf="true" data-offset-key="13897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13898"><span data-slate-leaf="true" data-offset-key="13898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="13899"><span data-slate-leaf="true" data-offset-key="13899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13900"><span data-slate-leaf="true" data-offset-key="13900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;unistd.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13901"><span data-slate-object="text" data-key="13902"><span data-slate-leaf="true" data-offset-key="13902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="13903"><span data-slate-leaf="true" data-offset-key="13903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="13904"><span data-slate-leaf="true" data-offset-key="13904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13905"><span data-slate-leaf="true" data-offset-key="13905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;sys/syscall.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13906"><span data-slate-object="text" data-key="13907"><span data-slate-leaf="true" data-offset-key="13907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="13908"><span data-slate-leaf="true" data-offset-key="13908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="13909"><span data-slate-leaf="true" data-offset-key="13909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="13910"><span data-slate-leaf="true" data-offset-key="13910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="13911"><span data-slate-leaf="true" data-offset-key="13911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="13912"><span data-slate-leaf="true" data-offset-key="13912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> argc, </span></span></span></span></span><span data-slate-object="text" data-key="13913"><span data-slate-leaf="true" data-offset-key="13913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span></span></span><span data-slate-object="text" data-key="13914"><span data-slate-leaf="true" data-offset-key="13914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="13915"><span data-slate-leaf="true" data-offset-key="13915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span></span></span><span data-slate-object="text" data-key="13916"><span data-slate-leaf="true" data-offset-key="13916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *argv[])</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13917"><span data-slate-object="text" data-key="13918"><span data-slate-leaf="true" data-offset-key="13918:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13919"><span data-slate-object="text" data-key="13920"><span data-slate-leaf="true" data-offset-key="13920:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13921"><span data-slate-leaf="true" data-offset-key="13921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//syscall 就是根据系统调用号调用相应的系统调用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13922"><span data-slate-object="text" data-key="13923"><span data-slate-leaf="true" data-offset-key="13923:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13924"><span data-slate-leaf="true" data-offset-key="13924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13925"><span data-slate-leaf="true" data-offset-key="13925:0" data-first-offset="true"><span data-slate-string="true"> cpus = </span></span></span><span data-slate-object="text" data-key="13926"><span data-slate-leaf="true" data-offset-key="13926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">syscall</span></span></span></span><span data-slate-object="text" data-key="13927"><span data-slate-leaf="true" data-offset-key="13927:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13928"><span data-slate-leaf="true" data-offset-key="13928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">441</span></span></span></span><span data-slate-object="text" data-key="13929"><span data-slate-leaf="true" data-offset-key="13929:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13930"><span data-slate-object="text" data-key="13931"><span data-slate-leaf="true" data-offset-key="13931:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13932"><span data-slate-leaf="true" data-offset-key="13932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">printf</span></span></span></span><span data-slate-object="text" data-key="13933"><span data-slate-leaf="true" data-offset-key="13933:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13934"><span data-slate-leaf="true" data-offset-key="13934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cpu num is:%d\n"</span></span></span></span><span data-slate-object="text" data-key="13935"><span data-slate-leaf="true" data-offset-key="13935:0" data-first-offset="true"><span data-slate-string="true">, cpus);</span></span></span><span data-slate-object="text" data-key="13936"><span data-slate-leaf="true" data-offset-key="13936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 输出结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13937"><span data-slate-object="text" data-key="13938"><span data-slate-leaf="true" data-offset-key="13938:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13939"><span data-slate-leaf="true" data-offset-key="13939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="13940"><span data-slate-leaf="true" data-offset-key="13940:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13941"><span data-slate-leaf="true" data-offset-key="13941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13942"><span data-slate-leaf="true" data-offset-key="13942:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13943"><span data-slate-object="text" data-key="13944"><span data-slate-leaf="true" data-offset-key="13944:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13945"><span data-slate-object="text" data-key="13946"><span data-slate-leaf="true" data-offset-key="13946:0" data-first-offset="true"><span data-slate-string="true">对上述代码我们使用 gcc main.c -o cpus 指令进行编译，运行之后就可以看到结果了，但是我们没有写库代码，而是直接使用 syscall 函数。这个函数可以根据系统调用号触发系统调用，根据上面定义，441 正是对应咱们的 sys_get_cpus 系统调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13947"><span data-slate-object="text" data-key="13948"><span data-slate-leaf="true" data-offset-key="13948:0" data-first-offset="true"><span data-slate-string="true">至此，在 Linux 系统上增加自己的系统调用这个实验，我们就完成了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13949" id="sr-toc-10"><span data-slate-object="text" data-key="13950"><span data-slate-leaf="true" data-offset-key="13950:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13951"><span data-slate-object="text" data-key="13952"><span data-slate-leaf="true" data-offset-key="13952:0" data-first-offset="true"><span data-slate-string="true">今天我们从了解 Linux 系统的 API 架构开始，最后在 Linux 系统上实现了一个自己的系统调用，虽然增加一个系统调用步骤不少，但你只要紧跟着我的思路一定可以拿下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13953"><span data-slate-object="text" data-key="13954"><span data-slate-leaf="true" data-offset-key="13954:0" data-first-offset="true"><span data-slate-string="true">下面我来为你梳理一下课程的重点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13955"><span data-slate-object="text" data-key="13956"><span data-slate-leaf="true" data-offset-key="13956:0" data-first-offset="true"><span data-slate-string="true">1. 从 Linux 系统的 API 架构开始，我们了解了 glibc 库，这个库是大部分应用程序的基础，我们以其中的 open 函数为例，分析了库函数如何通过寄存器传递参数，最后执行 syscall 指令进入 Linux 内核，执行系统调用，最后还归纳出一幅 Linux 系统 API 框架图。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13957"><span data-slate-object="text" data-key="13958"><span data-slate-leaf="true" data-offset-key="13958:0" data-first-offset="true"><span data-slate-string="true">2. 然后，我们了解 Linux 系统中有多少个 API，它们都放在系统调用表中，同时也知道了 Linux 系统调用表的生成方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13959"><span data-slate-object="text" data-key="13960"><span data-slate-leaf="true" data-offset-key="13960:0" data-first-offset="true"><span data-slate-string="true">3. 最后，为了验证我们了解的知识是否正确，我们从申明系统调用、定义系统调用到编译内核、编写应用测试，在现有的 Linux 代码中增加了一个属于我们自己的系统调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13961"><span data-slate-object="text" data-key="13962"><span data-slate-leaf="true" data-offset-key="13962:0" data-first-offset="true"><span data-slate-string="true">好了，我们通过这节课搞清楚了 Linux 内核系统调用的实现原理。你是否感觉这和我们的 Cosmos 的系统服务有些相似，又有些不同？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13963"><span data-slate-object="text" data-key="13964"><span data-slate-leaf="true" data-offset-key="13964:0" data-first-offset="true"><span data-slate-string="true">相似的是我们都使用寄存器来传递参数，不同的是 Cosmos 使用了中断门进入内核，而 Linux 内核使用了更新的 syscall 指令。有了这些知识储备，我也非常期待你能动手拓展，挑战一下在 Cosmos 上实现使用 syscall 触发系统调用。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13965" id="sr-toc-11"><span data-slate-object="text" data-key="13966"><span data-slate-leaf="true" data-offset-key="13966:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13967"><span data-slate-object="text" data-key="13968"><span data-slate-leaf="true" data-offset-key="13968:0" data-first-offset="true"><span data-slate-string="true">请说说 syscall 指令和 int 指令的区别，是什么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13969"><span data-slate-object="text" data-key="13970"><span data-slate-leaf="true" data-offset-key="13970:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我交流互动，也推荐你把这节课分享给有需要的朋友，一起实现操作系统里的各种功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13971"><span data-slate-object="text" data-key="13972"><span data-slate-leaf="true" data-offset-key="13972:0" data-first-offset="true"><span data-slate-string="true">我是 LMOS，我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (12)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>三、Demo 部分
1、新建一个源码编译目录
mkdir kernelbuild

2、下载源码，解压
wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.10.59.tar.gz   

tar -xzf linux-5.10.59.tar.gz   

cd linux-5.10.59

3、清理
make mrproper

4、修改文件
4.1、arch/x86/entry/syscalls/syscall_64.tbl
# 在 440 后面增加一行
441  common  get_cpus    sys_get_cpus

4.2、include/linux/syscalls.h
# 在最后一个 asmlinkage 增加一行
asmlinkage long sys_get_cpus (void);

4.3、kernel/sys.c  
# 在最后一个 SYSCALL_DEFINE0 后面增加下面几行
// 获取系统中有多少 CPU
SYSCALL_DEFINE0 (get_cpus)
{
    return num_present_cpus ();
}

5、内核配置
make menuconfig
make oldconfig

6、修改. config，去掉一个证书
CONFIG_SYSTEM_TRUSTED_KEYS=“”

7、编译
make -j4

8、安装
sudo make modules_install
sudo make install

9、测试
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/syscall.h&gt;
int main (int argc, char const *argv [])
{
    //syscall 就是根据系统调用号调用相应的系统调用
    long cpus = syscall (441);
    printf ("cpu num is:% d\n", cpus);// 输出结果
    return 0;
}

gcc  cpus.c -o cpus

./cpus
在没有修改的内核上返回是 - 1
在修改过的为 num_present_cpus 数量，我的虚拟机返回的是 1</div><div><p>作者回复: 66666 大佬 大佬</p></div><div><div>2021-08-17</div><div><div><i></i></div><div><i></i><span>9</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>二、linux 内核部分【下】
2、当产生系统调用时
2.1、应用直接 syscall 或通过 glibc 产生了 syscall

2.2、cpu 会产生类似于中断的效果，开始到 entry_SYSCALL_64 执行
// 文件路径 arch/x86/entry/entry_64.S
SYM_CODE_START (entry_SYSCALL_64)
// 省略代码
call   do_syscall_64
SYM_CODE_END (entry_SYSCALL_64)

// 文件路径 arch/x86/entry/entry_64.S
SYM_CODE_START (entry_SYSCALL_compat)
call   do_fast_syscall_32
SYM_CODE_END (entry_SYSCALL_compat)

2.3、调用 do_syscall_64
#ifdef CONFIG_X86_64
__visible noinstr void do_syscall_64 (unsigned long nr, struct pt_regs *regs)
{
    nr = syscall_enter_from_user_mode (regs, nr);
    instrumentation_begin ();
    if (likely (nr &lt; NR_syscalls)) {
        nr = array_index_nospec (nr, NR_syscalls);
        regs-&gt;ax = sys_call_table [nr](regs);
    }
    instrumentation_end ();
    syscall_exit_to_user_mode (regs);
}
#endif

2.4、根据 sys_call_table 调用对应的功能函数
sys_call_table [nr](regs)
如果我们传入 257，就会调用__x64_sys_openat
如果我们传入 441，就会调用__x64_sys_get_cpus

2.5、但咱们实际写的函数 sys_get_cpus，好像和实际调用函数__x64_sys_get_cpus，差了一个__x64，这需要一个 wrapper
arch\x86\include\asm\syscall_wrapper.h
#define SYSCALL_DEFINE0 (sname)                      \
    SYSCALL_METADATA (_##sname, 0);                  \
    static long __do_sys_##sname (const struct pt_regs *__unused);   \
    __X64_SYS_STUB0 (sname)                      \
    __IA32_SYS_STUB0 (sname)                     \
    static long __do_sys_##sname (const struct pt_regs *__unused)

#define __X64_SYS_STUB0 (name)                       \
    __SYS_STUB0 (x64, sys_##name)

#define __SYS_STUB0 (abi, name)                      \
    long __##abi##_##name (const struct pt_regs *regs);      \
    ALLOW_ERROR_INJECTION (__##abi##_##name, ERRNO);         \
    long __##abi##_##name (const struct pt_regs *regs)       \
        __alias (__do_##name);

SYSCALL_DEFINE0 (get_cpus)，会展开成为
__X64_SYS_STUB0 (get_cpus) 
然后
 __SYS_STUB0 (x64, sys_get_cpus)
然后
long __x64_sys_get_cpus (const struct pt_regs *regs);

这样前后就对上了，glibc 和 linux 内核就通了。</div><div><p>作者回复：是的 </p></div><div><div>2021-08-17</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>二、linux 内核部分【上】
1、在 make 时，会通过 syscall_64.tbl 生成 syscalls_64.h，然后包含到 syscall_64.c，进行调用号与函数之间的绑定。
arch/x86/entry/syscalls/syscall_64.tbl
arch/x86/include/generated/asm/syscalls_64.h
arch/x86/entry/syscall_64.c

1.1、以 sys_openat 为例，在 syscall_64.tbl 中为
257    common    openat            sys_openat
441    common    get_cpus          sys_get_cpus

1.2、make 后，在生成的 syscalls_64.h 中为
__SYSCALL_COMMON (257, sys_openat)

1.3 在 syscall_64.c 中，展开__SYSCALL_COMMON
#define __SYSCALL_COMMON (nr, sym) __SYSCALL_64 (nr, sym)
展开就是
__SYSCALL_64 (257, sys_openat)

1.4、在 syscall_64.c 中，第一次展开__SYSCALL_64
#define __SYSCALL_64 (nr, sym) extern long __x64_##sym (const struct pt_regs *);
#include &lt;asm/syscalls_64.h&gt;
#undef __SYSCALL_64
展开就是
extern long __x64_sys_openat (const struct pt_regs *);
也就是每个__SYSCALL_64 都展开成了一个外部函数

1.5、在 syscall_64.c 中，第二次展开__SYSCALL_64
#define __SYSCALL_64 (nr, sym) [nr] = __x64_##sym,

asmlinkage const sys_call_ptr_t sys_call_table [__NR_syscall_max+1] = {
    [0 ... __NR_syscall_max] = &amp;__x64_sys_ni_syscall,
#include &lt;asm/syscalls_64.h&gt;
};

展开其实就是指向了外部函数
[257]=__x64_sys_openat,

全部展开结果，都会被包含到 sys_call_table 中，从而完成了调用号与函数之间的绑定。</div><div><p>作者回复：是的 完全正确</p></div><div><div>2021-08-17</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>一、glibc 部分【下】
4.7、展开 INLINE_SYSCALL
//glibc/sysdeps/unix/sysv/linux/sysdep.h
#define INLINE_SYSCALL (name, nr, args...)       \
  ({                  \
    long int sc_ret = INTERNAL_SYSCALL (name, nr, args);    \
    __glibc_unlikely (INTERNAL_SYSCALL_ERROR_P (sc_ret))    \
    ? SYSCALL_ERROR_LABEL (INTERNAL_SYSCALL_ERRNO (sc_ret))   \
    : sc_ret;               \
  })

展开得到
INTERNAL_SYSCALL (openat, 4, args【AT_FDCWD, file, oflag, mode】);  

4.8、展开 INTERNAL_SYSCALL
#define INTERNAL_SYSCALL (name, nr, args...)       \
  internal_syscall##nr (SYS_ify (name), args)

展开得到
internal_syscall4 (SYS_ify (openat), args【AT_FDCWD, file, oflag, mode】)

展开 SYS_ify (openat)
#define SYS_ify (syscall_name) __NR_##syscall_name
得到
__NR_openat

从而得到
internal_syscall4 (__NR_openat, args【AT_FDCWD, file, oflag, mode】)

4.9、最后 internal_syscall4 中，汇编调用了 syscall

glibc\sysdeps\unix\sysv\linux\x86_64\64\arch-syscall.h
#define __NR_openat 257

syscall 时，先传入调用号 257，然后是四个位真正的参数。</div><div><div>2021-08-17</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI3F4IdQuDZrhN8ThibP85eCiaSWTYpTrcC6QB9EoAkw3IIj6otMibb1CgrS1uzITAnJmGLXQ2tgIkAQ/132"></div></div><div><div><div><span>cugphoenix</span></div></div><div>看了 Linux 系统调用表的生成方式，又刷新了对宏定义的认知，灵活性极强，用起来可太花哨了</div><div><p>作者回复：是的 </p></div><div><div>2021-08-14</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div></div><div>一、glibc 部分【上】
1、应用程序调用 open 函数
//glibc/intl/loadmsgcat.c
# define open (name, flags)  __open_nocancel (name, flags)

2、展开后实际上调用了
__open_nocancel (name, flags)

3、而__open_nocancel 最终调用了 INLINE_SYSCALL_CALL
//glibc/sysdeps/unix/sysv/linux/open_nocancel.c
__open_nocancel (name, flags)
-&gt;return INLINE_SYSCALL_CALL (openat, AT_FDCWD, file, oflag, mode);

4、宏展开【理解就好，不保证顺序】
4.1、初始为
INLINE_SYSCALL_CALL (openat, AT_FDCWD, file, oflag, mode);

4.2、第 1 次展开 INLINE_SYSCALL_CALL
#define INLINE_SYSCALL_CALL (...) \
  __INLINE_SYSCALL_DISP (__INLINE_SYSCALL, __VA_ARGS__)

展开得到：
__INLINE_SYSCALL_DISP (__INLINE_SYSCALL, __VA_ARGS__【openat, AT_FDCWD, file, oflag, mode】)

4.3、第 2 次展开__INLINE_SYSCALL_DISP
#define __INLINE_SYSCALL_DISP (b,...) \
  __SYSCALL_CONCAT (b,__INLINE_SYSCALL_NARGS (__VA_ARGS__))(__VA_ARGS__)

展开得到：
__SYSCALL_CONCAT (b【__INLINE_SYSCALL】,__INLINE_SYSCALL_NARGS (__VA_ARGS__【openat, AT_FDCWD, file, oflag, mode】))(__VA_ARGS__【openat, AT_FDCWD, file, oflag, mode】)

4.4、第 3 次展开__INLINE_SYSCALL_NARGS
__INLINE_SYSCALL_NARGS (__VA_ARGS__【openat, AT_FDCWD, file, oflag, mode】)

#define __INLINE_SYSCALL_NARGS (...) \
  __INLINE_SYSCALL_NARGS_X (__VA_ARGS__,7,6,5,4,3,2,1,0,)

展开得到：
__INLINE_SYSCALL_NARGS_X (openat, AT_FDCWD, file, oflag, mode,7,6,5,4,3,2,1,0,)

然后展开__INLINE_SYSCALL_NARGS_X
#define __INLINE_SYSCALL_NARGS_X (a,b,c,d,e,f,g,h,n,...) n

展开得到参数个数：4

从而 4.4 的结果为
__SYSCALL_CONCAT (__INLINE_SYSCALL,4)(__VA_ARGS__【openat, AT_FDCWD, file, oflag, mode】)

4.5、然后展开__SYSCALL_CONCAT，其实就是字符拼接
__SYSCALL_CONCAT (__INLINE_SYSCALL,4)

#define __SYSCALL_CONCAT_X (a,b)     a##b
#define __SYSCALL_CONCAT (a,b)       __SYSCALL_CONCAT_X (a, b)

展开得到：
__INLINE_SYSCALL4

从而 4.5 的结果为
__INLINE_SYSCALL4 (openat, AT_FDCWD, file, oflag, mode)

4.6、然后展开 INTERNAL_SYSCALL4
#define __INLINE_SYSCALL4 (name, a1, a2, a3, a4) \
  INLINE_SYSCALL (name, 4, a1, a2, a3, a4)

展开得到：
INLINE_SYSCALL (openat, 4, AT_FDCWD, file, oflag, mode)</div><div><p>作者回复：对的 就是这样</p></div><div><div>2021-08-17</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/b3/ac/2c8baa5e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Zhendicai</span></div></div><div>int 指令和 syscall 指令都会发生特权级切换吧，但是 syscall 能直接调定位到具体系统调用函数，int 则需要经过中断门描述符表和分发器才行。int 的步骤要多一些，那就是取指令次数要多一些？还有个问题使用 int 来执行系统调用是不是也会遇到中断优先级的问题？</div><div><p>作者回复：是的正确</p></div><div><div>2021-08-13</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/51/29/24739c58.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 凉人。</span></div></div><div>搬了下答案
1.syscall
syscall 是 x64 的系统调用。其调用号通过 rax 进行传递。查看具体的调用号，linux 环境下在 unistd.h 中定义。如果是 64 位，则可以查看 /usr/include/asm/unistd_64.h，如果是 32 位，则查看 /usr/include/unistd_32.h。

参数传递：处于用户态时，参数传递顺序为：rdi，rsi，rdx，rcx，r8，r9，处于内核态时，参数传递顺序：rdi，rsi，rdx，r10，r8，r9（补充：这是看别人文章是这么写的，但是我在实际操作中发现，我运行用户态汇编代码，通过 rcx 传递参数时函数返回错误，用 ida 查看，发现用户态的值传递其实是：rdi，rsi，rdx，r10，r8，r9（和前面提到的内核态的一致），内核的值传递我没有进行测试，欢迎各位大佬评论区补充）

2.int 80h
int 80h 是 32 位 x86 的系统调用方式。同样通过 ax 传递调用号，参数传递顺序是：ebx，ecx，edx，esi，edi

*** note ***
intel 体系的系统调用限制最多六个参数，没有任何一个参数是通过栈传递的。系统调用的返回结果存放在 ax 寄存器中，且只有整型和内存型可以传递给内核
</div><div><p>作者回复：是的 正确</p></div><div><div>2021-08-13</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f4/48/2242bed9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 吴建平</span></div></div><div>有个疑问，最后验证的应用例子，怎么链接到系统调用的呢，没看到链接过程，默认链接 glibc 么？</div><div><p>作者回复：要编译内核的</p></div><div><div>2022-03-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/21/7e/fb725950.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>罗 乾 林</span></div></div><div>因为这里用到的指令是最新处理器为其设计的系统调用指令 syscall。这个指令和 int 指令一样，都可以让 CPU 跳转到特定的地址上，只不过不经过中断门，系统调用返回时要用 sysexit 指令</div><div><p>作者回复：对的 </p></div><div><div>2021-08-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>实验太顶了，有时间一定搞一下，今天问题属于知识盲区，贴上链接：https://blog.csdn.net/sdulibh/article/details/50890250

不学习就变废物😂</div><div><p>作者回复：哈哈 这有点费时  没什么 难度 </p></div><div><div>2021-08-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/a6/ad/e65aec4c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>苏流郁宓</span></div></div><div>syscall 应该是系统与应用软件的接口？类似 win 系统的消息模块？int 是操作系统与硬件的接口？如新插入 usb 鼠标？</div><div><p>作者回复：不是</p></div><div><div>2021-08-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".y"><outline class="toc-level-h1" data-reactid=".y.0" style="width: 175px;"><active data-reactid=".y.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".y.0.1"><span data-reactid=".y.0.1.0">42 | 瞧一瞧 Linux：如何实现系统 API？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.1" style="width: 165px;"><active data-reactid=".y.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".y.1.1"><span data-reactid=".y.1.1.0">Linux 内核 API 接口的架构</span></a></outline><outline class="toc-level-h2" data-reactid=".y.2" style="width: 165px;"><active data-reactid=".y.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".y.2.1"><span data-reactid=".y.2.1.0">Linux 内核有多少 API 接口</span></a></outline><outline class="toc-level-h3" data-reactid=".y.3" style="width: 155px;"><active data-reactid=".y.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".y.3.1"><span data-reactid=".y.3.1.0">Linux 系统调用表</span></a></outline><outline class="toc-level-h2" data-reactid=".y.4" style="width: 165px;"><active data-reactid=".y.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".y.4.1"><span data-reactid=".y.4.1.0">Linux 系统调用实现</span></a></outline><outline class="toc-level-h3" data-reactid=".y.5" style="width: 155px;"><active data-reactid=".y.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".y.5.1"><span data-reactid=".y.5.1.0">下载 Linux 源码</span></a></outline><outline class="toc-level-h3" data-reactid=".y.6" style="width: 155px;"><active data-reactid=".y.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".y.6.1"><span data-reactid=".y.6.1.0">申明系统调用</span></a></outline><outline class="toc-level-h3" data-reactid=".y.7" style="width: 155px;"><active data-reactid=".y.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".y.7.1"><span data-reactid=".y.7.1.0">定义系统调用</span></a></outline><outline class="toc-level-h3" data-reactid=".y.8" style="width: 155px;"><active data-reactid=".y.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".y.8.1"><span data-reactid=".y.8.1.0">编译 Linux 内核</span></a></outline><outline class="toc-level-h3" data-reactid=".y.9" style="width: 155px;"><active data-reactid=".y.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".y.9.1"><span data-reactid=".y.9.1.0">编写应用测试</span></a></outline><outline class="toc-level-h2" data-reactid=".y.a" style="width: 165px;"><active data-reactid=".y.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".y.a.1"><span data-reactid=".y.a.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".y.b" style="width: 165px;"><active data-reactid=".y.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".y.b.1"><span data-reactid=".y.b.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".y.c" style="width: 165px;"><active data-reactid=".y.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".y.c.1"><span data-reactid=".y.c.1.0">精选留言 (12)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/407343" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>