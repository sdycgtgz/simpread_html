
                <html lang="en" class="simpread-font simpread-theme-root" style='undefined'>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAMAAAANIilAAAAA7VBMVEUAAAD///8ZGRnw8PBWVlb4+PgeHh719fVEREQlJSUODg6Ojo7Ly8v9/f1NTU2VlZUFBQV6enrCwsLy8vLh4eE0NDQLCwu8vLyXl5dxcXHa2trAwMCFhYVDQ0OysrKampo7OzssLCwICAioqKjJyckhISHu7u4/Pz9TU1NQUFBLS0tAQED6+vrS0tKRkZFISEgvLy+goKB+fn5vb29nZ2fm5uYbGxvk5OTX19d2dnZaWlre3t5hYWEyMjK5ubkoKCgVFRXQ0NDMzMzFxcW0tLSsrKykpKSMjIzq6urU1NSAgICvr6+cnJyHh4dsbGyfc25QAAAFkElEQVRIx4WXB3faMBCA74wHxgMMGAOh1MyyVyBAmtVmd/3/n1OdDtWstt/Li5JD35MtnU4CMnCIlkLEOpSKuMPhuI4FE444L9+dyv3zciad/rAjfU/yOPpGcjWS1NKSGsk29WTSD1IeYsIPkvsAJF+C5BIZkieYMNjJnsF4+JHk61wOSlVDyOIPqKBgZIxYTrqy/AmNtC1ps7yqlgE6dgYa1WqD5aV9SbKDbe6ZNnCq5A5ILlhGjEASIoawJdmHHo98AZLOnmxzKM9yK9Aht63FoAWBBmEgsEHnkfMgsZU8PJbpbXJd3MIep/Lg/MjbRqMRRuNtQ4Tthga5RiNzfmSWD97ZExQ64HhtgLb3CmbBGyj54vixjyeMsKjnV4AvOAHTwsHphKnH9toXki7Li3jLsgswizskv+c3PHKXe7ZHu5E/YMKcM2yqZIJkAclZTPClbJezivI1yTr4f+TeMib5qXxHsr7XtUFJDIc8pLAHA7Su4JXkd8ySnKZddQXH2NohswIutRu0Qu0jyS46JPugU+gISB1R8NBKWegVUsahTKEjAP9Bm5bKAc3DPlzjKaDvscE7PeEJu63WUg9a82tdA1O/ESupL9Cr6C1cXetjIe9zgQ4kvKLgHi6xC5LcGq9hhmiK0AYgUvLQtzm3n/x0jnum/Vo9j1jxg/pL3/f9W8isMOsv6/Ubf47rvl+u17nnZ1xQ+4iIXa6IpRVeimEEE3pnxO8kIz4CbFDyidVSpooBCCLLsj5noFlqUg2rwK0l+Anmm+VhCzKfrRHtqjGOLANxUKIUiYvFEcuaaZpXANniD5ZzpiBDTSRkuDJfWM6awxGuikUArp7fIOE7RlB6OygGTyhfsMyrtwDNIAkcp1YRhKC9Oh2IHUFQ6UPupnLL3icODaD5zVlUto7zhm1n7kmZ5kDSQBxykfZhD66eaQBoWriEGPcA182C4Crst90Z9NwvHgahDTALw/Ae4D500Pjq3oj/4sjtwcwVrCkkgB01HB8cdM0iIlWSr6IpNqFO+1mDHQFWORtO5EIi08b4jxy6giBsgKDnRnEYYdd9nIYvaLmuhS/h9DF5bEFr/7HTKAjUqWY1oUUBKgYEZdgIP6gJE2xQIWVvLhZBcAWx843kz87PDDi4cgR92s8/1FLpAGNeKiUbGtRQEIPkGb9TM1EF8MpCVEni7pIkkUdDs1ZcI/ZUer6YZg4WxTtqMmYsZJWebbOzEekZV4sCKaNhBaXQQ0NtjL71ZooNE1vWLfyyyFUbw7MsD0fWOFMSqAnbwj1Kuk0Aqp4aJ91MZhhvyS7+oQoMy5v63Jfoz/UYfPSiep2KQb5e4/gt1Ycdc7Se6jNyVbpuQNI08FrICQ6ccKnSXddrKCnqkqWFupJFAewKudSTBVAyBEjrLSXjCYnc5rrdQVl6VaiKqOTToi/kaSrlcW5fpGpgrlJTLvoGVxKDOg7PHzc6NLXOmuUHTZQhTWvS4T7T5ixPqGPz/EHXp/azkMeQoGOqBBOSq1gD4vwRe1culz8W8HlZKQt6Sjbm5XeS9eWizJw73HcsOW8mSpa0eT8zfK1w85LdtWKTf5dWfCPzMg5J+MBdsvvy6Q2QD/d91sfzouRz9zAdBp6HCcUzskccyBdKzjTC9ZE8HT8+JHLxtiE4d33Ud0uleOObvpXZk4E4/9h2sKD9t6oxgaCFxs9AHiI3wYJCndMbIMs9lLi7vEHFLxAUURyciOnTyzrLH6qSJwo+8CWuQIFL2wSoVyvQea/qtk2yvPtb4mekZMhJQkPwyvIzBbJGJD+jX3eGcfIFhWVmxsVAG5FMgSzm9y4wKL8aJdzvyctoTqEgep6K5lckWGM3uuuA5DadFvIhiTzBL1xzVtT0UDEDxd9ldeutcJLoyvUaoPgNdiqckZLamd0AAAAASUVORK5CYII=")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 网易 Spark Kyuubi 核心架构设计与源码实现剖析</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>网易 Spark Kyuubi 核心架构设计与源码实现剖析</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">本文介绍了网易 Spark Kyuubi 出现的背景、核心架构设计与关键源码实现，是学习、应用和对 Kyuubi 进行二次开发不可多得的技术干货。</sr-rd-desc>
                    <sr-rd-content><section><section><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWksHLyP8PwVYr5nUwria8bibW3gxncBxiaic1uT2nnkZicnKTkHeFNyyyI4K2xWGXN4ppJe8lFriazAibEHw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></section><section data-style="clear: none;line-height:17px;padding:0 0;font-size:12px;"><p><span><strong>香飘叶子</strong></span></p></section></section><section><section><br></section><section><br></section><section><span>未来香飘叶子奶茶店店长，资深奶茶爱好者 ，是网易游戏大数据搬砖工程师，对大数据框架底层实现原理颇感兴趣。<br></span></section></section><section><sr-blockquote><p>版权声明：本文为 xpleaf（香飘叶子）博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。</p></sr-blockquote></section><section><p>本文较为系统、全面并且由浅入深地介绍了网易 Spark Kyuubi 出现的背景、核心架构设计与关键源码实现，是学习、应用和对 Kyuubi 进行二次开发不可多得的技术干货，但由于作者认知水平有限，文中难免会出现描述不准确的措辞，还请多多包容和指出。</p></section><section><h2 id="sr-toc-0"><span>1 概述</span></h2></section><section><p> Kyuubi 是网易数帆旗下易数大数据团队开源的一个高性能的通用 JDBC 和 SQL 执行引擎，建立在 Apache Spark 之上，Kyuubi 的出现，较好的弥补了 Spark ThriftServer 在多租户、资源隔离和高可用等方面的不足，是一个真正可以满足大多数生产环境场景的开源项目。</p></section><section><p>通过分析 Spark ThriftServer 的设计与不足，本文会逐渐带你深入理解 Kyuubi 的核心设计与实现，同时会选取多个关键场景来剖析其源码，通过本文的阅读，希望能让读者对网易 Kyuubi 的整体架构设计有一个较为清晰的理解，并能够用在自己的生产环境中解决更多实际应用问题。</p></section><section><p>本文主要主要选取 Kyuubi 1.1.0 版本来对其设计与实现进行分析，后续的版本迭代社区加入了数据湖等概念和实现，本文不会对这方面的内容进行探讨。</p></section><section><h2 id="sr-toc-1"><span>2&nbsp; Spark ThriftServer 的设计、实现与不足</span></h2><h3 id="sr-toc-2"><span>2.1 产生背景</span></h3><p>在最初使用 Spark 时，只有理解了 Spark RDD 模型和其提供的各种算子时，才能比较好地使用 Spark 进行数据处理和分析，显然由于向上层暴露了过多底层实现细节，Spark 有一定的高使用门槛，在易用性上对许多初入门用户来说并不太友好。</p><p>SparkSQL 的出现则较好地解决了这一问题，通过使用 SparkSQL 提供的简易 API，用户只需要有基本的编程基础并且会使用 SQL，就可以借助 Spark 强大的快速分布式计算能力来处理和分析他们的大规模数据集。</p><p>而 Spark ThriftServer 的出现使 Spark 的易用性又向前迈进了一步，通过提供标准的 JDBC 接口和命令行终端的方式，平台开发者可以基于其提供的服务来快速构建它们的数据分析应用，普通用户甚至不需要有编程基础即可借助其强大的能力来进行交互式数据分析。&nbsp; &nbsp;&nbsp;</p></section><section><h3 id="sr-toc-3"><span>2.2 核心设计</span></h3><p>顾名思义，本质上，Spark ThriftServer 是一个基于 Apache Thrift 框架构建并且封装了 SparkContext 的 RPC 服务端，或者从 Spark 的层面来讲，我们也可以说，Spark ThriftServer 是一个提供了各种 RPC 服务的 Spark Driver。但不管从哪个角度去看 Spark ThriftServer ，有一点可以肯定的是，它是一个 Server，是需要对外提供服务的，因此其是常驻的进程，并不会像一般我们构建的 Spark Application 在完成数据处理的工作逻辑后就退出。其整体架构图如下所示：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPfMIe3iadnr6JibKibBsvuF9REZibxenr1TZcRbcBQezM34snBh75XvrR1w/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><sr-blockquote><p>Apache Thrift 是业界流行的 RPC 框架，通过其提供的接口描述语言（IDL），可以快速构建用于数据通信的并且语言无关的 RPC 客户端和服务端，在带来高性能的同时，大大降低了开发人员构建 RPC 服务的成本，因此在大数据生态其有较多的应用场景，比如我们熟知的 hiveserver2 即是基于 Apache Thrift 来构建其 RPC 服务。</p></sr-blockquote><p>当用户通过 JDBC 或 beeline 方式执行一条 SQL 语句时，<code>TThreadPoolServer</code> 会接收到该 SQL，通过一系列的 Session 和 Operation 的管理，最终会使用在启动 Spark ThriftServer 时已经构建好的 SparkContext 来执行该 SQL，并获取最后的结果集。</p><p>从上面的基本分析中我们可以看到，在不考虑 Spark ThrfitServer 的底层 RPC 通信框架和业务细节时，其整体实现思路是比较清晰和简单的。</p><sr-blockquote><p>当然实际上要构建一个对外提供 SQL 能力的 RPC 服务时，是有许多细节需要考虑的，并且工作量也会非常巨大，Spark ThriftServer 在实现时实际上也没有自己重复造轮子，它复用了 hiveserver2 的许多组件和逻辑，并根据自身的业务需求来对其进行特定改造；同样的，后面当我们去看 Kyuubi 时，也会发现它复用了 hiveserver2 和 Spark ThriftServer 的一些组件和逻辑，并在此基础上创新性地设计自己的一套架构。</p></sr-blockquote></section><section><h3 id="sr-toc-4"><span>2.3 基本实现</span></h3><sr-blockquote><p>这里列举的代码是基于 Spark 2.1 的源码，新版本在结构上可能有所有区别，但不影响我们对其本质实现原理的理解。</p></sr-blockquote><p>前面提到的 <code>TThreadPoolServer</code> 是 Apache Thrift 提供的用于构建 RPC Server 的一个工作线程池类，在 Spark ThriftServer 的 Service 体系结构中，<code>ThriftBinaryService</code> 正是使用 <code>TThreadPoolServer</code> 来构建 RPC 服务端并对外提供一系列 RPC 服务接口：</p><p><strong>Spark ThriftServer Service 体系</strong></p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhP2pAl850nZqcG0hlvzQNrj09xjdZbOonfSfpodtvsYPeVOnSmq7jLZw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></p><section><p><strong><code>ThriftBinaryService</code> 基于 <code>TThreadPoolServer</code> 构建 RPC 服务端</strong></p><pre class="hljs ruby">/<span class="hljs-regexp">/&nbsp;org.apache.hive.service.cli.thrift.ThriftBinaryCLIService#runpublic&nbsp;class&nbsp;ThriftBinaryCLIService&nbsp;extends&nbsp;ThriftCLIService&nbsp;{&nbsp;&nbsp;@Override&nbsp;&nbsp;public&nbsp;void&nbsp;run()&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;/</span><span class="hljs-regexp">/&nbsp;...省略其它细节...&nbsp;&nbsp;&nbsp;&nbsp;/</span><span class="hljs-regexp">/&nbsp;TCP&nbsp;Server&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;=&nbsp;new&nbsp;TThreadPoolServer(sargs);&nbsp;&nbsp;&nbsp;&nbsp;server.setServerEventHandler(serverEventHandler);&nbsp;&nbsp;&nbsp;&nbsp;server.serve();&nbsp;&nbsp;&nbsp;&nbsp;/</span><span class="hljs-regexp">/&nbsp;...省略其它细节...&nbsp;&nbsp;}}</span></pre><p><strong><code>ThriftBinaryService</code> 提供的 RPC 服务接口</strong></p><pre class="hljs cpp"><span class="hljs-comment">//&nbsp;org.apache.hive.service.cli.thrift.TCLIService.IfaceTOpenSessionResp&nbsp;OpenSession(TOpenSessionReq&nbsp;req);TCloseSessionResp&nbsp;CloseSession(TCloseSessionReq&nbsp;req);TGetInfoResp&nbsp;GetInfo(TGetInfoReq&nbsp;req);TExecuteStatementResp&nbsp;ExecuteStatement(TExecuteStatementReq&nbsp;req);TGetTypeInfoResp&nbsp;GetTypeInfo(TGetTypeInfoReq&nbsp;req);TGetCatalogsResp&nbsp;GetCatalogs(TGetCatalogsReq&nbsp;req);TGetSchemasResp&nbsp;GetSchemas(TGetSchemasReq&nbsp;req);TGetTablesResp&nbsp;GetTables(TGetTablesReq&nbsp;req);TGetTableTypesResp&nbsp;GetTableTypes(TGetTableTypesReq&nbsp;req);TGetColumnsResp&nbsp;GetColumns(TGetColumnsReq&nbsp;req);TGetFunctionsResp&nbsp;GetFunctions(TGetFunctionsReq&nbsp;req);TGetOperationStatusResp&nbsp;GetOperationStatus(TGetOperationStatusReq&nbsp;req);TCancelOperationResp&nbsp;CancelOperation(TCancelOperationReq&nbsp;req);TCloseOperationResp&nbsp;CloseOperation(TCloseOperationReq&nbsp;req);TGetResultSetMetadataResp&nbsp;GetResultSetMetadata(TGetResultSetMetadataReq&nbsp;req);TFetchResultsResp&nbsp;FetchResults(TFetchResultsReq&nbsp;req);TGetDelegationTokenResp&nbsp;GetDelegationToken(TGetDelegationTokenReq&nbsp;req);TCancelDelegationTokenResp&nbsp;CancelDelegationToken(TCancelDelegationTokenReq&nbsp;req);TRenewDelegationTokenResp&nbsp;RenewDelegationToken(TRenewDelegationTokenReq&nbsp;req);</span></pre><p>可以看到，其提供的相当一部分接口都是提供 SQL 服务时所必要的能力。</p><p>当然，不管是使用标准的 JDBC 接口还是通过 beeline 的方式来访问 Spark ThriftServer ，必然都是通过 Spark 基于 Apache Thrift 构建的 RPC 客户端来访问这些 RPC 服务接口的，因此我们去看 Spark ThriftServer 提供的 RPC 客户端，其提供的方法接口与 RPC 服务端提供的是对应的，可以参考 <span>org.apache.hive.service.cli.thrift.TCLIService.Client</span>。</p><sr-blockquote><p>如果比较难以理解，建议可以先研究一下 RPC 框架的本质，然后再简单使用一下 Apache Thrift 来构建 RPC 服务端和客户端，这样就会有一个比较清晰的理解，这里不对其底层框架和原理做更多深入的分析。个人觉得，要理解 Spark ThriftServer，或是后面要介绍的 Kyubbi ，本质上是理解其通信框架，也就是其是怎么使用 Apache Thrift 来进行通信的，因为其它的细节都是业务实现。</p></sr-blockquote></section><section><h3 id="sr-toc-5"><span>2.4 主要不足</span></h3><p>Spark ThriftServer 在带来各种便利性的同时，其不足也是显而易见的。</p><p>首先，Spark ThriftServer 难以满足生产环境下多租户与资源隔离的场景需求。由于一个 Spark ThriftServer 全局只有一个 SparkContext，也即只有一个 Spark Application ，其在启动时就确定了全局唯一的用户名，因此在 Spark ThriftServer 的维护人员看来，所有通过 Spark ThriftServer 下发的 SQL 都是来自同一用户（也就是启动时确定的全局唯一的用户名），尽管其背后实际上是由使用 Spark&nbsp; ThriftServer 服务的不同用户下发的，但所有背后的这些用户都共享使用了 Spark&nbsp; ThriftServer 的资源、权限和数据，因此我们难以单独对某个用户做资源和权限上的控制，操作审计和其它安全策略。</p><sr-blockquote><p>在 Spark ThriftServer 执行的一条 SQL 实际上会被转换为一个&nbsp;job 执行，如果用户 A 下发的 SQL 的 job 执行时间较长，必然也会阻塞后续用户 B 下发的 SQL 的执行。</p></sr-blockquote><p>其次，单个 Spark ThriftServer 也容易带来单点故障问题。从 Spark ThriftServer 接 受的客户端请求和其与 Executor 的通信来考虑，Spark ThriftServer 本身的可靠性也难以满足生产环境下的需求。</p><p>因此，在将 Spark ThriftServer 应用于生产环境当中，上面提及的问题和局限性都会不可避免，那业界有没有比较好的解决方案呢？网易开源的 Spark Kyuubi 就给出了比较好的答案。</p><h2 id="sr-toc-6"><span>3 Kyuubi 核心架构设计与源码实现剖析</span></h2><h3 id="sr-toc-7"><span>3.1 Kyuubi 核心架构设计</span></h3><p>Kyuubi 的整体架构设计如下：</p><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPR0VNnxZjICseA3pJKia1gDI7La2UWEVxWg7bTV1ykicaf6NVAF8tqFnQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><p>Kyuubi 从整体上可以分为用户层、服务发现层、Kyuubi Server 层、Kyuubi Engine 层，其整体概述如下：</p><ul><li><p><strong>用户层</strong></p><p>指通过不同方式使用 Kyuubi 的用户，比如通过 JDBC 或 beeline 方式使用 Kyuubi 的用户。</p></li><li><p><strong>服务发现层</strong></p><p>服务发现层依赖于 Zookeeper 实现，其又分为 Kyuubi Server 层的服务发现和 Kyuubi Engine 层的服务发现。</p></li><li><p><strong>Kyuubi Server 层</strong></p><p>由多个不同的 KyuubiServer 实例组成，每个 KyuubiServer 实例本质上为基于 Apache Thrift 实现的 RPC 服务端，其接收来自用户的请求，但并不会真正执行该请求的相关 SQL 操作，只会作为代理转发该请求到 Kyuubi Engine 层用户所属的 SparkSQLEngine 实例上。</p></li><li><p><strong>Kyuubi Engine 层</strong></p><p>由多个不同的 SparkSQLEngine 实例组成，每个 SparkSQLEngine 实例本质上为基于 Apache Thrift 实现的并且持有一个 SparkSession 实例的 RPC 服务端，其接收来自 KyuubiServer 实例的请求，并通过 SparkSession 实例来执行。在 Kyuubi 的 USER 共享层级上，每个 SparkSQLEngine 实例都是用户级别的，即不同的用户其会持有不同的 SparkSQLEngine 实例，以实现用户级别的资源隔离和控制。</p></li></ul><p>下面将会对每一层以及它们的协作与交互展开较为详细的分析。</p><h4 id="sr-toc-8"><span>3.1.1 用户层</span></h4><p>用户层就是指实际需要使用 Kyuubi 服务的用户，它们通过不过的用户名进行标识，以 JDBC 或 beeline 方式进行连接。</p><p>比如我们可以在 beeline 中指定以不同用户名进行登录：</p><p><strong>使用 xpleaf 用户名进行登录</strong></p><pre class="hljs bash">./beeline&nbsp;-u&nbsp;<span class="hljs-string">'jdbc:hive2://10.2.10.1:10009'</span>&nbsp;-n&nbsp;xpleaf&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p><strong>使用 yyh 用户名进行登录</strong></p><pre class="hljs bash">./beeline&nbsp;-u&nbsp;<span class="hljs-string">'jdbc:hive2://10.2.10.1:10010'</span>&nbsp;-n&nbsp;yyh&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p><strong>使用 leaf 用户名进行登录</strong></p><pre class="hljs bash">./beeline&nbsp;-u&nbsp;<span class="hljs-string">'jdbc:hive2://10.2.10.2:10009'</span>&nbsp;-n&nbsp;leaf&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p>当然，这里的用户名或登录标识并不是可以随意指定或使用的，它应该根据实际使用场景由运维系统管理人员进行分配，并且其背后应当有一整套完整的认证、授权和审计机制，以确保整体系统的安全。</p><h4 id="sr-toc-9"><span>3.1.2 服务发现层</span></h4><p>服务发现层主要是指 Zookeepr 服务以及 Kyuubi Server 层的 KyuubiServer 实例和 Kyuubi Engine 层的 SparkSQLEngine 在上面注册的命名空间（即 node 节点），以提供负载均衡和高可用等特性，因此它分为 Kyuubi Server 层的服务发现和 Kyuubi Engine 层的服务发现。</p><p><strong>Kyuubi Server 层的服务发现</strong></p><p>Kyuubi Server 层的服务发现是需要用户感知的。</p><p>KyuubiServer 实例在启动之后都会 向 Zookeeper 的 <code>/kyuubi</code> 节点下面创建关于自己实例信息的节点，主要是包含 KyuubiServer 实例监听的 host 和 port 这两个关键信息，这样用户在连接 KyuubiServer 时，只需要到 Zookeeper 的 <code>/kyuubi</code> 节点下面获取对应的服务信息即可，当有多个 KyuubiServer 实例时，选取哪一个实例进行登录，这个是由用户自行决定的，Kyuubi 本身并不会进行干预。</p><sr-blockquote><p>在实际应用时也可以封装接口实现随机返回实例给用户，以避免直接暴露 Kyuubi 的底层实现给用户。</p></sr-blockquote><p>另外，KyuubiServer 实例是对所有用户共享，并不会存在特定 KyuubiServer 实例只对特定用户服务的问题。</p><sr-blockquote><p>当然在实际应用时你也可以这么做，比如你可以不对用户暴露服务发现，也就是不对用户暴露 Zookeeper，对于不同用户，直接告诉他们相应的 KyuubiServer 实例连接信息即可。不过这样一来，Kyuubi Server 层的高可用就难以保证了。</p></sr-blockquote><p>比如有多个在不同节点上启动的 KyuubiServer 实例，其在 Zookeeper 上面注册的信息如下：</p><pre class="hljs xml">/kyuubi/instance1_10.2.10.1:10009<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>/kyuubi/instance2_10.2.10.1:10010<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>/kyuubi/instance3_10.2.10.2:10009<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p><strong>Kyuubi Engine 层的服务发现</strong></p><p>Kyuubi Engine 层的服务发现是不需要用户感知的，其属于 Kyuubi 内部不同组件之间的一种通信协作方式。</p><p>SparkSQLEngine 实例在启动之后都会向 Zookeeper 的 <code>/kyuubi_USER</code> 节点下面创建关于自己实例信息的节点，主要是包含该实例监听的 host 和 port 以及其所属 user 的相关信息，也就是说 SparkSQLEngine 实例并不是所有用户共享的，它是由用户独享的。</p><p>比如 Kyuubi 系统中有多个不同用户使用了 Kyuubi 服务，启动了多个 SparkSQLEngine 实例，其在 Zookeeper 上面注册的信息如下：</p><pre class="hljs makefile"><span class="hljs-section">/kyuubi_USER/xpleaf/instance1_10.2.20.1:52643/kyuubi_USER/yyh/instance2_10.2.10.1:52346/kyuubi_USER/leaf/instance3_10.2.10.2:51762</span></pre></section><p><span>3.1.3 Kyuubi Server 层</span><br></p><section><p>Kyuubi Server 层由多个不同的 KyuubiServer 实例组成，每个 KyuubiServer 实例本质上为基于 Apache Thrift 实现的 RPC 服务端，其接收来自用户的请求，但并不会真正执行该请求的相关 SQL 操作，只会作为代理转发该请求到 Kyuubi Engine 层用户所属的 SparkSQLEngine 实例上。</p><p>整个 Kyuubi 系统中需要存在多少个 KyuubiServer 实例是由 Kyuubi 系统管理员决定的，根据实际使用 Kyuubi 服务的用户数和并发数，可以部署一个或多个 KyuubiServer 实例，以满足 SLA 要求。当然后续发现 KyuubiServer 实例不够时，可以横向动态扩容，只需要在 Kyuubi 中系统配置好 host 和 port，启动新的 KyuubiServer 实例即可。</p><h4 id="sr-toc-10"><span>3.1.4 Kyuubi Engine 层</span></h4><p>Kyuubi Engine 层由多个不同的 SparkSQLEngine 实例组成，每个 SparkSQLEngine 实例本质上为基于 Apache Thrift 实现的并且持有一个 SparkSession 实例的 RPC 服务端，其接收来自 KyuubiServer 实例的请求，并通过 SparkSession 实例来执行。在 Kyuubi 的 USER 共享层级上，每个 SparkSQLEngine 实例都是用户级别的，即不同的用户其会持有不同的 SparkSQLEngine 实例，以实现用户级别的资源隔离和控制。</p><p>SparkSQLEngine 实例是针对不同的用户按需启动的。在 Kyuubi 整体系统启动之后，如果没有用户访问 Kyuubi 服务，实际上在整个系统中只有一个或多个 KyuubiServer 实例，当有用户通过 JDBC 或 beeline 的方式连接 KyuubiServer 实例时，其会在 Zookeeper 上去查找是否存在用户所属的 SparkSQLEngine 实例，如果没有，则通过 <code>spark-submit</code> 提交一个 Spark 应用，而这个 Spark 应用本身就是 SparkSQLEngine，启动后，基于其内部构建的 SparkSession 实例，即可为特定用户执行相关 SQL 操作。</p><h4 id="sr-toc-11"><span>3.1.5 整体协作流程</span></h4><p>通过前面对各层的介绍，结合 KyubbiServer 架构图，以用户 <code>xpleaf</code> 访问 Kyuubi 服务为例来描述整个流程。</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPR0VNnxZjICseA3pJKia1gDI7La2UWEVxWg7bTV1ykicaf6NVAF8tqFnQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><ul><li><p>1.Kyuubi 系统管理员在大数据集群中启动了 3 个 KyuubiServer 实例和 1 个 Zookeeper 集群，其中 3 个 KyuubiServer 实例的连接信息分别为 <code>10.2.10.1:10009</code>、<code>10.2.10.1:10010</code> 和 <code>10.2.10.2:1009</code>；</p></li><li><p>2. 用户 xpleaf 通过 beeline 终端的方式连接了其中一个 KyuubiServer 实例；</p><pre class="hljs bash">./beeline&nbsp;-u&nbsp;<span class="hljs-string">'jdbc:hive2://10.2.10.1:10009'</span>&nbsp;-n&nbsp;xpleaf&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre></li></ul><sr-blockquote><p>在这里我们假设用户 xpleaf 事先已经通过管理员告知的方式知道了该 KyuubiServer 实例的连接信息。</p></sr-blockquote><ul><li><p>3.KyuubiServer_instance1 接收到 xpleaf 的连接请求，会为该用户创建 session 会话，同时会去 Zookeeper 上检查是否已经存在 xpleaf 所属的 SparkSQLEngine 实例；</p></li><li><p>3.1 如果已经存在，则获取其连接信息；</p></li><li><p>3.2 如果不存在，则通过 spark-submit 的方式提交一个 Spark 应用，启动一个 SparkSQLEngine 实例；</p></li><li><p>4.KyuubiServer_instance1 在 Zookeeper 上没有找到 xpleaf 所属的 SparkSQLEngine 实例信息，其通过 spark-submit 的方式启动了一个 SparkSQLEngine 实例；</p></li><li><p>5. 属于 xpleaf 用户的新的 SparkSQLEngine_instance1 实例在 <code>10.2.10.1</code> 节点上进行启动，并且监听的 <code>52463</code> 端口，启动后，其向 Zookeeper 注册自己的连接信息 <code>/kyuubi_USER/xpleaf/instance1_10.2.10.1:52463</code>；</p></li><li><p>6.KyuubiServer_instance1 在检测到 SparkSQLEngine_instance1 启动成功后，会向其发送创建 session 会话的连接请求；</p></li><li><p>7.SparkSQLEngine_instance1 收到 KyuubiServer_instance1 创建 session 会话的连接请求，则创建一个新的 session 会话；</p></li><li><p>8. 用户启动 beeleine 完成并成功创建会话，接着用户执行 SQL 查询；</p><pre class="hljs coffeescript"><span class="hljs-number">0</span>:&nbsp;jdbc:hive2:<span class="hljs-regexp">//</span><span class="hljs-number">10.2</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>:<span class="hljs-number">10009</span>&gt;&nbsp;select&nbsp;*&nbsp;<span class="hljs-keyword">from</span>&nbsp;teacher;</pre></li><li><p>9.KyuubiServer_instance1 接收到 xpleaf 的执行 SQL 查询的请求，会先检查是否存在 xpleaf 所属的 SparkSQLEngine 实例；</p></li><li><p>10.KyuubiServer_instance1 找到 xpleaf 所属的 SparkSQLEngine_instance1 实例，接着会为这次执行 SQL 的操作创建一个 Operation；</p></li><li><p>11.KyuubiServer_instance1 根据连接信息创建了一个 RPC Client，并且构建 SQL 执行的 RPC 请求，发到对应的 SparkSQLEngine_instance1 实例上；</p></li><li><p>12.SparkSQLEngine_instance1 接收到该请求后，会创建一个该 SQL 操作的 Operation，并且使用其内部的 SparkSession 实例来进行执行，最后将执行结果返回给 KyuubiServer_instance1；</p></li><li><p>13.KyuubiServer_instance1 接收到 SparkSQLEngine_instance1 的执行结果，返回给用户，这样一次 SQL 查询操作就完成了。</p><pre class="hljs xml">0:&nbsp;jdbc:hive2://localhost:10009&gt;&nbsp;select&nbsp;*&nbsp;from&nbsp;teacher;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>+-----------+------------+--------------+<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>|&nbsp;database&nbsp;&nbsp;|&nbsp;tableName&nbsp;&nbsp;|&nbsp;isTemporary&nbsp;&nbsp;|<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>+-----------+------------+--------------+<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>|&nbsp;default&nbsp;&nbsp;&nbsp;|&nbsp;teacher&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>+-----------+------------+--------------+<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>1&nbsp;row&nbsp;selected&nbsp;(0.19&nbsp;seconds)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre></li></ul><p>透过整体协作流程我们可以看到：</p><ul><li><p><span>站在用户层视角来看，其为 RPC 客户端，而为其提供 RPC 服务的是 Kyuubi Server 层，在这里，Kyuubi Server 是 RPC 服务端；</span></p></li><li><p><span>站在 Kyuubi Server 层视角来看，其既是为用户层提供 RPC 服务的 RPC 服务端，同时也是使用 Kyuubi Engine 层 RPC 服务的 RPC 客户端；</span></p></li><li><p><span>站在 Kyuubi Engine 层视角来看，其为 RPC 服务端，其为 Kyuubi Server 层提供 RPC 服务；</span></p></li></ul><p>Kyuubi 在整体 Server 端和 Client 端以及其实现功能的设计上，是十分清晰的。</p><h3 id="sr-toc-12"><span>3.2 Kyuubi 源码实现剖析</span></h3><p>通过前面对 Kyuubi 各层以及整体协作流程的描述，相信对 Kyuubi 的核心架构设计会有一个比较清晰的理解，这样再去分析 Kyuubi 的源码时就会简单很多。</p><p>首先我们会来介绍 Kyuubi 整体的 Service 体系与组合关系，以对 Kyuubi 整体核心代码有一个概览性的理解，接着会选取多个关键场景来对 Kyuubi 的源码进行分析，并且给出每个场景的代码执行流程图。</p><sr-blockquote><p>确实没有办法在较为简短的篇幅里为大家介绍 Kyuubi 源码的方方面面，但我个人认为不管对于哪个大数据组件，在理解了其底层通信框架的基础上，再选取关于该组件的几个或多个关键场景来分析其源码，基本上对其整体设计就会有概览性的理解，这样后面对于该组件可能出现的 Bug 进行排查与修复，或是对该组件进行深度定制以满足业务的实际需求，我相信问题都不大 —— 这也就达到了我们的目的，就是去解决实际问题。</p><p>当然，在这个过程当中你也可以欣赏到漂亮的代码，这本身也是一种享受。</p></sr-blockquote><h4 id="sr-toc-13"><span>3.2.1 RPC 与 Apache Thrift 基本概述</span></h4><p><strong>RPC</strong></p><p>RPC（Remote Procedure Call）远程过程调用，如果按照百度百科的解释会非常羞涩难懂（上面提供的图应该还是《TCP/IP 详解卷 1：协议》上面的一个图），但实际上我们就可以简单地把它理解为，一个进程调用另外一个进程的服务即可，不管是通过 Socket、内存共享或是网络的方式，只要其调用的服务的具体实现不是在调用方的进程内完成的就可以，目前我们见得比较多的是通过网络通信调用服务的方式。</p><p>在 Java 语言层面上比较普遍的 RPC 实现方式是，反射 + 网络通信 + 动态代理的方式来实现 RPC，而网络通信由于需要考虑各种性能指标，主要用的 Netty 或者原生的 NIO 比较多，Socket 一般比较少用，比如可以看一下阿里 Dubbo 的实现。</p><sr-blockquote><p>如果想加深这方面的理解，可以参考我的一个开源 RPC 框架，其实就是非常 mini 版的 Dubbo 实现：<a target="_blank" rel="noopener noreferrer" href="https://github.com/xpleaf/minidubbo" one-link-mark="yes">https://github.com/xpleaf/minidubbo</a>，建议有时间可以看下，实际上这会非常有用，因为几乎所有的大数据组件都会用到相关的 RPC 框架，不管是开源三方的还是其自己实现的（比如 Hadoop 的就是使用自己实现的一套 RPC 框架）。</p></sr-blockquote><p><strong>Apache Thrift</strong></p><p>Apache Thrift 是业界流行的 RPC 框架，通过其提供的接口描述语言（IDL），可以快速构建用于数据通信的并且语言无关的 RPC 客户端和服务端，在带来高性能的同时，大大降低了开发人员构建 RPC 服务的成本，因此在大数据生态其有较多的应用场景，比如我们熟知的 hiveserver2 即是基于 Apache Thrift 来构建其 RPC 服务。</p><h4 id="sr-toc-14"><span>3.2.2 Kyuubi Service 体系与组合关系</span></h4><p>在看 Kyuubi 的源码时，我们可以把较多精力放在某几种较重要的类和其体系上，这样有助于我们抓住重点，理解 Kyuubi 最核心的部分。仅考虑 Kyuubi 整体的架构设计和实现，比较重要的是 Service、Session 和 Operation 等相关的类和体系。</p><p><strong>Service 体系</strong></p><p>Service，顾名思义就是服务，在 Kyuubi 中，各种不同核心功能的提供都是通过其 Service 体系下各个实现类来进行提供的。我们前面提到的服务发现层、Kyuubi Server 层和 Kyuubi Engine 层，在代码实现上绝大部分核心功能都是由 Kyuubi 源码项目的 Server 类体系来完成的，可以这么说，理解了 Service 体系涉及类的相关功能，就基本上从源码级别上理解了整个 Kyuubi 的体系架构设计和实现。</p><sr-blockquote><p>当然这些 Service 的实现类并不一定使用 Service 结尾，比如 SessionManager、OperationManager 等，但基本上从名字我们就能对其功能窥探一二。</p></sr-blockquote><p>其完整的继承关系如下：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhP69JhNMJWrZeAScIRfrJib27Fkdj8RiccdCD3HwOHyS9SqDMbpiauUXMUQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></p><section><p>基于 Kyuubi 提供的核心功能，我们可以大致按 Kyuubi Server 层和 Kyuubi Engine 层来将整个体系中的 Service 类进行一个划分：</p><ul><li><p><strong>Kyuubi Server 层</strong></p></li><li><p><strong>功能入口</strong><br>&nbsp; &nbsp;-&nbsp;<strong>KyuubiServer</strong>：提供 main 方法，是 Kyuubi Server 层 KyuubiServer 实例初始化和启动的入口；</p></li><li><p><strong>服务发现</strong><br>&nbsp; &nbsp;-&nbsp;<strong>KyuubiServiceDiscovery</strong>：封装了 zkClient，用来与 Zookeeper 服务进行交互；</p></li><li><p><strong>核心功能</strong><br>&nbsp; &nbsp;-&nbsp;<strong>FrontendService</strong>：封装了 Apache Thrift 的 TThreadPoolServer，在 Kyuubi Server 层，其主要用于向用户层提供 RPC 服务；<br>&nbsp; &nbsp;-&nbsp;<strong>KyuubiBackendService</strong>：封装了来自用户层不同 RPC 请求的处理逻辑，比如 <code>openSession</code>、<code>executeStatement</code>、<code>fetchResults</code> 等；</p></li><li><p><strong>Session 管理</strong><br>&nbsp; &nbsp;-&nbsp;<strong>KyuubiSessionManager</strong>：提供对用户层的请求会话（session）管理；</p></li><li><p><strong>Operation 管理</strong><br>&nbsp; &nbsp;-&nbsp;<strong>KyuubiOperationManager</strong>：提供对用户层的请求操作（operation）管理；</p></li><li><p><strong>Kyuubi Engine 层</strong></p></li><li><p><strong>功能入口</strong><br>&nbsp; &nbsp;-&nbsp;<strong>SparkSQLEngine</strong>：提供 main 方法，是 Kyuubi Engine 层 SparkSQLEngine 实例初始化和启动的入口；</p></li><li><p><strong>服务发现</strong><br>&nbsp; &nbsp;-&nbsp;<strong>EngineServiceDiscovery</strong>：封装了 zkClient，用来与 Zookeeper 服务进行交互；</p></li><li><p><strong>核心功能</strong><br>&nbsp; &nbsp;-&nbsp;<strong>FrontendService</strong>：封装了 Apache Thrift 的 TThreadPoolServer，在 Kyuubi Engine 层，其主要用于向 Kyuubi Server 层提供 RPC 服务；<br>&nbsp; &nbsp;-&nbsp;<strong>SparkSQLBackendService</strong>：封装了来自 Kyuubi Server 层不同 RPC 请求的处理逻辑，比如 <code>openSession</code>、<code>executeStatement</code>、<code>fetchResults</code> 等；</p></li><li><p><strong>Session 管理</strong><br>&nbsp; &nbsp;-&nbsp;<strong>SparkSQLSessionManager</strong>：提供对 Kyuubi Server 层的请求会话（session）管理；</p></li><li><p><strong>Operation 管理</strong><br>&nbsp; &nbsp;-&nbsp;<strong>SparkSQLOperationManager</strong>：提供对 Kyuubi Server 层的请求操作（operation）管理；</p></li></ul><p>这里我们只对具体实现类进行归类，因为中间抽象类只是提取多个子类的公共方法，不影响我们对其体系功能的说明和讲解；而以 Noop 开头的实际上是 Kyuubi 的测试实现类，因此我们也不展开说明；<code>KinitAuxiliaryService</code> 是 Kyuubi 中用于认证的类，这里我们不对其认证功能实现进行说明。</p><p>通过对 Service 体系各个具体实现类的介绍，再回顾前面对 Kyuubi 整体架构和协作流程的介绍，其抽象的功能在源码实现类上面就有了一个相对比较清晰的体现，并且基本上也是可以一一对应上的。</p><p><strong>Service 组合关系</strong></p><p>为了理解 Kyuubi 在源码层面上是如何进行整体协作的，除了前面介绍的 Service 体系外，我们还有必要理清其各个 Service 之间的组合关系。</p><p>在整个 Service 体系中，<code>CompositeService</code> 这个中间抽象类在设计上是需要额外关注的，它表示的是在它之下的实现类都至少有一个成员为其它 Service 服务类对象，比如对于 <code>KyuubiServer</code>，它的成员则包含有 <code>KyuubiBackdService</code>、<code>KyuubiServiceDiscovery</code> 等多个 Service 实现类，<code>SparkSQLEngine</code> 也是如此。</p><p>我们将一些关键的 Service 类及其组合关系梳理如下，这对后面我们分析关键场景的代码执行流程时会提供很清晰的思路参考：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhP7WbYNsiaaRSpVkb1TOKfyFabia49rY5EByAic0cfxN0dGztEvibYh9jOXQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p><strong>Session 与 SessionHandle</strong></p><ul><li><p><strong>Session</strong></p></li></ul><p>当我们使用通过 JDBC 或 beeline 的方式连接 Kyuubi 时，实际上在 Kyuubi 内部就为我们创建了一个 Session，用以标识本次会话的所有相关信息，后续的所有操作都是基于这次会话来完成的，我们可以在一次会话下执行多个操作（比如多次执行某次 SQL，我们只需要建立一次会话连接即可）。</p><p>Session 在 Kyuubi 中又分为 Kyuubi Server 层的 Session 和 Kyuubi Engine 层的 Session。Kyuubi Server 层的 Session 实现类为 <code>KyuubiSessionImpl</code>，用来标识来自用户层的会话连接信息；Kyuubi Engine 层的 Session 实现类为 <code>SparkSessionImpl</code>，用来标识来自 Kyuubi Server 层的会话连接信息。两个 Session 实现类都有一个共同的抽象父类 <code>AbstractSession</code>，用于 Session 操作的主要功能逻辑都是在该类实现的。</p><ul><li><p><strong>SessionHandle</strong></p></li></ul><p>Session 对象的存储实际上由 SessionManager 来完成，在 SessionManager 内部其通过一个 Map 来存储 Session 的详细信息，其中 key 为 SessionHandle，value 为 Session 对象本身。SessionHandle 可以理解为就是封装了一个唯一标识一个用户会话的字符串，这样用户在会话建立后进行通信时只需要携带该字符串标识即可，并不需要传输完整的会话信息，以避免网络传输带来的开销。</p><p><strong>Operation 与 OperationHandle</strong></p><ul><li><p><strong>Operation</strong></p></li></ul><p>用户在建立会话后执行的相关语句在 Kyuubi 内部都会抽象为一个个的 Operation，比如执行一条 SQL 语句对应的 Operation 实现类为 <code>Executement</code>，不过需要注意，Operation 又分为 Kyuubi Server 层的 <code>KyuubiOperation</code> 和 Kyuubi Engine 层的 <code>SparkOperation</code>。Kyuubi Server 层的 Operation 并不会执行真正的操作，它只是一个代理，它会通过 RPC Client 请求 Kyuubi Engine 层来执行该 Operation，因此所有 Operation 的真正执行都是在 Kyuubi Engine 层来完成的。</p><p>由于 Operation 都是建立在 Session 之下的，所以我们在看前面的组合关系时可以看到，用于管理 Operation 的 OperationManager 为 SessionManager 的成员属性。</p><ul><li><p><strong>OperationHandle</strong></p></li></ul><p>Operation 对象的存储实际上由 OprationManager 来完成，在 SessioOprationManagerManager 内部其通过一个 Map 来存储 Session 的详细信息，其中 key 为 OperationHandle，value 为 Operation 对象本身。OperationHandle 可以理解为就是封装了一个唯一标识一个用户操作的字符串，这样用户基于会话的操作时只需要携带该字符串标识即可，并不需要传输完整的操作信息，以避免网络传输带来的开销。</p><sr-blockquote><p>第一次提交 Operation 时还是需要完整信息，后续只需要提供 OperationHandle 即可，实际上 SQL 语句的执行在 Kyuubi 内部是异步执行的，用户端在提交 Opeation 后即可获得 OperationHandle，后续只需要持着该 OperationHandle 去获取结果即可，我们在分析 SQL 执行的代码时就可以看到这一点。</p></sr-blockquote><h4 id="sr-toc-15"><span>3.2.3 Kyuubi&nbsp;启动流程</span></h4><p>Kyuubi 的启动实际上包含两部分，分别是 KyuubiServer 的启动和 SparkSQLEngine 的启动。KyuubiServer 实例的启动发生在系统管理员根据实际业务需要启动 KyuubiServer 实例，这个是手动操作完成的；而 SparkSQLEngine 实例的启动则是在为用户建立会话时为由 KyuubiServer 实例通过 spark-submit 的方式去提交一个 Spark 应用来完成的。</p><p><strong>KyuubiServer 启动流程</strong></p><p>当我们在 Kyuubi 的 bin 目录下去执行<code>./kyuubi run</code> 命令去启动 KyuubiServer 时，就会去执行 KyuubiServer 的 main 方法：</p><pre class="hljs bash">def&nbsp;main(args:&nbsp;Array[String]):&nbsp;Unit&nbsp;=&nbsp;{&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;info(&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">""</span><span class="hljs-string">"&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Welcome&nbsp;to&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;__&nbsp;&nbsp;__&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;/\&nbsp;\/\&nbsp;\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\&nbsp;\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;\&nbsp;\&nbsp;\/'/'&nbsp;&nbsp;__&nbsp;&nbsp;__&nbsp;&nbsp;__&nbsp;&nbsp;__&nbsp;&nbsp;__&nbsp;&nbsp;__\&nbsp;\&nbsp;\____/\_\&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;\&nbsp;\&nbsp;,&nbsp;&lt;&nbsp;&nbsp;/\&nbsp;\/\&nbsp;\/\&nbsp;\/\&nbsp;\/\&nbsp;\/\&nbsp;\\&nbsp;\&nbsp;'__`\/\&nbsp;\&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;\&nbsp;\&nbsp;\\`\\&nbsp;\&nbsp;\_\&nbsp;\&nbsp;\&nbsp;\_\&nbsp;\&nbsp;\&nbsp;\_\&nbsp;\\&nbsp;\&nbsp;\L\&nbsp;\&nbsp;\&nbsp;\&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;\&nbsp;\_\&nbsp;\_\/`____&nbsp;\&nbsp;\____/\&nbsp;\____/&nbsp;\&nbsp;\_,__/\&nbsp;\_\&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/_/\/_/`/___/&gt;&nbsp;\/___/&nbsp;&nbsp;\/___/&nbsp;&nbsp;&nbsp;\/___/&nbsp;&nbsp;\/_/&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\___/&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/__/&lt;br style="</span>margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-built_in">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"</span><span class="hljs-string">""</span>.stripMargin)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;info(s<span class="hljs-string">"Version:&nbsp;<span class="hljs-variable">$KYUUBI_VERSION</span>,&nbsp;Revision:&nbsp;<span class="hljs-variable">$REVISION</span>,&nbsp;Branch:&nbsp;<span class="hljs-variable">$BRANCH</span>,"</span>&nbsp;+&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"&nbsp;Java:&nbsp;<span class="hljs-variable">$JAVA_COMPILE_VERSION</span>,&nbsp;Scala:&nbsp;<span class="hljs-variable">$SCALA_COMPILE_VERSION</span>,"</span>&nbsp;+&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"&nbsp;Spark:&nbsp;<span class="hljs-variable">$SPARK_COMPILE_VERSION</span>,&nbsp;Hadoop:&nbsp;<span class="hljs-variable">$HADOOP_COMPILE_VERSION</span>,"</span>&nbsp;+&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"&nbsp;Hive:&nbsp;<span class="hljs-variable">$HIVE_COMPILE_VERSION</span>"</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;info(s<span class="hljs-string">"Using&nbsp;Scala&nbsp;<span class="hljs-variable">${Properties.versionString}</span>,&nbsp;<span class="hljs-variable">${Properties.javaVmName}</span>,"</span>&nbsp;+&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"&nbsp;<span class="hljs-variable">${Properties.javaVersion}</span>"</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;SignalRegister.registerLogger(logger)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;val&nbsp;conf&nbsp;=&nbsp;new&nbsp;KyuubiConf().loadFileDefaults()&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;UserGroupInformation.setConfiguration(KyuubiHadoopUtils.newHadoopConf(conf))&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;startServer(conf)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;}&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p>在加载完配置信息后，通过调用 <code>startServer(conf)</code> 方法，就开始了 KyuubiServer 的启动流程：</p><pre class="hljs yaml"><span class="hljs-string">def</span>&nbsp;<span class="hljs-string">startServer(conf:</span>&nbsp;<span class="hljs-string">KyuubiConf):</span>&nbsp;<span class="hljs-string">KyuubiServer</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(!ServiceDiscovery.supportServiceDiscovery(conf))</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">zkServer.initialize(conf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">zkServer.start()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">conf.set(HA_ZK_QUORUM,</span>&nbsp;<span class="hljs-string">zkServer.getConnectString)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">conf.set(HA_ZK_ACL_ENABLED,</span>&nbsp;<span class="hljs-literal">false</span><span class="hljs-string">)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">server</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">KyuubiServer()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">server.initialize(conf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">server.start()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">sys.addShutdownHook(server.stop())&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">server&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>可以看到，实际上 KyuubiServer 的启动包括两部分：初始化和启动。</p><p>KyuubiServer 的初始化和启动实际上是一个递归初始化和启动的过程。我们前面提到，KyuubiServer 为 Service 体系下的一个 <code>CompositeService</code>，参考前面给出的组合关系图，它本身的成员又包含了多个 Service 对象，它们都保存在保存在 <code>serviceList</code> 这个成员当中，因此初始化和启动 KyuubiServer 实际上就是初始化和启动 <code>serviceList</code> 中所包含的各个 Service 对象。而这些 Service 对象本身又可能是 <code>CompositeService</code>，因此 KyuubiServer 的启动和初始化实际上就是一个递归初始化和启动的过程。</p><pre class="hljs xml">//&nbsp;递归初始化serviceList下的各个服务<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>override&nbsp;def&nbsp;initialize(conf:&nbsp;KyuubiConf):&nbsp;Unit&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;serviceList.foreach(_.initialize(conf))<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;super.initialize(conf)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>//&nbsp;递归启动serviceList下的各个服务<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>override&nbsp;def&nbsp;start():&nbsp;Unit&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;serviceList.zipWithIndex.foreach&nbsp;{&nbsp;case&nbsp;(service,&nbsp;idx)&nbsp;=&gt;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;service.start()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;NonFatal(e)&nbsp;=&gt;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(s"Error&nbsp;starting&nbsp;service&nbsp;${service.getName}",&nbsp;e)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop(idx)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;KyuubiException(s"Failed&nbsp;to&nbsp;Start&nbsp;$getName",&nbsp;e)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;super.start()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>这样一来，整个 KyuubiServer 的启动流程就比较清晰了，这也是我们在最开始就列出其 Service 体系和组合关系的原因，由于整体的启动流程和细节所包含的代码比较多，我们就没有必要贴代码了，这里我把整个初始化和启动流程步骤的流程图梳理了出来，待会再对其中一些需要重点关注的点进行说明，如下：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhP7J67r5tCICXiauOfp3mopSRyzg5qDGesffVMGnKwp79P3gv99SY9UMA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p>我们重点关注一下 <code>FontendService</code> 和 <code>ServiceDiscoveryService</code> 的初始化和启动流程。</p><ul><li><p><strong>FrontendService 的初始化和启动</strong></p></li></ul><p>我们需要重点关注一下 <code>FrontendService</code>，因为 KyuubiServer 实例对外提供 RPC 服务都是由其作为入口来完成的。</p><p>其初始化时主要是获取和设置了 Apache Thrift 内置的用于构建 RPC 服务端的 <code>TThreadPoolServer</code> 的相关参数：</p><pre class="hljs yaml"><span class="hljs-string">override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">initialize(conf:</span>&nbsp;<span class="hljs-string">KyuubiConf):</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">synchronized</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">this.conf</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">hadoopConf</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">KyuubiHadoopUtils.newHadoopConf(conf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">serverHost</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_BIND_HOST)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">serverAddr</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">serverHost.map(InetAddress.getByName).getOrElse(InetAddress.getLocalHost)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">portNum</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_BIND_PORT)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">minThreads</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_MIN_WORKER_THREADS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">maxThreads</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_MAX_WORKER_THREADS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">keepAliveTime</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_WORKER_KEEPALIVE_TIME)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">executor</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">ExecutorPoolCaptureOom(&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">name</span>&nbsp;<span class="hljs-string">+</span>&nbsp;<span class="hljs-string">"Handler-Pool"</span><span class="hljs-string">,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">minThreads,</span>&nbsp;<span class="hljs-string">maxThreads,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">keepAliveTime,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">oomHook)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">authFactory</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">KyuubiAuthenticationFactory(conf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">transFactory</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">authFactory.getTTransportFactory&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">tProcFactory</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">authFactory.getTProcessorFactory(this)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">serverSocket</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">ServerSocket(portNum,</span>&nbsp;<span class="hljs-bullet">-1</span><span class="hljs-string">,</span>&nbsp;<span class="hljs-string">serverAddr)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">portNum</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">serverSocket.getLocalPort&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">tServerSocket</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TServerSocket(serverSocket)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">maxMessageSize</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_MAX_MESSAGE_SIZE)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">requestTimeout</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_LOGIN_TIMEOUT).toInt&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">beBackoffSlotLength</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(FRONTEND_LOGIN_BACKOFF_SLOT_LENGTH).toInt&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">args</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TThreadPoolServer.Args(tServerSocket)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.processorFactory(tProcFactory)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.transportFactory(transFactory)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.protocolFactory(new</span>&nbsp;<span class="hljs-string">TBinaryProtocol.Factory)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.inputProtocolFactory(&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TBinaryProtocol.Factory(true,</span>&nbsp;<span class="hljs-literal">true</span><span class="hljs-string">,</span>&nbsp;<span class="hljs-string">maxMessageSize,</span>&nbsp;<span class="hljs-string">maxMessageSize))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.requestTimeout(requestTimeout).requestTimeoutUnit(TimeUnit.SECONDS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.beBackoffSlotLength(beBackoffSlotLength)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.beBackoffSlotLengthUnit(TimeUnit.MILLISECONDS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.executorService(executor)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">TCP</span>&nbsp;<span class="hljs-string">Server&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">server</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">Some(new</span>&nbsp;<span class="hljs-string">TThreadPoolServer(args))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">server.foreach(_.setServerEventHandler(new</span>&nbsp;<span class="hljs-string">FeTServerEventHandler))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">info(s"Initializing</span>&nbsp;<span class="hljs-string">$name</span>&nbsp;<span class="hljs-string">on</span>&nbsp;<span class="hljs-string">host</span>&nbsp;<span class="hljs-string">${serverAddr.getCanonicalHostName}</span>&nbsp;<span class="hljs-string">at</span>&nbsp;<span class="hljs-string">port</span>&nbsp;<span class="hljs-string">$portNum</span>&nbsp;<span class="hljs-string">with"</span>&nbsp;<span class="hljs-string">+&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">s"</span>&nbsp;<span class="hljs-string">[$minThreads,</span>&nbsp;<span class="hljs-string">$maxThreads]</span>&nbsp;<span class="hljs-string">worker</span>&nbsp;<span class="hljs-string">threads")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">e:</span>&nbsp;<span class="hljs-string">Throwable</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">throw</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">KyuubiException(&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">s"Failed</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">initialize</span>&nbsp;<span class="hljs-string">frontend</span>&nbsp;<span class="hljs-string">service</span>&nbsp;<span class="hljs-string">on</span>&nbsp;<span class="hljs-string">$serverAddr:$portNum.",</span>&nbsp;<span class="hljs-string">e)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">super.initialize(conf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>可以看到主要是 host、port、minThreads、maxThreads、maxMessageSize、requestTimeout 等，这些参数都是可配置的，关于其详细作用可以参考 <code>KyuubiConf</code> 这个类的说明。</p><p>其启动比较简单，主要是调用 <code>TThreadPoolServer</code> 的 <code>server()</code> 方法来完成：</p><pre class="hljs sql">override&nbsp;def&nbsp;<span class="hljs-keyword">start</span>():&nbsp;Unit&nbsp;=&nbsp;synchronized&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;super.start()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(!isStarted)&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;serverThread&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;NamedThreadFactory(getName,&nbsp;<span class="hljs-literal">false</span>).newThread(this)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;serverThread.start()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;isStarted&nbsp;=&nbsp;<span class="hljs-literal">true</span>&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;override&nbsp;<span class="hljs-keyword">def</span>&nbsp;run():&nbsp;Unit&nbsp;=&nbsp;try&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;info(s<span class="hljs-string">"Starting&nbsp;and&nbsp;exposing&nbsp;JDBC&nbsp;connection&nbsp;at:&nbsp;jdbc:hive2://$connectionUrl/"</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;server.foreach(_.serve())&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;}&nbsp;catch&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;_:&nbsp;InterruptedException&nbsp;=&gt;&nbsp;<span class="hljs-keyword">error</span>(s<span class="hljs-string">"$getName&nbsp;is&nbsp;interrupted"</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;t:&nbsp;Throwable&nbsp;=&gt;&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;<span class="hljs-keyword">error</span>(s<span class="hljs-string">"Error&nbsp;starting&nbsp;$getName"</span>,&nbsp;t)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;System.exit(<span class="hljs-number">-1</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><ul><li><p><strong>ServiceDiscoveryService 的初始化和启动</strong></p></li></ul><p>初始化时主要是创建一个用于后续连接 ZooKeeper 的 zkClient：</p><pre class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;<span class="hljs-title">namespace</span>:&nbsp;<span class="hljs-title">String</span>&nbsp;=&nbsp;<span class="hljs-title">_namespace</span><span class="hljs-title">&lt;</span><span class="hljs-title">br</span> <span class="hljs-title">style=</span>"<span class="hljs-title">margin</span>: 0<span class="hljs-title">px</span>;</span><span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;override&nbsp;def&nbsp;initialize(conf:&nbsp;KyuubiConf):&nbsp;Unit&nbsp;=&nbsp;{&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;this.conf&nbsp;=&nbsp;conf&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;_namespace&nbsp;=&nbsp;conf.get(HA_ZK_NAMESPACE)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;val&nbsp;maxSleepTime&nbsp;=&nbsp;conf.get(HA_ZK_CONN_MAX_RETRY_WAIT)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;val&nbsp;maxRetries&nbsp;=&nbsp;conf.get(HA_ZK_CONN_MAX_RETRIES)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;setUpZooKeeperAuth(conf)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;_zkClient&nbsp;=&nbsp;buildZookeeperClient(conf)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;zkClient.getConnectionStateListenable.addListener(new&nbsp;ConnectionStateListener&nbsp;{&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;val&nbsp;isConnected&nbsp;=&nbsp;new&nbsp;AtomicBoolean(false)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;override&nbsp;def&nbsp;stateChanged(client:&nbsp;CuratorFramework,&nbsp;newState:&nbsp;ConnectionState):&nbsp;Unit&nbsp;=&nbsp;{&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info(s"</span>Zookeeper&nbsp;client&nbsp;connection&nbsp;state&nbsp;changed&nbsp;<span class="hljs-symbol">to:</span>&nbsp;$newState<span class="hljs-string">")&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newState&nbsp;match&nbsp;{&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;CONNECTED&nbsp;|&nbsp;RECONNECTED&nbsp;=&gt;&nbsp;isConnected.set(true)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;LOST&nbsp;=&gt;&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isConnected.set(false)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;delay&nbsp;=&nbsp;maxRetries.toLong&nbsp;*&nbsp;maxSleepTime&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connectionChecker.schedule(new&nbsp;Runnable&nbsp;{&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;override&nbsp;def&nbsp;run():&nbsp;Unit&nbsp;=&nbsp;if&nbsp;(!isConnected.get())&nbsp;{&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(s"</span>Zookeeper&nbsp;client&nbsp;connection&nbsp;state&nbsp;changed&nbsp;<span class="hljs-symbol">to:</span>&nbsp;$newState,&nbsp;but&nbsp;failed&nbsp;to<span class="hljs-string">"&nbsp;+&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s"</span>&nbsp;reconnect&nbsp;<span class="hljs-keyword">in</span>&nbsp;${delay&nbsp;/&nbsp;<span class="hljs-number">1000</span>}&nbsp;seconds.&nbsp;Give&nbsp;up&nbsp;<span class="hljs-keyword">retry</span>.&nbsp;<span class="hljs-string">")&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stopGracefully()&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;delay,&nbsp;TimeUnit.MILLISECONDS)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;_&nbsp;=&gt;&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;})&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;zkClient.start()&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;super.initialize(conf)&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;}&lt;br style="</span><span class="hljs-symbol">margin:</span> 0px;<span class="hljs-symbol">padding:</span> 0px;<span class="hljs-symbol">outline:</span> 0px;max-<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>%;box-<span class="hljs-symbol">sizing:</span> border-box !important;overflow-<span class="hljs-symbol">wrap:</span> <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;</span></pre><p>当然这里还看到其获取了一个 <code>HA_ZK_NAMESPACE</code> 的配置值，其默认值为 <code>kyuubi</code>：</p><pre class="hljs yaml"><span class="hljs-string">val</span>&nbsp;<span class="hljs-attr">HA_ZK_NAMESPACE:</span>&nbsp;<span class="hljs-string">ConfigEntry[String]</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">buildConf("ha.zookeeper.namespace")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;.doc("The</span>&nbsp;<span class="hljs-string">root</span>&nbsp;<span class="hljs-string">directory</span>&nbsp;<span class="hljs-string">for</span>&nbsp;<span class="hljs-string">the</span>&nbsp;<span class="hljs-string">service</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">deploy</span>&nbsp;<span class="hljs-string">its</span>&nbsp;<span class="hljs-string">instance</span>&nbsp;<span class="hljs-string">uri.</span>&nbsp;<span class="hljs-string">Additionally,</span>&nbsp;<span class="hljs-string">it</span>&nbsp;<span class="hljs-string">will"</span>&nbsp;<span class="hljs-string">+&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"&nbsp;creates&nbsp;a&nbsp;-[username]&nbsp;suffixed&nbsp;root&nbsp;directory&nbsp;for&nbsp;each&nbsp;application"</span><span class="hljs-string">)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;.version("1.0.0")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;.stringConf&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;.createWithDefault("kyuubi")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>在 ServiceDiscoveryService 进行启动的时候，就会基于该 namesapce 来构建在 Kyuubi Server 层进行服务发现所需要的 KyuubiServer 实例信息：</p><pre class="hljs sql">override&nbsp;def&nbsp;<span class="hljs-keyword">start</span>():&nbsp;Unit&nbsp;=&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;val&nbsp;ns&nbsp;=&nbsp;ZKPaths.makePath(<span class="hljs-literal">null</span>,&nbsp;namespace)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;try&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;zkClient&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;.create()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;.creatingParentsIfNeeded()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;.withMode(PERSISTENT)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;.forPath(ns)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;}&nbsp;catch&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;_:&nbsp;NodeExistsException&nbsp;=&gt;&nbsp;&nbsp;//&nbsp;<span class="hljs-keyword">do</span>&nbsp;<span class="hljs-keyword">nothing</span>&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;e:&nbsp;KeeperException&nbsp;=&gt;&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;<span class="hljs-keyword">new</span>&nbsp;KyuubiException(s<span class="hljs-string">"Failed&nbsp;to&nbsp;create&nbsp;namespace&nbsp;'$ns'"</span>,&nbsp;e)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;val&nbsp;<span class="hljs-keyword">instance</span>&nbsp;=&nbsp;server.connectionUrl&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;val&nbsp;pathPrefix&nbsp;=&nbsp;ZKPaths.makePath(&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;namespace,&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"serviceUri=$instance;version=$KYUUBI_VERSION;sequence="</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;try&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;_serviceNode&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;PersistentEphemeralNode(&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zkClient,&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PersistentEphemeralNode.Mode.EPHEMERAL_SEQUENTIAL,&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pathPrefix,&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance.getBytes(StandardCharsets.UTF_8))&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;serviceNode.start()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;znodeTimeout&nbsp;=&nbsp;<span class="hljs-number">120</span>&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!serviceNode.waitForInitialCreate(znodeTimeout,&nbsp;TimeUnit.SECONDS))&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;<span class="hljs-keyword">new</span>&nbsp;KyuubiException(s<span class="hljs-string">"Max&nbsp;znode&nbsp;creation&nbsp;wait&nbsp;time&nbsp;$znodeTimeout&nbsp;s&nbsp;exhausted"</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;info(s<span class="hljs-string">"Created&nbsp;a&nbsp;${serviceNode.getActualPath}&nbsp;on&nbsp;ZooKeeper&nbsp;for&nbsp;KyuubiServer&nbsp;uri:&nbsp;"</span>&nbsp;+&nbsp;<span class="hljs-keyword">instance</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;}&nbsp;catch&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;e:&nbsp;<span class="hljs-keyword">Exception</span>&nbsp;=&gt;&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(serviceNode&nbsp;!=&nbsp;<span class="hljs-literal">null</span>)&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serviceNode.close()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;<span class="hljs-keyword">new</span>&nbsp;KyuubiException(&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"Unable&nbsp;to&nbsp;create&nbsp;a&nbsp;znode&nbsp;for&nbsp;this&nbsp;server&nbsp;instance:&nbsp;$instance"</span>,&nbsp;e)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;super.start()&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p>在这里，就会在 Zookeeper 的 <code>/kyuubi</code> 节点下面创建一个包含 KyuubiServer 实例详细连接信息的节点，假设 KyuubiServer 实例所配置的 host 和 post 分别为 <code>10.2.10.1</code> 和 <code>10009</code>，那么其所创建的 zk 节点为：</p><pre class="hljs yaml"><span class="hljs-string">[zk:</span>&nbsp;<span class="hljs-attr">localhost:2181(CONNECTED)</span>&nbsp;<span class="hljs-number">87</span><span class="hljs-string">]</span>&nbsp;<span class="hljs-string">ls</span>&nbsp;<span class="hljs-string">/kyuubi&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;[serviceUri=10.2.10.1:10009;version=1.1.0;sequence=0000000007]&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><ul><li><p><strong>KyuubiSessionManager 的初始化和启动</strong></p></li></ul><p>我们主要关注一下其启动过程：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.session.SessionManager#start&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">start():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">startTimeoutChecker()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">super.start()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.session.SessionManager#startTimeoutChecker&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;private</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">startTimeoutChecker():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">interval</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(SESSION_CHECK_INTERVAL)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">timeout</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(SESSION_TIMEOUT)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">checkTask</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">Runnable</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">run():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">current</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">System.currentTimeMillis&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(!shutdown)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">for</span>&nbsp;<span class="hljs-string">(session</span>&nbsp;<span class="hljs-string">&lt;-</span>&nbsp;<span class="hljs-string">handleToSession.values().asScala)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(session.lastAccessTime</span>&nbsp;<span class="hljs-string">+</span>&nbsp;<span class="hljs-string">timeout</span>&nbsp;<span class="hljs-string">&lt;=</span>&nbsp;<span class="hljs-string">current</span>&nbsp;<span class="hljs-string">&amp;&amp;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">session.getNoOperationTime</span>&nbsp;<span class="hljs-string">&gt;&nbsp;timeout)&nbsp;{&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closeSession(session.handle)&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;{&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;e:&nbsp;KyuubiSQLException&nbsp;=&gt;&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;warn(s"Error&nbsp;closing&nbsp;idle&nbsp;session&nbsp;${session.handle}",&nbsp;e)&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session.closeExpiredOperations&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;timeoutChecker.scheduleWithFixedDelay(checkTask,&nbsp;interval,&nbsp;interval,&nbsp;TimeUnit.MILLISECONDS)&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;</span></pre><p>在这里主要完成的事情：</p><p>1. 获取 session check interval；</p><p>2. 获取 session timout；</p><p>3. 起一个 schedule 的调度线程；</p><p>4. 根据 interval 和 timeout 对 handleToSession 的 session 进行检查；</p><p>5. 如果 session 超时（超过 timeout 没有 access），则 closesession；</p><p>那么对于 KyuubiServer 的启动过程我们就分析到这里，更多细节部分大家可以结合我的流程图来自行阅读代码即可，实际上当我们把 Kyuubi 的 Service 体系和组合关系整理下来之后，再去分析它的启动流程时就会发现简单很多，这个过程中无非就是要关注它的一些相关参数获取和设置是在哪里完成的，它是怎么侦听服务的（真正用于侦听 host 和 port 的 server 的启动）。</p><p><strong>SparkSQLEngine 启动流程</strong></p><p>在 KyuubiServer 为用户建立会话时会去通过服务发现层去 Zookeeper 查找该用户是否存在对应的 SparkSQLEngine 实例，如果没有则通过 spark-submit 的启动一个属于该用户的 SparkSQLEngine 实例。</p><p>后面在分析 KyuubiServer Session 建立过程会提到，实际上 KyuubiServer 是通过调用外部进程命令的方式来提交一个 Spark 应用的，为了方便分析 SparkSQLEngine 的启动流程，这里我先将其大致的命令贴出来：</p><pre class="hljs xml">/Users/xpleaf/app/kyuubi-1.1.0-bin-spark-3.0-hadoop2.7/externals/spark-3.0.2-bin-hadoop2.7/bin/spark-submit&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--class&nbsp;org.apache.kyuubi.engine.spark.SparkSQLEngine&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.app.name=kyuubi_USER_xpleaf_2dd0b8a8-e8c3-4788-8586-387622630b73&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.hive.server2.thrift.resultset.default.fetch.size=1000&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.kyuubi.ha.zookeeper.namespace=/kyuubi_USER/xpleaf&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.kyuubi.ha.zookeeper.quorum=127.0.0.1:2181&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.yarn.tags=KYUUBI&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.kyuubi.ha.zookeeper.acl.enabled=false&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--proxy-user&nbsp;xpleaf&nbsp;/Users/xpleaf/app/kyuubi-1.1.0-bin-spark-3.0-hadoop2.7/externals/engines/spark/kyuubi-spark-sql-engine-1.1.0.jar<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p><code>kyuubi-spark-sql-engine-1.1.0.jar</code> 是 Kyuubi 发布版本里面的一个 jar 包，里面就包含了 <code>SparkSQLEngine</code> 这个类，通过 <code>-class</code> 参数我们可以知道，实际上就是要运行 SparkSQLEngine 的 main 方法，由于开启了 SparkSQLEngine 的启动流程。</p><p>需要说明的是，提交 Sparkk App 的这些参数在 SparkSQLEngine 启动之前都会被设置到 SparkSQLEngine 的成员变量 <code>kyuubiConf</code> 当中，获取方法比较简单，通过 scala 提供的 <code>sys.props</code> 就可以获取，这些参数在 SparkSQLEngine 的初始化和启动中都会起到十分关键的作用。</p><p>接下来我们看一下 SparkSQLEngine 的 main 方法：</p><pre class="hljs yaml"><span class="hljs-string">def</span>&nbsp;<span class="hljs-string">main(args:</span>&nbsp;<span class="hljs-string">Array[String]):</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">SignalRegister.registerLogger(logger)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">var</span>&nbsp;<span class="hljs-attr">spark:</span>&nbsp;<span class="hljs-string">SparkSession</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-literal">null</span><span class="hljs-string">&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">var</span>&nbsp;<span class="hljs-attr">engine:</span>&nbsp;<span class="hljs-string">SparkSQLEngine</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-literal">null</span><span class="hljs-string">&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">spark</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">createSpark()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">startEngine(spark)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">info(KyuubiSparkUtil.diagnostics(spark))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">blocking</span>&nbsp;<span class="hljs-string">main</span>&nbsp;<span class="hljs-string">thread&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">countDownLatch.await()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">t:</span>&nbsp;<span class="hljs-string">Throwable</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">error("Error</span>&nbsp;<span class="hljs-string">start</span>&nbsp;<span class="hljs-string">SparkSQLEngine",</span>&nbsp;<span class="hljs-string">t)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(engine</span>&nbsp;<span class="hljs-string">!=</span>&nbsp;<span class="hljs-literal">null</span><span class="hljs-string">)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">engine.stop()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">finally</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(spark</span>&nbsp;<span class="hljs-string">!=</span>&nbsp;<span class="hljs-literal">null</span><span class="hljs-string">)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">spark.stop()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>首先会通过 <code>createSpark()</code> 创建一个 SparkSession 对象，后续 SQL 的真正执行都会交由其去执行，其创建方法如下：</p><pre class="hljs xml">def&nbsp;createSpark():&nbsp;SparkSession&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;val&nbsp;sparkConf&nbsp;=&nbsp;new&nbsp;SparkConf()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;sparkConf.setIfMissing("spark.sql.legacy.castComplexTypesToString.enabled",&nbsp;"true")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;sparkConf.setIfMissing("spark.master",&nbsp;"local")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;sparkConf.setIfMissing("spark.ui.port",&nbsp;"0")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;val&nbsp;appName&nbsp;=&nbsp;s"kyuubi_${user}_spark_${Instant.now}"<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;sparkConf.setIfMissing("spark.app.name",&nbsp;appName)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;kyuubiConf.setIfMissing(KyuubiConf.FRONTEND_BIND_PORT,&nbsp;0)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;kyuubiConf.setIfMissing(HA_ZK_CONN_RETRY_POLICY,&nbsp;RetryPolicies.N_TIME.toString)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;//&nbsp;Pass&nbsp;kyuubi&nbsp;config&nbsp;from&nbsp;spark&nbsp;with&nbsp;`spark.kyuubi`<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;val&nbsp;sparkToKyuubiPrefix&nbsp;=&nbsp;"spark.kyuubi."<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;sparkConf.getAllWithPrefix(sparkToKyuubiPrefix).foreach&nbsp;{&nbsp;case&nbsp;(k,&nbsp;v)&nbsp;=&gt;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;kyuubiConf.set(s"kyuubi.$k",&nbsp;v)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;if&nbsp;(logger.isDebugEnabled)&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;kyuubiConf.getAll.foreach&nbsp;{&nbsp;case&nbsp;(k,&nbsp;v)&nbsp;=&gt;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debug(s"KyuubiConf:&nbsp;$k&nbsp;=&nbsp;$v")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;val&nbsp;session&nbsp;=&nbsp;SparkSession.builder().config(sparkConf).enableHiveSupport().getOrCreate()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;session.sql("SHOW&nbsp;DATABASES")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;session<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>这里主要是设置了一些在创建 SparkSession 时需要的参数，包括 appName、spark 运行方式、spark ui 的端口等。另外这里还特别对 <code>frontend.bind.port</code> 参数设置为 0，关于该参数本身的定义如下：</p><pre class="hljs javascript">val&nbsp;FRONTEND_BIND_PORT:&nbsp;ConfigEntry[Int]&nbsp;=&nbsp;buildConf(<span class="hljs-string">"frontend.bind.port"</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;.doc(<span class="hljs-string">"Port&nbsp;of&nbsp;the&nbsp;machine&nbsp;on&nbsp;which&nbsp;to&nbsp;run&nbsp;the&nbsp;frontend&nbsp;service."</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;.version(<span class="hljs-string">"1.0.0"</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;.intConf&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;.checkValue(<span class="hljs-function"><span class="hljs-params">p</span>&nbsp;=&gt;</span>&nbsp;p&nbsp;==&nbsp;<span class="hljs-number">0</span>&nbsp;||&nbsp;(p&nbsp;&gt;&nbsp;<span class="hljs-number">1024</span>&nbsp;&amp;&amp;&nbsp;p&nbsp;&lt;&nbsp;<span class="hljs-number">65535</span>),&nbsp;<span class="hljs-string">"Invalid&nbsp;Port&nbsp;number"</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;.createWithDefault(<span class="hljs-number">10009</span>)&lt;br style=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p>可以看到其默认值为 10009，前面 KyuubiServer 在构建 <code>TThreadPoolServer</code> 时就直接使用了默认值，这也是我们启动的 KyuubiServer 实例侦听 10009 端口的原因，而在这里，也就是 SparkSQLEngine 启动时将其设置为 0 是有原因，我们将在下面继续说明。</p><p>创建完成 SparkSession 后才调用 <code>startEngine(spark)</code> 方法启动 SparkSQLEngine 本身：</p><pre class="hljs xml">def&nbsp;startEngine(spark:&nbsp;SparkSession):&nbsp;SparkSQLEngine&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;val&nbsp;engine&nbsp;=&nbsp;new&nbsp;SparkSQLEngine(spark)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;engine.initialize(kyuubiConf)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;engine.start()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;sys.addShutdownHook(engine.stop())<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;currentEngine&nbsp;=&nbsp;Some(engine)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;engine<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>可以看到也是先进行初始化，然后再启动，SparkSQLEngine 本身是 <code>CompositeService</code>，所以初始化和启动过程跟 KyuubiServer 是一模一样的（当然其包含的成员会有所差别），都是递归对 <code>serviceList</code> 中所包含的各个 Service 对象进行初始化和启动：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhP8LBUF1yApVuGeUxWo9icFgougsKMOUZia41R87Q1hf9w7DOvCKUh7Yrw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><ul><li><p><strong>FrontendService 的初始化和启动</strong></p></li></ul><p>FrontendService 在 SparkSQLEngine 中的启动流程与在 KyuubiServer 中的启动流程是基本一样的，可以参考前面的说明，这里主要说明一些比较细微的差别点。</p><p>前面已经设置了 <code>frontend.bind.port</code> 参数的值为 0，在 FrontendService 这个类当中，它会赋值给 <code>portNum</code> 这个变量，用以构建 <code>TThreadPoolServer</code> 所需要的参数 <code>ServerSocket</code> 对象：</p><pre class="hljs xml">//&nbsp;org.apache.kyuubi.service.FrontendService#initialize<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>val&nbsp;serverSocket&nbsp;=&nbsp;new&nbsp;ServerSocket(portNum,&nbsp;-1,&nbsp;serverAddr)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>所以实际上，不管是 KyuubiServer 还是 SparkSQLEngine，其所侦听的端口是在这里构建 ServerSocket 对象的时候确定下来的，对 ServerSocket 对象，如果传入一个为 0 的 portNum，则表示使用系统随机分配的端口号，所以这也就是我们在启动了 SparkSQLEngine 之后看到其侦听的端口号都是随机端口号的原因。</p><ul><li><p><strong>ServiceDiscoveryService 的初始化和启动</strong></p></li></ul><p>与 KyuubiServer 类似，这里分析一下其差别点。</p><p>前面在通过 spark-submit 提交应用时传入了 <code>--conf spark.kyuubi.ha.zookeeper.namespace=/kyuubi_USER/xpleaf</code> 的参数，实际上在 SparkSQLEngine 初始化 KyuubiConfig 对象时会设置到 <code>KyuubiConfig.HA_ZK_NAMESPACE</code> 属性上，因此在 ServiceDiscoveryService 初始化时获取的 namespace 实际上就为 <code>/kyuubi_USER/xpleaf</code>，而不是默认的 <code>kyuubi</code>，这点是需要注意的：</p><pre class="hljs php">def&nbsp;<span class="hljs-keyword">namespace</span>:&nbsp;<span class="hljs-title">String</span>&nbsp;=&nbsp;<span class="hljs-title">_namespace</span>&lt;<span class="hljs-title">br</span> <span class="hljs-title">style</span>="<span class="hljs-title">margin</span>: 0<span class="hljs-title">px</span>;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&lt;br style="</span>margin: <span class="hljs-number">0</span>px;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;override&nbsp;def&nbsp;initialize(conf:&nbsp;KyuubiConf):&nbsp;Unit&nbsp;=&nbsp;{&lt;br style="</span>margin: <span class="hljs-number">0</span>px;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;this.conf&nbsp;=&nbsp;conf&lt;br style="</span>margin: <span class="hljs-number">0</span>px;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;_namespace&nbsp;=&nbsp;conf.get(HA_ZK_NAMESPACE)&lt;br style="</span>margin: <span class="hljs-number">0</span>px;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;&nbsp;&nbsp;//&nbsp;省略其它代码&lt;br style="</span>margin: <span class="hljs-number">0</span>px;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;}&lt;br style="</span>margin: <span class="hljs-number">0</span>px;padding: <span class="hljs-number">0</span>px;outline: <span class="hljs-number">0</span>px;max-width: <span class="hljs-number">100</span>%;box-sizing: border-box !important;overflow-wrap: <span class="hljs-keyword">break</span>-word !important;<span class="hljs-string">"&gt;</span></pre><p>因此在启动调用 start () 方法时，其在 Zookeeper 上构建的 znode 节点也就不同：</p><pre class="hljs sql">override&nbsp;def&nbsp;<span class="hljs-keyword">start</span>():&nbsp;Unit&nbsp;=&nbsp;{&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;//&nbsp;省略其它代码&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;val&nbsp;<span class="hljs-keyword">instance</span>&nbsp;=&nbsp;server.connectionUrl&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;val&nbsp;pathPrefix&nbsp;=&nbsp;ZKPaths.makePath(&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;namespace,&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;&nbsp;&nbsp;s<span class="hljs-string">"serviceUri=$instance;version=$KYUUBI_VERSION;sequence="</span>)&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;&nbsp;&nbsp;//&nbsp;省略其它代码&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;}&lt;br <span class="hljs-keyword">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</pre><p>比如其创建的 znode 节点为：</p><pre class="hljs yaml"><span class="hljs-string">[zk:</span>&nbsp;<span class="hljs-attr">localhost:2181(CONNECTED)</span>&nbsp;<span class="hljs-number">94</span><span class="hljs-string">]</span>&nbsp;<span class="hljs-string">ls</span>&nbsp;<span class="hljs-string">/kyuubi_USER/xpleaf&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;[serviceUri=10.2.10.1:52643;version=1.1.0;sequence=0000000004]&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><ul><li><p><strong>SparkSQLSessionManager 的初始化和启动</strong></p></li></ul><p>SparkSQLSessionManager 也是继承自 SessionManager，因此与 KyuubiServer 的 KyuubiSessionManager 一样，其也启动了一个用于检查 Session 是否超时的 checker。</p><p>此外，还启动了另外一个 checker，如下：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.engine.spark.SparkSQLEngine#start</span>&nbsp;&nbsp;<span class="hljs-string">&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">start():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">super.start()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">Start</span>&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">self-terminating</span>&nbsp;<span class="hljs-string">checker</span>&nbsp;<span class="hljs-string">after</span>&nbsp;<span class="hljs-string">all</span>&nbsp;<span class="hljs-string">services</span>&nbsp;<span class="hljs-string">are</span>&nbsp;<span class="hljs-string">ready</span>&nbsp;<span class="hljs-string">and</span>&nbsp;<span class="hljs-string">it</span>&nbsp;<span class="hljs-string">can</span>&nbsp;<span class="hljs-string">be</span>&nbsp;<span class="hljs-string">reached</span>&nbsp;<span class="hljs-string">by&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">all</span>&nbsp;<span class="hljs-string">servers</span>&nbsp;<span class="hljs-string">in</span>&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">spaces.&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">backendService.sessionManager.startTerminatingChecker()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.session.SessionManager#startTerminatingChecker&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;private[kyuubi]</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">startTerminatingChecker():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(!isServer)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">initialize</span>&nbsp;<span class="hljs-string">`_latestLogoutTime`</span>&nbsp;<span class="hljs-string">at</span>&nbsp;<span class="hljs-string">start&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">_latestLogoutTime</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">System.currentTimeMillis()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">interval</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(ENGINE_CHECK_INTERVAL)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">idleTimeout</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">conf.get(ENGINE_IDLE_TIMEOUT)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">checkTask</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">Runnable</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">run():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(!shutdown</span>&nbsp;<span class="hljs-string">&amp;&amp;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">System.currentTimeMillis()</span>&nbsp;<span class="hljs-bullet">-</span>&nbsp;<span class="hljs-string">latestLogoutTime</span>&nbsp;<span class="hljs-string">&gt;&nbsp;idleTimeout&nbsp;&amp;&amp;&nbsp;getOpenSessionCount&nbsp;&lt;=&nbsp;0)&nbsp;{&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info(s"Idled&nbsp;for&nbsp;more&nbsp;than&nbsp;$idleTimeout&nbsp;ms,&nbsp;terminating")&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.exit(0)&nbsp;// Note：直接退出整个SparkSQLEngine，也就是App&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;&nbsp;&nbsp;timeoutChecker.scheduleWithFixedDelay(checkTask,&nbsp;interval,&nbsp;interval,&nbsp;TimeUnit.MILLISECONDS)&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;}&lt;br style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"&gt;</span></pre><p>实际上这个 checker 是在 SparkSQLEngine 递归初始化和启动其 serviceList 之前就已经启动，从它的实现当中我们可以看到，当超过一定时时并且 SparkSQLEngine 维护的 Session 为 0 时，整个 SparkSQLEngine 实例就会退出，这样做的好处就是，如果一个用户的 SparkSQLEngine 实例长期没有被使用，我们就可以将其占用的资源释放出来，达到节省资源的目的。</p><h4 id="sr-toc-16"><span>3.2.4 Kyuubi Session 建立过程</span></h4><p>Kyuubi Session 的建立实际上包含两部分，分别是 KyuubiServer Session 建立和 SparkSQLEngine Session 建立，这两个过程不是独立进行的，KyuubiServer Session 的建立伴随着 SparkSQLEngine Session 的建立，KyuubiServer Session 和 SparkSQLEngine Session 才完整构成了 Kyuubi 中可用于执行特定 Operation 操作的 Session。</p><p><strong>KyuubiServer Session 建立过程</strong></p><p>当用户通过 JDBC 或 beeline 的方式连接 Kyuubi 时，实际上就开启了 KyuubiServer Session 的一个建立过程，此时 KyuubiServer 中 FrontedService 的 <code>OpenSession</code> 方法就会被执行：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.service.FrontendService#OpenSession&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">OpenSession(req:</span>&nbsp;<span class="hljs-string">TOpenSessionReq):</span>&nbsp;<span class="hljs-string">TOpenSessionResp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">debug(req.toString)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">info("Client</span>&nbsp;<span class="hljs-string">protocol</span>&nbsp;<span class="hljs-attr">version:</span>&nbsp;<span class="hljs-string">"&nbsp;+&nbsp;req.getClient_protocol)&lt;br style="</span><span class="hljs-attr">margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">resp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TOpenSessionResp&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">sessionHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">getSessionHandle(req,</span>&nbsp;<span class="hljs-string">resp)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setSessionHandle(sessionHandle.toTSessionHandle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setConfiguration(new</span>&nbsp;<span class="hljs-string">java.util.HashMap[String,</span>&nbsp;<span class="hljs-string">String]())&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setStatus(OK_STATUS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">Option(CURRENT_SERVER_CONTEXT.get()).foreach(_.setSessionHandle(sessionHandle))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">e:</span>&nbsp;<span class="hljs-string">Exception</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">warn("Error</span>&nbsp;<span class="hljs-string">opening</span>&nbsp;<span class="hljs-attr">session:</span>&nbsp;<span class="hljs-string">",&nbsp;e)&lt;br style="</span><span class="hljs-attr">margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setStatus(KyuubiSQLException.toTStatus(e,</span>&nbsp;<span class="hljs-string">verbose</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-literal">true</span><span class="hljs-string">))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">resp&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>进而开启了 KyuubiServer Session 建立以及后续 SparkSQLEngine 实例启动（这部分前面已经单独介绍）、SparkSQLEngine Session 建立的过程：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPic84ibricHxZouHNZVUMFpgFR6Y49Wb9b6xsyRG099PBFzbVC97mpM1icg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p>整体流程并不复杂，在执行 FrontendService#OpenSession 方法时，最终会调用到 KyuubiSessionImpl#open 方法，这是整个 KyuubiServer Session 建立最复杂也是最为关键的一个过程，为此我们单独将其流程整理出来进行说明：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPHCqY6lGVOeJ4rMLeaM2rAictqToicBElibCWIfWFIiciaiavia9cYnR0J4wIw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p>流程中其实已经可以比较清晰地说明其过程，这里我们再详细展开说下，其主要分为下面的过程：</p><ul><li><p><strong>服务发现与 SparkSQLEngine 实例启动</strong></p></li></ul><p>第一次建立特定 user 的 session 时，在 zk 的 /kyuubi_USER path 下是没有相关 user 的节点的，比如 /kyuubi_USER/xpleaf，因此在代码执行流程中，其获取的值会为 None，这就触发了其调用外部命令来启动一个 SparkSQLEngine 实例：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.session.KyuubiSessionImpl#open&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">open():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">super.open()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">zkClient</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">startZookeeperClient(sessionConf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">logSessionInfo(s"Connected</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">Zookeeper")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">getServerHost(zkClient,</span>&nbsp;<span class="hljs-string">appZkNamespace)</span>&nbsp;<span class="hljs-string">match</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-string">Some((host,</span>&nbsp;<span class="hljs-string">port))</span>&nbsp;<span class="hljs-string">=&gt;</span>&nbsp;<span class="hljs-string">openSession(host,</span>&nbsp;<span class="hljs-string">port)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-string">None</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sessionConf.setIfMissing(SparkProcessBuilder.APP_KEY,</span>&nbsp;<span class="hljs-string">boundAppName.toString)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">tag</span>&nbsp;<span class="hljs-string">is</span>&nbsp;<span class="hljs-string">a</span>&nbsp;<span class="hljs-string">seq</span>&nbsp;<span class="hljs-string">type</span>&nbsp;<span class="hljs-string">with</span>&nbsp;<span class="hljs-string">comma-separated&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sessionConf.set(SparkProcessBuilder.TAG_KEY,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sessionConf.getOption(SparkProcessBuilder.TAG_KEY)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">.map(_</span>&nbsp;<span class="hljs-string">+</span>&nbsp;<span class="hljs-string">","</span><span class="hljs-string">).getOrElse("")</span>&nbsp;<span class="hljs-string">+</span>&nbsp;<span class="hljs-string">"KYUUBI"</span><span class="hljs-string">)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sessionConf.set(HA_ZK_NAMESPACE,</span>&nbsp;<span class="hljs-string">appZkNamespace)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">builder</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">SparkProcessBuilder(appUser,</span>&nbsp;<span class="hljs-string">sessionConf)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">logSessionInfo(s"Launching</span>&nbsp;<span class="hljs-string">SQL</span>&nbsp;<span class="hljs-attr">engine:\n$builder")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">process</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">builder.start&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">var</span>&nbsp;<span class="hljs-string">sh</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">getServerHost(zkClient,</span>&nbsp;<span class="hljs-string">appZkNamespace)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">started</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">System.currentTimeMillis()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">var</span>&nbsp;<span class="hljs-attr">exitValue:</span>&nbsp;<span class="hljs-string">Option[Int]</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">None&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">while</span>&nbsp;<span class="hljs-string">(sh.isEmpty)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(exitValue.isEmpty</span>&nbsp;<span class="hljs-string">&amp;&amp;</span>&nbsp;<span class="hljs-string">process.waitFor(1,</span>&nbsp;<span class="hljs-string">TimeUnit.SECONDS))</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">exitValue</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">Some(process.exitValue())&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(exitValue.get</span>&nbsp;<span class="hljs-string">!=</span>&nbsp;<span class="hljs-number">0</span><span class="hljs-string">)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">throw</span>&nbsp;<span class="hljs-string">builder.getError&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(started</span>&nbsp;<span class="hljs-string">+</span>&nbsp;<span class="hljs-string">timeout</span>&nbsp;<span class="hljs-string">&lt;=</span>&nbsp;<span class="hljs-string">System.currentTimeMillis())</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">process.destroyForcibly()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">throw</span>&nbsp;<span class="hljs-string">KyuubiSQLException(s"Timed</span>&nbsp;<span class="hljs-string">out($timeout</span>&nbsp;<span class="hljs-string">ms)</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">launched</span>&nbsp;<span class="hljs-string">Spark</span>&nbsp;<span class="hljs-string">with</span>&nbsp;<span class="hljs-string">$builder",&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">builder.getError)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sh</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">getServerHost(zkClient,</span>&nbsp;<span class="hljs-string">appZkNamespace)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">Some((host,</span>&nbsp;<span class="hljs-string">port))</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">sh&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">openSession(host,</span>&nbsp;<span class="hljs-string">port)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">finally</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">we</span>&nbsp;<span class="hljs-string">must</span>&nbsp;<span class="hljs-string">close</span>&nbsp;<span class="hljs-string">the</span>&nbsp;<span class="hljs-string">process</span>&nbsp;<span class="hljs-string">builder</span>&nbsp;<span class="hljs-string">whether</span>&nbsp;<span class="hljs-string">session</span>&nbsp;<span class="hljs-string">open</span>&nbsp;<span class="hljs-string">is</span>&nbsp;<span class="hljs-string">success</span>&nbsp;<span class="hljs-string">or</span>&nbsp;<span class="hljs-string">failure</span>&nbsp;<span class="hljs-string">since&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">we</span>&nbsp;<span class="hljs-string">have</span>&nbsp;<span class="hljs-string">a</span>&nbsp;<span class="hljs-string">log</span>&nbsp;<span class="hljs-string">capture</span>&nbsp;<span class="hljs-string">thread</span>&nbsp;<span class="hljs-string">in</span>&nbsp;<span class="hljs-string">process</span>&nbsp;<span class="hljs-string">builder.&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">builder.close()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">finally</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">zkClient.close()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">e:</span>&nbsp;<span class="hljs-string">IOException</span>&nbsp;<span class="hljs-string">=&gt;</span>&nbsp;<span class="hljs-string">error("Failed</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">release</span>&nbsp;<span class="hljs-string">the</span>&nbsp;<span class="hljs-string">zkClient</span>&nbsp;<span class="hljs-string">after</span>&nbsp;<span class="hljs-string">session</span>&nbsp;<span class="hljs-string">established",</span>&nbsp;<span class="hljs-string">e)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>而调用的外部命令实际上就是我们在前面讲解 SparkSQLEngine 实例中提到的 spark-submit 命令：</p><pre class="hljs xml">/Users/xpleaf/app/kyuubi-1.1.0-bin-spark-3.0-hadoop2.7/externals/spark-3.0.2-bin-hadoop2.7/bin/spark-submit&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--class&nbsp;org.apache.kyuubi.engine.spark.SparkSQLEngine&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.app.name=kyuubi_USER_xpleaf_2dd0b8a8-e8c3-4788-8586-387622630b73&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.hive.server2.thrift.resultset.default.fetch.size=1000&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.kyuubi.ha.zookeeper.namespace=/kyuubi_USER/xpleaf&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.kyuubi.ha.zookeeper.quorum=127.0.0.1:2181&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.yarn.tags=KYUUBI&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--conf&nbsp;spark.kyuubi.ha.zookeeper.acl.enabled=false&nbsp;\<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>--proxy-user&nbsp;xpleaf&nbsp;/Users/xpleaf/app/kyuubi-1.1.0-bin-spark-3.0-hadoop2.7/externals/engines/spark/kyuubi-spark-sql-engine-1.1.0.jar<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>之后就是 SparkSQLEngine 实例的启动过程，其启动完成之后，就会在 Zookeeper 上面注册自己的节点信息。</p><p>对于 KyuubiSessionImpl#open 方法，在不超时的情况下，循环会一直执行，直到其获取到用户的 SparkSQLEngine 实例信息，循环结束，进入下面跟 SparkSQLEngine 实例建立会话的过程。</p><ul><li><p><strong>建立与 SparkSQLEngine 实例的会话</strong></p></li></ul><p>SparkSQLEngine 本质上也是一个 RPC 服务端，为了与其进行通信以建立会话，就需要构建 RPC 客户端，这里 KyuubiSessionImpl#openSession 方法中构建 RPC 客户端的方法主要是 Apache Thrift 的一些模板代码，如下：</p><pre class="hljs yaml"><span class="hljs-string">org.apache.kyuubi.session.KyuubiSessionImpl#openSession&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;private</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">openSession(host:</span>&nbsp;<span class="hljs-string">String,</span>&nbsp;<span class="hljs-attr">port:</span>&nbsp;<span class="hljs-string">Int):</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">passwd</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">Option(password).filter(_.nonEmpty).getOrElse("anonymous")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">loginTimeout</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">sessionConf.get(ENGINE_LOGIN_TIMEOUT).toInt&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">transport</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">PlainSASLHelper.getPlainTransport(&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">user,</span>&nbsp;<span class="hljs-string">passwd,</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TSocket(host,</span>&nbsp;<span class="hljs-string">port,</span>&nbsp;<span class="hljs-string">loginTimeout))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(!transport.isOpen)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">logSessionInfo(s"Connecting</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">[$host:$port]")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">transport.open()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">logSessionInfo(s"Connected</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">[$host:$port]")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">client</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TCLIService.Client(new</span>&nbsp;<span class="hljs-string">TBinaryProtocol(transport))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">req</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TOpenSessionReq()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">req.setUsername(user)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">req.setPassword(passwd)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">req.setConfiguration(conf.asJava)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">logSessionInfo(s"Sending</span>&nbsp;<span class="hljs-string">TOpenSessionReq</span>&nbsp;<span class="hljs-string">to</span>&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">[$host:$port]")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">resp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">client.OpenSession(req)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">logSessionInfo(s"Received</span>&nbsp;<span class="hljs-string">TOpenSessionResp</span>&nbsp;<span class="hljs-string">from</span>&nbsp;<span class="hljs-string">engine</span>&nbsp;<span class="hljs-string">[$host:$port]")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">ThriftUtils.verifyTStatus(resp.getStatus)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">remoteSessionHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">resp.getSessionHandle&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">sessionManager.operationManager.setConnection(handle,</span>&nbsp;<span class="hljs-string">client,</span>&nbsp;<span class="hljs-string">remoteSessionHandle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>在发送请求给 SparkSQLEngine 的时候，又会触发 SparkSQLEngine Session 建立的过程（这个接下来说明），在跟其建立完 Session 之后，KyuubiSessionImpl 会将其用于标识用户端会话的 sessionHandle、用于跟 SparkSQLEngine 进行通信的 RPC 客户端和在 SparkSQLEngine 实例中进行 Session 标识的 remoteSessionHandle 缓存下来，这样在整个 Kyuubi 体系中，就构建了一个完整的 Session 映射关系：userSessionInKyuubiServer-RPCClient-KyuubiServerSessionInSparkSQLEngine，后续的 Operation 都是建立在这样一个体系之下。</p><p>KyuubiServer 在 Session 建立完成后会给客户端返回一个 SessionHandle，后续客户端在与 KyuubiServer 进行通信时都会携带该 SessionHandle，以标识其用于会话的窗口。</p><p><strong>SparkSQLEngine Session 建立过程</strong></p><p>在接收到来自 KyuubiServer 的建立会话的 RPC 请求之后，SparkSQLEngine 中 FrontedService 的 <code>OpenSession</code> 方法就会被执行，其整体流程与 KyuubiServer Session 的建立过程是类似的，主要不同在于 SparkSQLSessionManager#openSession 方法执行上面，如下：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPZjicYiamv1bLjIXkVor6mzUwib4Ag1eanJdaPdia1uia0Xw9Gq3q0soib0cw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p>其对应的关键代码如下：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.engine.spark.session.SparkSQLSessionManager#openSession&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">openSession(&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">protocol:</span>&nbsp;<span class="hljs-string">TProtocolVersion,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">user:</span>&nbsp;<span class="hljs-string">String,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">password:</span>&nbsp;<span class="hljs-string">String,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">ipAddress:</span>&nbsp;<span class="hljs-string">String,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">conf:</span>&nbsp;<span class="hljs-string">Map[String,</span>&nbsp;<span class="hljs-string">String]):</span>&nbsp;<span class="hljs-string">SessionHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">info(s"Opening</span>&nbsp;<span class="hljs-string">session</span>&nbsp;<span class="hljs-string">for</span>&nbsp;<span class="hljs-string">$user@$ipAddress")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">sessionImpl</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">SparkSessionImpl(protocol,</span>&nbsp;<span class="hljs-string">user,</span>&nbsp;<span class="hljs-string">password,</span>&nbsp;<span class="hljs-string">ipAddress,</span>&nbsp;<span class="hljs-string">conf,</span>&nbsp;<span class="hljs-string">this)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">handle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">sessionImpl.handle&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">sparkSession</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">spark.newSession()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">省略非核心代码&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sessionImpl.open()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">operationManager.setSparkSession(handle,</span>&nbsp;<span class="hljs-string">sparkSession)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">setSession(handle,</span>&nbsp;<span class="hljs-string">sessionImpl)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">info(s"$user's</span>&nbsp;<span class="hljs-string">session</span>&nbsp;<span class="hljs-string">with</span>&nbsp;<span class="hljs-string">$handle</span>&nbsp;<span class="hljs-string">is</span>&nbsp;<span class="hljs-string">opened,</span>&nbsp;<span class="hljs-string">current</span>&nbsp;<span class="hljs-string">opening</span>&nbsp;<span class="hljs-string">sessions"</span>&nbsp;<span class="hljs-string">+&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">s"</span>&nbsp;<span class="hljs-string">$getOpenSessionCount")&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">handle&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">e:</span>&nbsp;<span class="hljs-string">Exception</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">sessionImpl.close()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">throw</span>&nbsp;<span class="hljs-string">KyuubiSQLException(e)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p><code>sessionImpl.open()</code> 实际上只是做了日志记录的一些操作，所以其实这里的核心是将创建的 Session 记录下来。</p><p>SparkSQLEngine 在 Session 建立完成后会给 KyuubiServer 返回一个 SessionHandle，后续 KyuubiServer 在与 SparkSQLEngine 进行通信时都会携带该 SessionHandle，以标识其用于会话的窗口。</p><h4 id="sr-toc-17"><span>3.2.5 Kyuubi SQL 执行流程</span></h4><p>Kyuubi SQL 的执行流程实际上包含两部分，分别是 KyuubiServer SQL 执行流程和 SparkSQLEngine SQL 执行流程，其结合起来才是一个完整的 SQL 执行流程，KyuubiServer 只是一个代理，真正的 SQL 执行是在 SparkSQLEngine 中完成。</p><p>另外由于在 Kyuubi 中，SQL 的执行是异步的，也就是可以先提交一个 SQL 让其去执行，后续再通过其返回的 operationHandle 去获取结果，所以在 KyuubiServer 和 SparkSQLEngine 内部，SQL 的执行流程又可以再细分为提交 Statement 和 FetchResults 两个过程，在分别分析 KyuubiServer SQL 执行流程和 SparkSQLEngine SQL 执行流程时，我们就是对提交 Statment 和 FetchResults 这两个过程来展开详细的分析，整体会有些繁多，但并不复杂。</p><p><strong>KyuubiServer SQL 执行流程</strong></p><ul><li><p><strong>1. 提交 Statement</strong></p></li></ul><p>当用户通过 JDBC 或 beeline 的方式执行一条 SQL 语句时，就开启了 SQL 语句在 Kyuubi 中的执行流程，此时 KyuubiServer 中 FrontedService 的 <code>ExecuteStatement</code> 方法就会被执行：</p><pre class="hljs yaml"><span class="hljs-string">override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">ExecuteStatement(req:</span>&nbsp;<span class="hljs-string">TExecuteStatementReq):</span>&nbsp;<span class="hljs-string">TExecuteStatementResp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">debug(req.toString)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">resp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TExecuteStatementResp&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">sessionHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">SessionHandle(req.getSessionHandle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">statement</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">req.getStatement&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">runAsync</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">req.isRunAsync&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">confOverlay</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">req.getConfOverlay&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">queryTimeout</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">req.getQueryTimeout&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">operationHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(runAsync)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">be.executeStatementAsync(sessionHandle,</span>&nbsp;<span class="hljs-string">statement,</span>&nbsp;<span class="hljs-string">queryTimeout)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">else</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">be.executeStatement(sessionHandle,</span>&nbsp;<span class="hljs-string">statement,</span>&nbsp;<span class="hljs-string">queryTimeout)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setOperationHandle(operationHandle.toTOperationHandle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setStatus(OK_STATUS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">e:</span>&nbsp;<span class="hljs-string">Exception</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">warn("Error</span>&nbsp;<span class="hljs-string">executing</span>&nbsp;<span class="hljs-attr">statement:</span>&nbsp;<span class="hljs-string">",&nbsp;e)&lt;br style="</span><span class="hljs-attr">margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setStatus(KyuubiSQLException.toTStatus(e))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">resp&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p><code>runAsync</code> 值为 true，因此会通过异步的方式来执行 SQL，也就是会执行 BackendService 的 executeStatementAsync 方法，开启了异步执行 SQL 的流程：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPnxCZiaLtNQMkg3HvWvvIf4Wicl789BEjC7IaZhTI2lWfWvbRAEDw598A/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p>首先会通过 KyuubiOperationManager 去创建一个表示执行 SQL 的 ExecuteStatement：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.operation.KyuubiOperationManager#newExecuteStatementOperation&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">newExecuteStatementOperation(&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">session:</span>&nbsp;<span class="hljs-string">Session,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">statement:</span>&nbsp;<span class="hljs-string">String,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">runAsync:</span>&nbsp;<span class="hljs-string">Boolean,&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-attr">queryTimeout:</span>&nbsp;<span class="hljs-string">Long):</span>&nbsp;<span class="hljs-string">Operation</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">client</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">getThriftClient(session.handle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">remoteSessionHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">getRemoteTSessionHandle(session.handle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">operation</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">ExecuteStatement(session,</span>&nbsp;<span class="hljs-string">client,</span>&nbsp;<span class="hljs-string">remoteSessionHandle,</span>&nbsp;<span class="hljs-string">statement,</span>&nbsp;<span class="hljs-string">runAsync)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">addOperation(operation)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>client 实际上就是我们前面在 KyuubiServer Session 建立过程中建立的用于与 SparkSQLEngine 通信的 RPC 客户端，ExecuteStatement 需要 client 来发送执行 SQL 语句的请求给 SparkSQLEngine 实例，不过需要注意的是，这里的 ExecuteStatement 是 KyuubiServer 体系下的，其类全路径为 <code>org.apache.kyuubi.operation.ExecuteStatement</code>，因为后面在分析 SparkSQLEngine SQL 执行流程时，在 SparkSQLEngine 体系下也有一个 ExecuteStatement，但其类全路径为 <code>org.apache.kyuubi.engine.spark.operation.ExecuteStatement</code>。</p><p>这里的整个流程关键在于后面执行 <code>operation.run()</code> 方法，进而执行 <code>runInternal()</code> 方法：</p><pre class="hljs xml">//&nbsp;org.apache.kyuubi.operation.ExecuteStatement#runInternal<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>override&nbsp;protected&nbsp;def&nbsp;runInternal():&nbsp;Unit&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;if&nbsp;(shouldRunAsync)&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;executeStatement()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;sessionManager&nbsp;=&nbsp;session.sessionManager<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;asyncOperation&nbsp;=&nbsp;new&nbsp;Runnable&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;override&nbsp;def&nbsp;run():&nbsp;Unit&nbsp;=&nbsp;waitStatementComplete()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;backgroundOperation&nbsp;=<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionManager.submitBackgroundOperation(asyncOperation)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setBackgroundHandle(backgroundOperation)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;onError("submitting&nbsp;query&nbsp;in&nbsp;background,&nbsp;query&nbsp;rejected")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}&nbsp;else&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;setState(OperationState.RUNNING)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;executeStatement()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;setState(OperationState.FINISHED)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>这里会通过异步的方式来执行，其先同步执行 executeStatement () 方法，然后再提交一个异步线程来执行 asyncOperation（<code>sessionManager.submitBackgroundOperation(asyncOperation)</code> 实际上就是通过线程池来提交一个线程线程），我们先看一下其 executeStatement () 方法：</p><pre class="hljs xml">//&nbsp;org.apache.kyuubi.operation.ExecuteStatement#executeStatement<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>private&nbsp;def&nbsp;executeStatement():&nbsp;Unit&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;try&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;req&nbsp;=&nbsp;new&nbsp;TExecuteStatementReq(remoteSessionHandle,&nbsp;statement)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;req.setRunAsync(shouldRunAsync)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;resp&nbsp;=&nbsp;client.ExecuteStatement(req)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;verifyTStatus(resp.getStatus)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;_remoteOpHandle&nbsp;=&nbsp;resp.getOperationHandle<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}&nbsp;catch&nbsp;onError()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>这里 statement 实际上就是要执行的 SQL 语句，所以本质上就是向 SparkSQLEngine 发送了一个用于执行 SQL 语句的 RPC 请求，这样就会触发 SparkSQLEngine 执行提交 Statement 的一个过程（这个接下来会分析），请求成功后，KyuubiServer 会将 SparkSQLEngine 实例用于记录该操作的 operationHandle 记录下来，就是赋值给成员变量<code>_remoteOpHandle</code>，<code>_remoteOpHandle</code> 用后续用于查询 statement 在 SparkSQLEngine 实例中的执行状态和 FetchResults。</p><p>执行完 executeStatement () 方法后，我们再看一下其提交异步线程时所执行的操作，也就是 waitStatementComplete () 方法：</p><pre class="hljs xml">//&nbsp;org.apache.kyuubi.operation.ExecuteStatement#waitStatementComplete<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>//&nbsp;TODO&nbsp;主要是更新该Operation的State为FINISHED，这样后面取数据时才知道已经执行完成<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>private&nbsp;lazy&nbsp;val&nbsp;statusReq&nbsp;=&nbsp;new&nbsp;TGetOperationStatusReq(_remoteOpHandle)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>private&nbsp;def&nbsp;waitStatementComplete():&nbsp;Unit&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;setState(OperationState.RUNNING)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;因为FetchResults有进行检查，assertState(OperationState.FINISHED)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;var&nbsp;statusResp&nbsp;=&nbsp;client.GetOperationStatus(statusReq)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;var&nbsp;isComplete&nbsp;=&nbsp;false<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;while&nbsp;(!isComplete)&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;getQueryLog()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;verifyTStatus(statusResp.getStatus)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;remoteState&nbsp;=&nbsp;statusResp.getOperationState<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;info(s"Query[$statementId]&nbsp;in&nbsp;${remoteState.name()}")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;isComplete&nbsp;=&nbsp;true<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;remoteState&nbsp;match&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;INITIALIZED_STATE&nbsp;|&nbsp;PENDING_STATE&nbsp;|&nbsp;RUNNING_STATE&nbsp;=&gt;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isComplete&nbsp;=&nbsp;false<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;statusResp&nbsp;=&nbsp;client.GetOperationStatus(statusReq)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;FINISHED_STATE&nbsp;=&gt;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setState(OperationState.FINISHED)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;省略其它代码<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setOperationException(ke)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;//&nbsp;see&nbsp;if&nbsp;anymore&nbsp;log&nbsp;could&nbsp;be&nbsp;fetched<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;getQueryLog()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>可以看到其主要操作是构建用于查询 SparkSQLEngine 实例中 Operation 的执行状态。</p><p>再回过来看一下 <code>runInternal()</code> 方法：</p><pre class="hljs xml">//&nbsp;org.apache.kyuubi.operation.ExecuteStatement#runInternal<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>override&nbsp;protected&nbsp;def&nbsp;runInternal():&nbsp;Unit&nbsp;=&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;if&nbsp;(shouldRunAsync)&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;executeStatement()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;sessionManager&nbsp;=&nbsp;session.sessionManager<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;asyncOperation&nbsp;=&nbsp;new&nbsp;Runnable&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;override&nbsp;def&nbsp;run():&nbsp;Unit&nbsp;=&nbsp;waitStatementComplete()<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;backgroundOperation&nbsp;=<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sessionManager.submitBackgroundOperation(asyncOperation)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setBackgroundHandle(backgroundOperation)<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;onError("submitting&nbsp;query&nbsp;in&nbsp;background,&nbsp;query&nbsp;rejected")<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}&nbsp;else&nbsp;{<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;省略其它代码<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>&nbsp;&nbsp;}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span>}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"</span>&gt;</span></pre><p>这里提交一个线程后的返回结果 backgroundOperation 实际上为一个 FutureTask 对象，后续在 FetchResults 过程中通过该对象就可以知道 Operation 在 SparkSQLEngine 实例中的执行状态。</p><p>在提交完 Statement 之后，KyuubiServer 会将 operationHandle 返回给用户端，用于后续获取执行结果。</p><ul><li><p><strong>2.FetchResults</strong></p></li></ul><p>提交完 Statement 后，用户层的 RPC 客户端就会去获取结果，此时 KyuubiServer 中 FrontedService 的 <code>FetchResults</code> 方法就会被执行：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.service.FrontendService#FetchResults&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">FetchResults(req:</span>&nbsp;<span class="hljs-string">TFetchResultsReq):</span>&nbsp;<span class="hljs-string">TFetchResultsResp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">debug(req.toString)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">resp</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">TFetchResultsResp&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">operationHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">OperationHandle(req.getOperationHandle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">orientation</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">FetchOrientation.getFetchOrientation(req.getOrientation)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">//</span>&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-string">means</span>&nbsp;<span class="hljs-string">fetching</span>&nbsp;<span class="hljs-string">log&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">fetchLog</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">req.getFetchType</span>&nbsp;<span class="hljs-string">==</span>&nbsp;<span class="hljs-number">1</span><span class="hljs-string">&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">maxRows</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">req.getMaxRows.toInt&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">rowSet</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">be.fetchResults(operationHandle,</span>&nbsp;<span class="hljs-string">orientation,</span>&nbsp;<span class="hljs-string">maxRows,</span>&nbsp;<span class="hljs-string">fetchLog)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setResults(rowSet)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setHasMoreRows(false)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setStatus(OK_STATUS)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">e:</span>&nbsp;<span class="hljs-string">Exception</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">warn("Error</span>&nbsp;<span class="hljs-string">fetching</span>&nbsp;<span class="hljs-attr">results:</span>&nbsp;<span class="hljs-string">",&nbsp;e)&lt;br style="</span><span class="hljs-attr">margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">resp.setStatus(KyuubiSQLException.toTStatus(e))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">resp&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>在获取真正执行结果之前，会有多次获取操作日志的请求，也就是 <code>req.getFetchType == 1</code> 的情况，这里我们只关注 <code>fetchLog</code> 为 false 的情况：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPYrZgAuw5ORryVKTJnAN4icYTPYvicSsQOaMenbTVvjnaZqeuycHmC8sQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></p><section><p>获取执行结果的过程就比较简单，主要是调用 RPC 客户端的 FetchResults 方法，这样就会触发 SparkSQLEngine FetchResults 的一个过程（这个接下来会分析），不过在获取执行结果前会检查其执行状态，前面在分析在提交 Statement 时，异步线程 waitStatementComplete () 就会请求 SparkSQLEngine 更新其状态为 FINISHED，因此这里可以正常获取执行结果。</p><p><strong>SparkSQLEngine SQL 执行流程</strong></p><ul><li><p><strong>1. 提交 Statement</strong></p></li></ul><p>接收到 KyuubiServer 提交 Statement 的 RPC 请求时，此时 SparkSQLEngine 中 FrontedService 的 <code>ExecuteStatement</code> 方法就会被执行，进而触发接下来提交 Statement 的整个流程：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhP6kRTrtB8GCa3YCXV75G76LdMOKvAeVwiafZYpL1oCmoxuVra8gGlJvw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" style="width: auto;"></div></p><section><p>其整体流程与 KyuubiServer 是十分相似的，主要区别在于：</p><p>1. 其创建的 Statement 为 SparkSQLEngine 体系下的 ExecuteStatement；</p><p>2. 其异步线程是通过 SparkSession 来执行 SQL 语句；</p><p>因此我们来看一下其 <code>runInternal()</code> 方法和异步线程执行的 <code>executeStatement()</code> 方法：</p><pre class="hljs yaml"><span class="hljs-string">//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.engine.spark.operation.ExecuteStatement#runInternal&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;override</span>&nbsp;<span class="hljs-string">protected</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">runInternal():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">if</span>&nbsp;<span class="hljs-string">(shouldRunAsync)</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">asyncOperation</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">Runnable</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">override</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">run():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">OperationLog.setCurrentOperationLog(operationLog)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">executeStatement()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">sparkSQLSessionManager</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">session.sessionManager&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">backgroundHandle</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">sparkSQLSessionManager.submitBackgroundOperation(asyncOperation)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">setBackgroundHandle(backgroundHandle)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">case</span>&nbsp;<span class="hljs-attr">rejected:</span>&nbsp;<span class="hljs-string">RejectedExecutionException</span>&nbsp;<span class="hljs-string">=&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">setState(OperationState.ERROR)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">val</span>&nbsp;<span class="hljs-string">ke</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">KyuubiSQLException("Error</span>&nbsp;<span class="hljs-string">submitting</span>&nbsp;<span class="hljs-string">query</span>&nbsp;<span class="hljs-string">in</span>&nbsp;<span class="hljs-string">background,</span>&nbsp;<span class="hljs-string">query</span>&nbsp;<span class="hljs-string">rejected",&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">rejected)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">setOperationException(ke)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">throw</span>&nbsp;<span class="hljs-string">ke&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">else</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">executeStatement()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;//</span>&nbsp;<span class="hljs-string">org.apache.kyuubi.engine.spark.operation.ExecuteStatement#executeStatement&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;private</span>&nbsp;<span class="hljs-string">def</span>&nbsp;<span class="hljs-string">executeStatement():</span>&nbsp;<span class="hljs-string">Unit</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">try</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">setState(OperationState.RUNNING)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">info(KyuubiSparkUtil.diagnostics(spark))&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">Thread.currentThread().setContextClassLoader(spark.sharedState.jarClassLoader)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">spark.sparkContext.setJobGroup(statementId,</span>&nbsp;<span class="hljs-string">statement)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">result</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">spark.sql(statement)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">debug(result.queryExecution)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">iter</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-string">new</span>&nbsp;<span class="hljs-string">ArrayFetchIterator(result.collect())&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">setState(OperationState.FINISHED)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">catch</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">onError(cancel</span>&nbsp;<span class="hljs-string">=</span>&nbsp;<span class="hljs-literal">true</span><span class="hljs-string">)&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}</span>&nbsp;<span class="hljs-string">finally</span>&nbsp;<span class="hljs-string">{&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">spark.sparkContext.clearJobGroup()&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span>&nbsp;&nbsp;<span class="hljs-string">}&lt;br</span> <span class="hljs-string">style="margin:</span> <span class="hljs-number">0</span><span class="hljs-string">px;padding:</span> <span class="hljs-number">0</span><span class="hljs-string">px;outline:</span> <span class="hljs-number">0</span><span class="hljs-string">px;max-width:</span> <span class="hljs-number">100</span><span class="hljs-string">%;box-sizing:</span> <span class="hljs-string">border-box</span> <span class="hljs-type">!important</span><span class="hljs-string">;overflow-wrap:</span> <span class="hljs-string">break-word</span> <span class="hljs-type">!important</span><span class="hljs-string">;"&gt;</span></pre><p>可以看到其执行非常简单，就是直接调用 SparkSession 的 sql () 方法来执行 SQL 语句，最后再将结果保存到迭代器 iter，并设置执行状态为完成。</p><p>在提交完 Statement 之后，SparkSQLEngine 会将 operationHandle 返回给 KyuubiServer，用于后续获取执行结果。</p><ul><li><p><strong>2.FetchResults</strong></p></li></ul><p>接收到 KyuubiServer 获取结果的 RPC 请求时，此时 SparkSQLEngine 中 FrontedService 的 <code>FetchResults</code> 方法就会被执行，进而触发接下来 FetchResults 的整个流程：</p></section><p><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_jpg/zz4SicRwEWWl8rdZhFrhkzBMge15JjhhPdqLn9JHGHfM9bZkyXKnJibDLbCSRrribMlgjTDeLvasl22E5LdZPRMSA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></p><section><p>整个过程比较简单，就是将 iter 的结果转换为 rowSet 的对象格式，最后返回给 KyuubiServer。</p><h2 id="sr-toc-18"><span>参考资料</span></h2><ul><li><p><span>《Spark SQL 内核剖析》</span></p></li><li><p>《网易数帆开源 Kyuubi：基于 Spark 的高性能 JDBC 和 SQL 执行引擎》</p></li><li><p>《大数据实战：Kyuubi 与 Spark ThriftServer 的全面对比分析》</p></li><li><p>Apache Thrift</p></li><li><p>minidubbo：A Full RPC Framework Based on Netty.</p></li></ul></section><p><strong><span><strong><span><strong><span><strong><span><strong><span><strong><span><strong><span><strong><span><div class="sr-rd-content-center-small"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/u61OjQroUM3BiaHibiaiaBW6e9jzC4AqKSs5jVRD3mD9QeXmjkUxYLPVhUa8sxia6IA4T9xrAbRJnYVKod8ry5tEhmw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></span></strong></span></strong></span></strong></span></strong>&nbsp;END</span></strong></span></strong></span></strong></span></strong></p><p><span><div class="sr-rd-content-center"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/u61OjQroUM3BiaHibiaiaBW6e9jzC4AqKSs55vFuAcPUvoGzZXbY3MndqaWGSjpu8T3vCNq9zicqsrn3Irbu2KxKGibg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></span></p><section data-role="splitline" data-tools="135编辑器" data-id="110353" data-color="#eb2e28"><section><section><section data-width="100%"><section><section data-width="45%"><br></section></section><section><section data-width="35%"><br></section><section><br></section></section></section><section><div class="sr-rd-content-center-small"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/u61OjQroUM3l7H342uRuuZibEWKCCSpCg9A8DPWrvrjQgGciboAYibMlgxYSEUjPWZicS2mhicpQIpKQvB56Vmzz5Sw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></section><section data-width="100%"><section hm_fix="338:327" data-width="40%"><br></section><section><section><br></section><section data-width="35%"><br></section></section></section></section></section></section><p><span><span><strong>Apache Kyuubi&nbsp;</strong></span><span><strong>推特账号&nbsp;</strong></span><span><strong>现已开通</strong></span></span></p><p><span><span><strong>推特搜索</strong></span><span><strong>&nbsp;Apache Kyuubi</strong></span><span><strong>&nbsp;或 浏览器&nbsp;</strong></span><span><strong>打开下方链接&nbsp;</strong></span></span><strong>即可关注～</strong></p><p><strong><span><a target="_blank" rel="noopener noreferrer" href="https://twitter.com/KyuubiApache" one-link-mark="yes">https://twitter.com/KyuubiApache</a></span></strong></p><p><span><strong>还可以加入</strong></span><span><strong><span>&nbsp;Apache Kyuubi Slack</span></strong></span></p><p><span><strong><a target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/apachekyuubi/shared_invite/zt-1e1qw68g4-yE5HJsVVDin~ABtZISyuxg" one-link-mark="yes">https://join.slack.com/t/apachekyuubi/shared_invite/zt-1e1qw68g4-yE5HJsVVDin~ABtZISyuxg</a></strong><br></span></p><p><span><strong>和海外开发者交流互动哦～</strong></span></p><p><span><strong>最后<br></strong></span></p><p><span><strong>Kyuubi 在这里提醒大家</strong></span></p><p><span><strong>文明上网 科学上网</strong></span></p><section data-id="99661" data-tools="135编辑器" draggable="true"><section><section><section data-brushtype="text"><strong>往期精彩:</strong></section><section data-width="100%"><br></section></section><section><section><br></section><section><br></section><section><br></section></section><section><section><section><br></section><section data-autoskip="1"><p hm_fix="266:396"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MDA5MTU4OA==&amp;mid=2247492200&amp;idx=1&amp;sn=c60b3c63719c949f79af02aad7a7b44c&amp;chksm=ce2907c3f95e8ed506c085ed2b7a657805a7931652cf2607daf72005f90777107ebe430a9492&amp;scene=21#wechat_redirect" textvalue="Apache Kyuubi 官网更新，这个地方需要你的支持" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" one-link-mark="yes">Apache Kyuubi 官网更新，这个地方需要你的支持</a><br></p></section></section><section><section><br></section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MDA5MTU4OA==&amp;mid=2247492364&amp;idx=1&amp;sn=84a4b95d4f6a6d382e5228c79cdda1bc&amp;chksm=ce2906a7f95e8fb1c022023f4f8b65c3beecbc156543e9a443fd8173f7d05015cb16b5677213&amp;scene=21#wechat_redirect" textvalue="社区的用户老铁们！Apache Kyuubi 叫你来领周边！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" one-link-mark="yes">社区的用户老铁们！Apache Kyuubi 叫你来领周边！</a><br></p></section></section><section><section><br></section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MDA5MTU4OA==&amp;mid=2247492371&amp;idx=1&amp;sn=c7907cb9a948077cce8e82d06f5ea785&amp;chksm=ce2906b8f95e8faee527b9b6b4a2fcebac1788fa7108dd3d94c3d8b4c887ca499e4ee615d465&amp;scene=21#wechat_redirect" textvalue="Apache Kyuubi 及在移动云湖仓一体中的实践" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2" one-link-mark="yes">Apache Kyuubi 及在移动云湖仓一体中的实践</a><br></p></section></section><section><section><br></section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MDA5MTU4OA==&amp;mid=2247492325&amp;idx=1&amp;sn=0456c6db99c91de6d614338a5805d25a&amp;chksm=ce29074ef95e8e5868ba2afcccb0f3d915f6fa8aff4a9c72529acb51f5368c1c12284aa8c014&amp;scene=21#wechat_redirect" textvalue="基于 Kyuubi + Spark + Iceberg 构建云原生数据湖 (HiveCatalog)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2" one-link-mark="yes">基于 Kyuubi + Spark + Iceberg 构建云原生数据湖 (HiveCatalog)</a><br></p></section></section><section><section><br></section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzg2MDA5MTU4OA==&amp;mid=2247487924&amp;idx=1&amp;sn=40e868e4deabd789a03ef4d0196f7ce9&amp;chksm=ce2af41ff95d7d096b086eb4949a2fe543356b727da817355e58ca48347c74be12fa03cfc225&amp;scene=21#wechat_redirect" textvalue="Become A Committer of Apache Kyuubi" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" one-link-mark="yes">Become A Committer of Apache Kyuubi</a></p></section></section></section></section></section><section data-role="outer" label="edit by 135editor"><section data-id="101122" data-tools="135编辑器"><section><section><section><section><section><section><div class="sr-rd-content-center-small"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/u61OjQroUM3BiaHibiaiaBW6e9jzC4AqKSs5jVRD3mD9QeXmjkUxYLPVhUa8sxia6IA4T9xrAbRJnYVKod8ry5tEhmw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div><section data-brushtype="text"> 看到这里记得多多点赞、评论、收藏</section></section></section></section></section><section><section><section><section><section data-brushtype="text">还可以把 Kyuubi 分享给更多朋友～</section><section><br></section></section></section></section><section><div class="sr-rd-content-center-small"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/u61OjQroUM3BiaHibiaiaBW6e9jzC4AqKSs553vwtFEutvcbVVDocT6pdzbDMcAMOftG9gXIAE6c47KNsRXUEWsmBQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></div></section></section></section></section></section></section></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1"><outline class="toc-level-h2" data-reactid=".1.0" style="width: 165px;"><active data-reactid=".1.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1.0.1" one-link-mark="yes"><span data-reactid=".1.0.1.0">1 概述</span></a></outline><outline class="toc-level-h2" data-reactid=".1.1" style="width: 165px;"><active data-reactid=".1.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1.1.1" one-link-mark="yes"><span data-reactid=".1.1.1.0">2&nbsp; Spark ThriftServer 的设计、实现与不足</span></a></outline><outline class="toc-level-h3" data-reactid=".1.2" style="width: 155px;"><active data-reactid=".1.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1.2.1" one-link-mark="yes"><span data-reactid=".1.2.1.0">2.1 产生背景</span></a></outline><outline class="toc-level-h3" data-reactid=".1.3" style="width: 155px;"><active data-reactid=".1.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1.3.1" one-link-mark="yes"><span data-reactid=".1.3.1.0">2.2 核心设计</span></a></outline><outline class="toc-level-h3" data-reactid=".1.4" style="width: 155px;"><active data-reactid=".1.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1.4.1" one-link-mark="yes"><span data-reactid=".1.4.1.0">2.3 基本实现</span></a></outline><outline class="toc-level-h3" data-reactid=".1.5" style="width: 155px;"><active data-reactid=".1.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1.5.1" one-link-mark="yes"><span data-reactid=".1.5.1.0">2.4 主要不足</span></a></outline><outline class="toc-level-h2" data-reactid=".1.6" style="width: 165px;"><active data-reactid=".1.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1.6.1" one-link-mark="yes"><span data-reactid=".1.6.1.0">3 Kyuubi 核心架构设计与源码实现剖析</span></a></outline><outline class="toc-level-h3" data-reactid=".1.7" style="width: 155px;"><active data-reactid=".1.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1.7.1" one-link-mark="yes"><span data-reactid=".1.7.1.0">3.1 Kyuubi 核心架构设计</span></a></outline><outline class="toc-level-h4" data-reactid=".1.8" style="width: 145px;"><active data-reactid=".1.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1.8.1" one-link-mark="yes"><span data-reactid=".1.8.1.0">3.1.1 用户层</span></a></outline><outline class="toc-level-h4" data-reactid=".1.9" style="width: 145px;"><active data-reactid=".1.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1.9.1" one-link-mark="yes"><span data-reactid=".1.9.1.0">3.1.2 服务发现层</span></a></outline><outline class="toc-level-h4" data-reactid=".1.a" style="width: 145px;"><active data-reactid=".1.a.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1.a.1" one-link-mark="yes"><span data-reactid=".1.a.1.0">3.1.4 Kyuubi Engine 层</span></a></outline><outline class="toc-level-h4" data-reactid=".1.b" style="width: 145px;"><active data-reactid=".1.b.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1.b.1" one-link-mark="yes"><span data-reactid=".1.b.1.0">3.1.5 整体协作流程</span></a></outline><outline class="toc-level-h3" data-reactid=".1.c" style="width: 155px;"><active data-reactid=".1.c.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".1.c.1" one-link-mark="yes"><span data-reactid=".1.c.1.0">3.2 Kyuubi 源码实现剖析</span></a></outline><outline class="toc-level-h4" data-reactid=".1.d" style="width: 145px;"><active data-reactid=".1.d.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".1.d.1" one-link-mark="yes"><span data-reactid=".1.d.1.0">3.2.1 RPC 与 Apache Thrift 基本概述</span></a></outline><outline class="toc-level-h4" data-reactid=".1.e" style="width: 145px;"><active data-reactid=".1.e.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".1.e.1" one-link-mark="yes"><span data-reactid=".1.e.1.0">3.2.2 Kyuubi Service 体系与组合关系</span></a></outline><outline class="toc-level-h4" data-reactid=".1.f" style="width: 145px;"><active data-reactid=".1.f.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".1.f.1" one-link-mark="yes"><span data-reactid=".1.f.1.0">3.2.3 Kyuubi&nbsp;启动流程</span></a></outline><outline class="toc-level-h4" data-reactid=".1.g" style="width: 145px;"><active data-reactid=".1.g.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".1.g.1" one-link-mark="yes"><span data-reactid=".1.g.1.0">3.2.4 Kyuubi Session 建立过程</span></a></outline><outline class="toc-level-h4" data-reactid=".1.h" style="width: 145px;"><active data-reactid=".1.h.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-17" data-reactid=".1.h.1" one-link-mark="yes"><span data-reactid=".1.h.1.0">3.2.5 Kyuubi SQL 执行流程</span></a></outline><outline class="toc-level-h2" data-reactid=".1.i" style="width: 165px;"><active data-reactid=".1.i.0"></active><a class="toc-outline-theme-github" href="#sr-toc-18" data-reactid=".1.i.1" one-link-mark="yes"><span data-reactid=".1.i.1.0">参考资料</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://mp.weixin.qq.com/s/YfipUhAoyc4idpsP2gQmtQ" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>