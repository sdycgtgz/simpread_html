
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 32 | GroupCoordinator：在 Rebalance 中，Coordinator 如何处理成员入组？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>32 | GroupCoordinator：在 Rebalance 中，Coordinator 如何处理成员入组？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">学完了今天的课程之后，你不但能够说出 4 种 Leader 选举的场景，还能总结出它们的共性。对于面试来说，绝对是个加分项！</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">32 | GroupCoordinator：在 Rebalance 中，Coordinator 如何处理成员入组？</h1><div><span>胡夕</span> <span> 2020-07-11</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/16/ac/163cdc635d99190da2c9813b6cd81dac.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：21.47M</span><span> 时长：23:27</span></div></div><audio title="32 | GroupCoordinator：在Rebalance中，Coordinator如何处理成员入组？" src="https://res001.geekbang.org/media/audio/7c/93/7cefc2ca03365f3469717e23350e7693/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="13835" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="13836"><span data-slate-object="text" data-key="13837"><span data-slate-leaf="true" data-offset-key="13837:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。不知不觉间，课程已经接近尾声了，最后这两节课，我们来学习一下消费者组的 Rebalance 流程是如何完成的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13838"><span data-slate-object="text" data-key="13839"><span data-slate-leaf="true" data-offset-key="13839:0" data-first-offset="true"><span data-slate-string="true">提到 Rebalance，你的第一反应一定是 “爱恨交加”。毕竟，如果使用得当，它能够自动帮我们实现消费者之间的负载均衡和故障转移；但如果配置失当，我们就可能触碰到它被诟病已久的缺陷：耗时长，而且会出现消费中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13840"><span data-slate-object="text" data-key="13841"><span data-slate-leaf="true" data-offset-key="13841:0" data-first-offset="true"><span data-slate-string="true">在使用消费者组的实践中，你肯定想知道，应该如何避免 Rebalance。如果你不了解 Rebalance 的源码机制的话，就很容易掉进它无意中铺设的 “陷阱” 里。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13842"><span data-slate-object="text" data-key="13843"><span data-slate-leaf="true" data-offset-key="13843:0" data-first-offset="true"><span data-slate-string="true">举个小例子。有些人认为，Consumer 端参数 session.timeout.ms 决定了完成一次 Rebalance 流程的最大时间。这种认知是不对的，实际上，这个参数是用于检测消费者组成员存活性的，即如果在这段超时时间内，没有收到该成员发给 Coordinator 的心跳请求，则把该成员标记为 Dead，而且要显式地将其从消费者组中移除，并触发新一轮的 Rebalance。而真正决定单次 Rebalance 所用最大时长的参数，是 Consumer 端的 </span></span></span><span data-slate-object="text" data-key="13844"><span data-slate-leaf="true" data-offset-key="13844:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">max.poll.interval.ms</span></span></span></span><span data-slate-object="text" data-key="13845"><span data-slate-leaf="true" data-offset-key="13845:0" data-first-offset="true"><span data-slate-string="true">。显然，如果没有搞懂这部分的源码，你就没办法为这些参数设置合理的数值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13846"><span data-slate-object="text" data-key="13847"><span data-slate-leaf="true" data-offset-key="13847:0" data-first-offset="true"><span data-slate-string="true">总体而言， Rebalance 的流程大致分为两大步：加入组（JoinGroup）和组同步（SyncGroup）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13848"><span data-slate-object="text" data-key="13849"><span data-slate-leaf="true" data-offset-key="13849:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">加入组，是指消费者组下的各个成员向 Coordinator 发送 JoinGroupRequest 请求加入进组的过程</span></span></span></span><span data-slate-object="text" data-key="13850"><span data-slate-leaf="true" data-offset-key="13850:0" data-first-offset="true"><span data-slate-string="true">。这个过程有一个超时时间，如果有成员在超时时间之内，无法完成加入组操作，它就会被排除在这轮 Rebalance 之外。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13851"><span data-slate-object="text" data-key="13852"><span data-slate-leaf="true" data-offset-key="13852:0" data-first-offset="true"><span data-slate-string="true">组同步，是指当所有成员都成功加入组之后，Coordinator 指定其中一个成员为 Leader，然后将订阅分区信息发给 Leader 成员。接着，所有成员（包括 Leader 成员）向 Coordinator 发送 SyncGroupRequest 请求。需要注意的是，</span></span></span><span data-slate-object="text" data-key="13853"><span data-slate-leaf="true" data-offset-key="13853:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">只有 Leader 成员发送的请求中包含了订阅分区消费分配方案，在其他成员发送的请求中，这部分的内容为空</span></span></span></span><span data-slate-object="text" data-key="13854"><span data-slate-leaf="true" data-offset-key="13854:0" data-first-offset="true"><span data-slate-string="true">。当 Coordinator 接收到分配方案后，会通过向成员发送响应的方式，通知各个成员要消费哪些分区。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13855"><span data-slate-object="text" data-key="13856"><span data-slate-leaf="true" data-offset-key="13856:0" data-first-offset="true"><span data-slate-string="true">当组同步完成后，Rebalance 宣告结束。此时，消费者组处于正常工作状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13857"><span data-slate-object="text" data-key="13858"><span data-slate-leaf="true" data-offset-key="13858:0" data-first-offset="true"><span data-slate-string="true">今天，我们就学习下第一大步，也就是加入组的源码实现，它们位于 GroupCoordinator.scala 文件中。下节课，我们再深入地学习组同步的源码实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13859"><span data-slate-object="text" data-key="13860"><span data-slate-leaf="true" data-offset-key="13860:0" data-first-offset="true"><span data-slate-string="true">要搞懂加入组的源码机制，我们必须要学习 4 个方法，分别是 handleJoinGroup、doUnknownJoinGroup、doJoinGroup 和 addMemberAndRebalance。handleJoinGroup 是执行加入组的顶层方法，被 KafkaApis 类调用，该方法依据给定消费者组成员是否了设置成员 ID，来决定是调用 doUnknownJoinGroup 还是 doJoinGroup，前者对应于未设定成员 ID 的情形，后者对应于已设定成员 ID 的情形。而这两个方法，都会调用 addMemberAndRebalance，执行真正的加入组逻辑。为了帮助你理解它们之间的交互关系，我画了一张图，借用它展示了这 4 个方法的调用顺序。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13861"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/b7/20/b7ed79cbf4eba29b39f32015b527c220.jpg?wh=2256*2084"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13862" id="sr-toc-1"><span data-slate-object="text" data-key="13863"><span data-slate-leaf="true" data-offset-key="13863:0" data-first-offset="true"><span data-slate-string="true">handleJoinGroup 方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13864"><span data-slate-object="text" data-key="13865"><span data-slate-leaf="true" data-offset-key="13865:0" data-first-offset="true"><span data-slate-string="true">如果你翻开 KafkaApis.scala 这个 API 入口文件，就可以看到，处理 JoinGroupRequest 请求的方法是 handleJoinGroupRequest。而它的主要逻辑，就是</span></span></span><span data-slate-object="text" data-key="13866"><span data-slate-leaf="true" data-offset-key="13866:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">调用 GroupCoordinator 的 handleJoinGroup 方法，来处理消费者组成员发送过来的加入组请求，所以，我们要具体学习一下 handleJoinGroup 方法</span></span></span></span><span data-slate-object="text" data-key="13867"><span data-slate-leaf="true" data-offset-key="13867:0" data-first-offset="true"><span data-slate-string="true">。先看它的方法签名：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13868"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13869"><span data-slate-object="text" data-key="13870"><span data-slate-leaf="true" data-offset-key="13870:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="13871"><span data-slate-leaf="true" data-offset-key="13871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleJoinGroup</span></span></span></span><span data-slate-object="text" data-key="13872"><span data-slate-leaf="true" data-offset-key="13872:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13873"><span data-slate-object="text" data-key="13874"><span data-slate-leaf="true" data-offset-key="13874:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13875"><span data-slate-leaf="true" data-offset-key="13875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">groupId</span></span></span></span><span data-slate-object="text" data-key="13876"><span data-slate-leaf="true" data-offset-key="13876:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13877"><span data-slate-leaf="true" data-offset-key="13877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13878"><span data-slate-leaf="true" data-offset-key="13878:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13879"><span data-slate-leaf="true" data-offset-key="13879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 消费者组名</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13880"><span data-slate-object="text" data-key="13881"><span data-slate-leaf="true" data-offset-key="13881:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13882"><span data-slate-leaf="true" data-offset-key="13882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">memberId</span></span></span></span><span data-slate-object="text" data-key="13883"><span data-slate-leaf="true" data-offset-key="13883:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13884"><span data-slate-leaf="true" data-offset-key="13884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13885"><span data-slate-leaf="true" data-offset-key="13885:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13886"><span data-slate-leaf="true" data-offset-key="13886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 消费者组成员 ID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13887"><span data-slate-object="text" data-key="13888"><span data-slate-leaf="true" data-offset-key="13888:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13889"><span data-slate-leaf="true" data-offset-key="13889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">groupInstanceId</span></span></span></span><span data-slate-object="text" data-key="13890"><span data-slate-leaf="true" data-offset-key="13890:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13891"><span data-slate-leaf="true" data-offset-key="13891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Option</span></span></span></span><span data-slate-object="text" data-key="13892"><span data-slate-leaf="true" data-offset-key="13892:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13893"><span data-slate-leaf="true" data-offset-key="13893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13894"><span data-slate-leaf="true" data-offset-key="13894:0" data-first-offset="true"><span data-slate-string="true">], </span></span></span><span data-slate-object="text" data-key="13895"><span data-slate-leaf="true" data-offset-key="13895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 组实例 ID，用于标识静态成员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13896"><span data-slate-object="text" data-key="13897"><span data-slate-leaf="true" data-offset-key="13897:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13898"><span data-slate-leaf="true" data-offset-key="13898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requireKnownMemberId</span></span></span></span><span data-slate-object="text" data-key="13899"><span data-slate-leaf="true" data-offset-key="13899:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13900"><span data-slate-leaf="true" data-offset-key="13900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Boolean</span></span></span></span><span data-slate-object="text" data-key="13901"><span data-slate-leaf="true" data-offset-key="13901:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13902"><span data-slate-leaf="true" data-offset-key="13902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否需要成员 ID 不为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13903"><span data-slate-object="text" data-key="13904"><span data-slate-leaf="true" data-offset-key="13904:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13905"><span data-slate-leaf="true" data-offset-key="13905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clientId</span></span></span></span><span data-slate-object="text" data-key="13906"><span data-slate-leaf="true" data-offset-key="13906:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13907"><span data-slate-leaf="true" data-offset-key="13907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13908"><span data-slate-leaf="true" data-offset-key="13908:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13909"><span data-slate-leaf="true" data-offset-key="13909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//client.id 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13910"><span data-slate-object="text" data-key="13911"><span data-slate-leaf="true" data-offset-key="13911:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13912"><span data-slate-leaf="true" data-offset-key="13912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">clientHost</span></span></span></span><span data-slate-object="text" data-key="13913"><span data-slate-leaf="true" data-offset-key="13913:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13914"><span data-slate-leaf="true" data-offset-key="13914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13915"><span data-slate-leaf="true" data-offset-key="13915:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13916"><span data-slate-leaf="true" data-offset-key="13916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 消费者程序主机名</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13917"><span data-slate-object="text" data-key="13918"><span data-slate-leaf="true" data-offset-key="13918:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13919"><span data-slate-leaf="true" data-offset-key="13919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rebalanceTimeoutMs</span></span></span></span><span data-slate-object="text" data-key="13920"><span data-slate-leaf="true" data-offset-key="13920:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13921"><span data-slate-leaf="true" data-offset-key="13921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="13922"><span data-slate-leaf="true" data-offset-key="13922:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13923"><span data-slate-leaf="true" data-offset-key="13923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Rebalance 超时时间，默认是 max.poll.interval.ms 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13924"><span data-slate-object="text" data-key="13925"><span data-slate-leaf="true" data-offset-key="13925:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13926"><span data-slate-leaf="true" data-offset-key="13926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sessionTimeoutMs</span></span></span></span><span data-slate-object="text" data-key="13927"><span data-slate-leaf="true" data-offset-key="13927:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13928"><span data-slate-leaf="true" data-offset-key="13928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="13929"><span data-slate-leaf="true" data-offset-key="13929:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13930"><span data-slate-leaf="true" data-offset-key="13930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 会话超时时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13931"><span data-slate-object="text" data-key="13932"><span data-slate-leaf="true" data-offset-key="13932:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13933"><span data-slate-leaf="true" data-offset-key="13933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protocolType</span></span></span></span><span data-slate-object="text" data-key="13934"><span data-slate-leaf="true" data-offset-key="13934:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13935"><span data-slate-leaf="true" data-offset-key="13935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13936"><span data-slate-leaf="true" data-offset-key="13936:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13937"><span data-slate-leaf="true" data-offset-key="13937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 协议类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13938"><span data-slate-object="text" data-key="13939"><span data-slate-leaf="true" data-offset-key="13939:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13940"><span data-slate-leaf="true" data-offset-key="13940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protocols</span></span></span></span><span data-slate-object="text" data-key="13941"><span data-slate-leaf="true" data-offset-key="13941:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13942"><span data-slate-leaf="true" data-offset-key="13942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="13943"><span data-slate-leaf="true" data-offset-key="13943:0" data-first-offset="true"><span data-slate-string="true">[(</span></span></span><span data-slate-object="text" data-key="13944"><span data-slate-leaf="true" data-offset-key="13944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13945"><span data-slate-leaf="true" data-offset-key="13945:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13946"><span data-slate-leaf="true" data-offset-key="13946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Array</span></span></span></span><span data-slate-object="text" data-key="13947"><span data-slate-leaf="true" data-offset-key="13947:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13948"><span data-slate-leaf="true" data-offset-key="13948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Byte</span></span></span></span><span data-slate-object="text" data-key="13949"><span data-slate-leaf="true" data-offset-key="13949:0" data-first-offset="true"><span data-slate-string="true">])], </span></span></span><span data-slate-object="text" data-key="13950"><span data-slate-leaf="true" data-offset-key="13950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 按照分配策略分组的订阅分区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13951"><span data-slate-object="text" data-key="13952"><span data-slate-leaf="true" data-offset-key="13952:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13953"><span data-slate-leaf="true" data-offset-key="13953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">responseCallback</span></span></span></span><span data-slate-object="text" data-key="13954"><span data-slate-leaf="true" data-offset-key="13954:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13955"><span data-slate-leaf="true" data-offset-key="13955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">JoinCallback</span></span></span></span><span data-slate-object="text" data-key="13956"><span data-slate-leaf="true" data-offset-key="13956:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13957"><span data-slate-leaf="true" data-offset-key="13957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 回调函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13958"><span data-slate-object="text" data-key="13959"><span data-slate-leaf="true" data-offset-key="13959:0" data-first-offset="true"><span data-slate-string="true">  ): </span></span></span><span data-slate-object="text" data-key="13960"><span data-slate-leaf="true" data-offset-key="13960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unit</span></span></span></span><span data-slate-object="text" data-key="13961"><span data-slate-leaf="true" data-offset-key="13961:0" data-first-offset="true"><span data-slate-string="true"> = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13962"><span data-slate-object="text" data-key="13963"><span data-slate-leaf="true" data-offset-key="13963:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13964"><span data-slate-object="text" data-key="13965"><span data-slate-leaf="true" data-offset-key="13965:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13966"><span data-slate-object="text" data-key="13967"><span data-slate-leaf="true" data-offset-key="13967:0" data-first-offset="true"><span data-slate-string="true">这个方法的参数有很多，我介绍几个比较关键的。接下来在阅读其他方法的源码时，你还会看到这些参数，所以，这里你一定要提前掌握它们的含义。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13968"><div data-slate-type="list-line" data-slate-object="block" data-key="13969"><span data-slate-object="text" data-key="13970"><span data-slate-leaf="true" data-offset-key="13970:0" data-first-offset="true"><span data-slate-string="true">groupId：消费者组名。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13971"><span data-slate-object="text" data-key="13972"><span data-slate-leaf="true" data-offset-key="13972:0" data-first-offset="true"><span data-slate-string="true">memberId：消费者组成员 ID。如果成员是新加入的，那么该字段是空字符串。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13973"><span data-slate-object="text" data-key="13974"><span data-slate-leaf="true" data-offset-key="13974:0" data-first-offset="true"><span data-slate-string="true">groupInstanceId：这是社区于 2.4 版本引入的静态成员字段。静态成员的引入，可以有效避免因系统升级或程序更新而导致的 Rebalance 场景。它属于比较高阶的用法，而且目前还没有被大规模使用，因此，这里你只需要简单了解一下它的作用。另外，后面在讲其他方法时，我会直接省略静态成员的代码，我们只关注核心逻辑就行了。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13975"><span data-slate-object="text" data-key="13976"><span data-slate-leaf="true" data-offset-key="13976:0" data-first-offset="true"><span data-slate-string="true">requireKnownMemberId：是否要求成员 ID 不为空，即是否要求成员必须设置 ID 的布尔字段。这个字段如果为 True 的话，那么，Kafka 要求消费者组成员必须设置 ID。未设置 ID 的成员，会被拒绝加入组。直到它设置了 ID 之后，才能重新加入组。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13977"><span data-slate-object="text" data-key="13978"><span data-slate-leaf="true" data-offset-key="13978:0" data-first-offset="true"><span data-slate-string="true">clientId：消费者端参数 client.id 值。Coordinator 使用它来生成 memberId。memberId 的格式是 clientId 值 -UUID。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13979"><span data-slate-object="text" data-key="13980"><span data-slate-leaf="true" data-offset-key="13980:0" data-first-offset="true"><span data-slate-string="true">clientHost：消费者程序的主机名。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13981"><span data-slate-object="text" data-key="13982"><span data-slate-leaf="true" data-offset-key="13982:0" data-first-offset="true"><span data-slate-string="true">rebalanceTimeoutMs：Rebalance 超时时间。如果在这个时间段内，消费者组成员没有完成加入组的操作，就会被禁止入组。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13983"><span data-slate-object="text" data-key="13984"><span data-slate-leaf="true" data-offset-key="13984:0" data-first-offset="true"><span data-slate-string="true">sessionTimeoutMs：会话超时时间。如果消费者组成员无法在这段时间内向 Coordinator 汇报心跳，那么将被视为 “已过期”，从而引发新一轮 Rebalance。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13985"><span data-slate-object="text" data-key="13986"><span data-slate-leaf="true" data-offset-key="13986:0" data-first-offset="true"><span data-slate-string="true">responseCallback：完成加入组之后的回调逻辑方法。当消费者组成员成功加入组之后，需要执行该方法。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13987"><span data-slate-object="text" data-key="13988"><span data-slate-leaf="true" data-offset-key="13988:0" data-first-offset="true"><span data-slate-string="true">说完了方法签名，我们看下它的主体代码：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="13989"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13990"><span data-slate-object="text" data-key="13991"><span data-slate-leaf="true" data-offset-key="13991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 验证消费者组状态的合法性</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13992"><span data-slate-object="text" data-key="13993"><span data-slate-leaf="true" data-offset-key="13993:0" data-first-offset="true"><span data-slate-string="true">validateGroupStatus(groupId, ApiKeys.JOIN_GROUP).foreach { error =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13994"><span data-slate-object="text" data-key="13995"><span data-slate-leaf="true" data-offset-key="13995:0" data-first-offset="true"><span data-slate-string="true">  responseCallback(JoinGroupResult(memberId, error))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13996"><span data-slate-object="text" data-key="13997"><span data-slate-leaf="true" data-offset-key="13997:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13998"><span data-slate-leaf="true" data-offset-key="13998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13999"><span data-slate-object="text" data-key="14000"><span data-slate-leaf="true" data-offset-key="14000:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14001"><span data-slate-object="text" data-key="14002"><span data-slate-leaf="true" data-offset-key="14002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确保 sessionTimeoutMs 介于</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14003"><span data-slate-object="text" data-key="14004"><span data-slate-leaf="true" data-offset-key="14004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// [group.min.session.timeout.ms 值，group.max.session.timeout.ms 值] 之间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14005"><span data-slate-object="text" data-key="14006"><span data-slate-leaf="true" data-offset-key="14006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则抛出异常，表示超时时间设置无效</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14007"><span data-slate-object="text" data-key="14008"><span data-slate-leaf="true" data-offset-key="14008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14009"><span data-slate-leaf="true" data-offset-key="14009:0" data-first-offset="true"><span data-slate-string="true"> (sessionTimeoutMs &lt; groupConfig.groupMinSessionTimeoutMs ||</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14010"><span data-slate-object="text" data-key="14011"><span data-slate-leaf="true" data-offset-key="14011:0" data-first-offset="true"><span data-slate-string="true">  sessionTimeoutMs &gt; groupConfig.groupMaxSessionTimeoutMs) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14012"><span data-slate-object="text" data-key="14013"><span data-slate-leaf="true" data-offset-key="14013:0" data-first-offset="true"><span data-slate-string="true">  responseCallback(JoinGroupResult(memberId, Errors.INVALID_SESSION_TIMEOUT))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14014"><span data-slate-object="text" data-key="14015"><span data-slate-leaf="true" data-offset-key="14015:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="14016"><span data-slate-leaf="true" data-offset-key="14016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14017"><span data-slate-leaf="true" data-offset-key="14017:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14018"><span data-slate-object="text" data-key="14019"><span data-slate-leaf="true" data-offset-key="14019:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14020"><span data-slate-leaf="true" data-offset-key="14020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 消费者组成员 ID 是否为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14021"><span data-slate-object="text" data-key="14022"><span data-slate-leaf="true" data-offset-key="14022:0" data-first-offset="true"><span data-slate-string="true">  val isUnknownMember = memberId == JoinGroupRequest.UNKNOWN_MEMBER_ID</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14023"><span data-slate-object="text" data-key="14024"><span data-slate-leaf="true" data-offset-key="14024:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14025"><span data-slate-leaf="true" data-offset-key="14025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取消费者组信息，如果组不存在，就创建一个新的消费者组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14026"><span data-slate-object="text" data-key="14027"><span data-slate-leaf="true" data-offset-key="14027:0" data-first-offset="true"><span data-slate-string="true">  groupManager.getOrMaybeCreateGroup(groupId, isUnknownMember) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14028"><span data-slate-object="text" data-key="14029"><span data-slate-leaf="true" data-offset-key="14029:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14030"><span data-slate-leaf="true" data-offset-key="14030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14031"><span data-slate-leaf="true" data-offset-key="14031:0" data-first-offset="true"><span data-slate-string="true"> None =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14032"><span data-slate-object="text" data-key="14033"><span data-slate-leaf="true" data-offset-key="14033:0" data-first-offset="true"><span data-slate-string="true">      responseCallback(JoinGroupResult(memberId, Errors.UNKNOWN_MEMBER_ID))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14034"><span data-slate-object="text" data-key="14035"><span data-slate-leaf="true" data-offset-key="14035:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14036"><span data-slate-leaf="true" data-offset-key="14036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14037"><span data-slate-leaf="true" data-offset-key="14037:0" data-first-offset="true"><span data-slate-string="true"> Some(group) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14038"><span data-slate-object="text" data-key="14039"><span data-slate-leaf="true" data-offset-key="14039:0" data-first-offset="true"><span data-slate-string="true">      group.inLock {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14040"><span data-slate-object="text" data-key="14041"><span data-slate-leaf="true" data-offset-key="14041:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14042"><span data-slate-leaf="true" data-offset-key="14042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该消费者组已满员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14043"><span data-slate-object="text" data-key="14044"><span data-slate-leaf="true" data-offset-key="14044:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14045"><span data-slate-leaf="true" data-offset-key="14045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14046"><span data-slate-leaf="true" data-offset-key="14046:0" data-first-offset="true"><span data-slate-string="true"> (!acceptJoiningMember(group, memberId)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14047"><span data-slate-object="text" data-key="14048"><span data-slate-leaf="true" data-offset-key="14048:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14049"><span data-slate-leaf="true" data-offset-key="14049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 移除该消费者组成员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14050"><span data-slate-object="text" data-key="14051"><span data-slate-leaf="true" data-offset-key="14051:0" data-first-offset="true"><span data-slate-string="true">          group.remove(memberId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14052"><span data-slate-object="text" data-key="14053"><span data-slate-leaf="true" data-offset-key="14053:0" data-first-offset="true"><span data-slate-string="true">          group.removeStaticMember(groupInstanceId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14054"><span data-slate-object="text" data-key="14055"><span data-slate-leaf="true" data-offset-key="14055:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14056"><span data-slate-leaf="true" data-offset-key="14056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 封装异常表明组已满员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14057"><span data-slate-object="text" data-key="14058"><span data-slate-leaf="true" data-offset-key="14058:0" data-first-offset="true"><span data-slate-string="true">          responseCallback(JoinGroupResult(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14059"><span data-slate-object="text" data-key="14060"><span data-slate-leaf="true" data-offset-key="14060:0" data-first-offset="true"><span data-slate-string="true">            JoinGroupRequest.UNKNOWN_MEMBER_ID, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14061"><span data-slate-object="text" data-key="14062"><span data-slate-leaf="true" data-offset-key="14062:0" data-first-offset="true"><span data-slate-string="true">            Errors.GROUP_MAX_SIZE_REACHED))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14063"><span data-slate-object="text" data-key="14064"><span data-slate-leaf="true" data-offset-key="14064:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14065"><span data-slate-leaf="true" data-offset-key="14065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果消费者组成员 ID 为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14066"><span data-slate-object="text" data-key="14067"><span data-slate-leaf="true" data-offset-key="14067:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="14068"><span data-slate-leaf="true" data-offset-key="14068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14069"><span data-slate-leaf="true" data-offset-key="14069:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14070"><span data-slate-leaf="true" data-offset-key="14070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14071"><span data-slate-leaf="true" data-offset-key="14071:0" data-first-offset="true"><span data-slate-string="true"> (isUnknownMember) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14072"><span data-slate-object="text" data-key="14073"><span data-slate-leaf="true" data-offset-key="14073:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14074"><span data-slate-leaf="true" data-offset-key="14074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为空 ID 成员执行加入组操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14075"><span data-slate-object="text" data-key="14076"><span data-slate-leaf="true" data-offset-key="14076:0" data-first-offset="true"><span data-slate-string="true">          doUnknownJoinGroup(group, groupInstanceId, requireKnownMemberId, clientId, clientHost, rebalanceTimeoutMs, sessionTimeoutMs, protocolType, protocols, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14077"><span data-slate-object="text" data-key="14078"><span data-slate-leaf="true" data-offset-key="14078:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="14079"><span data-slate-leaf="true" data-offset-key="14079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14080"><span data-slate-leaf="true" data-offset-key="14080:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14081"><span data-slate-object="text" data-key="14082"><span data-slate-leaf="true" data-offset-key="14082:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14083"><span data-slate-leaf="true" data-offset-key="14083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为非空 ID 成员执行加入组操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14084"><span data-slate-object="text" data-key="14085"><span data-slate-leaf="true" data-offset-key="14085:0" data-first-offset="true"><span data-slate-string="true">          doJoinGroup(group, memberId, groupInstanceId, clientId, clientHost, rebalanceTimeoutMs, sessionTimeoutMs, protocolType, protocols, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14086"><span data-slate-object="text" data-key="14087"><span data-slate-leaf="true" data-offset-key="14087:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14088"><span data-slate-object="text" data-key="14089"><span data-slate-leaf="true" data-offset-key="14089:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14090"><span data-slate-leaf="true" data-offset-key="14090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果消费者组正处于 PreparingRebalance 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14091"><span data-slate-object="text" data-key="14092"><span data-slate-leaf="true" data-offset-key="14092:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="14093"><span data-slate-leaf="true" data-offset-key="14093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14094"><span data-slate-leaf="true" data-offset-key="14094:0" data-first-offset="true"><span data-slate-string="true"> (group.</span></span></span><span data-slate-object="text" data-key="14095"><span data-slate-leaf="true" data-offset-key="14095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="14096"><span data-slate-leaf="true" data-offset-key="14096:0" data-first-offset="true"><span data-slate-string="true">(PreparingRebalance)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14097"><span data-slate-object="text" data-key="14098"><span data-slate-leaf="true" data-offset-key="14098:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14099"><span data-slate-leaf="true" data-offset-key="14099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 放入 Purgatory，等待后面统一延时处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14100"><span data-slate-object="text" data-key="14101"><span data-slate-leaf="true" data-offset-key="14101:0" data-first-offset="true"><span data-slate-string="true">          joinPurgatory.checkAndComplete(GroupKey(group.groupId))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14102"><span data-slate-object="text" data-key="14103"><span data-slate-leaf="true" data-offset-key="14103:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14104"><span data-slate-object="text" data-key="14105"><span data-slate-leaf="true" data-offset-key="14105:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14106"><span data-slate-object="text" data-key="14107"><span data-slate-leaf="true" data-offset-key="14107:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14108"><span data-slate-object="text" data-key="14109"><span data-slate-leaf="true" data-offset-key="14109:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14110"><span data-slate-object="text" data-key="14111"><span data-slate-leaf="true" data-offset-key="14111:0" data-first-offset="true"><span data-slate-string="true">为了方便你更直观地理解，我画了一张图来说明它的完整流程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14112"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/4b/89/4b4624d5cced2be6a77c7659e048b089.jpg?wh=3476*4352"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14113"><span data-slate-object="text" data-key="14114"><span data-slate-leaf="true" data-offset-key="14114:0" data-first-offset="true"><span data-slate-string="true">第 1 步，调用 validateGroupStatus 方法验证消费者组状态的合法性。所谓的合法性，也就是消费者组名 groupId 不能为空，以及 JoinGroupRequest 请求发送给了正确的 Coordinator，这两者必须同时满足。如果没有通过这些检查，那么，handleJoinGroup 方法会封装相应的错误，并调用回调函数返回。否则，就进入到下一步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14115"><span data-slate-object="text" data-key="14116"><span data-slate-leaf="true" data-offset-key="14116:0" data-first-offset="true"><span data-slate-string="true">第 2 步，代码检验 sessionTimeoutMs 的值是否介于 [group.min.session.timeout.ms，group.max.session.timeout.ms] 之间，如果不是，就认定该值是非法值，从而封装一个对应的异常调用回调函数返回，这两个参数分别表示消费者组允许配置的最小和最大会话超时时间；如果是的话，就进入下一步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14117"><span data-slate-object="text" data-key="14118"><span data-slate-leaf="true" data-offset-key="14118:0" data-first-offset="true"><span data-slate-string="true">第 3 步，代码获取当前成员的 ID 信息，并查看它是否为空。之后，通过 GroupMetadataManager 获取消费者组的元数据信息，如果该组的元数据信息存在，则进入到下一步；如果不存在，代码会看当前成员 ID 是否为空，如果为空，就创建一个空的元数据对象，然后进入到下一步，如果不为空，则返回 None。一旦返回了 None，handleJoinGroup 方法会封装 “未知成员 ID” 的异常，调用回调函数返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14119"><span data-slate-object="text" data-key="14120"><span data-slate-leaf="true" data-offset-key="14120:0" data-first-offset="true"><span data-slate-string="true">第 4 步，检查当前消费者组是否已满员。该逻辑是通过 </span></span></span><span data-slate-object="text" data-key="14121"><span data-slate-leaf="true" data-offset-key="14121:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">acceptJoiningMember 方法</span></span></span></span><span data-slate-object="text" data-key="14122"><span data-slate-leaf="true" data-offset-key="14122:0" data-first-offset="true"><span data-slate-string="true">实现的。这个方法根据</span></span></span><span data-slate-object="text" data-key="14123"><span data-slate-leaf="true" data-offset-key="14123:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">消费者组状态</span></span></span></span><span data-slate-object="text" data-key="14124"><span data-slate-leaf="true" data-offset-key="14124:0" data-first-offset="true"><span data-slate-string="true">确定是否满员。这里的消费者组状态有三种。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14125"><span data-slate-object="text" data-key="14126"><span data-slate-leaf="true" data-offset-key="14126:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">状态一</span></span></span></span><span data-slate-object="text" data-key="14127"><span data-slate-leaf="true" data-offset-key="14127:0" data-first-offset="true"><span data-slate-string="true">：如果是 Empty 或 Dead 状态，肯定不会是满员，直接返回 True，表示可以接纳申请入组的成员；</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14128"><span data-slate-object="text" data-key="14129"><span data-slate-leaf="true" data-offset-key="14129:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">状态二</span></span></span></span><span data-slate-object="text" data-key="14130"><span data-slate-leaf="true" data-offset-key="14130:0" data-first-offset="true"><span data-slate-string="true">：如果是 PreparingRebalance 状态，那么，批准成员入组的条件是必须满足一下两个条件之一。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14131"><div data-slate-type="list-line" data-slate-object="block" data-key="14132"><span data-slate-object="text" data-key="14133"><span data-slate-leaf="true" data-offset-key="14133:0" data-first-offset="true"><span data-slate-string="true">该成员是之前已有的成员，且当前正在等待加入组；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14134"><span data-slate-object="text" data-key="14135"><span data-slate-leaf="true" data-offset-key="14135:0" data-first-offset="true"><span data-slate-string="true">当前等待加入组的成员数小于 Broker 端参数 group.max.size 值。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14136"><span data-slate-object="text" data-key="14137"><span data-slate-leaf="true" data-offset-key="14137:0" data-first-offset="true"><span data-slate-string="true">只要满足这两个条件中的任意一个，当前消费者组成员都会被批准入组。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14138"><span data-slate-object="text" data-key="14139"><span data-slate-leaf="true" data-offset-key="14139:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">状态三</span></span></span></span><span data-slate-object="text" data-key="14140"><span data-slate-leaf="true" data-offset-key="14140:0" data-first-offset="true"><span data-slate-string="true">：如果是其他状态，那么，入组的条件是</span></span></span><span data-slate-object="text" data-key="14141"><span data-slate-leaf="true" data-offset-key="14141:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该成员是已有成员，或者是当前组总成员数小于 Broker 端参数 group.max.size 值</span></span></span></span><span data-slate-object="text" data-key="14142"><span data-slate-leaf="true" data-offset-key="14142:0" data-first-offset="true"><span data-slate-string="true">。需要注意的是，这里比较的是</span></span></span><span data-slate-object="text" data-key="14143"><span data-slate-leaf="true" data-offset-key="14143:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">组当前的总成员数</span></span></span></span><span data-slate-object="text" data-key="14144"><span data-slate-leaf="true" data-offset-key="14144:0" data-first-offset="true"><span data-slate-string="true">，而不是等待入组的成员数，这是因为，一旦 Rebalance 过渡到 CompletingRebalance 之后，没有完成加入组的成员，就会被移除。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14145"><span data-slate-object="text" data-key="14146"><span data-slate-leaf="true" data-offset-key="14146:0" data-first-offset="true"><span data-slate-string="true">倘若成员不被批准入组，那么，代码需要将该成员从元数据缓存中移除，同时封装 “组已满员” 的异常，并调用回调函数返回；如果成员被批准入组，则根据 Member ID 是否为空，就执行 doUnknownJoinGroup 或 doJoinGroup 方法执行加入组的逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14147"><span data-slate-object="text" data-key="14148"><span data-slate-leaf="true" data-offset-key="14148:0" data-first-offset="true"><span data-slate-string="true">第 5 步是尝试完成 JoinGroupRequest 请求的处理。如果消费者组处于 PreparingRebalance 状态，那么，就将该请求放入 Purgatory，尝试立即完成；如果是其它状态，则无需将请求放入 Purgatory。毕竟，我们处理的是加入组的逻辑，而此时消费者组的状态应该要变更到 PreparingRebalance 后，Rebalance 才能完成加入组操作。当然，如果延时请求不能立即完成，则交由 Purgatory 统一进行延时处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14149"><span data-slate-object="text" data-key="14150"><span data-slate-leaf="true" data-offset-key="14150:0" data-first-offset="true"><span data-slate-string="true">至此，handleJoinGroup 逻辑结束。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14151"><span data-slate-object="text" data-key="14152"><span data-slate-leaf="true" data-offset-key="14152:0" data-first-offset="true"><span data-slate-string="true">实际上，我们可以看到，真正执行加入组逻辑的是 doUnknownJoinGroup 和 doJoinGroup 这两个方法。那么，接下来，我们就来学习下这两个方法。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14153" id="sr-toc-2"><span data-slate-object="text" data-key="14154"><span data-slate-leaf="true" data-offset-key="14154:0" data-first-offset="true"><span data-slate-string="true">doUnknownJoinGroup 方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14155"><span data-slate-object="text" data-key="14156"><span data-slate-leaf="true" data-offset-key="14156:0" data-first-offset="true"><span data-slate-string="true">如果是全新的消费者组成员加入组，那么，就需要为它们执行 doUnknownJoinGroup 方法，因为此时，它们的 Member ID 尚未生成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14157"><span data-slate-object="text" data-key="14158"><span data-slate-leaf="true" data-offset-key="14158:0" data-first-offset="true"><span data-slate-string="true">除了 memberId 之外，该方法的输入参数与 handleJoinGroup 方法几乎一模一样，我就不一一地详细介绍了，我们直接看它的源码。为了便于你理解，我省略了关于静态成员以及 DEBUG/INFO 调试的部分代码。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="14159"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14160"><span data-slate-object="text" data-key="14161"><span data-slate-leaf="true" data-offset-key="14161:0" data-first-offset="true"><span data-slate-string="true">group.inLock {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14162"><span data-slate-object="text" data-key="14163"><span data-slate-leaf="true" data-offset-key="14163:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14164"><span data-slate-leaf="true" data-offset-key="14164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Dead 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14165"><span data-slate-object="text" data-key="14166"><span data-slate-leaf="true" data-offset-key="14166:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14167"><span data-slate-leaf="true" data-offset-key="14167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14168"><span data-slate-leaf="true" data-offset-key="14168:0" data-first-offset="true"><span data-slate-string="true"> (group.is(Dead)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14169"><span data-slate-object="text" data-key="14170"><span data-slate-leaf="true" data-offset-key="14170:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14171"><span data-slate-leaf="true" data-offset-key="14171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 封装异常调用回调函数返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14172"><span data-slate-object="text" data-key="14173"><span data-slate-leaf="true" data-offset-key="14173:0" data-first-offset="true"><span data-slate-string="true">    responseCallback(JoinGroupResult(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14174"><span data-slate-object="text" data-key="14175"><span data-slate-leaf="true" data-offset-key="14175:0" data-first-offset="true"><span data-slate-string="true">      JoinGroupRequest.UNKNOWN_MEMBER_ID,         </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14176"><span data-slate-object="text" data-key="14177"><span data-slate-leaf="true" data-offset-key="14177:0" data-first-offset="true"><span data-slate-string="true">      Errors.COORDINATOR_NOT_AVAILABLE))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14178"><span data-slate-object="text" data-key="14179"><span data-slate-leaf="true" data-offset-key="14179:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14180"><span data-slate-leaf="true" data-offset-key="14180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 成员配置的协议类型 / 分区消费分配策略与消费者组的不匹配</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14181"><span data-slate-object="text" data-key="14182"><span data-slate-leaf="true" data-offset-key="14182:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="14183"><span data-slate-leaf="true" data-offset-key="14183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14184"><span data-slate-leaf="true" data-offset-key="14184:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14185"><span data-slate-leaf="true" data-offset-key="14185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14186"><span data-slate-leaf="true" data-offset-key="14186:0" data-first-offset="true"><span data-slate-string="true"> (!group.supportsProtocols(protocolType, MemberMetadata.plainProtocolSet(protocols))) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14187"><span data-slate-object="text" data-key="14188"><span data-slate-leaf="true" data-offset-key="14188:0" data-first-offset="true"><span data-slate-string="true">  responseCallback(JoinGroupResult(JoinGroupRequest.UNKNOWN_MEMBER_ID, Errors.INCONSISTENT_GROUP_PROTOCOL))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14189"><span data-slate-object="text" data-key="14190"><span data-slate-leaf="true" data-offset-key="14190:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="14191"><span data-slate-leaf="true" data-offset-key="14191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14192"><span data-slate-leaf="true" data-offset-key="14192:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14193"><span data-slate-object="text" data-key="14194"><span data-slate-leaf="true" data-offset-key="14194:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14195"><span data-slate-leaf="true" data-offset-key="14195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据规则为该成员创建成员 ID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14196"><span data-slate-object="text" data-key="14197"><span data-slate-leaf="true" data-offset-key="14197:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14198"><span data-slate-leaf="true" data-offset-key="14198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14199"><span data-slate-leaf="true" data-offset-key="14199:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14200"><span data-slate-leaf="true" data-offset-key="14200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newMemberId</span></span></span></span><span data-slate-object="text" data-key="14201"><span data-slate-leaf="true" data-offset-key="14201:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14202"><span data-slate-leaf="true" data-offset-key="14202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14203"><span data-slate-leaf="true" data-offset-key="14203:0" data-first-offset="true"><span data-slate-string="true"> group.generateMemberId(clientId, groupInstanceId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14204"><span data-slate-object="text" data-key="14205"><span data-slate-leaf="true" data-offset-key="14205:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14206"><span data-slate-leaf="true" data-offset-key="14206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果配置了静态成员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14207"><span data-slate-object="text" data-key="14208"><span data-slate-leaf="true" data-offset-key="14208:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14209"><span data-slate-leaf="true" data-offset-key="14209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14210"><span data-slate-leaf="true" data-offset-key="14210:0" data-first-offset="true"><span data-slate-string="true"> (group.hasStaticMember(groupInstanceId)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14211"><span data-slate-object="text" data-key="14212"><span data-slate-leaf="true" data-offset-key="14212:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14213"><span data-slate-object="text" data-key="14214"><span data-slate-leaf="true" data-offset-key="14214:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14215"><span data-slate-leaf="true" data-offset-key="14215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果要求成员 ID 不为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14216"><span data-slate-object="text" data-key="14217"><span data-slate-leaf="true" data-offset-key="14217:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="14218"><span data-slate-leaf="true" data-offset-key="14218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14219"><span data-slate-leaf="true" data-offset-key="14219:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14220"><span data-slate-leaf="true" data-offset-key="14220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14221"><span data-slate-leaf="true" data-offset-key="14221:0" data-first-offset="true"><span data-slate-string="true"> (requireKnownMemberId) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14222"><span data-slate-object="text" data-key="14223"><span data-slate-leaf="true" data-offset-key="14223:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14224"><span data-slate-object="text" data-key="14225"><span data-slate-leaf="true" data-offset-key="14225:0" data-first-offset="true"><span data-slate-string="true">      group.addPendingMember(newMemberId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14226"><span data-slate-object="text" data-key="14227"><span data-slate-leaf="true" data-offset-key="14227:0" data-first-offset="true"><span data-slate-string="true">      addPendingMemberExpiration(group, newMemberId, sessionTimeoutMs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14228"><span data-slate-object="text" data-key="14229"><span data-slate-leaf="true" data-offset-key="14229:0" data-first-offset="true"><span data-slate-string="true">      responseCallback(JoinGroupResult(newMemberId, Errors.MEMBER_ID_REQUIRED))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14230"><span data-slate-object="text" data-key="14231"><span data-slate-leaf="true" data-offset-key="14231:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="14232"><span data-slate-leaf="true" data-offset-key="14232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14233"><span data-slate-leaf="true" data-offset-key="14233:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14234"><span data-slate-object="text" data-key="14235"><span data-slate-leaf="true" data-offset-key="14235:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14236"><span data-slate-object="text" data-key="14237"><span data-slate-leaf="true" data-offset-key="14237:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14238"><span data-slate-leaf="true" data-offset-key="14238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 添加成员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14239"><span data-slate-object="text" data-key="14240"><span data-slate-leaf="true" data-offset-key="14240:0" data-first-offset="true"><span data-slate-string="true">      addMemberAndRebalance(rebalanceTimeoutMs, sessionTimeoutMs, newMemberId, groupInstanceId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14241"><span data-slate-object="text" data-key="14242"><span data-slate-leaf="true" data-offset-key="14242:0" data-first-offset="true"><span data-slate-string="true">        clientId, clientHost, protocolType, protocols, group, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14243"><span data-slate-object="text" data-key="14244"><span data-slate-leaf="true" data-offset-key="14244:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14245"><span data-slate-object="text" data-key="14246"><span data-slate-leaf="true" data-offset-key="14246:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14247"><span data-slate-object="text" data-key="14248"><span data-slate-leaf="true" data-offset-key="14248:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14249"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14250"><span data-slate-object="text" data-key="14251"><span data-slate-leaf="true" data-offset-key="14251:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解，我画了一张图来展示下这个方法的流程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14252"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/49/95/497aef4be2afa50f34ddc99a6788b695.jpg?wh=1716*2752"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14253"><span data-slate-object="text" data-key="14254"><span data-slate-leaf="true" data-offset-key="14254:0" data-first-offset="true"><span data-slate-string="true">首先，代码会检查消费者组的状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14255"><span data-slate-object="text" data-key="14256"><span data-slate-leaf="true" data-offset-key="14256:0" data-first-offset="true"><span data-slate-string="true">如果是 Dead 状态，则封装异常，然后调用回调函数返回。你可能会觉得奇怪，既然是向该组添加成员，为什么组状态还能是 Dead 呢？实际上，这种情况是可能的。因为，在成员加入组的同时，可能存在另一个线程，已经把组的元数据信息从 Coordinator 中移除了。比如，组对应的 Coordinator 发生了变更，移动到了其他的 Broker 上，此时，代码封装一个异常返回给消费者程序，后者会去寻找最新的 Coordinator，然后重新发起加入组操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14257"><span data-slate-object="text" data-key="14258"><span data-slate-leaf="true" data-offset-key="14258:0" data-first-offset="true"><span data-slate-string="true">如果状态不是 Dead，就检查该成员的协议类型以及分区消费分配策略，是否与消费者组当前支持的方案匹配，如果不匹配，依然是封装异常，然后调用回调函数返回。这里的匹配与否，是指成员的协议类型与消费者组的是否一致，以及成员设定的分区消费分配策略是否被消费者组下的其它成员支持。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14259"><span data-slate-object="text" data-key="14260"><span data-slate-leaf="true" data-offset-key="14260:0" data-first-offset="true"><span data-slate-string="true">如果这些检查都顺利通过，接着，代码就会为该成员生成成员 ID，生成规则是 clientId-UUID。这便是 generateMemberId 方法做的事情。然后，handleJoinGroup 方法会根据 requireKnownMemberId 的取值，来决定下面的逻辑路径：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14261"><div data-slate-type="list-line" data-slate-object="block" data-key="14262"><span data-slate-object="text" data-key="14263"><span data-slate-leaf="true" data-offset-key="14263:0" data-first-offset="true"><span data-slate-string="true">如果该值为 True，则将该成员加入到待决成员列表（Pending Member List）中，然后封装一个异常以及生成好的成员 ID，将该成员的入组申请 “打回去”，令其分配好了成员 ID 之后再重新申请；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14264"><span data-slate-object="text" data-key="14265"><span data-slate-leaf="true" data-offset-key="14265:0" data-first-offset="true"><span data-slate-string="true">如果为 False，则无需这么苛刻，直接调用 addMemberAndRebalance 方法将其加入到组中。至此，handleJoinGroup 方法结束。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14266"><span data-slate-object="text" data-key="14267"><span data-slate-leaf="true" data-offset-key="14267:0" data-first-offset="true"><span data-slate-string="true">通常来说，如果你没有启用静态成员机制的话，requireKnownMemberId 的值是 True，这是由 KafkaApis 中 handleJoinGroupRequest 方法的这行语句决定的：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="14268"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14269"><span data-slate-object="text" data-key="14270"><span data-slate-leaf="true" data-offset-key="14270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14271"><span data-slate-leaf="true" data-offset-key="14271:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14272"><span data-slate-leaf="true" data-offset-key="14272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requireKnownMemberId</span></span></span></span><span data-slate-object="text" data-key="14273"><span data-slate-leaf="true" data-offset-key="14273:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14274"><span data-slate-leaf="true" data-offset-key="14274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14275"><span data-slate-leaf="true" data-offset-key="14275:0" data-first-offset="true"><span data-slate-string="true"> joinGroupRequest.version &gt;= </span></span></span><span data-slate-object="text" data-key="14276"><span data-slate-leaf="true" data-offset-key="14276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="14277"><span data-slate-leaf="true" data-offset-key="14277:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; groupInstanceId.isEmpty</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14278"><span data-slate-object="text" data-key="14279"><span data-slate-leaf="true" data-offset-key="14279:0" data-first-offset="true"><span data-slate-string="true">可见， 如果你使用的是比较新的 Kafka 客户端版本，而且没有配置过 Consumer 端参数 group.instance.id 的话，那么，这个字段的值就是 True，这说明，Kafka 要求消费者成员加入组时，必须要分配好成员 ID。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14280"><span data-slate-object="text" data-key="14281"><span data-slate-leaf="true" data-offset-key="14281:0" data-first-offset="true"><span data-slate-string="true">关于 addMemberAndRebalance 方法的源码，一会儿在学习 doJoinGroup 方法时，我再给你具体解释。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14282" id="sr-toc-3"><span data-slate-object="text" data-key="14283"><span data-slate-leaf="true" data-offset-key="14283:0" data-first-offset="true"><span data-slate-string="true">doJoinGroup 方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14284"><span data-slate-object="text" data-key="14285"><span data-slate-leaf="true" data-offset-key="14285:0" data-first-offset="true"><span data-slate-string="true">接下来，我们看下 doJoinGroup 方法。这是为那些设置了成员 ID 的成员，执行加入组逻辑的方法。它的输入参数全部承袭自 handleJoinGroup 方法输入参数，你应该已经很熟悉了，因此，我们直接看它的源码实现。由于代码比较长，我分成两个部分来介绍。同时，我再画一张图，帮助你理解整个方法的逻辑。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14286"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/46/4f/4658881317dc5d8afdeb3bac07cfae4f.jpg?wh=3164*3432"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14287" id="sr-toc-4"><span data-slate-object="text" data-key="14288"><span data-slate-leaf="true" data-offset-key="14288:0" data-first-offset="true"><span data-slate-string="true">第 1 部分</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14289"><span data-slate-object="text" data-key="14290"><span data-slate-leaf="true" data-offset-key="14290:0" data-first-offset="true"><span data-slate-string="true">这部分主要做一些校验和条件检查。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="14291"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14292"><span data-slate-object="text" data-key="14293"><span data-slate-leaf="true" data-offset-key="14293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 Dead 状态，封装 COORDINATOR_NOT_AVAILABLE 异常调用回调函数返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14294"><span data-slate-object="text" data-key="14295"><span data-slate-leaf="true" data-offset-key="14295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14296"><span data-slate-leaf="true" data-offset-key="14296:0" data-first-offset="true"><span data-slate-string="true"> (group.</span></span></span><span data-slate-object="text" data-key="14297"><span data-slate-leaf="true" data-offset-key="14297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="14298"><span data-slate-leaf="true" data-offset-key="14298:0" data-first-offset="true"><span data-slate-string="true">(Dead)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14299"><span data-slate-object="text" data-key="14300"><span data-slate-leaf="true" data-offset-key="14300:0" data-first-offset="true"><span data-slate-string="true">  responseCallback(JoinGroupResult(memberId, Errors.COORDINATOR_NOT_AVAILABLE))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14301"><span data-slate-object="text" data-key="14302"><span data-slate-leaf="true" data-offset-key="14302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果协议类型或分区消费分配策略与消费者组的不匹配</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14303"><span data-slate-object="text" data-key="14304"><span data-slate-leaf="true" data-offset-key="14304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 封装 INCONSISTENT_GROUP_PROTOCOL 异常调用回调函数返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14305"><span data-slate-object="text" data-key="14306"><span data-slate-leaf="true" data-offset-key="14306:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="14307"><span data-slate-leaf="true" data-offset-key="14307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14308"><span data-slate-leaf="true" data-offset-key="14308:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14309"><span data-slate-leaf="true" data-offset-key="14309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14310"><span data-slate-leaf="true" data-offset-key="14310:0" data-first-offset="true"><span data-slate-string="true"> (!group.supportsProtocols(protocolType, MemberMetadata.plainProtocolSet(protocols))) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14311"><span data-slate-object="text" data-key="14312"><span data-slate-leaf="true" data-offset-key="14312:0" data-first-offset="true"><span data-slate-string="true">  responseCallback(JoinGroupResult(memberId, Errors.INCONSISTENT_GROUP_PROTOCOL))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14313"><span data-slate-object="text" data-key="14314"><span data-slate-leaf="true" data-offset-key="14314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是待决成员，由于这次分配了成员 ID，故允许加入组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14315"><span data-slate-object="text" data-key="14316"><span data-slate-leaf="true" data-offset-key="14316:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="14317"><span data-slate-leaf="true" data-offset-key="14317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14318"><span data-slate-leaf="true" data-offset-key="14318:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14319"><span data-slate-leaf="true" data-offset-key="14319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14320"><span data-slate-leaf="true" data-offset-key="14320:0" data-first-offset="true"><span data-slate-string="true"> (group.isPendingMember(memberId)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14321"><span data-slate-object="text" data-key="14322"><span data-slate-leaf="true" data-offset-key="14322:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14323"><span data-slate-leaf="true" data-offset-key="14323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14324"><span data-slate-leaf="true" data-offset-key="14324:0" data-first-offset="true"><span data-slate-string="true"> (groupInstanceId.isDefined) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14325"><span data-slate-object="text" data-key="14326"><span data-slate-leaf="true" data-offset-key="14326:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14327"><span data-slate-object="text" data-key="14328"><span data-slate-leaf="true" data-offset-key="14328:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="14329"><span data-slate-leaf="true" data-offset-key="14329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14330"><span data-slate-leaf="true" data-offset-key="14330:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14331"><span data-slate-object="text" data-key="14332"><span data-slate-leaf="true" data-offset-key="14332:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14333"><span data-slate-object="text" data-key="14334"><span data-slate-leaf="true" data-offset-key="14334:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14335"><span data-slate-leaf="true" data-offset-key="14335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 令其加入组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14336"><span data-slate-object="text" data-key="14337"><span data-slate-leaf="true" data-offset-key="14337:0" data-first-offset="true"><span data-slate-string="true">    addMemberAndRebalance(rebalanceTimeoutMs, sessionTimeoutMs, memberId, groupInstanceId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14338"><span data-slate-object="text" data-key="14339"><span data-slate-leaf="true" data-offset-key="14339:0" data-first-offset="true"><span data-slate-string="true">      clientId, clientHost, protocolType, protocols, group, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14340"><span data-slate-object="text" data-key="14341"><span data-slate-leaf="true" data-offset-key="14341:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14342"><span data-slate-object="text" data-key="14343"><span data-slate-leaf="true" data-offset-key="14343:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="14344"><span data-slate-leaf="true" data-offset-key="14344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14345"><span data-slate-leaf="true" data-offset-key="14345:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14346"><span data-slate-object="text" data-key="14347"><span data-slate-leaf="true" data-offset-key="14347:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14348"><span data-slate-leaf="true" data-offset-key="14348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第二部分代码......</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14349"><span data-slate-object="text" data-key="14350"><span data-slate-leaf="true" data-offset-key="14350:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14351"><span data-slate-object="text" data-key="14352"><span data-slate-leaf="true" data-offset-key="14352:0" data-first-offset="true"><span data-slate-string="true">doJoinGroup 方法开头和 doUnkwownJoinGroup 非常类似，也是判断是否处于 Dead 状态，并且检查协议类型和分区消费分配策略是否与消费者组的相匹配。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14353"><span data-slate-object="text" data-key="14354"><span data-slate-leaf="true" data-offset-key="14354:0" data-first-offset="true"><span data-slate-string="true">不同的是，doJoinGroup 要判断当前申请入组的成员是否是待决成员。如果是的话，那么，这次成员已经分配好了成员 ID，因此，就直接调用 addMemberAndRebalance 方法令其入组；如果不是的话，那么，方法进入到第 2 部分，即处理一个非待决成员的入组申请。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="14355" id="sr-toc-5"><span data-slate-object="text" data-key="14356"><span data-slate-leaf="true" data-offset-key="14356:0" data-first-offset="true"><span data-slate-string="true">第 2 部分</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="14357"><span data-slate-object="text" data-key="14358"><span data-slate-leaf="true" data-offset-key="14358:0" data-first-offset="true"><span data-slate-string="true">代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="14359"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14360"><span data-slate-object="text" data-key="14361"><span data-slate-leaf="true" data-offset-key="14361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取该成员的元数据信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14362"><span data-slate-object="text" data-key="14363"><span data-slate-leaf="true" data-offset-key="14363:0" data-first-offset="true"><span data-slate-string="true">val member = group.</span></span></span><span data-slate-object="text" data-key="14364"><span data-slate-leaf="true" data-offset-key="14364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="14365"><span data-slate-leaf="true" data-offset-key="14365:0" data-first-offset="true"><span data-slate-string="true">(memberId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14366"><span data-slate-object="text" data-key="14367"><span data-slate-leaf="true" data-offset-key="14367:0" data-first-offset="true"><span data-slate-string="true">group.currentState match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14368"><span data-slate-object="text" data-key="14369"><span data-slate-leaf="true" data-offset-key="14369:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14370"><span data-slate-leaf="true" data-offset-key="14370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 PreparingRebalance 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14371"><span data-slate-object="text" data-key="14372"><span data-slate-leaf="true" data-offset-key="14372:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14373"><span data-slate-leaf="true" data-offset-key="14373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14374"><span data-slate-leaf="true" data-offset-key="14374:0" data-first-offset="true"><span data-slate-string="true"> PreparingRebalance =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14375"><span data-slate-object="text" data-key="14376"><span data-slate-leaf="true" data-offset-key="14376:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14377"><span data-slate-leaf="true" data-offset-key="14377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新成员信息并开始准备 Rebalance</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14378"><span data-slate-object="text" data-key="14379"><span data-slate-leaf="true" data-offset-key="14379:0" data-first-offset="true"><span data-slate-string="true">    updateMemberAndRebalance(group, member, protocols, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14380"><span data-slate-object="text" data-key="14381"><span data-slate-leaf="true" data-offset-key="14381:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14382"><span data-slate-leaf="true" data-offset-key="14382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 CompletingRebalance 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14383"><span data-slate-object="text" data-key="14384"><span data-slate-leaf="true" data-offset-key="14384:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14385"><span data-slate-leaf="true" data-offset-key="14385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14386"><span data-slate-leaf="true" data-offset-key="14386:0" data-first-offset="true"><span data-slate-string="true"> CompletingRebalance =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14387"><span data-slate-object="text" data-key="14388"><span data-slate-leaf="true" data-offset-key="14388:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14389"><span data-slate-leaf="true" data-offset-key="14389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果成员以前申请过加入组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14390"><span data-slate-object="text" data-key="14391"><span data-slate-leaf="true" data-offset-key="14391:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14392"><span data-slate-leaf="true" data-offset-key="14392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14393"><span data-slate-leaf="true" data-offset-key="14393:0" data-first-offset="true"><span data-slate-string="true"> (member.matches(protocols)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14394"><span data-slate-object="text" data-key="14395"><span data-slate-leaf="true" data-offset-key="14395:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14396"><span data-slate-leaf="true" data-offset-key="14396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 直接返回当前组信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14397"><span data-slate-object="text" data-key="14398"><span data-slate-leaf="true" data-offset-key="14398:0" data-first-offset="true"><span data-slate-string="true">      responseCallback(JoinGroupResult(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14399"><span data-slate-object="text" data-key="14400"><span data-slate-leaf="true" data-offset-key="14400:0" data-first-offset="true"><span data-slate-string="true">        members = </span></span></span><span data-slate-object="text" data-key="14401"><span data-slate-leaf="true" data-offset-key="14401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14402"><span data-slate-leaf="true" data-offset-key="14402:0" data-first-offset="true"><span data-slate-string="true"> (group.isLeader(memberId)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14403"><span data-slate-object="text" data-key="14404"><span data-slate-leaf="true" data-offset-key="14404:0" data-first-offset="true"><span data-slate-string="true">          group.currentMemberMetadata</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14405"><span data-slate-object="text" data-key="14406"><span data-slate-leaf="true" data-offset-key="14406:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="14407"><span data-slate-leaf="true" data-offset-key="14407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14408"><span data-slate-leaf="true" data-offset-key="14408:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14409"><span data-slate-object="text" data-key="14410"><span data-slate-leaf="true" data-offset-key="14410:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="14411"><span data-slate-leaf="true" data-offset-key="14411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="14412"><span data-slate-leaf="true" data-offset-key="14412:0" data-first-offset="true"><span data-slate-string="true">.empty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14413"><span data-slate-object="text" data-key="14414"><span data-slate-leaf="true" data-offset-key="14414:0" data-first-offset="true"><span data-slate-string="true">        },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14415"><span data-slate-object="text" data-key="14416"><span data-slate-leaf="true" data-offset-key="14416:0" data-first-offset="true"><span data-slate-string="true">        memberId = memberId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14417"><span data-slate-object="text" data-key="14418"><span data-slate-leaf="true" data-offset-key="14418:0" data-first-offset="true"><span data-slate-string="true">        generationId = group.generationId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14419"><span data-slate-object="text" data-key="14420"><span data-slate-leaf="true" data-offset-key="14420:0" data-first-offset="true"><span data-slate-string="true">        protocolType = group.protocolType,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14421"><span data-slate-object="text" data-key="14422"><span data-slate-leaf="true" data-offset-key="14422:0" data-first-offset="true"><span data-slate-string="true">        protocolName = group.protocolName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14423"><span data-slate-object="text" data-key="14424"><span data-slate-leaf="true" data-offset-key="14424:0" data-first-offset="true"><span data-slate-string="true">        leaderId = group.leaderOrNull,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14425"><span data-slate-object="text" data-key="14426"><span data-slate-leaf="true" data-offset-key="14426:0" data-first-offset="true"><span data-slate-string="true">        error = Errors.NONE))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14427"><span data-slate-object="text" data-key="14428"><span data-slate-leaf="true" data-offset-key="14428:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14429"><span data-slate-leaf="true" data-offset-key="14429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则，更新成员信息并开始准备 Rebalance</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14430"><span data-slate-object="text" data-key="14431"><span data-slate-leaf="true" data-offset-key="14431:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="14432"><span data-slate-leaf="true" data-offset-key="14432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14433"><span data-slate-leaf="true" data-offset-key="14433:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14434"><span data-slate-object="text" data-key="14435"><span data-slate-leaf="true" data-offset-key="14435:0" data-first-offset="true"><span data-slate-string="true">      updateMemberAndRebalance(group, member, protocols, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14436"><span data-slate-object="text" data-key="14437"><span data-slate-leaf="true" data-offset-key="14437:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14438"><span data-slate-object="text" data-key="14439"><span data-slate-leaf="true" data-offset-key="14439:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14440"><span data-slate-leaf="true" data-offset-key="14440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 Stable 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14441"><span data-slate-object="text" data-key="14442"><span data-slate-leaf="true" data-offset-key="14442:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14443"><span data-slate-leaf="true" data-offset-key="14443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14444"><span data-slate-leaf="true" data-offset-key="14444:0" data-first-offset="true"><span data-slate-string="true"> Stable =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14445"><span data-slate-object="text" data-key="14446"><span data-slate-leaf="true" data-offset-key="14446:0" data-first-offset="true"><span data-slate-string="true">    val member = group.</span></span></span><span data-slate-object="text" data-key="14447"><span data-slate-leaf="true" data-offset-key="14447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="14448"><span data-slate-leaf="true" data-offset-key="14448:0" data-first-offset="true"><span data-slate-string="true">(memberId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14449"><span data-slate-object="text" data-key="14450"><span data-slate-leaf="true" data-offset-key="14450:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14451"><span data-slate-leaf="true" data-offset-key="14451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果成员是 Leader 成员，或者成员变更了分区分配策略</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14452"><span data-slate-object="text" data-key="14453"><span data-slate-leaf="true" data-offset-key="14453:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14454"><span data-slate-leaf="true" data-offset-key="14454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14455"><span data-slate-leaf="true" data-offset-key="14455:0" data-first-offset="true"><span data-slate-string="true"> (group.isLeader(memberId) || !member.matches(protocols)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14456"><span data-slate-object="text" data-key="14457"><span data-slate-leaf="true" data-offset-key="14457:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14458"><span data-slate-leaf="true" data-offset-key="14458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新成员信息并开始准备 Rebalance</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14459"><span data-slate-object="text" data-key="14460"><span data-slate-leaf="true" data-offset-key="14460:0" data-first-offset="true"><span data-slate-string="true">      updateMemberAndRebalance(group, member, protocols, responseCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14461"><span data-slate-object="text" data-key="14462"><span data-slate-leaf="true" data-offset-key="14462:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="14463"><span data-slate-leaf="true" data-offset-key="14463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14464"><span data-slate-leaf="true" data-offset-key="14464:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14465"><span data-slate-object="text" data-key="14466"><span data-slate-leaf="true" data-offset-key="14466:0" data-first-offset="true"><span data-slate-string="true">      responseCallback(JoinGroupResult(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14467"><span data-slate-object="text" data-key="14468"><span data-slate-leaf="true" data-offset-key="14468:0" data-first-offset="true"><span data-slate-string="true">        members = </span></span></span><span data-slate-object="text" data-key="14469"><span data-slate-leaf="true" data-offset-key="14469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="14470"><span data-slate-leaf="true" data-offset-key="14470:0" data-first-offset="true"><span data-slate-string="true">.empty,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14471"><span data-slate-object="text" data-key="14472"><span data-slate-leaf="true" data-offset-key="14472:0" data-first-offset="true"><span data-slate-string="true">        memberId = memberId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14473"><span data-slate-object="text" data-key="14474"><span data-slate-leaf="true" data-offset-key="14474:0" data-first-offset="true"><span data-slate-string="true">        generationId = group.generationId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14475"><span data-slate-object="text" data-key="14476"><span data-slate-leaf="true" data-offset-key="14476:0" data-first-offset="true"><span data-slate-string="true">        protocolType = group.protocolType,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14477"><span data-slate-object="text" data-key="14478"><span data-slate-leaf="true" data-offset-key="14478:0" data-first-offset="true"><span data-slate-string="true">        protocolName = group.protocolName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14479"><span data-slate-object="text" data-key="14480"><span data-slate-leaf="true" data-offset-key="14480:0" data-first-offset="true"><span data-slate-string="true">        leaderId = group.leaderOrNull,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14481"><span data-slate-object="text" data-key="14482"><span data-slate-leaf="true" data-offset-key="14482:0" data-first-offset="true"><span data-slate-string="true">        error = Errors.NONE))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14483"><span data-slate-object="text" data-key="14484"><span data-slate-leaf="true" data-offset-key="14484:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14485"><span data-slate-object="text" data-key="14486"><span data-slate-leaf="true" data-offset-key="14486:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14487"><span data-slate-leaf="true" data-offset-key="14487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是其它状态，封装异常调用回调函数返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14488"><span data-slate-object="text" data-key="14489"><span data-slate-leaf="true" data-offset-key="14489:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14490"><span data-slate-leaf="true" data-offset-key="14490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14491"><span data-slate-leaf="true" data-offset-key="14491:0" data-first-offset="true"><span data-slate-string="true"> Empty | Dead =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14492"><span data-slate-object="text" data-key="14493"><span data-slate-leaf="true" data-offset-key="14493:0" data-first-offset="true"><span data-slate-string="true">    warn(s</span></span></span><span data-slate-object="text" data-key="14494"><span data-slate-leaf="true" data-offset-key="14494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempt to add rejoining member </span></span></span></span><span data-slate-object="text" data-key="14495"><span data-slate-leaf="true" data-offset-key="14495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$memberId</span></span></span></span></span><span data-slate-object="text" data-key="14496"><span data-slate-leaf="true" data-offset-key="14496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> of group </span></span></span></span><span data-slate-object="text" data-key="14497"><span data-slate-leaf="true" data-offset-key="14497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${group.groupId}</span></span></span></span></span><span data-slate-object="text" data-key="14498"><span data-slate-leaf="true" data-offset-key="14498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> in "</span></span></span></span><span data-slate-object="text" data-key="14499"><span data-slate-leaf="true" data-offset-key="14499:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14500"><span data-slate-object="text" data-key="14501"><span data-slate-leaf="true" data-offset-key="14501:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="14502"><span data-slate-leaf="true" data-offset-key="14502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"unexpected group state </span></span></span></span><span data-slate-object="text" data-key="14503"><span data-slate-leaf="true" data-offset-key="14503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${group.currentState}</span></span></span></span></span><span data-slate-object="text" data-key="14504"><span data-slate-leaf="true" data-offset-key="14504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="14505"><span data-slate-leaf="true" data-offset-key="14505:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14506"><span data-slate-object="text" data-key="14507"><span data-slate-leaf="true" data-offset-key="14507:0" data-first-offset="true"><span data-slate-string="true">    responseCallback(JoinGroupResult(memberId, Errors.UNKNOWN_MEMBER_ID))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14508"><span data-slate-object="text" data-key="14509"><span data-slate-leaf="true" data-offset-key="14509:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14510"><span data-slate-object="text" data-key="14511"><span data-slate-leaf="true" data-offset-key="14511:0" data-first-offset="true"><span data-slate-string="true">这部分代码的</span></span></span><span data-slate-object="text" data-key="14512"><span data-slate-leaf="true" data-offset-key="14512:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 1 步</span></span></span></span><span data-slate-object="text" data-key="14513"><span data-slate-leaf="true" data-offset-key="14513:0" data-first-offset="true"><span data-slate-string="true">，是获取要加入组成员的元数据信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14514"><span data-slate-object="text" data-key="14515"><span data-slate-leaf="true" data-offset-key="14515:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 2 步</span></span></span></span><span data-slate-object="text" data-key="14516"><span data-slate-leaf="true" data-offset-key="14516:0" data-first-offset="true"><span data-slate-string="true">，是查询消费者组的当前状态。这里有 4 种情况。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14517"><div data-slate-type="list-line" data-slate-object="block" data-key="14518"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="14519"><span data-slate-leaf="true" data-offset-key="14519:0" data-first-offset="true"><span data-slate-string="true">如果是 PreparingRebalance 状态，就说明消费者组正要开启 Rebalance 流程，那么，调用 updateMemberAndRebalance 方法更新成员信息，并开始准备 Rebalance 即可。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="14520"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="14521"><span data-slate-leaf="true" data-offset-key="14521:0" data-first-offset="true"><span data-slate-string="true">如果是 CompletingRebalance 状态，那么，就判断一下，该成员的分区消费分配策略与订阅分区列表是否和已保存记录中的一致，如果相同，就说明该成员已经应该发起过加入组的操作，并且 Coordinator 已经批准了，只是该成员没有收到，因此，针对这种情况，代码构造一个 JoinGroupResult 对象，直接返回当前的组信息给成员。但是，如果 protocols 不相同，那么，就说明成员变更了订阅信息或分配策略，就要调用 updateMemberAndRebalance 方法，更新成员信息，并开始准备新一轮 Rebalance。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="14522"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="14523"><span data-slate-leaf="true" data-offset-key="14523:0" data-first-offset="true"><span data-slate-string="true">如果是 Stable 状态，那么，就判断该成员是否是 Leader 成员，或者是它的订阅信息或分配策略发生了变更。如果是这种情况，就调用 updateMemberAndRebalance 方法强迫一次新的 Rebalance。否则的话，返回当前组信息给该成员即可，通知它们可以发起 Rebalance 的下一步操作。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="14524"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="14525"><span data-slate-leaf="true" data-offset-key="14525:0" data-first-offset="true"><span data-slate-string="true">如果这些状态都不是，而是 Empty 或 Dead 状态，那么，就封装 UNKNOWN_MEMBER_ID 异常，并调用回调函数返回。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14526"><span data-slate-object="text" data-key="14527"><span data-slate-leaf="true" data-offset-key="14527:0" data-first-offset="true"><span data-slate-string="true">可以看到，这部分代码频繁地调用 updateMemberAndRebalance 方法。如果你翻开它的代码，会发现，它仅仅做两件事情。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14528"><div data-slate-type="list-line" data-slate-object="block" data-key="14529"><span data-slate-object="text" data-key="14530"><span data-slate-leaf="true" data-offset-key="14530:0" data-first-offset="true"><span data-slate-string="true">更新组成员信息；调用 GroupMetadata 的 updateMember 方法来更新消费者组成员；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14531"><span data-slate-object="text" data-key="14532"><span data-slate-leaf="true" data-offset-key="14532:0" data-first-offset="true"><span data-slate-string="true">准备 Rebalance：这一步的核心思想，是将消费者组状态变更到 PreparingRebalance，然后创建 DelayedJoin 对象，并交由 Purgatory，等待延时处理加入组操作。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14533"><span data-slate-object="text" data-key="14534"><span data-slate-leaf="true" data-offset-key="14534:0" data-first-offset="true"><span data-slate-string="true">这个方法的代码行数不多，而且逻辑很简单，就是变更消费者组状态，以及处理延时请求并放入 Purgatory，因此，我不展开说了，你可以自行阅读下这部分代码。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14535" id="sr-toc-6"><span data-slate-object="text" data-key="14536"><span data-slate-leaf="true" data-offset-key="14536:0" data-first-offset="true"><span data-slate-string="true">addMemberAndRebalance 方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14537"><span data-slate-object="text" data-key="14538"><span data-slate-leaf="true" data-offset-key="14538:0" data-first-offset="true"><span data-slate-string="true">现在，我们学习下 doUnknownJoinGroup 和 doJoinGroup 方法都会用到的 addMemberAndRebalance 方法。从名字上来看，它的作用有两个：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14539"><div data-slate-type="list-line" data-slate-object="block" data-key="14540"><span data-slate-object="text" data-key="14541"><span data-slate-leaf="true" data-offset-key="14541:0" data-first-offset="true"><span data-slate-string="true">向消费者组添加成员；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14542"><span data-slate-object="text" data-key="14543"><span data-slate-leaf="true" data-offset-key="14543:0" data-first-offset="true"><span data-slate-string="true">准备 Rebalance。</span></span></span></div></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="14544"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14545"><span data-slate-object="text" data-key="14546"><span data-slate-leaf="true" data-offset-key="14546:0" data-first-offset="true"><span data-slate-string="true">private def addMemberAndRebalance(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14547"><span data-slate-object="text" data-key="14548"><span data-slate-leaf="true" data-offset-key="14548:0" data-first-offset="true"><span data-slate-string="true">  rebalanceTimeoutMs: Int,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14549"><span data-slate-object="text" data-key="14550"><span data-slate-leaf="true" data-offset-key="14550:0" data-first-offset="true"><span data-slate-string="true">  sessionTimeoutMs: Int,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14551"><span data-slate-object="text" data-key="14552"><span data-slate-leaf="true" data-offset-key="14552:0" data-first-offset="true"><span data-slate-string="true">  memberId: </span></span></span><span data-slate-object="text" data-key="14553"><span data-slate-leaf="true" data-offset-key="14553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="14554"><span data-slate-leaf="true" data-offset-key="14554:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14555"><span data-slate-object="text" data-key="14556"><span data-slate-leaf="true" data-offset-key="14556:0" data-first-offset="true"><span data-slate-string="true">  groupInstanceId: Option[</span></span></span><span data-slate-object="text" data-key="14557"><span data-slate-leaf="true" data-offset-key="14557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="14558"><span data-slate-leaf="true" data-offset-key="14558:0" data-first-offset="true"><span data-slate-string="true">],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14559"><span data-slate-object="text" data-key="14560"><span data-slate-leaf="true" data-offset-key="14560:0" data-first-offset="true"><span data-slate-string="true">  clientId: </span></span></span><span data-slate-object="text" data-key="14561"><span data-slate-leaf="true" data-offset-key="14561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="14562"><span data-slate-leaf="true" data-offset-key="14562:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14563"><span data-slate-object="text" data-key="14564"><span data-slate-leaf="true" data-offset-key="14564:0" data-first-offset="true"><span data-slate-string="true">  clientHost: </span></span></span><span data-slate-object="text" data-key="14565"><span data-slate-leaf="true" data-offset-key="14565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="14566"><span data-slate-leaf="true" data-offset-key="14566:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14567"><span data-slate-object="text" data-key="14568"><span data-slate-leaf="true" data-offset-key="14568:0" data-first-offset="true"><span data-slate-string="true">  protocolType: </span></span></span><span data-slate-object="text" data-key="14569"><span data-slate-leaf="true" data-offset-key="14569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="14570"><span data-slate-leaf="true" data-offset-key="14570:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14571"><span data-slate-object="text" data-key="14572"><span data-slate-leaf="true" data-offset-key="14572:0" data-first-offset="true"><span data-slate-string="true">  protocols: </span></span></span><span data-slate-object="text" data-key="14573"><span data-slate-leaf="true" data-offset-key="14573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="14574"><span data-slate-leaf="true" data-offset-key="14574:0" data-first-offset="true"><span data-slate-string="true">[(</span></span></span><span data-slate-object="text" data-key="14575"><span data-slate-leaf="true" data-offset-key="14575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="14576"><span data-slate-leaf="true" data-offset-key="14576:0" data-first-offset="true"><span data-slate-string="true">, Array[Byte])],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14577"><span data-slate-object="text" data-key="14578"><span data-slate-leaf="true" data-offset-key="14578:0" data-first-offset="true"><span data-slate-string="true">  group: GroupMetadata,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14579"><span data-slate-object="text" data-key="14580"><span data-slate-leaf="true" data-offset-key="14580:0" data-first-offset="true"><span data-slate-string="true">  callback: JoinCallback): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14581"><span data-slate-object="text" data-key="14582"><span data-slate-leaf="true" data-offset-key="14582:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14583"><span data-slate-leaf="true" data-offset-key="14583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 MemberMetadata 对象实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14584"><span data-slate-object="text" data-key="14585"><span data-slate-leaf="true" data-offset-key="14585:0" data-first-offset="true"><span data-slate-string="true">  val member = </span></span></span><span data-slate-object="text" data-key="14586"><span data-slate-leaf="true" data-offset-key="14586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="14587"><span data-slate-leaf="true" data-offset-key="14587:0" data-first-offset="true"><span data-slate-string="true"> MemberMetadata(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14588"><span data-slate-object="text" data-key="14589"><span data-slate-leaf="true" data-offset-key="14589:0" data-first-offset="true"><span data-slate-string="true">    memberId, group.groupId, groupInstanceId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14590"><span data-slate-object="text" data-key="14591"><span data-slate-leaf="true" data-offset-key="14591:0" data-first-offset="true"><span data-slate-string="true">    clientId, clientHost, rebalanceTimeoutMs,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14592"><span data-slate-object="text" data-key="14593"><span data-slate-leaf="true" data-offset-key="14593:0" data-first-offset="true"><span data-slate-string="true">    sessionTimeoutMs, protocolType, protocols)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14594"><span data-slate-object="text" data-key="14595"><span data-slate-leaf="true" data-offset-key="14595:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14596"><span data-slate-leaf="true" data-offset-key="14596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 标识该成员是新成员</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14597"><span data-slate-object="text" data-key="14598"><span data-slate-leaf="true" data-offset-key="14598:0" data-first-offset="true"><span data-slate-string="true">  member.isNew = </span></span></span><span data-slate-object="text" data-key="14599"><span data-slate-leaf="true" data-offset-key="14599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14600"><span data-slate-object="text" data-key="14601"><span data-slate-leaf="true" data-offset-key="14601:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14602"><span data-slate-leaf="true" data-offset-key="14602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果消费者组准备开启首次 Rebalance，设置 newMemberAdded 为 True</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14603"><span data-slate-object="text" data-key="14604"><span data-slate-leaf="true" data-offset-key="14604:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14605"><span data-slate-leaf="true" data-offset-key="14605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14606"><span data-slate-leaf="true" data-offset-key="14606:0" data-first-offset="true"><span data-slate-string="true"> (group.</span></span></span><span data-slate-object="text" data-key="14607"><span data-slate-leaf="true" data-offset-key="14607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="14608"><span data-slate-leaf="true" data-offset-key="14608:0" data-first-offset="true"><span data-slate-string="true">(PreparingRebalance) &amp;&amp; group.generationId == </span></span></span><span data-slate-object="text" data-key="14609"><span data-slate-leaf="true" data-offset-key="14609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14610"><span data-slate-leaf="true" data-offset-key="14610:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14611"><span data-slate-object="text" data-key="14612"><span data-slate-leaf="true" data-offset-key="14612:0" data-first-offset="true"><span data-slate-string="true">    group.newMemberAdded = </span></span></span><span data-slate-object="text" data-key="14613"><span data-slate-leaf="true" data-offset-key="14613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14614"><span data-slate-object="text" data-key="14615"><span data-slate-leaf="true" data-offset-key="14615:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14616"><span data-slate-leaf="true" data-offset-key="14616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将该成员添加到消费者组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14617"><span data-slate-object="text" data-key="14618"><span data-slate-leaf="true" data-offset-key="14618:0" data-first-offset="true"><span data-slate-string="true">  group.add(member, callback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14619"><span data-slate-object="text" data-key="14620"><span data-slate-leaf="true" data-offset-key="14620:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14621"><span data-slate-leaf="true" data-offset-key="14621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置下次心跳超期时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14622"><span data-slate-object="text" data-key="14623"><span data-slate-leaf="true" data-offset-key="14623:0" data-first-offset="true"><span data-slate-string="true">  completeAndScheduleNextExpiration(group, member, NewMemberJoinTimeoutMs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14624"><span data-slate-object="text" data-key="14625"><span data-slate-leaf="true" data-offset-key="14625:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14626"><span data-slate-leaf="true" data-offset-key="14626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14627"><span data-slate-leaf="true" data-offset-key="14627:0" data-first-offset="true"><span data-slate-string="true"> (member.isStaticMember) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14628"><span data-slate-object="text" data-key="14629"><span data-slate-leaf="true" data-offset-key="14629:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="14630"><span data-slate-leaf="true" data-offset-key="14630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Adding new static member </span></span></span></span><span data-slate-object="text" data-key="14631"><span data-slate-leaf="true" data-offset-key="14631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$groupInstanceId</span></span></span></span></span><span data-slate-object="text" data-key="14632"><span data-slate-leaf="true" data-offset-key="14632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> to group </span></span></span></span><span data-slate-object="text" data-key="14633"><span data-slate-leaf="true" data-offset-key="14633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${group.groupId}</span></span></span></span></span><span data-slate-object="text" data-key="14634"><span data-slate-leaf="true" data-offset-key="14634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with member id </span></span></span></span><span data-slate-object="text" data-key="14635"><span data-slate-leaf="true" data-offset-key="14635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$memberId</span></span></span></span></span><span data-slate-object="text" data-key="14636"><span data-slate-leaf="true" data-offset-key="14636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="14637"><span data-slate-leaf="true" data-offset-key="14637:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14638"><span data-slate-object="text" data-key="14639"><span data-slate-leaf="true" data-offset-key="14639:0" data-first-offset="true"><span data-slate-string="true">    group.addStaticMember(groupInstanceId, memberId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14640"><span data-slate-object="text" data-key="14641"><span data-slate-leaf="true" data-offset-key="14641:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="14642"><span data-slate-leaf="true" data-offset-key="14642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="14643"><span data-slate-leaf="true" data-offset-key="14643:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14644"><span data-slate-object="text" data-key="14645"><span data-slate-leaf="true" data-offset-key="14645:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14646"><span data-slate-leaf="true" data-offset-key="14646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从待决成员列表中移除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14647"><span data-slate-object="text" data-key="14648"><span data-slate-leaf="true" data-offset-key="14648:0" data-first-offset="true"><span data-slate-string="true">    group.removePendingMember(memberId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14649"><span data-slate-object="text" data-key="14650"><span data-slate-leaf="true" data-offset-key="14650:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14651"><span data-slate-object="text" data-key="14652"><span data-slate-leaf="true" data-offset-key="14652:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14653"><span data-slate-leaf="true" data-offset-key="14653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 准备开启 Rebalance</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14654"><span data-slate-object="text" data-key="14655"><span data-slate-leaf="true" data-offset-key="14655:0" data-first-offset="true"><span data-slate-string="true">  maybePrepareRebalance(group, s</span></span></span><span data-slate-object="text" data-key="14656"><span data-slate-leaf="true" data-offset-key="14656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Adding new member </span></span></span></span><span data-slate-object="text" data-key="14657"><span data-slate-leaf="true" data-offset-key="14657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$memberId</span></span></span></span></span><span data-slate-object="text" data-key="14658"><span data-slate-leaf="true" data-offset-key="14658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with group instance id </span></span></span></span><span data-slate-object="text" data-key="14659"><span data-slate-leaf="true" data-offset-key="14659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$groupInstanceId</span></span></span></span></span><span data-slate-object="text" data-key="14660"><span data-slate-leaf="true" data-offset-key="14660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="14661"><span data-slate-leaf="true" data-offset-key="14661:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14662"><span data-slate-object="text" data-key="14663"><span data-slate-leaf="true" data-offset-key="14663:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14664"><span data-slate-object="text" data-key="14665"><span data-slate-leaf="true" data-offset-key="14665:0" data-first-offset="true"><span data-slate-string="true">这个方法的参数列表虽然很长，但我相信，你对它们已经非常熟悉了，它们都是承袭自其上层调用方法的参数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14666"><span data-slate-object="text" data-key="14667"><span data-slate-leaf="true" data-offset-key="14667:0" data-first-offset="true"><span data-slate-string="true">我来介绍一下这个方法的执行逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14668"><span data-slate-object="text" data-key="14669"><span data-slate-leaf="true" data-offset-key="14669:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 1 步</span></span></span></span><span data-slate-object="text" data-key="14670"><span data-slate-leaf="true" data-offset-key="14670:0" data-first-offset="true"><span data-slate-string="true">，该方法会根据传入参数创建一个 MemberMetadata 对象实例，并设置 isNew 字段为 True，标识其是一个新成员。isNew 字段与心跳设置相关联，你可以阅读下 MemberMetadata 的 hasSatisfiedHeartbeat 方法的代码，搞明白该字段是如何帮助 Coordinator 确认消费者组成员心跳的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14671"><span data-slate-object="text" data-key="14672"><span data-slate-leaf="true" data-offset-key="14672:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 2 步</span></span></span></span><span data-slate-object="text" data-key="14673"><span data-slate-leaf="true" data-offset-key="14673:0" data-first-offset="true"><span data-slate-string="true">，代码会判断消费者组是否是首次开启 Rebalance。如果是的话，就把 newMemberAdded 字段设置为 True；如果不是，则无需执行这个赋值操作。这个字段的作用，是 Kafka 为消费者组 Rebalance 流程做的一个性能优化。大致的思想，是在消费者组首次进行 Rebalance 时，让 Coordinator 多等待一段时间，从而让更多的消费者组成员加入到组中，以免后来者申请入组而反复进行 Rebalance。这段多等待的时间，就是 Broker 端参数 </span></span></span><span data-slate-object="text" data-key="14674"><span data-slate-leaf="true" data-offset-key="14674:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">group.initial.rebalance.delay.ms 的值</span></span></span></span><span data-slate-object="text" data-key="14675"><span data-slate-leaf="true" data-offset-key="14675:0" data-first-offset="true"><span data-slate-string="true">。这里的 newMemberAdded 字段，就是用于判断是否需要多等待这段时间的一个变量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14676"><span data-slate-object="text" data-key="14677"><span data-slate-leaf="true" data-offset-key="14677:0" data-first-offset="true"><span data-slate-string="true">我们接着说回 addMemberAndRebalance 方法。该方法的</span></span></span><span data-slate-object="text" data-key="14678"><span data-slate-leaf="true" data-offset-key="14678:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 3 步</span></span></span></span><span data-slate-object="text" data-key="14679"><span data-slate-leaf="true" data-offset-key="14679:0" data-first-offset="true"><span data-slate-string="true">是调用 GroupMetadata 的 add 方法，将新成员信息加入到消费者组元数据中，同时设置该成员的下次心跳超期时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14680"><span data-slate-object="text" data-key="14681"><span data-slate-leaf="true" data-offset-key="14681:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 4 步</span></span></span></span><span data-slate-object="text" data-key="14682"><span data-slate-leaf="true" data-offset-key="14682:0" data-first-offset="true"><span data-slate-string="true">，代码将该成员从待决成员列表中移除。毕竟，它已经正式加入到组中了，就不需要待在待决列表中了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14683"><span data-slate-object="text" data-key="14684"><span data-slate-leaf="true" data-offset-key="14684:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 5 步</span></span></span></span><span data-slate-object="text" data-key="14685"><span data-slate-leaf="true" data-offset-key="14685:0" data-first-offset="true"><span data-slate-string="true">，调用 maybePrepareRebalance 方法，准备开启 Rebalance。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14686" id="sr-toc-7"><span data-slate-object="text" data-key="14687"><span data-slate-leaf="true" data-offset-key="14687:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14688"><span data-slate-object="text" data-key="14689"><span data-slate-leaf="true" data-offset-key="14689:0" data-first-offset="true"><span data-slate-string="true">至此，我们学完了 Rebalance 流程的第一大步，也就是加入组的源码学习。在这一步中，你要格外注意，</span></span></span><span data-slate-object="text" data-key="14690"><span data-slate-leaf="true" data-offset-key="14690:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">加入组时是区分有无消费者组成员 ID</span></span></span></span><span data-slate-object="text" data-key="14691"><span data-slate-leaf="true" data-offset-key="14691:0" data-first-offset="true"><span data-slate-string="true">。对于未设定成员 ID 的分支，代码调用 doUnkwonwJoinGroup 为成员生成 ID 信息；对于已设定成员 ID 的分支，则调用 doJoinGroup 方法。而这两个方法，底层都是调用 addMemberAndRebalance 方法，实现将消费者组成员添加进组的逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14692"><span data-slate-object="text" data-key="14693"><span data-slate-leaf="true" data-offset-key="14693:0" data-first-offset="true"><span data-slate-string="true">我们来简单回顾一下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14694"><div data-slate-type="list-line" data-slate-object="block" data-key="14695"><span data-slate-object="text" data-key="14696"><span data-slate-leaf="true" data-offset-key="14696:0" data-first-offset="true"><span data-slate-string="true">Rebalance 流程：包括 JoinGroup 和 SyncGroup 两大步。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14697"><span data-slate-object="text" data-key="14698"><span data-slate-leaf="true" data-offset-key="14698:0" data-first-offset="true"><span data-slate-string="true">handleJoinGroup 方法：Coordinator 端处理成员加入组申请的方法。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14699"><span data-slate-object="text" data-key="14700"><span data-slate-leaf="true" data-offset-key="14700:0" data-first-offset="true"><span data-slate-string="true">Member Id：成员 ID。Kafka 源码根据成员 ID 的有无，决定调用哪种加入组逻辑方法，比如 doUnknownJoinGroup 或 doJoinGroup 方法。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14701"><span data-slate-object="text" data-key="14702"><span data-slate-leaf="true" data-offset-key="14702:0" data-first-offset="true"><span data-slate-string="true">addMemberAndRebalance 方法：实现加入组功能的实际方法，用于完成 “加入组 + 开启 Rebalance” 这两个操作。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="14703"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/41/01/41212f50defaffd79b04f851a278eb01.jpg?wh=2250*1323"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14704"><span data-slate-object="text" data-key="14705"><span data-slate-leaf="true" data-offset-key="14705:0" data-first-offset="true"><span data-slate-string="true">当所有成员都成功加入到组之后，所有成员会开启 Rebalance 的第二大步：组同步。在这一步中，成员会发送 SyncGroupRequest 请求给 Coordinator。那么，Coordinator 又是如何应对的呢？咱们下节课见分晓。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14706" id="sr-toc-8"><span data-slate-object="text" data-key="14707"><span data-slate-leaf="true" data-offset-key="14707:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14708"><span data-slate-object="text" data-key="14709"><span data-slate-leaf="true" data-offset-key="14709:0" data-first-offset="true"><span data-slate-string="true">今天，我们曾多次提到 maybePrepareRebalance 方法，从名字上看，它并不一定会开启 Rebalance。那么，你能否结合源码说说看，到底什么情况下才能开启 Rebalance？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14710"><span data-slate-object="text" data-key="14711"><span data-slate-leaf="true" data-offset-key="14711:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-9">精选留言 (10)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，我们重点学习了 GroupMetadataManager 类读写位移主题的源码。课后我请你分析 cleanGroupMetadata 方法的流程。实际上，这个方法调用带参数的同名方法 cleanupGroupMetadata 来执行组位移的清除。后者会遍历给定的所有消费者组，之后调用 removeExpiredOffsets 方法执行过期位移的清除。清除的主要依据是看当前时间与位移提交的时间的差值是否越过了 offsets.retention.minutes 参数值。如果越过了则视该位移为过期，需要从 offsets 中移除。同时，cleanupGroupMetadata 方法还会构造 tombstone 消息并写入到内部位移主题执行主题中的过期位移消息的输出。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-07-21</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/4a/b9/1531ff1c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>双椒叔叔</span></div></div><div>胡老师，您好
分区迁移遇到的问题怎么解决呢
1038，1037，1029-----reassign-----&gt;1038,1037,1048
其实就是 1029 机子先宕掉了，然后我想要把死掉的 1029 机子上的副本迁移到 1048 上

但是迁移计划卡死了，一直 in progress
replica 变成 1038，1037，1048，1029 了，ISR 变成了 1038,1048

现在我想要在 replica 中 remove1029，我看了源码发现是状态机维护的每一个 replica 状态

源码中
1038，1037，1029-----reassign-----&gt;1038,1037,1048
迁移计划卡住的那步是这样的
要把 1029 副本的状态从 replica 中移除流程是
controller 先把 1029offline,
然后
controller 发送状态改变请求（deleted）给 1029


1、first move the replica to offline state (the controller removes it from the ISR)

2、send stop replica command to the old replicas


3、Eventually partition reassignment could use a callback that does retries if deletion failed

如果 1029 这个节点不在线的话就会
返回一个回调状态值 NonExistentReplica（因为 1029 现在是死了的状态）。
reassignment 那里的源码大概我看了下，不知道上面的理解对不对
就想问下，想这种原本 3 副本，现在执行迁移计划后，replica 中多了一个不在线的 1029，然后执行计划一直 in progress
那么这种情况如何解决呢？
是直接在 zk 中修改该主题的问题分区（执行迁移计划卡主的那个分区）吗？生产中 1k 个分区，zk 中不知道敢不敢修改</div><div><p>作者回复：删除 zk 中 /admin/reassign_partitions 下对应的节点然后重启 broker 试试呢
</p></div><div><div>2020-07-13</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span> 肖恒</span></div></div><div>请教下，重平衡开启前是如何处理 offset 的？</div><div><p>作者回复：会在 rebalance 前尝试提交位移，如果成功则 okay，不成功就只能等待 rebalance 结束了</p></div><div><div>2021-01-20</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>对与错</span></div></div><div>胡哥，协调者是依据什么来的？比如一个协调者所对应的 broker 挂了，那么其他消费者成员会发生什么？</div><div><p>作者回复: broker 挂了，其他副本会成为 leader，也就是新的 Coordinator</p></div><div><div>2021-01-07</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1e/a6/3e/3d18f35a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>三颗豆子</span></div></div><div>生产发现 JoinGroup 的监控指标时延很高，短的几秒，长的 1 分钟，这个正常吗？其他的全部请求时延都在 2 秒以下。仔细分析是在 remote 阶段的时延很高，remote 它在等什么呢？</div><div><p>作者回复：能发下截图或具体的 JMX bean 吗？我去看下对应的逻辑</p></div><div><div>2020-12-18</div><div><div><i></i><span>4</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div>   private def maybePrepareRebalance (group: GroupMetadata, reason: String): Unit = {
    group.inLock {
      if (group.canRebalance) 
        prepareRebalance (group, reason)
    }
  }
  在 GroupMetadata 中 canRebalance 方法定义为
   def canRebalance = PreparingRebalance.validPreviousStates.contains (state)
  然后调用 prepareRebalance 方法
     private def prepareRebalance (group: GroupMetadata, reason: String): Unit = {
    // 如果有任何成员正在等待同步，取消他们的请求并让他们重新加入
    if (group.is (CompletingRebalance))
      resetAndPropagateAssignmentError (group, Errors.REBALANCE_IN_PROGRESS)
    val delayedRebalance = if (group.is (Empty))
      new InitialDelayedJoin (this,
        joinPurgatory,
        group,
        groupConfig.groupInitialRebalanceDelayMs,
        groupConfig.groupInitialRebalanceDelayMs,
        max (group.rebalanceTimeoutMs - groupConfig.groupInitialRebalanceDelayMs, 0))
    else
      new DelayedJoin (this, group, group.rebalanceTimeoutMs)
    group.transitionTo (PreparingRebalance)
    info (s"Preparing to rebalance group ${group.groupId} in state ${group.currentState} with old generation" +
      s"${group.generationId} (${Topic.GROUP_METADATA_TOPIC_NAME}-${partitionFor (group.groupId)}) (reason: $reason)")
    val groupKey = GroupKey (group.groupId)
    joinPurgatory.tryCompleteElseWatch (delayedRebalance, Seq (groupKey))
  }
</div><div><div>2020-09-02</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/a1/ea/4afba3f1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>云端漫漫步</span></div></div><div>GroupState 是 Stable, CompletingRebalance, Empty 这三种的情况下才可以</div><div><p>作者回复: ������</p></div><div><div>2020-07-25</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/64/9b/0b578b08.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>J.Smile</span></div></div><div>老师您好，想问下如何能明确观察到 reblance 的过程，因为有时候知道发生了 reblance，但是不能确认是什么原因引起的 reblance，所以想通过一定手段定位下，比如 tcpdump 抓包，但是用 wireshark 打开并转为 kafka 协议好像也看不出 reblance 的过程，也可能是我用的不熟练，想请老师可以补充下这方面的，毕竟理论结合实践才是解决问题的途径。
补充说一下，好像 server.log 也只能看到说 Reblance 开始了，Member 被移除。。之类等等。</div><div><p>作者回复：打开 DEBUG 日志，会有非常详细的日志输出，重点看看 Coordinator 部分的 DEBUG 日志</p></div><div><div>2020-07-22</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>懂码哥 (GerryWen)</span></div></div><div>胡大大，您的社区名字有点意思。https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huxi_2b
😀😁😝</div><div><p>作者回复：额。。。不是你想的那样：）</p></div><div><div>2020-07-13</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>从代码上看，进入 maybePrepareRebalance 的时候，首先把 group 加入锁中，因为这里要访问消费组的元数据（线程不安全），然后只有一个判断 if (group.canRebalance)，这个判断主要是判断消费组元数据中的 validPreviousStates 的 map 集合中是否存在 PreparingRebalance 状态的数据，事实上这个状态就是一个过渡的中间状态比如某些成员加入超时的状态，所有成员离开了组，通过分区迁移删除组。</div><div><p>作者回复: 👍</p></div><div><div>2020-07-11</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".17"><outline class="toc-level-h1" data-reactid=".17.0" style="width: 175px;"><active data-reactid=".17.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".17.0.1"><span data-reactid=".17.0.1.0">32 | GroupCoordinator：在 Rebalance 中，Coordinator 如何处理成员入组？</span></a></outline><outline class="toc-level-h2" data-reactid=".17.1" style="width: 165px;"><active data-reactid=".17.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".17.1.1"><span data-reactid=".17.1.1.0">handleJoinGroup 方法</span></a></outline><outline class="toc-level-h2" data-reactid=".17.2" style="width: 165px;"><active data-reactid=".17.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".17.2.1"><span data-reactid=".17.2.1.0">doUnknownJoinGroup 方法</span></a></outline><outline class="toc-level-h2" data-reactid=".17.3" style="width: 165px;"><active data-reactid=".17.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".17.3.1"><span data-reactid=".17.3.1.0">doJoinGroup 方法</span></a></outline><outline class="toc-level-h3" data-reactid=".17.4" style="width: 155px;"><active data-reactid=".17.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".17.4.1"><span data-reactid=".17.4.1.0">第 1 部分</span></a></outline><outline class="toc-level-h3" data-reactid=".17.5" style="width: 155px;"><active data-reactid=".17.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".17.5.1"><span data-reactid=".17.5.1.0">第 2 部分</span></a></outline><outline class="toc-level-h2" data-reactid=".17.6" style="width: 165px;"><active data-reactid=".17.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".17.6.1"><span data-reactid=".17.6.1.0">addMemberAndRebalance 方法</span></a></outline><outline class="toc-level-h2" data-reactid=".17.7" style="width: 165px;"><active data-reactid=".17.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".17.7.1"><span data-reactid=".17.7.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".17.8" style="width: 165px;"><active data-reactid=".17.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".17.8.1"><span data-reactid=".17.8.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".17.9" style="width: 165px;"><active data-reactid=".17.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".17.9.1"><span data-reactid=".17.9.1.0">精选留言 (10)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/259297" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>