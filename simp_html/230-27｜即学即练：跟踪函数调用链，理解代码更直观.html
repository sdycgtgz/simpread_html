
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 27｜即学即练：跟踪函数调用链，理解代码更直观</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>27｜即学即练：跟踪函数调用链，理解代码更直观</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">今天，我会讲解 Go 语言提供的另一种分支控制结构：switch 语句。和 if 分支语句相比，在一些执行分支较多的场景下，使用 switch 分支控制语</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 27｜即学即练：跟踪函数调用链，理解代码更直观</h1><div><span>Tony Bai</span> <span>2021-12-22</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/fb/28/fb5d036dec87115b27f81946c2302628.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：Tony Bai</span><span> 大小：20.16M</span><span> 时长：22:04</span></div></div><audio title="27｜即学即练：跟踪函数调用链，理解代码更直观" src="https://res001.geekbang.org/media/audio/c1/09/c15c48b02881e79ac737a53481f99209/ld/ld.m3u8" __idm_id__="253960"></audio></div><div><div><div><div data-slate-editor="true" data-key="8358" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="8359"><span data-slate-object="text" data-key="8360"><span data-slate-leaf="true" data-offset-key="8360:0" data-first-offset="true"><span data-slate-string="true">你好，我是 Tony Bai。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8361"><span data-slate-object="text" data-key="8362"><span data-slate-leaf="true" data-offset-key="8362:0" data-first-offset="true"><span data-slate-string="true">时间过得真快！转眼间我们已经完成了这门课基础篇 Go 语法部分的学习。在这一部分中，我们从变量声明开始，一直学到了 Go 函数与方法的设计，不知道你掌握得怎么样呢？基础篇的重点是</span></span></span><span data-slate-object="text" data-key="8363"><span data-slate-leaf="true" data-offset-key="8363:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">对 Go 基础语法部分的理解</span></span></span></span><span data-slate-object="text" data-key="8364"><span data-slate-leaf="true" data-offset-key="8364:0" data-first-offset="true"><span data-slate-string="true">，只有理解透了，我们才能在动手实践的环节运用自如。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8365"><span data-slate-object="text" data-key="8366"><span data-slate-leaf="true" data-offset-key="8366:0" data-first-offset="true"><span data-slate-string="true">同时，基础篇也是整个课程篇幅最多的部分，想必学到这里，你差不多也进入了一个 “疲劳期”。为了给你的大脑 “充充电”，我在这一讲，也就是基础篇的最后一讲中安排了一个小实战项目，适当放松一下，也希望你在实现这个实战项目的过程中，能对基础篇所学的内容做一个回顾与总结，夯实一下 Go 的语法基础。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8367" id="sr-toc-1"><span data-slate-object="text" data-key="8368"><span data-slate-leaf="true" data-offset-key="8368:0" data-first-offset="true"><span data-slate-string="true">引子</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8369"><span data-slate-object="text" data-key="8370"><span data-slate-leaf="true" data-offset-key="8370:0" data-first-offset="true"><span data-slate-string="true">在前面的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8371"><span data-slate-object="text" data-key="8372"><span data-slate-leaf="true" data-offset-key="8372:0" data-first-offset="true"><span data-slate-string="true">第 23 讲</span></span></span></a><span data-slate-object="text" data-key="8373"><span data-slate-leaf="true" data-offset-key="8373:0" data-first-offset="true"><span data-slate-string="true">中，我曾留过这样的一道思考题：“除了捕捉 panic、延迟释放资源外，我们日常编码中还有哪些使用 defer 的小技巧呢？”</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8374"><span data-slate-object="text" data-key="8375"><span data-slate-leaf="true" data-offset-key="8375:0" data-first-offset="true"><span data-slate-string="true">这个思考题得到了同学们的热烈响应，有同学在留言区提到：</span></span></span><span data-slate-object="text" data-key="8376"><span data-slate-leaf="true" data-offset-key="8376:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">使用 defer 可以跟踪函数的执行过程</span></span></span></span><span data-slate-object="text" data-key="8377"><span data-slate-leaf="true" data-offset-key="8377:0" data-first-offset="true"><span data-slate-string="true">。没错！这的确是 defer 的一个常见的使用技巧，很多 Go 教程在讲解 defer 时也会经常使用这个用途举例。那么，我们具体是怎么用 defer 来实现函数执行过程的跟踪呢？这里，我给出了一个最简单的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8378"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8379"><span data-slate-object="text" data-key="8380"><span data-slate-leaf="true" data-offset-key="8380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// trace.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8381"><span data-slate-object="text" data-key="8382"><span data-slate-leaf="true" data-offset-key="8382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="8383"><span data-slate-leaf="true" data-offset-key="8383:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8384"><span data-slate-object="text" data-key="8385"><span data-slate-leaf="true" data-offset-key="8385:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8386"><span data-slate-object="text" data-key="8387"><span data-slate-leaf="true" data-offset-key="8387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8388"><span data-slate-leaf="true" data-offset-key="8388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8389"><span data-slate-leaf="true" data-offset-key="8389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Trace</span></span></span></span></span><span data-slate-object="text" data-key="8390"><span data-slate-leaf="true" data-offset-key="8390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(name </span></span></span></span></span><span data-slate-object="text" data-key="8391"><span data-slate-leaf="true" data-offset-key="8391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="8392"><span data-slate-leaf="true" data-offset-key="8392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="8393"><span data-slate-leaf="true" data-offset-key="8393:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8394"><span data-slate-leaf="true" data-offset-key="8394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8395"><span data-slate-leaf="true" data-offset-key="8395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8396"><span data-slate-leaf="true" data-offset-key="8396:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8397"><span data-slate-object="text" data-key="8398"><span data-slate-leaf="true" data-offset-key="8398:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8399"><span data-slate-leaf="true" data-offset-key="8399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="8400"><span data-slate-leaf="true" data-offset-key="8400:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8401"><span data-slate-leaf="true" data-offset-key="8401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"enter:"</span></span></span></span><span data-slate-object="text" data-key="8402"><span data-slate-leaf="true" data-offset-key="8402:0" data-first-offset="true"><span data-slate-string="true">, name)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8403"><span data-slate-object="text" data-key="8404"><span data-slate-leaf="true" data-offset-key="8404:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8405"><span data-slate-leaf="true" data-offset-key="8405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8406"><span data-slate-leaf="true" data-offset-key="8406:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8407"><span data-slate-leaf="true" data-offset-key="8407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8408"><span data-slate-leaf="true" data-offset-key="8408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8409"><span data-slate-leaf="true" data-offset-key="8409:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8410"><span data-slate-object="text" data-key="8411"><span data-slate-leaf="true" data-offset-key="8411:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8412"><span data-slate-leaf="true" data-offset-key="8412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="8413"><span data-slate-leaf="true" data-offset-key="8413:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8414"><span data-slate-leaf="true" data-offset-key="8414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit:"</span></span></span></span><span data-slate-object="text" data-key="8415"><span data-slate-leaf="true" data-offset-key="8415:0" data-first-offset="true"><span data-slate-string="true">, name)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8416"><span data-slate-object="text" data-key="8417"><span data-slate-leaf="true" data-offset-key="8417:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8418"><span data-slate-object="text" data-key="8419"><span data-slate-leaf="true" data-offset-key="8419:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8420"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8421"><span data-slate-object="text" data-key="8422"><span data-slate-leaf="true" data-offset-key="8422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8423"><span data-slate-leaf="true" data-offset-key="8423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8424"><span data-slate-leaf="true" data-offset-key="8424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo</span></span></span></span></span><span data-slate-object="text" data-key="8425"><span data-slate-leaf="true" data-offset-key="8425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8426"><span data-slate-leaf="true" data-offset-key="8426:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8427"><span data-slate-object="text" data-key="8428"><span data-slate-leaf="true" data-offset-key="8428:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8429"><span data-slate-leaf="true" data-offset-key="8429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8430"><span data-slate-leaf="true" data-offset-key="8430:0" data-first-offset="true"><span data-slate-string="true"> Trace(</span></span></span><span data-slate-object="text" data-key="8431"><span data-slate-leaf="true" data-offset-key="8431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span><span data-slate-object="text" data-key="8432"><span data-slate-leaf="true" data-offset-key="8432:0" data-first-offset="true"><span data-slate-string="true">)()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8433"><span data-slate-object="text" data-key="8434"><span data-slate-leaf="true" data-offset-key="8434:0" data-first-offset="true"><span data-slate-string="true">    bar()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8435"><span data-slate-object="text" data-key="8436"><span data-slate-leaf="true" data-offset-key="8436:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8437"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8438"><span data-slate-object="text" data-key="8439"><span data-slate-leaf="true" data-offset-key="8439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8440"><span data-slate-leaf="true" data-offset-key="8440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8441"><span data-slate-leaf="true" data-offset-key="8441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="8442"><span data-slate-leaf="true" data-offset-key="8442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8443"><span data-slate-leaf="true" data-offset-key="8443:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8444"><span data-slate-object="text" data-key="8445"><span data-slate-leaf="true" data-offset-key="8445:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8446"><span data-slate-leaf="true" data-offset-key="8446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8447"><span data-slate-leaf="true" data-offset-key="8447:0" data-first-offset="true"><span data-slate-string="true"> Trace(</span></span></span><span data-slate-object="text" data-key="8448"><span data-slate-leaf="true" data-offset-key="8448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"bar"</span></span></span></span><span data-slate-object="text" data-key="8449"><span data-slate-leaf="true" data-offset-key="8449:0" data-first-offset="true"><span data-slate-string="true">)()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8450"><span data-slate-object="text" data-key="8451"><span data-slate-leaf="true" data-offset-key="8451:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8452"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8453"><span data-slate-object="text" data-key="8454"><span data-slate-leaf="true" data-offset-key="8454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8455"><span data-slate-leaf="true" data-offset-key="8455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8456"><span data-slate-leaf="true" data-offset-key="8456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="8457"><span data-slate-leaf="true" data-offset-key="8457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8458"><span data-slate-leaf="true" data-offset-key="8458:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8459"><span data-slate-object="text" data-key="8460"><span data-slate-leaf="true" data-offset-key="8460:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5bf26c3a" data-attr-id="33552" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="8461"><span data-slate-leaf="true" data-offset-key="8461:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5bf26c3a" data-attr-id="33552" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span></span><span data-slate-object="text" data-key="8462"><span data-slate-leaf="true" data-offset-key="8462:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5bf26c3a" data-attr-id="33552" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> Trace(</span></span></span></span><span data-slate-object="text" data-key="8463"><span data-slate-leaf="true" data-offset-key="8463:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5bf26c3a" data-attr-id="33552" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"main"</span></span></span></span></span><span data-slate-object="text" data-key="8464"><span data-slate-leaf="true" data-offset-key="8464:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5bf26c3a" data-attr-id="33552" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">)()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8465"><span data-slate-object="text" data-key="8466"><span data-slate-leaf="true" data-offset-key="8466:0" data-first-offset="true"><span data-slate-string="true">    foo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8467"><span data-slate-object="text" data-key="8468"><span data-slate-leaf="true" data-offset-key="8468:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8469"><span data-slate-object="text" data-key="8470"><span data-slate-leaf="true" data-offset-key="8470:0" data-first-offset="true"><span data-slate-string="true">在讲解这段代码的原理之前，我们先看一下这段代码的执行结果，直观感受一下什么是</span></span></span><span data-slate-object="text" data-key="8471"><span data-slate-leaf="true" data-offset-key="8471:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">函数调用跟踪</span></span></span></span><span data-slate-object="text" data-key="8472"><span data-slate-leaf="true" data-offset-key="8472:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="8473"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8474"><span data-slate-object="text" data-key="8475"><span data-slate-leaf="true" data-offset-key="8475:0" data-first-offset="true"><span data-slate-string="true">enter: main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8476"><span data-slate-object="text" data-key="8477"><span data-slate-leaf="true" data-offset-key="8477:0" data-first-offset="true"><span data-slate-string="true">enter: foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8478"><span data-slate-object="text" data-key="8479"><span data-slate-leaf="true" data-offset-key="8479:0" data-first-offset="true"><span data-slate-string="true">enter: bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8480"><span data-slate-object="text" data-key="8481"><span data-slate-leaf="true" data-offset-key="8481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="8482"><span data-slate-leaf="true" data-offset-key="8482:0" data-first-offset="true"><span data-slate-string="true">: bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8483"><span data-slate-object="text" data-key="8484"><span data-slate-leaf="true" data-offset-key="8484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="8485"><span data-slate-leaf="true" data-offset-key="8485:0" data-first-offset="true"><span data-slate-string="true">: foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8486"><span data-slate-object="text" data-key="8487"><span data-slate-leaf="true" data-offset-key="8487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="8488"><span data-slate-leaf="true" data-offset-key="8488:0" data-first-offset="true"><span data-slate-string="true">: main</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8489"><span data-slate-object="text" data-key="8490"><span data-slate-leaf="true" data-offset-key="8490:0" data-first-offset="true"><span data-slate-string="true">我们看到，这个 Go 程序的函数调用的全过程一目了然地展现在了我们面前：程序按</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8491"><span data-slate-object="text" data-key="8492"><span data-slate-leaf="true" data-offset-key="8492:0" data-first-offset="true"><span data-slate-string="true"> main -&gt; foo -&gt; bar</span></span></span></span><span data-slate-object="text" data-key="8493"><span data-slate-leaf="true" data-offset-key="8493:0" data-first-offset="true"><span data-slate-string="true"> 的函数调用次序执行，代码在函数的入口与出口处分别输出了跟踪日志。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8494"><span data-slate-object="text" data-key="8495"><span data-slate-leaf="true" data-offset-key="8495:0" data-first-offset="true"><span data-slate-string="true">那这段代码是怎么做到的呢？我们简要分析一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8496"><span data-slate-object="text" data-key="8497"><span data-slate-leaf="true" data-offset-key="8497:0" data-first-offset="true"><span data-slate-string="true">在这段实现中，我们在每个函数的入口处都使用 defer 设置了一个 deferred 函数。根据</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8498"><span data-slate-object="text" data-key="8499"><span data-slate-leaf="true" data-offset-key="8499:0" data-first-offset="true"><span data-slate-string="true">第 23 讲</span></span></span></a><span data-slate-object="text" data-key="8500"><span data-slate-leaf="true" data-offset-key="8500:0" data-first-offset="true"><span data-slate-string="true">中讲解的 defer 的运作机制，</span></span><span data-slate-leaf="true" data-offset-key="8500:1"><span data-slate-object="annotation" data-annotation-key="gkann_de8e1418" data-attr-id="33393" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Go 会在 defer 设置 deferred 函数时对 defer 后面的表达式进行求值。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8501"><span data-slate-object="text" data-key="8502"><span data-slate-leaf="true" data-offset-key="8502:0" data-first-offset="true"><span data-slate-string="true">我们以 foo 函数中的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8503"><span data-slate-object="text" data-key="8504"><span data-slate-leaf="true" data-offset-key="8504:0" data-first-offset="true"><span data-slate-string="true"> defer Trace("foo")()</span></span></span></span><span data-slate-object="text" data-key="8505"><span data-slate-leaf="true" data-offset-key="8505:0" data-first-offset="true"><span data-slate-string="true"> 这行代码为例，Go 会对 defer 后面的表达式</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8506"><span data-slate-object="text" data-key="8507"><span data-slate-leaf="true" data-offset-key="8507:0" data-first-offset="true"><span data-slate-string="true"> Trace("foo")()</span></span></span></span><span data-slate-object="text" data-key="8508"><span data-slate-leaf="true" data-offset-key="8508:0" data-first-offset="true"><span data-slate-string="true"> 进行求值。由于这个表达式包含一个函数调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8509"><span data-slate-object="text" data-key="8510"><span data-slate-leaf="true" data-offset-key="8510:0" data-first-offset="true"><span data-slate-string="true"> Trace("foo")</span></span></span></span><span data-slate-object="text" data-key="8511"><span data-slate-leaf="true" data-offset-key="8511:0" data-first-offset="true"><span data-slate-string="true">，所以这个函数会被执行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8512"><span data-slate-object="text" data-key="8513"><span data-slate-leaf="true" data-offset-key="8513:0" data-first-offset="true"><span data-slate-string="true">上面的 Trace 函数只接受一个参数，˙这个参数代表函数名，Trace 会首先打印进入某函数的日志，比如：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8514"><span data-slate-object="text" data-key="8515"><span data-slate-leaf="true" data-offset-key="8515:0" data-first-offset="true"><span data-slate-string="true">“enter: foo”</span></span></span></span><span data-slate-object="text" data-key="8516"><span data-slate-leaf="true" data-offset-key="8516:0" data-first-offset="true"><span data-slate-string="true">。然后返回一个闭包函数，这个闭包函数一旦被执行，就会输出离开某函数的日志。在 foo 函数中，这个由 Trace 函数返回的闭包函数就被设置为了 deferred 函数，于是当 foo 函数返回后，这个闭包函数就会被执行，输出</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8517"><span data-slate-object="text" data-key="8518"><span data-slate-leaf="true" data-offset-key="8518:0" data-first-offset="true"><span data-slate-string="true"> “exit: foo”</span></span></span></span><span data-slate-object="text" data-key="8519"><span data-slate-leaf="true" data-offset-key="8519:0" data-first-offset="true"><span data-slate-string="true"> 的日志。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8520"><span data-slate-object="text" data-key="8521"><span data-slate-leaf="true" data-offset-key="8521:0" data-first-offset="true"><span data-slate-string="true">搞清楚上面跟踪函数调用链的实现原理后，我们再来看看这个实现。我们会发现这里还是有一些</span></span></span><span data-slate-object="text" data-key="8522"><span data-slate-leaf="true" data-offset-key="8522:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “瑕疵”</span></span></span></span><span data-slate-object="text" data-key="8523"><span data-slate-leaf="true" data-offset-key="8523:0" data-first-offset="true"><span data-slate-string="true">，也就是离我们期望的 “跟踪函数调用链” 的实现还有一些不足之处。这里我列举了几点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8524"><div data-slate-type="list-line" data-slate-object="block" data-key="8525"><span data-slate-object="text" data-key="8526"><span data-slate-leaf="true" data-offset-key="8526:0" data-first-offset="true"><span data-slate-string="true">调用 Trace 时需手动显式传入要跟踪的函数名；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8527"><span data-slate-object="text" data-key="8528"><span data-slate-leaf="true" data-offset-key="8528:0" data-first-offset="true"><span data-slate-string="true">如果是并发应用，不同 Goroutine 中函数链跟踪混在一起无法分辨；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8529"><span data-slate-object="text" data-key="8530"><span data-slate-leaf="true" data-offset-key="8530:0" data-first-offset="true"><span data-slate-string="true">输出的跟踪结果缺少层次感，调用关系不易识别；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8531"><span data-slate-object="text" data-key="8532"><span data-slate-leaf="true" data-offset-key="8532:0" data-first-offset="true"><span data-slate-string="true">对要跟踪的函数，需手动调用 Trace 函数。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8533"><span data-slate-object="text" data-key="8534"><span data-slate-leaf="true" data-offset-key="8534:0" data-first-offset="true"><span data-slate-string="true">那么，这一讲我们的任务就是逐一分析并解决上面提出的这几点问题进行，经过逐步地代码演进，最终</span></span></span><span data-slate-object="text" data-key="8535"><span data-slate-leaf="true" data-offset-key="8535:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">实现一个自动注入跟踪代码，并输出有层次感的函数调用链跟踪命令行工具</span></span></span></span><span data-slate-object="text" data-key="8536"><span data-slate-leaf="true" data-offset-key="8536:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8537"><span data-slate-object="text" data-key="8538"><span data-slate-leaf="true" data-offset-key="8538:0" data-first-offset="true"><span data-slate-string="true">好，下面我们先来解决第一个问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8539" id="sr-toc-2"><span data-slate-object="text" data-key="8540"><span data-slate-leaf="true" data-offset-key="8540:0" data-first-offset="true"><span data-slate-string="true">自动获取所跟踪函数的函数名</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8541"><span data-slate-object="text" data-key="8542"><span data-slate-leaf="true" data-offset-key="8542:0" data-first-offset="true"><span data-slate-string="true">要解决 “调用 Trace 时需要手动显式传入要跟踪的函数名” 的问题，也就是要让我们的 Trace 函数能够自动获取到它跟踪函数的函数名信息。我们以跟踪 foo 为例，看看这样做能给我们带来什么好处。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8543"><span data-slate-object="text" data-key="8544"><span data-slate-leaf="true" data-offset-key="8544:0" data-first-offset="true"><span data-slate-string="true">在手动显式传入的情况下，我们需要用下面这个代码对 foo 进行跟踪：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="8545"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8546"><span data-slate-object="text" data-key="8547"><span data-slate-leaf="true" data-offset-key="8547:0" data-first-offset="true"><span data-slate-string="true">defer </span></span></span><span data-slate-object="text" data-key="8548"><span data-slate-leaf="true" data-offset-key="8548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Trace</span></span></span></span><span data-slate-object="text" data-key="8549"><span data-slate-leaf="true" data-offset-key="8549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="8550"><span data-slate-leaf="true" data-offset-key="8550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span></span><span data-slate-object="text" data-key="8551"><span data-slate-leaf="true" data-offset-key="8551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span><span data-slate-object="text" data-key="8552"><span data-slate-leaf="true" data-offset-key="8552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8553"><span data-slate-object="text" data-key="8554"><span data-slate-leaf="true" data-offset-key="8554:0" data-first-offset="true"><span data-slate-string="true">一旦实现了自动获取函数名，所有支持函数调用链跟踪的函数都只需使用下面调用形式的 Trace 函数就可以了：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="8555"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8556"><span data-slate-object="text" data-key="8557"><span data-slate-leaf="true" data-offset-key="8557:0" data-first-offset="true"><span data-slate-string="true">defer </span></span></span><span data-slate-object="text" data-key="8558"><span data-slate-leaf="true" data-offset-key="8558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Trace</span></span></span></span><span data-slate-object="text" data-key="8559"><span data-slate-leaf="true" data-offset-key="8559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="8560"><span data-slate-leaf="true" data-offset-key="8560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8561"><span data-slate-object="text" data-key="8562"><span data-slate-leaf="true" data-offset-key="8562:0" data-first-offset="true"><span data-slate-string="true">这种一致的 Trace 函数调用方式也为后续的自动向代码中注入 Trace 函数奠定了基础。那么如何实现 Trace 函数对它跟踪函数名的自动获取呢？我们需要借助 Go 标准库 runtime 包的帮助。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8563"><span data-slate-object="text" data-key="8564"><span data-slate-leaf="true" data-offset-key="8564:0" data-first-offset="true"><span data-slate-string="true">这里，我给出了新版 Trace 函数的实现以及它的使用方法，我们先看一下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8565"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8566"><span data-slate-object="text" data-key="8567"><span data-slate-leaf="true" data-offset-key="8567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// trace1/trace.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8568"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8569"><span data-slate-object="text" data-key="8570"><span data-slate-leaf="true" data-offset-key="8570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8571"><span data-slate-leaf="true" data-offset-key="8571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8572"><span data-slate-leaf="true" data-offset-key="8572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Trace</span></span></span></span></span><span data-slate-object="text" data-key="8573"><span data-slate-leaf="true" data-offset-key="8573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8574"><span data-slate-leaf="true" data-offset-key="8574:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8575"><span data-slate-leaf="true" data-offset-key="8575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8576"><span data-slate-leaf="true" data-offset-key="8576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8577"><span data-slate-leaf="true" data-offset-key="8577:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8578"><span data-slate-object="text" data-key="8579"><span data-slate-leaf="true" data-offset-key="8579:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_00beb1d2" data-attr-id="32760" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    pc, _, _, ok := runtime.Caller(</span></span></span></span><span data-slate-object="text" data-key="8580"><span data-slate-leaf="true" data-offset-key="8580:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_00beb1d2" data-attr-id="32760" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></span><span data-slate-object="text" data-key="8581"><span data-slate-leaf="true" data-offset-key="8581:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_00beb1d2" data-attr-id="32760" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8582"><span data-slate-object="text" data-key="8583"><span data-slate-leaf="true" data-offset-key="8583:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8584"><span data-slate-leaf="true" data-offset-key="8584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8585"><span data-slate-leaf="true" data-offset-key="8585:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8586"><span data-slate-object="text" data-key="8587"><span data-slate-leaf="true" data-offset-key="8587:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8588"><span data-slate-leaf="true" data-offset-key="8588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="8589"><span data-slate-leaf="true" data-offset-key="8589:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8590"><span data-slate-leaf="true" data-offset-key="8590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"not found caller"</span></span></span></span><span data-slate-object="text" data-key="8591"><span data-slate-leaf="true" data-offset-key="8591:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8592"><span data-slate-object="text" data-key="8593"><span data-slate-leaf="true" data-offset-key="8593:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8594"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8595"><span data-slate-object="text" data-key="8596"><span data-slate-leaf="true" data-offset-key="8596:0" data-first-offset="true"><span data-slate-string="true">    fn := runtime.FuncForPC(pc)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8597"><span data-slate-object="text" data-key="8598"><span data-slate-leaf="true" data-offset-key="8598:0" data-first-offset="true"><span data-slate-string="true">    name := fn.Name()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8599"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8600"><span data-slate-object="text" data-key="8601"><span data-slate-leaf="true" data-offset-key="8601:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8602"><span data-slate-leaf="true" data-offset-key="8602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="8603"><span data-slate-leaf="true" data-offset-key="8603:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8604"><span data-slate-leaf="true" data-offset-key="8604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"enter:"</span></span></span></span><span data-slate-object="text" data-key="8605"><span data-slate-leaf="true" data-offset-key="8605:0" data-first-offset="true"><span data-slate-string="true">, name)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8606"><span data-slate-object="text" data-key="8607"><span data-slate-leaf="true" data-offset-key="8607:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8608"><span data-slate-leaf="true" data-offset-key="8608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8609"><span data-slate-leaf="true" data-offset-key="8609:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8610"><span data-slate-leaf="true" data-offset-key="8610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8611"><span data-slate-leaf="true" data-offset-key="8611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8612"><span data-slate-leaf="true" data-offset-key="8612:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="8613"><span data-slate-leaf="true" data-offset-key="8613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="8614"><span data-slate-leaf="true" data-offset-key="8614:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8615"><span data-slate-leaf="true" data-offset-key="8615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit:"</span></span></span></span><span data-slate-object="text" data-key="8616"><span data-slate-leaf="true" data-offset-key="8616:0" data-first-offset="true"><span data-slate-string="true">, name) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8617"><span data-slate-object="text" data-key="8618"><span data-slate-leaf="true" data-offset-key="8618:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8619"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8620"><span data-slate-object="text" data-key="8621"><span data-slate-leaf="true" data-offset-key="8621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8622"><span data-slate-leaf="true" data-offset-key="8622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8623"><span data-slate-leaf="true" data-offset-key="8623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo</span></span></span></span></span><span data-slate-object="text" data-key="8624"><span data-slate-leaf="true" data-offset-key="8624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8625"><span data-slate-leaf="true" data-offset-key="8625:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8626"><span data-slate-object="text" data-key="8627"><span data-slate-leaf="true" data-offset-key="8627:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8628"><span data-slate-leaf="true" data-offset-key="8628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8629"><span data-slate-leaf="true" data-offset-key="8629:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8630"><span data-slate-object="text" data-key="8631"><span data-slate-leaf="true" data-offset-key="8631:0" data-first-offset="true"><span data-slate-string="true">    bar()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8632"><span data-slate-object="text" data-key="8633"><span data-slate-leaf="true" data-offset-key="8633:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8634"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8635"><span data-slate-object="text" data-key="8636"><span data-slate-leaf="true" data-offset-key="8636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8637"><span data-slate-leaf="true" data-offset-key="8637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8638"><span data-slate-leaf="true" data-offset-key="8638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="8639"><span data-slate-leaf="true" data-offset-key="8639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8640"><span data-slate-leaf="true" data-offset-key="8640:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8641"><span data-slate-object="text" data-key="8642"><span data-slate-leaf="true" data-offset-key="8642:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8643"><span data-slate-leaf="true" data-offset-key="8643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8644"><span data-slate-leaf="true" data-offset-key="8644:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8645"><span data-slate-object="text" data-key="8646"><span data-slate-leaf="true" data-offset-key="8646:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8647"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8648"><span data-slate-object="text" data-key="8649"><span data-slate-leaf="true" data-offset-key="8649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8650"><span data-slate-leaf="true" data-offset-key="8650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8651"><span data-slate-leaf="true" data-offset-key="8651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="8652"><span data-slate-leaf="true" data-offset-key="8652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8653"><span data-slate-leaf="true" data-offset-key="8653:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8654"><span data-slate-object="text" data-key="8655"><span data-slate-leaf="true" data-offset-key="8655:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8656"><span data-slate-leaf="true" data-offset-key="8656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8657"><span data-slate-leaf="true" data-offset-key="8657:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8658"><span data-slate-object="text" data-key="8659"><span data-slate-leaf="true" data-offset-key="8659:0" data-first-offset="true"><span data-slate-string="true">    foo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8660"><span data-slate-object="text" data-key="8661"><span data-slate-leaf="true" data-offset-key="8661:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8662"><span data-slate-object="text" data-key="8663"><span data-slate-leaf="true" data-offset-key="8663:0" data-first-offset="true"><span data-slate-string="true">在这一版 Trace 函数中，我们通过 runtime.Caller 函数获得当前 Goroutine 的函数调用栈上的信息，runtime.Caller 的参数标识的是要获取的是哪一个栈帧的信息。当参数为 0 时，返回的是 Caller 函数的调用者的函数信息，在这里就是 Trace 函数。</span></span><span data-slate-leaf="true" data-offset-key="8663:1"><span data-slate-object="annotation" data-annotation-key="gkann_862f5fb3" data-attr-id="42602" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_46bc4401" data-attr-id="32685" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">但我们需要的是 Trace 函数的调用者的信息，于是我们传入 1。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8664"><span data-slate-object="text" data-key="8665"><span data-slate-leaf="true" data-offset-key="8665:0" data-first-offset="true"><span data-slate-string="true">Caller 函数有四个返回值：第一个返回值代表的是程序计数（pc）；第二个和第三个参数代表对应函数所在的源文件名以及所在行数，这里我们暂时不需要；最后一个参数代表是否能成功获取这些信息，如果获取失败，我们抛出 panic。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8666"><span data-slate-object="text" data-key="8667"><span data-slate-leaf="true" data-offset-key="8667:0" data-first-offset="true"><span data-slate-string="true">接下来，我们通过 runtime.FuncForPC 函数和程序计数器（PC）得到被跟踪函数的函数名称。我们运行一下改造后代码：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="8668"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8669"><span data-slate-object="text" data-key="8670"><span data-slate-leaf="true" data-offset-key="8670:0" data-first-offset="true"><span data-slate-string="true">enter: main.main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8671"><span data-slate-object="text" data-key="8672"><span data-slate-leaf="true" data-offset-key="8672:0" data-first-offset="true"><span data-slate-string="true">enter: main.foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8673"><span data-slate-object="text" data-key="8674"><span data-slate-leaf="true" data-offset-key="8674:0" data-first-offset="true"><span data-slate-string="true">enter: main.bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8675"><span data-slate-object="text" data-key="8676"><span data-slate-leaf="true" data-offset-key="8676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="8677"><span data-slate-leaf="true" data-offset-key="8677:0" data-first-offset="true"><span data-slate-string="true">: main.bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8678"><span data-slate-object="text" data-key="8679"><span data-slate-leaf="true" data-offset-key="8679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="8680"><span data-slate-leaf="true" data-offset-key="8680:0" data-first-offset="true"><span data-slate-string="true">: main.foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8681"><span data-slate-object="text" data-key="8682"><span data-slate-leaf="true" data-offset-key="8682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="8683"><span data-slate-leaf="true" data-offset-key="8683:0" data-first-offset="true"><span data-slate-string="true">: main.main</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8684"><span data-slate-object="text" data-key="8685"><span data-slate-leaf="true" data-offset-key="8685:0" data-first-offset="true"><span data-slate-string="true">我们看到，runtime.FuncForPC 返回的名称中不仅仅包含函数名，还包含了被跟踪函数所在的包名。也就是说，我们第一个问题已经圆满解决了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8686"><span data-slate-object="text" data-key="8687"><span data-slate-leaf="true" data-offset-key="8687:0" data-first-offset="true"><span data-slate-string="true">接下来，我们来解决第二个问题，也就是当程序中有多 Goroutine 时，Trace 输出的跟踪信息混杂在一起难以分辨的问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8688" id="sr-toc-3"><span data-slate-object="text" data-key="8689"><span data-slate-leaf="true" data-offset-key="8689:0" data-first-offset="true"><span data-slate-string="true">增加 Goroutine 标识</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8690"><span data-slate-object="text" data-key="8691"><span data-slate-leaf="true" data-offset-key="8691:0" data-first-offset="true"><span data-slate-string="true">上面的 Trace 函数在面对只有一个 Goroutine 的时候，还是可以支撑的，但当程序中并发运行多个 Goroutine 的时候，多个函数调用链的出入口信息输出就会混杂在一起，无法分辨。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8692"><span data-slate-object="text" data-key="8693"><span data-slate-leaf="true" data-offset-key="8693:0" data-first-offset="true"><span data-slate-string="true">那么，接下来我们还继续对 Trace 函数进行改造，让它支持多 Goroutine 函数调用链的跟踪。我们的方案就是</span></span></span><span data-slate-object="text" data-key="8694"><span data-slate-leaf="true" data-offset-key="8694:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在输出的函数出入口信息时，带上一个在程序每次执行时能唯一区分 Goroutine 的 Goroutine ID</span></span></span></span><span data-slate-object="text" data-key="8695"><span data-slate-leaf="true" data-offset-key="8695:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8696"><span data-slate-object="text" data-key="8697"><span data-slate-leaf="true" data-offset-key="8697:0" data-first-offset="true"><span data-slate-string="true">到这里，你可能会说，Goroutine 也没有 ID 信息啊！的确如此，Go 核心团队为了避免 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8698"><span data-slate-object="text" data-key="8699"><span data-slate-leaf="true" data-offset-key="8699:0" data-first-offset="true"><span data-slate-string="true">Goroutine ID 的滥用</span></span></span></a><span data-slate-object="text" data-key="8700"><span data-slate-leaf="true" data-offset-key="8700:0" data-first-offset="true"><span data-slate-string="true">，故意没有将 Goroutine ID 暴露给开发者。但在 Go 标准库的 h2_bundle.go 中，我们却发现了一个获取 Goroutine ID 的标准方法，看下面代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8701"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8702"><span data-slate-object="text" data-key="8703"><span data-slate-leaf="true" data-offset-key="8703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/net/http/h2_bundle.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8704"><span data-slate-object="text" data-key="8705"><span data-slate-leaf="true" data-offset-key="8705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8706"><span data-slate-leaf="true" data-offset-key="8706:0" data-first-offset="true"><span data-slate-string="true"> http2goroutineSpace = []</span></span></span><span data-slate-object="text" data-key="8707"><span data-slate-leaf="true" data-offset-key="8707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="8708"><span data-slate-leaf="true" data-offset-key="8708:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8709"><span data-slate-leaf="true" data-offset-key="8709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"goroutine"</span></span></span></span><span data-slate-object="text" data-key="8710"><span data-slate-leaf="true" data-offset-key="8710:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8711"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8712"><span data-slate-object="text" data-key="8713"><span data-slate-leaf="true" data-offset-key="8713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8714"><span data-slate-leaf="true" data-offset-key="8714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8715"><span data-slate-leaf="true" data-offset-key="8715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">http2curGoroutineID</span></span></span></span></span><span data-slate-object="text" data-key="8716"><span data-slate-leaf="true" data-offset-key="8716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8717"><span data-slate-leaf="true" data-offset-key="8717:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8718"><span data-slate-leaf="true" data-offset-key="8718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="8719"><span data-slate-leaf="true" data-offset-key="8719:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8720"><span data-slate-object="text" data-key="8721"><span data-slate-leaf="true" data-offset-key="8721:0" data-first-offset="true"><span data-slate-string="true">    bp := http2littleBuf.Get().(*[]</span></span></span><span data-slate-object="text" data-key="8722"><span data-slate-leaf="true" data-offset-key="8722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="8723"><span data-slate-leaf="true" data-offset-key="8723:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8724"><span data-slate-object="text" data-key="8725"><span data-slate-leaf="true" data-offset-key="8725:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8726"><span data-slate-leaf="true" data-offset-key="8726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8727"><span data-slate-leaf="true" data-offset-key="8727:0" data-first-offset="true"><span data-slate-string="true"> http2littleBuf.Put(bp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8728"><span data-slate-object="text" data-key="8729"><span data-slate-leaf="true" data-offset-key="8729:0" data-first-offset="true"><span data-slate-string="true">    b := *bp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8730"><span data-slate-object="text" data-key="8731"><span data-slate-leaf="true" data-offset-key="8731:0" data-first-offset="true"><span data-slate-string="true">    b = b[:runtime.Stack(b, </span></span></span><span data-slate-object="text" data-key="8732"><span data-slate-leaf="true" data-offset-key="8732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="8733"><span data-slate-leaf="true" data-offset-key="8733:0" data-first-offset="true"><span data-slate-string="true">)]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8734"><span data-slate-object="text" data-key="8735"><span data-slate-leaf="true" data-offset-key="8735:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8736"><span data-slate-leaf="true" data-offset-key="8736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Parse the 4707 out of "goroutine 4707 ["</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8737"><span data-slate-object="text" data-key="8738"><span data-slate-leaf="true" data-offset-key="8738:0" data-first-offset="true"><span data-slate-string="true">    b = bytes.TrimPrefix(b, http2goroutineSpace)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8739"><span data-slate-object="text" data-key="8740"><span data-slate-leaf="true" data-offset-key="8740:0" data-first-offset="true"><span data-slate-string="true">    i := bytes.IndexByte(b, </span></span></span><span data-slate-object="text" data-key="8741"><span data-slate-leaf="true" data-offset-key="8741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">' '</span></span></span></span><span data-slate-object="text" data-key="8742"><span data-slate-leaf="true" data-offset-key="8742:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8743"><span data-slate-object="text" data-key="8744"><span data-slate-leaf="true" data-offset-key="8744:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8745"><span data-slate-leaf="true" data-offset-key="8745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8746"><span data-slate-leaf="true" data-offset-key="8746:0" data-first-offset="true"><span data-slate-string="true"> i &lt; </span></span></span><span data-slate-object="text" data-key="8747"><span data-slate-leaf="true" data-offset-key="8747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8748"><span data-slate-leaf="true" data-offset-key="8748:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8749"><span data-slate-object="text" data-key="8750"><span data-slate-leaf="true" data-offset-key="8750:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8751"><span data-slate-leaf="true" data-offset-key="8751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="8752"><span data-slate-leaf="true" data-offset-key="8752:0" data-first-offset="true"><span data-slate-string="true">(fmt.Sprintf(</span></span></span><span data-slate-object="text" data-key="8753"><span data-slate-leaf="true" data-offset-key="8753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"No space found in %q"</span></span></span></span><span data-slate-object="text" data-key="8754"><span data-slate-leaf="true" data-offset-key="8754:0" data-first-offset="true"><span data-slate-string="true">, b))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8755"><span data-slate-object="text" data-key="8756"><span data-slate-leaf="true" data-offset-key="8756:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8757"><span data-slate-object="text" data-key="8758"><span data-slate-leaf="true" data-offset-key="8758:0" data-first-offset="true"><span data-slate-string="true">    b = b[:i]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8759"><span data-slate-object="text" data-key="8760"><span data-slate-leaf="true" data-offset-key="8760:0" data-first-offset="true"><span data-slate-string="true">    n, err := http2parseUintBytes(b, </span></span></span><span data-slate-object="text" data-key="8761"><span data-slate-leaf="true" data-offset-key="8761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="8762"><span data-slate-leaf="true" data-offset-key="8762:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="8763"><span data-slate-leaf="true" data-offset-key="8763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="8764"><span data-slate-leaf="true" data-offset-key="8764:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8765"><span data-slate-object="text" data-key="8766"><span data-slate-leaf="true" data-offset-key="8766:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8767"><span data-slate-leaf="true" data-offset-key="8767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8768"><span data-slate-leaf="true" data-offset-key="8768:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8769"><span data-slate-leaf="true" data-offset-key="8769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8770"><span data-slate-leaf="true" data-offset-key="8770:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8771"><span data-slate-object="text" data-key="8772"><span data-slate-leaf="true" data-offset-key="8772:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8773"><span data-slate-leaf="true" data-offset-key="8773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="8774"><span data-slate-leaf="true" data-offset-key="8774:0" data-first-offset="true"><span data-slate-string="true">(fmt.Sprintf(</span></span></span><span data-slate-object="text" data-key="8775"><span data-slate-leaf="true" data-offset-key="8775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Failed to parse goroutine ID out of %q: %v"</span></span></span></span><span data-slate-object="text" data-key="8776"><span data-slate-leaf="true" data-offset-key="8776:0" data-first-offset="true"><span data-slate-string="true">, b, err))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8777"><span data-slate-object="text" data-key="8778"><span data-slate-leaf="true" data-offset-key="8778:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8779"><span data-slate-object="text" data-key="8780"><span data-slate-leaf="true" data-offset-key="8780:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8781"><span data-slate-leaf="true" data-offset-key="8781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8782"><span data-slate-leaf="true" data-offset-key="8782:0" data-first-offset="true"><span data-slate-string="true"> n</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8783"><span data-slate-object="text" data-key="8784"><span data-slate-leaf="true" data-offset-key="8784:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8785"><span data-slate-object="text" data-key="8786"><span data-slate-leaf="true" data-offset-key="8786:0" data-first-offset="true"><span data-slate-string="true">不过，由于 http2curGoroutineID 不是一个导出函数，我们无法直接使用。我们可以把它复制出来改造一下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8787"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8788"><span data-slate-object="text" data-key="8789"><span data-slate-leaf="true" data-offset-key="8789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// trace2/trace.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8790"><span data-slate-object="text" data-key="8791"><span data-slate-leaf="true" data-offset-key="8791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8792"><span data-slate-leaf="true" data-offset-key="8792:0" data-first-offset="true"><span data-slate-string="true"> goroutineSpace = []</span></span></span><span data-slate-object="text" data-key="8793"><span data-slate-leaf="true" data-offset-key="8793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="8794"><span data-slate-leaf="true" data-offset-key="8794:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8795"><span data-slate-leaf="true" data-offset-key="8795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"goroutine"</span></span></span></span><span data-slate-object="text" data-key="8796"><span data-slate-leaf="true" data-offset-key="8796:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8797"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8798"><span data-slate-object="text" data-key="8799"><span data-slate-leaf="true" data-offset-key="8799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8800"><span data-slate-leaf="true" data-offset-key="8800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8801"><span data-slate-leaf="true" data-offset-key="8801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curGoroutineID</span></span></span></span></span><span data-slate-object="text" data-key="8802"><span data-slate-leaf="true" data-offset-key="8802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8803"><span data-slate-leaf="true" data-offset-key="8803:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8804"><span data-slate-leaf="true" data-offset-key="8804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="8805"><span data-slate-leaf="true" data-offset-key="8805:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8806"><span data-slate-object="text" data-key="8807"><span data-slate-leaf="true" data-offset-key="8807:0" data-first-offset="true"><span data-slate-string="true">    b := </span></span></span><span data-slate-object="text" data-key="8808"><span data-slate-leaf="true" data-offset-key="8808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="8809"><span data-slate-leaf="true" data-offset-key="8809:0" data-first-offset="true"><span data-slate-string="true">([]</span></span></span><span data-slate-object="text" data-key="8810"><span data-slate-leaf="true" data-offset-key="8810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="8811"><span data-slate-leaf="true" data-offset-key="8811:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="8812"><span data-slate-leaf="true" data-offset-key="8812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="8813"><span data-slate-leaf="true" data-offset-key="8813:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8814"><span data-slate-object="text" data-key="8815"><span data-slate-leaf="true" data-offset-key="8815:0" data-first-offset="true"><span data-slate-string="true">    b = b[:runtime.Stack(b, </span></span></span><span data-slate-object="text" data-key="8816"><span data-slate-leaf="true" data-offset-key="8816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="8817"><span data-slate-leaf="true" data-offset-key="8817:0" data-first-offset="true"><span data-slate-string="true">)]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8818"><span data-slate-object="text" data-key="8819"><span data-slate-leaf="true" data-offset-key="8819:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8820"><span data-slate-leaf="true" data-offset-key="8820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Parse the 4707 out of "goroutine 4707 ["</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8821"><span data-slate-object="text" data-key="8822"><span data-slate-leaf="true" data-offset-key="8822:0" data-first-offset="true"><span data-slate-string="true">    b = bytes.TrimPrefix(b, goroutineSpace)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8823"><span data-slate-object="text" data-key="8824"><span data-slate-leaf="true" data-offset-key="8824:0" data-first-offset="true"><span data-slate-string="true">    i := bytes.IndexByte(b, </span></span></span><span data-slate-object="text" data-key="8825"><span data-slate-leaf="true" data-offset-key="8825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">' '</span></span></span></span><span data-slate-object="text" data-key="8826"><span data-slate-leaf="true" data-offset-key="8826:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8827"><span data-slate-object="text" data-key="8828"><span data-slate-leaf="true" data-offset-key="8828:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8829"><span data-slate-leaf="true" data-offset-key="8829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8830"><span data-slate-leaf="true" data-offset-key="8830:0" data-first-offset="true"><span data-slate-string="true"> i &lt; </span></span></span><span data-slate-object="text" data-key="8831"><span data-slate-leaf="true" data-offset-key="8831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8832"><span data-slate-leaf="true" data-offset-key="8832:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8833"><span data-slate-object="text" data-key="8834"><span data-slate-leaf="true" data-offset-key="8834:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8835"><span data-slate-leaf="true" data-offset-key="8835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="8836"><span data-slate-leaf="true" data-offset-key="8836:0" data-first-offset="true"><span data-slate-string="true">(fmt.Sprintf(</span></span></span><span data-slate-object="text" data-key="8837"><span data-slate-leaf="true" data-offset-key="8837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"No space found in %q"</span></span></span></span><span data-slate-object="text" data-key="8838"><span data-slate-leaf="true" data-offset-key="8838:0" data-first-offset="true"><span data-slate-string="true">, b))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8839"><span data-slate-object="text" data-key="8840"><span data-slate-leaf="true" data-offset-key="8840:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8841"><span data-slate-object="text" data-key="8842"><span data-slate-leaf="true" data-offset-key="8842:0" data-first-offset="true"><span data-slate-string="true">    b = b[:i]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8843"><span data-slate-object="text" data-key="8844"><span data-slate-leaf="true" data-offset-key="8844:0" data-first-offset="true"><span data-slate-string="true">    n, err := strconv.ParseUint(</span></span></span><span data-slate-object="text" data-key="8845"><span data-slate-leaf="true" data-offset-key="8845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="8846"><span data-slate-leaf="true" data-offset-key="8846:0" data-first-offset="true"><span data-slate-string="true">(b), </span></span></span><span data-slate-object="text" data-key="8847"><span data-slate-leaf="true" data-offset-key="8847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="8848"><span data-slate-leaf="true" data-offset-key="8848:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="8849"><span data-slate-leaf="true" data-offset-key="8849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="8850"><span data-slate-leaf="true" data-offset-key="8850:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8851"><span data-slate-object="text" data-key="8852"><span data-slate-leaf="true" data-offset-key="8852:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8853"><span data-slate-leaf="true" data-offset-key="8853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8854"><span data-slate-leaf="true" data-offset-key="8854:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8855"><span data-slate-leaf="true" data-offset-key="8855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8856"><span data-slate-leaf="true" data-offset-key="8856:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8857"><span data-slate-object="text" data-key="8858"><span data-slate-leaf="true" data-offset-key="8858:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8859"><span data-slate-leaf="true" data-offset-key="8859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="8860"><span data-slate-leaf="true" data-offset-key="8860:0" data-first-offset="true"><span data-slate-string="true">(fmt.Sprintf(</span></span></span><span data-slate-object="text" data-key="8861"><span data-slate-leaf="true" data-offset-key="8861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Failed to parse goroutine ID out of %q: %v"</span></span></span></span><span data-slate-object="text" data-key="8862"><span data-slate-leaf="true" data-offset-key="8862:0" data-first-offset="true"><span data-slate-string="true">, b, err))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8863"><span data-slate-object="text" data-key="8864"><span data-slate-leaf="true" data-offset-key="8864:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8865"><span data-slate-object="text" data-key="8866"><span data-slate-leaf="true" data-offset-key="8866:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8867"><span data-slate-leaf="true" data-offset-key="8867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8868"><span data-slate-leaf="true" data-offset-key="8868:0" data-first-offset="true"><span data-slate-string="true"> n</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8869"><span data-slate-object="text" data-key="8870"><span data-slate-leaf="true" data-offset-key="8870:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8871"><span data-slate-object="text" data-key="8872"><span data-slate-leaf="true" data-offset-key="8872:0" data-first-offset="true"><span data-slate-string="true">这里，我们改造了两个地方。一个地方是通过直接创建一个 byte 切片赋值给 b，替代原 http2curGoroutineID 函数中从一个 pool 池获取 byte 切片的方式，另外一个是使用 strconv.ParseUint 替代了原先的 http2parseUintBytes。改造后，我们就可以直接使用 curGoroutineID 函数来获取 Goroutine 的 ID 信息了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8873"><span data-slate-object="text" data-key="8874"><span data-slate-leaf="true" data-offset-key="8874:0" data-first-offset="true"><span data-slate-string="true">好，接下来，我们在 Trace 函数中添加 Goroutine ID 信息的输出：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8875"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8876"><span data-slate-object="text" data-key="8877"><span data-slate-leaf="true" data-offset-key="8877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// trace2/trace.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8878"><span data-slate-object="text" data-key="8879"><span data-slate-leaf="true" data-offset-key="8879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8880"><span data-slate-leaf="true" data-offset-key="8880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8881"><span data-slate-leaf="true" data-offset-key="8881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Trace</span></span></span></span></span><span data-slate-object="text" data-key="8882"><span data-slate-leaf="true" data-offset-key="8882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8883"><span data-slate-leaf="true" data-offset-key="8883:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8884"><span data-slate-leaf="true" data-offset-key="8884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8885"><span data-slate-leaf="true" data-offset-key="8885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8886"><span data-slate-leaf="true" data-offset-key="8886:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8887"><span data-slate-object="text" data-key="8888"><span data-slate-leaf="true" data-offset-key="8888:0" data-first-offset="true"><span data-slate-string="true">    pc, _, _, ok := runtime.Caller(</span></span></span><span data-slate-object="text" data-key="8889"><span data-slate-leaf="true" data-offset-key="8889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="8890"><span data-slate-leaf="true" data-offset-key="8890:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8891"><span data-slate-object="text" data-key="8892"><span data-slate-leaf="true" data-offset-key="8892:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8893"><span data-slate-leaf="true" data-offset-key="8893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8894"><span data-slate-leaf="true" data-offset-key="8894:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8895"><span data-slate-object="text" data-key="8896"><span data-slate-leaf="true" data-offset-key="8896:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8897"><span data-slate-leaf="true" data-offset-key="8897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="8898"><span data-slate-leaf="true" data-offset-key="8898:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8899"><span data-slate-leaf="true" data-offset-key="8899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"not found caller"</span></span></span></span><span data-slate-object="text" data-key="8900"><span data-slate-leaf="true" data-offset-key="8900:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8901"><span data-slate-object="text" data-key="8902"><span data-slate-leaf="true" data-offset-key="8902:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8903"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8904"><span data-slate-object="text" data-key="8905"><span data-slate-leaf="true" data-offset-key="8905:0" data-first-offset="true"><span data-slate-string="true">    fn := runtime.FuncForPC(pc)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8906"><span data-slate-object="text" data-key="8907"><span data-slate-leaf="true" data-offset-key="8907:0" data-first-offset="true"><span data-slate-string="true">    name := fn.Name()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8908"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8909"><span data-slate-object="text" data-key="8910"><span data-slate-leaf="true" data-offset-key="8910:0" data-first-offset="true"><span data-slate-string="true">    gid := curGoroutineID()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8911"><span data-slate-object="text" data-key="8912"><span data-slate-leaf="true" data-offset-key="8912:0" data-first-offset="true"><span data-slate-string="true">    fmt.Printf(</span></span></span><span data-slate-object="text" data-key="8913"><span data-slate-leaf="true" data-offset-key="8913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g[%05d]: enter: [%s]\n"</span></span></span></span><span data-slate-object="text" data-key="8914"><span data-slate-leaf="true" data-offset-key="8914:0" data-first-offset="true"><span data-slate-string="true">, gid, name)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8915"><span data-slate-object="text" data-key="8916"><span data-slate-leaf="true" data-offset-key="8916:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8917"><span data-slate-leaf="true" data-offset-key="8917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8918"><span data-slate-leaf="true" data-offset-key="8918:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8919"><span data-slate-leaf="true" data-offset-key="8919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8920"><span data-slate-leaf="true" data-offset-key="8920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8921"><span data-slate-leaf="true" data-offset-key="8921:0" data-first-offset="true"><span data-slate-string="true"> { fmt.Printf(</span></span></span><span data-slate-object="text" data-key="8922"><span data-slate-leaf="true" data-offset-key="8922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g[%05d]: exit: [%s]\n"</span></span></span></span><span data-slate-object="text" data-key="8923"><span data-slate-leaf="true" data-offset-key="8923:0" data-first-offset="true"><span data-slate-string="true">, gid, name) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8924"><span data-slate-object="text" data-key="8925"><span data-slate-leaf="true" data-offset-key="8925:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8926"><span data-slate-object="text" data-key="8927"><span data-slate-leaf="true" data-offset-key="8927:0" data-first-offset="true"><span data-slate-string="true">从上面代码看到，我们在出入口输出的跟踪信息中加入了 Goroutine ID 信息，我们输出的 Goroutine ID 为 5 位数字，如果 ID 值不足 5 位，则左补零，这一切都是 Printf 函数的格式控制字符串 “%05d” 帮助我们实现的。这样对齐 Goroutine ID 的位数，为的是输出信息格式的一致性更好。如果你的 Go 程序中 Goroutine 的数量超过了 5 位数可以表示的数值范围，也可以自行调整控制字符串。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8928"><span data-slate-object="text" data-key="8929"><span data-slate-leaf="true" data-offset-key="8929:0" data-first-offset="true"><span data-slate-string="true">接下来，我们也要对示例进行一些调整，将这个程序由单 Goroutine 改为多 Goroutine 并发的，这样才能验证支持多 Goroutine 的新版 Trace 函数是否好用：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8930"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8931"><span data-slate-object="text" data-key="8932"><span data-slate-leaf="true" data-offset-key="8932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// trace2/trace.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8933"><span data-slate-object="text" data-key="8934"><span data-slate-leaf="true" data-offset-key="8934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8935"><span data-slate-leaf="true" data-offset-key="8935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8936"><span data-slate-leaf="true" data-offset-key="8936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">A1</span></span></span></span></span><span data-slate-object="text" data-key="8937"><span data-slate-leaf="true" data-offset-key="8937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8938"><span data-slate-leaf="true" data-offset-key="8938:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8939"><span data-slate-object="text" data-key="8940"><span data-slate-leaf="true" data-offset-key="8940:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8941"><span data-slate-leaf="true" data-offset-key="8941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8942"><span data-slate-leaf="true" data-offset-key="8942:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8943"><span data-slate-object="text" data-key="8944"><span data-slate-leaf="true" data-offset-key="8944:0" data-first-offset="true"><span data-slate-string="true">    B1()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8945"><span data-slate-object="text" data-key="8946"><span data-slate-leaf="true" data-offset-key="8946:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8947"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8948"><span data-slate-object="text" data-key="8949"><span data-slate-leaf="true" data-offset-key="8949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8950"><span data-slate-leaf="true" data-offset-key="8950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8951"><span data-slate-leaf="true" data-offset-key="8951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">B1</span></span></span></span></span><span data-slate-object="text" data-key="8952"><span data-slate-leaf="true" data-offset-key="8952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8953"><span data-slate-leaf="true" data-offset-key="8953:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8954"><span data-slate-object="text" data-key="8955"><span data-slate-leaf="true" data-offset-key="8955:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8956"><span data-slate-leaf="true" data-offset-key="8956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8957"><span data-slate-leaf="true" data-offset-key="8957:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8958"><span data-slate-object="text" data-key="8959"><span data-slate-leaf="true" data-offset-key="8959:0" data-first-offset="true"><span data-slate-string="true">    C1()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8960"><span data-slate-object="text" data-key="8961"><span data-slate-leaf="true" data-offset-key="8961:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8962"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8963"><span data-slate-object="text" data-key="8964"><span data-slate-leaf="true" data-offset-key="8964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8965"><span data-slate-leaf="true" data-offset-key="8965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8966"><span data-slate-leaf="true" data-offset-key="8966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">C1</span></span></span></span></span><span data-slate-object="text" data-key="8967"><span data-slate-leaf="true" data-offset-key="8967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8968"><span data-slate-leaf="true" data-offset-key="8968:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8969"><span data-slate-object="text" data-key="8970"><span data-slate-leaf="true" data-offset-key="8970:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8971"><span data-slate-leaf="true" data-offset-key="8971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8972"><span data-slate-leaf="true" data-offset-key="8972:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8973"><span data-slate-object="text" data-key="8974"><span data-slate-leaf="true" data-offset-key="8974:0" data-first-offset="true"><span data-slate-string="true">    D()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8975"><span data-slate-object="text" data-key="8976"><span data-slate-leaf="true" data-offset-key="8976:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8977"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8978"><span data-slate-object="text" data-key="8979"><span data-slate-leaf="true" data-offset-key="8979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8980"><span data-slate-leaf="true" data-offset-key="8980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8981"><span data-slate-leaf="true" data-offset-key="8981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">D</span></span></span></span></span><span data-slate-object="text" data-key="8982"><span data-slate-leaf="true" data-offset-key="8982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8983"><span data-slate-leaf="true" data-offset-key="8983:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8984"><span data-slate-object="text" data-key="8985"><span data-slate-leaf="true" data-offset-key="8985:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8986"><span data-slate-leaf="true" data-offset-key="8986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="8987"><span data-slate-leaf="true" data-offset-key="8987:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8988"><span data-slate-object="text" data-key="8989"><span data-slate-leaf="true" data-offset-key="8989:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8990"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8991"><span data-slate-object="text" data-key="8992"><span data-slate-leaf="true" data-offset-key="8992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8993"><span data-slate-leaf="true" data-offset-key="8993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8994"><span data-slate-leaf="true" data-offset-key="8994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">A2</span></span></span></span></span><span data-slate-object="text" data-key="8995"><span data-slate-leaf="true" data-offset-key="8995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8996"><span data-slate-leaf="true" data-offset-key="8996:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8997"><span data-slate-object="text" data-key="8998"><span data-slate-leaf="true" data-offset-key="8998:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8999"><span data-slate-leaf="true" data-offset-key="8999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9000"><span data-slate-leaf="true" data-offset-key="9000:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9001"><span data-slate-object="text" data-key="9002"><span data-slate-leaf="true" data-offset-key="9002:0" data-first-offset="true"><span data-slate-string="true">    B2()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9003"><span data-slate-object="text" data-key="9004"><span data-slate-leaf="true" data-offset-key="9004:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9005"><span data-slate-object="text" data-key="9006"><span data-slate-leaf="true" data-offset-key="9006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9007"><span data-slate-leaf="true" data-offset-key="9007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9008"><span data-slate-leaf="true" data-offset-key="9008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">B2</span></span></span></span></span><span data-slate-object="text" data-key="9009"><span data-slate-leaf="true" data-offset-key="9009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9010"><span data-slate-leaf="true" data-offset-key="9010:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9011"><span data-slate-object="text" data-key="9012"><span data-slate-leaf="true" data-offset-key="9012:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9013"><span data-slate-leaf="true" data-offset-key="9013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9014"><span data-slate-leaf="true" data-offset-key="9014:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9015"><span data-slate-object="text" data-key="9016"><span data-slate-leaf="true" data-offset-key="9016:0" data-first-offset="true"><span data-slate-string="true">    C2()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9017"><span data-slate-object="text" data-key="9018"><span data-slate-leaf="true" data-offset-key="9018:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9019"><span data-slate-object="text" data-key="9020"><span data-slate-leaf="true" data-offset-key="9020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9021"><span data-slate-leaf="true" data-offset-key="9021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9022"><span data-slate-leaf="true" data-offset-key="9022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">C2</span></span></span></span></span><span data-slate-object="text" data-key="9023"><span data-slate-leaf="true" data-offset-key="9023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9024"><span data-slate-leaf="true" data-offset-key="9024:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9025"><span data-slate-object="text" data-key="9026"><span data-slate-leaf="true" data-offset-key="9026:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9027"><span data-slate-leaf="true" data-offset-key="9027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9028"><span data-slate-leaf="true" data-offset-key="9028:0" data-first-offset="true"><span data-slate-string="true"> Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9029"><span data-slate-object="text" data-key="9030"><span data-slate-leaf="true" data-offset-key="9030:0" data-first-offset="true"><span data-slate-string="true">    D()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9031"><span data-slate-object="text" data-key="9032"><span data-slate-leaf="true" data-offset-key="9032:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9033"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9034"><span data-slate-object="text" data-key="9035"><span data-slate-leaf="true" data-offset-key="9035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9036"><span data-slate-leaf="true" data-offset-key="9036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9037"><span data-slate-leaf="true" data-offset-key="9037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="9038"><span data-slate-leaf="true" data-offset-key="9038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9039"><span data-slate-leaf="true" data-offset-key="9039:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9040"><span data-slate-object="text" data-key="9041"><span data-slate-leaf="true" data-offset-key="9041:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9042"><span data-slate-leaf="true" data-offset-key="9042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9043"><span data-slate-leaf="true" data-offset-key="9043:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9044"><span data-slate-object="text" data-key="9045"><span data-slate-leaf="true" data-offset-key="9045:0" data-first-offset="true"><span data-slate-string="true">    wg.Add(</span></span></span><span data-slate-object="text" data-key="9046"><span data-slate-leaf="true" data-offset-key="9046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9047"><span data-slate-leaf="true" data-offset-key="9047:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9048"><span data-slate-object="text" data-key="9049"><span data-slate-leaf="true" data-offset-key="9049:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9050"><span data-slate-leaf="true" data-offset-key="9050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="9051"><span data-slate-leaf="true" data-offset-key="9051:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9052"><span data-slate-leaf="true" data-offset-key="9052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9053"><span data-slate-leaf="true" data-offset-key="9053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9054"><span data-slate-leaf="true" data-offset-key="9054:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9055"><span data-slate-object="text" data-key="9056"><span data-slate-leaf="true" data-offset-key="9056:0" data-first-offset="true"><span data-slate-string="true">        A2()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9057"><span data-slate-object="text" data-key="9058"><span data-slate-leaf="true" data-offset-key="9058:0" data-first-offset="true"><span data-slate-string="true">        wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9059"><span data-slate-object="text" data-key="9060"><span data-slate-leaf="true" data-offset-key="9060:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9061"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9062"><span data-slate-object="text" data-key="9063"><span data-slate-leaf="true" data-offset-key="9063:0" data-first-offset="true"><span data-slate-string="true">    A1()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9064"><span data-slate-object="text" data-key="9065"><span data-slate-leaf="true" data-offset-key="9065:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9066"><span data-slate-object="text" data-key="9067"><span data-slate-leaf="true" data-offset-key="9067:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9068"><span data-slate-object="text" data-key="9069"><span data-slate-leaf="true" data-offset-key="9069:0" data-first-offset="true"><span data-slate-string="true">新示例程序共有两个 Goroutine，main groutine 的调用链为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9070"><span data-slate-object="text" data-key="9071"><span data-slate-leaf="true" data-offset-key="9071:0" data-first-offset="true"><span data-slate-string="true"> A1 -&gt; B1 -&gt; C1 -&gt; D</span></span></span></span><span data-slate-object="text" data-key="9072"><span data-slate-leaf="true" data-offset-key="9072:0" data-first-offset="true"><span data-slate-string="true">，而另外一个 Goroutine 的函数调用链为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9073"><span data-slate-object="text" data-key="9074"><span data-slate-leaf="true" data-offset-key="9074:0" data-first-offset="true"><span data-slate-string="true"> A2 -&gt; B2 -&gt; C2 -&gt; D</span></span></span></span><span data-slate-object="text" data-key="9075"><span data-slate-leaf="true" data-offset-key="9075:0" data-first-offset="true"><span data-slate-string="true">。我们来看一下这个程序的执行结果是否和原代码中两个 Goroutine 的调用链一致：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9076"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9077"><span data-slate-object="text" data-key="9078"><span data-slate-leaf="true" data-offset-key="9078:0" data-first-offset="true"><span data-slate-string="true">g[00001]: enter: [main.A1]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9079"><span data-slate-object="text" data-key="9080"><span data-slate-leaf="true" data-offset-key="9080:0" data-first-offset="true"><span data-slate-string="true">g[00001]: enter: [main.B1]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9081"><span data-slate-object="text" data-key="9082"><span data-slate-leaf="true" data-offset-key="9082:0" data-first-offset="true"><span data-slate-string="true">g[00018]: enter: [main.A2]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9083"><span data-slate-object="text" data-key="9084"><span data-slate-leaf="true" data-offset-key="9084:0" data-first-offset="true"><span data-slate-string="true">g[00001]: enter: [main.C1]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9085"><span data-slate-object="text" data-key="9086"><span data-slate-leaf="true" data-offset-key="9086:0" data-first-offset="true"><span data-slate-string="true">g[00001]: enter: [main.D]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9087"><span data-slate-object="text" data-key="9088"><span data-slate-leaf="true" data-offset-key="9088:0" data-first-offset="true"><span data-slate-string="true">g[00001]: </span></span></span><span data-slate-object="text" data-key="9089"><span data-slate-leaf="true" data-offset-key="9089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9090"><span data-slate-leaf="true" data-offset-key="9090:0" data-first-offset="true"><span data-slate-string="true">: [main.D]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9091"><span data-slate-object="text" data-key="9092"><span data-slate-leaf="true" data-offset-key="9092:0" data-first-offset="true"><span data-slate-string="true">g[00001]: </span></span></span><span data-slate-object="text" data-key="9093"><span data-slate-leaf="true" data-offset-key="9093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9094"><span data-slate-leaf="true" data-offset-key="9094:0" data-first-offset="true"><span data-slate-string="true">: [main.C1]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9095"><span data-slate-object="text" data-key="9096"><span data-slate-leaf="true" data-offset-key="9096:0" data-first-offset="true"><span data-slate-string="true">g[00001]: </span></span></span><span data-slate-object="text" data-key="9097"><span data-slate-leaf="true" data-offset-key="9097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9098"><span data-slate-leaf="true" data-offset-key="9098:0" data-first-offset="true"><span data-slate-string="true">: [main.B1]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9099"><span data-slate-object="text" data-key="9100"><span data-slate-leaf="true" data-offset-key="9100:0" data-first-offset="true"><span data-slate-string="true">g[00001]: </span></span></span><span data-slate-object="text" data-key="9101"><span data-slate-leaf="true" data-offset-key="9101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9102"><span data-slate-leaf="true" data-offset-key="9102:0" data-first-offset="true"><span data-slate-string="true">: [main.A1]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9103"><span data-slate-object="text" data-key="9104"><span data-slate-leaf="true" data-offset-key="9104:0" data-first-offset="true"><span data-slate-string="true">g[00018]: enter: [main.B2]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9105"><span data-slate-object="text" data-key="9106"><span data-slate-leaf="true" data-offset-key="9106:0" data-first-offset="true"><span data-slate-string="true">g[00018]: enter: [main.C2]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9107"><span data-slate-object="text" data-key="9108"><span data-slate-leaf="true" data-offset-key="9108:0" data-first-offset="true"><span data-slate-string="true">g[00018]: enter: [main.D]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9109"><span data-slate-object="text" data-key="9110"><span data-slate-leaf="true" data-offset-key="9110:0" data-first-offset="true"><span data-slate-string="true">g[00018]: </span></span></span><span data-slate-object="text" data-key="9111"><span data-slate-leaf="true" data-offset-key="9111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9112"><span data-slate-leaf="true" data-offset-key="9112:0" data-first-offset="true"><span data-slate-string="true">: [main.D]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9113"><span data-slate-object="text" data-key="9114"><span data-slate-leaf="true" data-offset-key="9114:0" data-first-offset="true"><span data-slate-string="true">g[00018]: </span></span></span><span data-slate-object="text" data-key="9115"><span data-slate-leaf="true" data-offset-key="9115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9116"><span data-slate-leaf="true" data-offset-key="9116:0" data-first-offset="true"><span data-slate-string="true">: [main.C2]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9117"><span data-slate-object="text" data-key="9118"><span data-slate-leaf="true" data-offset-key="9118:0" data-first-offset="true"><span data-slate-string="true">g[00018]: </span></span></span><span data-slate-object="text" data-key="9119"><span data-slate-leaf="true" data-offset-key="9119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9120"><span data-slate-leaf="true" data-offset-key="9120:0" data-first-offset="true"><span data-slate-string="true">: [main.B2]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9121"><span data-slate-object="text" data-key="9122"><span data-slate-leaf="true" data-offset-key="9122:0" data-first-offset="true"><span data-slate-string="true">g[00018]: </span></span></span><span data-slate-object="text" data-key="9123"><span data-slate-leaf="true" data-offset-key="9123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="9124"><span data-slate-leaf="true" data-offset-key="9124:0" data-first-offset="true"><span data-slate-string="true">: [main.A2]</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9125"><span data-slate-object="text" data-key="9126"><span data-slate-leaf="true" data-offset-key="9126:0" data-first-offset="true"><span data-slate-string="true">我们看到，新示例程序输出了带有 Goroutine ID 的出入口跟踪信息，通过 Goroutine ID 我们可以快速确认某一行输出是属于哪个 Goroutine 的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9127"><span data-slate-object="text" data-key="9128"><span data-slate-leaf="true" data-offset-key="9128:0" data-first-offset="true"><span data-slate-string="true">但由于 Go 运行时对 Goroutine 调度顺序的不确定性，各个 Goroutine 的输出还是会存在交织在一起的问题，这会给你查看某个 Goroutine 的函数调用链跟踪信息带来阻碍。这里我提供一个</span></span></span><span data-slate-object="text" data-key="9129"><span data-slate-leaf="true" data-offset-key="9129:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">小技巧</span></span></span></span><span data-slate-object="text" data-key="9130"><span data-slate-leaf="true" data-offset-key="9130:0" data-first-offset="true"><span data-slate-string="true">：你可以将程序的输出重定向到一个本地文件中，然后通过 Goroutine ID 过滤出（可使用 grep 工具）你想查看的 groutine 的全部函数跟踪信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9131"><span data-slate-object="text" data-key="9132"><span data-slate-leaf="true" data-offset-key="9132:0" data-first-offset="true"><span data-slate-string="true">到这里，我们就实现了输出带有 Goroutine ID 的函数跟踪信息，不过，你是不是也觉得输出的函数调用链信息还是不够美观，缺少层次感，体验依旧不那么优秀呢？至少我是这么觉得的。所以下面我们就来美化一下信息的输出形式。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9133" id="sr-toc-4"><span data-slate-object="text" data-key="9134"><span data-slate-leaf="true" data-offset-key="9134:0" data-first-offset="true"><span data-slate-string="true">让输出的跟踪信息更具层次感</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9135"><span data-slate-object="text" data-key="9136"><span data-slate-leaf="true" data-offset-key="9136:0" data-first-offset="true"><span data-slate-string="true">对于程序员来说，缩进是最能体现出 “层次感” 的方法，如果我们将上面示例中 Goroutine 00001 的函数调用跟踪信息以下面的形式展示出来，函数的调用顺序是不是更加一目了然了呢？</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="9137"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9138"><span data-slate-object="text" data-key="9139"><span data-slate-leaf="true" data-offset-key="9139:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9140"><span data-slate-leaf="true" data-offset-key="9140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9141"><span data-slate-leaf="true" data-offset-key="9141:0" data-first-offset="true"><span data-slate-string="true">]:    </span></span></span><span data-slate-object="text" data-key="9142"><span data-slate-leaf="true" data-offset-key="9142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9143"><span data-slate-leaf="true" data-offset-key="9143:0" data-first-offset="true"><span data-slate-string="true">main.A1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9144"><span data-slate-object="text" data-key="9145"><span data-slate-leaf="true" data-offset-key="9145:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9146"><span data-slate-leaf="true" data-offset-key="9146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9147"><span data-slate-leaf="true" data-offset-key="9147:0" data-first-offset="true"><span data-slate-string="true">]:        </span></span></span><span data-slate-object="text" data-key="9148"><span data-slate-leaf="true" data-offset-key="9148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9149"><span data-slate-leaf="true" data-offset-key="9149:0" data-first-offset="true"><span data-slate-string="true">main.B1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9150"><span data-slate-object="text" data-key="9151"><span data-slate-leaf="true" data-offset-key="9151:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9152"><span data-slate-leaf="true" data-offset-key="9152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9153"><span data-slate-leaf="true" data-offset-key="9153:0" data-first-offset="true"><span data-slate-string="true">]:            </span></span></span><span data-slate-object="text" data-key="9154"><span data-slate-leaf="true" data-offset-key="9154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9155"><span data-slate-leaf="true" data-offset-key="9155:0" data-first-offset="true"><span data-slate-string="true">main.C1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9156"><span data-slate-object="text" data-key="9157"><span data-slate-leaf="true" data-offset-key="9157:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9158"><span data-slate-leaf="true" data-offset-key="9158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9159"><span data-slate-leaf="true" data-offset-key="9159:0" data-first-offset="true"><span data-slate-string="true">]:                </span></span></span><span data-slate-object="text" data-key="9160"><span data-slate-leaf="true" data-offset-key="9160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9161"><span data-slate-leaf="true" data-offset-key="9161:0" data-first-offset="true"><span data-slate-string="true">main.D</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9162"><span data-slate-object="text" data-key="9163"><span data-slate-leaf="true" data-offset-key="9163:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9164"><span data-slate-leaf="true" data-offset-key="9164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9165"><span data-slate-leaf="true" data-offset-key="9165:0" data-first-offset="true"><span data-slate-string="true">]:                &lt;-main.D</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9166"><span data-slate-object="text" data-key="9167"><span data-slate-leaf="true" data-offset-key="9167:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9168"><span data-slate-leaf="true" data-offset-key="9168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9169"><span data-slate-leaf="true" data-offset-key="9169:0" data-first-offset="true"><span data-slate-string="true">]:            &lt;-main.C1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9170"><span data-slate-object="text" data-key="9171"><span data-slate-leaf="true" data-offset-key="9171:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9172"><span data-slate-leaf="true" data-offset-key="9172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9173"><span data-slate-leaf="true" data-offset-key="9173:0" data-first-offset="true"><span data-slate-string="true">]:        &lt;-main.B1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9174"><span data-slate-object="text" data-key="9175"><span data-slate-leaf="true" data-offset-key="9175:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9176"><span data-slate-leaf="true" data-offset-key="9176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9177"><span data-slate-leaf="true" data-offset-key="9177:0" data-first-offset="true"><span data-slate-string="true">]:    &lt;-main.A1</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9178"><span data-slate-object="text" data-key="9179"><span data-slate-leaf="true" data-offset-key="9179:0" data-first-offset="true"><span data-slate-string="true">那么我们就以这个形式为目标，考虑如何实现输出这种带缩进的函数调用跟踪信息。我们还是直接上代码吧：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9180"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9181"><span data-slate-object="text" data-key="9182"><span data-slate-leaf="true" data-offset-key="9182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// trace3/trace.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9183"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9184"><span data-slate-object="text" data-key="9185"><span data-slate-leaf="true" data-offset-key="9185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9186"><span data-slate-leaf="true" data-offset-key="9186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9187"><span data-slate-leaf="true" data-offset-key="9187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">printTrace</span></span></span></span></span><span data-slate-object="text" data-key="9188"><span data-slate-leaf="true" data-offset-key="9188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(id </span></span></span></span></span><span data-slate-object="text" data-key="9189"><span data-slate-leaf="true" data-offset-key="9189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span></span></span><span data-slate-object="text" data-key="9190"><span data-slate-leaf="true" data-offset-key="9190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, name, arrow </span></span></span></span></span><span data-slate-object="text" data-key="9191"><span data-slate-leaf="true" data-offset-key="9191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="9192"><span data-slate-leaf="true" data-offset-key="9192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, indent </span></span></span></span></span><span data-slate-object="text" data-key="9193"><span data-slate-leaf="true" data-offset-key="9193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="9194"><span data-slate-leaf="true" data-offset-key="9194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="9195"><span data-slate-leaf="true" data-offset-key="9195:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9196"><span data-slate-object="text" data-key="9197"><span data-slate-leaf="true" data-offset-key="9197:0" data-first-offset="true"><span data-slate-string="true">    indents := </span></span></span><span data-slate-object="text" data-key="9198"><span data-slate-leaf="true" data-offset-key="9198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9199"><span data-slate-object="text" data-key="9200"><span data-slate-leaf="true" data-offset-key="9200:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9201"><span data-slate-leaf="true" data-offset-key="9201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9202"><span data-slate-leaf="true" data-offset-key="9202:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="9203"><span data-slate-leaf="true" data-offset-key="9203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9204"><span data-slate-leaf="true" data-offset-key="9204:0" data-first-offset="true"><span data-slate-string="true">; i &lt; indent; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9205"><span data-slate-object="text" data-key="9206"><span data-slate-leaf="true" data-offset-key="9206:0" data-first-offset="true"><span data-slate-string="true">        indents += </span></span></span><span data-slate-object="text" data-key="9207"><span data-slate-leaf="true" data-offset-key="9207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" "</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9208"><span data-slate-object="text" data-key="9209"><span data-slate-leaf="true" data-offset-key="9209:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9210"><span data-slate-object="text" data-key="9211"><span data-slate-leaf="true" data-offset-key="9211:0" data-first-offset="true"><span data-slate-string="true">    fmt.Printf(</span></span></span><span data-slate-object="text" data-key="9212"><span data-slate-leaf="true" data-offset-key="9212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g[%05d]:%s%s%s\n"</span></span></span></span><span data-slate-object="text" data-key="9213"><span data-slate-leaf="true" data-offset-key="9213:0" data-first-offset="true"><span data-slate-string="true">, id, indents, arrow, name)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9214"><span data-slate-object="text" data-key="9215"><span data-slate-leaf="true" data-offset-key="9215:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9216"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9217"><span data-slate-object="text" data-key="9218"><span data-slate-leaf="true" data-offset-key="9218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9219"><span data-slate-leaf="true" data-offset-key="9219:0" data-first-offset="true"><span data-slate-string="true"> mu sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9220"><span data-slate-object="text" data-key="9221"><span data-slate-leaf="true" data-offset-key="9221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9222"><span data-slate-leaf="true" data-offset-key="9222:0" data-first-offset="true"><span data-slate-string="true"> m = </span></span></span><span data-slate-object="text" data-key="9223"><span data-slate-leaf="true" data-offset-key="9223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="9224"><span data-slate-leaf="true" data-offset-key="9224:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9225"><span data-slate-leaf="true" data-offset-key="9225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="9226"><span data-slate-leaf="true" data-offset-key="9226:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="9227"><span data-slate-leaf="true" data-offset-key="9227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="9228"><span data-slate-leaf="true" data-offset-key="9228:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="9229"><span data-slate-leaf="true" data-offset-key="9229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9230"><span data-slate-leaf="true" data-offset-key="9230:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9231"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9232"><span data-slate-object="text" data-key="9233"><span data-slate-leaf="true" data-offset-key="9233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9234"><span data-slate-leaf="true" data-offset-key="9234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9235"><span data-slate-leaf="true" data-offset-key="9235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Trace</span></span></span></span></span><span data-slate-object="text" data-key="9236"><span data-slate-leaf="true" data-offset-key="9236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9237"><span data-slate-leaf="true" data-offset-key="9237:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9238"><span data-slate-leaf="true" data-offset-key="9238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9239"><span data-slate-leaf="true" data-offset-key="9239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9240"><span data-slate-leaf="true" data-offset-key="9240:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9241"><span data-slate-object="text" data-key="9242"><span data-slate-leaf="true" data-offset-key="9242:0" data-first-offset="true"><span data-slate-string="true">    pc, _, _, ok := runtime.Caller(</span></span></span><span data-slate-object="text" data-key="9243"><span data-slate-leaf="true" data-offset-key="9243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9244"><span data-slate-leaf="true" data-offset-key="9244:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9245"><span data-slate-object="text" data-key="9246"><span data-slate-leaf="true" data-offset-key="9246:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9247"><span data-slate-leaf="true" data-offset-key="9247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9248"><span data-slate-leaf="true" data-offset-key="9248:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9249"><span data-slate-object="text" data-key="9250"><span data-slate-leaf="true" data-offset-key="9250:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9251"><span data-slate-leaf="true" data-offset-key="9251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="9252"><span data-slate-leaf="true" data-offset-key="9252:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9253"><span data-slate-leaf="true" data-offset-key="9253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"not found caller"</span></span></span></span><span data-slate-object="text" data-key="9254"><span data-slate-leaf="true" data-offset-key="9254:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9255"><span data-slate-object="text" data-key="9256"><span data-slate-leaf="true" data-offset-key="9256:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9257"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9258"><span data-slate-object="text" data-key="9259"><span data-slate-leaf="true" data-offset-key="9259:0" data-first-offset="true"><span data-slate-string="true">    fn := runtime.FuncForPC(pc)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9260"><span data-slate-object="text" data-key="9261"><span data-slate-leaf="true" data-offset-key="9261:0" data-first-offset="true"><span data-slate-string="true">    name := fn.Name()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9262"><span data-slate-object="text" data-key="9263"><span data-slate-leaf="true" data-offset-key="9263:0" data-first-offset="true"><span data-slate-string="true">    gid := curGoroutineID()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9264"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9265"><span data-slate-object="text" data-key="9266"><span data-slate-leaf="true" data-offset-key="9266:0" data-first-offset="true"><span data-slate-string="true">    mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9267"><span data-slate-object="text" data-key="9268"><span data-slate-leaf="true" data-offset-key="9268:0" data-first-offset="true"><span data-slate-string="true">    indents := m[gid]    </span></span></span><span data-slate-object="text" data-key="9269"><span data-slate-leaf="true" data-offset-key="9269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前 gid 对应的缩进层次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9270"><span data-slate-object="text" data-key="9271"><span data-slate-leaf="true" data-offset-key="9271:0" data-first-offset="true"><span data-slate-string="true">    m[gid] = indents + </span></span></span><span data-slate-object="text" data-key="9272"><span data-slate-leaf="true" data-offset-key="9272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9273"><span data-slate-leaf="true" data-offset-key="9273:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9274"><span data-slate-leaf="true" data-offset-key="9274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 缩进层次 + 1 后存入 map</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9275"><span data-slate-object="text" data-key="9276"><span data-slate-leaf="true" data-offset-key="9276:0" data-first-offset="true"><span data-slate-string="true">    mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9277"><span data-slate-object="text" data-key="9278"><span data-slate-leaf="true" data-offset-key="9278:0" data-first-offset="true"><span data-slate-string="true">    printTrace(gid, name, </span></span></span><span data-slate-object="text" data-key="9279"><span data-slate-leaf="true" data-offset-key="9279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"-&gt;"</span></span></span></span><span data-slate-object="text" data-key="9280"><span data-slate-leaf="true" data-offset-key="9280:0" data-first-offset="true"><span data-slate-string="true">, indents+</span></span></span><span data-slate-object="text" data-key="9281"><span data-slate-leaf="true" data-offset-key="9281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9282"><span data-slate-leaf="true" data-offset-key="9282:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9283"><span data-slate-object="text" data-key="9284"><span data-slate-leaf="true" data-offset-key="9284:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_81368e9a" data-attr-id="42752" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="9285"><span data-slate-leaf="true" data-offset-key="9285:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_81368e9a" data-attr-id="42752" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></span><span data-slate-object="text" data-key="9286"><span data-slate-leaf="true" data-offset-key="9286:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_81368e9a" data-attr-id="42752" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9287"><span data-slate-leaf="true" data-offset-key="9287:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_81368e9a" data-attr-id="42752" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span></span><span data-slate-object="text" data-key="9288"><span data-slate-leaf="true" data-offset-key="9288:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_81368e9a" data-attr-id="42752" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></span><span data-slate-object="text" data-key="9289"><span data-slate-leaf="true" data-offset-key="9289:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_81368e9a" data-attr-id="42752" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> {</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9290"><span data-slate-object="text" data-key="9291"><span data-slate-leaf="true" data-offset-key="9291:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9b43709" data-attr-id="42753" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">        mu.Lock()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9292"><span data-slate-object="text" data-key="9293"><span data-slate-leaf="true" data-offset-key="9293:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_edac7cb0" data-attr-id="42754" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">        indents := m[gid]    </span></span></span></span><span data-slate-object="text" data-key="9294"><span data-slate-leaf="true" data-offset-key="9294:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_edac7cb0" data-attr-id="42754" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前 gid 对应的缩进层次</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9295"><span data-slate-object="text" data-key="9296"><span data-slate-leaf="true" data-offset-key="9296:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cd05031a" data-attr-id="42755" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">        m[gid] = indents - </span></span></span></span><span data-slate-object="text" data-key="9297"><span data-slate-leaf="true" data-offset-key="9297:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cd05031a" data-attr-id="42755" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></span><span data-slate-object="text" data-key="9298"><span data-slate-leaf="true" data-offset-key="9298:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cd05031a" data-attr-id="42755" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9299"><span data-slate-leaf="true" data-offset-key="9299:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cd05031a" data-attr-id="42755" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 缩进层次 - 1 后存入 map</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9300"><span data-slate-object="text" data-key="9301"><span data-slate-leaf="true" data-offset-key="9301:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_0d5ac068" data-attr-id="42756" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">        mu.Unlock()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9302"><span data-slate-object="text" data-key="9303"><span data-slate-leaf="true" data-offset-key="9303:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5739a243" data-attr-id="42757" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">        printTrace(gid, name, </span></span></span></span><span data-slate-object="text" data-key="9304"><span data-slate-leaf="true" data-offset-key="9304:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5739a243" data-attr-id="42757" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"&lt;-"</span></span></span></span></span><span data-slate-object="text" data-key="9305"><span data-slate-leaf="true" data-offset-key="9305:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5739a243" data-attr-id="42757" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">, indents)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9306"><span data-slate-object="text" data-key="9307"><span data-slate-leaf="true" data-offset-key="9307:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9308"><span data-slate-object="text" data-key="9309"><span data-slate-leaf="true" data-offset-key="9309:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9310"><span data-slate-object="text" data-key="9311"><span data-slate-leaf="true" data-offset-key="9311:0" data-first-offset="true"><span data-slate-string="true">在上面这段代码中，我们使用了一个 map 类型变量 m 来保存每个 Goroutine 当前的缩进信息：m 的 key 为 Goroutine 的 ID，值为缩进的层次。然后，考虑到 Trace 函数可能在并发环境中运行，根据我们在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9312"><span data-slate-object="text" data-key="9313"><span data-slate-leaf="true" data-offset-key="9313:0" data-first-offset="true"><span data-slate-string="true">第 16 讲</span></span></span></a><span data-slate-object="text" data-key="9314"><span data-slate-leaf="true" data-offset-key="9314:0" data-first-offset="true"><span data-slate-string="true">中提到的 “map 不支持并发写” 的注意事项，我们增加了一个 sync.Mutex 实例 mu 用于同步对 m 的写操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9315"><span data-slate-object="text" data-key="9316"><span data-slate-leaf="true" data-offset-key="9316:0" data-first-offset="true"><span data-slate-string="true">这样，对于一个 Goroutine 来说，每次刚进入一个函数调用，我们就在输出入口跟踪信息之前，将缩进层次加一，并输出入口跟踪信息，加一后的缩进层次值也保存到 map 中。然后，在函数退出前，我们取出当前缩进层次值并输出出口跟踪信息，之后再将缩进层次减一后保存到 map 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9317"><span data-slate-object="text" data-key="9318"><span data-slate-leaf="true" data-offset-key="9318:0" data-first-offset="true"><span data-slate-string="true">除了增加缩进层次信息外，在这一版的 Trace 函数实现中，我们也把输出出入口跟踪信息的操作提取到了一个独立的函数 printTrace 中，这个函数会根据传入的 Goroutine ID、函数名、箭头类型与缩进层次值，按预定的格式拼接跟踪信息并输出。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9319"><span data-slate-object="text" data-key="9320"><span data-slate-leaf="true" data-offset-key="9320:0" data-first-offset="true"><span data-slate-string="true">运行新版示例代码，我们会得到下面的结果：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="9321"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9322"><span data-slate-object="text" data-key="9323"><span data-slate-leaf="true" data-offset-key="9323:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9324"><span data-slate-leaf="true" data-offset-key="9324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9325"><span data-slate-leaf="true" data-offset-key="9325:0" data-first-offset="true"><span data-slate-string="true">]:    </span></span></span><span data-slate-object="text" data-key="9326"><span data-slate-leaf="true" data-offset-key="9326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9327"><span data-slate-leaf="true" data-offset-key="9327:0" data-first-offset="true"><span data-slate-string="true">main.A1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9328"><span data-slate-object="text" data-key="9329"><span data-slate-leaf="true" data-offset-key="9329:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9330"><span data-slate-leaf="true" data-offset-key="9330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9331"><span data-slate-leaf="true" data-offset-key="9331:0" data-first-offset="true"><span data-slate-string="true">]:        </span></span></span><span data-slate-object="text" data-key="9332"><span data-slate-leaf="true" data-offset-key="9332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9333"><span data-slate-leaf="true" data-offset-key="9333:0" data-first-offset="true"><span data-slate-string="true">main.B1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9334"><span data-slate-object="text" data-key="9335"><span data-slate-leaf="true" data-offset-key="9335:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9336"><span data-slate-leaf="true" data-offset-key="9336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9337"><span data-slate-leaf="true" data-offset-key="9337:0" data-first-offset="true"><span data-slate-string="true">]:            </span></span></span><span data-slate-object="text" data-key="9338"><span data-slate-leaf="true" data-offset-key="9338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9339"><span data-slate-leaf="true" data-offset-key="9339:0" data-first-offset="true"><span data-slate-string="true">main.C1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9340"><span data-slate-object="text" data-key="9341"><span data-slate-leaf="true" data-offset-key="9341:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9342"><span data-slate-leaf="true" data-offset-key="9342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9343"><span data-slate-leaf="true" data-offset-key="9343:0" data-first-offset="true"><span data-slate-string="true">]:                </span></span></span><span data-slate-object="text" data-key="9344"><span data-slate-leaf="true" data-offset-key="9344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9345"><span data-slate-leaf="true" data-offset-key="9345:0" data-first-offset="true"><span data-slate-string="true">main.D</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9346"><span data-slate-object="text" data-key="9347"><span data-slate-leaf="true" data-offset-key="9347:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9348"><span data-slate-leaf="true" data-offset-key="9348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9349"><span data-slate-leaf="true" data-offset-key="9349:0" data-first-offset="true"><span data-slate-string="true">]:                &lt;-main.D</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9350"><span data-slate-object="text" data-key="9351"><span data-slate-leaf="true" data-offset-key="9351:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9352"><span data-slate-leaf="true" data-offset-key="9352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9353"><span data-slate-leaf="true" data-offset-key="9353:0" data-first-offset="true"><span data-slate-string="true">]:            &lt;-main.C1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9354"><span data-slate-object="text" data-key="9355"><span data-slate-leaf="true" data-offset-key="9355:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9356"><span data-slate-leaf="true" data-offset-key="9356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9357"><span data-slate-leaf="true" data-offset-key="9357:0" data-first-offset="true"><span data-slate-string="true">]:        &lt;-main.B1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9358"><span data-slate-object="text" data-key="9359"><span data-slate-leaf="true" data-offset-key="9359:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9360"><span data-slate-leaf="true" data-offset-key="9360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="9361"><span data-slate-leaf="true" data-offset-key="9361:0" data-first-offset="true"><span data-slate-string="true">]:    &lt;-main.A1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9362"><span data-slate-object="text" data-key="9363"><span data-slate-leaf="true" data-offset-key="9363:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9364"><span data-slate-leaf="true" data-offset-key="9364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9365"><span data-slate-leaf="true" data-offset-key="9365:0" data-first-offset="true"><span data-slate-string="true">]:    </span></span></span><span data-slate-object="text" data-key="9366"><span data-slate-leaf="true" data-offset-key="9366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9367"><span data-slate-leaf="true" data-offset-key="9367:0" data-first-offset="true"><span data-slate-string="true">main.A2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9368"><span data-slate-object="text" data-key="9369"><span data-slate-leaf="true" data-offset-key="9369:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9370"><span data-slate-leaf="true" data-offset-key="9370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9371"><span data-slate-leaf="true" data-offset-key="9371:0" data-first-offset="true"><span data-slate-string="true">]:        </span></span></span><span data-slate-object="text" data-key="9372"><span data-slate-leaf="true" data-offset-key="9372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9373"><span data-slate-leaf="true" data-offset-key="9373:0" data-first-offset="true"><span data-slate-string="true">main.B2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9374"><span data-slate-object="text" data-key="9375"><span data-slate-leaf="true" data-offset-key="9375:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9376"><span data-slate-leaf="true" data-offset-key="9376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9377"><span data-slate-leaf="true" data-offset-key="9377:0" data-first-offset="true"><span data-slate-string="true">]:            </span></span></span><span data-slate-object="text" data-key="9378"><span data-slate-leaf="true" data-offset-key="9378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9379"><span data-slate-leaf="true" data-offset-key="9379:0" data-first-offset="true"><span data-slate-string="true">main.C2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9380"><span data-slate-object="text" data-key="9381"><span data-slate-leaf="true" data-offset-key="9381:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9382"><span data-slate-leaf="true" data-offset-key="9382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9383"><span data-slate-leaf="true" data-offset-key="9383:0" data-first-offset="true"><span data-slate-string="true">]:                </span></span></span><span data-slate-object="text" data-key="9384"><span data-slate-leaf="true" data-offset-key="9384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="9385"><span data-slate-leaf="true" data-offset-key="9385:0" data-first-offset="true"><span data-slate-string="true">main.D</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9386"><span data-slate-object="text" data-key="9387"><span data-slate-leaf="true" data-offset-key="9387:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9388"><span data-slate-leaf="true" data-offset-key="9388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9389"><span data-slate-leaf="true" data-offset-key="9389:0" data-first-offset="true"><span data-slate-string="true">]:                &lt;-main.D</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9390"><span data-slate-object="text" data-key="9391"><span data-slate-leaf="true" data-offset-key="9391:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9392"><span data-slate-leaf="true" data-offset-key="9392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9393"><span data-slate-leaf="true" data-offset-key="9393:0" data-first-offset="true"><span data-slate-string="true">]:            &lt;-main.C2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9394"><span data-slate-object="text" data-key="9395"><span data-slate-leaf="true" data-offset-key="9395:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9396"><span data-slate-leaf="true" data-offset-key="9396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9397"><span data-slate-leaf="true" data-offset-key="9397:0" data-first-offset="true"><span data-slate-string="true">]:        &lt;-main.B2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9398"><span data-slate-object="text" data-key="9399"><span data-slate-leaf="true" data-offset-key="9399:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="9400"><span data-slate-leaf="true" data-offset-key="9400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00018</span></span></span></span><span data-slate-object="text" data-key="9401"><span data-slate-leaf="true" data-offset-key="9401:0" data-first-offset="true"><span data-slate-string="true">]:    &lt;-main.A2</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9402"><span data-slate-object="text" data-key="9403"><span data-slate-leaf="true" data-offset-key="9403:0" data-first-offset="true"><span data-slate-string="true">显然，通过这种带有缩进层次的函数调用跟踪信息，我们可以更容易地识别某个 Goroutine 的函数调用关系。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9404"><span data-slate-object="text" data-key="9405"><span data-slate-leaf="true" data-offset-key="9405:0" data-first-offset="true"><span data-slate-string="true">到这里，我们的函数调用链跟踪已经支持了多 Goroutine，并且可以输出有层次感的跟踪信息了，但对于 Trace 特性的使用者而言，他们依然需要手工在自己的函数中添加对 Trace 函数的调用。那么我们是否可以将 Trace 特性自动注入特定项目下的各个源码文件中呢？接下来我们继续来改进我们的 Trace 工具。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9406" id="sr-toc-5"><span data-slate-object="text" data-key="9407"><span data-slate-leaf="true" data-offset-key="9407:0" data-first-offset="true"><span data-slate-string="true">利用代码生成自动注入 Trace 函数</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9408"><span data-slate-object="text" data-key="9409"><span data-slate-leaf="true" data-offset-key="9409:0" data-first-offset="true"><span data-slate-string="true">要实现向目标代码中的函数 / 方法自动注入 Trace 函数，我们首先要做的就是将上面 Trace 函数相关的代码打包到一个 module 中以方便其他 module 导入。下面我们就先来看看将 Trace 函数放入一个独立的 module 中的步骤。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9410" id="sr-toc-6"><span data-slate-object="text" data-key="9411"><span data-slate-leaf="true" data-offset-key="9411:0" data-first-offset="true"><span data-slate-string="true">将 Trace 函数放入一个独立的 module 中</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9412"><span data-slate-object="text" data-key="9413"><span data-slate-leaf="true" data-offset-key="9413:0" data-first-offset="true"><span data-slate-string="true">我们创建一个名为 instrument_trace 的目录，进入这个目录后，通过 go mod init 命令创建一个名为 github.com/bigwhite/instrument_trace 的 module：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="9414"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9415"><span data-slate-object="text" data-key="9416"><span data-slate-leaf="true" data-offset-key="9416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$</span></span></span></span><span data-slate-object="text" data-key="9417"><span data-slate-leaf="true" data-offset-key="9417:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mkdir</span></span></span></span></span><span data-slate-object="text" data-key="9418"><span data-slate-leaf="true" data-offset-key="9418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> instrument_trace</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9419"><span data-slate-object="text" data-key="9420"><span data-slate-leaf="true" data-offset-key="9420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$</span></span></span></span><span data-slate-object="text" data-key="9421"><span data-slate-leaf="true" data-offset-key="9421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cd</span></span></span></span></span><span data-slate-object="text" data-key="9422"><span data-slate-leaf="true" data-offset-key="9422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> instrument_trace</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9423"><span data-slate-object="text" data-key="9424"><span data-slate-leaf="true" data-offset-key="9424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$</span></span></span></span><span data-slate-object="text" data-key="9425"><span data-slate-leaf="true" data-offset-key="9425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go mod init github.com/bigwhite/instrument_trace</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9426"><span data-slate-object="text" data-key="9427"><span data-slate-leaf="true" data-offset-key="9427:0" data-first-offset="true"><span data-slate-string="true">go: creating new go.mod: module github.com/bigwhite/instrument_trace</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9428"><span data-slate-object="text" data-key="9429"><span data-slate-leaf="true" data-offset-key="9429:0" data-first-offset="true"><span data-slate-string="true">接下来，我们将最新版的 trace.go 放入到该目录下，将包名改为 trace，并仅保留 Trace 函数、Trace 使用的函数以及包级变量，其他函数一律删除掉。这样，一个独立的 trace 包就提取完毕了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9430"><span data-slate-object="text" data-key="9431"><span data-slate-leaf="true" data-offset-key="9431:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">作为 trace 包的作者，我们有义务告诉大家如何使用 trace 包。</span></span></span></span><span data-slate-object="text" data-key="9432"><span data-slate-leaf="true" data-offset-key="9432:0" data-first-offset="true"><span data-slate-string="true">在 Go 中，通常我们会用一个 example_test.go 文件来编写使用 trace 包的演示代码，下面就是我们为 trace 包提供的 example_test.go 文件：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9433"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9434"><span data-slate-object="text" data-key="9435"><span data-slate-leaf="true" data-offset-key="9435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// instrument_trace/example_test.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9436"><span data-slate-object="text" data-key="9437"><span data-slate-leaf="true" data-offset-key="9437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="9438"><span data-slate-leaf="true" data-offset-key="9438:0" data-first-offset="true"><span data-slate-string="true"> trace_test</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9439"><span data-slate-object="text" data-key="9440"><span data-slate-leaf="true" data-offset-key="9440:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9441"><span data-slate-object="text" data-key="9442"><span data-slate-leaf="true" data-offset-key="9442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="9443"><span data-slate-leaf="true" data-offset-key="9443:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9444"><span data-slate-object="text" data-key="9445"><span data-slate-leaf="true" data-offset-key="9445:0" data-first-offset="true"><span data-slate-string="true">    trace </span></span></span><span data-slate-object="text" data-key="9446"><span data-slate-leaf="true" data-offset-key="9446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/bigwhite/instrument_trace"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9447"><span data-slate-object="text" data-key="9448"><span data-slate-leaf="true" data-offset-key="9448:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9449"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9450"><span data-slate-object="text" data-key="9451"><span data-slate-leaf="true" data-offset-key="9451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9452"><span data-slate-leaf="true" data-offset-key="9452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9453"><span data-slate-leaf="true" data-offset-key="9453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">a</span></span></span></span></span><span data-slate-object="text" data-key="9454"><span data-slate-leaf="true" data-offset-key="9454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9455"><span data-slate-leaf="true" data-offset-key="9455:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9456"><span data-slate-object="text" data-key="9457"><span data-slate-leaf="true" data-offset-key="9457:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9458"><span data-slate-leaf="true" data-offset-key="9458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9459"><span data-slate-leaf="true" data-offset-key="9459:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9460"><span data-slate-object="text" data-key="9461"><span data-slate-leaf="true" data-offset-key="9461:0" data-first-offset="true"><span data-slate-string="true">    b()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9462"><span data-slate-object="text" data-key="9463"><span data-slate-leaf="true" data-offset-key="9463:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9464"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9465"><span data-slate-object="text" data-key="9466"><span data-slate-leaf="true" data-offset-key="9466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9467"><span data-slate-leaf="true" data-offset-key="9467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9468"><span data-slate-leaf="true" data-offset-key="9468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">b</span></span></span></span></span><span data-slate-object="text" data-key="9469"><span data-slate-leaf="true" data-offset-key="9469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9470"><span data-slate-leaf="true" data-offset-key="9470:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9471"><span data-slate-object="text" data-key="9472"><span data-slate-leaf="true" data-offset-key="9472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9473"><span data-slate-leaf="true" data-offset-key="9473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9474"><span data-slate-leaf="true" data-offset-key="9474:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9475"><span data-slate-object="text" data-key="9476"><span data-slate-leaf="true" data-offset-key="9476:0" data-first-offset="true"><span data-slate-string="true">    c()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9477"><span data-slate-object="text" data-key="9478"><span data-slate-leaf="true" data-offset-key="9478:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9479"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9480"><span data-slate-object="text" data-key="9481"><span data-slate-leaf="true" data-offset-key="9481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9482"><span data-slate-leaf="true" data-offset-key="9482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9483"><span data-slate-leaf="true" data-offset-key="9483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">c</span></span></span></span></span><span data-slate-object="text" data-key="9484"><span data-slate-leaf="true" data-offset-key="9484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9485"><span data-slate-leaf="true" data-offset-key="9485:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9486"><span data-slate-object="text" data-key="9487"><span data-slate-leaf="true" data-offset-key="9487:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9488"><span data-slate-leaf="true" data-offset-key="9488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9489"><span data-slate-leaf="true" data-offset-key="9489:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9490"><span data-slate-object="text" data-key="9491"><span data-slate-leaf="true" data-offset-key="9491:0" data-first-offset="true"><span data-slate-string="true">    d()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9492"><span data-slate-object="text" data-key="9493"><span data-slate-leaf="true" data-offset-key="9493:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9494"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9495"><span data-slate-object="text" data-key="9496"><span data-slate-leaf="true" data-offset-key="9496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9497"><span data-slate-leaf="true" data-offset-key="9497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9498"><span data-slate-leaf="true" data-offset-key="9498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">d</span></span></span></span></span><span data-slate-object="text" data-key="9499"><span data-slate-leaf="true" data-offset-key="9499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9500"><span data-slate-leaf="true" data-offset-key="9500:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9501"><span data-slate-object="text" data-key="9502"><span data-slate-leaf="true" data-offset-key="9502:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9503"><span data-slate-leaf="true" data-offset-key="9503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="9504"><span data-slate-leaf="true" data-offset-key="9504:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9505"><span data-slate-object="text" data-key="9506"><span data-slate-leaf="true" data-offset-key="9506:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9507"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9508"><span data-slate-object="text" data-key="9509"><span data-slate-leaf="true" data-offset-key="9509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9510"><span data-slate-leaf="true" data-offset-key="9510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9511"><span data-slate-leaf="true" data-offset-key="9511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ExampleTrace</span></span></span></span></span><span data-slate-object="text" data-key="9512"><span data-slate-leaf="true" data-offset-key="9512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9513"><span data-slate-leaf="true" data-offset-key="9513:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9514"><span data-slate-object="text" data-key="9515"><span data-slate-leaf="true" data-offset-key="9515:0" data-first-offset="true"><span data-slate-string="true">    a()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9516"><span data-slate-object="text" data-key="9517"><span data-slate-leaf="true" data-offset-key="9517:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9518"><span data-slate-leaf="true" data-offset-key="9518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Output:</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9519"><span data-slate-object="text" data-key="9520"><span data-slate-leaf="true" data-offset-key="9520:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9521"><span data-slate-leaf="true" data-offset-key="9521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:    -&gt;github.com/bigwhite/instrument_trace_test.a</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9522"><span data-slate-object="text" data-key="9523"><span data-slate-leaf="true" data-offset-key="9523:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9524"><span data-slate-leaf="true" data-offset-key="9524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:        -&gt;github.com/bigwhite/instrument_trace_test.b</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9525"><span data-slate-object="text" data-key="9526"><span data-slate-leaf="true" data-offset-key="9526:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9527"><span data-slate-leaf="true" data-offset-key="9527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:            -&gt;github.com/bigwhite/instrument_trace_test.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9528"><span data-slate-object="text" data-key="9529"><span data-slate-leaf="true" data-offset-key="9529:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9530"><span data-slate-leaf="true" data-offset-key="9530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:                -&gt;github.com/bigwhite/instrument_trace_test.d</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9531"><span data-slate-object="text" data-key="9532"><span data-slate-leaf="true" data-offset-key="9532:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9533"><span data-slate-leaf="true" data-offset-key="9533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:                &lt;-github.com/bigwhite/instrument_trace_test.d</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9534"><span data-slate-object="text" data-key="9535"><span data-slate-leaf="true" data-offset-key="9535:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9536"><span data-slate-leaf="true" data-offset-key="9536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:            &lt;-github.com/bigwhite/instrument_trace_test.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9537"><span data-slate-object="text" data-key="9538"><span data-slate-leaf="true" data-offset-key="9538:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9539"><span data-slate-leaf="true" data-offset-key="9539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:        &lt;-github.com/bigwhite/instrument_trace_test.b</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9540"><span data-slate-object="text" data-key="9541"><span data-slate-leaf="true" data-offset-key="9541:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9542"><span data-slate-leaf="true" data-offset-key="9542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g[00001]:    &lt;-github.com/bigwhite/instrument_trace_test.a</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9543"><span data-slate-object="text" data-key="9544"><span data-slate-leaf="true" data-offset-key="9544:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9545"><span data-slate-object="text" data-key="9546"><span data-slate-leaf="true" data-offset-key="9546:0" data-first-offset="true"><span data-slate-string="true">在 example_test.go 文件中，我们用 ExampleXXX 形式的函数表示一个示例，go test 命令会扫描 example_test.go 中的以 Example 为前缀的函数并执行这些函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9547"><span data-slate-object="text" data-key="9548"><span data-slate-leaf="true" data-offset-key="9548:0" data-first-offset="true"><span data-slate-string="true">每个 ExampleXXX 函数需要包含预期的输出，就像上面 ExampleTrace 函数尾部那样，我们在一大段注释中提供这个函数执行后的预期输出，预期输出的内容从</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9549"><span data-slate-object="text" data-key="9550"><span data-slate-leaf="true" data-offset-key="9550:0" data-first-offset="true"><span data-slate-string="true"> // Output:</span></span></span></span><span data-slate-object="text" data-key="9551"><span data-slate-leaf="true" data-offset-key="9551:0" data-first-offset="true"><span data-slate-string="true"> 的下一行开始。go test 会将 ExampleTrace 的输出与预期输出对比，如果不一致，会报测试错误。从这一点，我们可以看出 example_test.go 也是 trace 包单元测试的一部分。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9552"><span data-slate-object="text" data-key="9553"><span data-slate-leaf="true" data-offset-key="9553:0" data-first-offset="true"><span data-slate-string="true">现在 Trace 函数已经被放入到独立的包中了，接下来我们就来看看如何将它自动注入到要跟踪的函数中去。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9554" id="sr-toc-7"><span data-slate-object="text" data-key="9555"><span data-slate-leaf="true" data-offset-key="9555:0" data-first-offset="true"><span data-slate-string="true">自动注入 Trace 函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9556"><span data-slate-object="text" data-key="9557"><span data-slate-leaf="true" data-offset-key="9557:0" data-first-offset="true"><span data-slate-string="true">现在，我们在 instrument_trace module 下面增加一个命令行工具，这个工具可以以一个 Go 源文件为单位，自动向这个 Go 源文件中的所有函数注入 Trace 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9558"><span data-slate-object="text" data-key="9559"><span data-slate-leaf="true" data-offset-key="9559:0" data-first-offset="true"><span data-slate-string="true">我们再根据 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9560"><span data-slate-object="text" data-key="9561"><span data-slate-leaf="true" data-offset-key="9561:0" data-first-offset="true"><span data-slate-string="true">05 讲</span></span></span></a><span data-slate-object="text" data-key="9562"><span data-slate-leaf="true" data-offset-key="9562:0" data-first-offset="true"><span data-slate-string="true">中介绍的带有可执行文件的 Go 项目布局，在 instrument_trace module 中增加 cmd/instrument 目录，这个工具的 main 包就放在这个目录下，而真正实现自动注入 Trace 函数的代码呢，被我们放在了 instrumenter 目录下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9563"><span data-slate-object="text" data-key="9564"><span data-slate-leaf="true" data-offset-key="9564:0" data-first-offset="true"><span data-slate-string="true">下面是变化后的 instrument_trace module 的目录结构：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9565"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9566"><span data-slate-object="text" data-key="9567"><span data-slate-leaf="true" data-offset-key="9567:0" data-first-offset="true"><span data-slate-string="true">$tree ./instrument_trace -F</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9568"><span data-slate-object="text" data-key="9569"><span data-slate-leaf="true" data-offset-key="9569:0" data-first-offset="true"><span data-slate-string="true">./instrument_trace</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9570"><span data-slate-object="text" data-key="9571"><span data-slate-leaf="true" data-offset-key="9571:0" data-first-offset="true"><span data-slate-string="true">├── Makefile</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9572"><span data-slate-object="text" data-key="9573"><span data-slate-leaf="true" data-offset-key="9573:0" data-first-offset="true"><span data-slate-string="true">├── cmd/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9574"><span data-slate-object="text" data-key="9575"><span data-slate-leaf="true" data-offset-key="9575:0" data-first-offset="true"><span data-slate-string="true">│   └── instrument/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9576"><span data-slate-object="text" data-key="9577"><span data-slate-leaf="true" data-offset-key="9577:0" data-first-offset="true"><span data-slate-string="true">│       └── main.</span></span></span><span data-slate-object="text" data-key="9578"><span data-slate-leaf="true" data-offset-key="9578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="9579"><span data-slate-leaf="true" data-offset-key="9579:0" data-first-offset="true"><span data-slate-string="true">  # instrument 命令行工具的 main 包</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9580"><span data-slate-object="text" data-key="9581"><span data-slate-leaf="true" data-offset-key="9581:0" data-first-offset="true"><span data-slate-string="true">├── example_test.</span></span></span><span data-slate-object="text" data-key="9582"><span data-slate-leaf="true" data-offset-key="9582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9583"><span data-slate-object="text" data-key="9584"><span data-slate-leaf="true" data-offset-key="9584:0" data-first-offset="true"><span data-slate-string="true">├── </span></span></span><span data-slate-object="text" data-key="9585"><span data-slate-leaf="true" data-offset-key="9585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="9586"><span data-slate-leaf="true" data-offset-key="9586:0" data-first-offset="true"><span data-slate-string="true">.mod</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9587"><span data-slate-object="text" data-key="9588"><span data-slate-leaf="true" data-offset-key="9588:0" data-first-offset="true"><span data-slate-string="true">├── </span></span></span><span data-slate-object="text" data-key="9589"><span data-slate-leaf="true" data-offset-key="9589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="9590"><span data-slate-leaf="true" data-offset-key="9590:0" data-first-offset="true"><span data-slate-string="true">.sum</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9591"><span data-slate-object="text" data-key="9592"><span data-slate-leaf="true" data-offset-key="9592:0" data-first-offset="true"><span data-slate-string="true">├── instrumenter/    # 自动注入逻辑的相关结构</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9593"><span data-slate-object="text" data-key="9594"><span data-slate-leaf="true" data-offset-key="9594:0" data-first-offset="true"><span data-slate-string="true">│   ├── ast/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9595"><span data-slate-object="text" data-key="9596"><span data-slate-leaf="true" data-offset-key="9596:0" data-first-offset="true"><span data-slate-string="true">│   │   └── ast.</span></span></span><span data-slate-object="text" data-key="9597"><span data-slate-leaf="true" data-offset-key="9597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9598"><span data-slate-object="text" data-key="9599"><span data-slate-leaf="true" data-offset-key="9599:0" data-first-offset="true"><span data-slate-string="true">│   └── instrumenter.</span></span></span><span data-slate-object="text" data-key="9600"><span data-slate-leaf="true" data-offset-key="9600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9601"><span data-slate-object="text" data-key="9602"><span data-slate-leaf="true" data-offset-key="9602:0" data-first-offset="true"><span data-slate-string="true">└── trace.</span></span></span><span data-slate-object="text" data-key="9603"><span data-slate-leaf="true" data-offset-key="9603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9604"><span data-slate-object="text" data-key="9605"><span data-slate-leaf="true" data-offset-key="9605:0" data-first-offset="true"><span data-slate-string="true">我们先来看一下 cmd/instrument/main.go 源码，然后自上而下沿着 main 函数的调用逻辑逐一看一下这个功能的实现。下面是 main.go 的源码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9606"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9607"><span data-slate-object="text" data-key="9608"><span data-slate-leaf="true" data-offset-key="9608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//  instrument_trace/cmd/instrument/main.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9609"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9610"><span data-slate-object="text" data-key="9611"><span data-slate-leaf="true" data-offset-key="9611:0" data-first-offset="true"><span data-slate-string="true">... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9612"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9613"><span data-slate-object="text" data-key="9614"><span data-slate-leaf="true" data-offset-key="9614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9615"><span data-slate-leaf="true" data-offset-key="9615:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9616"><span data-slate-object="text" data-key="9617"><span data-slate-leaf="true" data-offset-key="9617:0" data-first-offset="true"><span data-slate-string="true">    wrote </span></span></span><span data-slate-object="text" data-key="9618"><span data-slate-leaf="true" data-offset-key="9618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9619"><span data-slate-object="text" data-key="9620"><span data-slate-leaf="true" data-offset-key="9620:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9621"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9622"><span data-slate-object="text" data-key="9623"><span data-slate-leaf="true" data-offset-key="9623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9624"><span data-slate-leaf="true" data-offset-key="9624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9625"><span data-slate-leaf="true" data-offset-key="9625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init</span></span></span></span></span><span data-slate-object="text" data-key="9626"><span data-slate-leaf="true" data-offset-key="9626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9627"><span data-slate-leaf="true" data-offset-key="9627:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9628"><span data-slate-object="text" data-key="9629"><span data-slate-leaf="true" data-offset-key="9629:0" data-first-offset="true"><span data-slate-string="true">    flag.BoolVar(&amp;wrote, </span></span></span><span data-slate-object="text" data-key="9630"><span data-slate-leaf="true" data-offset-key="9630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"w"</span></span></span></span><span data-slate-object="text" data-key="9631"><span data-slate-leaf="true" data-offset-key="9631:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9632"><span data-slate-leaf="true" data-offset-key="9632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="9633"><span data-slate-leaf="true" data-offset-key="9633:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9634"><span data-slate-leaf="true" data-offset-key="9634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"write result to (source) file instead of stdout"</span></span></span></span><span data-slate-object="text" data-key="9635"><span data-slate-leaf="true" data-offset-key="9635:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9636"><span data-slate-object="text" data-key="9637"><span data-slate-leaf="true" data-offset-key="9637:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9638"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9639"><span data-slate-object="text" data-key="9640"><span data-slate-leaf="true" data-offset-key="9640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9641"><span data-slate-leaf="true" data-offset-key="9641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9642"><span data-slate-leaf="true" data-offset-key="9642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">usage</span></span></span></span></span><span data-slate-object="text" data-key="9643"><span data-slate-leaf="true" data-offset-key="9643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9644"><span data-slate-leaf="true" data-offset-key="9644:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9645"><span data-slate-object="text" data-key="9646"><span data-slate-leaf="true" data-offset-key="9646:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="9647"><span data-slate-leaf="true" data-offset-key="9647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"instrument [-w] xxx.go"</span></span></span></span><span data-slate-object="text" data-key="9648"><span data-slate-leaf="true" data-offset-key="9648:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9649"><span data-slate-object="text" data-key="9650"><span data-slate-leaf="true" data-offset-key="9650:0" data-first-offset="true"><span data-slate-string="true">    flag.PrintDefaults()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9651"><span data-slate-object="text" data-key="9652"><span data-slate-leaf="true" data-offset-key="9652:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9653"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9654"><span data-slate-object="text" data-key="9655"><span data-slate-leaf="true" data-offset-key="9655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9656"><span data-slate-leaf="true" data-offset-key="9656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9657"><span data-slate-leaf="true" data-offset-key="9657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="9658"><span data-slate-leaf="true" data-offset-key="9658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9659"><span data-slate-leaf="true" data-offset-key="9659:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9660"><span data-slate-object="text" data-key="9661"><span data-slate-leaf="true" data-offset-key="9661:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(os.Args)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9662"><span data-slate-object="text" data-key="9663"><span data-slate-leaf="true" data-offset-key="9663:0" data-first-offset="true"><span data-slate-string="true">    flag.Usage = usage</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9664"><span data-slate-object="text" data-key="9665"><span data-slate-leaf="true" data-offset-key="9665:0" data-first-offset="true"><span data-slate-string="true">    flag.Parse() </span></span></span><span data-slate-object="text" data-key="9666"><span data-slate-leaf="true" data-offset-key="9666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解析命令行参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9667"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9668"><span data-slate-object="text" data-key="9669"><span data-slate-leaf="true" data-offset-key="9669:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9670"><span data-slate-leaf="true" data-offset-key="9670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9671"><span data-slate-leaf="true" data-offset-key="9671:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9672"><span data-slate-leaf="true" data-offset-key="9672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="9673"><span data-slate-leaf="true" data-offset-key="9673:0" data-first-offset="true"><span data-slate-string="true">(os.Args) &lt; </span></span></span><span data-slate-object="text" data-key="9674"><span data-slate-leaf="true" data-offset-key="9674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="9675"><span data-slate-leaf="true" data-offset-key="9675:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="9676"><span data-slate-leaf="true" data-offset-key="9676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对命令行参数个数进行校验</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9677"><span data-slate-object="text" data-key="9678"><span data-slate-leaf="true" data-offset-key="9678:0" data-first-offset="true"><span data-slate-string="true">        usage()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9679"><span data-slate-object="text" data-key="9680"><span data-slate-leaf="true" data-offset-key="9680:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9681"><span data-slate-leaf="true" data-offset-key="9681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9682"><span data-slate-object="text" data-key="9683"><span data-slate-leaf="true" data-offset-key="9683:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9684"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9685"><span data-slate-object="text" data-key="9686"><span data-slate-leaf="true" data-offset-key="9686:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9687"><span data-slate-leaf="true" data-offset-key="9687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9688"><span data-slate-leaf="true" data-offset-key="9688:0" data-first-offset="true"><span data-slate-string="true"> file </span></span></span><span data-slate-object="text" data-key="9689"><span data-slate-leaf="true" data-offset-key="9689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9690"><span data-slate-object="text" data-key="9691"><span data-slate-leaf="true" data-offset-key="9691:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9692"><span data-slate-leaf="true" data-offset-key="9692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9693"><span data-slate-leaf="true" data-offset-key="9693:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9694"><span data-slate-leaf="true" data-offset-key="9694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="9695"><span data-slate-leaf="true" data-offset-key="9695:0" data-first-offset="true"><span data-slate-string="true">(os.Args) == </span></span></span><span data-slate-object="text" data-key="9696"><span data-slate-leaf="true" data-offset-key="9696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="9697"><span data-slate-leaf="true" data-offset-key="9697:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9698"><span data-slate-object="text" data-key="9699"><span data-slate-leaf="true" data-offset-key="9699:0" data-first-offset="true"><span data-slate-string="true">        file = os.Args[</span></span></span><span data-slate-object="text" data-key="9700"><span data-slate-leaf="true" data-offset-key="9700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="9701"><span data-slate-leaf="true" data-offset-key="9701:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9702"><span data-slate-object="text" data-key="9703"><span data-slate-leaf="true" data-offset-key="9703:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9704"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9705"><span data-slate-object="text" data-key="9706"><span data-slate-leaf="true" data-offset-key="9706:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9707"><span data-slate-leaf="true" data-offset-key="9707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9708"><span data-slate-leaf="true" data-offset-key="9708:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9709"><span data-slate-leaf="true" data-offset-key="9709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="9710"><span data-slate-leaf="true" data-offset-key="9710:0" data-first-offset="true"><span data-slate-string="true">(os.Args) == </span></span></span><span data-slate-object="text" data-key="9711"><span data-slate-leaf="true" data-offset-key="9711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="9712"><span data-slate-leaf="true" data-offset-key="9712:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9713"><span data-slate-object="text" data-key="9714"><span data-slate-leaf="true" data-offset-key="9714:0" data-first-offset="true"><span data-slate-string="true">        file = os.Args[</span></span></span><span data-slate-object="text" data-key="9715"><span data-slate-leaf="true" data-offset-key="9715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="9716"><span data-slate-leaf="true" data-offset-key="9716:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9717"><span data-slate-object="text" data-key="9718"><span data-slate-leaf="true" data-offset-key="9718:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9719"><span data-slate-object="text" data-key="9720"><span data-slate-leaf="true" data-offset-key="9720:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9721"><span data-slate-leaf="true" data-offset-key="9721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9722"><span data-slate-leaf="true" data-offset-key="9722:0" data-first-offset="true"><span data-slate-string="true"> filepath.Ext(file) != </span></span></span><span data-slate-object="text" data-key="9723"><span data-slate-leaf="true" data-offset-key="9723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">".go"</span></span></span></span><span data-slate-object="text" data-key="9724"><span data-slate-leaf="true" data-offset-key="9724:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="9725"><span data-slate-leaf="true" data-offset-key="9725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对源文件扩展名进行校验</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9726"><span data-slate-object="text" data-key="9727"><span data-slate-leaf="true" data-offset-key="9727:0" data-first-offset="true"><span data-slate-string="true">        usage()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9728"><span data-slate-object="text" data-key="9729"><span data-slate-leaf="true" data-offset-key="9729:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9730"><span data-slate-leaf="true" data-offset-key="9730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9731"><span data-slate-object="text" data-key="9732"><span data-slate-leaf="true" data-offset-key="9732:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9733"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9734"><span data-slate-object="text" data-key="9735"><span data-slate-leaf="true" data-offset-key="9735:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9736"><span data-slate-leaf="true" data-offset-key="9736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="9737"><span data-slate-leaf="true" data-offset-key="9737:0" data-first-offset="true"><span data-slate-string="true"> ins instrumenter.Instrumenter </span></span></span><span data-slate-object="text" data-key="9738"><span data-slate-leaf="true" data-offset-key="9738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 声明 instrumenter.Instrumenter 接口类型变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9739"><span data-slate-object="text" data-key="9740"><span data-slate-leaf="true" data-offset-key="9740:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9741"><span data-slate-object="text" data-key="9742"><span data-slate-leaf="true" data-offset-key="9742:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9743"><span data-slate-leaf="true" data-offset-key="9743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建以 ast 方式实现 Instrumenter 接口的 ast.instrumenter 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9744"><span data-slate-object="text" data-key="9745"><span data-slate-leaf="true" data-offset-key="9745:0" data-first-offset="true"><span data-slate-string="true">    ins = ast.New(</span></span></span><span data-slate-object="text" data-key="9746"><span data-slate-leaf="true" data-offset-key="9746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/bigwhite/instrument_trace"</span></span></span></span><span data-slate-object="text" data-key="9747"><span data-slate-leaf="true" data-offset-key="9747:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9748"><span data-slate-leaf="true" data-offset-key="9748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"trace"</span></span></span></span><span data-slate-object="text" data-key="9749"><span data-slate-leaf="true" data-offset-key="9749:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9750"><span data-slate-leaf="true" data-offset-key="9750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Trace"</span></span></span></span><span data-slate-object="text" data-key="9751"><span data-slate-leaf="true" data-offset-key="9751:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9752"><span data-slate-object="text" data-key="9753"><span data-slate-leaf="true" data-offset-key="9753:0" data-first-offset="true"><span data-slate-string="true">    newSrc, err := ins.Instrument(file) </span></span></span><span data-slate-object="text" data-key="9754"><span data-slate-leaf="true" data-offset-key="9754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 Go 源文件所有函数注入 Trace 函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9755"><span data-slate-object="text" data-key="9756"><span data-slate-leaf="true" data-offset-key="9756:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9757"><span data-slate-leaf="true" data-offset-key="9757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9758"><span data-slate-leaf="true" data-offset-key="9758:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="9759"><span data-slate-leaf="true" data-offset-key="9759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9760"><span data-slate-leaf="true" data-offset-key="9760:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9761"><span data-slate-object="text" data-key="9762"><span data-slate-leaf="true" data-offset-key="9762:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9763"><span data-slate-leaf="true" data-offset-key="9763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="9764"><span data-slate-leaf="true" data-offset-key="9764:0" data-first-offset="true"><span data-slate-string="true">(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9765"><span data-slate-object="text" data-key="9766"><span data-slate-leaf="true" data-offset-key="9766:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9767"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9768"><span data-slate-object="text" data-key="9769"><span data-slate-leaf="true" data-offset-key="9769:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9770"><span data-slate-leaf="true" data-offset-key="9770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9771"><span data-slate-leaf="true" data-offset-key="9771:0" data-first-offset="true"><span data-slate-string="true"> newSrc == </span></span></span><span data-slate-object="text" data-key="9772"><span data-slate-leaf="true" data-offset-key="9772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9773"><span data-slate-leaf="true" data-offset-key="9773:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9774"><span data-slate-object="text" data-key="9775"><span data-slate-leaf="true" data-offset-key="9775:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9776"><span data-slate-leaf="true" data-offset-key="9776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// add nothing to the source file. no change</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9777"><span data-slate-object="text" data-key="9778"><span data-slate-leaf="true" data-offset-key="9778:0" data-first-offset="true"><span data-slate-string="true">        fmt.Printf(</span></span></span><span data-slate-object="text" data-key="9779"><span data-slate-leaf="true" data-offset-key="9779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"no trace added for %s\n"</span></span></span></span><span data-slate-object="text" data-key="9780"><span data-slate-leaf="true" data-offset-key="9780:0" data-first-offset="true"><span data-slate-string="true">, file)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9781"><span data-slate-object="text" data-key="9782"><span data-slate-leaf="true" data-offset-key="9782:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9783"><span data-slate-leaf="true" data-offset-key="9783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9784"><span data-slate-object="text" data-key="9785"><span data-slate-leaf="true" data-offset-key="9785:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9786"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9787"><span data-slate-object="text" data-key="9788"><span data-slate-leaf="true" data-offset-key="9788:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9789"><span data-slate-leaf="true" data-offset-key="9789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9790"><span data-slate-leaf="true" data-offset-key="9790:0" data-first-offset="true"><span data-slate-string="true"> !wrote {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9791"><span data-slate-object="text" data-key="9792"><span data-slate-leaf="true" data-offset-key="9792:0" data-first-offset="true"><span data-slate-string="true">        fmt.Println(</span></span></span><span data-slate-object="text" data-key="9793"><span data-slate-leaf="true" data-offset-key="9793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="9794"><span data-slate-leaf="true" data-offset-key="9794:0" data-first-offset="true"><span data-slate-string="true">(newSrc))  </span></span></span><span data-slate-object="text" data-key="9795"><span data-slate-leaf="true" data-offset-key="9795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将生成的新代码内容输出到 stdout 上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9796"><span data-slate-object="text" data-key="9797"><span data-slate-leaf="true" data-offset-key="9797:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9798"><span data-slate-leaf="true" data-offset-key="9798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9799"><span data-slate-object="text" data-key="9800"><span data-slate-leaf="true" data-offset-key="9800:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9801"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9802"><span data-slate-object="text" data-key="9803"><span data-slate-leaf="true" data-offset-key="9803:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9804"><span data-slate-leaf="true" data-offset-key="9804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将生成的新代码内容写回原 Go 源文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9805"><span data-slate-object="text" data-key="9806"><span data-slate-leaf="true" data-offset-key="9806:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9807"><span data-slate-leaf="true" data-offset-key="9807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9808"><span data-slate-leaf="true" data-offset-key="9808:0" data-first-offset="true"><span data-slate-string="true"> err = ioutil.WriteFile(file, newSrc, </span></span></span><span data-slate-object="text" data-key="9809"><span data-slate-leaf="true" data-offset-key="9809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0666</span></span></span></span><span data-slate-object="text" data-key="9810"><span data-slate-leaf="true" data-offset-key="9810:0" data-first-offset="true"><span data-slate-string="true">); err != </span></span></span><span data-slate-object="text" data-key="9811"><span data-slate-leaf="true" data-offset-key="9811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9812"><span data-slate-leaf="true" data-offset-key="9812:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9813"><span data-slate-object="text" data-key="9814"><span data-slate-leaf="true" data-offset-key="9814:0" data-first-offset="true"><span data-slate-string="true">        fmt.Printf(</span></span></span><span data-slate-object="text" data-key="9815"><span data-slate-leaf="true" data-offset-key="9815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"write %s error: %v\n"</span></span></span></span><span data-slate-object="text" data-key="9816"><span data-slate-leaf="true" data-offset-key="9816:0" data-first-offset="true"><span data-slate-string="true">, file, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9817"><span data-slate-object="text" data-key="9818"><span data-slate-leaf="true" data-offset-key="9818:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9819"><span data-slate-leaf="true" data-offset-key="9819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9820"><span data-slate-object="text" data-key="9821"><span data-slate-leaf="true" data-offset-key="9821:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9822"><span data-slate-object="text" data-key="9823"><span data-slate-leaf="true" data-offset-key="9823:0" data-first-offset="true"><span data-slate-string="true">    fmt.Printf(</span></span></span><span data-slate-object="text" data-key="9824"><span data-slate-leaf="true" data-offset-key="9824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"instrument trace for %s ok\n"</span></span></span></span><span data-slate-object="text" data-key="9825"><span data-slate-leaf="true" data-offset-key="9825:0" data-first-offset="true"><span data-slate-string="true">, file)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9826"><span data-slate-object="text" data-key="9827"><span data-slate-leaf="true" data-offset-key="9827:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9828"><span data-slate-object="text" data-key="9829"><span data-slate-leaf="true" data-offset-key="9829:0" data-first-offset="true"><span data-slate-string="true">作为命令行工具，instrument 使用标准库的 flag 包实现对命令行参数（这里是 -w）的解析，通过 os.Args 获取待注入的 Go 源文件路径。在完成对命令行参数个数与值的校验后，instrument 程序声明了一个 instrumenter.Instrumenter 接口类型变量 ins，然后创建了一个实现了 Instrumenter 接口类型的 ast.instrumenter 类型的实例，并赋值给变量 ins。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9830"><span data-slate-object="text" data-key="9831"><span data-slate-leaf="true" data-offset-key="9831:0" data-first-offset="true"><span data-slate-string="true">instrumenter.Instrumenter 接口类型的声明放在了 instrumenter/instrumenter.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9832"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9833"><span data-slate-object="text" data-key="9834"><span data-slate-leaf="true" data-offset-key="9834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="9835"><span data-slate-leaf="true" data-offset-key="9835:0" data-first-offset="true"><span data-slate-string="true"> Instrumenter </span></span></span><span data-slate-object="text" data-key="9836"><span data-slate-leaf="true" data-offset-key="9836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="9837"><span data-slate-leaf="true" data-offset-key="9837:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9838"><span data-slate-object="text" data-key="9839"><span data-slate-leaf="true" data-offset-key="9839:0" data-first-offset="true"><span data-slate-string="true">    Instrument(</span></span></span><span data-slate-object="text" data-key="9840"><span data-slate-leaf="true" data-offset-key="9840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="9841"><span data-slate-leaf="true" data-offset-key="9841:0" data-first-offset="true"><span data-slate-string="true">) ([]</span></span></span><span data-slate-object="text" data-key="9842"><span data-slate-leaf="true" data-offset-key="9842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="9843"><span data-slate-leaf="true" data-offset-key="9843:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9844"><span data-slate-leaf="true" data-offset-key="9844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="9845"><span data-slate-leaf="true" data-offset-key="9845:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9846"><span data-slate-object="text" data-key="9847"><span data-slate-leaf="true" data-offset-key="9847:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9848"><span data-slate-object="text" data-key="9849"><span data-slate-leaf="true" data-offset-key="9849:0" data-first-offset="true"><span data-slate-string="true">这里我们看到，这个接口类型的方法列表中只有一个方法 Instrument，这个方法接受一个 Go 源文件路径，返回注入了 Trace 函数的新源文件内容以及一个 error 类型值，作为错误状态标识。我们之所以要抽象出一个接口类型，考虑的就是注入 Trace 函数的实现方法不一，为后续的扩展做好预留。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9850"><span data-slate-object="text" data-key="9851"><span data-slate-leaf="true" data-offset-key="9851:0" data-first-offset="true"><span data-slate-string="true">在这个例子中，我们默认提供了一种自动注入 Trace 函数的实现，那就是 ast.instrumenter，它注入 Trace 的实现原理是这样的：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9852"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/5b/a8/5be0efb3920c39cd9f252af0b26e7ca8.jpg?wh=1980x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9853"><span data-slate-object="text" data-key="9854"><span data-slate-leaf="true" data-offset-key="9854:0" data-first-offset="true"><span data-slate-string="true">从原理图中我们可以清楚地看到，在这一实现方案中，我们先将传入的 Go 源码转换为</span></span></span><span data-slate-object="text" data-key="9855"><span data-slate-leaf="true" data-offset-key="9855:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">抽象语法树</span></span></span></span><span data-slate-object="text" data-key="9856"><span data-slate-leaf="true" data-offset-key="9856:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9857"><span data-slate-object="text" data-key="9858"><span data-slate-leaf="true" data-offset-key="9858:0" data-first-offset="true"><span data-slate-string="true">在计算机科学中，抽象语法树（abstract syntax tree，AST）是源代码的抽象语法结构的树状表现形式，树上的每个节点都表示源代码中的一种结构。因为 Go 语言是开源编程语言，所以它的抽象语法树的操作包也和语言一起开放给了 Go 开发人员，我们可以基于 Go 标准库以及 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9859"><span data-slate-object="text" data-key="9860"><span data-slate-leaf="true" data-offset-key="9860:0" data-first-offset="true"><span data-slate-string="true">Go 实验工具库</span></span></span></a><span data-slate-object="text" data-key="9861"><span data-slate-leaf="true" data-offset-key="9861:0" data-first-offset="true"><span data-slate-string="true">提供的 ast 相关包，快速地构建基于 AST 的应用，这里的 ast.instrumenter 就是一个应用 AST 的典型例子。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9862"><span data-slate-object="text" data-key="9863"><span data-slate-leaf="true" data-offset-key="9863:0" data-first-offset="true"><span data-slate-string="true">一旦我们通过 ast 相关包解析 Go 源码得到相应的抽象语法树后，我们便可以操作这棵语法树，并按我们的逻辑在语法树中注入我们的 Trace 函数，最后我们再将修改后的抽象语法树转换为 Go 源码，就完成了整个自动注入的工作了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9864"><span data-slate-object="text" data-key="9865"><span data-slate-leaf="true" data-offset-key="9865:0" data-first-offset="true"><span data-slate-string="true">了解了原理后，我们再看一下具体的代码实现。下面是 ast.instrumenter 的 Instructment 方法的代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9866"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9867"><span data-slate-object="text" data-key="9868"><span data-slate-leaf="true" data-offset-key="9868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// instrument_trace/instrumenter/ast/ast.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9869"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9870"><span data-slate-object="text" data-key="9871"><span data-slate-leaf="true" data-offset-key="9871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9872"><span data-slate-leaf="true" data-offset-key="9872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9873"><span data-slate-leaf="true" data-offset-key="9873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a instrumenter)</span></span></span></span></span><span data-slate-object="text" data-key="9874"><span data-slate-leaf="true" data-offset-key="9874:0" data-first-offset="true"><span data-slate-string="true"> Instrument(filename </span></span></span><span data-slate-object="text" data-key="9875"><span data-slate-leaf="true" data-offset-key="9875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="9876"><span data-slate-leaf="true" data-offset-key="9876:0" data-first-offset="true"><span data-slate-string="true">) ([]</span></span></span><span data-slate-object="text" data-key="9877"><span data-slate-leaf="true" data-offset-key="9877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="9878"><span data-slate-leaf="true" data-offset-key="9878:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9879"><span data-slate-leaf="true" data-offset-key="9879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="9880"><span data-slate-leaf="true" data-offset-key="9880:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9881"><span data-slate-object="text" data-key="9882"><span data-slate-leaf="true" data-offset-key="9882:0" data-first-offset="true"><span data-slate-string="true">    fset := token.NewFileSet()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9883"><span data-slate-object="text" data-key="9884"><span data-slate-leaf="true" data-offset-key="9884:0" data-first-offset="true"><span data-slate-string="true">    curAST, err := parser.ParseFile(fset, filename, </span></span></span><span data-slate-object="text" data-key="9885"><span data-slate-leaf="true" data-offset-key="9885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9886"><span data-slate-leaf="true" data-offset-key="9886:0" data-first-offset="true"><span data-slate-string="true">, parser.ParseComments) </span></span></span><span data-slate-object="text" data-key="9887"><span data-slate-leaf="true" data-offset-key="9887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解析 Go 源码，得到 AST</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9888"><span data-slate-object="text" data-key="9889"><span data-slate-leaf="true" data-offset-key="9889:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9890"><span data-slate-leaf="true" data-offset-key="9890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9891"><span data-slate-leaf="true" data-offset-key="9891:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="9892"><span data-slate-leaf="true" data-offset-key="9892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9893"><span data-slate-leaf="true" data-offset-key="9893:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9894"><span data-slate-object="text" data-key="9895"><span data-slate-leaf="true" data-offset-key="9895:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9896"><span data-slate-leaf="true" data-offset-key="9896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9897"><span data-slate-leaf="true" data-offset-key="9897:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9898"><span data-slate-leaf="true" data-offset-key="9898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9899"><span data-slate-leaf="true" data-offset-key="9899:0" data-first-offset="true"><span data-slate-string="true">, fmt.Errorf(</span></span></span><span data-slate-object="text" data-key="9900"><span data-slate-leaf="true" data-offset-key="9900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"error parsing %s: %w"</span></span></span></span><span data-slate-object="text" data-key="9901"><span data-slate-leaf="true" data-offset-key="9901:0" data-first-offset="true"><span data-slate-string="true">, filename, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9902"><span data-slate-object="text" data-key="9903"><span data-slate-leaf="true" data-offset-key="9903:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9904"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9905"><span data-slate-object="text" data-key="9906"><span data-slate-leaf="true" data-offset-key="9906:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9907"><span data-slate-leaf="true" data-offset-key="9907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9908"><span data-slate-leaf="true" data-offset-key="9908:0" data-first-offset="true"><span data-slate-string="true"> !hasFuncDecl(curAST) { </span></span></span><span data-slate-object="text" data-key="9909"><span data-slate-leaf="true" data-offset-key="9909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果整个源码都不包含函数声明，则无需注入操作，直接返回。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9910"><span data-slate-object="text" data-key="9911"><span data-slate-leaf="true" data-offset-key="9911:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9912"><span data-slate-leaf="true" data-offset-key="9912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9913"><span data-slate-leaf="true" data-offset-key="9913:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9914"><span data-slate-leaf="true" data-offset-key="9914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9915"><span data-slate-leaf="true" data-offset-key="9915:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9916"><span data-slate-leaf="true" data-offset-key="9916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9917"><span data-slate-object="text" data-key="9918"><span data-slate-leaf="true" data-offset-key="9918:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9919"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9920"><span data-slate-object="text" data-key="9921"><span data-slate-leaf="true" data-offset-key="9921:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9922"><span data-slate-leaf="true" data-offset-key="9922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 AST 上添加包导入语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9923"><span data-slate-object="text" data-key="9924"><span data-slate-leaf="true" data-offset-key="9924:0" data-first-offset="true"><span data-slate-string="true">    astutil.AddImport(fset, curAST, a.traceImport)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9925"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9926"><span data-slate-object="text" data-key="9927"><span data-slate-leaf="true" data-offset-key="9927:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9928"><span data-slate-leaf="true" data-offset-key="9928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 AST 上的所有函数注入 Trace 函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9929"><span data-slate-object="text" data-key="9930"><span data-slate-leaf="true" data-offset-key="9930:0" data-first-offset="true"><span data-slate-string="true">    a.addDeferTraceIntoFuncDecls(curAST)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9931"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9932"><span data-slate-object="text" data-key="9933"><span data-slate-leaf="true" data-offset-key="9933:0" data-first-offset="true"><span data-slate-string="true">    buf := &amp;bytes.Buffer{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9934"><span data-slate-object="text" data-key="9935"><span data-slate-leaf="true" data-offset-key="9935:0" data-first-offset="true"><span data-slate-string="true">    err = format.Node(buf, fset, curAST) </span></span></span><span data-slate-object="text" data-key="9936"><span data-slate-leaf="true" data-offset-key="9936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将修改后的 AST 转换回 Go 源码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9937"><span data-slate-object="text" data-key="9938"><span data-slate-leaf="true" data-offset-key="9938:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9939"><span data-slate-leaf="true" data-offset-key="9939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9940"><span data-slate-leaf="true" data-offset-key="9940:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="9941"><span data-slate-leaf="true" data-offset-key="9941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9942"><span data-slate-leaf="true" data-offset-key="9942:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9943"><span data-slate-object="text" data-key="9944"><span data-slate-leaf="true" data-offset-key="9944:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9945"><span data-slate-leaf="true" data-offset-key="9945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9946"><span data-slate-leaf="true" data-offset-key="9946:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9947"><span data-slate-leaf="true" data-offset-key="9947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9948"><span data-slate-leaf="true" data-offset-key="9948:0" data-first-offset="true"><span data-slate-string="true">, fmt.Errorf(</span></span></span><span data-slate-object="text" data-key="9949"><span data-slate-leaf="true" data-offset-key="9949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"error formatting new code: %w"</span></span></span></span><span data-slate-object="text" data-key="9950"><span data-slate-leaf="true" data-offset-key="9950:0" data-first-offset="true"><span data-slate-string="true">, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9951"><span data-slate-object="text" data-key="9952"><span data-slate-leaf="true" data-offset-key="9952:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9953"><span data-slate-object="text" data-key="9954"><span data-slate-leaf="true" data-offset-key="9954:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9955"><span data-slate-leaf="true" data-offset-key="9955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9956"><span data-slate-leaf="true" data-offset-key="9956:0" data-first-offset="true"><span data-slate-string="true"> buf.Bytes(), </span></span></span><span data-slate-object="text" data-key="9957"><span data-slate-leaf="true" data-offset-key="9957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9958"><span data-slate-leaf="true" data-offset-key="9958:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9959"><span data-slate-leaf="true" data-offset-key="9959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回转换后的 Go 源码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9960"><span data-slate-object="text" data-key="9961"><span data-slate-leaf="true" data-offset-key="9961:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9962"><span data-slate-object="text" data-key="9963"><span data-slate-leaf="true" data-offset-key="9963:0" data-first-offset="true"><span data-slate-string="true">通过代码，我们看到 Instrument 方法的基本步骤与上面原理图大同小异。Instrument 首先通过 go/paser 的 ParserFile 函数对传入的 Go 源文件中的源码进行解析，并得到对应的抽象语法树 AST，然后向 AST 中导入 Trace 函数所在的包，并向这个 AST 的所有函数声明注入 Trace 函数调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9964"><span data-slate-object="text" data-key="9965"><span data-slate-leaf="true" data-offset-key="9965:0" data-first-offset="true"><span data-slate-string="true">实际的注入操作发生在 instrumenter 的 addDeferTraceIntoFuncDecls 方法中，我们来看一下这个方法的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9966"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9967"><span data-slate-object="text" data-key="9968"><span data-slate-leaf="true" data-offset-key="9968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// instrument_trace/instrumenter/ast/ast.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9969"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9970"><span data-slate-object="text" data-key="9971"><span data-slate-leaf="true" data-offset-key="9971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9972"><span data-slate-leaf="true" data-offset-key="9972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9973"><span data-slate-leaf="true" data-offset-key="9973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a instrumenter)</span></span></span></span></span><span data-slate-object="text" data-key="9974"><span data-slate-leaf="true" data-offset-key="9974:0" data-first-offset="true"><span data-slate-string="true"> addDeferTraceIntoFuncDecls(f *ast.File) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9975"><span data-slate-object="text" data-key="9976"><span data-slate-leaf="true" data-offset-key="9976:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9977"><span data-slate-leaf="true" data-offset-key="9977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9978"><span data-slate-leaf="true" data-offset-key="9978:0" data-first-offset="true"><span data-slate-string="true"> _, decl := </span></span></span><span data-slate-object="text" data-key="9979"><span data-slate-leaf="true" data-offset-key="9979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="9980"><span data-slate-leaf="true" data-offset-key="9980:0" data-first-offset="true"><span data-slate-string="true"> f.Decls { </span></span></span><span data-slate-object="text" data-key="9981"><span data-slate-leaf="true" data-offset-key="9981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历所有声明语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9982"><span data-slate-object="text" data-key="9983"><span data-slate-leaf="true" data-offset-key="9983:0" data-first-offset="true"><span data-slate-string="true">        fd, ok := decl.(*ast.FuncDecl) </span></span></span><span data-slate-object="text" data-key="9984"><span data-slate-leaf="true" data-offset-key="9984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 类型断言：是否为函数声明</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9985"><span data-slate-object="text" data-key="9986"><span data-slate-leaf="true" data-offset-key="9986:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9987"><span data-slate-leaf="true" data-offset-key="9987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9988"><span data-slate-leaf="true" data-offset-key="9988:0" data-first-offset="true"><span data-slate-string="true"> ok { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9989"><span data-slate-object="text" data-key="9990"><span data-slate-leaf="true" data-offset-key="9990:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="9991"><span data-slate-leaf="true" data-offset-key="9991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是函数声明，则注入跟踪设施</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9992"><span data-slate-object="text" data-key="9993"><span data-slate-leaf="true" data-offset-key="9993:0" data-first-offset="true"><span data-slate-string="true">            a.addDeferStmt(fd)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9994"><span data-slate-object="text" data-key="9995"><span data-slate-leaf="true" data-offset-key="9995:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9996"><span data-slate-object="text" data-key="9997"><span data-slate-leaf="true" data-offset-key="9997:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9998"><span data-slate-object="text" data-key="9999"><span data-slate-leaf="true" data-offset-key="9999:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10000"><span data-slate-object="text" data-key="10001"><span data-slate-leaf="true" data-offset-key="10001:0" data-first-offset="true"><span data-slate-string="true">这个方法的逻辑十分清晰，就是遍历语法树上所有声明语句，如果是函数声明，就调用 instrumenter 的 addDeferStmt 方法进行注入，如果不是，就直接返回。addDeferStmt 方法的实现如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10002"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10003"><span data-slate-object="text" data-key="10004"><span data-slate-leaf="true" data-offset-key="10004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// instrument_trace/instrumenter/ast/ast.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10005"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10006"><span data-slate-object="text" data-key="10007"><span data-slate-leaf="true" data-offset-key="10007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10008"><span data-slate-leaf="true" data-offset-key="10008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10009"><span data-slate-leaf="true" data-offset-key="10009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a instrumenter)</span></span></span></span></span><span data-slate-object="text" data-key="10010"><span data-slate-leaf="true" data-offset-key="10010:0" data-first-offset="true"><span data-slate-string="true"> addDeferStmt(fd *ast.FuncDecl) (added </span></span></span><span data-slate-object="text" data-key="10011"><span data-slate-leaf="true" data-offset-key="10011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="10012"><span data-slate-leaf="true" data-offset-key="10012:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10013"><span data-slate-object="text" data-key="10014"><span data-slate-leaf="true" data-offset-key="10014:0" data-first-offset="true"><span data-slate-string="true">    stmts := fd.Body.List</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10015"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10016"><span data-slate-object="text" data-key="10017"><span data-slate-leaf="true" data-offset-key="10017:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10018"><span data-slate-leaf="true" data-offset-key="10018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断 "defer trace.Trace ()()" 语句是否已经存在</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10019"><span data-slate-object="text" data-key="10020"><span data-slate-leaf="true" data-offset-key="10020:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10021"><span data-slate-leaf="true" data-offset-key="10021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10022"><span data-slate-leaf="true" data-offset-key="10022:0" data-first-offset="true"><span data-slate-string="true"> _, stmt := </span></span></span><span data-slate-object="text" data-key="10023"><span data-slate-leaf="true" data-offset-key="10023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="10024"><span data-slate-leaf="true" data-offset-key="10024:0" data-first-offset="true"><span data-slate-string="true"> stmts {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10025"><span data-slate-object="text" data-key="10026"><span data-slate-leaf="true" data-offset-key="10026:0" data-first-offset="true"><span data-slate-string="true">        ds, ok := stmt.(*ast.DeferStmt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10027"><span data-slate-object="text" data-key="10028"><span data-slate-leaf="true" data-offset-key="10028:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10029"><span data-slate-leaf="true" data-offset-key="10029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10030"><span data-slate-leaf="true" data-offset-key="10030:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10031"><span data-slate-object="text" data-key="10032"><span data-slate-leaf="true" data-offset-key="10032:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10033"><span data-slate-leaf="true" data-offset-key="10033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果不是 defer 语句，则继续 for 循环</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10034"><span data-slate-object="text" data-key="10035"><span data-slate-leaf="true" data-offset-key="10035:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10036"><span data-slate-leaf="true" data-offset-key="10036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10037"><span data-slate-object="text" data-key="10038"><span data-slate-leaf="true" data-offset-key="10038:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10039"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10040"><span data-slate-object="text" data-key="10041"><span data-slate-leaf="true" data-offset-key="10041:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10042"><span data-slate-leaf="true" data-offset-key="10042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 defer 语句，则要进一步判断是否是 defer trace.Trace ()()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10043"><span data-slate-object="text" data-key="10044"><span data-slate-leaf="true" data-offset-key="10044:0" data-first-offset="true"><span data-slate-string="true">        ce, ok := ds.Call.Fun.(*ast.CallExpr)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10045"><span data-slate-object="text" data-key="10046"><span data-slate-leaf="true" data-offset-key="10046:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10047"><span data-slate-leaf="true" data-offset-key="10047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10048"><span data-slate-leaf="true" data-offset-key="10048:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10049"><span data-slate-object="text" data-key="10050"><span data-slate-leaf="true" data-offset-key="10050:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10051"><span data-slate-leaf="true" data-offset-key="10051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10052"><span data-slate-object="text" data-key="10053"><span data-slate-leaf="true" data-offset-key="10053:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10054"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10055"><span data-slate-object="text" data-key="10056"><span data-slate-leaf="true" data-offset-key="10056:0" data-first-offset="true"><span data-slate-string="true">        se, ok := ce.Fun.(*ast.SelectorExpr)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10057"><span data-slate-object="text" data-key="10058"><span data-slate-leaf="true" data-offset-key="10058:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10059"><span data-slate-leaf="true" data-offset-key="10059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10060"><span data-slate-leaf="true" data-offset-key="10060:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10061"><span data-slate-object="text" data-key="10062"><span data-slate-leaf="true" data-offset-key="10062:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10063"><span data-slate-leaf="true" data-offset-key="10063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10064"><span data-slate-object="text" data-key="10065"><span data-slate-leaf="true" data-offset-key="10065:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10066"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10067"><span data-slate-object="text" data-key="10068"><span data-slate-leaf="true" data-offset-key="10068:0" data-first-offset="true"><span data-slate-string="true">        x, ok := se.X.(*ast.Ident)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10069"><span data-slate-object="text" data-key="10070"><span data-slate-leaf="true" data-offset-key="10070:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10071"><span data-slate-leaf="true" data-offset-key="10071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10072"><span data-slate-leaf="true" data-offset-key="10072:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10073"><span data-slate-object="text" data-key="10074"><span data-slate-leaf="true" data-offset-key="10074:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10075"><span data-slate-leaf="true" data-offset-key="10075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10076"><span data-slate-object="text" data-key="10077"><span data-slate-leaf="true" data-offset-key="10077:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10078"><span data-slate-object="text" data-key="10079"><span data-slate-leaf="true" data-offset-key="10079:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10080"><span data-slate-leaf="true" data-offset-key="10080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10081"><span data-slate-leaf="true" data-offset-key="10081:0" data-first-offset="true"><span data-slate-string="true"> (x.Name == a.tracePkg) &amp;&amp; (se.Sel.Name == a.traceFunc) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10082"><span data-slate-object="text" data-key="10083"><span data-slate-leaf="true" data-offset-key="10083:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10084"><span data-slate-leaf="true" data-offset-key="10084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//defer trace.Trace ()() 已存在，返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10085"><span data-slate-object="text" data-key="10086"><span data-slate-leaf="true" data-offset-key="10086:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10087"><span data-slate-leaf="true" data-offset-key="10087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10088"><span data-slate-leaf="true" data-offset-key="10088:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10089"><span data-slate-leaf="true" data-offset-key="10089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10090"><span data-slate-object="text" data-key="10091"><span data-slate-leaf="true" data-offset-key="10091:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10092"><span data-slate-object="text" data-key="10093"><span data-slate-leaf="true" data-offset-key="10093:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10094"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10095"><span data-slate-object="text" data-key="10096"><span data-slate-leaf="true" data-offset-key="10096:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10097"><span data-slate-leaf="true" data-offset-key="10097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 没有找到 "defer trace.Trace ()()"，注入一个新的跟踪语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10098"><span data-slate-object="text" data-key="10099"><span data-slate-leaf="true" data-offset-key="10099:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10100"><span data-slate-leaf="true" data-offset-key="10100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 AST 上构造一个 defer trace.Trace ()()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10101"><span data-slate-object="text" data-key="10102"><span data-slate-leaf="true" data-offset-key="10102:0" data-first-offset="true"><span data-slate-string="true">    ds := &amp;ast.DeferStmt{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10103"><span data-slate-object="text" data-key="10104"><span data-slate-leaf="true" data-offset-key="10104:0" data-first-offset="true"><span data-slate-string="true">        Call: &amp;ast.CallExpr{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10105"><span data-slate-object="text" data-key="10106"><span data-slate-leaf="true" data-offset-key="10106:0" data-first-offset="true"><span data-slate-string="true">            Fun: &amp;ast.CallExpr{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10107"><span data-slate-object="text" data-key="10108"><span data-slate-leaf="true" data-offset-key="10108:0" data-first-offset="true"><span data-slate-string="true">                Fun: &amp;ast.SelectorExpr{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10109"><span data-slate-object="text" data-key="10110"><span data-slate-leaf="true" data-offset-key="10110:0" data-first-offset="true"><span data-slate-string="true">                    X: &amp;ast.Ident{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10111"><span data-slate-object="text" data-key="10112"><span data-slate-leaf="true" data-offset-key="10112:0" data-first-offset="true"><span data-slate-string="true">                        Name: a.tracePkg,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10113"><span data-slate-object="text" data-key="10114"><span data-slate-leaf="true" data-offset-key="10114:0" data-first-offset="true"><span data-slate-string="true">                    },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10115"><span data-slate-object="text" data-key="10116"><span data-slate-leaf="true" data-offset-key="10116:0" data-first-offset="true"><span data-slate-string="true">                    Sel: &amp;ast.Ident{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10117"><span data-slate-object="text" data-key="10118"><span data-slate-leaf="true" data-offset-key="10118:0" data-first-offset="true"><span data-slate-string="true">                        Name: a.traceFunc,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10119"><span data-slate-object="text" data-key="10120"><span data-slate-leaf="true" data-offset-key="10120:0" data-first-offset="true"><span data-slate-string="true">                    },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10121"><span data-slate-object="text" data-key="10122"><span data-slate-leaf="true" data-offset-key="10122:0" data-first-offset="true"><span data-slate-string="true">                },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10123"><span data-slate-object="text" data-key="10124"><span data-slate-leaf="true" data-offset-key="10124:0" data-first-offset="true"><span data-slate-string="true">            },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10125"><span data-slate-object="text" data-key="10126"><span data-slate-leaf="true" data-offset-key="10126:0" data-first-offset="true"><span data-slate-string="true">        },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10127"><span data-slate-object="text" data-key="10128"><span data-slate-leaf="true" data-offset-key="10128:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10129"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10130"><span data-slate-object="text" data-key="10131"><span data-slate-leaf="true" data-offset-key="10131:0" data-first-offset="true"><span data-slate-string="true">    newList := </span></span></span><span data-slate-object="text" data-key="10132"><span data-slate-leaf="true" data-offset-key="10132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="10133"><span data-slate-leaf="true" data-offset-key="10133:0" data-first-offset="true"><span data-slate-string="true">([]ast.Stmt, </span></span></span><span data-slate-object="text" data-key="10134"><span data-slate-leaf="true" data-offset-key="10134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="10135"><span data-slate-leaf="true" data-offset-key="10135:0" data-first-offset="true"><span data-slate-string="true">(stmts)+</span></span></span><span data-slate-object="text" data-key="10136"><span data-slate-leaf="true" data-offset-key="10136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10137"><span data-slate-leaf="true" data-offset-key="10137:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10138"><span data-slate-object="text" data-key="10139"><span data-slate-leaf="true" data-offset-key="10139:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10140"><span data-slate-leaf="true" data-offset-key="10140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy</span></span></span></span><span data-slate-object="text" data-key="10141"><span data-slate-leaf="true" data-offset-key="10141:0" data-first-offset="true"><span data-slate-string="true">(newList[</span></span></span><span data-slate-object="text" data-key="10142"><span data-slate-leaf="true" data-offset-key="10142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10143"><span data-slate-leaf="true" data-offset-key="10143:0" data-first-offset="true"><span data-slate-string="true">:], stmts)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10144"><span data-slate-object="text" data-key="10145"><span data-slate-leaf="true" data-offset-key="10145:0" data-first-offset="true"><span data-slate-string="true">    newList[</span></span></span><span data-slate-object="text" data-key="10146"><span data-slate-leaf="true" data-offset-key="10146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10147"><span data-slate-leaf="true" data-offset-key="10147:0" data-first-offset="true"><span data-slate-string="true">] = ds </span></span></span><span data-slate-object="text" data-key="10148"><span data-slate-leaf="true" data-offset-key="10148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注入新构造的 defer 语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10149"><span data-slate-object="text" data-key="10150"><span data-slate-leaf="true" data-offset-key="10150:0" data-first-offset="true"><span data-slate-string="true">    fd.Body.List = newList</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10151"><span data-slate-object="text" data-key="10152"><span data-slate-leaf="true" data-offset-key="10152:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10153"><span data-slate-leaf="true" data-offset-key="10153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10154"><span data-slate-leaf="true" data-offset-key="10154:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10155"><span data-slate-leaf="true" data-offset-key="10155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10156"><span data-slate-object="text" data-key="10157"><span data-slate-leaf="true" data-offset-key="10157:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10158"><span data-slate-object="text" data-key="10159"><span data-slate-leaf="true" data-offset-key="10159:0" data-first-offset="true"><span data-slate-string="true">虽然 addDeferStmt 函数体略长，但逻辑也很清晰，就是先判断函数是否已经注入了 Trace，如果有，则略过；如果没有，就构造一个 Trace 语句节点，并将它插入到 AST 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10160"><span data-slate-object="text" data-key="10161"><span data-slate-leaf="true" data-offset-key="10161:0" data-first-offset="true"><span data-slate-string="true">Instrument 的最后一步就是将注入 Trace 后的 AST 重新转换为 Go 代码，这就是我们期望得到的带有 Trace 特性的 Go 代码了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10162" id="sr-toc-8"><span data-slate-object="text" data-key="10163"><span data-slate-leaf="true" data-offset-key="10163:0" data-first-offset="true"><span data-slate-string="true">利用 instrument 工具注入跟踪代码</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10164"><span data-slate-object="text" data-key="10165"><span data-slate-leaf="true" data-offset-key="10165:0" data-first-offset="true"><span data-slate-string="true">有了 instrument 工具后，我们再来看看如何使用这个工具，在目标 Go 源文件中自动注入跟踪设施。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10166"><span data-slate-object="text" data-key="10167"><span data-slate-leaf="true" data-offset-key="10167:0" data-first-offset="true"><span data-slate-string="true">这里，我在 instrument_trace 项目的 examples 目录下建立了一个名为 demo 的项目，我们就来看看如何使用 instrument 工具为 demo 项目下的 demo.go 文件自动注入跟踪设施。demo.go 文件内容很简单：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10168"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10169"><span data-slate-object="text" data-key="10170"><span data-slate-leaf="true" data-offset-key="10170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// instrument_trace/examples/demo/demo.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10171"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10172"><span data-slate-object="text" data-key="10173"><span data-slate-leaf="true" data-offset-key="10173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="10174"><span data-slate-leaf="true" data-offset-key="10174:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10175"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10176"><span data-slate-object="text" data-key="10177"><span data-slate-leaf="true" data-offset-key="10177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10178"><span data-slate-leaf="true" data-offset-key="10178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10179"><span data-slate-leaf="true" data-offset-key="10179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo</span></span></span></span></span><span data-slate-object="text" data-key="10180"><span data-slate-leaf="true" data-offset-key="10180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10181"><span data-slate-leaf="true" data-offset-key="10181:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10182"><span data-slate-object="text" data-key="10183"><span data-slate-leaf="true" data-offset-key="10183:0" data-first-offset="true"><span data-slate-string="true">    bar()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10184"><span data-slate-object="text" data-key="10185"><span data-slate-leaf="true" data-offset-key="10185:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10186"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10187"><span data-slate-object="text" data-key="10188"><span data-slate-leaf="true" data-offset-key="10188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10189"><span data-slate-leaf="true" data-offset-key="10189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10190"><span data-slate-leaf="true" data-offset-key="10190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="10191"><span data-slate-leaf="true" data-offset-key="10191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10192"><span data-slate-leaf="true" data-offset-key="10192:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10193"><span data-slate-object="text" data-key="10194"><span data-slate-leaf="true" data-offset-key="10194:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10195"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10196"><span data-slate-object="text" data-key="10197"><span data-slate-leaf="true" data-offset-key="10197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10198"><span data-slate-leaf="true" data-offset-key="10198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10199"><span data-slate-leaf="true" data-offset-key="10199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="10200"><span data-slate-leaf="true" data-offset-key="10200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10201"><span data-slate-leaf="true" data-offset-key="10201:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10202"><span data-slate-object="text" data-key="10203"><span data-slate-leaf="true" data-offset-key="10203:0" data-first-offset="true"><span data-slate-string="true">    foo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10204"><span data-slate-object="text" data-key="10205"><span data-slate-leaf="true" data-offset-key="10205:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10206"><span data-slate-object="text" data-key="10207"><span data-slate-leaf="true" data-offset-key="10207:0" data-first-offset="true"><span data-slate-string="true">我们首先构建一下 instrument_trace 下的 instrument 工具：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="10208"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10209"><span data-slate-object="text" data-key="10210"><span data-slate-leaf="true" data-offset-key="10210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$</span></span></span></span><span data-slate-object="text" data-key="10211"><span data-slate-leaf="true" data-offset-key="10211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cd</span></span></span></span></span><span data-slate-object="text" data-key="10212"><span data-slate-leaf="true" data-offset-key="10212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> instrument_trace</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10213"><span data-slate-object="text" data-key="10214"><span data-slate-leaf="true" data-offset-key="10214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$</span></span></span></span><span data-slate-object="text" data-key="10215"><span data-slate-leaf="true" data-offset-key="10215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go build github.com/bigwhite/instrument_trace/cmd/instrument</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10216"><span data-slate-object="text" data-key="10217"><span data-slate-leaf="true" data-offset-key="10217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$</span></span></span></span><span data-slate-object="text" data-key="10218"><span data-slate-leaf="true" data-offset-key="10218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">instrument version</span></span></span></span><span data-slate-object="text" data-key="10219"><span data-slate-leaf="true" data-offset-key="10219:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10220"><span data-slate-object="text" data-key="10221"><span data-slate-leaf="true" data-offset-key="10221:0" data-first-offset="true"><span data-slate-string="true">[instrument version]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10222"><span data-slate-object="text" data-key="10223"><span data-slate-leaf="true" data-offset-key="10223:0" data-first-offset="true"><span data-slate-string="true">instrument [-w] xxx.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10224"><span data-slate-object="text" data-key="10225"><span data-slate-leaf="true" data-offset-key="10225:0" data-first-offset="true"><span data-slate-string="true">  -w  write result to (source) file instead of stdout</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10226"><span data-slate-object="text" data-key="10227"><span data-slate-leaf="true" data-offset-key="10227:0" data-first-offset="true"><span data-slate-string="true">接下来，我们使用 instrument 工具向 examples/demo/demo.go 源文件中的函数自动注入跟踪设施：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="10228"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10229"><span data-slate-object="text" data-key="10230"><span data-slate-leaf="true" data-offset-key="10230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$instrument</span></span></span></span><span data-slate-object="text" data-key="10231"><span data-slate-leaf="true" data-offset-key="10231:0" data-first-offset="true"><span data-slate-string="true"> -w  examples/demo/demo.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10232"><span data-slate-object="text" data-key="10233"><span data-slate-leaf="true" data-offset-key="10233:0" data-first-offset="true"><span data-slate-string="true">[instrument -w examples/demo/demo.go]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10234"><span data-slate-object="text" data-key="10235"><span data-slate-leaf="true" data-offset-key="10235:0" data-first-offset="true"><span data-slate-string="true">instrument trace </span></span></span><span data-slate-object="text" data-key="10236"><span data-slate-leaf="true" data-offset-key="10236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10237"><span data-slate-leaf="true" data-offset-key="10237:0" data-first-offset="true"><span data-slate-string="true"> examples/demo/demo.go ok</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10238"><span data-slate-object="text" data-key="10239"><span data-slate-leaf="true" data-offset-key="10239:0" data-first-offset="true"><span data-slate-string="true">注入后的 demo.go 文件变为了下面这个样子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="10240"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10241"><span data-slate-object="text" data-key="10242"><span data-slate-leaf="true" data-offset-key="10242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// instrument_trace/examples/demo/demo.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10243"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10244"><span data-slate-object="text" data-key="10245"><span data-slate-leaf="true" data-offset-key="10245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="10246"><span data-slate-leaf="true" data-offset-key="10246:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10247"><span data-slate-object="text" data-key="10248"><span data-slate-leaf="true" data-offset-key="10248:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10249"><span data-slate-object="text" data-key="10250"><span data-slate-leaf="true" data-offset-key="10250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="10251"><span data-slate-leaf="true" data-offset-key="10251:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10252"><span data-slate-leaf="true" data-offset-key="10252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/bigwhite/instrument_trace"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10253"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10254"><span data-slate-object="text" data-key="10255"><span data-slate-leaf="true" data-offset-key="10255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10256"><span data-slate-leaf="true" data-offset-key="10256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10257"><span data-slate-leaf="true" data-offset-key="10257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo</span></span></span></span></span><span data-slate-object="text" data-key="10258"><span data-slate-leaf="true" data-offset-key="10258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10259"><span data-slate-leaf="true" data-offset-key="10259:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10260"><span data-slate-object="text" data-key="10261"><span data-slate-leaf="true" data-offset-key="10261:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10262"><span data-slate-leaf="true" data-offset-key="10262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="10263"><span data-slate-leaf="true" data-offset-key="10263:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10264"><span data-slate-object="text" data-key="10265"><span data-slate-leaf="true" data-offset-key="10265:0" data-first-offset="true"><span data-slate-string="true">    bar()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10266"><span data-slate-object="text" data-key="10267"><span data-slate-leaf="true" data-offset-key="10267:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10268"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10269"><span data-slate-object="text" data-key="10270"><span data-slate-leaf="true" data-offset-key="10270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10271"><span data-slate-leaf="true" data-offset-key="10271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10272"><span data-slate-leaf="true" data-offset-key="10272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="10273"><span data-slate-leaf="true" data-offset-key="10273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10274"><span data-slate-leaf="true" data-offset-key="10274:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10275"><span data-slate-object="text" data-key="10276"><span data-slate-leaf="true" data-offset-key="10276:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10277"><span data-slate-leaf="true" data-offset-key="10277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="10278"><span data-slate-leaf="true" data-offset-key="10278:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10279"><span data-slate-object="text" data-key="10280"><span data-slate-leaf="true" data-offset-key="10280:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10281"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10282"><span data-slate-object="text" data-key="10283"><span data-slate-leaf="true" data-offset-key="10283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="10284"><span data-slate-leaf="true" data-offset-key="10284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="10285"><span data-slate-leaf="true" data-offset-key="10285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="10286"><span data-slate-leaf="true" data-offset-key="10286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10287"><span data-slate-leaf="true" data-offset-key="10287:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10288"><span data-slate-object="text" data-key="10289"><span data-slate-leaf="true" data-offset-key="10289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10290"><span data-slate-leaf="true" data-offset-key="10290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="10291"><span data-slate-leaf="true" data-offset-key="10291:0" data-first-offset="true"><span data-slate-string="true"> trace.Trace()()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10292"><span data-slate-object="text" data-key="10293"><span data-slate-leaf="true" data-offset-key="10293:0" data-first-offset="true"><span data-slate-string="true">    foo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10294"><span data-slate-object="text" data-key="10295"><span data-slate-leaf="true" data-offset-key="10295:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10296"><span data-slate-object="text" data-key="10297"><span data-slate-leaf="true" data-offset-key="10297:0" data-first-offset="true"><span data-slate-string="true">此时，如果我们再对已注入 Trace 函数的 demo.go 执行一次 instrument 命令，由于 instrument 会判断 demo.go 各个函数已经注入了 Trace，demo.go 的内容将保持不变。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10298"><span data-slate-object="text" data-key="10299"><span data-slate-leaf="true" data-offset-key="10299:0" data-first-offset="true"><span data-slate-string="true">由于 github.com/bigwhite/instrument_trace 并没有真正上传到 github.com 上，所以如果你要运行 demo.go，我们可以为它配置一个下面这样的 go.mod：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="10300"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10301"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10302"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10303"><span data-slate-object="text" data-key="10304"><span data-slate-leaf="true" data-offset-key="10304:0" data-first-offset="true"><span data-slate-string="true">// instrument_trace/examples/demo/go.mod</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10305"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10306"><span data-slate-object="text" data-key="10307"><span data-slate-leaf="true" data-offset-key="10307:0" data-first-offset="true"><span data-slate-string="true">module demo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10308"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10309"><span data-slate-object="text" data-key="10310"><span data-slate-leaf="true" data-offset-key="10310:0" data-first-offset="true"><span data-slate-string="true">go 1.17</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10311"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10312"><span data-slate-object="text" data-key="10313"><span data-slate-leaf="true" data-offset-key="10313:0" data-first-offset="true"><span data-slate-string="true">require github.com/bigwhite/instrument_trace v1.0.0</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10314"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10315"><span data-slate-object="text" data-key="10316"><span data-slate-leaf="true" data-offset-key="10316:0" data-first-offset="true"><span data-slate-string="true">replace github.com/bigwhite/instrument_trace v1.0.0 =&gt; ../../</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10317"><span data-slate-object="text" data-key="10318"><span data-slate-leaf="true" data-offset-key="10318:0" data-first-offset="true"><span data-slate-string="true">这样运行 demo.go 就不会遇到障碍了：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="10319"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10320"><span data-slate-object="text" data-key="10321"><span data-slate-leaf="true" data-offset-key="10321:0" data-first-offset="true"><span data-slate-string="true">$go run demo.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10322"><span data-slate-object="text" data-key="10323"><span data-slate-leaf="true" data-offset-key="10323:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="10324"><span data-slate-leaf="true" data-offset-key="10324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="10325"><span data-slate-leaf="true" data-offset-key="10325:0" data-first-offset="true"><span data-slate-string="true">]:    </span></span></span><span data-slate-object="text" data-key="10326"><span data-slate-leaf="true" data-offset-key="10326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="10327"><span data-slate-leaf="true" data-offset-key="10327:0" data-first-offset="true"><span data-slate-string="true">main.main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10328"><span data-slate-object="text" data-key="10329"><span data-slate-leaf="true" data-offset-key="10329:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="10330"><span data-slate-leaf="true" data-offset-key="10330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="10331"><span data-slate-leaf="true" data-offset-key="10331:0" data-first-offset="true"><span data-slate-string="true">]:        </span></span></span><span data-slate-object="text" data-key="10332"><span data-slate-leaf="true" data-offset-key="10332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="10333"><span data-slate-leaf="true" data-offset-key="10333:0" data-first-offset="true"><span data-slate-string="true">main.foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10334"><span data-slate-object="text" data-key="10335"><span data-slate-leaf="true" data-offset-key="10335:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="10336"><span data-slate-leaf="true" data-offset-key="10336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="10337"><span data-slate-leaf="true" data-offset-key="10337:0" data-first-offset="true"><span data-slate-string="true">]:            </span></span></span><span data-slate-object="text" data-key="10338"><span data-slate-leaf="true" data-offset-key="10338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="10339"><span data-slate-leaf="true" data-offset-key="10339:0" data-first-offset="true"><span data-slate-string="true">main.bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10340"><span data-slate-object="text" data-key="10341"><span data-slate-leaf="true" data-offset-key="10341:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="10342"><span data-slate-leaf="true" data-offset-key="10342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="10343"><span data-slate-leaf="true" data-offset-key="10343:0" data-first-offset="true"><span data-slate-string="true">]:            &lt;-main.bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10344"><span data-slate-object="text" data-key="10345"><span data-slate-leaf="true" data-offset-key="10345:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="10346"><span data-slate-leaf="true" data-offset-key="10346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="10347"><span data-slate-leaf="true" data-offset-key="10347:0" data-first-offset="true"><span data-slate-string="true">]:        &lt;-main.foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10348"><span data-slate-object="text" data-key="10349"><span data-slate-leaf="true" data-offset-key="10349:0" data-first-offset="true"><span data-slate-string="true">g[</span></span></span><span data-slate-object="text" data-key="10350"><span data-slate-leaf="true" data-offset-key="10350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">00001</span></span></span></span><span data-slate-object="text" data-key="10351"><span data-slate-leaf="true" data-offset-key="10351:0" data-first-offset="true"><span data-slate-string="true">]:    &lt;-main.main</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10352" id="sr-toc-9"><span data-slate-object="text" data-key="10353"><span data-slate-leaf="true" data-offset-key="10353:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10354"><span data-slate-object="text" data-key="10355"><span data-slate-leaf="true" data-offset-key="10355:0" data-first-offset="true"><span data-slate-string="true">到这里，我们已经实现了这节课开始时设定的目标：实现一个自动注入跟踪代码并输出有层次感的函数调用链跟踪命令行工具。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10356"><span data-slate-object="text" data-key="10357"><span data-slate-leaf="true" data-offset-key="10357:0" data-first-offset="true"><span data-slate-string="true">回顾一下这个工具的实现思路：我们先基于 defer 实现了一个最简单的函数跟踪机制，然后针对这个最简单的实现提出若干问题，接下来我们逐一把这些问题解决掉了，最终将第一版相对粗糙的代码实现演进重构为一个相对完善的命令行工具。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10358"><span data-slate-object="text" data-key="10359"><span data-slate-leaf="true" data-offset-key="10359:0" data-first-offset="true"><span data-slate-string="true">关于这个实战项目，有两点注意事项要和你交代清楚：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10360"><span data-slate-object="text" data-key="10361"><span data-slate-leaf="true" data-offset-key="10361:0" data-first-offset="true"><span data-slate-string="true">第一，在代码中注入函数调用跟踪代码仅适用于日常调试代码和阅读理解代码时使用，被注入了跟踪设施的代码是不适合上生产环境的；</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10362"><span data-slate-object="text" data-key="10363"><span data-slate-leaf="true" data-offset-key="10363:0" data-first-offset="true"><span data-slate-string="true">第二，我在这里使用到了 Go 核心团队不推荐使用的 Goroutine id，这也是由这个实战项目的性质所决定的。如果你的代码是上生产，我建议还是尽量听从 Go 核心团队的建议，</span></span></span><span data-slate-object="text" data-key="10364"><span data-slate-leaf="true" data-offset-key="10364:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不要依赖 Goroutine ID</span></span></span></span><span data-slate-object="text" data-key="10365"><span data-slate-leaf="true" data-offset-key="10365:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10366" id="sr-toc-10"><span data-slate-object="text" data-key="10367"><span data-slate-leaf="true" data-offset-key="10367:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10368"><span data-slate-object="text" data-key="10369"><span data-slate-leaf="true" data-offset-key="10369:0" data-first-offset="true"><span data-slate-string="true">通过 instrument 命令行工具对 Go 源文件进行注入后，defer trace.Trace ()() 就会成为 Go 源码的一部分被编译进最终的可执行文件中。我们在小结中也提到了，开启了 Trace 的代码不要上生产环境，这样我们在构建上生产的应用之前需要手工删掉这些 Trace 代码，操作起来十分繁琐易错。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10370"><span data-slate-object="text" data-key="10371"><span data-slate-leaf="true" data-offset-key="10371:0" data-first-offset="true"><span data-slate-string="true">所以，这里我想请你为 Trace 增加一个开关功能，有了这个开关后，日常开发调试过程中编译出的程序中的 Trace 是起作用的，但为生产环境编译出的可执行程序中虽然也包含 Trace，但 Trace 不会真正起作用（提示：使用 build tag）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10372"><span data-slate-object="text" data-key="10373"><span data-slate-leaf="true" data-offset-key="10373:0" data-first-offset="true"><span data-slate-string="true">欢迎你把这节课分享给更多对 Go 语言感兴趣的朋友。我是 Tony Bai，我们下节课见。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10374" id="sr-toc-11"><a data-slate-type="link" data-slate-object="inline" data-key="10375"><span data-slate-object="text" data-key="10376"><span data-slate-leaf="true" data-offset-key="10376:0" data-first-offset="true"><span data-slate-string="true">这个项目的源码在这里！</span></span></span></a></h4></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>23</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (22)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/26/38/ef063dc2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Darren</span></div></div><div>老师，问个小白的问题哈，就是 Java 和 Python 都支持注解增加能力，不会修改源代码。
我看您这节课的最终版本，就是工具修改源代码，那么 go 有没有类似 Java 和 Python 那种注解的增强能力？如果没有，那么是因为什么原因不支持呀？</div><div><p>作者回复: go 原生不支持注解功能。官方对此原因没有任何说明。go 支持 struct tag，一定程度具备了 annotation 的性质。</p></div><div><div>2021-12-24</div><div><div><i></i><span>4</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 木木</span></div></div><div>感谢，这节课觉得学到了很多。有个问题，在文中演示如何获得 Goroutine ID 的 trace 例程里，waitGroup 的作用是什么？我本来以为是像信号量一样的同步手段，但是想了一想发现并不是，因为 wait 在 A1（）之后。如果 wait 在 A1（）之前的话，可以保证让 A2 先执行完再执行 A1。文中这种在 A1（）之后 wait（）的原因是什么？</div><div><p>作者回复: waitgroup 是 go 标准库 sync 包提供的一个功能特性，常用用于等待一组子 goroutine 的退出。可以看看 go 官方相关文档以及文档中的用法。</p></div><div><div>2021-12-23</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/11/66/ac631a36.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geralt</span></div></div><div>思考题的一个思路：
在 instrument_trace 目录下新建一个 config 目录，里面有 dev.go 和 prod.go 两个文件：
dev.go
//go:build dev
package config

const ShouldPrint = true
------
prod.go

//go:build prod
package config

const ShouldPrint = false

------

修改 Trace () 函数，在方法体内先判断 ShouldPrint 的值，若为 false 则返回一个空的匿名函数。

通过 go build -tags dev (prod) 可以指定 config 目录下哪个文件参与编译。</div><div><p>作者回复：都用 build tag 了，应该就不需要 shouldprint 了吧。</p></div><div><div>2021-12-23</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/44/b5/7eba5a0e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 木木</span></div></div><div>一个问题：老师代码里好几处用到了类似 fd, ok :=decl.(*ast.FuncDecl) 这种写法，看了一下，ast 是 package，FuncDecl 是一个 struct，decl 是一个 ast.Decl 类型的变量，给我搞晕了。请问等号右边的意思是什么？ </div><div><p>作者回复：这不能怪你，因为这里使用了接口的类型断言 (type assert) 语法，可以先看看第 28 讲后，再回来看这段代码。</p></div><div><div>2021-12-23</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/0a/a4/828a431f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 张申傲</span></div></div><div>就喜欢这种实战，可以把前面的知识点都串起来，对于加深理解很有帮助～</div><div><p>作者回复: 👍</p></div><div><div>2021-12-22</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>qinsi</span></div></div><div>一些疑问：

1. 在输出带缩进的跟踪信息时，用一个 map 保存了不同 goroutine 的当前缩进。但似乎每个 goroutine 都只会访问自己的 id 对应的 kv，不存在不同的 goroutine 访问同一个 key 的情况。这种情况下能否不加锁呢？

2. 在其他语言的生态中，实现无侵入的链路跟踪通常都是在语言的中间表示上做文章，比如 JVM 字节码或是 LLVM IR。查了下 go 似乎也有自己的一种 ssa ir，那么是否有可能也在这种 ir 上做做文章？</div><div><p>作者回复: 1. go 的 map 类型如果发现多个 goroutine 尝试对其进行写操作，但没有加锁，就可能抛出 panic 
2. 思路不错，但我对 ssa ir 了解不多，如果你对 ssa ir 很了解，建议你尝试一下，有成果后也可以分享出来。</p></div><div><div>2021-12-22</div><div><div><i></i><span>7</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/64/8a/bc8cb43c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 路边的猪</span></div></div><div>var mgroup = make (map [uint64] int)
var mutex sync.Mutex

func Trace () func () {
	pc, _, _, ok := runtime.Caller (1)
	if !ok {
		fmt.Println ("报错")
	}
	funcccc := runtime.FuncForPC (pc)
	funname := funcccc.Name ()
	gid := curGoroutineID ()

	mutex.Lock ()
	index := mgroup [gid]
	mgroup [gid] = index + 1
	mutex.Unlock ()
	s := ""
	for i := 0; i &lt;= index; i++ {
		s = s + " "
	}
	fmt.Printf ("g [%05d]:% s-&gt; enter:% s\n", gid, s, funname)
	return func () {
		fmt.Printf ("g [%05d]:% s&lt;- exit :% s\n", gid, s, funname)
	}
}

利用 defer 后面的表达式在入栈时求值这一特性，用一个缩紧变量就行了，闭包中的 indents -1 有点多此一举吧？</div><div><p>作者回复：嗯，不错的思路。</p></div><div><div>2022-05-10</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/kHoDdV15McW26tMCNnU8GSsUib9UWboAjVSe4nop5nPVt7qZNcUicCic3W50uaDHj0ibupXQtpvOUG4YaomBqHicVmg/132"></div></div><div><div><div><span>KingOfDark</span></div></div><div>1. 对于 go build 的编译过程，有点疑问，就比如这里编译 go build demo.go ，会把依赖的包也都给重新编译吗？ 还是说依赖包的都是提前编译好的（或者说只会有一次编译，之后不会重新编译了，只需要在链接即可？）

2. 对于思考题的使用 build tags，有两种思路：
第一种思路，是 trace.go 有两个版本（文件名可以分别为 dev_trace.go， prod_trace.go），dev 版本的 trace 是正常的打印逻辑，prod 版本直接返回空函数体
第二种思路，是 要编译 / 追踪的 go 源文件有两个版本，一个带有 trace 函数，一个不带 trace 函数（这个方法好像用不到 build tag 了，但是这样好像把 defer 的开销也省去了）
</div><div><p>作者回复: 1. 关于 go 增量编译，可以了解一下 https://tonybai.com/2022/03/21/go-native-support-incremental-build 
2. 第一个思路✅。第二种思路维护起来过于麻烦了。</p></div><div><div>2022-06-15</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lesserror</span></div></div><div>感谢大白老师，这一讲的内容很有启发性。有几个小疑问，劳烦有时间回复一下：

1. 文中说：“于是当 foo 函数返回后，这个闭包函数就会被执行。” 我想的是，这里是不是 foo 函数返回之前，闭包函数就会被执行呢？   foo 函数返回后，是不是代表这个函数已经执行完毕了？

2. 第一个返回值代表的是程序计数（pc)。我打印 pc 变量，出来的是类似： 17343465、17343241、17343369 ・・・・・・，这个计数究竟是什么呢，内存地址吗？

3. 文中的这两步操作：$go build github.com/bigwhite/instrument_trace/cmd/instrument
                               $instrument version
我的理解是编译生成了可执行二进制文件后，需要放到 类似 bin 目录中，才能全局 执行 “instrument version” 命令吧？ 感觉老师这里还少了一步操作。

4. 不建议使用 Goroutine ID 的最大原因是什么？ 文中链接中的讨论组内容没有仔细看完。

5. 课后问题的比较优越的实现方案是什么？想听到老师的答案。

ps：问题有点多，但是确实属于我这节课看完后的疑惑，谢谢老师解答。</div><div><p>作者回复: 1. 这里所谓的 foo 函数返回后，指的是 defer 函数被执行，deferred 函数即是那个闭包函数。
2.pc 是程序计数器，冯・诺伊曼计算机体系结构中的一个寄存器。可以自行 google 或 baidu 一下。
3. go build 后，instrument 程序会出现在当前目录下。
4. 最大原因还是避免被滥用。避免写出强依赖 goroutine id 的代码。因为强依赖 goroutine 将导致代码不好移植，同时也会导致并发模型复杂化。
5. 提示里有，使用 build tag。关于 build tag 用法，可以参考 go 官方文档。</p></div><div><div>2021-12-24</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 左耳朵东</span></div></div><div>我生成的 demo.go 文件和老师一样，但执行的时候为什么报错：
examples\demo\demo.go:3:8: imported and not used: "instrument_trace"
examples\demo\demo.go:6:8: undefined: trace
examples\demo\demo.go:11:8: undefined: trace
examples\demo\demo.go:15:8: undefined: trace</div><div><p>作者回复: demo 下的 go.mod 中内容是否正确？</p></div><div><div>2021-12-22</div><div><div><i></i><span>3</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ba/ce/fd45714f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>bearlu</span></div></div><div>老师，还有其他方式获取 Goroutine ID？还是不建议使用 Goroutine ID？</div><div><p>作者回复：不建议使用。</p></div><div><div>2021-12-22</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 罗杰</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>干货满满，这节的代码最好手动码出来，亲自好好感受一下。我们线上的环境基本上都是环境变量控制，go build 倒是从来没有使用过，这个也可以尝试一下。</div><div><p>作者回复：嗯，可以对比一下两种方法哪个更适合。</p></div><div><div>2021-12-22</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/2e/ca/469f7266.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 菠萝吹雪 —Code</span></div></div><div>打卡</div><div><p>作者回复: 👍</p></div><div><div>2022-08-20</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/qhonwcQle1RBufvLdTm4MgSNl554GBXUZtNNH65oYajbbRLxKsZX4hM9vFtrLLpDM0H93ZNWRFAZSrIZC7yAsQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_as</span></div></div><div>老师，我觉得那个 map 加锁好像不需要，map 的确是不支持并发写，但我觉得这个并发写，应该是不支持多个 gorunine 对同一个 key 写，但是现在这个项目，每个 gorunine 是对属于自己的 key 进行操作，即每个 key 任何时刻最多只会被一个 gorunine 写，不存在并发问题</div><div><p>作者回复: runtime 层面对 map 并发读写的检测是整体的，不会考虑 goroutine 是否各自访问自己的数据。</p></div><div><div>2022-04-26</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/4c/12/f0c145d4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Rayjun</span></div></div><div>在日志里面加锁也不是一个好的方案吧</div><div><p>作者回复：在我的初衷里，生产环境是不应该开启该 Trace 的，该 Trace 更多是在日常 dev/debug/read source code 时使用。可以通过 go build -tag 方式开启和关闭 Trace。</p></div><div><div>2022-03-20</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/c2/aa/fbff810a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>二刀田</span></div></div><div>看完这章，有种酣畅淋漓的感觉</div><div><p>作者回复: 👍</p></div><div><div>2022-03-03</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/49/4e/8798cd01.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>顷</span></div></div><div>老师我 1.17  第一个例子跑出来为啥是
enter： foo
enter： bar
exit:  bar
exit:  foo
enter： main</div><div><p>作者回复：你是用 go 1.17，并在终端命令行中跑的么？还是在一些 IDE 中运行的？</p></div><div><div>2022-02-25</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep7c7UKsjRiclaAqD9vMHSUXayzrvRhvic3Lm6ibX82L3DibJnCCtDmB3OfxbuVjetpT6Qa8IuwqZCWlw/132"></div></div><div><div><div><span>Geek_2337af</span></div></div><div>老师解读一下 go build github.com/bigwhite/instrument_trace/cmd/instrument，这样是整个包构建的吗，然后生成的文件名默认是包名 instrument，如果 instrument 包里面还有 main.go 依赖的源码文件，还这样这样构建可以吗</div><div><p>作者回复：好问题！如果是像用 go build xxx/yyy 构建 main 包，那么 go build 会生成名为 yyy 的可执行文件。如果 main 包下面有很多源文件，也是可以这么构建的。
 </p></div><div><div>2022-02-14</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/75/04/d26cd437.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lemon</span></div></div><div>老师，我这边按照步骤写完代码 build 之后显示 command not found: instrument，这是为什么呀，从 GitHub 上 clone 下来老师您的代码 build 之后也不行... 很奇怪</div><div><p>作者回复：什么 os？用./instrument 呢？</p></div><div><div>2022-01-12</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/b8/d8/f81b5604.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>hcyycb</span></div></div><div>跟练模拟 instrument_trace 的练习。
我在 go mod init 的时候，省略了 “github.com/bigwhite/” 。
直接用 go mod init instrument_trace,
输出的结果是：
g [00001]:    -&gt;command-line-arguments_test.a
获取不到报名。本来的期望值应该是：
g [00001]:    -&gt;instrument_trace_test.a

不知有没有同学遇到相似的报错经历？
</div><div><p>作者回复：我按照你的思路修改了一下并运行 example_test.go，得到结果:

g [00001]:    -&gt;instrument_trace_test.a
g [00001]:        -&gt;instrument_trace_test.b
g [00001]:            -&gt;instrument_trace_test.c
g [00001]:                -&gt;instrument_trace_test.d
g [00001]:                &lt;-instrument_trace_test.d
g [00001]:            &lt;-instrument_trace_test.c
g [00001]:        &lt;-instrument_trace_test.b
g [00001]:    &lt;-instrument_trace_test.a

macos go 1.17

没有遇到你所提到的情况。</p></div><div><div>2022-01-06</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".m"><outline class="toc-level-h1" data-reactid=".m.0" style="width: 175px;"><active data-reactid=".m.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".m.0.1"><span data-reactid=".m.0.1.0"> 27｜即学即练：跟踪函数调用链，理解代码更直观</span></a></outline><outline class="toc-level-h2" data-reactid=".m.1" style="width: 165px;"><active data-reactid=".m.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".m.1.1"><span data-reactid=".m.1.1.0">引子</span></a></outline><outline class="toc-level-h2" data-reactid=".m.2" style="width: 165px;"><active data-reactid=".m.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".m.2.1"><span data-reactid=".m.2.1.0">自动获取所跟踪函数的函数名</span></a></outline><outline class="toc-level-h2" data-reactid=".m.3" style="width: 165px;"><active data-reactid=".m.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".m.3.1"><span data-reactid=".m.3.1.0">增加 Goroutine 标识</span></a></outline><outline class="toc-level-h2" data-reactid=".m.4" style="width: 165px;"><active data-reactid=".m.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".m.4.1"><span data-reactid=".m.4.1.0">让输出的跟踪信息更具层次感</span></a></outline><outline class="toc-level-h2" data-reactid=".m.5" style="width: 165px;"><active data-reactid=".m.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".m.5.1"><span data-reactid=".m.5.1.0">利用代码生成自动注入 Trace 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".m.6" style="width: 155px;"><active data-reactid=".m.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".m.6.1"><span data-reactid=".m.6.1.0">将 Trace 函数放入一个独立的 module 中</span></a></outline><outline class="toc-level-h3" data-reactid=".m.7" style="width: 155px;"><active data-reactid=".m.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".m.7.1"><span data-reactid=".m.7.1.0">自动注入 Trace 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".m.8" style="width: 155px;"><active data-reactid=".m.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".m.8.1"><span data-reactid=".m.8.1.0">利用 instrument 工具注入跟踪代码</span></a></outline><outline class="toc-level-h2" data-reactid=".m.9" style="width: 165px;"><active data-reactid=".m.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".m.9.1"><span data-reactid=".m.9.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".m.a" style="width: 165px;"><active data-reactid=".m.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".m.a.1"><span data-reactid=".m.a.1.0">思考题</span></a></outline><outline class="toc-level-h4" data-reactid=".m.b" style="width: 145px;"><active data-reactid=".m.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".m.b.1"><span data-reactid=".m.b.1.0">这个项目的源码在这里！</span></a></outline><outline class="toc-level-h2" data-reactid=".m.c" style="width: 165px;"><active data-reactid=".m.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".m.c.1"><span data-reactid=".m.c.1.0">精选留言 (22)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/471138" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>