
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 22 | 配置及服务发现：解析 etcd 在 API Gateway 开源项目中应用</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>22 | 配置及服务发现：解析 etcd 在 API Gateway 开源项目中应用</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">我希望你能够用最低的学习成本，掌握 etcd 核心原理和最佳实践，让 etcd 为你所用。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">22 | 配置及服务发现：解析 etcd 在 API Gateway 开源项目中应用</h1><div><span>唐聪</span> <span> 2021-03-12</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/d4/f2/d4c03ebcd833fea9332edb32cd4dbaf2.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：王超凡</span><span>大小：13.75M</span><span> 时长：15:03</span></div></div><audio title="22 | 配置及服务发现：解析etcd在API Gateway开源项目中应用" src="https://res001.geekbang.org/media/audio/0a/5c/0a5a0df51e06568f94d7520ceb6d225c/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="9700" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="9701"><span data-slate-object="text" data-key="9702"><span data-slate-leaf="true" data-offset-key="9702:0" data-first-offset="true"><span data-slate-string="true">你好，我是唐聪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9703"><span data-slate-object="text" data-key="9704"><span data-slate-leaf="true" data-offset-key="9704:0" data-first-offset="true"><span data-slate-string="true">在软件开发的过程中，为了提升代码的灵活性和开发效率，我们大量使用配置去控制程序的运行行为。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9705"><span data-slate-object="text" data-key="9706"><span data-slate-leaf="true" data-offset-key="9706:0" data-first-offset="true"><span data-slate-string="true">从简单的数据库账号密码配置，到 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9707"><span data-slate-object="text" data-key="9708"><span data-slate-leaf="true" data-offset-key="9708:0" data-first-offset="true"><span data-slate-string="true">confd</span></span></span></a><span data-slate-object="text" data-key="9709"><span data-slate-leaf="true" data-offset-key="9709:0" data-first-offset="true"><span data-slate-string="true"> 支持以 etcd 为后端存储的本地配置及模板管理，再到 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9710"><span data-slate-object="text" data-key="9711"><span data-slate-leaf="true" data-offset-key="9711:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX</span></span></span></a><span data-slate-object="text" data-key="9712"><span data-slate-leaf="true" data-offset-key="9712:0" data-first-offset="true"><span data-slate-string="true"> 等 API Gateway 项目使用 etcd 存储服务配置、路由信息等，最后到 Kubernetes 更实现了 Secret 和 ConfigMap 资源对象来解决配置管理的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9713"><span data-slate-object="text" data-key="9714"><span data-slate-leaf="true" data-offset-key="9714:0" data-first-offset="true"><span data-slate-string="true">那么它们是如何实现实时、动态调整服务配置而不需要重启相关服务的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9715"><span data-slate-object="text" data-key="9716"><span data-slate-leaf="true" data-offset-key="9716:0" data-first-offset="true"><span data-slate-string="true">今天我就和你聊聊 etcd 在配置和服务发现场景中的应用。我将以开源项目 Apache APISIX 为例，为你分析服务发现的原理，带你了解 etcd 的 key-value 模型，Watch 机制，鉴权机制，Lease 特性，事务特性在其中的应用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9717"><span data-slate-object="text" data-key="9718"><span data-slate-leaf="true" data-offset-key="9718:0" data-first-offset="true"><span data-slate-string="true">希望通过这节课，让你了解 etcd 在配置系统和服务发现场景工作原理，帮助你选型适合业务场景的配置系统、服务发现组件。同时，在使用 Apache APISIX 等开源项目过程中遇到 etcd 相关问题时，你能独立排查、分析，并向社区提交 issue 和 PR 解决。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9719" id="sr-toc-1"><span data-slate-object="text" data-key="9720"><span data-slate-leaf="true" data-offset-key="9720:0" data-first-offset="true"><span data-slate-string="true">服务发现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9721"><span data-slate-object="text" data-key="9722"><span data-slate-leaf="true" data-offset-key="9722:0" data-first-offset="true"><span data-slate-string="true">首先和你聊聊服务发现，服务发现是指什么？为什么需要它呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9723"><span data-slate-object="text" data-key="9724"><span data-slate-leaf="true" data-offset-key="9724:0" data-first-offset="true"><span data-slate-string="true">为了搞懂这个问题，我首先和你分享下程序部署架构的演进。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9725" id="sr-toc-2"><span data-slate-object="text" data-key="9726"><span data-slate-leaf="true" data-offset-key="9726:0" data-first-offset="true"><span data-slate-string="true">单体架构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9727"><span data-slate-object="text" data-key="9728"><span data-slate-leaf="true" data-offset-key="9728:0" data-first-offset="true"><span data-slate-string="true">在早期软件开发时使用的是单体架构，也就是所有功能耦合在同一个项目中，统一构建、测试、发布。单体架构在项目刚启动的时候，架构简单、开发效率高，比较容易部署、测试。但是随着项目不断增大，它具有若干缺点，比如：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9729"><div data-slate-type="list-line" data-slate-object="block" data-key="9730"><span data-slate-object="text" data-key="9731"><span data-slate-leaf="true" data-offset-key="9731:0" data-first-offset="true"><span data-slate-string="true">所有功能耦合在同一个项目中，修复一个小 Bug 就需要发布整个大工程项目，增大引入问题风险。同时随着开发人员增多、单体项目的代码增长、各模块堆砌在一起、代码质量参差不齐，内部复杂度会越来越高，可维护性差。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9732"><span data-slate-object="text" data-key="9733"><span data-slate-leaf="true" data-offset-key="9733:0" data-first-offset="true"><span data-slate-string="true">无法按需针对仅出现瓶颈的功能模块进行弹性扩容，只能作为一个整体继续扩展，因此扩展性较差。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9734"><span data-slate-object="text" data-key="9735"><span data-slate-leaf="true" data-offset-key="9735:0" data-first-offset="true"><span data-slate-string="true">一旦单体应用宕机，将导致所有服务不可用，因此可用性较差。</span></span></span></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9736" id="sr-toc-3"><span data-slate-object="text" data-key="9737"><span data-slate-leaf="true" data-offset-key="9737:0" data-first-offset="true"><span data-slate-string="true">分布式及微服务架构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9738"><span data-slate-object="text" data-key="9739"><span data-slate-leaf="true" data-offset-key="9739:0" data-first-offset="true"><span data-slate-string="true">如何解决以上痛点呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9740"><span data-slate-object="text" data-key="9741"><span data-slate-leaf="true" data-offset-key="9741:0" data-first-offset="true"><span data-slate-string="true">当然是将单体应用进行拆分，大而化小。如何拆分呢？ 这里我就以一个我曾经参与重构建设的电商系统为案例给你分析一下。在一个单体架构中，完整的电商系统应包括如下模块：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9742"><div data-slate-type="list-line" data-slate-object="block" data-key="9743"><span data-slate-object="text" data-key="9744"><span data-slate-leaf="true" data-offset-key="9744:0" data-first-offset="true"><span data-slate-string="true">商城系统，负责用户登录、查看及搜索商品、购物车商品管理、优惠券管理、订单管理、支付等功能。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9745"><span data-slate-object="text" data-key="9746"><span data-slate-leaf="true" data-offset-key="9746:0" data-first-offset="true"><span data-slate-string="true">物流及仓储系统，根据用户订单，进行发货、退货、换货等一系列仓储、物流管理。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9747"><span data-slate-object="text" data-key="9748"><span data-slate-leaf="true" data-offset-key="9748:0" data-first-offset="true"><span data-slate-string="true">其他客服系统、客户管理系统等。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9749"><span data-slate-object="text" data-key="9750"><span data-slate-leaf="true" data-offset-key="9750:0" data-first-offset="true"><span data-slate-string="true">因此在分布式架构中，你可以按整体功能，将单体应用垂直拆分成以上三大功能模块，各个功能模块可以选择不同的技术栈实现，按需弹性扩缩容，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9751"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/ca/20/ca6090e229dde9a0361d6yy2c3df8d20.png?wh=1920*1046"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9752"><span data-slate-object="text" data-key="9753"><span data-slate-leaf="true" data-offset-key="9753:0" data-first-offset="true"><span data-slate-string="true">那什么又是微服务架构呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9754"><span data-slate-object="text" data-key="9755"><span data-slate-leaf="true" data-offset-key="9755:0" data-first-offset="true"><span data-slate-string="true">它是对各个功能模块进行更细立度的拆分，比如商城系统模块可以拆分成：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9756"><div data-slate-type="list-line" data-slate-object="block" data-key="9757"><span data-slate-object="text" data-key="9758"><span data-slate-leaf="true" data-offset-key="9758:0" data-first-offset="true"><span data-slate-string="true">用户鉴权模块；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9759"><span data-slate-object="text" data-key="9760"><span data-slate-leaf="true" data-offset-key="9760:0" data-first-offset="true"><span data-slate-string="true">商品模块；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9761"><span data-slate-object="text" data-key="9762"><span data-slate-leaf="true" data-offset-key="9762:0" data-first-offset="true"><span data-slate-string="true">购物车模块；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9763"><span data-slate-object="text" data-key="9764"><span data-slate-leaf="true" data-offset-key="9764:0" data-first-offset="true"><span data-slate-string="true">优惠券模块；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9765"><span data-slate-object="text" data-key="9766"><span data-slate-leaf="true" data-offset-key="9766:0" data-first-offset="true"><span data-slate-string="true">支付模块；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9767"><span data-slate-object="text" data-key="9768"><span data-slate-leaf="true" data-offset-key="9768:0" data-first-offset="true"><span data-slate-string="true">……</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9769"><span data-slate-object="text" data-key="9770"><span data-slate-leaf="true" data-offset-key="9770:0" data-first-offset="true"><span data-slate-string="true">在微服务架构中，每个模块职责更单一、独立部署、开发迭代快，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9771"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/cf/4a/cf62b7704446c05d8747b4672b5fb74a.png?wh=1920*1048"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9772"><span data-slate-object="text" data-key="9773"><span data-slate-leaf="true" data-offset-key="9773:0" data-first-offset="true"><span data-slate-string="true">那么在分布式及微服务架构中，各个模块之间如何及时知道对方网络地址与端口、协议，进行接口调用呢？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9774" id="sr-toc-4"><span data-slate-object="text" data-key="9775"><span data-slate-leaf="true" data-offset-key="9775:0" data-first-offset="true"><span data-slate-string="true">为什么需要服务发现中间件？</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9776"><span data-slate-object="text" data-key="9777"><span data-slate-leaf="true" data-offset-key="9777:0" data-first-offset="true"><span data-slate-string="true">其实这个知道的过程，就是服务发现。在早期的时候我们往往通过硬编码、配置文件声明各个依赖模块的网络地址、端口，然而这种方式在分布式及微服务架构中，其运维效率、服务可用性是远远不够的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9778"><span data-slate-object="text" data-key="9779"><span data-slate-leaf="true" data-offset-key="9779:0" data-first-offset="true"><span data-slate-string="true">那么我们能否实现通过一个特殊服务就查询到各个服务的后端部署地址呢？ 各服务启动的时候，就自动将 IP 和 Port、协议等信息注册到特殊服务上，当某服务出现异常的时候，特殊服务就自动删除异常实例信息？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9780"><span data-slate-object="text" data-key="9781"><span data-slate-leaf="true" data-offset-key="9781:0" data-first-offset="true"><span data-slate-string="true">是的，当然可以，这个特殊服务就是注册中心服务，你可以基于 etcd、ZooKeeper、consul 等实现。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9782" id="sr-toc-5"><span data-slate-object="text" data-key="9783"><span data-slate-leaf="true" data-offset-key="9783:0" data-first-offset="true"><span data-slate-string="true">etcd 服务发现原理</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9784"><span data-slate-object="text" data-key="9785"><span data-slate-leaf="true" data-offset-key="9785:0" data-first-offset="true"><span data-slate-string="true">那么如何基于 etcd 实现服务发现呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9786"><span data-slate-object="text" data-key="9787"><span data-slate-leaf="true" data-offset-key="9787:0" data-first-offset="true"><span data-slate-string="true">下面我给出了一个通用的服务发现原理架构图，通过此图，为你介绍下服务发现的基本原理。详细如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9788"><div data-slate-type="list-line" data-slate-object="block" data-key="9789"><span data-slate-object="text" data-key="9790"><span data-slate-leaf="true" data-offset-key="9790:0" data-first-offset="true"><span data-slate-string="true">整体上分为四层，client 层、proxy 层 (可选)、业务 server、etcd 存储层组成。引入 proxy 层的原因是使 client 更轻、逻辑更简单，无需直接访问存储层，同时可通过 proxy 层支持各种协议。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9791"><span data-slate-object="text" data-key="9792"><span data-slate-leaf="true" data-offset-key="9792:0" data-first-offset="true"><span data-slate-string="true">client 层通过负载均衡访问 proxy 组件。proxy 组件启动的时候，通过 etcd 的 Range RPC 方法从 etcd 读取初始化服务配置数据，随后通过 Watch 接口持续监听后端业务 server 扩缩容变化，实时修改路由。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9793"><span data-slate-object="text" data-key="9794"><span data-slate-leaf="true" data-offset-key="9794:0" data-first-offset="true"><span data-slate-string="true">proxy 组件收到 client 的请求后，它根据从 etcd 读取到的对应服务的路由配置、负载均衡算法（比如 Round-robin）转发到对应的业务 server。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9795"><span data-slate-object="text" data-key="9796"><span data-slate-leaf="true" data-offset-key="9796:0" data-first-offset="true"><span data-slate-string="true">业务 server 启动的时候，通过 etcd 的写接口 Txn/Put 等，注册自身地址信息、协议到高可用的 etcd 集群上。业务 server 缩容、故障时，对应的 key 应能自动从 etcd 集群删除，因此相关 key 需要关联 lease 信息，设置一个合理的 TTL，并定时发送 keepalive 请求给 Leader 续租，以防止租约及 key 被淘汰。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="9797"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/26/e4/26d0d18c0725de278eeb7505f20642e4.png?wh=1920*1137"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9798"><span data-slate-object="text" data-key="9799"><span data-slate-leaf="true" data-offset-key="9799:0" data-first-offset="true"><span data-slate-string="true">当然，在分布式及微服务架构中，我们面对的问题不仅仅是服务发现，还包括如下痛点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9800"><div data-slate-type="list-line" data-slate-object="block" data-key="9801"><span data-slate-object="text" data-key="9802"><span data-slate-leaf="true" data-offset-key="9802:0" data-first-offset="true"><span data-slate-string="true">限速；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9803"><span data-slate-object="text" data-key="9804"><span data-slate-leaf="true" data-offset-key="9804:0" data-first-offset="true"><span data-slate-string="true">鉴权；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9805"><span data-slate-object="text" data-key="9806"><span data-slate-leaf="true" data-offset-key="9806:0" data-first-offset="true"><span data-slate-string="true">安全；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9807"><span data-slate-object="text" data-key="9808"><span data-slate-leaf="true" data-offset-key="9808:0" data-first-offset="true"><span data-slate-string="true">日志；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9809"><span data-slate-object="text" data-key="9810"><span data-slate-leaf="true" data-offset-key="9810:0" data-first-offset="true"><span data-slate-string="true">监控；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9811"><span data-slate-object="text" data-key="9812"><span data-slate-leaf="true" data-offset-key="9812:0" data-first-offset="true"><span data-slate-string="true">丰富的发布策略；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9813"><span data-slate-object="text" data-key="9814"><span data-slate-leaf="true" data-offset-key="9814:0" data-first-offset="true"><span data-slate-string="true">链路追踪；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9815"><span data-slate-object="text" data-key="9816"><span data-slate-leaf="true" data-offset-key="9816:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9817"><span data-slate-object="text" data-key="9818"><span data-slate-leaf="true" data-offset-key="9818:0" data-first-offset="true"><span data-slate-string="true">为了解决以上痛点，各大公司及社区开发者推出了大量的开源项目。这里我就以国内开发者广泛使用的 Apache APISIX 项目为例，为你分析 etcd 在其中的应用，了解下它是怎么玩转服务发现的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9819" id="sr-toc-6"><span data-slate-object="text" data-key="9820"><span data-slate-leaf="true" data-offset-key="9820:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 原理</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9821"><span data-slate-object="text" data-key="9822"><span data-slate-leaf="true" data-offset-key="9822:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 它具备哪些功能呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9823"><span data-slate-object="text" data-key="9824"><span data-slate-leaf="true" data-offset-key="9824:0" data-first-offset="true"><span data-slate-string="true">它的本质是一个无状态、高性能、实时、动态、可水平扩展的 API 网关。核心原理就是基于你配置的服务信息、路由规则等信息，将收到的请求通过一系列规则后，正确转发给后端的服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9825"><span data-slate-object="text" data-key="9826"><span data-slate-leaf="true" data-offset-key="9826:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 其实就是上面服务发现原理架构图中的 proxy 组件，如下图红色虚线框所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9827"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/20/fd/20a539bdd37db2d4632c7b0c5f4119fd.png?wh=1920*1246"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9828"><span data-slate-object="text" data-key="9829"><span data-slate-leaf="true" data-offset-key="9829:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 详细架构图如下（</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9830"><span data-slate-object="text" data-key="9831"><span data-slate-leaf="true" data-offset-key="9831:0" data-first-offset="true"><span data-slate-string="true">引用自社区项目文档</span></span></span></a><span data-slate-object="text" data-key="9832"><span data-slate-leaf="true" data-offset-key="9832:0" data-first-offset="true"><span data-slate-string="true">）。从图中你可以看到，它由控制面和数据面组成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9833"><span data-slate-object="text" data-key="9834"><span data-slate-leaf="true" data-offset-key="9834:0" data-first-offset="true"><span data-slate-string="true">控制面顾名思义，就是你通过 Admin API 下发服务、路由、安全配置的操作。控制面默认的服务发现存储是 etcd，当然也支持 consul、nacos 等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9835"><span data-slate-object="text" data-key="9836"><span data-slate-leaf="true" data-offset-key="9836:0" data-first-offset="true"><span data-slate-string="true">你如果没有使用过 Apache APISIX 的话，可以参考下这个 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9837"><span data-slate-object="text" data-key="9838"><span data-slate-leaf="true" data-offset-key="9838:0" data-first-offset="true"><span data-slate-string="true">example</span></span></span></a><span data-slate-object="text" data-key="9839"><span data-slate-leaf="true" data-offset-key="9839:0" data-first-offset="true"><span data-slate-string="true">，快速、直观的了解下 Apache APISIX 是如何通过 Admin API 下发服务和路由配置的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9840"><span data-slate-object="text" data-key="9841"><span data-slate-leaf="true" data-offset-key="9841:0" data-first-offset="true"><span data-slate-string="true">数据面是在实现基于服务路由信息数据转发的基础上，提供了限速、鉴权、安全、日志等一系列功能，也就是解决了我们上面提的分布式及微服务架构中的典型痛点。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9842"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/83/f4/834502c6ed7e59fe0b4643c11b2d31f4.png?wh=1746*838"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9843"><span data-slate-object="text" data-key="9844"><span data-slate-leaf="true" data-offset-key="9844:0" data-first-offset="true"><span data-slate-string="true">那么当我们通过控制面 API 新增一个服务时，Apache APISIX 是是如何实现实时、动态调整服务配置，而不需要重启网关服务的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9845"><span data-slate-object="text" data-key="9846"><span data-slate-leaf="true" data-offset-key="9846:0" data-first-offset="true"><span data-slate-string="true">下面，我就和你聊聊 etcd 在 Apache APISIX 项目中的应用。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9847" id="sr-toc-7"><span data-slate-object="text" data-key="9848"><span data-slate-leaf="true" data-offset-key="9848:0" data-first-offset="true"><span data-slate-string="true">etcd 在 Apache APISIX 中的应用</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9849"><span data-slate-object="text" data-key="9850"><span data-slate-leaf="true" data-offset-key="9850:0" data-first-offset="true"><span data-slate-string="true">在搞懂这个问题之前，我们先看看 Apache APISIX 在 etcd 中，都存储了哪些数据呢？它的数据存储格式是怎样的？</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="9851" id="sr-toc-8"><span data-slate-object="text" data-key="9852"><span data-slate-leaf="true" data-offset-key="9852:0" data-first-offset="true"><span data-slate-string="true">数据存储格式</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="9853"><span data-slate-object="text" data-key="9854"><span data-slate-leaf="true" data-offset-key="9854:0" data-first-offset="true"><span data-slate-string="true">下面我参考 Apache APISIX 的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9855"><span data-slate-object="text" data-key="9856"><span data-slate-leaf="true" data-offset-key="9856:0" data-first-offset="true"><span data-slate-string="true">example</span></span></span></a><span data-slate-object="text" data-key="9857"><span data-slate-leaf="true" data-offset-key="9857:0" data-first-offset="true"><span data-slate-string="true"> 案例（apisix:2.3），通过 Admin API 新增了两个服务、路由规则后，执行如下查看 etcd 所有 key 的命令：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="9858"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9859"><span data-slate-object="text" data-key="9860"><span data-slate-leaf="true" data-offset-key="9860:0" data-first-offset="true"><span data-slate-string="true">etcdctl </span></span></span><span data-slate-object="text" data-key="9861"><span data-slate-leaf="true" data-offset-key="9861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="9862"><span data-slate-leaf="true" data-offset-key="9862:0" data-first-offset="true"><span data-slate-string="true"> "" </span></span></span><span data-slate-object="text" data-key="9863"><span data-slate-leaf="true" data-offset-key="9863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--prefix --keys-only</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9864"><span data-slate-object="text" data-key="9865"><span data-slate-leaf="true" data-offset-key="9865:0" data-first-offset="true"><span data-slate-string="true">etcd 输出结果如下：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="9866"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9867"><span data-slate-object="text" data-key="9868"><span data-slate-leaf="true" data-offset-key="9868:0" data-first-offset="true"><span data-slate-string="true">/apisix/consumers/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9869"><span data-slate-object="text" data-key="9870"><span data-slate-leaf="true" data-offset-key="9870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9871"><span data-slate-leaf="true" data-offset-key="9871:0" data-first-offset="true"><span data-slate-string="true">data_plane/server_info/f7285805-</span></span></span><span data-slate-object="text" data-key="9872"><span data-slate-leaf="true" data-offset-key="9872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">73e9</span></span></span></span><span data-slate-object="text" data-key="9873"><span data-slate-leaf="true" data-offset-key="9873:0" data-first-offset="true"><span data-slate-string="true">-4ce4-acc6-a38d619afdc3</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9874"><span data-slate-object="text" data-key="9875"><span data-slate-leaf="true" data-offset-key="9875:0" data-first-offset="true"><span data-slate-string="true">/apisix/global_rules/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9876"><span data-slate-object="text" data-key="9877"><span data-slate-leaf="true" data-offset-key="9877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9878"><span data-slate-leaf="true" data-offset-key="9878:0" data-first-offset="true"><span data-slate-string="true">node_status/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9879"><span data-slate-object="text" data-key="9880"><span data-slate-leaf="true" data-offset-key="9880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9881"><span data-slate-leaf="true" data-offset-key="9881:0" data-first-offset="true"><span data-slate-string="true">plugin_metadata/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9882"><span data-slate-object="text" data-key="9883"><span data-slate-leaf="true" data-offset-key="9883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9884"><span data-slate-leaf="true" data-offset-key="9884:0" data-first-offset="true"><span data-slate-string="true">plugins</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9885"><span data-slate-object="text" data-key="9886"><span data-slate-leaf="true" data-offset-key="9886:0" data-first-offset="true"><span data-slate-string="true">/apisix/plugins/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9887"><span data-slate-object="text" data-key="9888"><span data-slate-leaf="true" data-offset-key="9888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9889"><span data-slate-leaf="true" data-offset-key="9889:0" data-first-offset="true"><span data-slate-string="true">proto/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9890"><span data-slate-object="text" data-key="9891"><span data-slate-leaf="true" data-offset-key="9891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9892"><span data-slate-leaf="true" data-offset-key="9892:0" data-first-offset="true"><span data-slate-string="true">routes/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9893"><span data-slate-object="text" data-key="9894"><span data-slate-leaf="true" data-offset-key="9894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9895"><span data-slate-leaf="true" data-offset-key="9895:0" data-first-offset="true"><span data-slate-string="true">routes/</span></span></span><span data-slate-object="text" data-key="9896"><span data-slate-leaf="true" data-offset-key="9896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">12</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9897"><span data-slate-object="text" data-key="9898"><span data-slate-leaf="true" data-offset-key="9898:0" data-first-offset="true"><span data-slate-string="true">/apisix/routes/</span></span></span><span data-slate-object="text" data-key="9899"><span data-slate-leaf="true" data-offset-key="9899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">22</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9900"><span data-slate-object="text" data-key="9901"><span data-slate-leaf="true" data-offset-key="9901:0" data-first-offset="true"><span data-slate-string="true">/apisix/services/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9902"><span data-slate-object="text" data-key="9903"><span data-slate-leaf="true" data-offset-key="9903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9904"><span data-slate-leaf="true" data-offset-key="9904:0" data-first-offset="true"><span data-slate-string="true">services/</span></span></span><span data-slate-object="text" data-key="9905"><span data-slate-leaf="true" data-offset-key="9905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9906"><span data-slate-object="text" data-key="9907"><span data-slate-leaf="true" data-offset-key="9907:0" data-first-offset="true"><span data-slate-string="true">/apisix/services/</span></span></span><span data-slate-object="text" data-key="9908"><span data-slate-leaf="true" data-offset-key="9908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9909"><span data-slate-object="text" data-key="9910"><span data-slate-leaf="true" data-offset-key="9910:0" data-first-offset="true"><span data-slate-string="true">/apisix/ssl/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9911"><span data-slate-object="text" data-key="9912"><span data-slate-leaf="true" data-offset-key="9912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/</span></span></span></span><span data-slate-object="text" data-key="9913"><span data-slate-leaf="true" data-offset-key="9913:0" data-first-offset="true"><span data-slate-string="true">ssl/</span></span></span><span data-slate-object="text" data-key="9914"><span data-slate-leaf="true" data-offset-key="9914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9915"><span data-slate-object="text" data-key="9916"><span data-slate-leaf="true" data-offset-key="9916:0" data-first-offset="true"><span data-slate-string="true">/apisix/ssl/</span></span></span><span data-slate-object="text" data-key="9917"><span data-slate-leaf="true" data-offset-key="9917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9918"><span data-slate-object="text" data-key="9919"><span data-slate-leaf="true" data-offset-key="9919:0" data-first-offset="true"><span data-slate-string="true">/apisix/stream_routes/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9920"><span data-slate-object="text" data-key="9921"><span data-slate-leaf="true" data-offset-key="9921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/apisix/u</span></span></span></span><span data-slate-object="text" data-key="9922"><span data-slate-leaf="true" data-offset-key="9922:0" data-first-offset="true"><span data-slate-string="true">pstreams/</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9923"><span data-slate-object="text" data-key="9924"><span data-slate-leaf="true" data-offset-key="9924:0" data-first-offset="true"><span data-slate-string="true">然后我们继续通过 etcdctl get 命令查看下 services 都存储了哪些信息呢？</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9925"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9926"><span data-slate-object="text" data-key="9927"><span data-slate-leaf="true" data-offset-key="9927:0" data-first-offset="true"><span data-slate-string="true">root@e9d3b477ca1f:/opt/bitnami/etcd</span></span></span><span data-slate-object="text" data-key="9928"><span data-slate-leaf="true" data-offset-key="9928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># etcdctl get /apisix/services --prefix</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9929"><span data-slate-object="text" data-key="9930"><span data-slate-leaf="true" data-offset-key="9930:0" data-first-offset="true"><span data-slate-string="true">/apisix/services/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9931"><span data-slate-object="text" data-key="9932"><span data-slate-leaf="true" data-offset-key="9932:0" data-first-offset="true"><span data-slate-string="true">init_dir</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9933"><span data-slate-object="text" data-key="9934"><span data-slate-leaf="true" data-offset-key="9934:0" data-first-offset="true"><span data-slate-string="true">/apisix/services/1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9935"><span data-slate-object="text" data-key="9936"><span data-slate-leaf="true" data-offset-key="9936:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="9937"><span data-slate-leaf="true" data-offset-key="9937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"update_time"</span></span></span></span><span data-slate-object="text" data-key="9938"><span data-slate-leaf="true" data-offset-key="9938:0" data-first-offset="true"><span data-slate-string="true">:1614293352,</span></span></span><span data-slate-object="text" data-key="9939"><span data-slate-leaf="true" data-offset-key="9939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"create_time"</span></span></span></span><span data-slate-object="text" data-key="9940"><span data-slate-leaf="true" data-offset-key="9940:0" data-first-offset="true"><span data-slate-string="true">:1614293352,</span></span></span><span data-slate-object="text" data-key="9941"><span data-slate-leaf="true" data-offset-key="9941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"upstream"</span></span></span></span><span data-slate-object="text" data-key="9942"><span data-slate-leaf="true" data-offset-key="9942:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="9943"><span data-slate-leaf="true" data-offset-key="9943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"type"</span></span></span></span><span data-slate-object="text" data-key="9944"><span data-slate-leaf="true" data-offset-key="9944:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9945"><span data-slate-leaf="true" data-offset-key="9945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"roundrobin"</span></span></span></span><span data-slate-object="text" data-key="9946"><span data-slate-leaf="true" data-offset-key="9946:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9947"><span data-slate-leaf="true" data-offset-key="9947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"nodes"</span></span></span></span><span data-slate-object="text" data-key="9948"><span data-slate-leaf="true" data-offset-key="9948:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="9949"><span data-slate-leaf="true" data-offset-key="9949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"172.18.5.12:80"</span></span></span></span><span data-slate-object="text" data-key="9950"><span data-slate-leaf="true" data-offset-key="9950:0" data-first-offset="true"><span data-slate-string="true">:1},</span></span></span><span data-slate-object="text" data-key="9951"><span data-slate-leaf="true" data-offset-key="9951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hash_on"</span></span></span></span><span data-slate-object="text" data-key="9952"><span data-slate-leaf="true" data-offset-key="9952:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9953"><span data-slate-leaf="true" data-offset-key="9953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"vars"</span></span></span></span><span data-slate-object="text" data-key="9954"><span data-slate-leaf="true" data-offset-key="9954:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9955"><span data-slate-leaf="true" data-offset-key="9955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"scheme"</span></span></span></span><span data-slate-object="text" data-key="9956"><span data-slate-leaf="true" data-offset-key="9956:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9957"><span data-slate-leaf="true" data-offset-key="9957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"http"</span></span></span></span><span data-slate-object="text" data-key="9958"><span data-slate-leaf="true" data-offset-key="9958:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9959"><span data-slate-leaf="true" data-offset-key="9959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pass_host"</span></span></span></span><span data-slate-object="text" data-key="9960"><span data-slate-leaf="true" data-offset-key="9960:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9961"><span data-slate-leaf="true" data-offset-key="9961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pass"</span></span></span></span><span data-slate-object="text" data-key="9962"><span data-slate-leaf="true" data-offset-key="9962:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="9963"><span data-slate-leaf="true" data-offset-key="9963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="9964"><span data-slate-leaf="true" data-offset-key="9964:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9965"><span data-slate-leaf="true" data-offset-key="9965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1"</span></span></span></span><span data-slate-object="text" data-key="9966"><span data-slate-leaf="true" data-offset-key="9966:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9967"><span data-slate-object="text" data-key="9968"><span data-slate-leaf="true" data-offset-key="9968:0" data-first-offset="true"><span data-slate-string="true">/apisix/services/2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9969"><span data-slate-object="text" data-key="9970"><span data-slate-leaf="true" data-offset-key="9970:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="9971"><span data-slate-leaf="true" data-offset-key="9971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"update_time"</span></span></span></span><span data-slate-object="text" data-key="9972"><span data-slate-leaf="true" data-offset-key="9972:0" data-first-offset="true"><span data-slate-string="true">:1614293361,</span></span></span><span data-slate-object="text" data-key="9973"><span data-slate-leaf="true" data-offset-key="9973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"create_time"</span></span></span></span><span data-slate-object="text" data-key="9974"><span data-slate-leaf="true" data-offset-key="9974:0" data-first-offset="true"><span data-slate-string="true">:1614293361,</span></span></span><span data-slate-object="text" data-key="9975"><span data-slate-leaf="true" data-offset-key="9975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"upstream"</span></span></span></span><span data-slate-object="text" data-key="9976"><span data-slate-leaf="true" data-offset-key="9976:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9977"><span data-slate-object="text" data-key="9978"><span data-slate-leaf="true" data-offset-key="9978:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="9979"><span data-slate-leaf="true" data-offset-key="9979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"type"</span></span></span></span><span data-slate-object="text" data-key="9980"><span data-slate-leaf="true" data-offset-key="9980:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9981"><span data-slate-leaf="true" data-offset-key="9981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"roundrobin"</span></span></span></span><span data-slate-object="text" data-key="9982"><span data-slate-leaf="true" data-offset-key="9982:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9983"><span data-slate-leaf="true" data-offset-key="9983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"nodes"</span></span></span></span><span data-slate-object="text" data-key="9984"><span data-slate-leaf="true" data-offset-key="9984:0" data-first-offset="true"><span data-slate-string="true">:{</span></span></span><span data-slate-object="text" data-key="9985"><span data-slate-leaf="true" data-offset-key="9985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"172.18.5.13:80"</span></span></span></span><span data-slate-object="text" data-key="9986"><span data-slate-leaf="true" data-offset-key="9986:0" data-first-offset="true"><span data-slate-string="true">:1},</span></span></span><span data-slate-object="text" data-key="9987"><span data-slate-leaf="true" data-offset-key="9987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hash_on"</span></span></span></span><span data-slate-object="text" data-key="9988"><span data-slate-leaf="true" data-offset-key="9988:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9989"><span data-slate-leaf="true" data-offset-key="9989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"vars"</span></span></span></span><span data-slate-object="text" data-key="9990"><span data-slate-leaf="true" data-offset-key="9990:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9991"><span data-slate-leaf="true" data-offset-key="9991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"scheme"</span></span></span></span><span data-slate-object="text" data-key="9992"><span data-slate-leaf="true" data-offset-key="9992:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9993"><span data-slate-leaf="true" data-offset-key="9993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"http"</span></span></span></span><span data-slate-object="text" data-key="9994"><span data-slate-leaf="true" data-offset-key="9994:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="9995"><span data-slate-leaf="true" data-offset-key="9995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pass_host"</span></span></span></span><span data-slate-object="text" data-key="9996"><span data-slate-leaf="true" data-offset-key="9996:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="9997"><span data-slate-leaf="true" data-offset-key="9997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pass"</span></span></span></span><span data-slate-object="text" data-key="9998"><span data-slate-leaf="true" data-offset-key="9998:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span><span data-slate-object="text" data-key="9999"><span data-slate-leaf="true" data-offset-key="9999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="10000"><span data-slate-leaf="true" data-offset-key="10000:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="10001"><span data-slate-leaf="true" data-offset-key="10001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2"</span></span></span></span><span data-slate-object="text" data-key="10002"><span data-slate-leaf="true" data-offset-key="10002:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10003"><span data-slate-object="text" data-key="10004"><span data-slate-leaf="true" data-offset-key="10004:0" data-first-offset="true"><span data-slate-string="true">从中我们可以总结出如下信息：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10005"><div data-slate-type="list-line" data-slate-object="block" data-key="10006"><span data-slate-object="text" data-key="10007"><span data-slate-leaf="true" data-offset-key="10007:0" data-first-offset="true"><span data-slate-string="true">Apache APSIX 2.x 系列版本使用的是 etcd3。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10008"><span data-slate-object="text" data-key="10009"><span data-slate-leaf="true" data-offset-key="10009:0" data-first-offset="true"><span data-slate-string="true">服务、路由、ssl、插件等配置存储格式前缀是 /apisix + "/" + 功能特性类型（routes/services/ssl 等），我们通过 Admin API 添加的路由、服务等配置就保存在相应的前缀下。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10010"><span data-slate-object="text" data-key="10011"><span data-slate-leaf="true" data-offset-key="10011:0" data-first-offset="true"><span data-slate-string="true">路由和服务配置的 value 是个 Json 对象，其中服务对象包含了 id、负载均衡算法、后端节点、协议等信息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10012"><span data-slate-object="text" data-key="10013"><span data-slate-leaf="true" data-offset-key="10013:0" data-first-offset="true"><span data-slate-string="true">了解完 Apache APISIX 在 etcd 中的数据存储格式后，那么它是如何动态、近乎实时地感知到服务配置变化的呢？</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10014" id="sr-toc-9"><span data-slate-object="text" data-key="10015"><span data-slate-leaf="true" data-offset-key="10015:0" data-first-offset="true"><span data-slate-string="true">Watch 机制的应用</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="10016"><span data-slate-object="text" data-key="10017"><span data-slate-leaf="true" data-offset-key="10017:0" data-first-offset="true"><span data-slate-string="true">与 Kubernetes 一样，它们都是通过 etcd 的 </span></span></span><span data-slate-object="text" data-key="10018"><span data-slate-leaf="true" data-offset-key="10018:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Watch 机制</span></span></span></span><span data-slate-object="text" data-key="10019"><span data-slate-leaf="true" data-offset-key="10019:0" data-first-offset="true"><span data-slate-string="true">来实现的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10020"><span data-slate-object="text" data-key="10021"><span data-slate-leaf="true" data-offset-key="10021:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 在启动的时候，首先会通过 Range 操作获取网关的配置、路由等信息，随后就通过 Watch 机制，获取增量变化事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10022"><span data-slate-object="text" data-key="10023"><span data-slate-leaf="true" data-offset-key="10023:0" data-first-offset="true"><span data-slate-string="true">使用 Watch 机制最容易犯错的地方是什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10024"><span data-slate-object="text" data-key="10025"><span data-slate-leaf="true" data-offset-key="10025:0" data-first-offset="true"><span data-slate-string="true">答案是不处理 Watch 返回的相关错误信息，比如已压缩 ErrCompacted 错误。Apache APISIX 项目在从 etcd v2 中切换到 etcd v3 早期的时候，同样也犯了这个错误。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10026"><span data-slate-object="text" data-key="10027"><span data-slate-leaf="true" data-offset-key="10027:0" data-first-offset="true"><span data-slate-string="true">去年某日收到小伙伴求助，说使用 Apache APISIX 后，获取不到新的服务配置了，是不是 etcd 出什么 Bug 了？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10028"><span data-slate-object="text" data-key="10029"><span data-slate-leaf="true" data-offset-key="10029:0" data-first-offset="true"><span data-slate-string="true">经过一番交流和查看日志，发现原来是 Apache APISIX 未处理 ErrCompacted 错误导致的。根据我们 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10030"><span data-slate-object="text" data-key="10031"><span data-slate-leaf="true" data-offset-key="10031:0" data-first-offset="true"><span data-slate-string="true">07</span></span></span></a><span data-slate-object="text" data-key="10032"><span data-slate-leaf="true" data-offset-key="10032:0" data-first-offset="true"><span data-slate-string="true">Watch 原理的介绍，当你请求 Watch 的版本号已被 etcd 压缩后，etcd 就会取消这个 watcher，这时你需要重建 watcher，才能继续监听到最新数据变化事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10033"><span data-slate-object="text" data-key="10034"><span data-slate-leaf="true" data-offset-key="10034:0" data-first-offset="true"><span data-slate-string="true">查清楚问题后，小伙伴向社区提交了 issue 反馈，随后 Apache APISIX 相关同学通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10035"><span data-slate-object="text" data-key="10036"><span data-slate-leaf="true" data-offset-key="10036:0" data-first-offset="true"><span data-slate-string="true">PR 2687</span></span></span></a><span data-slate-object="text" data-key="10037"><span data-slate-leaf="true" data-offset-key="10037:0" data-first-offset="true"><span data-slate-string="true"> 修复了此问题，更多信息你可参考 Apache APISIX 访问 etcd </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10038"><span data-slate-object="text" data-key="10039"><span data-slate-leaf="true" data-offset-key="10039:0" data-first-offset="true"><span data-slate-string="true">相关实现代码文件</span></span></span></a><span data-slate-object="text" data-key="10040"><span data-slate-leaf="true" data-offset-key="10040:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10041" id="sr-toc-10"><span data-slate-object="text" data-key="10042"><span data-slate-leaf="true" data-offset-key="10042:0" data-first-offset="true"><span data-slate-string="true">鉴权机制的应用</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="10043"><span data-slate-object="text" data-key="10044"><span data-slate-leaf="true" data-offset-key="10044:0" data-first-offset="true"><span data-slate-string="true">除了 Watch 机制，Apache APISIX 项目还使用了鉴权，毕竟配置网关是个高危操作，那它是如何使用 etcd 鉴权机制的呢？ </span></span></span><span data-slate-object="text" data-key="10045"><span data-slate-leaf="true" data-offset-key="10045:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">etcd 鉴权机制</span></span></span></span><span data-slate-object="text" data-key="10046"><span data-slate-leaf="true" data-offset-key="10046:0" data-first-offset="true"><span data-slate-string="true">中最容易踩的坑是什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10047"><span data-slate-object="text" data-key="10048"><span data-slate-leaf="true" data-offset-key="10048:0" data-first-offset="true"><span data-slate-string="true">答案是不复用 client 和鉴权 token，频繁发起 Authenticate 操作，导致 etcd 高负载。正如我在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10049"><span data-slate-object="text" data-key="10050"><span data-slate-leaf="true" data-offset-key="10050:0" data-first-offset="true"><span data-slate-string="true">17</span></span></span></a><span data-slate-object="text" data-key="10051"><span data-slate-leaf="true" data-offset-key="10051:0" data-first-offset="true"><span data-slate-string="true"> 和你介绍的，一个 8 核 32G 的高配节点在 100 个连接时，Authenticate QPS 仅为 8。可想而知，你如果不复用 token，那么出问题就很自然不过了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10052"><span data-slate-object="text" data-key="10053"><span data-slate-leaf="true" data-offset-key="10053:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 是否也踩了这个坑呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10054"><span data-slate-object="text" data-key="10055"><span data-slate-leaf="true" data-offset-key="10055:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 是基于 Lua 构建的，使用的是 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10056"><span data-slate-object="text" data-key="10057"><span data-slate-leaf="true" data-offset-key="10057:0" data-first-offset="true"><span data-slate-string="true">lua-resty-etcd</span></span></span></a><span data-slate-object="text" data-key="10058"><span data-slate-leaf="true" data-offset-key="10058:0" data-first-offset="true"><span data-slate-string="true"> 这个项目访问 etcd，从相关 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10059"><span data-slate-object="text" data-key="10060"><span data-slate-leaf="true" data-offset-key="10060:0" data-first-offset="true"><span data-slate-string="true">issue</span></span></span></a><span data-slate-object="text" data-key="10061"><span data-slate-leaf="true" data-offset-key="10061:0" data-first-offset="true"><span data-slate-string="true"> 反馈看，的确也踩了这个坑。社区用户反馈后，随后通过复用 client、更完善的 token 复用机制解决了 Authenticate 的性能瓶颈，详细信息你可参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10062"><span data-slate-object="text" data-key="10063"><span data-slate-leaf="true" data-offset-key="10063:0" data-first-offset="true"><span data-slate-string="true">PR 2932</span></span></span></a><span data-slate-object="text" data-key="10064"><span data-slate-leaf="true" data-offset-key="10064:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10065"><span data-slate-object="text" data-key="10066"><span data-slate-leaf="true" data-offset-key="10066:0" data-first-offset="true"><span data-slate-string="true">PR 100</span></span></span></a><span data-slate-object="text" data-key="10067"><span data-slate-leaf="true" data-offset-key="10067:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10068"><span data-slate-object="text" data-key="10069"><span data-slate-leaf="true" data-offset-key="10069:0" data-first-offset="true"><span data-slate-string="true">除了以上介绍的 Watch 机制、鉴权机制，Apache APISIX 还使用了 etcd 的 Lease 特性和事务接口。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10070" id="sr-toc-11"><span data-slate-object="text" data-key="10071"><span data-slate-leaf="true" data-offset-key="10071:0" data-first-offset="true"><span data-slate-string="true">Lease 特性的应用</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="10072"><span data-slate-object="text" data-key="10073"><span data-slate-leaf="true" data-offset-key="10073:0" data-first-offset="true"><span data-slate-string="true">为什么 Apache APISIX 项目需要 Lease 特性呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10074"><span data-slate-object="text" data-key="10075"><span data-slate-leaf="true" data-offset-key="10075:0" data-first-offset="true"><span data-slate-string="true">服务发现的核心工作原理是服务启动的时候将地址信息登录到注册中心，服务异常时自动从注册中心删除。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10076"><span data-slate-object="text" data-key="10077"><span data-slate-leaf="true" data-offset-key="10077:0" data-first-offset="true"><span data-slate-string="true">这是不是跟我们前面 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10078"><span data-slate-object="text" data-key="10079"><span data-slate-leaf="true" data-offset-key="10079:0" data-first-offset="true"><span data-slate-string="true">05</span></span></span></a><span data-slate-object="text" data-key="10080"><span data-slate-leaf="true" data-offset-key="10080:0" data-first-offset="true"><span data-slate-string="true"> 节介绍的 &lt;Lease 特性：如何检测客户端的存活性&gt; 应用场景很匹配呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10081"><span data-slate-object="text" data-key="10082"><span data-slate-leaf="true" data-offset-key="10082:0" data-first-offset="true"><span data-slate-string="true">没错，Apache APISIX 通过 etcd v2 的 TTL 特性、etcd v3 的 Lease 特性来实现类似的效果，它提供的增加服务路由 API，支持设置 TTL 属性，如下面所示：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="10083"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10084"><span data-slate-object="text" data-key="10085"><span data-slate-leaf="true" data-offset-key="10085:0" data-first-offset="true"><span data-slate-string="true"># Create a route expires after </span></span></span><span data-slate-object="text" data-key="10086"><span data-slate-leaf="true" data-offset-key="10086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">60</span></span></span></span><span data-slate-object="text" data-key="10087"><span data-slate-leaf="true" data-offset-key="10087:0" data-first-offset="true"><span data-slate-string="true"> seconds, then it</span></span></span><span data-slate-object="text" data-key="10088"><span data-slate-leaf="true" data-offset-key="10088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'s</span></span></span></span><span data-slate-object="text" data-key="10089"><span data-slate-leaf="true" data-offset-key="10089:0" data-first-offset="true"><span data-slate-string="true"> deleted automatically</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10090"><span data-slate-object="text" data-key="10091"><span data-slate-leaf="true" data-offset-key="10091:0" data-first-offset="true"><span data-slate-string="true">$ curl http:</span></span></span><span data-slate-object="text" data-key="10092"><span data-slate-leaf="true" data-offset-key="10092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//127.0.0.1:9080/apisix/admin/routes/2?ttl=60 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -i -d '</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10093"><span data-slate-object="text" data-key="10094"><span data-slate-leaf="true" data-offset-key="10094:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10095"><span data-slate-object="text" data-key="10096"><span data-slate-leaf="true" data-offset-key="10096:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10097"><span data-slate-leaf="true" data-offset-key="10097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"uri"</span></span></span></span><span data-slate-object="text" data-key="10098"><span data-slate-leaf="true" data-offset-key="10098:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10099"><span data-slate-leaf="true" data-offset-key="10099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/aa/index.html"</span></span></span></span><span data-slate-object="text" data-key="10100"><span data-slate-leaf="true" data-offset-key="10100:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10101"><span data-slate-object="text" data-key="10102"><span data-slate-leaf="true" data-offset-key="10102:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10103"><span data-slate-leaf="true" data-offset-key="10103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"upstream"</span></span></span></span><span data-slate-object="text" data-key="10104"><span data-slate-leaf="true" data-offset-key="10104:0" data-first-offset="true"><span data-slate-string="true">: {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10105"><span data-slate-object="text" data-key="10106"><span data-slate-leaf="true" data-offset-key="10106:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10107"><span data-slate-leaf="true" data-offset-key="10107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"type"</span></span></span></span><span data-slate-object="text" data-key="10108"><span data-slate-leaf="true" data-offset-key="10108:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10109"><span data-slate-leaf="true" data-offset-key="10109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"roundrobin"</span></span></span></span><span data-slate-object="text" data-key="10110"><span data-slate-leaf="true" data-offset-key="10110:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10111"><span data-slate-object="text" data-key="10112"><span data-slate-leaf="true" data-offset-key="10112:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10113"><span data-slate-leaf="true" data-offset-key="10113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"nodes"</span></span></span></span><span data-slate-object="text" data-key="10114"><span data-slate-leaf="true" data-offset-key="10114:0" data-first-offset="true"><span data-slate-string="true">: {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10115"><span data-slate-object="text" data-key="10116"><span data-slate-leaf="true" data-offset-key="10116:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="10117"><span data-slate-leaf="true" data-offset-key="10117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"39.97.63.215:80"</span></span></span></span><span data-slate-object="text" data-key="10118"><span data-slate-leaf="true" data-offset-key="10118:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10119"><span data-slate-leaf="true" data-offset-key="10119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10120"><span data-slate-object="text" data-key="10121"><span data-slate-leaf="true" data-offset-key="10121:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10122"><span data-slate-object="text" data-key="10123"><span data-slate-leaf="true" data-offset-key="10123:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10124"><span data-slate-object="text" data-key="10125"><span data-slate-leaf="true" data-offset-key="10125:0" data-first-offset="true"><span data-slate-string="true">}'</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10126"><span data-slate-object="text" data-key="10127"><span data-slate-leaf="true" data-offset-key="10127:0" data-first-offset="true"><span data-slate-string="true">当一个路由设置非 0 TTL 后，Apache APISIX 就会为它创建 Lease，关联 key，相关代码如下：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="10128"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10129"><span data-slate-object="text" data-key="10130"><span data-slate-leaf="true" data-offset-key="10130:0" data-first-offset="true"><span data-slate-string="true">-- lease substitute ttl </span></span></span><span data-slate-object="text" data-key="10131"><span data-slate-leaf="true" data-offset-key="10131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="10132"><span data-slate-leaf="true" data-offset-key="10132:0" data-first-offset="true"><span data-slate-string="true"> v3</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10133"><span data-slate-object="text" data-key="10134"><span data-slate-leaf="true" data-offset-key="10134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">local</span></span></span></span><span data-slate-object="text" data-key="10135"><span data-slate-leaf="true" data-offset-key="10135:0" data-first-offset="true"><span data-slate-string="true"> res, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10136"><span data-slate-object="text" data-key="10137"><span data-slate-leaf="true" data-offset-key="10137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10138"><span data-slate-leaf="true" data-offset-key="10138:0" data-first-offset="true"><span data-slate-string="true"> ttl </span></span></span><span data-slate-object="text" data-key="10139"><span data-slate-leaf="true" data-offset-key="10139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">then</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10140"><span data-slate-object="text" data-key="10141"><span data-slate-leaf="true" data-offset-key="10141:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10142"><span data-slate-leaf="true" data-offset-key="10142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">local</span></span></span></span><span data-slate-object="text" data-key="10143"><span data-slate-leaf="true" data-offset-key="10143:0" data-first-offset="true"><span data-slate-string="true"> data, grant_err = etcd_cli:grant(tonumber(ttl))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10144"><span data-slate-object="text" data-key="10145"><span data-slate-leaf="true" data-offset-key="10145:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10146"><span data-slate-leaf="true" data-offset-key="10146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10147"><span data-slate-leaf="true" data-offset-key="10147:0" data-first-offset="true"><span data-slate-string="true"> not data </span></span></span><span data-slate-object="text" data-key="10148"><span data-slate-leaf="true" data-offset-key="10148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">then</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10149"><span data-slate-object="text" data-key="10150"><span data-slate-leaf="true" data-offset-key="10150:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10151"><span data-slate-leaf="true" data-offset-key="10151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10152"><span data-slate-leaf="true" data-offset-key="10152:0" data-first-offset="true"><span data-slate-string="true"> nil, grant_err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10153"><span data-slate-object="text" data-key="10154"><span data-slate-leaf="true" data-offset-key="10154:0" data-first-offset="true"><span data-slate-string="true">    end</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10155"><span data-slate-object="text" data-key="10156"><span data-slate-leaf="true" data-offset-key="10156:0" data-first-offset="true"><span data-slate-string="true">    res, err = etcd_cli:</span></span></span><span data-slate-object="text" data-key="10157"><span data-slate-leaf="true" data-offset-key="10157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set</span></span></span></span><span data-slate-object="text" data-key="10158"><span data-slate-leaf="true" data-offset-key="10158:0" data-first-offset="true"><span data-slate-string="true">(prefix .. key, value, {prev_kv = </span></span></span><span data-slate-object="text" data-key="10159"><span data-slate-leaf="true" data-offset-key="10159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="10160"><span data-slate-leaf="true" data-offset-key="10160:0" data-first-offset="true"><span data-slate-string="true">, lease = data.body.ID})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10161"><span data-slate-object="text" data-key="10162"><span data-slate-leaf="true" data-offset-key="10162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10163"><span data-slate-object="text" data-key="10164"><span data-slate-leaf="true" data-offset-key="10164:0" data-first-offset="true"><span data-slate-string="true">    res, err = etcd_cli:</span></span></span><span data-slate-object="text" data-key="10165"><span data-slate-leaf="true" data-offset-key="10165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set</span></span></span></span><span data-slate-object="text" data-key="10166"><span data-slate-leaf="true" data-offset-key="10166:0" data-first-offset="true"><span data-slate-string="true">(prefix .. key, value, {prev_kv = </span></span></span><span data-slate-object="text" data-key="10167"><span data-slate-leaf="true" data-offset-key="10167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="10168"><span data-slate-leaf="true" data-offset-key="10168:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10169"><span data-slate-object="text" data-key="10170"><span data-slate-leaf="true" data-offset-key="10170:0" data-first-offset="true"><span data-slate-string="true">end</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h4 data-slate-type="heading" data-slate-object="block" data-key="10171" id="sr-toc-12"><span data-slate-object="text" data-key="10172"><span data-slate-leaf="true" data-offset-key="10172:0" data-first-offset="true"><span data-slate-string="true">事务特性的应用</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="10173"><span data-slate-object="text" data-key="10174"><span data-slate-leaf="true" data-offset-key="10174:0" data-first-offset="true"><span data-slate-string="true">介绍完 Lease 特性在 Apache APISIX 项目中的应用后，我们再来思考两个问题。为什么它还依赖 etcd 的事务特性呢？简单的执行 put 接口有什么问题？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10175"><span data-slate-object="text" data-key="10176"><span data-slate-leaf="true" data-offset-key="10176:0" data-first-offset="true"><span data-slate-string="true">答案是它跟 Kubernetes 是一样的使用目的。使用事务是为了防止并发场景下的数据写冲突，比如你可能同时发起两个 Patch Admin API 去修改配置等。如果简单地使用 put 接口，就会导致第一个写请求的结果被覆盖。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10177"><span data-slate-object="text" data-key="10178"><span data-slate-leaf="true" data-offset-key="10178:0" data-first-offset="true"><span data-slate-string="true">Apache APISIX 是如何使用事务接口提供的乐观锁机制去解决并发冲突的问题呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10179"><span data-slate-object="text" data-key="10180"><span data-slate-leaf="true" data-offset-key="10180:0" data-first-offset="true"><span data-slate-string="true">核心依然是我们前面课程中一直强调的 mod_revision，它会比较事务提交时的 mod_revision 与预期是否一致，一致才能执行 put 操作，Apache APISIX 相关使用代码如下：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="10181"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10182"><span data-slate-object="text" data-key="10183"><span data-slate-leaf="true" data-offset-key="10183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">local</span></span></span></span><span data-slate-object="text" data-key="10184"><span data-slate-leaf="true" data-offset-key="10184:0" data-first-offset="true"><span data-slate-string="true"> compare = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10185"><span data-slate-object="text" data-key="10186"><span data-slate-leaf="true" data-offset-key="10186:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10187"><span data-slate-object="text" data-key="10188"><span data-slate-leaf="true" data-offset-key="10188:0" data-first-offset="true"><span data-slate-string="true">        key = key,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10189"><span data-slate-object="text" data-key="10190"><span data-slate-leaf="true" data-offset-key="10190:0" data-first-offset="true"><span data-slate-string="true">        target = </span></span></span><span data-slate-object="text" data-key="10191"><span data-slate-leaf="true" data-offset-key="10191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"MOD"</span></span></span></span><span data-slate-object="text" data-key="10192"><span data-slate-leaf="true" data-offset-key="10192:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10193"><span data-slate-object="text" data-key="10194"><span data-slate-leaf="true" data-offset-key="10194:0" data-first-offset="true"><span data-slate-string="true">        result = </span></span></span><span data-slate-object="text" data-key="10195"><span data-slate-leaf="true" data-offset-key="10195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"EQUAL"</span></span></span></span><span data-slate-object="text" data-key="10196"><span data-slate-leaf="true" data-offset-key="10196:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10197"><span data-slate-object="text" data-key="10198"><span data-slate-leaf="true" data-offset-key="10198:0" data-first-offset="true"><span data-slate-string="true">        mod_revision = mod_revision,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10199"><span data-slate-object="text" data-key="10200"><span data-slate-leaf="true" data-offset-key="10200:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10201"><span data-slate-object="text" data-key="10202"><span data-slate-leaf="true" data-offset-key="10202:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10203"><span data-slate-object="text" data-key="10204"><span data-slate-leaf="true" data-offset-key="10204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">local</span></span></span></span><span data-slate-object="text" data-key="10205"><span data-slate-leaf="true" data-offset-key="10205:0" data-first-offset="true"><span data-slate-string="true"> success = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10206"><span data-slate-object="text" data-key="10207"><span data-slate-leaf="true" data-offset-key="10207:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10208"><span data-slate-object="text" data-key="10209"><span data-slate-leaf="true" data-offset-key="10209:0" data-first-offset="true"><span data-slate-string="true">        requestPut = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10210"><span data-slate-object="text" data-key="10211"><span data-slate-leaf="true" data-offset-key="10211:0" data-first-offset="true"><span data-slate-string="true">            key = key,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10212"><span data-slate-object="text" data-key="10213"><span data-slate-leaf="true" data-offset-key="10213:0" data-first-offset="true"><span data-slate-string="true">            value = value,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10214"><span data-slate-object="text" data-key="10215"><span data-slate-leaf="true" data-offset-key="10215:0" data-first-offset="true"><span data-slate-string="true">            lease = lease_id,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10216"><span data-slate-object="text" data-key="10217"><span data-slate-leaf="true" data-offset-key="10217:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10218"><span data-slate-object="text" data-key="10219"><span data-slate-leaf="true" data-offset-key="10219:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10220"><span data-slate-object="text" data-key="10221"><span data-slate-leaf="true" data-offset-key="10221:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10222"><span data-slate-object="text" data-key="10223"><span data-slate-leaf="true" data-offset-key="10223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">local</span></span></span></span><span data-slate-object="text" data-key="10224"><span data-slate-leaf="true" data-offset-key="10224:0" data-first-offset="true"><span data-slate-string="true"> res, err = etcd_cli:txn(compare, success)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10225"><span data-slate-object="text" data-key="10226"><span data-slate-leaf="true" data-offset-key="10226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10227"><span data-slate-leaf="true" data-offset-key="10227:0" data-first-offset="true"><span data-slate-string="true"> not res </span></span></span><span data-slate-object="text" data-key="10228"><span data-slate-leaf="true" data-offset-key="10228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">then</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10229"><span data-slate-object="text" data-key="10230"><span data-slate-leaf="true" data-offset-key="10230:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10231"><span data-slate-leaf="true" data-offset-key="10231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="10232"><span data-slate-leaf="true" data-offset-key="10232:0" data-first-offset="true"><span data-slate-string="true"> nil, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10233"><span data-slate-object="text" data-key="10234"><span data-slate-leaf="true" data-offset-key="10234:0" data-first-offset="true"><span data-slate-string="true">end</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10235"><span data-slate-object="text" data-key="10236"><span data-slate-leaf="true" data-offset-key="10236:0" data-first-offset="true"><span data-slate-string="true">关于 Apache APISIX 事务特性的引入、背景以及更详细的实现，你也可以参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="10237"><span data-slate-object="text" data-key="10238"><span data-slate-leaf="true" data-offset-key="10238:0" data-first-offset="true"><span data-slate-string="true">PR 2216</span></span></span></a><span data-slate-object="text" data-key="10239"><span data-slate-leaf="true" data-offset-key="10239:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10240" id="sr-toc-13"><span data-slate-object="text" data-key="10241"><span data-slate-leaf="true" data-offset-key="10241:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10242"><span data-slate-object="text" data-key="10243"><span data-slate-leaf="true" data-offset-key="10243:0" data-first-offset="true"><span data-slate-string="true">最后我们来小结下今天的内容。今天我给你介绍了服务部署架构的演进，我们从单体架构的缺陷开始、到分布式及微服务架构的诞生，和你分享了分布式及微服务架构中面临的一系列痛点（如服务发现，鉴权，安全，限速等等）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10244"><span data-slate-object="text" data-key="10245"><span data-slate-leaf="true" data-offset-key="10245:0" data-first-offset="true"><span data-slate-string="true">而开源项目 Apache APISIX 正是一个基于 etcd 的项目，它为后端存储提供了一系列的解决方案，我通过它的架构图为你介绍了其控制面和数据面的工作原理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10246"><span data-slate-object="text" data-key="10247"><span data-slate-leaf="true" data-offset-key="10247:0" data-first-offset="true"><span data-slate-string="true">随后我从数据存储格式、Watch 机制、鉴权机制、Lease 特性以及事务特性维度，和你分析了它们在 Apache APISIX 项目中的应用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10248"><span data-slate-object="text" data-key="10249"><span data-slate-leaf="true" data-offset-key="10249:0" data-first-offset="true"><span data-slate-string="true">数据存储格式上，APISIX 采用典型的 prefix + 功能特性组织格式。key 是相关配置 id，value 是个 json 对象，包含一系列业务所需要的核心数据。你需要注意的是 Apache APISIX 1.x 版本使用的 etcd v2 API，2.x 版本使用的是 etcd v3 API，要求至少是 etcd v3.4 版本以上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10250"><span data-slate-object="text" data-key="10251"><span data-slate-leaf="true" data-offset-key="10251:0" data-first-offset="true"><span data-slate-string="true">Watch 机制上，APISIX 依赖它进行配置的动态、实时更新，避免了传统的修改配置，需要服务重启等缺陷。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10252"><span data-slate-object="text" data-key="10253"><span data-slate-leaf="true" data-offset-key="10253:0" data-first-offset="true"><span data-slate-string="true">鉴权机制上，APISIX 使用密码认证，进行多租户认证、授权，防止用户出现越权访问，保护网关服务的安全。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10254"><span data-slate-object="text" data-key="10255"><span data-slate-leaf="true" data-offset-key="10255:0" data-first-offset="true"><span data-slate-string="true">Lease 及事务特性上，APISIX 通过 Lease 来设置自动过期的路由规则，解决服务发现中的节点异常自动剔除等问题，通过事务特性的乐观锁机制来实现并发场景下覆盖更新等问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10256"><span data-slate-object="text" data-key="10257"><span data-slate-leaf="true" data-offset-key="10257:0" data-first-offset="true"><span data-slate-string="true">希望通过本节课的学习，让你从 etcd 角度更深入了解 APISIX 项目的原理，了解 etcd 各个特性在其中的应用，学习它的最佳实践经验和经历的各种坑，避免重复踩坑。在以后的工作中，在你使用 APISIX 等开源项目遇到 etcd 相关错误时，能独立分析、排查，甚至给社区提交 PR 解决。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10258" id="sr-toc-14"><span data-slate-object="text" data-key="10259"><span data-slate-leaf="true" data-offset-key="10259:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10260"><span data-slate-object="text" data-key="10261"><span data-slate-leaf="true" data-offset-key="10261:0" data-first-offset="true"><span data-slate-string="true">好了，这节课到这里也就结束了，最后我给你留了一个开放的配置系统设计思考题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10262"><span data-slate-object="text" data-key="10263"><span data-slate-leaf="true" data-offset-key="10263:0" data-first-offset="true"><span data-slate-string="true">假设老板让你去设计一个大型配置系统，满足公司各个业务场景的诉求，期望的设计目标如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10264"><div data-slate-type="list-line" data-slate-object="block" data-key="10265"><span data-slate-object="text" data-key="10266"><span data-slate-leaf="true" data-offset-key="10266:0" data-first-offset="true"><span data-slate-string="true">高可靠。配置系统的作为核心基础设施，期望可用性能达到 99.99%。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10267"><span data-slate-object="text" data-key="10268"><span data-slate-leaf="true" data-offset-key="10268:0" data-first-offset="true"><span data-slate-string="true">高性能。公司业务多，规模大，配置系统应具备高性能、并能水平扩容。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10269"><span data-slate-object="text" data-key="10270"><span data-slate-leaf="true" data-offset-key="10270:0" data-first-offset="true"><span data-slate-string="true">支持多业务、多版本管理、多种发布策略。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10271"><span data-slate-object="text" data-key="10272"><span data-slate-leaf="true" data-offset-key="10272:0" data-first-offset="true"><span data-slate-string="true">你认为 etcd 适合此业务场景吗？如果适合，分享下你的核心想法、整体架构，如果不适合，你心目中的理想存储和架构又是怎样的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10273"><span data-slate-object="text" data-key="10274"><span data-slate-leaf="true" data-offset-key="10274:0" data-first-offset="true"><span data-slate-string="true">欢迎大家留言一起讨论，后面我也将在答疑篇中分享我的一些想法和曾经大规模 TO C 业务中的实践经验。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10275"><span data-slate-object="text" data-key="10276"><span data-slate-leaf="true" data-offset-key="10276:0" data-first-offset="true"><span data-slate-string="true">感谢你阅读，也欢迎你把这篇文章分享给更多的朋友一起阅读。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-15">精选留言 (7)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>那时刻</span></div></div><div>老师的问题，我的个人看法是，采用 etcd 应该是可行的。

1. 高可靠。etcd 基于 raft 的多副本可以满足。
2. 高性能。公司业务多，规模大，可以依据不同业务不同 etcd 的方法，分担 etcd 的写压力，以及数据存储量有限的问题。各自业务的 etcd 可以水平扩展。
3. 支持多业务、多版本管理、多种发布策略。etcd 可以做到多版本管理，多发布策略的话，可以级联多个 etcd 的方法。

另外，可能更加理想的存储架构方式是采用计算与存储分离的方法，计算部分处理读写以及扩展，存储部分处理多版本，多业务，多发布策略。</div><div><p>作者回复：嗯，整体想法不错，特别是考虑到数据容量问题，但是还需要考虑更多问题，比如性能问题，一个业务可能数万个 client, 直接读 etcd 性能肯定扛不住的，其次是复杂度管理，比如一个业务分配一个 etcd 集群，那这过程是手动的还是自动的呢？能否自动快速就接入一个新业务而无需相关运维操作呢？ 或者有没有更好的存储方案。</p></div><div><div>2021-03-12</div><div><div><i></i><span>2</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_daf51a</span></div></div><div>思考题很棒，我认为 etcd 并不合适，适合使用可平行扩容的分布式数据库如 tidb，运维复杂度不更低点吗，容量也更大，还能支持各种 key value 大小配置</div><div><div>2021-03-12</div><div><div><i></i><span></span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/40/06/bb31933b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 大爱无疆</span></div></div><div>做一个 etcd proxy，proxy 实现 hash，将不同的 /key  映射到后端不同的 etcd 集群上。
这样 相当于实现了 支持分片的 分布式存储。</div><div><p>作者回复：嗯啊，这个想法在有的公司落地了，但是不支持跨多节点的事务，有一定局限性，proxy 稳定性也是个考验</p></div><div><div>2021-04-09</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_ed84ef</span></div></div><div>给服务路由配 Lease 跟 APISIX 提供的健康检查插件有什么区别吗？好像都是服务异常后可自动摘除节点</div><div><div>2021-04-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/41/64/cf13c011.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>刁寿钧</span></div></div><div>其实还期待讨论下 APISIX 搭配证书使用 etcd 的姿势，哈哈</div><div><div>2021-03-15</div><div><div><i></i><span>1</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/3b/46/3701e908.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Coder</span></div></div><div>我认为使用支持分片的 nosql 数据库比较合适，比如 redis 集群版本，一主两副本、还是很可靠得</div><div><div>2021-03-13</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>云原生工程师</span></div></div><div>我认为 etcd 不太合适，应该使用类似阿里云 drds、腾讯云 tdsql 这样分布式数据库，不过数据推送机制就没了，需要轮询了，但是容量不需要担心，支持多业务就表中增加一个字段或独立的表</div><div><div>2021-03-13</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1v"><outline class="toc-level-h1" data-reactid=".1v.0" style="width: 175px;"><active data-reactid=".1v.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1v.0.1"><span data-reactid=".1v.0.1.0">22 | 配置及服务发现：解析 etcd 在 API Gateway 开源项目中应用</span></a></outline><outline class="toc-level-h2" data-reactid=".1v.1" style="width: 165px;"><active data-reactid=".1v.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1v.1.1"><span data-reactid=".1v.1.1.0">服务发现</span></a></outline><outline class="toc-level-h3" data-reactid=".1v.2" style="width: 155px;"><active data-reactid=".1v.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1v.2.1"><span data-reactid=".1v.2.1.0">单体架构</span></a></outline><outline class="toc-level-h3" data-reactid=".1v.3" style="width: 155px;"><active data-reactid=".1v.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1v.3.1"><span data-reactid=".1v.3.1.0">分布式及微服务架构</span></a></outline><outline class="toc-level-h3" data-reactid=".1v.4" style="width: 155px;"><active data-reactid=".1v.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1v.4.1"><span data-reactid=".1v.4.1.0">为什么需要服务发现中间件？</span></a></outline><outline class="toc-level-h3" data-reactid=".1v.5" style="width: 155px;"><active data-reactid=".1v.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1v.5.1"><span data-reactid=".1v.5.1.0">etcd 服务发现原理</span></a></outline><outline class="toc-level-h3" data-reactid=".1v.6" style="width: 155px;"><active data-reactid=".1v.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1v.6.1"><span data-reactid=".1v.6.1.0">Apache APISIX 原理</span></a></outline><outline class="toc-level-h3" data-reactid=".1v.7" style="width: 155px;"><active data-reactid=".1v.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1v.7.1"><span data-reactid=".1v.7.1.0">etcd 在 Apache APISIX 中的应用</span></a></outline><outline class="toc-level-h4" data-reactid=".1v.8" style="width: 145px;"><active data-reactid=".1v.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1v.8.1"><span data-reactid=".1v.8.1.0">数据存储格式</span></a></outline><outline class="toc-level-h4" data-reactid=".1v.9" style="width: 145px;"><active data-reactid=".1v.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1v.9.1"><span data-reactid=".1v.9.1.0">Watch 机制的应用</span></a></outline><outline class="toc-level-h4" data-reactid=".1v.a" style="width: 145px;"><active data-reactid=".1v.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1v.a.1"><span data-reactid=".1v.a.1.0">鉴权机制的应用</span></a></outline><outline class="toc-level-h4" data-reactid=".1v.b" style="width: 145px;"><active data-reactid=".1v.b.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1v.b.1"><span data-reactid=".1v.b.1.0">Lease 特性的应用</span></a></outline><outline class="toc-level-h4" data-reactid=".1v.c" style="width: 145px;"><active data-reactid=".1v.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".1v.c.1"><span data-reactid=".1v.c.1.0">事务特性的应用</span></a></outline><outline class="toc-level-h2" data-reactid=".1v.d" style="width: 165px;"><active data-reactid=".1v.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".1v.d.1"><span data-reactid=".1v.d.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".1v.e" style="width: 165px;"><active data-reactid=".1v.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".1v.e.1"><span data-reactid=".1v.e.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1v.f" style="width: 165px;"><active data-reactid=".1v.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".1v.f.1"><span data-reactid=".1v.f.1.0">精选留言 (7)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/351113" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>