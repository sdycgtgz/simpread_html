
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 31 | GroupMetadataManager：查询位移时，不用读取位移主题？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>31 | GroupMetadataManager：查询位移时，不用读取位移主题？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">学完了今天的课程之后，你不但能够说出 4 种 Leader 选举的场景，还能总结出它们的共性。对于面试来说，绝对是个加分项！</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">31 | GroupMetadataManager：查询位移时，不用读取位移主题？</h1><div><span>胡夕</span> <span> 2020-07-09</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/eb/c3/ebbe8863158dc9c6ca94c5641650bcc3.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：14.22M</span><span> 时长：15:32</span></div></div><audio title="31 | GroupMetadataManager：查询位移时，不用读取位移主题？" src="https://res001.geekbang.org/media/audio/cc/e8/cc65d5cd5e47f8262f73f51940008be8/ld/ld.m3u8" __idm_id__="57358"></audio></div><div><div><div><div data-slate-editor="true" data-key="12855" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="12856"><span data-slate-object="text" data-key="12857"><span data-slate-leaf="true" data-offset-key="12857:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12858"><span data-slate-object="text" data-key="12859"><span data-slate-leaf="true" data-offset-key="12859:0" data-first-offset="true"><span data-slate-string="true">上节课，我们学习了位移主题中的两类消息：</span></span></span><span data-slate-object="text" data-key="12860"><span data-slate-leaf="true" data-offset-key="12860:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">消费者组注册消息</span></span></span></span><span data-slate-object="text" data-key="12861"><span data-slate-leaf="true" data-offset-key="12861:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><span data-slate-object="text" data-key="12862"><span data-slate-leaf="true" data-offset-key="12862:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">消费者组已提交位移消息</span></span></span></span><span data-slate-object="text" data-key="12863"><span data-slate-leaf="true" data-offset-key="12863:0" data-first-offset="true"><span data-slate-string="true">。今天，我们接着学习位移主题，重点是掌握写入位移主题和读取位移主题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12864"><span data-slate-object="text" data-key="12865"><span data-slate-leaf="true" data-offset-key="12865:0" data-first-offset="true"><span data-slate-string="true">我们总说，位移主题是个神秘的主题，除了它并非我们亲自创建之外，它的神秘之处还体现在，它的读写也不由我们控制。默认情况下，我们没法向这个主题写入消息，而且直接读取该主题的消息时，看到的更是一堆乱码。因此，今天我们学习一下读写位移主题，这正是去除它神秘感的重要一步。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12866" id="sr-toc-1"><span data-slate-object="text" data-key="12867"><span data-slate-leaf="true" data-offset-key="12867:0" data-first-offset="true"><span data-slate-string="true">写入位移主题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12868"><span data-slate-object="text" data-key="12869"><span data-slate-leaf="true" data-offset-key="12869:0" data-first-offset="true"><span data-slate-string="true">我们先来学习一下位移主题的写入。在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="12870"><span data-slate-object="text" data-key="12871"><span data-slate-leaf="true" data-offset-key="12871:0" data-first-offset="true"><span data-slate-string="true">第 29 讲</span></span></span></a><span data-slate-object="text" data-key="12872"><span data-slate-leaf="true" data-offset-key="12872:0" data-first-offset="true"><span data-slate-string="true">学习 storeOffsets 方法时，我们已经学过了 appendForGroup 方法。Kafka 定义的两类消息类型都是由它写入的。在源码中，storeGroup 方法调用它写入消费者组注册消息，storeOffsets 方法调用它写入已提交位移消息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12873"><span data-slate-object="text" data-key="12874"><span data-slate-leaf="true" data-offset-key="12874:0" data-first-offset="true"><span data-slate-string="true">首先，我们需要知道 storeGroup 方法，它的作用是</span></span></span><span data-slate-object="text" data-key="12875"><span data-slate-leaf="true" data-offset-key="12875:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">向 Coordinator 注册消费者组</span></span></span></span><span data-slate-object="text" data-key="12876"><span data-slate-leaf="true" data-offset-key="12876:0" data-first-offset="true"><span data-slate-string="true">。我们看下它的代码实现：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="12877"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12878"><span data-slate-object="text" data-key="12879"><span data-slate-leaf="true" data-offset-key="12879:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="12880"><span data-slate-leaf="true" data-offset-key="12880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">storeGroup</span></span></span></span><span data-slate-object="text" data-key="12881"><span data-slate-leaf="true" data-offset-key="12881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(group: GroupMetadata,</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12882"><span data-slate-object="text" data-key="12883"><span data-slate-leaf="true" data-offset-key="12883:0" data-first-offset="true"><span data-slate-string="true">               groupAssignment: Map[String, Array[Byte]],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12884"><span data-slate-object="text" data-key="12885"><span data-slate-leaf="true" data-offset-key="12885:0" data-first-offset="true"><span data-slate-string="true">               responseCallback: Errors =&gt; Unit): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12886"><span data-slate-object="text" data-key="12887"><span data-slate-leaf="true" data-offset-key="12887:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12888"><span data-slate-leaf="true" data-offset-key="12888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断当前 Broker 是否是该消费者组的 Coordinator</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12889"><span data-slate-object="text" data-key="12890"><span data-slate-leaf="true" data-offset-key="12890:0" data-first-offset="true"><span data-slate-string="true">  getMagic(partitionFor(group.groupId)) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12891"><span data-slate-object="text" data-key="12892"><span data-slate-leaf="true" data-offset-key="12892:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12893"><span data-slate-leaf="true" data-offset-key="12893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前 Broker 不是 Coordinator</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12894"><span data-slate-object="text" data-key="12895"><span data-slate-leaf="true" data-offset-key="12895:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12896"><span data-slate-leaf="true" data-offset-key="12896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="12897"><span data-slate-leaf="true" data-offset-key="12897:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12898"><span data-slate-leaf="true" data-offset-key="12898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Some</span></span></span></span><span data-slate-object="text" data-key="12899"><span data-slate-leaf="true" data-offset-key="12899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(magicValue)</span></span></span></span><span data-slate-object="text" data-key="12900"><span data-slate-leaf="true" data-offset-key="12900:0" data-first-offset="true"><span data-slate-string="true"> =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12901"><span data-slate-object="text" data-key="12902"><span data-slate-leaf="true" data-offset-key="12902:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12903"><span data-slate-leaf="true" data-offset-key="12903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12904"><span data-slate-leaf="true" data-offset-key="12904:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12905"><span data-slate-leaf="true" data-offset-key="12905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">timestampType</span></span></span></span><span data-slate-object="text" data-key="12906"><span data-slate-leaf="true" data-offset-key="12906:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12907"><span data-slate-leaf="true" data-offset-key="12907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12908"><span data-slate-leaf="true" data-offset-key="12908:0" data-first-offset="true"><span data-slate-string="true"> TimestampType.CREATE_TIME</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12909"><span data-slate-object="text" data-key="12910"><span data-slate-leaf="true" data-offset-key="12910:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12911"><span data-slate-leaf="true" data-offset-key="12911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12912"><span data-slate-leaf="true" data-offset-key="12912:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12913"><span data-slate-leaf="true" data-offset-key="12913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">timestamp</span></span></span></span><span data-slate-object="text" data-key="12914"><span data-slate-leaf="true" data-offset-key="12914:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12915"><span data-slate-leaf="true" data-offset-key="12915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12916"><span data-slate-leaf="true" data-offset-key="12916:0" data-first-offset="true"><span data-slate-string="true"> time.milliseconds()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12917"><span data-slate-object="text" data-key="12918"><span data-slate-leaf="true" data-offset-key="12918:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12919"><span data-slate-leaf="true" data-offset-key="12919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构建注册消息的 Key</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12920"><span data-slate-object="text" data-key="12921"><span data-slate-leaf="true" data-offset-key="12921:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12922"><span data-slate-leaf="true" data-offset-key="12922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12923"><span data-slate-leaf="true" data-offset-key="12923:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12924"><span data-slate-leaf="true" data-offset-key="12924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">key</span></span></span></span><span data-slate-object="text" data-key="12925"><span data-slate-leaf="true" data-offset-key="12925:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12926"><span data-slate-leaf="true" data-offset-key="12926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12927"><span data-slate-leaf="true" data-offset-key="12927:0" data-first-offset="true"><span data-slate-string="true"> GroupMetadataManager.groupMetadataKey(group.groupId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12928"><span data-slate-object="text" data-key="12929"><span data-slate-leaf="true" data-offset-key="12929:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12930"><span data-slate-leaf="true" data-offset-key="12930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构建注册消息的 Value</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12931"><span data-slate-object="text" data-key="12932"><span data-slate-leaf="true" data-offset-key="12932:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12933"><span data-slate-leaf="true" data-offset-key="12933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12934"><span data-slate-leaf="true" data-offset-key="12934:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12935"><span data-slate-leaf="true" data-offset-key="12935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">value</span></span></span></span><span data-slate-object="text" data-key="12936"><span data-slate-leaf="true" data-offset-key="12936:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12937"><span data-slate-leaf="true" data-offset-key="12937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12938"><span data-slate-leaf="true" data-offset-key="12938:0" data-first-offset="true"><span data-slate-string="true"> GroupMetadataManager.groupMetadataValue(group, groupAssignment, interBrokerProtocolVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12939"><span data-slate-object="text" data-key="12940"><span data-slate-leaf="true" data-offset-key="12940:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12941"><span data-slate-leaf="true" data-offset-key="12941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用 Key 和 Value 构建待写入消息集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12942"><span data-slate-object="text" data-key="12943"><span data-slate-leaf="true" data-offset-key="12943:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12944"><span data-slate-leaf="true" data-offset-key="12944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12945"><span data-slate-leaf="true" data-offset-key="12945:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12946"><span data-slate-leaf="true" data-offset-key="12946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">records</span></span></span></span><span data-slate-object="text" data-key="12947"><span data-slate-leaf="true" data-offset-key="12947:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12948"><span data-slate-leaf="true" data-offset-key="12948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12949"><span data-slate-leaf="true" data-offset-key="12949:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12950"><span data-slate-object="text" data-key="12951"><span data-slate-leaf="true" data-offset-key="12951:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12952"><span data-slate-leaf="true" data-offset-key="12952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12953"><span data-slate-leaf="true" data-offset-key="12953:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12954"><span data-slate-leaf="true" data-offset-key="12954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">buffer</span></span></span></span><span data-slate-object="text" data-key="12955"><span data-slate-leaf="true" data-offset-key="12955:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12956"><span data-slate-leaf="true" data-offset-key="12956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12957"><span data-slate-leaf="true" data-offset-key="12957:0" data-first-offset="true"><span data-slate-string="true"> ByteBuffer.allocate(AbstractRecords.estimateSizeInBytes(magicValue, compressionType,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12958"><span data-slate-object="text" data-key="12959"><span data-slate-leaf="true" data-offset-key="12959:0" data-first-offset="true"><span data-slate-string="true">          Seq(</span></span></span><span data-slate-object="text" data-key="12960"><span data-slate-leaf="true" data-offset-key="12960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="12961"><span data-slate-leaf="true" data-offset-key="12961:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12962"><span data-slate-leaf="true" data-offset-key="12962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SimpleRecord</span></span></span></span><span data-slate-object="text" data-key="12963"><span data-slate-leaf="true" data-offset-key="12963:0" data-first-offset="true"><span data-slate-string="true">(timestamp, key, value)).asJava))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12964"><span data-slate-object="text" data-key="12965"><span data-slate-leaf="true" data-offset-key="12965:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12966"><span data-slate-leaf="true" data-offset-key="12966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12967"><span data-slate-leaf="true" data-offset-key="12967:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12968"><span data-slate-leaf="true" data-offset-key="12968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">builder</span></span></span></span><span data-slate-object="text" data-key="12969"><span data-slate-leaf="true" data-offset-key="12969:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12970"><span data-slate-leaf="true" data-offset-key="12970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12971"><span data-slate-leaf="true" data-offset-key="12971:0" data-first-offset="true"><span data-slate-string="true"> MemoryRecords.builder(buffer, magicValue, compressionType, timestampType, </span></span></span><span data-slate-object="text" data-key="12972"><span data-slate-leaf="true" data-offset-key="12972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0L</span></span></span></span><span data-slate-object="text" data-key="12973"><span data-slate-leaf="true" data-offset-key="12973:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12974"><span data-slate-object="text" data-key="12975"><span data-slate-leaf="true" data-offset-key="12975:0" data-first-offset="true"><span data-slate-string="true">        builder.append(timestamp, key, value)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12976"><span data-slate-object="text" data-key="12977"><span data-slate-leaf="true" data-offset-key="12977:0" data-first-offset="true"><span data-slate-string="true">        builder.build()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12978"><span data-slate-object="text" data-key="12979"><span data-slate-leaf="true" data-offset-key="12979:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12980"><span data-slate-object="text" data-key="12981"><span data-slate-leaf="true" data-offset-key="12981:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12982"><span data-slate-leaf="true" data-offset-key="12982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 计算要写入的目标分区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12983"><span data-slate-object="text" data-key="12984"><span data-slate-leaf="true" data-offset-key="12984:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12985"><span data-slate-leaf="true" data-offset-key="12985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12986"><span data-slate-leaf="true" data-offset-key="12986:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12987"><span data-slate-leaf="true" data-offset-key="12987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">groupMetadataPartition</span></span></span></span><span data-slate-object="text" data-key="12988"><span data-slate-leaf="true" data-offset-key="12988:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12989"><span data-slate-leaf="true" data-offset-key="12989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="12990"><span data-slate-leaf="true" data-offset-key="12990:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12991"><span data-slate-leaf="true" data-offset-key="12991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="12992"><span data-slate-leaf="true" data-offset-key="12992:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12993"><span data-slate-leaf="true" data-offset-key="12993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicPartition</span></span></span></span><span data-slate-object="text" data-key="12994"><span data-slate-leaf="true" data-offset-key="12994:0" data-first-offset="true"><span data-slate-string="true">(Topic.GROUP_METADATA_TOPIC_NAME, partitionFor(group.groupId))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12995"><span data-slate-object="text" data-key="12996"><span data-slate-leaf="true" data-offset-key="12996:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="12997"><span data-slate-leaf="true" data-offset-key="12997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="12998"><span data-slate-leaf="true" data-offset-key="12998:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12999"><span data-slate-leaf="true" data-offset-key="12999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">groupMetadataRecords</span></span></span></span><span data-slate-object="text" data-key="13000"><span data-slate-leaf="true" data-offset-key="13000:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13001"><span data-slate-leaf="true" data-offset-key="13001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13002"><span data-slate-leaf="true" data-offset-key="13002:0" data-first-offset="true"><span data-slate-string="true"> Map(groupMetadataPartition -&gt; records)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13003"><span data-slate-object="text" data-key="13004"><span data-slate-leaf="true" data-offset-key="13004:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13005"><span data-slate-leaf="true" data-offset-key="13005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13006"><span data-slate-leaf="true" data-offset-key="13006:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13007"><span data-slate-leaf="true" data-offset-key="13007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">generationId</span></span></span></span><span data-slate-object="text" data-key="13008"><span data-slate-leaf="true" data-offset-key="13008:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13009"><span data-slate-leaf="true" data-offset-key="13009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13010"><span data-slate-leaf="true" data-offset-key="13010:0" data-first-offset="true"><span data-slate-string="true"> group.generationId</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13011"><span data-slate-object="text" data-key="13012"><span data-slate-leaf="true" data-offset-key="13012:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13013"><span data-slate-leaf="true" data-offset-key="13013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//putCacheCallback 方法，填充 Cache</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13014"><span data-slate-object="text" data-key="13015"><span data-slate-leaf="true" data-offset-key="13015:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13016"><span data-slate-object="text" data-key="13017"><span data-slate-leaf="true" data-offset-key="13017:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13018"><span data-slate-leaf="true" data-offset-key="13018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向位移主题写入消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13019"><span data-slate-object="text" data-key="13020"><span data-slate-leaf="true" data-offset-key="13020:0" data-first-offset="true"><span data-slate-string="true">      appendForGroup(group, groupMetadataRecords, putCacheCallback)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13021"><span data-slate-object="text" data-key="13022"><span data-slate-leaf="true" data-offset-key="13022:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13023"><span data-slate-leaf="true" data-offset-key="13023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前 Broker 不是 Coordinator</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13024"><span data-slate-object="text" data-key="13025"><span data-slate-leaf="true" data-offset-key="13025:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13026"><span data-slate-leaf="true" data-offset-key="13026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13027"><span data-slate-leaf="true" data-offset-key="13027:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13028"><span data-slate-leaf="true" data-offset-key="13028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">None</span></span></span></span><span data-slate-object="text" data-key="13029"><span data-slate-leaf="true" data-offset-key="13029:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13030"><span data-slate-leaf="true" data-offset-key="13030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13031"><span data-slate-leaf="true" data-offset-key="13031:0" data-first-offset="true"><span data-slate-string="true">&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13032"><span data-slate-object="text" data-key="13033"><span data-slate-leaf="true" data-offset-key="13033:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13034"><span data-slate-leaf="true" data-offset-key="13034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回 NOT_COORDINATOR 异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13035"><span data-slate-object="text" data-key="13036"><span data-slate-leaf="true" data-offset-key="13036:0" data-first-offset="true"><span data-slate-string="true">      responseCallback(Errors.NOT_COORDINATOR)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13037"><span data-slate-object="text" data-key="13038"><span data-slate-leaf="true" data-offset-key="13038:0" data-first-offset="true"><span data-slate-string="true">      None</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13039"><span data-slate-object="text" data-key="13040"><span data-slate-leaf="true" data-offset-key="13040:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13041"><span data-slate-object="text" data-key="13042"><span data-slate-leaf="true" data-offset-key="13042:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13043"><span data-slate-object="text" data-key="13044"><span data-slate-leaf="true" data-offset-key="13044:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解，我画一张图来展示一下 storeGroup 方法的逻辑。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13045"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/a6/47/a6248981bc588722c09e38d6f1294447.jpg?wh=1632*2632"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13046"><span data-slate-object="text" data-key="13047"><span data-slate-leaf="true" data-offset-key="13047:0" data-first-offset="true"><span data-slate-string="true">storeGroup 方法的第 1 步是调用 getMagic 方法，来判断当前 Broker 是否是该消费者组的 Coordinator 组件。判断的依据，是尝试去获取位移主题目标分区的底层日志对象。如果能够获取到，就说明当前 Broker 是 Coordinator，程序进入到下一步；反之，则表明当前 Broker 不是 Coordinator，就构造一个 NOT_COORDINATOR 异常返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13048"><span data-slate-object="text" data-key="13049"><span data-slate-leaf="true" data-offset-key="13049:0" data-first-offset="true"><span data-slate-string="true">第 2 步，调用我们上节课学习的 groupMetadataKey 和 groupMetadataValue 方法，去构造注册消息的 Key 和 Value 字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13050"><span data-slate-object="text" data-key="13051"><span data-slate-leaf="true" data-offset-key="13051:0" data-first-offset="true"><span data-slate-string="true">第 3 步，使用 Key 和 Value 构建待写入消息集合。这里的消息集合类是 MemoryRecords。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13052"><span data-slate-object="text" data-key="13053"><span data-slate-leaf="true" data-offset-key="13053:0" data-first-offset="true"><span data-slate-string="true">当前，建模 Kafka 消息集合的类有两个。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13054"><div data-slate-type="list-line" data-slate-object="block" data-key="13055"><span data-slate-object="text" data-key="13056"><span data-slate-leaf="true" data-offset-key="13056:0" data-first-offset="true"><span data-slate-string="true">MemoryRecords：表示内存中的消息集合；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13057"><span data-slate-object="text" data-key="13058"><span data-slate-leaf="true" data-offset-key="13058:0" data-first-offset="true"><span data-slate-string="true">FileRecords：表示磁盘文件中的消息集合。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13059"><span data-slate-object="text" data-key="13060"><span data-slate-leaf="true" data-offset-key="13060:0" data-first-offset="true"><span data-slate-string="true">这两个类的源码不是我们学习的重点，你只需要知道它们的含义就行了。不过，我推荐你课下阅读一下它们的源码，它们在 clients 工程中，这可以进一步帮助你理解 Kafka 如何在内存和磁盘上保存消息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13061"><span data-slate-object="text" data-key="13062"><span data-slate-leaf="true" data-offset-key="13062:0" data-first-offset="true"><span data-slate-string="true">第 4 步，调用 partitionFor 方法，计算要写入的位移主题目标分区。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13063"><span data-slate-object="text" data-key="13064"><span data-slate-leaf="true" data-offset-key="13064:0" data-first-offset="true"><span data-slate-string="true">第 5 步，调用 appendForGroup 方法，将待写入消息插入到位移主题的目标分区下。至此，方法返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13065"><span data-slate-object="text" data-key="13066"><span data-slate-leaf="true" data-offset-key="13066:0" data-first-offset="true"><span data-slate-string="true">需要提一下的是，在上面的代码中，我省略了 putCacheCallback 方法的源码，我们在第 29 讲已经详细地学习过它了。它的作用就是当消息被写入到位移主题后，填充 Cache。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13067"><span data-slate-object="text" data-key="13068"><span data-slate-leaf="true" data-offset-key="13068:0" data-first-offset="true"><span data-slate-string="true">可以看到，写入位移主题和写入其它的普通主题并无差别。Coordinator 会构造符合规定格式的消息数据，并把它们传给 storeOffsets 和 storeGroup 方法，由它们执行写入操作。因此，我们可以认为，Coordinator 相当于位移主题的消息生产者。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13069" id="sr-toc-2"><span data-slate-object="text" data-key="13070"><span data-slate-leaf="true" data-offset-key="13070:0" data-first-offset="true"><span data-slate-string="true">读取位移主题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13071"><span data-slate-object="text" data-key="13072"><span data-slate-leaf="true" data-offset-key="13072:0" data-first-offset="true"><span data-slate-string="true">其实，除了生产者这个角色以外，Coordinator 还扮演了消费者的角色，也就是读取位移主题。跟写入相比，读取操作的逻辑更加复杂一些，不光体现在代码长度上，更体现在消息读取之后的处理上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13073"><span data-slate-object="text" data-key="13074"><span data-slate-leaf="true" data-offset-key="13074:0" data-first-offset="true"><span data-slate-string="true">首先，我们要知道，什么时候需要读取位移主题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13075"><span data-slate-object="text" data-key="13076"><span data-slate-leaf="true" data-offset-key="13076:0" data-first-offset="true"><span data-slate-string="true">你可能会觉得，当消费者组查询位移时，会读取该主题下的数据。其实不然。查询位移时，Coordinator 只会从 GroupMetadata 元数据缓存中查找对应的位移值，而不会读取位移主题。真正需要读取位移主题的时机，</span></span></span><span data-slate-object="text" data-key="13077"><span data-slate-leaf="true" data-offset-key="13077:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a6e45fcd" data-attr-id="32781" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">是在当前 Broker 当选 Coordinator</span></span></span></span></span><span data-slate-object="text" data-key="13078"><span data-slate-leaf="true" data-offset-key="13078:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a6e45fcd" data-attr-id="32781" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，</span></span></span><span data-slate-leaf="true" data-offset-key="13078:1"><span data-slate-string="true">也就是 Broker 成为了位移主题某分区的 Leader 副本时。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13079"><span data-slate-object="text" data-key="13080"><span data-slate-leaf="true" data-offset-key="13080:0" data-first-offset="true"><span data-slate-string="true">一旦当前 Broker 当选为位移主题某分区的 Leader 副本，它就需要将它内存中的元数据缓存填充起来，因此需要读取位移主题。在代码中，这是由 </span></span></span><span data-slate-object="text" data-key="13081"><span data-slate-leaf="true" data-offset-key="13081:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">scheduleLoadGroupAndOffsets</span></span></span></span><span data-slate-object="text" data-key="13082"><span data-slate-leaf="true" data-offset-key="13082:0" data-first-offset="true"><span data-slate-string="true"> 方法完成的。该方法会创建一个异步任务，来读取位移主题消息，并填充缓存。这个异步任务要执行的逻辑，就是 loadGroupsAndOffsets 方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13083"><span data-slate-object="text" data-key="13084"><span data-slate-leaf="true" data-offset-key="13084:0" data-first-offset="true"><span data-slate-string="true">如果你翻开 loadGroupsAndOffsets 方法的源码，就可以看到，它本质上是调用 doLoadGroupsAndOffsets 方法实现的位移主题读取。下面，我们就重点学习下这个方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13085"><span data-slate-object="text" data-key="13086"><span data-slate-leaf="true" data-offset-key="13086:0" data-first-offset="true"><span data-slate-string="true">这个方法的代码很长，为了让你能够更加清晰地理解它，我先带你了解下它的方法签名，然后再给你介绍具体的实现逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13087"><span data-slate-object="text" data-key="13088"><span data-slate-leaf="true" data-offset-key="13088:0" data-first-offset="true"><span data-slate-string="true">首先，我们来看它的方法签名以及内置的一个子方法 logEndOffset。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13089"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13090"><span data-slate-object="text" data-key="13091"><span data-slate-leaf="true" data-offset-key="13091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="13092"><span data-slate-leaf="true" data-offset-key="13092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="13093"><span data-slate-leaf="true" data-offset-key="13093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">doLoadGroupsAndOffsets</span></span></span></span></span><span data-slate-object="text" data-key="13094"><span data-slate-leaf="true" data-offset-key="13094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topicPartition: TopicPartition, onGroupLoaded: GroupMetadata =&gt; Unit)</span></span></span></span></span><span data-slate-object="text" data-key="13095"><span data-slate-leaf="true" data-offset-key="13095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="13096"><span data-slate-leaf="true" data-offset-key="13096:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13097"><span data-slate-object="text" data-key="13098"><span data-slate-leaf="true" data-offset-key="13098:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13099"><span data-slate-leaf="true" data-offset-key="13099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取位移主题指定分区的 LEO 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13100"><span data-slate-object="text" data-key="13101"><span data-slate-leaf="true" data-offset-key="13101:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13102"><span data-slate-leaf="true" data-offset-key="13102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前 Broker 不是该分区的 Leader 副本，则返回 - 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13103"><span data-slate-object="text" data-key="13104"><span data-slate-leaf="true" data-offset-key="13104:0" data-first-offset="true"><span data-slate-string="true">  def logEndOffset: Long = replicaManager.</span></span></span><span data-slate-object="text" data-key="13105"><span data-slate-leaf="true" data-offset-key="13105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getLogEndOffset</span></span></span></span><span data-slate-object="text" data-key="13106"><span data-slate-leaf="true" data-offset-key="13106:0" data-first-offset="true"><span data-slate-string="true">(topicPartition).</span></span></span><span data-slate-object="text" data-key="13107"><span data-slate-leaf="true" data-offset-key="13107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getOrElse</span></span></span></span><span data-slate-object="text" data-key="13108"><span data-slate-leaf="true" data-offset-key="13108:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13109"><span data-slate-leaf="true" data-offset-key="13109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1L</span></span></span></span><span data-slate-object="text" data-key="13110"><span data-slate-leaf="true" data-offset-key="13110:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13111"><span data-slate-object="text" data-key="13112"><span data-slate-leaf="true" data-offset-key="13112:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13113"><span data-slate-object="text" data-key="13114"><span data-slate-leaf="true" data-offset-key="13114:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13115"><span data-slate-object="text" data-key="13116"><span data-slate-leaf="true" data-offset-key="13116:0" data-first-offset="true"><span data-slate-string="true">doLoadGroupsAndOffsets 方法，顾名思义，它要做两件事请：加载消费者组；加载消费者组的位移。再强调一遍，所谓的加载，就是指读取位移主题下的消息，并将这些信息填充到缓存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13117"><span data-slate-object="text" data-key="13118"><span data-slate-leaf="true" data-offset-key="13118:0" data-first-offset="true"><span data-slate-string="true">该方法接收两个参数，第一个参数 topicPartition 是位移主题目标分区；第二个参数 onGroupLoaded 是加载完成后要执行的逻辑，这个逻辑是在上层组件中指定的，我们不需要掌握它的实现，这不会影响我们学习位移主题的读取。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13119"><span data-slate-object="text" data-key="13120"><span data-slate-leaf="true" data-offset-key="13120:0" data-first-offset="true"><span data-slate-string="true">doLoadGroupsAndOffsets 还定义了一个内置子方法 logEndOffset。它的目的很简单，就是</span></span></span><span data-slate-object="text" data-key="13121"><span data-slate-leaf="true" data-offset-key="13121:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">获取位移主题指定分区的 LEO 值，如果当前 Broker 不是该分区的 Leader 副本，就返回 -1</span></span></span></span><span data-slate-object="text" data-key="13122"><span data-slate-leaf="true" data-offset-key="13122:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13123"><span data-slate-object="text" data-key="13124"><span data-slate-leaf="true" data-offset-key="13124:0" data-first-offset="true"><span data-slate-string="true">这是一个特别重要的事实，因为 Kafka 依靠它来判断分区的 Leader 副本是否发生变更。一旦发生变更，那么，在当前 Broker 执行 logEndOffset 方法的返回值，就是 -1，此时，Broker 就不再是 Leader 副本了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13125"><span data-slate-object="text" data-key="13126"><span data-slate-leaf="true" data-offset-key="13126:0" data-first-offset="true"><span data-slate-string="true">doLoadGroupsAndOffsets 方法会</span></span></span><span data-slate-object="text" data-key="13127"><span data-slate-leaf="true" data-offset-key="13127:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">读取位移主题目标分区的日志对象</span></span></span></span><span data-slate-object="text" data-key="13128"><span data-slate-leaf="true" data-offset-key="13128:0" data-first-offset="true"><span data-slate-string="true">，并执行核心的逻辑动作，代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="13129"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13130"><span data-slate-object="text" data-key="13131"><span data-slate-leaf="true" data-offset-key="13131:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13132"><span data-slate-object="text" data-key="13133"><span data-slate-leaf="true" data-offset-key="13133:0" data-first-offset="true"><span data-slate-string="true">replicaManager.getLog(topicPartition) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13134"><span data-slate-object="text" data-key="13135"><span data-slate-leaf="true" data-offset-key="13135:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13136"><span data-slate-leaf="true" data-offset-key="13136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果无法获取到日志对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13137"><span data-slate-object="text" data-key="13138"><span data-slate-leaf="true" data-offset-key="13138:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13139"><span data-slate-leaf="true" data-offset-key="13139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13140"><span data-slate-leaf="true" data-offset-key="13140:0" data-first-offset="true"><span data-slate-string="true"> None =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13141"><span data-slate-object="text" data-key="13142"><span data-slate-leaf="true" data-offset-key="13142:0" data-first-offset="true"><span data-slate-string="true">    warn(s</span></span></span><span data-slate-object="text" data-key="13143"><span data-slate-leaf="true" data-offset-key="13143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempted to load offsets and group metadata from </span></span></span></span><span data-slate-object="text" data-key="13144"><span data-slate-leaf="true" data-offset-key="13144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topicPartition</span></span></span></span></span><span data-slate-object="text" data-key="13145"><span data-slate-leaf="true" data-offset-key="13145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, but found no log"</span></span></span></span><span data-slate-object="text" data-key="13146"><span data-slate-leaf="true" data-offset-key="13146:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13147"><span data-slate-object="text" data-key="13148"><span data-slate-leaf="true" data-offset-key="13148:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13149"><span data-slate-leaf="true" data-offset-key="13149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13150"><span data-slate-leaf="true" data-offset-key="13150:0" data-first-offset="true"><span data-slate-string="true"> Some(log) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13151"><span data-slate-object="text" data-key="13152"><span data-slate-leaf="true" data-offset-key="13152:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="13153"><span data-slate-leaf="true" data-offset-key="13153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 核心逻辑......</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13154"><span data-slate-object="text" data-key="13155"><span data-slate-leaf="true" data-offset-key="13155:0" data-first-offset="true"><span data-slate-string="true">我把核心的逻辑分成 3 个部分来介绍。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13156"><div data-slate-type="list-line" data-slate-object="block" data-key="13157"><span data-slate-object="text" data-key="13158"><span data-slate-leaf="true" data-offset-key="13158:0" data-first-offset="true"><span data-slate-string="true">第 1 部分：初始化 4 个列表 + 读取位移主题；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13159"><span data-slate-object="text" data-key="13160"><span data-slate-leaf="true" data-offset-key="13160:0" data-first-offset="true"><span data-slate-string="true">第 2 部分：处理读到的数据，并填充 4 个列表；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13161"><span data-slate-object="text" data-key="13162"><span data-slate-leaf="true" data-offset-key="13162:0" data-first-offset="true"><span data-slate-string="true">第 3 部分：分别处理这 4 个列表。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13163"><span data-slate-object="text" data-key="13164"><span data-slate-leaf="true" data-offset-key="13164:0" data-first-offset="true"><span data-slate-string="true">在具体讲解这个方法所做的事情之前，我先画一张流程图，从宏观层面展示一下这个流程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13165"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/d0/fb/d03d553361f14695917f6b62528008fb.jpg?wh=1404*3932"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13166" id="sr-toc-3"><span data-slate-object="text" data-key="13167"><span data-slate-leaf="true" data-offset-key="13167:0" data-first-offset="true"><span data-slate-string="true">第 1 部分</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13168"><span data-slate-object="text" data-key="13169"><span data-slate-leaf="true" data-offset-key="13169:0" data-first-offset="true"><span data-slate-string="true">首先，我们来学习一下第一部分的代码，完成了对位移主题的读取操作。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="13170"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13171"><span data-slate-object="text" data-key="13172"><span data-slate-leaf="true" data-offset-key="13172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 已完成位移值加载的分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13173"><span data-slate-object="text" data-key="13174"><span data-slate-leaf="true" data-offset-key="13174:0" data-first-offset="true"><span data-slate-string="true">val loadedOffsets = mutable.</span></span></span><span data-slate-object="text" data-key="13175"><span data-slate-leaf="true" data-offset-key="13175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13176"><span data-slate-leaf="true" data-offset-key="13176:0" data-first-offset="true"><span data-slate-string="true">[GroupTopicPartition, CommitRecordMetadataAndOffset]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13177"><span data-slate-object="text" data-key="13178"><span data-slate-leaf="true" data-offset-key="13178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处于位移加载中的分区列表，只用于 Kafka 事务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13179"><span data-slate-object="text" data-key="13180"><span data-slate-leaf="true" data-offset-key="13180:0" data-first-offset="true"><span data-slate-string="true">val pendingOffsets = mutable.</span></span></span><span data-slate-object="text" data-key="13181"><span data-slate-leaf="true" data-offset-key="13181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13182"><span data-slate-leaf="true" data-offset-key="13182:0" data-first-offset="true"><span data-slate-string="true">[Long, mutable.</span></span></span><span data-slate-object="text" data-key="13183"><span data-slate-leaf="true" data-offset-key="13183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13184"><span data-slate-leaf="true" data-offset-key="13184:0" data-first-offset="true"><span data-slate-string="true">[GroupTopicPartition, CommitRecordMetadataAndOffset]]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13185"><span data-slate-object="text" data-key="13186"><span data-slate-leaf="true" data-offset-key="13186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 已完成组信息加载的消费者组列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13187"><span data-slate-object="text" data-key="13188"><span data-slate-leaf="true" data-offset-key="13188:0" data-first-offset="true"><span data-slate-string="true">val loadedGroups = mutable.</span></span></span><span data-slate-object="text" data-key="13189"><span data-slate-leaf="true" data-offset-key="13189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13190"><span data-slate-leaf="true" data-offset-key="13190:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13191"><span data-slate-leaf="true" data-offset-key="13191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13192"><span data-slate-leaf="true" data-offset-key="13192:0" data-first-offset="true"><span data-slate-string="true">, GroupMetadata]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13193"><span data-slate-object="text" data-key="13194"><span data-slate-leaf="true" data-offset-key="13194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 待移除的消费者组列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13195"><span data-slate-object="text" data-key="13196"><span data-slate-leaf="true" data-offset-key="13196:0" data-first-offset="true"><span data-slate-string="true">val removedGroups = mutable.</span></span></span><span data-slate-object="text" data-key="13197"><span data-slate-leaf="true" data-offset-key="13197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="13198"><span data-slate-leaf="true" data-offset-key="13198:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13199"><span data-slate-leaf="true" data-offset-key="13199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13200"><span data-slate-leaf="true" data-offset-key="13200:0" data-first-offset="true"><span data-slate-string="true">]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13201"><span data-slate-object="text" data-key="13202"><span data-slate-leaf="true" data-offset-key="13202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存消息集合的 ByteBuffer 缓冲区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13203"><span data-slate-object="text" data-key="13204"><span data-slate-leaf="true" data-offset-key="13204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="13205"><span data-slate-leaf="true" data-offset-key="13205:0" data-first-offset="true"><span data-slate-string="true"> buffer = ByteBuffer.allocate(</span></span></span><span data-slate-object="text" data-key="13206"><span data-slate-leaf="true" data-offset-key="13206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13207"><span data-slate-leaf="true" data-offset-key="13207:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13208"><span data-slate-object="text" data-key="13209"><span data-slate-leaf="true" data-offset-key="13209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 位移主题目标分区日志起始位移值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13210"><span data-slate-object="text" data-key="13211"><span data-slate-leaf="true" data-offset-key="13211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="13212"><span data-slate-leaf="true" data-offset-key="13212:0" data-first-offset="true"><span data-slate-string="true"> currOffset = log.logStartOffset</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13213"><span data-slate-object="text" data-key="13214"><span data-slate-leaf="true" data-offset-key="13214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 至少要求读取一条消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13215"><span data-slate-object="text" data-key="13216"><span data-slate-leaf="true" data-offset-key="13216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="13217"><span data-slate-leaf="true" data-offset-key="13217:0" data-first-offset="true"><span data-slate-string="true"> readAtLeastOneRecord = </span></span></span><span data-slate-object="text" data-key="13218"><span data-slate-leaf="true" data-offset-key="13218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13219"><span data-slate-object="text" data-key="13220"><span data-slate-leaf="true" data-offset-key="13220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当前读取位移 &lt; LEO，且至少要求读取一条消息，且 GroupMetadataManager 未关闭</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13221"><span data-slate-object="text" data-key="13222"><span data-slate-leaf="true" data-offset-key="13222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="13223"><span data-slate-leaf="true" data-offset-key="13223:0" data-first-offset="true"><span data-slate-string="true"> (currOffset &lt; logEndOffset &amp;&amp; readAtLeastOneRecord &amp;&amp; !shuttingDown.</span></span></span><span data-slate-object="text" data-key="13224"><span data-slate-leaf="true" data-offset-key="13224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="13225"><span data-slate-leaf="true" data-offset-key="13225:0" data-first-offset="true"><span data-slate-string="true">()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13226"><span data-slate-object="text" data-key="13227"><span data-slate-leaf="true" data-offset-key="13227:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13228"><span data-slate-leaf="true" data-offset-key="13228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读取位移主题指定分区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13229"><span data-slate-object="text" data-key="13230"><span data-slate-leaf="true" data-offset-key="13230:0" data-first-offset="true"><span data-slate-string="true">  val fetchDataInfo = log.read(currOffset,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13231"><span data-slate-object="text" data-key="13232"><span data-slate-leaf="true" data-offset-key="13232:0" data-first-offset="true"><span data-slate-string="true">    maxLength = config.loadBufferSize,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13233"><span data-slate-object="text" data-key="13234"><span data-slate-leaf="true" data-offset-key="13234:0" data-first-offset="true"><span data-slate-string="true">    isolation = FetchLogEnd,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13235"><span data-slate-object="text" data-key="13236"><span data-slate-leaf="true" data-offset-key="13236:0" data-first-offset="true"><span data-slate-string="true">    minOneMessage = </span></span></span><span data-slate-object="text" data-key="13237"><span data-slate-leaf="true" data-offset-key="13237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="13238"><span data-slate-leaf="true" data-offset-key="13238:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13239"><span data-slate-object="text" data-key="13240"><span data-slate-leaf="true" data-offset-key="13240:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13241"><span data-slate-leaf="true" data-offset-key="13241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果无消息可读，则不再要求至少读取一条消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13242"><span data-slate-object="text" data-key="13243"><span data-slate-leaf="true" data-offset-key="13243:0" data-first-offset="true"><span data-slate-string="true">  readAtLeastOneRecord = fetchDataInfo.records.sizeInBytes &gt; </span></span></span><span data-slate-object="text" data-key="13244"><span data-slate-leaf="true" data-offset-key="13244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13245"><span data-slate-object="text" data-key="13246"><span data-slate-leaf="true" data-offset-key="13246:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13247"><span data-slate-leaf="true" data-offset-key="13247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建消息集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13248"><span data-slate-object="text" data-key="13249"><span data-slate-leaf="true" data-offset-key="13249:0" data-first-offset="true"><span data-slate-string="true">  val memRecords = fetchDataInfo.records match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13250"><span data-slate-object="text" data-key="13251"><span data-slate-leaf="true" data-offset-key="13251:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13252"><span data-slate-leaf="true" data-offset-key="13252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13253"><span data-slate-leaf="true" data-offset-key="13253:0" data-first-offset="true"><span data-slate-string="true"> records: MemoryRecords =&gt; records</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13254"><span data-slate-object="text" data-key="13255"><span data-slate-leaf="true" data-offset-key="13255:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13256"><span data-slate-leaf="true" data-offset-key="13256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13257"><span data-slate-leaf="true" data-offset-key="13257:0" data-first-offset="true"><span data-slate-string="true"> fileRecords: FileRecords =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13258"><span data-slate-object="text" data-key="13259"><span data-slate-leaf="true" data-offset-key="13259:0" data-first-offset="true"><span data-slate-string="true">      val sizeInBytes = fileRecords.sizeInBytes</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13260"><span data-slate-object="text" data-key="13261"><span data-slate-leaf="true" data-offset-key="13261:0" data-first-offset="true"><span data-slate-string="true">      val bytesNeeded = Math.max(config.loadBufferSize, sizeInBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13262"><span data-slate-object="text" data-key="13263"><span data-slate-leaf="true" data-offset-key="13263:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13264"><span data-slate-leaf="true" data-offset-key="13264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13265"><span data-slate-leaf="true" data-offset-key="13265:0" data-first-offset="true"><span data-slate-string="true"> (buffer.capacity &lt; bytesNeeded) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13266"><span data-slate-object="text" data-key="13267"><span data-slate-leaf="true" data-offset-key="13267:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13268"><span data-slate-leaf="true" data-offset-key="13268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13269"><span data-slate-leaf="true" data-offset-key="13269:0" data-first-offset="true"><span data-slate-string="true"> (config.loadBufferSize &lt; bytesNeeded)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13270"><span data-slate-object="text" data-key="13271"><span data-slate-leaf="true" data-offset-key="13271:0" data-first-offset="true"><span data-slate-string="true">          warn(s</span></span></span><span data-slate-object="text" data-key="13272"><span data-slate-leaf="true" data-offset-key="13272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Loaded offsets and group metadata from </span></span></span></span><span data-slate-object="text" data-key="13273"><span data-slate-leaf="true" data-offset-key="13273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topicPartition</span></span></span></span></span><span data-slate-object="text" data-key="13274"><span data-slate-leaf="true" data-offset-key="13274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with buffer larger (</span></span></span></span><span data-slate-object="text" data-key="13275"><span data-slate-leaf="true" data-offset-key="13275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$bytesNeeded</span></span></span></span></span><span data-slate-object="text" data-key="13276"><span data-slate-leaf="true" data-offset-key="13276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> bytes) than "</span></span></span></span><span data-slate-object="text" data-key="13277"><span data-slate-leaf="true" data-offset-key="13277:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13278"><span data-slate-object="text" data-key="13279"><span data-slate-leaf="true" data-offset-key="13279:0" data-first-offset="true"><span data-slate-string="true">            s</span></span></span><span data-slate-object="text" data-key="13280"><span data-slate-leaf="true" data-offset-key="13280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"configured offsets.load.buffer.size (</span></span></span></span><span data-slate-object="text" data-key="13281"><span data-slate-leaf="true" data-offset-key="13281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${config.loadBufferSize}</span></span></span></span></span><span data-slate-object="text" data-key="13282"><span data-slate-leaf="true" data-offset-key="13282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> bytes)"</span></span></span></span><span data-slate-object="text" data-key="13283"><span data-slate-leaf="true" data-offset-key="13283:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13284"><span data-slate-object="text" data-key="13285"><span data-slate-leaf="true" data-offset-key="13285:0" data-first-offset="true"><span data-slate-string="true">        buffer = ByteBuffer.allocate(bytesNeeded)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13286"><span data-slate-object="text" data-key="13287"><span data-slate-leaf="true" data-offset-key="13287:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="13288"><span data-slate-leaf="true" data-offset-key="13288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="13289"><span data-slate-leaf="true" data-offset-key="13289:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13290"><span data-slate-object="text" data-key="13291"><span data-slate-leaf="true" data-offset-key="13291:0" data-first-offset="true"><span data-slate-string="true">        buffer.clear()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13292"><span data-slate-object="text" data-key="13293"><span data-slate-leaf="true" data-offset-key="13293:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13294"><span data-slate-object="text" data-key="13295"><span data-slate-leaf="true" data-offset-key="13295:0" data-first-offset="true"><span data-slate-string="true">      fileRecords.readInto(buffer, </span></span></span><span data-slate-object="text" data-key="13296"><span data-slate-leaf="true" data-offset-key="13296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="13297"><span data-slate-leaf="true" data-offset-key="13297:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13298"><span data-slate-object="text" data-key="13299"><span data-slate-leaf="true" data-offset-key="13299:0" data-first-offset="true"><span data-slate-string="true">      MemoryRecords.readableRecords(buffer)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13300"><span data-slate-object="text" data-key="13301"><span data-slate-leaf="true" data-offset-key="13301:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13302"><span data-slate-object="text" data-key="13303"><span data-slate-leaf="true" data-offset-key="13303:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13304"><span data-slate-object="text" data-key="13305"><span data-slate-leaf="true" data-offset-key="13305:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13306"><span data-slate-object="text" data-key="13307"><span data-slate-leaf="true" data-offset-key="13307:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先</span></span></span></span><span data-slate-object="text" data-key="13308"><span data-slate-leaf="true" data-offset-key="13308:0" data-first-offset="true"><span data-slate-string="true">，这部分代码创建了 4 个列表。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13309"><div data-slate-type="list-line" data-slate-object="block" data-key="13310"><span data-slate-object="text" data-key="13311"><span data-slate-leaf="true" data-offset-key="13311:0" data-first-offset="true"><span data-slate-string="true">loadedOffsets：已完成位移值加载的分区列表；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13312"><span data-slate-object="text" data-key="13313"><span data-slate-leaf="true" data-offset-key="13313:0" data-first-offset="true"><span data-slate-string="true">pendingOffsets：位移值加载中的分区列表；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13314"><span data-slate-object="text" data-key="13315"><span data-slate-leaf="true" data-offset-key="13315:0" data-first-offset="true"><span data-slate-string="true">loadedGroups：已完成组信息加载的消费者组列表；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13316"><span data-slate-object="text" data-key="13317"><span data-slate-leaf="true" data-offset-key="13317:0" data-first-offset="true"><span data-slate-string="true">removedGroups：待移除的消费者组列表。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13318"><span data-slate-object="text" data-key="13319"><span data-slate-leaf="true" data-offset-key="13319:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">之后</span></span></span></span><span data-slate-object="text" data-key="13320"><span data-slate-leaf="true" data-offset-key="13320:0" data-first-offset="true"><span data-slate-string="true">，代码又创建了一个 ByteBuffer 缓冲区，用于保存消息集合。</span></span></span><span data-slate-object="text" data-key="13321"><span data-slate-leaf="true" data-offset-key="13321:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">接下来</span></span></span></span><span data-slate-object="text" data-key="13322"><span data-slate-leaf="true" data-offset-key="13322:0" data-first-offset="true"><span data-slate-string="true">，计算位移主题目标分区的日志起始位移值，这是要读取的起始位置。</span></span></span><span data-slate-object="text" data-key="13323"><span data-slate-leaf="true" data-offset-key="13323:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">再之后</span></span></span></span><span data-slate-object="text" data-key="13324"><span data-slate-leaf="true" data-offset-key="13324:0" data-first-offset="true"><span data-slate-string="true">，代码定义了一个布尔类型的变量，该变量表示本次至少要读取一条消息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13325"><span data-slate-object="text" data-key="13326"><span data-slate-leaf="true" data-offset-key="13326:0" data-first-offset="true"><span data-slate-string="true">这些初始化工作都做完之后，代码进入到 while 循环中。循环的条件有 3 个，而且需要同时满足：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13327"><div data-slate-type="list-line" data-slate-object="block" data-key="13328"><span data-slate-object="text" data-key="13329"><span data-slate-leaf="true" data-offset-key="13329:0" data-first-offset="true"><span data-slate-string="true">读取位移值小于日志 LEO 值；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13330"><span data-slate-object="text" data-key="13331"><span data-slate-leaf="true" data-offset-key="13331:0" data-first-offset="true"><span data-slate-string="true">布尔变量值是 True；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13332"><span data-slate-object="text" data-key="13333"><span data-slate-leaf="true" data-offset-key="13333:0" data-first-offset="true"><span data-slate-string="true">GroupMetadataManager 未关闭。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13334"><span data-slate-object="text" data-key="13335"><span data-slate-leaf="true" data-offset-key="13335:0" data-first-offset="true"><span data-slate-string="true">只要满足这 3 个条件，代码就会一直执行 while 循环下的语句逻辑。整个 while 下的逻辑被分成了 3 个步骤，我们现在学习的第 1 部分代码，包含了前两步。最后一步在第 3 部分中实现，即处理上面的这 4 个列表。我们先看前两步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13336"><span data-slate-object="text" data-key="13337"><span data-slate-leaf="true" data-offset-key="13337:0" data-first-offset="true"><span data-slate-string="true">第 1 步是</span></span></span><span data-slate-object="text" data-key="13338"><span data-slate-leaf="true" data-offset-key="13338:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">读取位移主题目标分区的日志对象</span></span></span></span><span data-slate-object="text" data-key="13339"><span data-slate-leaf="true" data-offset-key="13339:0" data-first-offset="true"><span data-slate-string="true">，从日志中取出真实的消息数据。读取日志这个操作，是使用我们在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13340"><span data-slate-object="text" data-key="13341"><span data-slate-leaf="true" data-offset-key="13341:0" data-first-offset="true"><span data-slate-string="true">第 3 讲</span></span></span></a><span data-slate-object="text" data-key="13342"><span data-slate-leaf="true" data-offset-key="13342:0" data-first-offset="true"><span data-slate-string="true">中学过的 Log.read 方法完成的。当读取到完整的日志之后，doLoadGroupsAndOffsets 方法会查看返回的消息集合，如果一条消息都没有返回，则取消 “至少要求读取一条消息” 的限制，即把刚才的布尔变量值设置为 False。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13343"><span data-slate-object="text" data-key="13344"><span data-slate-leaf="true" data-offset-key="13344:0" data-first-offset="true"><span data-slate-string="true">第 2 步是根据上一步获取到的消息数据，创建保存在内存中的消息集合对象，也就是 MemoryRecords 对象。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13345"><span data-slate-object="text" data-key="13346"><span data-slate-leaf="true" data-offset-key="13346:0" data-first-offset="true"><span data-slate-string="true">由于 doLoadGroupsAndOffsets 方法要将读取的消息填充到缓存中，因此，这里必须做出 MemoryRecords 类型的消息集合。这就是第二路 case 分支要将 FileRecords 转换成 MemoryRecords 类型的原因。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13347"><span data-slate-object="text" data-key="13348"><span data-slate-leaf="true" data-offset-key="13348:0" data-first-offset="true"><span data-slate-string="true">至此，第 1 部分逻辑完成。这一部分的产物就是成功地从位移主题目标分区读取到消息，然后转换成 MemoryRecords 对象，等待后续处理。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13349" id="sr-toc-4"><span data-slate-object="text" data-key="13350"><span data-slate-leaf="true" data-offset-key="13350:0" data-first-offset="true"><span data-slate-string="true">第 2 部分</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13351"><span data-slate-object="text" data-key="13352"><span data-slate-leaf="true" data-offset-key="13352:0" data-first-offset="true"><span data-slate-string="true">现在，代码进入到第 2 部分：</span></span></span><span data-slate-object="text" data-key="13353"><span data-slate-leaf="true" data-offset-key="13353:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">处理消息集合</span></span></span></span><span data-slate-object="text" data-key="13354"><span data-slate-leaf="true" data-offset-key="13354:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13355"><span data-slate-object="text" data-key="13356"><span data-slate-leaf="true" data-offset-key="13356:0" data-first-offset="true"><span data-slate-string="true">值得注意的是，这部分代码依然在 while 循环下，我们看下它是如何实现的：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13357"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13358"><span data-slate-object="text" data-key="13359"><span data-slate-leaf="true" data-offset-key="13359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历消息集合的每个消息批次 (RecordBatch)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13360"><span data-slate-object="text" data-key="13361"><span data-slate-leaf="true" data-offset-key="13361:0" data-first-offset="true"><span data-slate-string="true">memRecords.</span></span></span><span data-slate-object="text" data-key="13362"><span data-slate-leaf="true" data-offset-key="13362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">batches</span></span></span></span><span data-slate-object="text" data-key="13363"><span data-slate-leaf="true" data-offset-key="13363:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13364"><span data-slate-leaf="true" data-offset-key="13364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">forEach</span></span></span></span><span data-slate-object="text" data-key="13365"><span data-slate-leaf="true" data-offset-key="13365:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="13366"><span data-slate-leaf="true" data-offset-key="13366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">batch</span></span></span></span></span><span data-slate-object="text" data-key="13367"><span data-slate-leaf="true" data-offset-key="13367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13368"><span data-slate-object="text" data-key="13369"><span data-slate-leaf="true" data-offset-key="13369:0" data-first-offset="true"><span data-slate-string="true">  val isTxnOffsetCommit = batch.</span></span></span><span data-slate-object="text" data-key="13370"><span data-slate-leaf="true" data-offset-key="13370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">isTransactional</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13371"><span data-slate-object="text" data-key="13372"><span data-slate-leaf="true" data-offset-key="13372:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13373"><span data-slate-leaf="true" data-offset-key="13373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是控制类消息批次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13374"><span data-slate-object="text" data-key="13375"><span data-slate-leaf="true" data-offset-key="13375:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13376"><span data-slate-leaf="true" data-offset-key="13376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 控制类消息批次属于 Kafka 事务范畴，这里不展开讲</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13377"><span data-slate-object="text" data-key="13378"><span data-slate-leaf="true" data-offset-key="13378:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13379"><span data-slate-leaf="true" data-offset-key="13379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13380"><span data-slate-leaf="true" data-offset-key="13380:0" data-first-offset="true"><span data-slate-string="true"> (batch.</span></span></span><span data-slate-object="text" data-key="13381"><span data-slate-leaf="true" data-offset-key="13381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">isControlBatch</span></span></span></span><span data-slate-object="text" data-key="13382"><span data-slate-leaf="true" data-offset-key="13382:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13383"><span data-slate-object="text" data-key="13384"><span data-slate-leaf="true" data-offset-key="13384:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13385"><span data-slate-object="text" data-key="13386"><span data-slate-leaf="true" data-offset-key="13386:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="13387"><span data-slate-leaf="true" data-offset-key="13387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="13388"><span data-slate-leaf="true" data-offset-key="13388:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13389"><span data-slate-object="text" data-key="13390"><span data-slate-leaf="true" data-offset-key="13390:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13391"><span data-slate-leaf="true" data-offset-key="13391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存消息批次第一条消息的位移值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13392"><span data-slate-object="text" data-key="13393"><span data-slate-leaf="true" data-offset-key="13393:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13394"><span data-slate-leaf="true" data-offset-key="13394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="13395"><span data-slate-leaf="true" data-offset-key="13395:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13396"><span data-slate-leaf="true" data-offset-key="13396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">batchBaseOffset</span></span></span></span><span data-slate-object="text" data-key="13397"><span data-slate-leaf="true" data-offset-key="13397:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13398"><span data-slate-leaf="true" data-offset-key="13398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Option</span></span></span></span><span data-slate-object="text" data-key="13399"><span data-slate-leaf="true" data-offset-key="13399:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13400"><span data-slate-leaf="true" data-offset-key="13400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Long</span></span></span></span><span data-slate-object="text" data-key="13401"><span data-slate-leaf="true" data-offset-key="13401:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="13402"><span data-slate-leaf="true" data-offset-key="13402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">None</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13403"><span data-slate-object="text" data-key="13404"><span data-slate-leaf="true" data-offset-key="13404:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13405"><span data-slate-leaf="true" data-offset-key="13405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历消息批次下的所有消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13406"><span data-slate-object="text" data-key="13407"><span data-slate-leaf="true" data-offset-key="13407:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13408"><span data-slate-leaf="true" data-offset-key="13408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="13409"><span data-slate-leaf="true" data-offset-key="13409:0" data-first-offset="true"><span data-slate-string="true"> (record &lt;- batch.</span></span></span><span data-slate-object="text" data-key="13410"><span data-slate-leaf="true" data-offset-key="13410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asScala</span></span></span></span><span data-slate-object="text" data-key="13411"><span data-slate-leaf="true" data-offset-key="13411:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13412"><span data-slate-object="text" data-key="13413"><span data-slate-leaf="true" data-offset-key="13413:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13414"><span data-slate-leaf="true" data-offset-key="13414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确保消息必须有 Key，否则抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13415"><span data-slate-object="text" data-key="13416"><span data-slate-leaf="true" data-offset-key="13416:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13417"><span data-slate-leaf="true" data-offset-key="13417:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">require</span></span></span></span><span data-slate-object="text" data-key="13418"><span data-slate-leaf="true" data-offset-key="13418:0" data-first-offset="true"><span data-slate-string="true">(record.</span></span></span><span data-slate-object="text" data-key="13419"><span data-slate-leaf="true" data-offset-key="13419:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hasKey</span></span></span></span><span data-slate-object="text" data-key="13420"><span data-slate-leaf="true" data-offset-key="13420:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13421"><span data-slate-leaf="true" data-offset-key="13421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Group metadata/offset entry key should not be null"</span></span></span></span><span data-slate-object="text" data-key="13422"><span data-slate-leaf="true" data-offset-key="13422:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13423"><span data-slate-object="text" data-key="13424"><span data-slate-leaf="true" data-offset-key="13424:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13425"><span data-slate-leaf="true" data-offset-key="13425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 记录消息批次第一条消息的位移值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13426"><span data-slate-object="text" data-key="13427"><span data-slate-leaf="true" data-offset-key="13427:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13428"><span data-slate-leaf="true" data-offset-key="13428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13429"><span data-slate-leaf="true" data-offset-key="13429:0" data-first-offset="true"><span data-slate-string="true"> (batchBaseOffset.</span></span></span><span data-slate-object="text" data-key="13430"><span data-slate-leaf="true" data-offset-key="13430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">isEmpty</span></span></span></span><span data-slate-object="text" data-key="13431"><span data-slate-leaf="true" data-offset-key="13431:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13432"><span data-slate-object="text" data-key="13433"><span data-slate-leaf="true" data-offset-key="13433:0" data-first-offset="true"><span data-slate-string="true">        batchBaseOffset = </span></span></span><span data-slate-object="text" data-key="13434"><span data-slate-leaf="true" data-offset-key="13434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Some</span></span></span></span><span data-slate-object="text" data-key="13435"><span data-slate-leaf="true" data-offset-key="13435:0" data-first-offset="true"><span data-slate-string="true">(record.</span></span></span><span data-slate-object="text" data-key="13436"><span data-slate-leaf="true" data-offset-key="13436:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">offset</span></span></span></span><span data-slate-object="text" data-key="13437"><span data-slate-leaf="true" data-offset-key="13437:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13438"><span data-slate-object="text" data-key="13439"><span data-slate-leaf="true" data-offset-key="13439:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13440"><span data-slate-leaf="true" data-offset-key="13440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读取消息 Key</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13441"><span data-slate-object="text" data-key="13442"><span data-slate-leaf="true" data-offset-key="13442:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13443"><span data-slate-leaf="true" data-offset-key="13443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">GroupMetadataManager</span></span></span></span><span data-slate-object="text" data-key="13444"><span data-slate-leaf="true" data-offset-key="13444:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13445"><span data-slate-leaf="true" data-offset-key="13445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readMessageKey</span></span></span></span><span data-slate-object="text" data-key="13446"><span data-slate-leaf="true" data-offset-key="13446:0" data-first-offset="true"><span data-slate-string="true">(record.</span></span></span><span data-slate-object="text" data-key="13447"><span data-slate-leaf="true" data-offset-key="13447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">key</span></span></span></span><span data-slate-object="text" data-key="13448"><span data-slate-leaf="true" data-offset-key="13448:0" data-first-offset="true"><span data-slate-string="true">) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13449"><span data-slate-object="text" data-key="13450"><span data-slate-leaf="true" data-offset-key="13450:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13451"><span data-slate-leaf="true" data-offset-key="13451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 OffsetKey，说明是提交位移消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13452"><span data-slate-object="text" data-key="13453"><span data-slate-leaf="true" data-offset-key="13453:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13454"><span data-slate-leaf="true" data-offset-key="13454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13455"><span data-slate-leaf="true" data-offset-key="13455:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13456"><span data-slate-leaf="true" data-offset-key="13456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">offsetKey</span></span></span></span><span data-slate-object="text" data-key="13457"><span data-slate-leaf="true" data-offset-key="13457:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13458"><span data-slate-leaf="true" data-offset-key="13458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OffsetKey</span></span></span></span></span><span data-slate-object="text" data-key="13459"><span data-slate-leaf="true" data-offset-key="13459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13460"><span data-slate-object="text" data-key="13461"><span data-slate-leaf="true" data-offset-key="13461:0" data-first-offset="true"><span data-slate-string="true">          ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13462"><span data-slate-object="text" data-key="13463"><span data-slate-leaf="true" data-offset-key="13463:0" data-first-offset="true"><span data-slate-string="true">          val groupTopicPartition = offsetKey.</span></span></span><span data-slate-object="text" data-key="13464"><span data-slate-leaf="true" data-offset-key="13464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">key</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13465"><span data-slate-object="text" data-key="13466"><span data-slate-leaf="true" data-offset-key="13466:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13467"><span data-slate-leaf="true" data-offset-key="13467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该消息没有 Value</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13468"><span data-slate-object="text" data-key="13469"><span data-slate-leaf="true" data-offset-key="13469:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13470"><span data-slate-leaf="true" data-offset-key="13470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13471"><span data-slate-leaf="true" data-offset-key="13471:0" data-first-offset="true"><span data-slate-string="true"> (!record.</span></span></span><span data-slate-object="text" data-key="13472"><span data-slate-leaf="true" data-offset-key="13472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hasValue</span></span></span></span><span data-slate-object="text" data-key="13473"><span data-slate-leaf="true" data-offset-key="13473:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13474"><span data-slate-object="text" data-key="13475"><span data-slate-leaf="true" data-offset-key="13475:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13476"><span data-slate-leaf="true" data-offset-key="13476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13477"><span data-slate-leaf="true" data-offset-key="13477:0" data-first-offset="true"><span data-slate-string="true"> (isTxnOffsetCommit)                </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13478"><span data-slate-object="text" data-key="13479"><span data-slate-leaf="true" data-offset-key="13479:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="13480"><span data-slate-leaf="true" data-offset-key="13480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pendingOffsets</span></span></span></span><span data-slate-object="text" data-key="13481"><span data-slate-leaf="true" data-offset-key="13481:0" data-first-offset="true"><span data-slate-string="true">(batch.</span></span></span><span data-slate-object="text" data-key="13482"><span data-slate-leaf="true" data-offset-key="13482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">producerId</span></span></span></span><span data-slate-object="text" data-key="13483"><span data-slate-leaf="true" data-offset-key="13483:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13484"><span data-slate-object="text" data-key="13485"><span data-slate-leaf="true" data-offset-key="13485:0" data-first-offset="true"><span data-slate-string="true">                .</span></span></span><span data-slate-object="text" data-key="13486"><span data-slate-leaf="true" data-offset-key="13486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="13487"><span data-slate-leaf="true" data-offset-key="13487:0" data-first-offset="true"><span data-slate-string="true">(groupTopicPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13488"><span data-slate-object="text" data-key="13489"><span data-slate-leaf="true" data-offset-key="13489:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13490"><span data-slate-leaf="true" data-offset-key="13490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13491"><span data-slate-object="text" data-key="13492"><span data-slate-leaf="true" data-offset-key="13492:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="13493"><span data-slate-leaf="true" data-offset-key="13493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将目标分区从已完成位移值加载的分区列表中移除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13494"><span data-slate-object="text" data-key="13495"><span data-slate-leaf="true" data-offset-key="13495:0" data-first-offset="true"><span data-slate-string="true">              loadedOffsets.</span></span></span><span data-slate-object="text" data-key="13496"><span data-slate-leaf="true" data-offset-key="13496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="13497"><span data-slate-leaf="true" data-offset-key="13497:0" data-first-offset="true"><span data-slate-string="true">(groupTopicPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13498"><span data-slate-object="text" data-key="13499"><span data-slate-leaf="true" data-offset-key="13499:0" data-first-offset="true"><span data-slate-string="true">          } </span></span></span><span data-slate-object="text" data-key="13500"><span data-slate-leaf="true" data-offset-key="13500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="13501"><span data-slate-leaf="true" data-offset-key="13501:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13502"><span data-slate-object="text" data-key="13503"><span data-slate-leaf="true" data-offset-key="13503:0" data-first-offset="true"><span data-slate-string="true">            val offsetAndMetadata = </span></span></span><span data-slate-object="text" data-key="13504"><span data-slate-leaf="true" data-offset-key="13504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">GroupMetadataManager</span></span></span></span><span data-slate-object="text" data-key="13505"><span data-slate-leaf="true" data-offset-key="13505:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13506"><span data-slate-leaf="true" data-offset-key="13506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readOffsetMessageValue</span></span></span></span><span data-slate-object="text" data-key="13507"><span data-slate-leaf="true" data-offset-key="13507:0" data-first-offset="true"><span data-slate-string="true">(record.</span></span></span><span data-slate-object="text" data-key="13508"><span data-slate-leaf="true" data-offset-key="13508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">value</span></span></span></span><span data-slate-object="text" data-key="13509"><span data-slate-leaf="true" data-offset-key="13509:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13510"><span data-slate-object="text" data-key="13511"><span data-slate-leaf="true" data-offset-key="13511:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13512"><span data-slate-leaf="true" data-offset-key="13512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13513"><span data-slate-leaf="true" data-offset-key="13513:0" data-first-offset="true"><span data-slate-string="true"> (isTxnOffsetCommit)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13514"><span data-slate-object="text" data-key="13515"><span data-slate-leaf="true" data-offset-key="13515:0" data-first-offset="true"><span data-slate-string="true">             </span></span></span><span data-slate-object="text" data-key="13516"><span data-slate-leaf="true" data-offset-key="13516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pendingOffsets</span></span></span></span><span data-slate-object="text" data-key="13517"><span data-slate-leaf="true" data-offset-key="13517:0" data-first-offset="true"><span data-slate-string="true">(batch.</span></span></span><span data-slate-object="text" data-key="13518"><span data-slate-leaf="true" data-offset-key="13518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">producerId</span></span></span></span><span data-slate-object="text" data-key="13519"><span data-slate-leaf="true" data-offset-key="13519:0" data-first-offset="true"><span data-slate-string="true">).</span></span></span><span data-slate-object="text" data-key="13520"><span data-slate-leaf="true" data-offset-key="13520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="13521"><span data-slate-leaf="true" data-offset-key="13521:0" data-first-offset="true"><span data-slate-string="true">(groupTopicPartition, </span></span></span><span data-slate-object="text" data-key="13522"><span data-slate-leaf="true" data-offset-key="13522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CommitRecordMetadataAndOffset</span></span></span></span><span data-slate-object="text" data-key="13523"><span data-slate-leaf="true" data-offset-key="13523:0" data-first-offset="true"><span data-slate-string="true">(batchBaseOffset, offsetAndMetadata))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13524"><span data-slate-object="text" data-key="13525"><span data-slate-leaf="true" data-offset-key="13525:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13526"><span data-slate-leaf="true" data-offset-key="13526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13527"><span data-slate-object="text" data-key="13528"><span data-slate-leaf="true" data-offset-key="13528:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="13529"><span data-slate-leaf="true" data-offset-key="13529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将目标分区加入到已完成位移值加载的分区列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13530"><span data-slate-object="text" data-key="13531"><span data-slate-leaf="true" data-offset-key="13531:0" data-first-offset="true"><span data-slate-string="true">              loadedOffsets.</span></span></span><span data-slate-object="text" data-key="13532"><span data-slate-leaf="true" data-offset-key="13532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="13533"><span data-slate-leaf="true" data-offset-key="13533:0" data-first-offset="true"><span data-slate-string="true">(groupTopicPartition, </span></span></span><span data-slate-object="text" data-key="13534"><span data-slate-leaf="true" data-offset-key="13534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CommitRecordMetadataAndOffset</span></span></span></span><span data-slate-object="text" data-key="13535"><span data-slate-leaf="true" data-offset-key="13535:0" data-first-offset="true"><span data-slate-string="true">(batchBaseOffset, offsetAndMetadata))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13536"><span data-slate-object="text" data-key="13537"><span data-slate-leaf="true" data-offset-key="13537:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13538"><span data-slate-object="text" data-key="13539"><span data-slate-leaf="true" data-offset-key="13539:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13540"><span data-slate-leaf="true" data-offset-key="13540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 GroupMetadataKey，说明是注册消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13541"><span data-slate-object="text" data-key="13542"><span data-slate-leaf="true" data-offset-key="13542:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13543"><span data-slate-leaf="true" data-offset-key="13543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13544"><span data-slate-leaf="true" data-offset-key="13544:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13545"><span data-slate-leaf="true" data-offset-key="13545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">groupMetadataKey</span></span></span></span><span data-slate-object="text" data-key="13546"><span data-slate-leaf="true" data-offset-key="13546:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13547"><span data-slate-leaf="true" data-offset-key="13547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">GroupMetadataKey</span></span></span></span></span><span data-slate-object="text" data-key="13548"><span data-slate-leaf="true" data-offset-key="13548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13549"><span data-slate-object="text" data-key="13550"><span data-slate-leaf="true" data-offset-key="13550:0" data-first-offset="true"><span data-slate-string="true">          val groupId = groupMetadataKey.</span></span></span><span data-slate-object="text" data-key="13551"><span data-slate-leaf="true" data-offset-key="13551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">key</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13552"><span data-slate-object="text" data-key="13553"><span data-slate-leaf="true" data-offset-key="13553:0" data-first-offset="true"><span data-slate-string="true">          val groupMetadata = </span></span></span><span data-slate-object="text" data-key="13554"><span data-slate-leaf="true" data-offset-key="13554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">GroupMetadataManager</span></span></span></span><span data-slate-object="text" data-key="13555"><span data-slate-leaf="true" data-offset-key="13555:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13556"><span data-slate-leaf="true" data-offset-key="13556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readGroupMessageValue</span></span></span></span><span data-slate-object="text" data-key="13557"><span data-slate-leaf="true" data-offset-key="13557:0" data-first-offset="true"><span data-slate-string="true">(groupId, record.</span></span></span><span data-slate-object="text" data-key="13558"><span data-slate-leaf="true" data-offset-key="13558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">value</span></span></span></span><span data-slate-object="text" data-key="13559"><span data-slate-leaf="true" data-offset-key="13559:0" data-first-offset="true"><span data-slate-string="true">, time)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13560"><span data-slate-object="text" data-key="13561"><span data-slate-leaf="true" data-offset-key="13561:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13562"><span data-slate-leaf="true" data-offset-key="13562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果消息 Value 不为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13563"><span data-slate-object="text" data-key="13564"><span data-slate-leaf="true" data-offset-key="13564:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13565"><span data-slate-leaf="true" data-offset-key="13565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13566"><span data-slate-leaf="true" data-offset-key="13566:0" data-first-offset="true"><span data-slate-string="true"> (groupMetadata != </span></span></span><span data-slate-object="text" data-key="13567"><span data-slate-leaf="true" data-offset-key="13567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="13568"><span data-slate-leaf="true" data-offset-key="13568:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13569"><span data-slate-object="text" data-key="13570"><span data-slate-leaf="true" data-offset-key="13570:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13571"><span data-slate-leaf="true" data-offset-key="13571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把该消费者组从待移除消费者组列表中移除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13572"><span data-slate-object="text" data-key="13573"><span data-slate-leaf="true" data-offset-key="13573:0" data-first-offset="true"><span data-slate-string="true">            removedGroups.</span></span></span><span data-slate-object="text" data-key="13574"><span data-slate-leaf="true" data-offset-key="13574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="13575"><span data-slate-leaf="true" data-offset-key="13575:0" data-first-offset="true"><span data-slate-string="true">(groupId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13576"><span data-slate-object="text" data-key="13577"><span data-slate-leaf="true" data-offset-key="13577:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13578"><span data-slate-leaf="true" data-offset-key="13578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将消费者组加入到已完成加载的消费组列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13579"><span data-slate-object="text" data-key="13580"><span data-slate-leaf="true" data-offset-key="13580:0" data-first-offset="true"><span data-slate-string="true">            loadedGroups.</span></span></span><span data-slate-object="text" data-key="13581"><span data-slate-leaf="true" data-offset-key="13581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="13582"><span data-slate-leaf="true" data-offset-key="13582:0" data-first-offset="true"><span data-slate-string="true">(groupId, groupMetadata)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13583"><span data-slate-object="text" data-key="13584"><span data-slate-leaf="true" data-offset-key="13584:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13585"><span data-slate-leaf="true" data-offset-key="13585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果消息 Value 为空，说明是 Tombstone 消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13586"><span data-slate-object="text" data-key="13587"><span data-slate-leaf="true" data-offset-key="13587:0" data-first-offset="true"><span data-slate-string="true">          } </span></span></span><span data-slate-object="text" data-key="13588"><span data-slate-leaf="true" data-offset-key="13588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="13589"><span data-slate-leaf="true" data-offset-key="13589:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13590"><span data-slate-object="text" data-key="13591"><span data-slate-leaf="true" data-offset-key="13591:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13592"><span data-slate-leaf="true" data-offset-key="13592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把该消费者组从已完成加载的组列表中移除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13593"><span data-slate-object="text" data-key="13594"><span data-slate-leaf="true" data-offset-key="13594:0" data-first-offset="true"><span data-slate-string="true">            loadedGroups.</span></span></span><span data-slate-object="text" data-key="13595"><span data-slate-leaf="true" data-offset-key="13595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="13596"><span data-slate-leaf="true" data-offset-key="13596:0" data-first-offset="true"><span data-slate-string="true">(groupId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13597"><span data-slate-object="text" data-key="13598"><span data-slate-leaf="true" data-offset-key="13598:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13599"><span data-slate-leaf="true" data-offset-key="13599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将消费者组加入到待移除消费组列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13600"><span data-slate-object="text" data-key="13601"><span data-slate-leaf="true" data-offset-key="13601:0" data-first-offset="true"><span data-slate-string="true">            removedGroups.</span></span></span><span data-slate-object="text" data-key="13602"><span data-slate-leaf="true" data-offset-key="13602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">add</span></span></span></span><span data-slate-object="text" data-key="13603"><span data-slate-leaf="true" data-offset-key="13603:0" data-first-offset="true"><span data-slate-string="true">(groupId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13604"><span data-slate-object="text" data-key="13605"><span data-slate-leaf="true" data-offset-key="13605:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13606"><span data-slate-object="text" data-key="13607"><span data-slate-leaf="true" data-offset-key="13607:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13608"><span data-slate-leaf="true" data-offset-key="13608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是未知类型的 Key，抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13609"><span data-slate-object="text" data-key="13610"><span data-slate-leaf="true" data-offset-key="13610:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13611"><span data-slate-leaf="true" data-offset-key="13611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13612"><span data-slate-leaf="true" data-offset-key="13612:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13613"><span data-slate-leaf="true" data-offset-key="13613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unknownKey</span></span></span></span></span><span data-slate-object="text" data-key="13614"><span data-slate-leaf="true" data-offset-key="13614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13615"><span data-slate-object="text" data-key="13616"><span data-slate-leaf="true" data-offset-key="13616:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13617"><span data-slate-leaf="true" data-offset-key="13617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="13618"><span data-slate-leaf="true" data-offset-key="13618:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13619"><span data-slate-leaf="true" data-offset-key="13619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13620"><span data-slate-leaf="true" data-offset-key="13620:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13621"><span data-slate-leaf="true" data-offset-key="13621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">IllegalStateException</span></span></span></span><span data-slate-object="text" data-key="13622"><span data-slate-leaf="true" data-offset-key="13622:0" data-first-offset="true"><span data-slate-string="true">(s</span></span></span><span data-slate-object="text" data-key="13623"><span data-slate-leaf="true" data-offset-key="13623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Unexpected message key $unknownKey while loading offsets and group metadata"</span></span></span></span><span data-slate-object="text" data-key="13624"><span data-slate-leaf="true" data-offset-key="13624:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13625"><span data-slate-object="text" data-key="13626"><span data-slate-leaf="true" data-offset-key="13626:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13627"><span data-slate-object="text" data-key="13628"><span data-slate-leaf="true" data-offset-key="13628:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13629"><span data-slate-object="text" data-key="13630"><span data-slate-leaf="true" data-offset-key="13630:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13631"><span data-slate-object="text" data-key="13632"><span data-slate-leaf="true" data-offset-key="13632:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13633"><span data-slate-leaf="true" data-offset-key="13633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新读取位置到消息批次最后一条消息的位移值 + 1，等待下次 while 循环</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13634"><span data-slate-object="text" data-key="13635"><span data-slate-leaf="true" data-offset-key="13635:0" data-first-offset="true"><span data-slate-string="true">  currOffset = batch.</span></span></span><span data-slate-object="text" data-key="13636"><span data-slate-leaf="true" data-offset-key="13636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nextOffset</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13637"><span data-slate-object="text" data-key="13638"><span data-slate-leaf="true" data-offset-key="13638:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13639"><span data-slate-object="text" data-key="13640"><span data-slate-leaf="true" data-offset-key="13640:0" data-first-offset="true"><span data-slate-string="true">这一部分的主要目的，是处理上一步获取到的消息集合，然后把相应数据添加到刚刚说到的 4 个列表中，具体逻辑是代码遍历消息集合的每个消息批次（Record Batch）。我来解释一下这个流程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13641"><span data-slate-object="text" data-key="13642"><span data-slate-leaf="true" data-offset-key="13642:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先</span></span></span></span><span data-slate-object="text" data-key="13643"><span data-slate-leaf="true" data-offset-key="13643:0" data-first-offset="true"><span data-slate-string="true">，判断该批次是否是控制类消息批次，如果是，就执行 Kafka 事务专属的一些逻辑。由于我们不讨论 Kafka 事务，因此，这里我就不详细展开了。如果不是，就进入到下一步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13644"><span data-slate-object="text" data-key="13645"><span data-slate-leaf="true" data-offset-key="13645:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">其次</span></span></span></span><span data-slate-object="text" data-key="13646"><span data-slate-leaf="true" data-offset-key="13646:0" data-first-offset="true"><span data-slate-string="true">，遍历该消息批次下的所有消息，并依次执行下面的步骤。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13647"><span data-slate-object="text" data-key="13648"><span data-slate-leaf="true" data-offset-key="13648:0" data-first-offset="true"><span data-slate-string="true">第 1 步，记录消息批次中第一条消息的位移值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13649"><span data-slate-object="text" data-key="13650"><span data-slate-leaf="true" data-offset-key="13650:0" data-first-offset="true"><span data-slate-string="true">第 2 步，读取消息 Key，并判断 Key 的类型，判断的依据如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13651"><div data-slate-type="list-line" data-slate-object="block" data-key="13652"><span data-slate-object="text" data-key="13653"><span data-slate-leaf="true" data-offset-key="13653:0" data-first-offset="true"><span data-slate-string="true">如果是提交位移消息，就判断消息有无 Value。如果没有，那么，方法将目标分区从已完成位移值加载的分区列表中移除；如果有，则将目标分区加入到已完成位移值加载的分区列表中。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13654"><span data-slate-object="text" data-key="13655"><span data-slate-leaf="true" data-offset-key="13655:0" data-first-offset="true"><span data-slate-string="true">如果是注册消息，依然是判断消息有无 Value。如果存在 Value，就把该消费者组从待移除消费者组列表中移除，并加入到已完成加载的消费组列表；如果不存在 Value，就说明，这是一条 Tombstone 消息，那么，代码把该消费者组从已完成加载的组列表中移除，并加入到待移除消费组列表。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13656"><span data-slate-object="text" data-key="13657"><span data-slate-leaf="true" data-offset-key="13657:0" data-first-offset="true"><span data-slate-string="true">如果是未知类型的 Key，就直接抛出异常。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13658"><span data-slate-object="text" data-key="13659"><span data-slate-leaf="true" data-offset-key="13659:0" data-first-offset="true"><span data-slate-string="true">最后，更新读取位置，等待下次 while 循环，这个位置就是整个消息批次中最后一条消息的位移值 +1。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13660"><span data-slate-object="text" data-key="13661"><span data-slate-leaf="true" data-offset-key="13661:0" data-first-offset="true"><span data-slate-string="true">至此，这部分代码宣告结束，它的主要产物就是被填充了的 4 个列表。那么，第 3 部分，就要开始处理这 4 个列表了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="13662" id="sr-toc-5"><span data-slate-object="text" data-key="13663"><span data-slate-leaf="true" data-offset-key="13663:0" data-first-offset="true"><span data-slate-string="true">第 3 部分</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="13664"><span data-slate-object="text" data-key="13665"><span data-slate-leaf="true" data-offset-key="13665:0" data-first-offset="true"><span data-slate-string="true">最后一部分的完整代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="13666"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13667"><span data-slate-object="text" data-key="13668"><span data-slate-leaf="true" data-offset-key="13668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 loadedOffsets</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13669"><span data-slate-object="text" data-key="13670"><span data-slate-leaf="true" data-offset-key="13670:0" data-first-offset="true"><span data-slate-string="true">val (groupOffsets, emptyGroupOffsets) = loadedOffsets</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13671"><span data-slate-object="text" data-key="13672"><span data-slate-leaf="true" data-offset-key="13672:0" data-first-offset="true"><span data-slate-string="true">  .groupBy(_._1.group)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13673"><span data-slate-object="text" data-key="13674"><span data-slate-leaf="true" data-offset-key="13674:0" data-first-offset="true"><span data-slate-string="true">  .map { </span></span></span><span data-slate-object="text" data-key="13675"><span data-slate-leaf="true" data-offset-key="13675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13676"><span data-slate-leaf="true" data-offset-key="13676:0" data-first-offset="true"><span data-slate-string="true"> (k, v) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13677"><span data-slate-object="text" data-key="13678"><span data-slate-leaf="true" data-offset-key="13678:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13679"><span data-slate-leaf="true" data-offset-key="13679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 提取出 &lt;组名，主题名，分区号&gt; 与位移值对</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13680"><span data-slate-object="text" data-key="13681"><span data-slate-leaf="true" data-offset-key="13681:0" data-first-offset="true"><span data-slate-string="true">    k -&gt; v.map { </span></span></span><span data-slate-object="text" data-key="13682"><span data-slate-leaf="true" data-offset-key="13682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13683"><span data-slate-leaf="true" data-offset-key="13683:0" data-first-offset="true"><span data-slate-string="true"> (groupTopicPartition, offset) =&gt; (groupTopicPartition.topicPartition, offset) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13684"><span data-slate-object="text" data-key="13685"><span data-slate-leaf="true" data-offset-key="13685:0" data-first-offset="true"><span data-slate-string="true">  }.partition { </span></span></span><span data-slate-object="text" data-key="13686"><span data-slate-leaf="true" data-offset-key="13686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13687"><span data-slate-leaf="true" data-offset-key="13687:0" data-first-offset="true"><span data-slate-string="true"> (group, _) =&gt; loadedGroups.contains(group) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13688"><span data-slate-object="text" data-key="13689"><span data-slate-leaf="true" data-offset-key="13689:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13690"><span data-slate-object="text" data-key="13691"><span data-slate-leaf="true" data-offset-key="13691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 loadedGroups</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13692"><span data-slate-object="text" data-key="13693"><span data-slate-leaf="true" data-offset-key="13693:0" data-first-offset="true"><span data-slate-string="true">loadedGroups.values.foreach {group =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13694"><span data-slate-object="text" data-key="13695"><span data-slate-leaf="true" data-offset-key="13695:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13696"><span data-slate-leaf="true" data-offset-key="13696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 提取消费者组的已提交位移</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13697"><span data-slate-object="text" data-key="13698"><span data-slate-leaf="true" data-offset-key="13698:0" data-first-offset="true"><span data-slate-string="true">  val offsets = groupOffsets.getOrElse(group.groupId, </span></span></span><span data-slate-object="text" data-key="13699"><span data-slate-leaf="true" data-offset-key="13699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13700"><span data-slate-leaf="true" data-offset-key="13700:0" data-first-offset="true"><span data-slate-string="true">.empty[TopicPartition, CommitRecordMetadataAndOffset])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13701"><span data-slate-object="text" data-key="13702"><span data-slate-leaf="true" data-offset-key="13702:0" data-first-offset="true"><span data-slate-string="true">  val pendingOffsets = pendingGroupOffsets.getOrElse(group.groupId, </span></span></span><span data-slate-object="text" data-key="13703"><span data-slate-leaf="true" data-offset-key="13703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13704"><span data-slate-leaf="true" data-offset-key="13704:0" data-first-offset="true"><span data-slate-string="true">.empty[Long, mutable.</span></span></span><span data-slate-object="text" data-key="13705"><span data-slate-leaf="true" data-offset-key="13705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13706"><span data-slate-leaf="true" data-offset-key="13706:0" data-first-offset="true"><span data-slate-string="true">[TopicPartition, CommitRecordMetadataAndOffset]])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13707"><span data-slate-object="text" data-key="13708"><span data-slate-leaf="true" data-offset-key="13708:0" data-first-offset="true"><span data-slate-string="true">  debug(s</span></span></span><span data-slate-object="text" data-key="13709"><span data-slate-leaf="true" data-offset-key="13709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Loaded group metadata </span></span></span></span><span data-slate-object="text" data-key="13710"><span data-slate-leaf="true" data-offset-key="13710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$group</span></span></span></span></span><span data-slate-object="text" data-key="13711"><span data-slate-leaf="true" data-offset-key="13711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with offsets </span></span></span></span><span data-slate-object="text" data-key="13712"><span data-slate-leaf="true" data-offset-key="13712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offsets</span></span></span></span></span><span data-slate-object="text" data-key="13713"><span data-slate-leaf="true" data-offset-key="13713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> and pending offsets </span></span></span></span><span data-slate-object="text" data-key="13714"><span data-slate-leaf="true" data-offset-key="13714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$pendingOffsets</span></span></span></span></span><span data-slate-object="text" data-key="13715"><span data-slate-leaf="true" data-offset-key="13715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13716"><span data-slate-leaf="true" data-offset-key="13716:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13717"><span data-slate-object="text" data-key="13718"><span data-slate-leaf="true" data-offset-key="13718:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13719"><span data-slate-leaf="true" data-offset-key="13719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为已完成加载的组执行加载组操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13720"><span data-slate-object="text" data-key="13721"><span data-slate-leaf="true" data-offset-key="13721:0" data-first-offset="true"><span data-slate-string="true">  loadGroup(group, offsets, pendingOffsets)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13722"><span data-slate-object="text" data-key="13723"><span data-slate-leaf="true" data-offset-key="13723:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13724"><span data-slate-leaf="true" data-offset-key="13724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为已完成加载的组执行加载组操作之后的逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13725"><span data-slate-object="text" data-key="13726"><span data-slate-leaf="true" data-offset-key="13726:0" data-first-offset="true"><span data-slate-string="true">  onGroupLoaded(group)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13727"><span data-slate-object="text" data-key="13728"><span data-slate-leaf="true" data-offset-key="13728:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13729"><span data-slate-object="text" data-key="13730"><span data-slate-leaf="true" data-offset-key="13730:0" data-first-offset="true"><span data-slate-string="true">(emptyGroupOffsets.keySet ++ pendingEmptyGroupOffsets.keySet).foreach { groupId =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13731"><span data-slate-object="text" data-key="13732"><span data-slate-leaf="true" data-offset-key="13732:0" data-first-offset="true"><span data-slate-string="true">  val group = </span></span></span><span data-slate-object="text" data-key="13733"><span data-slate-leaf="true" data-offset-key="13733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13734"><span data-slate-leaf="true" data-offset-key="13734:0" data-first-offset="true"><span data-slate-string="true"> GroupMetadata(groupId, Empty, time)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13735"><span data-slate-object="text" data-key="13736"><span data-slate-leaf="true" data-offset-key="13736:0" data-first-offset="true"><span data-slate-string="true">  val offsets = emptyGroupOffsets.getOrElse(groupId, </span></span></span><span data-slate-object="text" data-key="13737"><span data-slate-leaf="true" data-offset-key="13737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13738"><span data-slate-leaf="true" data-offset-key="13738:0" data-first-offset="true"><span data-slate-string="true">.empty[TopicPartition, CommitRecordMetadataAndOffset])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13739"><span data-slate-object="text" data-key="13740"><span data-slate-leaf="true" data-offset-key="13740:0" data-first-offset="true"><span data-slate-string="true">  val pendingOffsets = pendingEmptyGroupOffsets.getOrElse(groupId, </span></span></span><span data-slate-object="text" data-key="13741"><span data-slate-leaf="true" data-offset-key="13741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13742"><span data-slate-leaf="true" data-offset-key="13742:0" data-first-offset="true"><span data-slate-string="true">.empty[Long, mutable.</span></span></span><span data-slate-object="text" data-key="13743"><span data-slate-leaf="true" data-offset-key="13743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="13744"><span data-slate-leaf="true" data-offset-key="13744:0" data-first-offset="true"><span data-slate-string="true">[TopicPartition, CommitRecordMetadataAndOffset]])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13745"><span data-slate-object="text" data-key="13746"><span data-slate-leaf="true" data-offset-key="13746:0" data-first-offset="true"><span data-slate-string="true">  debug(s</span></span></span><span data-slate-object="text" data-key="13747"><span data-slate-leaf="true" data-offset-key="13747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Loaded group metadata </span></span></span></span><span data-slate-object="text" data-key="13748"><span data-slate-leaf="true" data-offset-key="13748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$group</span></span></span></span></span><span data-slate-object="text" data-key="13749"><span data-slate-leaf="true" data-offset-key="13749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with offsets </span></span></span></span><span data-slate-object="text" data-key="13750"><span data-slate-leaf="true" data-offset-key="13750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offsets</span></span></span></span></span><span data-slate-object="text" data-key="13751"><span data-slate-leaf="true" data-offset-key="13751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> and pending offsets </span></span></span></span><span data-slate-object="text" data-key="13752"><span data-slate-leaf="true" data-offset-key="13752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$pendingOffsets</span></span></span></span></span><span data-slate-object="text" data-key="13753"><span data-slate-leaf="true" data-offset-key="13753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13754"><span data-slate-leaf="true" data-offset-key="13754:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13755"><span data-slate-object="text" data-key="13756"><span data-slate-leaf="true" data-offset-key="13756:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13757"><span data-slate-leaf="true" data-offset-key="13757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为空的消费者组执行加载组操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13758"><span data-slate-object="text" data-key="13759"><span data-slate-leaf="true" data-offset-key="13759:0" data-first-offset="true"><span data-slate-string="true">  loadGroup(group, offsets, pendingOffsets)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13760"><span data-slate-object="text" data-key="13761"><span data-slate-leaf="true" data-offset-key="13761:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13762"><span data-slate-leaf="true" data-offset-key="13762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为空的消费者执行加载组操作之后的逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13763"><span data-slate-object="text" data-key="13764"><span data-slate-leaf="true" data-offset-key="13764:0" data-first-offset="true"><span data-slate-string="true">  onGroupLoaded(group)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13765"><span data-slate-object="text" data-key="13766"><span data-slate-leaf="true" data-offset-key="13766:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13767"><span data-slate-object="text" data-key="13768"><span data-slate-leaf="true" data-offset-key="13768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理 removedGroups</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13769"><span data-slate-object="text" data-key="13770"><span data-slate-leaf="true" data-offset-key="13770:0" data-first-offset="true"><span data-slate-string="true">removedGroups.foreach {groupId =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13771"><span data-slate-object="text" data-key="13772"><span data-slate-leaf="true" data-offset-key="13772:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13773"><span data-slate-leaf="true" data-offset-key="13773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13774"><span data-slate-leaf="true" data-offset-key="13774:0" data-first-offset="true"><span data-slate-string="true"> (groupMetadataCache.contains(groupId) &amp;&amp; !emptyGroupOffsets.contains(groupId))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13775"><span data-slate-object="text" data-key="13776"><span data-slate-leaf="true" data-offset-key="13776:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13777"><span data-slate-leaf="true" data-offset-key="13777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="13778"><span data-slate-leaf="true" data-offset-key="13778:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13779"><span data-slate-leaf="true" data-offset-key="13779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13780"><span data-slate-leaf="true" data-offset-key="13780:0" data-first-offset="true"><span data-slate-string="true"> IllegalStateException(s</span></span></span><span data-slate-object="text" data-key="13781"><span data-slate-leaf="true" data-offset-key="13781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Unexpected unload of active group </span></span></span></span><span data-slate-object="text" data-key="13782"><span data-slate-leaf="true" data-offset-key="13782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$groupId</span></span></span></span></span><span data-slate-object="text" data-key="13783"><span data-slate-leaf="true" data-offset-key="13783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> while "</span></span></span></span><span data-slate-object="text" data-key="13784"><span data-slate-leaf="true" data-offset-key="13784:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13785"><span data-slate-object="text" data-key="13786"><span data-slate-leaf="true" data-offset-key="13786:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="13787"><span data-slate-leaf="true" data-offset-key="13787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"loading partition </span></span></span></span><span data-slate-object="text" data-key="13788"><span data-slate-leaf="true" data-offset-key="13788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topicPartition</span></span></span></span></span><span data-slate-object="text" data-key="13789"><span data-slate-leaf="true" data-offset-key="13789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13790"><span data-slate-leaf="true" data-offset-key="13790:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13791"><span data-slate-object="text" data-key="13792"><span data-slate-leaf="true" data-offset-key="13792:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13793"><span data-slate-object="text" data-key="13794"><span data-slate-leaf="true" data-offset-key="13794:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先</span></span></span></span><span data-slate-object="text" data-key="13795"><span data-slate-leaf="true" data-offset-key="13795:0" data-first-offset="true"><span data-slate-string="true">，代码对 loadedOffsets 进行分组，将那些已经完成组加载的消费者组位移值分到一组，保存在字段 groupOffsets 中；将那些有位移值，但没有对应组信息的分成另外一组，也就是字段 emptyGroupOffsets 保存的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13796"><span data-slate-object="text" data-key="13797"><span data-slate-leaf="true" data-offset-key="13797:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">其次</span></span></span></span><span data-slate-object="text" data-key="13798"><span data-slate-leaf="true" data-offset-key="13798:0" data-first-offset="true"><span data-slate-string="true">，代码为 loadedGroups 中的所有消费者组执行加载组操作，以及加载之后的操作 onGroupLoaded。还记得吧，loadedGroups 中保存的都是已完成组加载的消费者组。这里的 onGroupLoaded 是上层调用组件 Coordinator 传入的。它主要的作用是处理消费者组下所有成员的心跳超时设置，并指定下一次心跳的超时时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13799"><span data-slate-object="text" data-key="13800"><span data-slate-leaf="true" data-offset-key="13800:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">再次</span></span></span></span><span data-slate-object="text" data-key="13801"><span data-slate-leaf="true" data-offset-key="13801:0" data-first-offset="true"><span data-slate-string="true">，代码为 emptyGroupOffsets 的所有消费者组，创建空的消费者组元数据，然后执行和上一步相同的组加载逻辑以及加载后的逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13802"><span data-slate-object="text" data-key="13803"><span data-slate-leaf="true" data-offset-key="13803:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最后</span></span></span></span><span data-slate-object="text" data-key="13804"><span data-slate-leaf="true" data-offset-key="13804:0" data-first-offset="true"><span data-slate-string="true">，代码检查 removedGroups 中的所有消费者组，确保它们不能出现在消费者组元数据缓存中，否则将抛出异常。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13805"><span data-slate-object="text" data-key="13806"><span data-slate-leaf="true" data-offset-key="13806:0" data-first-offset="true"><span data-slate-string="true">至此，doLoadGroupsAndOffsets 方法的逻辑全部完成。经过调用该方法后，Coordinator 成功地读取了位移主题目标分区下的数据，并把它们填充到了消费者组元数据缓存中。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13807" id="sr-toc-6"><span data-slate-object="text" data-key="13808"><span data-slate-leaf="true" data-offset-key="13808:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13809"><span data-slate-object="text" data-key="13810"><span data-slate-leaf="true" data-offset-key="13810:0" data-first-offset="true"><span data-slate-string="true">今天，我们重点学习了 GroupMetadataManager 类中读写位移主题的方法代码。Coordinator 会使用这些方法对位移主题进行操作，实现对消费者组的管理。写入操作比较简单，它和一般的消息写入并无太大区别，而读取操作相对复杂一些。更重要的是，和我们的直观理解可能相悖的是，Kafka 在查询消费者组已提交位移时，是不会读取位移主题的，而是直接从内存中的消费者组元数据缓存中查询。这一点你一定要重点关注。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13811"><span data-slate-object="text" data-key="13812"><span data-slate-leaf="true" data-offset-key="13812:0" data-first-offset="true"><span data-slate-string="true">我们来简单回顾一下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13813"><div data-slate-type="list-line" data-slate-object="block" data-key="13814"><span data-slate-object="text" data-key="13815"><span data-slate-leaf="true" data-offset-key="13815:0" data-first-offset="true"><span data-slate-string="true">读写方法：appendForGroup 方法负责写入位移主题，doLoadGroupsAndOffsets 负责读取位移主题，并加载组信息和位移值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13816"><span data-slate-object="text" data-key="13817"><span data-slate-leaf="true" data-offset-key="13817:0" data-first-offset="true"><span data-slate-string="true">查询消费者组位移：查询位移时不读取位移主题，而是读取消费者组元数据缓存。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="13818"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/19/3b/19304a381e75783fd584dyye5cc0733b.jpg?wh=2250*537"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13819"><span data-slate-object="text" data-key="13820"><span data-slate-leaf="true" data-offset-key="13820:0" data-first-offset="true"><span data-slate-string="true">至此，GroupMetadataManager 类的重要源码，我们就学完了。作为一个有着将近 1000 行代码，而且集这么多功能于一身的大文件，这个类的代码绝对值得你多读几遍。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13821"><span data-slate-object="text" data-key="13822"><span data-slate-leaf="true" data-offset-key="13822:0" data-first-offset="true"><span data-slate-string="true">除了我们集中介绍的这些功能之外，GroupMetadataManager 类其实还是连接 GroupMetadata 和 Coordinator 的重要纽带，Coordinator 利用 GroupMetadataManager 类实现操作 GroupMetadata 的目的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13823"><span data-slate-object="text" data-key="13824"><span data-slate-leaf="true" data-offset-key="13824:0" data-first-offset="true"><span data-slate-string="true">我刚开始学习这部分源码的时候，居然不清楚 GroupMetadata 和 GroupMetadataManager 的区别是什么。现在，经过这 3 节课的内容，相信你已经知道，GroupMetadata 建模的是元数据信息，而 GroupMetadataManager 类建模的是管理元数据的方法，也是管理内部位移主题的唯一组件。以后碰到任何有关位移主题的问题，你都可以直接到这个类中去寻找答案。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13825" id="sr-toc-7"><span data-slate-object="text" data-key="13826"><span data-slate-leaf="true" data-offset-key="13826:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13827"><span data-slate-object="text" data-key="13828"><span data-slate-leaf="true" data-offset-key="13828:0" data-first-offset="true"><span data-slate-string="true">其实，除了读写位移主题之外，GroupMetadataManager 还提供了清除位移主题数据的方法。代码中的 cleanGroupMetadata 就是做这个事儿的。请你结合源码，分析一下 cleanGroupMetadata 方法的流程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13829"><span data-slate-object="text" data-key="13830"><span data-slate-leaf="true" data-offset-key="13830:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-8">精选留言 (2)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，我们重点学习了消费者组管理器 GroupMetadataManager 类中关于位移主题的管理。课后我请你思考下 kafka-console-consumer 脚本中输出字段的含义。对于已提交位移消息来说，它的 Key 格式是 offset_commit::group=&lt;groupId&gt;,partition=&lt; 分区号 &gt;。它的 Value 可能有三种取值：1、如果是 tombstone 消息，那么 Value 值是 &lt; DELETE&gt;；2、如果仅包含位移消息，则 Value 是 offset=&lt;offset&gt;；3、如果还包括已提交的元数据信息，那么 Value 是 offset=&lt;offset&gt;,metadata=&lt;metadata&gt;

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-07-21</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡小禾</span></div></div><div>读__consumer_offset 的逻辑第一步那里有点不是很理解
 while (currOffset &lt; logEndOffset &amp;&amp; readAtLeastOneRecord &amp;&amp; !shuttingDown.get ()){

}
它这里貌似是从 Log 的起始位置开始读取的，那么:

1. 每一次 while 循环，会不会有后面的查询结果查询前者的情况

2. 假如 log 很大，难道还费挺久从头开始读那四个列表，然后更新到缓存？

难道不是读 Log 最后几条就可以？</div><div><div>2021-12-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".14"><outline class="toc-level-h1" data-reactid=".14.0" style="width: 175px;"><active data-reactid=".14.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".14.0.1"><span data-reactid=".14.0.1.0">31 | GroupMetadataManager：查询位移时，不用读取位移主题？</span></a></outline><outline class="toc-level-h2" data-reactid=".14.1" style="width: 165px;"><active data-reactid=".14.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".14.1.1"><span data-reactid=".14.1.1.0">写入位移主题</span></a></outline><outline class="toc-level-h2" data-reactid=".14.2" style="width: 165px;"><active data-reactid=".14.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".14.2.1"><span data-reactid=".14.2.1.0">读取位移主题</span></a></outline><outline class="toc-level-h3" data-reactid=".14.3" style="width: 155px;"><active data-reactid=".14.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".14.3.1"><span data-reactid=".14.3.1.0">第 1 部分</span></a></outline><outline class="toc-level-h3" data-reactid=".14.4" style="width: 155px;"><active data-reactid=".14.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".14.4.1"><span data-reactid=".14.4.1.0">第 2 部分</span></a></outline><outline class="toc-level-h3" data-reactid=".14.5" style="width: 155px;"><active data-reactid=".14.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".14.5.1"><span data-reactid=".14.5.1.0">第 3 部分</span></a></outline><outline class="toc-level-h2" data-reactid=".14.6" style="width: 165px;"><active data-reactid=".14.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".14.6.1"><span data-reactid=".14.6.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".14.7" style="width: 165px;"><active data-reactid=".14.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".14.7.1"><span data-reactid=".14.7.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".14.8" style="width: 165px;"><active data-reactid=".14.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".14.8.1"><span data-reactid=".14.8.1.0">精选留言 (2)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/258348" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>