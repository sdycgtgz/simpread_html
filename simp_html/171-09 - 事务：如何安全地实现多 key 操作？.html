
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 09 | 事务：如何安全地实现多 key 操作？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>09 | 事务：如何安全地实现多 key 操作？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">我希望你能够用最低的学习成本，掌握 etcd 核心原理和最佳实践，让 etcd 为你所用。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">09 | 事务：如何安全地实现多 key 操作？</h1><div><span>唐聪</span> <span> 2021-02-08</span></div><div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/7d/15/7d52c574d2f4aaec7af94d9101362215.jpg" style="width: auto;"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：王超凡</span><span>大小：18.04M</span><span> 时长：19:45</span></div></div><audio title="09 | 事务：如何安全地实现多key操作？" src="https://res001.geekbang.org/media/audio/f2/a7/f2fe6bd7faae53297a3a389899f525a7/ld/ld.m3u8" __idm_id__="925706"></audio></div><div><div><div><div data-slate-editor="true" data-key="2682" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="2683"><span data-slate-object="text" data-key="2684"><span data-slate-leaf="true" data-offset-key="2684:0" data-first-offset="true"><span data-slate-string="true">你好，我是唐聪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2685"><span data-slate-object="text" data-key="2686"><span data-slate-leaf="true" data-offset-key="2686:0" data-first-offset="true"><span data-slate-string="true">在软件开发过程中，我们经常会遇到需要批量执行多个 key 操作的业务场景，比如转账案例中，Alice 给 Bob 转账 100 元，Alice 账号减少 100，Bob 账号增加 100，这涉及到多个 key 的原子更新。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2687"><span data-slate-object="text" data-key="2688"><span data-slate-leaf="true" data-offset-key="2688:0" data-first-offset="true"><span data-slate-string="true">无论发生任何故障，我们应用层期望的结果是，要么两个操作一起成功，要么两个一起失败。我们无法容忍出现一个成功，一个失败的情况。那么 etcd 是如何解决多 key 原子更新问题呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2689"><span data-slate-object="text" data-key="2690"><span data-slate-leaf="true" data-offset-key="2690:0" data-first-offset="true"><span data-slate-string="true">这正是我今天要和你分享的主题 —— 事务，它就是为了</span></span></span><span data-slate-object="text" data-key="2691"><span data-slate-leaf="true" data-offset-key="2691:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">简化应用层的编程模型</span></span></span></span><span data-slate-object="text" data-key="2692"><span data-slate-leaf="true" data-offset-key="2692:0" data-first-offset="true"><span data-slate-string="true">而诞生的。我将通过转账案例为你剖析 etcd 事务实现，让你了解 etcd 如何实现事务 ACID 特性的，以及 MVCC 版本号在事务中的重要作用。希望通过本节课，帮助你在业务开发中正确使用事务，保证软件代码的正确性。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2693" id="sr-toc-1"><span data-slate-object="text" data-key="2694"><span data-slate-leaf="true" data-offset-key="2694:0" data-first-offset="true"><span data-slate-string="true">事务特性初体验及 API</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2695"><span data-slate-object="text" data-key="2696"><span data-slate-leaf="true" data-offset-key="2696:0" data-first-offset="true"><span data-slate-string="true">如何使用 etcd 实现 Alice 向 Bob 转账功能呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2697"><span data-slate-object="text" data-key="2698"><span data-slate-leaf="true" data-offset-key="2698:0" data-first-offset="true"><span data-slate-string="true">在 etcd v2 的时候， etcd 提供了 CAS（Compare and swap），然而其只支持单 key，不支持多 key，因此无法满足类似转账场景的需求。严格意义上说 CAS 称不上事务，无法实现事务的各个隔离级别。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2699"><span data-slate-object="text" data-key="2700"><span data-slate-leaf="true" data-offset-key="2700:0" data-first-offset="true"><span data-slate-string="true">etcd v3 为了解决多 key 的原子操作问题，提供了全新迷你事务 API，同时基于 MVCC 版本号，它可以实现各种隔离级别的事务。它的基本结构如下：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="2701"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2702"><span data-slate-object="text" data-key="2703"><span data-slate-leaf="true" data-offset-key="2703:0" data-first-offset="true"><span data-slate-string="true">client.Txn(ctx).If(cmp1, cmp2, ...).</span></span></span><span data-slate-object="text" data-key="2704"><span data-slate-leaf="true" data-offset-key="2704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Then</span></span></span></span><span data-slate-object="text" data-key="2705"><span data-slate-leaf="true" data-offset-key="2705:0" data-first-offset="true"><span data-slate-string="true">(op1, op2, ...,).</span></span></span><span data-slate-object="text" data-key="2706"><span data-slate-leaf="true" data-offset-key="2706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Else</span></span></span></span><span data-slate-object="text" data-key="2707"><span data-slate-leaf="true" data-offset-key="2707:0" data-first-offset="true"><span data-slate-string="true">(op1, op2, …)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2708"><span data-slate-object="text" data-key="2709"><span data-slate-leaf="true" data-offset-key="2709:0" data-first-offset="true"><span data-slate-string="true">从上面结构中你可以看到，</span></span></span><span data-slate-object="text" data-key="2710"><span data-slate-leaf="true" data-offset-key="2710:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">事务 API 由 If 语句、Then 语句、Else 语句组成</span></span></span></span><span data-slate-object="text" data-key="2711"><span data-slate-leaf="true" data-offset-key="2711:0" data-first-offset="true"><span data-slate-string="true">，这与我们平时常见的 MySQL 事务完全不一样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2712"><span data-slate-object="text" data-key="2713"><span data-slate-leaf="true" data-offset-key="2713:0" data-first-offset="true"><span data-slate-string="true">它的基本原理是，在 If 语句中，你可以添加一系列的条件表达式，若条件表达式全部通过检查，则执行 Then 语句的 get/put/delete 等操作，否则执行 Else 的 get/put/delete 等操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2714"><span data-slate-object="text" data-key="2715"><span data-slate-leaf="true" data-offset-key="2715:0" data-first-offset="true"><span data-slate-string="true">那么 If 语句支持哪些检查项呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2716"><span data-slate-object="text" data-key="2717"><span data-slate-leaf="true" data-offset-key="2717:0" data-first-offset="true"><span data-slate-string="true">首先是 </span></span></span><span data-slate-object="text" data-key="2718"><span data-slate-leaf="true" data-offset-key="2718:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">key 的最近一次修改版本号 mod_revision</span></span></span></span><span data-slate-object="text" data-key="2719"><span data-slate-leaf="true" data-offset-key="2719:0" data-first-offset="true"><span data-slate-string="true">，简称 mod。你可以通过它检查 key 最近一次被修改时的版本号是否符合你的预期。比如当你查询到 Alice 账号资金为 100 元时，它的 mod_revision 是 v1，当你发起转账操作时，你得确保 Alice 账号上的 100 元未被挪用，这就可以通过 mod (“Alice”) = “v1” 条件表达式来保障转账安全性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2720"><span data-slate-object="text" data-key="2721"><span data-slate-leaf="true" data-offset-key="2721:0" data-first-offset="true"><span data-slate-string="true">其次是 </span></span></span><span data-slate-object="text" data-key="2722"><span data-slate-leaf="true" data-offset-key="2722:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">key 的创建版本号 create_revision</span></span></span></span><span data-slate-object="text" data-key="2723"><span data-slate-leaf="true" data-offset-key="2723:0" data-first-offset="true"><span data-slate-string="true">，简称 create。你可以通过它检查 key 是否已存在。比如在分布式锁场景里，只有分布式锁 key (lock) 不存在的时候，你才能发起 put 操作创建锁，这时你可以通过 create (“lock”) = "0" 来判断，因为一个 key 不存在的话它的 create_revision 版本号就是 0。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2724"><span data-slate-object="text" data-key="2725"><span data-slate-leaf="true" data-offset-key="2725:0" data-first-offset="true"><span data-slate-string="true">接着是 </span></span></span><span data-slate-object="text" data-key="2726"><span data-slate-leaf="true" data-offset-key="2726:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">key 的修改次数 version</span></span></span></span><span data-slate-object="text" data-key="2727"><span data-slate-leaf="true" data-offset-key="2727:0" data-first-offset="true"><span data-slate-string="true">。你可以通过它检查 key 的修改次数是否符合预期。比如你期望 key 在修改次数小于 3 时，才能发起某些操作时，可以通过 version (“key”) &lt; "3" 来判断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2728"><span data-slate-object="text" data-key="2729"><span data-slate-leaf="true" data-offset-key="2729:0" data-first-offset="true"><span data-slate-string="true">最后是 </span></span></span><span data-slate-object="text" data-key="2730"><span data-slate-leaf="true" data-offset-key="2730:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">key 的 value 值</span></span></span></span><span data-slate-object="text" data-key="2731"><span data-slate-leaf="true" data-offset-key="2731:0" data-first-offset="true"><span data-slate-string="true">。你可以通过检查 key 的 value 值是否符合预期，然后发起某些操作。比如期望 Alice 的账号资金为 200, value (“Alice”) = “200”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2732"><span data-slate-object="text" data-key="2733"><span data-slate-leaf="true" data-offset-key="2733:0" data-first-offset="true"><span data-slate-string="true">If 语句通过以上 MVCC 版本号、value 值、各种比较运算符 (等于、大于、小于、不等于)，实现了灵活的比较的功能，满足你各类业务场景诉求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2734"><span data-slate-object="text" data-key="2735"><span data-slate-leaf="true" data-offset-key="2735:0" data-first-offset="true"><span data-slate-string="true">下面我给出了一个使用 etcdctl 的 txn 事务命令，基于以上介绍的特性，初步实现的一个 Alice 向 Bob 转账 100 元的事务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2736"><span data-slate-object="text" data-key="2737"><span data-slate-leaf="true" data-offset-key="2737:0" data-first-offset="true"><span data-slate-string="true">Alice 和 Bob 初始账上资金分别都为 200 元，事务首先判断 Alice 账号资金是否为 200，若是则执行转账操作，不是则返回最新资金。etcd 是如何执行这个事务的呢？</span></span></span><span data-slate-object="text" data-key="2738"><span data-slate-leaf="true" data-offset-key="2738:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这个事务实现上有哪些问题呢？</span></span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="2739"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2740"><span data-slate-object="text" data-key="2741"><span data-slate-leaf="true" data-offset-key="2741:0" data-first-offset="true"><span data-slate-string="true">$ etcdctl txn -i</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2742"><span data-slate-object="text" data-key="2743"><span data-slate-leaf="true" data-offset-key="2743:0" data-first-offset="true"><span data-slate-string="true">compares: </span></span></span><span data-slate-object="text" data-key="2744"><span data-slate-leaf="true" data-offset-key="2744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应 If 语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2745"><span data-slate-object="text" data-key="2746"><span data-slate-leaf="true" data-offset-key="2746:0" data-first-offset="true"><span data-slate-string="true">value(</span></span></span><span data-slate-object="text" data-key="2747"><span data-slate-leaf="true" data-offset-key="2747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Alice"</span></span></span></span><span data-slate-object="text" data-key="2748"><span data-slate-leaf="true" data-offset-key="2748:0" data-first-offset="true"><span data-slate-string="true">) = </span></span></span><span data-slate-object="text" data-key="2749"><span data-slate-leaf="true" data-offset-key="2749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"200"</span></span></span></span><span data-slate-object="text" data-key="2750"><span data-slate-leaf="true" data-offset-key="2750:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2751"><span data-slate-leaf="true" data-offset-key="2751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断 Alice 账号资金是否为 200</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2752"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2753"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2754"><span data-slate-object="text" data-key="2755"><span data-slate-leaf="true" data-offset-key="2755:0" data-first-offset="true"><span data-slate-string="true">success requests (</span></span></span><span data-slate-object="text" data-key="2756"><span data-slate-leaf="true" data-offset-key="2756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2757"><span data-slate-leaf="true" data-offset-key="2757:0" data-first-offset="true"><span data-slate-string="true">, put, del): </span></span></span><span data-slate-object="text" data-key="2758"><span data-slate-leaf="true" data-offset-key="2758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应 Then 语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2759"><span data-slate-object="text" data-key="2760"><span data-slate-leaf="true" data-offset-key="2760:0" data-first-offset="true"><span data-slate-string="true">put Alice </span></span></span><span data-slate-object="text" data-key="2761"><span data-slate-leaf="true" data-offset-key="2761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">100</span></span></span></span><span data-slate-object="text" data-key="2762"><span data-slate-leaf="true" data-offset-key="2762:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2763"><span data-slate-leaf="true" data-offset-key="2763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Alice 账号初始资金 200 减 100</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2764"><span data-slate-object="text" data-key="2765"><span data-slate-leaf="true" data-offset-key="2765:0" data-first-offset="true"><span data-slate-string="true">put Bob </span></span></span><span data-slate-object="text" data-key="2766"><span data-slate-leaf="true" data-offset-key="2766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">300</span></span></span></span><span data-slate-object="text" data-key="2767"><span data-slate-leaf="true" data-offset-key="2767:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2768"><span data-slate-leaf="true" data-offset-key="2768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Bob 账号初始资金 200 加 100</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2769"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2770"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2771"><span data-slate-object="text" data-key="2772"><span data-slate-leaf="true" data-offset-key="2772:0" data-first-offset="true"><span data-slate-string="true">failure requests (</span></span></span><span data-slate-object="text" data-key="2773"><span data-slate-leaf="true" data-offset-key="2773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2774"><span data-slate-leaf="true" data-offset-key="2774:0" data-first-offset="true"><span data-slate-string="true">, put, del): </span></span></span><span data-slate-object="text" data-key="2775"><span data-slate-leaf="true" data-offset-key="2775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应 Else 语句</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2776"><span data-slate-object="text" data-key="2777"><span data-slate-leaf="true" data-offset-key="2777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2778"><span data-slate-leaf="true" data-offset-key="2778:0" data-first-offset="true"><span data-slate-string="true"> Alice  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2779"><span data-slate-object="text" data-key="2780"><span data-slate-leaf="true" data-offset-key="2780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2781"><span data-slate-leaf="true" data-offset-key="2781:0" data-first-offset="true"><span data-slate-string="true"> Bob</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2782"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2783"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2784"><span data-slate-object="text" data-key="2785"><span data-slate-leaf="true" data-offset-key="2785:0" data-first-offset="true"><span data-slate-string="true">SUCCESS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2786"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2787"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2788"><span data-slate-object="text" data-key="2789"><span data-slate-leaf="true" data-offset-key="2789:0" data-first-offset="true"><span data-slate-string="true">OK</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2790"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2791"><span data-slate-object="text" data-key="2792"><span data-slate-leaf="true" data-offset-key="2792:0" data-first-offset="true"><span data-slate-string="true">OK</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2793"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2794" id="sr-toc-2"><span data-slate-object="text" data-key="2795"><span data-slate-leaf="true" data-offset-key="2795:0" data-first-offset="true"><span data-slate-string="true">整体流程</span></span></span></h2><div data-slate-type="image" data-slate-object="block" data-key="2796"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/e4/d3/e41a4f83bda29599efcf06f6012b0bd3.png?wh=1920*852"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2797"><span data-slate-object="text" data-key="2798"><span data-slate-leaf="true" data-offset-key="2798:0" data-first-offset="true"><span data-slate-string="true">在和你介绍上面案例中的 etcd 事务原理和问题前，我先给你介绍下事务的整体流程，为我们后面介绍 etcd 事务 ACID 特性的实现做准备。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2799"><span data-slate-object="text" data-key="2800"><span data-slate-leaf="true" data-offset-key="2800:0" data-first-offset="true"><span data-slate-string="true">上图是 etcd 事务的执行流程，当你通过 client 发起一个 txn 转账事务操作时，通过 gRPC KV Server、Raft 模块处理后，在 Apply 模块执行此事务的时候，它首先对你的事务的 If 语句进行检查，也就是 ApplyCompares 操作，如果通过此操作，则执行 ApplyTxn/Then 语句，否则执行 ApplyTxn/Else 语句。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2801"><span data-slate-object="text" data-key="2802"><span data-slate-leaf="true" data-offset-key="2802:0" data-first-offset="true"><span data-slate-string="true">在执行以上操作过程中，它会根据事务是否只读、可写，通过 MVCC 层的读写事务对象，执行事务中的 get/put/delete 各操作，也就是我们上一节课介绍的 MVCC 对 key 的读写原理。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2803" id="sr-toc-3"><span data-slate-object="text" data-key="2804"><span data-slate-leaf="true" data-offset-key="2804:0" data-first-offset="true"><span data-slate-string="true">事务 ACID 特性</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2805"><span data-slate-object="text" data-key="2806"><span data-slate-leaf="true" data-offset-key="2806:0" data-first-offset="true"><span data-slate-string="true">了解完事务的整体执行流程后，那么 etcd 应该如何正确实现上面案例中 Alice 向 Bob 转账的事务呢？别着急，我们先来了解一下事务的 ACID 特性。在你了解了 etcd 事务 ACID 特性实现后，这个转账事务案例的正确解决方案也就简单了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2807"><span data-slate-object="text" data-key="2808"><span data-slate-leaf="true" data-offset-key="2808:0" data-first-offset="true"><span data-slate-string="true">ACID 是衡量事务的四个特性，由原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）组成。接下来我就为你分析 ACID 特性在 etcd 中的实现。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2809" id="sr-toc-4"><span data-slate-object="text" data-key="2810"><span data-slate-leaf="true" data-offset-key="2810:0" data-first-offset="true"><span data-slate-string="true">原子性与持久性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2811"><span data-slate-object="text" data-key="2812"><span data-slate-leaf="true" data-offset-key="2812:0" data-first-offset="true"><span data-slate-string="true">事务的原子性（Atomicity）是指在一个事务中，所有请求要么同时成功，要么同时失败。比如在我们的转账案例中，是绝对无法容忍 Alice 账号扣款成功，但是 Bob 账号资金到账失败的场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2813"><span data-slate-object="text" data-key="2814"><span data-slate-leaf="true" data-offset-key="2814:0" data-first-offset="true"><span data-slate-string="true">持久性（Durability）是指事务一旦提交，其所做的修改会永久保存在数据库。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2815"><span data-slate-object="text" data-key="2816"><span data-slate-leaf="true" data-offset-key="2816:0" data-first-offset="true"><span data-slate-string="true">软件系统在运行过程中会遇到各种各样的软硬件故障，如果 etcd 在执行上面事务过程中，刚执行完扣款命令（put Alice 100）就突然 crash 了，它是如何保证转账事务的原子性与持久性的呢？</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2817"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/cf/9e/cf94ce8fc0649fe5cce45f8b7468019e.png?wh=1920*949"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2818"><span data-slate-object="text" data-key="2819"><span data-slate-leaf="true" data-offset-key="2819:0" data-first-offset="true"><span data-slate-string="true">如上图转账事务流程图所示，etcd 在执行一个事务过程中，任何时间点都可能会出现节点 crash 等异常问题。我在图中给你标注了两个关键的异常时间点，它们分别是 T1 和 T2。接下来我分别为你分析一下 etcd 在这两个关键时间点异常后，是如何保证事务的原子性和持久性的。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2820" id="sr-toc-5"><span data-slate-object="text" data-key="2821"><span data-slate-leaf="true" data-offset-key="2821:0" data-first-offset="true"><span data-slate-string="true">T1 时间点</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2822"><span data-slate-object="text" data-key="2823"><span data-slate-leaf="true" data-offset-key="2823:0" data-first-offset="true"><span data-slate-string="true">T1 时间点是在 Alice 账号扣款 100 元完成时，Bob 账号资金还未成功增加时突然发生了 crash。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2824"><span data-slate-object="text" data-key="2825"><span data-slate-leaf="true" data-offset-key="2825:0" data-first-offset="true"><span data-slate-string="true">从前面介绍的 etcd 写原理和上面流程图我们可知，此时 MVCC 写事务持有 boltdb 写锁，仅是将修改提交到了内存中，保证幂等性、防止日志条目重复执行的一致性索引 consistent index 也并未更新。同时，负责 boltdb 事务提交的 goroutine 因无法持有写锁，也并未将事务提交到持久化存储中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2826"><span data-slate-object="text" data-key="2827"><span data-slate-leaf="true" data-offset-key="2827:0" data-first-offset="true"><span data-slate-string="true">因此，T1 时间点发生 crash 异常后，事务并未成功执行和持久化任意数据到磁盘上。在节点重启时，</span></span><span data-slate-leaf="true" data-offset-key="2827:1"><span data-slate-object="annotation" data-annotation-key="gkann_710030be" data-attr-id="22756" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">etcd  server 会重放 WAL 中的已提交日志条目，</span></span></span><span data-slate-leaf="true" data-offset-key="2827:2"><span data-slate-string="true">再次执行以上转账事务。因此不会出现 Alice 扣款成功、Bob 到帐失败等严重 Bug，极大简化了业务的编程复杂度。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2828" id="sr-toc-6"><span data-slate-object="text" data-key="2829"><span data-slate-leaf="true" data-offset-key="2829:0" data-first-offset="true"><span data-slate-string="true">T2 时间点</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2830"><span data-slate-object="text" data-key="2831"><span data-slate-leaf="true" data-offset-key="2831:0" data-first-offset="true"><span data-slate-string="true">T2 时间点是在 MVCC 写事务完成转账，server 返回给 client 转账成功后，boltdb 的事务提交 goroutine，批量将事务持久化到磁盘中时发生了 crash。这时 etcd 又是如何保证原子性和持久性的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2832"><span data-slate-object="text" data-key="2833"><span data-slate-leaf="true" data-offset-key="2833:0" data-first-offset="true"><span data-slate-string="true">我们知道一致性索引 consistent index 字段值是和 key-value 数据在一个 boltdb 事务里同时持久化到磁盘中的。若在 boltdb 事务提交过程中发生 crash 了，简单情况是 consistent index 和 key-value 数据都更新失败。那么当节点重启，etcd  server 重放 WAL 中已提交日志条目时，同样会再次应用转账事务到状态机中，因此事务的原子性和持久化依然能得到保证。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2834"><span data-slate-object="text" data-key="2835"><span data-slate-leaf="true" data-offset-key="2835:0" data-first-offset="true"><span data-slate-string="true">更复杂的情况是，当 boltdb 提交事务的时候，会不会部分数据提交成功，部分数据提交失败呢？这个问题，我将在下一节课通过深入介绍 boltdb 为你解答。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2836"><span data-slate-object="text" data-key="2837"><span data-slate-leaf="true" data-offset-key="2837:0" data-first-offset="true"><span data-slate-string="true">了解完 etcd 事务的原子性和持久性后，那一致性又是怎么一回事呢？事务的一致性难道是指各个节点数据一致性吗？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2838" id="sr-toc-7"><span data-slate-object="text" data-key="2839"><span data-slate-leaf="true" data-offset-key="2839:0" data-first-offset="true"><span data-slate-string="true">一致性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2840"><span data-slate-object="text" data-key="2841"><span data-slate-leaf="true" data-offset-key="2841:0" data-first-offset="true"><span data-slate-string="true">在软件系统中，到处可见一致性（Consistency）的表述，其实在不同场景下，它的含义是不一样的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2842"><span data-slate-object="text" data-key="2843"><span data-slate-leaf="true" data-offset-key="2843:0" data-first-offset="true"><span data-slate-string="true">首先分布式系统中多副本数据一致性，它是指各个副本之间的数据是否一致，比如 Redis 的主备是异步复制的，那么它的一致性是最终一致性的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2844"><span data-slate-object="text" data-key="2845"><span data-slate-leaf="true" data-offset-key="2845:0" data-first-offset="true"><span data-slate-string="true">其次是 CAP 原理中的一致性是指可线性化。核心原理是虽然整个系统是由多副本组成，但是通过线性化能力支持，对 client 而言就如一个副本，应用程序无需关心系统有多少个副本。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2846"><span data-slate-object="text" data-key="2847"><span data-slate-leaf="true" data-offset-key="2847:0" data-first-offset="true"><span data-slate-string="true">然后是一致性哈希，它是一种分布式系统中的数据分片算法，具备良好的分散性、平衡性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2848"><span data-slate-object="text" data-key="2849"><span data-slate-leaf="true" data-offset-key="2849:0" data-first-offset="true"><span data-slate-string="true">最后是事务中的一致性，它是指事务变更前后，数据库必须满足若干恒等条件的状态约束，</span></span></span><span data-slate-object="text" data-key="2850"><span data-slate-leaf="true" data-offset-key="2850:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一致性往往是由数据库和业务程序两方面来保障的</span></span></span></span><span data-slate-object="text" data-key="2851"><span data-slate-leaf="true" data-offset-key="2851:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2852"><span data-slate-object="text" data-key="2853"><span data-slate-leaf="true" data-offset-key="2853:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 Alice 向 Bob 转账的案例中有哪些恒等状态呢？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2854"><span data-slate-object="text" data-key="2855"><span data-slate-leaf="true" data-offset-key="2855:0" data-first-offset="true"><span data-slate-string="true">很明显，转账系统内的各账号资金总额，在转账前后应该一致，同时各账号资产不能小于 0。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2856"><span data-slate-object="text" data-key="2857"><span data-slate-leaf="true" data-offset-key="2857:0" data-first-offset="true"><span data-slate-string="true">为了帮助你更好地理解前面转账事务实现的问题，下面我给你画了幅两个并发转账事务的流程图。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2858"><span data-slate-object="text" data-key="2859"><span data-slate-leaf="true" data-offset-key="2859:0" data-first-offset="true"><span data-slate-string="true">图中有两个并发的转账事务，Mike 向 Bob 转账 100 元，Alice 也向 Bob 转账 100 元，按照我们上面的事务实现，从下图可知转账前系统总资金是 600 元，转账后却只有 500 元了，因此它无法保证转账前后账号系统内的资产一致性，导致了资产凭空消失，破坏了事务的一致性。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2860"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/1f/ea/1ff951756c0ffc427e5a064e3cf8caea.png?wh=1920*1153"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2861"><span data-slate-object="text" data-key="2862"><span data-slate-leaf="true" data-offset-key="2862:0" data-first-offset="true"><span data-slate-string="true">事务一致性被破坏的根本原因是，事务中缺少对 Bob 账号资产是否发生变化的判断，这就导致账号资金被覆盖。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2863"><span data-slate-object="text" data-key="2864"><span data-slate-leaf="true" data-offset-key="2864:0" data-first-offset="true"><span data-slate-string="true">为了确保事务的一致性，一方面，业务程序在转账逻辑里面，需检查转账者资产大于等于转账金额。在事务提交时，通过账号资产的版本号，确保双方账号资产未被其他事务修改。若双方账号资产被其他事务修改，账号资产版本号会检查失败，这时业务可以通过获取最新的资产和版本号，发起新的转账事务流程解决。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2865"><span data-slate-object="text" data-key="2866"><span data-slate-leaf="true" data-offset-key="2866:0" data-first-offset="true"><span data-slate-string="true">另一方面，etcd 会通过 WAL 日志和 consistent index、boltdb 事务特性，去确保事务的原子性，因此不会有部分成功部分失败的操作，导致资金凭空消失、新增。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2867"><span data-slate-object="text" data-key="2868"><span data-slate-leaf="true" data-offset-key="2868:0" data-first-offset="true"><span data-slate-string="true">介绍完事务的原子性和持久化、一致性后，我们再看看 etcd 又是如何提供各种隔离级别的事务，在转账过程中，其他 client 能看到转账的中间状态吗 (如 Alice 扣款成功，Bob 还未增加时)？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2869" id="sr-toc-8"><span data-slate-object="text" data-key="2870"><span data-slate-leaf="true" data-offset-key="2870:0" data-first-offset="true"><span data-slate-string="true">隔离性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2871"><span data-slate-object="text" data-key="2872"><span data-slate-leaf="true" data-offset-key="2872:0" data-first-offset="true"><span data-slate-string="true">ACID 中的 I 是指 Isolation，也就是事务的隔离性，它是指事务在执行过程中的可见性。常见的事务隔离级别有以下四种。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2873"><span data-slate-object="text" data-key="2874"><span data-slate-leaf="true" data-offset-key="2874:0" data-first-offset="true"><span data-slate-string="true">首先是</span></span></span><span data-slate-object="text" data-key="2875"><span data-slate-leaf="true" data-offset-key="2875:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">未提交读</span></span></span></span><span data-slate-object="text" data-key="2876"><span data-slate-leaf="true" data-offset-key="2876:0" data-first-offset="true"><span data-slate-string="true">（Read UnCommitted），也就是一个 client 能读取到未提交的事务。比如转账事务过程中，Alice 账号资金扣除后，Bob 账号上资金还未增加，这时如果其他 client 读取到这种中间状态，它会发现系统总金额钱减少了，破坏了事务一致性的约束。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2877"><span data-slate-object="text" data-key="2878"><span data-slate-leaf="true" data-offset-key="2878:0" data-first-offset="true"><span data-slate-string="true">其次是</span></span></span><span data-slate-object="text" data-key="2879"><span data-slate-leaf="true" data-offset-key="2879:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">已提交读</span></span></span></span><span data-slate-object="text" data-key="2880"><span data-slate-leaf="true" data-offset-key="2880:0" data-first-offset="true"><span data-slate-string="true">（Read Committed），指的是只能读取到已经提交的事务数据，但是存在不可重复读的问题。比如事务开始时，你读取了 Alice 和 Bob 资金，这时其他事务修改 Alice 和 Bob 账号上的资金，你在事务中再次读取时会读取到最新资金，导致两次读取结果不一样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2881"><span data-slate-object="text" data-key="2882"><span data-slate-leaf="true" data-offset-key="2882:0" data-first-offset="true"><span data-slate-string="true">接着是</span></span></span><span data-slate-object="text" data-key="2883"><span data-slate-leaf="true" data-offset-key="2883:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">可重复读</span></span></span></span><span data-slate-object="text" data-key="2884"><span data-slate-leaf="true" data-offset-key="2884:0" data-first-offset="true"><span data-slate-string="true">（Repeated Read），它是指在一个事务中，同一个读操作 get Alice/Bob 在事务的任意时刻都能得到同样的结果，其他修改事务提交后也不会影响你本事务所看到的结果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2885"><span data-slate-object="text" data-key="2886"><span data-slate-leaf="true" data-offset-key="2886:0" data-first-offset="true"><span data-slate-string="true">最后是</span></span></span><span data-slate-object="text" data-key="2887"><span data-slate-leaf="true" data-offset-key="2887:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">串行化</span></span></span></span><span data-slate-object="text" data-key="2888"><span data-slate-leaf="true" data-offset-key="2888:0" data-first-offset="true"><span data-slate-string="true">（Serializable），它是最高的事务隔离级别，读写相互阻塞，通过牺牲并发能力、串行化来解决事务并发更新过程中的隔离问题。对于串行化我要和你特别补充一点，很多人认为它都是通过读写锁，来实现事务一个个串行提交的，其实这只是在基于锁的并发控制数据库系统实现而已。</span></span></span><span data-slate-object="text" data-key="2889"><span data-slate-leaf="true" data-offset-key="2889:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为了优化性能，在基于 MVCC 机制实现的各个数据库系统中，提供了一个名为 “可串行化的快照隔离” 级别，相比悲观锁而言，它是一种乐观并发控制，通过快照技术实现的类似串行化的效果，事务提交时能检查是否冲突。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2890"><span data-slate-object="text" data-key="2891"><span data-slate-leaf="true" data-offset-key="2891:0" data-first-offset="true"><span data-slate-string="true">下面我重点和你介绍下未提交读、已提交读、可重复读、串行化快照隔离。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2892" id="sr-toc-9"><span data-slate-object="text" data-key="2893"><span data-slate-leaf="true" data-offset-key="2893:0" data-first-offset="true"><span data-slate-string="true">未提交读</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2894"><span data-slate-object="text" data-key="2895"><span data-slate-leaf="true" data-offset-key="2895:0" data-first-offset="true"><span data-slate-string="true">首先是最低的事务隔离级别，未提交读。我们通过如下一个转账事务时间序列图，来分析下一个 client 能否读取到未提交事务修改的数据，是否存在脏读。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2896"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/6a/8d/6a526be4949a383fd5263484c706d68d.png?wh=1920*786"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2897"><span data-slate-object="text" data-key="2898"><span data-slate-leaf="true" data-offset-key="2898:0" data-first-offset="true"><span data-slate-string="true">图中有两个事务，一个是用户查询 Alice 和 Bob 资产的事务，一个是我们执行 Alice 向 Bob 转账的事务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2899"><span data-slate-object="text" data-key="2900"><span data-slate-leaf="true" data-offset-key="2900:0" data-first-offset="true"><span data-slate-string="true">如图中所示，若在 Alice 向 Bob 转账事务执行过程中，etcd server 收到了 client 查询 Alice 和 Bob 资产的读请求，显然此时我们无法接受 client 能读取到一个未提交的事务，因为这对应用程序而言会产生严重的 BUG。那么 etcd 是如何保证不出现这种场景呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2901"><span data-slate-object="text" data-key="2902"><span data-slate-leaf="true" data-offset-key="2902:0" data-first-offset="true"><span data-slate-string="true">我们知道 etcd 基于 boltdb 实现读写操作的，读请求由 boltdb 的读事务处理，你可以理解为快照读。写请求由 boltdb 写事务处理，etcd 定时将一批写操作提交到 boltdb 并清空 buffer。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2903"><span data-slate-object="text" data-key="2904"><span data-slate-leaf="true" data-offset-key="2904:0" data-first-offset="true"><span data-slate-string="true">由于 etcd 是批量提交写事务的，而读事务又是快照读，因此当 MVCC 写事务完成时，它需要更新 buffer，这样下一个读请求到达时，才能从 buffer 中获取到最新数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2905"><span data-slate-object="text" data-key="2906"><span data-slate-leaf="true" data-offset-key="2906:0" data-first-offset="true"><span data-slate-string="true">在我们的场景中，转账事务并未结束，执行 put Alice 为 100 的操作不会回写 buffer，因此避免了脏读的可能性。用户此刻从 boltdb 快照读事务中查询到的 Alice 和 Bob 资产都为 200。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2907"><span data-slate-object="text" data-key="2908"><span data-slate-leaf="true" data-offset-key="2908:0" data-first-offset="true"><span data-slate-string="true">从以上分析可知，etcd 并未使用悲观锁来解决脏读的问题，而是通过 MVCC 机制来实现读写不阻塞，并解决脏读的问题。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2909" id="sr-toc-10"><span data-slate-object="text" data-key="2910"><span data-slate-leaf="true" data-offset-key="2910:0" data-first-offset="true"><span data-slate-string="true">已提交读、可重复读</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2911"><span data-slate-object="text" data-key="2912"><span data-slate-leaf="true" data-offset-key="2912:0" data-first-offset="true"><span data-slate-string="true">比未提交读隔离级别更高的是已提交读，它是指在事务中能读取到已提交数据，但是存在不可重复读的问题。已提交读，也就是说你每次读操作，若未增加任何版本号限制，默认都是当前读，etcd 会返回最新已提交的事务结果给你。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2913"><span data-slate-object="text" data-key="2914"><span data-slate-leaf="true" data-offset-key="2914:0" data-first-offset="true"><span data-slate-string="true">如何理解不可重复读呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2915"><span data-slate-object="text" data-key="2916"><span data-slate-leaf="true" data-offset-key="2916:0" data-first-offset="true"><span data-slate-string="true">在上面用户查询 Alice 和 Bob 事务的案例中，第一次查出来资产都是 200，第二次是 Alice 为 100，Bob 为 300，通过读已提交模式，你能及时获取到 etcd 最新已提交的事务结果，但是出现了不可重复读，两次读出来的 Alice 和 Bob 资产不一致。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2917"><span data-slate-object="text" data-key="2918"><span data-slate-leaf="true" data-offset-key="2918:0" data-first-offset="true"><span data-slate-string="true">那么如何实现可重复读呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2919"><span data-slate-object="text" data-key="2920"><span data-slate-leaf="true" data-offset-key="2920:0" data-first-offset="true"><span data-slate-string="true">你可以通过 MVCC 快照读，或者参考 etcd 的事务框架 STM 实现，它在事务中维护一个读缓存，优先从读缓存中查找，不存在则从 etcd 查询并更新到缓存中，这样事务中后续读请求都可从缓存中查找，确保了可重复读。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2921"><span data-slate-object="text" data-key="2922"><span data-slate-leaf="true" data-offset-key="2922:0" data-first-offset="true"><span data-slate-string="true">最后我们再来重点介绍下什么是串行化快照隔离。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="2923" id="sr-toc-11"><span data-slate-object="text" data-key="2924"><span data-slate-leaf="true" data-offset-key="2924:0" data-first-offset="true"><span data-slate-string="true">串行化快照隔离</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="2925"><span data-slate-object="text" data-key="2926"><span data-slate-leaf="true" data-offset-key="2926:0" data-first-offset="true"><span data-slate-string="true">串行化快照隔离是最严格的事务隔离级别，它是指在在事务刚开始时，首先获取 etcd 当前的版本号 rev，事务中后续发出的读请求都带上这个版本号 rev，告诉 etcd 你需要获取那个时间点的快照数据，etcd 的 MVCC 机制就能确保事务中能读取到同一时刻的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2927"><span data-slate-object="text" data-key="2928"><span data-slate-leaf="true" data-offset-key="2928:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">同时，它还要确保事务提交时，你读写的数据都是最新的，未被其他人修改，也就是要增加冲突检测机制。</span></span></span></span><span data-slate-object="text" data-key="2929"><span data-slate-leaf="true" data-offset-key="2929:0" data-first-offset="true"><span data-slate-string="true">当事务提交出现冲突的时候依赖 client 重试解决，安全地实现多 key 原子更新。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2930"><span data-slate-object="text" data-key="2931"><span data-slate-leaf="true" data-offset-key="2931:0" data-first-offset="true"><span data-slate-string="true">那么我们应该如何为上面一致性案例中，两个并发转账的事务，增加冲突检测机制呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2932"><span data-slate-object="text" data-key="2933"><span data-slate-leaf="true" data-offset-key="2933:0" data-first-offset="true"><span data-slate-string="true">核心就是我们前面介绍 MVCC 的版本号，我通过下面的并发转账事务流程图为你解释它是如何工作的。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2934"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/3b/26/3b4c7fb43e03a38aceb2a8c2d5c92226.png?wh=1920*1011"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2935"><span data-slate-object="text" data-key="2936"><span data-slate-leaf="true" data-offset-key="2936:0" data-first-offset="true"><span data-slate-string="true">如上图所示，事务 A，Alice 向 Bob 转账 100 元，事务 B，Mike 向 Bob 转账 100 元，两个事务同时发起转账操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2937"><span data-slate-object="text" data-key="2938"><span data-slate-leaf="true" data-offset-key="2938:0" data-first-offset="true"><span data-slate-string="true">一开始时，Mike 的版本号 (指 mod_revision) 是 4，Bob 版本号是 3，Alice 版本号是 2，资产各自 200。为了防止并发写事务冲突，etcd 在一个写事务开始时，会独占一个 MVCC 读写锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2939"><span data-slate-object="text" data-key="2940"><span data-slate-leaf="true" data-offset-key="2940:0" data-first-offset="true"><span data-slate-string="true">事务 A 会先去 etcd 查询当前 Alice 和 Bob 的资产版本号，用于在事务提交时做冲突检测。在事务 A 查询后，事务 B 获得 MVCC 写锁并完成转账事务，Mike 和 Bob 账号资产分别为 100，300，版本号都为 5。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2941"><span data-slate-object="text" data-key="2942"><span data-slate-leaf="true" data-offset-key="2942:0" data-first-offset="true"><span data-slate-string="true">事务 B 完成后，事务 A 获得写锁，开始执行事务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2943"><span data-slate-object="text" data-key="2944"><span data-slate-leaf="true" data-offset-key="2944:0" data-first-offset="true"><span data-slate-string="true">为了解决并发事务冲突问题，事务 A 中增加了冲突检测，期望的 Alice 版本号应为 2，Bob 为 3。结果事务 B 的修改导致 Bob 版本号变成了 5，因此此事务会执行失败分支，再次查询 Alice 和 Bob 版本号和资产，发起新的转账事务，成功通过 MVCC 冲突检测规则 mod (“Alice”) = 2 和 mod (“Bob”) = 5 后，更新 Alice 账号资产为 100，Bob 资产为 400，完成转账操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2945"><span data-slate-object="text" data-key="2946"><span data-slate-leaf="true" data-offset-key="2946:0" data-first-offset="true"><span data-slate-string="true">通过上面介绍的快照读和 MVCC 冲突检测检测机制，etcd 就可实现串行化快照隔离能力。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2947" id="sr-toc-12"><span data-slate-object="text" data-key="2948"><span data-slate-leaf="true" data-offset-key="2948:0" data-first-offset="true"><span data-slate-string="true">转账案例应用</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2949"><span data-slate-object="text" data-key="2950"><span data-slate-leaf="true" data-offset-key="2950:0" data-first-offset="true"><span data-slate-string="true">介绍完 etcd 事务 ACID 特性实现后，你很容易发现事务特性初体验中的案例问题了，它缺少了完整事务的冲突检测机制。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2951"><span data-slate-object="text" data-key="2952"><span data-slate-leaf="true" data-offset-key="2952:0" data-first-offset="true"><span data-slate-string="true">首先你可通过一个事务获取 Alice 和 Bob 账号的上资金和版本号，用以判断 Alice 是否有足够的金额转账给 Bob 和事务提交时做冲突检测。 你可通过如下 etcdctl txn 命令，获取 Alice 和 Bob 账号的资产和最后一次修改时的版本号 (mod_revision):</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="2953"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2954"><span data-slate-object="text" data-key="2955"><span data-slate-leaf="true" data-offset-key="2955:0" data-first-offset="true"><span data-slate-string="true">$ etcdctl txn -i -w=json</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2956"><span data-slate-object="text" data-key="2957"><span data-slate-leaf="true" data-offset-key="2957:0" data-first-offset="true"><span data-slate-string="true">compares:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2958"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2959"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2960"><span data-slate-object="text" data-key="2961"><span data-slate-leaf="true" data-offset-key="2961:0" data-first-offset="true"><span data-slate-string="true">success requests (</span></span></span><span data-slate-object="text" data-key="2962"><span data-slate-leaf="true" data-offset-key="2962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2963"><span data-slate-leaf="true" data-offset-key="2963:0" data-first-offset="true"><span data-slate-string="true">, put, del):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2964"><span data-slate-object="text" data-key="2965"><span data-slate-leaf="true" data-offset-key="2965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2966"><span data-slate-leaf="true" data-offset-key="2966:0" data-first-offset="true"><span data-slate-string="true"> Alice</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2967"><span data-slate-object="text" data-key="2968"><span data-slate-leaf="true" data-offset-key="2968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2969"><span data-slate-leaf="true" data-offset-key="2969:0" data-first-offset="true"><span data-slate-string="true"> Bob</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2970"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2971"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2972"><span data-slate-object="text" data-key="2973"><span data-slate-leaf="true" data-offset-key="2973:0" data-first-offset="true"><span data-slate-string="true">failure requests (</span></span></span><span data-slate-object="text" data-key="2974"><span data-slate-leaf="true" data-offset-key="2974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="2975"><span data-slate-leaf="true" data-offset-key="2975:0" data-first-offset="true"><span data-slate-string="true">, put, del):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2976"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2977"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2978"><span data-slate-object="text" data-key="2979"><span data-slate-leaf="true" data-offset-key="2979:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2980"><span data-slate-object="text" data-key="2981"><span data-slate-leaf="true" data-offset-key="2981:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2982"><span data-slate-leaf="true" data-offset-key="2982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"kvs"</span></span></span></span><span data-slate-object="text" data-key="2983"><span data-slate-leaf="true" data-offset-key="2983:0" data-first-offset="true"><span data-slate-string="true">:[</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2984"><span data-slate-object="text" data-key="2985"><span data-slate-leaf="true" data-offset-key="2985:0" data-first-offset="true"><span data-slate-string="true">      {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2986"><span data-slate-object="text" data-key="2987"><span data-slate-leaf="true" data-offset-key="2987:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="2988"><span data-slate-leaf="true" data-offset-key="2988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"key"</span></span></span></span><span data-slate-object="text" data-key="2989"><span data-slate-leaf="true" data-offset-key="2989:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="2990"><span data-slate-leaf="true" data-offset-key="2990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"QWxpY2U="</span></span></span></span><span data-slate-object="text" data-key="2991"><span data-slate-leaf="true" data-offset-key="2991:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2992"><span data-slate-object="text" data-key="2993"><span data-slate-leaf="true" data-offset-key="2993:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="2994"><span data-slate-leaf="true" data-offset-key="2994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"create_revision"</span></span></span></span><span data-slate-object="text" data-key="2995"><span data-slate-leaf="true" data-offset-key="2995:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="2996"><span data-slate-leaf="true" data-offset-key="2996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="2997"><span data-slate-leaf="true" data-offset-key="2997:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2998"><span data-slate-object="text" data-key="2999"><span data-slate-leaf="true" data-offset-key="2999:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3000"><span data-slate-leaf="true" data-offset-key="3000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"mod_revision"</span></span></span></span><span data-slate-object="text" data-key="3001"><span data-slate-leaf="true" data-offset-key="3001:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3002"><span data-slate-leaf="true" data-offset-key="3002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="3003"><span data-slate-leaf="true" data-offset-key="3003:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3004"><span data-slate-object="text" data-key="3005"><span data-slate-leaf="true" data-offset-key="3005:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3006"><span data-slate-leaf="true" data-offset-key="3006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"version"</span></span></span></span><span data-slate-object="text" data-key="3007"><span data-slate-leaf="true" data-offset-key="3007:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3008"><span data-slate-leaf="true" data-offset-key="3008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="3009"><span data-slate-leaf="true" data-offset-key="3009:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3010"><span data-slate-object="text" data-key="3011"><span data-slate-leaf="true" data-offset-key="3011:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3012"><span data-slate-leaf="true" data-offset-key="3012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"value"</span></span></span></span><span data-slate-object="text" data-key="3013"><span data-slate-leaf="true" data-offset-key="3013:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3014"><span data-slate-leaf="true" data-offset-key="3014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"MjAw"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3015"><span data-slate-object="text" data-key="3016"><span data-slate-leaf="true" data-offset-key="3016:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3017"><span data-slate-object="text" data-key="3018"><span data-slate-leaf="true" data-offset-key="3018:0" data-first-offset="true"><span data-slate-string="true">  ],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3019"><span data-slate-object="text" data-key="3020"><span data-slate-leaf="true" data-offset-key="3020:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3021"><span data-slate-object="text" data-key="3022"><span data-slate-leaf="true" data-offset-key="3022:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="3023"><span data-slate-leaf="true" data-offset-key="3023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"kvs"</span></span></span></span><span data-slate-object="text" data-key="3024"><span data-slate-leaf="true" data-offset-key="3024:0" data-first-offset="true"><span data-slate-string="true">:[</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3025"><span data-slate-object="text" data-key="3026"><span data-slate-leaf="true" data-offset-key="3026:0" data-first-offset="true"><span data-slate-string="true">      {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3027"><span data-slate-object="text" data-key="3028"><span data-slate-leaf="true" data-offset-key="3028:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3029"><span data-slate-leaf="true" data-offset-key="3029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"key"</span></span></span></span><span data-slate-object="text" data-key="3030"><span data-slate-leaf="true" data-offset-key="3030:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3031"><span data-slate-leaf="true" data-offset-key="3031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Qm9i"</span></span></span></span><span data-slate-object="text" data-key="3032"><span data-slate-leaf="true" data-offset-key="3032:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3033"><span data-slate-object="text" data-key="3034"><span data-slate-leaf="true" data-offset-key="3034:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3035"><span data-slate-leaf="true" data-offset-key="3035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"create_revision"</span></span></span></span><span data-slate-object="text" data-key="3036"><span data-slate-leaf="true" data-offset-key="3036:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3037"><span data-slate-leaf="true" data-offset-key="3037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="3038"><span data-slate-leaf="true" data-offset-key="3038:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3039"><span data-slate-object="text" data-key="3040"><span data-slate-leaf="true" data-offset-key="3040:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3041"><span data-slate-leaf="true" data-offset-key="3041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"mod_revision"</span></span></span></span><span data-slate-object="text" data-key="3042"><span data-slate-leaf="true" data-offset-key="3042:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3043"><span data-slate-leaf="true" data-offset-key="3043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="3044"><span data-slate-leaf="true" data-offset-key="3044:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3045"><span data-slate-object="text" data-key="3046"><span data-slate-leaf="true" data-offset-key="3046:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3047"><span data-slate-leaf="true" data-offset-key="3047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"version"</span></span></span></span><span data-slate-object="text" data-key="3048"><span data-slate-leaf="true" data-offset-key="3048:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3049"><span data-slate-leaf="true" data-offset-key="3049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="3050"><span data-slate-leaf="true" data-offset-key="3050:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3051"><span data-slate-object="text" data-key="3052"><span data-slate-leaf="true" data-offset-key="3052:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="3053"><span data-slate-leaf="true" data-offset-key="3053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"value"</span></span></span></span><span data-slate-object="text" data-key="3054"><span data-slate-leaf="true" data-offset-key="3054:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="3055"><span data-slate-leaf="true" data-offset-key="3055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"MzAw"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3056"><span data-slate-object="text" data-key="3057"><span data-slate-leaf="true" data-offset-key="3057:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3058"><span data-slate-object="text" data-key="3059"><span data-slate-leaf="true" data-offset-key="3059:0" data-first-offset="true"><span data-slate-string="true">  ],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3060"><span data-slate-object="text" data-key="3061"><span data-slate-leaf="true" data-offset-key="3061:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3062"><span data-slate-object="text" data-key="3063"><span data-slate-leaf="true" data-offset-key="3063:0" data-first-offset="true"><span data-slate-string="true">其次发起资金转账操作，Alice 账号减去 100，Bob 账号增加 100。为了保证转账事务的准确性、一致性，提交事务的时候需检查 Alice 和 Bob 账号最新修改版本号与读取资金时的一致 (compares 操作中增加版本号检测)，以保证其他事务未修改两个账号的资金。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3064"><span data-slate-object="text" data-key="3065"><span data-slate-leaf="true" data-offset-key="3065:0" data-first-offset="true"><span data-slate-string="true">若 compares 操作通过检查，则执行转账操作，否则执行查询 Alice 和 Bob 账号资金操作，命令如下:</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="3066"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3067"><span data-slate-object="text" data-key="3068"><span data-slate-leaf="true" data-offset-key="3068:0" data-first-offset="true"><span data-slate-string="true">$ etcdctl txn </span></span></span><span data-slate-object="text" data-key="3069"><span data-slate-leaf="true" data-offset-key="3069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="3070"><span data-slate-leaf="true" data-offset-key="3070:0" data-first-offset="true"><span data-slate-string="true">i</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3071"><span data-slate-object="text" data-key="3072"><span data-slate-leaf="true" data-offset-key="3072:0" data-first-offset="true"><span data-slate-string="true">compares:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3073"><span data-slate-object="text" data-key="3074"><span data-slate-leaf="true" data-offset-key="3074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mod</span></span></span></span><span data-slate-object="text" data-key="3075"><span data-slate-leaf="true" data-offset-key="3075:0" data-first-offset="true"><span data-slate-string="true">("Alice") </span></span></span><span data-slate-object="text" data-key="3076"><span data-slate-leaf="true" data-offset-key="3076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="3077"><span data-slate-leaf="true" data-offset-key="3077:0" data-first-offset="true"><span data-slate-string="true"> "2"</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3078"><span data-slate-object="text" data-key="3079"><span data-slate-leaf="true" data-offset-key="3079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mod</span></span></span></span><span data-slate-object="text" data-key="3080"><span data-slate-leaf="true" data-offset-key="3080:0" data-first-offset="true"><span data-slate-string="true">("Bob") </span></span></span><span data-slate-object="text" data-key="3081"><span data-slate-leaf="true" data-offset-key="3081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="3082"><span data-slate-leaf="true" data-offset-key="3082:0" data-first-offset="true"><span data-slate-string="true"> "3"</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3083"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3084"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3085"><span data-slate-object="text" data-key="3086"><span data-slate-leaf="true" data-offset-key="3086:0" data-first-offset="true"><span data-slate-string="true">success requests (</span></span></span><span data-slate-object="text" data-key="3087"><span data-slate-leaf="true" data-offset-key="3087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="3088"><span data-slate-leaf="true" data-offset-key="3088:0" data-first-offset="true"><span data-slate-string="true">, put, del):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3089"><span data-slate-object="text" data-key="3090"><span data-slate-leaf="true" data-offset-key="3090:0" data-first-offset="true"><span data-slate-string="true">put Alice </span></span></span><span data-slate-object="text" data-key="3091"><span data-slate-leaf="true" data-offset-key="3091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">100</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3092"><span data-slate-object="text" data-key="3093"><span data-slate-leaf="true" data-offset-key="3093:0" data-first-offset="true"><span data-slate-string="true">put Bob </span></span></span><span data-slate-object="text" data-key="3094"><span data-slate-leaf="true" data-offset-key="3094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">300</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3095"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3096"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3097"><span data-slate-object="text" data-key="3098"><span data-slate-leaf="true" data-offset-key="3098:0" data-first-offset="true"><span data-slate-string="true">failure requests (</span></span></span><span data-slate-object="text" data-key="3099"><span data-slate-leaf="true" data-offset-key="3099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="3100"><span data-slate-leaf="true" data-offset-key="3100:0" data-first-offset="true"><span data-slate-string="true">, put, del):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3101"><span data-slate-object="text" data-key="3102"><span data-slate-leaf="true" data-offset-key="3102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="3103"><span data-slate-leaf="true" data-offset-key="3103:0" data-first-offset="true"><span data-slate-string="true"> Alice</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3104"><span data-slate-object="text" data-key="3105"><span data-slate-leaf="true" data-offset-key="3105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="3106"><span data-slate-leaf="true" data-offset-key="3106:0" data-first-offset="true"><span data-slate-string="true"> Bob</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3107"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3108"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3109"><span data-slate-object="text" data-key="3110"><span data-slate-leaf="true" data-offset-key="3110:0" data-first-offset="true"><span data-slate-string="true">SUCCESS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3111"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3112"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3113"><span data-slate-object="text" data-key="3114"><span data-slate-leaf="true" data-offset-key="3114:0" data-first-offset="true"><span data-slate-string="true">OK</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3115"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3116"><span data-slate-object="text" data-key="3117"><span data-slate-leaf="true" data-offset-key="3117:0" data-first-offset="true"><span data-slate-string="true">OK</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3118"><span data-slate-object="text" data-key="3119"><span data-slate-leaf="true" data-offset-key="3119:0" data-first-offset="true"><span data-slate-string="true">到这里我们就完成了一个安全的转账事务操作，从以上流程中你可以发现，自己从 0 到 1 实现一个完整的事务还是比较繁琐的，幸运的是，etcd 社区基于以上介绍的事务特性，提供了一个简单的事务框架 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="3120"><span data-slate-object="text" data-key="3121"><span data-slate-leaf="true" data-offset-key="3121:0" data-first-offset="true"><span data-slate-string="true">STM</span></span></span></a><span data-slate-object="text" data-key="3122"><span data-slate-leaf="true" data-offset-key="3122:0" data-first-offset="true"><span data-slate-string="true">，构建了各个事务隔离级别类，帮助你进一步简化应用编程复杂度。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3123" id="sr-toc-13"><span data-slate-object="text" data-key="3124"><span data-slate-leaf="true" data-offset-key="3124:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="3125"><span data-slate-object="text" data-key="3126"><span data-slate-leaf="true" data-offset-key="3126:0" data-first-offset="true"><span data-slate-string="true">最后我们来小结下今天的内容。首先我给你介绍了事务 API 的基本结构，它由 If、Then、Else 语句组成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3127"><span data-slate-object="text" data-key="3128"><span data-slate-leaf="true" data-offset-key="3128:0" data-first-offset="true"><span data-slate-string="true">其中 If 支持多个比较规则，它是用于事务提交时的冲突检测，比较的对象支持 key 的 </span></span></span><span data-slate-object="text" data-key="3129"><span data-slate-leaf="true" data-offset-key="3129:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">mod_revision</span></span></span></span><span data-slate-object="text" data-key="3130"><span data-slate-leaf="true" data-offset-key="3130:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-object="text" data-key="3131"><span data-slate-leaf="true" data-offset-key="3131:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">create_revision、version、value 值</span></span></span></span><span data-slate-object="text" data-key="3132"><span data-slate-leaf="true" data-offset-key="3132:0" data-first-offset="true"><span data-slate-string="true">。随后我给你介绍了整个事务执行的基本流程，Apply 模块首先执行 If 的比较规则，为真则执行 Then 语句，否则执行 Else 语句。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3133"><span data-slate-object="text" data-key="3134"><span data-slate-leaf="true" data-offset-key="3134:0" data-first-offset="true"><span data-slate-string="true">接着通过转账案例，四幅转账事务时间序列图，我为你分析了事务的 ACID 特性，剖析了在 etcd 中事务的 ACID 特性的实现。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="3135"><div data-slate-type="list-line" data-slate-object="block" data-key="3136"><span data-slate-object="text" data-key="3137"><span data-slate-leaf="true" data-offset-key="3137:0" data-first-offset="true"><span data-slate-string="true">原子性是指一个事务要么全部成功要么全部失败，etcd 基于 WAL 日志、consistent index、boltdb 的事务能力提供支持。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="3138"><span data-slate-object="text" data-key="3139"><span data-slate-leaf="true" data-offset-key="3139:0" data-first-offset="true"><span data-slate-string="true">一致性是指事务转账前后的，数据库和应用程序期望的恒等状态应该保持不变，这通过数据库和业务应用程序相互协作完成。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="3140"><span data-slate-object="text" data-key="3141"><span data-slate-leaf="true" data-offset-key="3141:0" data-first-offset="true"><span data-slate-string="true">持久性是指事务提交后，数据不丢失，</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="3142"><span data-slate-object="text" data-key="3143"><span data-slate-leaf="true" data-offset-key="3143:0" data-first-offset="true"><span data-slate-string="true">隔离性是指事务提交过程中的可见性，etcd 不存在脏读，基于 MVCC 机制、boltdb 事务你可以实现可重复读、串行化快照隔离级别的事务，保障并发事务场景中你的数据安全性。</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3144" id="sr-toc-14"><span data-slate-object="text" data-key="3145"><span data-slate-leaf="true" data-offset-key="3145:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="3146"><span data-slate-object="text" data-key="3147"><span data-slate-leaf="true" data-offset-key="3147:0" data-first-offset="true"><span data-slate-string="true">在数据库事务中，有各种各样的概念，比如脏读、脏写、不可重复读与读倾斜、幻读与写倾斜、更新丢失、快照隔离、可串行化快照隔离？你知道它们的含义吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3148"><span data-slate-object="text" data-key="3149"><span data-slate-leaf="true" data-offset-key="3149:0" data-first-offset="true"><span data-slate-string="true">感谢你的阅读，如果你认为这节课的内容有收获，也欢迎把它分享给你的朋友，谢谢。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>19</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-15">精选留言 (16)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/ib3Rzem884S5MOS96THy0gQXcF26PNsnRBpyr3pM5rVibZdYvAibpVvAGfibF1ddpgrteg9fQUsq4vce9EM95Jj97Q/132"></div></div><div><div><div><span>Geek_604077</span></div></div><div>在数据库事务中，有各种各样的概念，比如脏读、脏写、不可重复读与读倾斜、幻读与写倾斜、更新丢失、快照隔离、可串行化快照隔离？你知道它们的含义吗？
脏读、脏写：

在读未提交的隔离级别的情况下，事务 A 执行过程中，事务 A 对数据资源进行了修改，事务 B 读取了事务 A 修改后且未提交的数据。A 因为某些原因回滚了操作，B 却使用了 A 对资源修改后的数据，进行了读写等操作。

不可重复读：

在读未提交、读提交的隔离级别情况下，事务 B 读取了两次数据资源，在这两次读取的过程中事务 A 修改了数据，导致事务 B 在这两次读取出来的数据不一致。这种在同一个事务中，前后两次读取的数据不一致的现象就是不可重复读。

幻读：

在可重复读得隔离级别情况下，事务 B 前后两次读取同一个范围的数据，在事务 B 两次读取的过程中事务 A 新增了数据，导致事务 B 后一次读取到前一次查询没有看到的行。

读倾斜、写倾斜：

读写倾斜是在数据分表不合理的情况下，对某个表的数据存在大量的读取写入的需求，分表不均衡不合理导致的。

更新丢失：

第一类丢失，在读未提交的隔离级别情况下，事务 A 和事务 B 都对数据进行更新，但是事务 A 由于某种原因事务回滚了，把已经提交的事务 B 的更新数据给覆盖了。这种现象就是第一类更新丢失。

第二类丢失，在可重复读的隔离级别情况下，跟第一类更新丢失有点类似，也是两个事务同时对数据进行更新，但是事务 A 的更新把已提交的事务 B 的更新数据给覆盖了。这种现象就是第二类更新丢失。

快照隔离：

每个事务都从一个数据库的快照中读数据，如果有些数据在当前事务开始之后，被其他事务改变了值，快照隔离能够保证当前事务无法看到这个新值。

可串行化快照隔离：

可串行化快照隔离是在快照隔离级别之上，支持串行化。
（讲得特别好，肯定花了特别多的心思跟时间，肯定掉了好多头发🐶，给老师点赞）</div><div><div>2022-02-15</div><div><div><i></i><span>1</span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 云原生工程师</span></div></div><div>老师分析得透彻，学习了，原来自己平时使用的事务过程中，无意间已经使用了串行化快照隔离级别，还请问一下事务性能相比 put 接口差异大吗</div><div><p>作者回复：嗯，肯定有不少差异的，事务执行逻辑更复杂，影响性能的因素比较多，实践篇我有介绍，建议根据自己实际业务场景，部署环境，使用 etcd 自带的 benchmark 工具压测对比下差异.</p></div><div><div>2021-02-10</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132"></div></div><div><div><div><span>types</span></div></div><div>关于事务 txn，请问事务都是在 leader 执行的嘛？还是根据 request 中的动作决定？</div><div><div>2021-09-25</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/e1/6b/74a8b7d8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Hugh</span></div></div><div>在快照串行化隔离的案例里面，有个问题想请教一下，首先冲突检测机制是在提交前进行检测的，那么意味着无论提交是否成功，大部分的节点都已经写入了 raft log 或者 WAL，假设这次检测的结果是失败的（比如已经没有足够的钱进行转账），那么就不会提交了（给客户端的反馈也是此次转账失败）。
这个时候 leader 节点突然宕机，其他节点重新开始了选举，那些已经写入此次转账 log 的节点是有可能成为新的 leader，在新的任期中，仍然会尝试提交这次事务，假设这次提交时已经有了足够的金额，则会导致提交成功。但是这次的提交成功对于客户端来说完全不感知，这样子就会导致用户发现自己的金额突然变少了，这个肯定是不符合预期的，老师可以解释一下这中间是不是有哪部分我的理解有问题呢</div><div><div>2022-06-21</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/96/a2/c1596dd8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>🤔</span></div></div><div>etcd 事务可用在分布式事务吗？</div><div><div>2022-02-15</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDRPejHodutia9Ud8UZLY8g5lTkKXgf3J104c0jM9aFfAGNoUdxkRLnnWRc5Kd3jIeN3EqXxKFT0g/132"></div></div><div><div><div><span>蓝莓侠</span></div></div><div>串行化快照隔离中的冲突检测，感觉和 CAS 一样啊，有什么区别吗？</div><div><div>2022-02-14</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/jA97yib7VetXc4iclOg2gGfZu1fO7efyib2mKeqvIxDdmgLqukusyFzPrbIQeZYR0WDJUicRakgVGroaYC7aWGFrEw/132"></div></div><div><div><div><span>Turing</span></div></div><div>这篇文章含金量很高，分布式中的 acid 和数据库中的 acid 是不一样的概念。其实事务提交的时候还是走了读写锁，读写锁的目的应该是为了回写 buffer 吧. etcd 事务提交，并不一定立马持久化到磁盘中. </div><div><div>2021-11-22</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HelloBug</span></div></div><div>&gt;Apply 模块首先执行 If 的比较规则，为真则执行 Then 语句，否则执行 Else 语句
这里执行 Then 里的命令的时候，为什么不可能发生状态的变更呢？例如向 Bob 转账 100，put bob 300 时，bob 的账户已经是 300 了，就是说判断的时候还没问题，执行 Then 的时候就有问题了。</div><div><div>2021-11-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HelloBug</span></div></div><div>极端一点考虑，冲突检测的时候可能会发生很多次的冲突，这样应用程序如果只进行了一次的冲突检测，是可能出现事务提交失败的情况的，对吗？</div><div><div>2021-11-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HelloBug</span></div></div><div>&gt;&gt; 为了解决并发事务冲突问题，事务 A 中增加了冲突检测，期望的 Alice 版本号应为 2，Bob 为 3。结果事务 B 的修改导致 Bob 版本号变成了 5
这里 Bob 的版本号应该是变成了 4 吧？</div><div><div>2021-11-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HelloBug</span></div></div><div>已提交读和可重复读本身就是互相冲突的，如果每次都能读取已经提交的数据，那重复读的时候，前后两次的数据就可能是不一样的，可重复读无法保证。如果利用文中说的第一次读的时候，将读到的数据放在一个缓存里，然后下一次读的时候，读取到的数据就和上一次一样，这样读取到的数据就不是已提交的。这两个特性不可能同时满足吧？</div><div><div>2021-11-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIAfpw5Mm3UNgMdju8V3WSbQiaHp4RxaG3JTz9Zx3dtL32Rib7zTVn6v7a1OF6KQcmQYnnILrSmee8g/132"></div></div><div><div><div><span>降措</span></div></div><div>多次执行 stm 事务时，偶尔会提示 etcdserver: mvcc: required revision is a future revision，一直没有发现是什么原因</div><div><div>2021-07-16</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132"></div></div><div><div><div><span>types</span></div></div><div>etcd 事务默认的隔离级别是什么？ 可重复读？</div><div><div>2021-03-03</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/30/85/14c2f16c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>石小</span></div></div><div>“由于 etcd 是批量提交写事务的，而读事务又是快照读，因此当 MVCC 写事务完成时，它需要更新 buffer，这样下一个读请求到达时，才能从 buffer 中获取到最新数据。”  会不会出站事务完成后更新 buffer 失败的情况？</div><div><div>2021-03-01</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>一步</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>可串行化的快照隔离：是每个事物都会生成一个新的快照吗？</div><div><div>2021-02-24</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/68/83/ecd4e4d6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>WGJ</span></div></div><div>老师，有个问题就是 在原子性和持久性介绍当中，假如在 WAF 日志已经提交成功了，执行事务的时候发生了 crash，这时候我理解的返回给 client 是失败的，那么当执行 WAF 重放日志的时候，该事务又成功了；换句话说，事务操作 返回给 client 结果 的时机是什么时候呢，是写 WAF 日志成功就返回呢，还是等待事务提交之后才返回呢</div><div><p>作者回复：返回给 client 的结果时机可参考 03 节写流程架构图中第 10 步，apply 成功的时候，会通过管道通知给相应的 goroutine,  告知写入结果，然后返回给 client。如果事务执行过程中 crash 了，这时 client 看到的应该是超时错误，超时意味着，可能写入成功，可能写入失败，业务自己重试时需要进行相应的检查、确保幂等性。</p></div><div><div>2021-02-19</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".s"><outline class="toc-level-h1" data-reactid=".s.0" style="width: 175px;"><active data-reactid=".s.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".s.0.1"><span data-reactid=".s.0.1.0">09 | 事务：如何安全地实现多 key 操作？</span></a></outline><outline class="toc-level-h2" data-reactid=".s.1" style="width: 165px;"><active data-reactid=".s.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".s.1.1"><span data-reactid=".s.1.1.0">事务特性初体验及 API</span></a></outline><outline class="toc-level-h2" data-reactid=".s.2" style="width: 165px;"><active data-reactid=".s.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".s.2.1"><span data-reactid=".s.2.1.0">整体流程</span></a></outline><outline class="toc-level-h2" data-reactid=".s.3" style="width: 165px;"><active data-reactid=".s.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".s.3.1"><span data-reactid=".s.3.1.0">事务 ACID 特性</span></a></outline><outline class="toc-level-h3" data-reactid=".s.4" style="width: 155px;"><active data-reactid=".s.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".s.4.1"><span data-reactid=".s.4.1.0">原子性与持久性</span></a></outline><outline class="toc-level-h4" data-reactid=".s.5" style="width: 145px;"><active data-reactid=".s.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".s.5.1"><span data-reactid=".s.5.1.0">T1 时间点</span></a></outline><outline class="toc-level-h4" data-reactid=".s.6" style="width: 145px;"><active data-reactid=".s.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".s.6.1"><span data-reactid=".s.6.1.0">T2 时间点</span></a></outline><outline class="toc-level-h3" data-reactid=".s.7" style="width: 155px;"><active data-reactid=".s.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".s.7.1"><span data-reactid=".s.7.1.0">一致性</span></a></outline><outline class="toc-level-h3" data-reactid=".s.8" style="width: 155px;"><active data-reactid=".s.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".s.8.1"><span data-reactid=".s.8.1.0">隔离性</span></a></outline><outline class="toc-level-h4" data-reactid=".s.9" style="width: 145px;"><active data-reactid=".s.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".s.9.1"><span data-reactid=".s.9.1.0">未提交读</span></a></outline><outline class="toc-level-h4" data-reactid=".s.a" style="width: 145px;"><active data-reactid=".s.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".s.a.1"><span data-reactid=".s.a.1.0">已提交读、可重复读</span></a></outline><outline class="toc-level-h4" data-reactid=".s.b" style="width: 145px;"><active data-reactid=".s.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".s.b.1"><span data-reactid=".s.b.1.0">串行化快照隔离</span></a></outline><outline class="toc-level-h3" data-reactid=".s.c" style="width: 155px;"><active data-reactid=".s.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".s.c.1"><span data-reactid=".s.c.1.0">转账案例应用</span></a></outline><outline class="toc-level-h2" data-reactid=".s.d" style="width: 165px;"><active data-reactid=".s.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".s.d.1"><span data-reactid=".s.d.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".s.e" style="width: 165px;"><active data-reactid=".s.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".s.e.1"><span data-reactid=".s.e.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".s.f" style="width: 165px;"><active data-reactid=".s.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".s.f.1"><span data-reactid=".s.f.1.0">精选留言 (16)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/341935" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>