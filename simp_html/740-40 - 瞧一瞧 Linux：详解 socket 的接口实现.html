
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 40 | 瞧一瞧 Linux：详解 socket 的接口实现</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>40 | 瞧一瞧 Linux：详解 socket 的接口实现</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我们通过动手写个驱动程序体会 Linux 驱动相关的内容。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">40 | 瞧一瞧 Linux：详解 socket 的接口实现</h1><div><span>LMOS</span> <span>2021-08-09</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a3/d2/a3aeb812f73d735204aeaf8829c3ecd2.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：9.07M</span><span> 时长：09:56</span></div></div><audio title="40 | 瞧一瞧Linux：详解socket的接口实现" src="https://res001.geekbang.org/media/audio/6e/8f/6e5ccedyy9e554980901876fc35a278f/ld/ld.m3u8" __idm_id__="958474"></audio></div><div><div><div><div data-slate-editor="true" data-key="10995" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="10996"><span data-slate-object="text" data-key="10997"><span data-slate-leaf="true" data-offset-key="10997:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10998"><span data-slate-object="text" data-key="10999"><span data-slate-leaf="true" data-offset-key="10999:0" data-first-offset="true"><span data-slate-string="true">上节课，我们一起了解了套接字的工作机制和数据结构，但套接字有哪些基本接口实现呢？相信学完这节课，你就能够解决这个问题了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11000"><span data-slate-object="text" data-key="11001"><span data-slate-leaf="true" data-offset-key="11001:0" data-first-offset="true"><span data-slate-string="true">今天我会和你探讨套接字从创建、协议接口注册与初始化过程，还会为你深入分析套接字系统，是怎样调用各个功能函数的。通过这节课，相信你可以学会基于套接字来编写网络应用程序。有了之前的基础，想理解这节课并不难，让我们正式开始吧。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11002" id="sr-toc-1"><span data-slate-object="text" data-key="11003"><span data-slate-leaf="true" data-offset-key="11003:0" data-first-offset="true"><span data-slate-string="true">套接字接口</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11004"><span data-slate-object="text" data-key="11005"><span data-slate-leaf="true" data-offset-key="11005:0" data-first-offset="true"><span data-slate-string="true">套接字接口最初是 BSD 操作系统的一部分，在应用层与 TCP/IP 协议栈之间接供了一套标准的独立于协议的接口。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11006"><span data-slate-object="text" data-key="11007"><span data-slate-leaf="true" data-offset-key="11007:0" data-first-offset="true"><span data-slate-string="true">Linux 内核实现的套接字接口，将 UNIX 的 “一切都是文件操作” 的概念应用在了网络连接访问上，让应用程序可以用常规文件操作 API 访问网络连接。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11008"><span data-slate-object="text" data-key="11009"><span data-slate-leaf="true" data-offset-key="11009:0" data-first-offset="true"><span data-slate-string="true">从 TCP/IP 协议栈的角度来看，传输层以上的都是应用程序的一部分，Linux 与传统的 UNIX 类似，TCP/IP 协议栈驻留在内核中，与内核的其他组件共享内存。传输层以上执行的网络功能，都是在用户地址空间完成的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11010"><span data-slate-object="text" data-key="11011"><span data-slate-leaf="true" data-offset-key="11011:0" data-first-offset="true"><span data-slate-string="true">Linux 使用内核套接字概念与用户空间套接字通信，这样可以让实现和操作变得更简单。Linux 提供了一套 API 和套接字数据结构，这些服务向下与内核接口，向上与用户空间接口，应用程序正是使用这一套 API 访问内核中的网络功能。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11012" id="sr-toc-2"><span data-slate-object="text" data-key="11013"><span data-slate-leaf="true" data-offset-key="11013:0" data-first-offset="true"><span data-slate-string="true">套接字的创建</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11014"><span data-slate-object="text" data-key="11015"><span data-slate-leaf="true" data-offset-key="11015:0" data-first-offset="true"><span data-slate-string="true">在应用程序使用 TCP/IP 协议栈的功能之前，我们必须调用套接字库函数 API 创建一个新的套接字，创建好以后，对库函数创建套接字的调用，就会转换为内核套接字创建函数的系统调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11016"><span data-slate-object="text" data-key="11017"><span data-slate-leaf="true" data-offset-key="11017:0" data-first-offset="true"><span data-slate-string="true">这时，完成的是通用套接字创建的初始化功能，跟具体的协议族并不相关。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11018"><span data-slate-object="text" data-key="11019"><span data-slate-leaf="true" data-offset-key="11019:0" data-first-offset="true"><span data-slate-string="true">这个过程具体是这样的，在应用程序中执行 socket 函数，socket 产生系统调用中断执行内核的套接字分路函数 sys_socketcall，在 sys_socketcall 套接字函数分路器中将调用传送到 sys_socket 函数，由 sys_socket 函数调用套接字的通用创建函数 sock_create。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11020"><span data-slate-object="text" data-key="11021"><span data-slate-leaf="true" data-offset-key="11021:0" data-first-offset="true"><span data-slate-string="true">sock_create 函数完成通用套接字创建、初始化任务后，再调用特定协议族的套接字创建函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11022"><span data-slate-object="text" data-key="11023"><span data-slate-leaf="true" data-offset-key="11023:0" data-first-offset="true"><span data-slate-string="true">这样描述你可能还没有直观感受，我特意画了图，帮你梳理 socket 创建的流程，你可以对照图片仔细体会调用过程。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="11024"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/31/ef/313d5d8c3b3224633fab2bd121006aef.jpg?wh=2655x2255"></div><div>socket 创建示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11025"><span data-slate-object="text" data-key="11026"><span data-slate-leaf="true" data-offset-key="11026:0" data-first-offset="true"><span data-slate-string="true">结合图解，我再用一个具体例子帮你加深理解，比如由 AF_INET 协议族的 inet_create 函数完成套接字与特定协议族的关联。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11027"><span data-slate-object="text" data-key="11028"><span data-slate-leaf="true" data-offset-key="11028:0" data-first-offset="true"><span data-slate-string="true">一个新的 struct socket 数据结构起始由 sock_create 函数创建，</span></span></span><span data-slate-object="text" data-key="11029"><span data-slate-leaf="true" data-offset-key="11029:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该函数直接调用 __sock_create 函数，__sock_create 函数的任务是为套接字预留需要的内存空间，由 sock_alloc 函数完成这项功能。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11030"><span data-slate-object="text" data-key="11031"><span data-slate-leaf="true" data-offset-key="11031:0" data-first-offset="true"><span data-slate-string="true">这个 sock_alloc 函数不仅会为 struct socket 数据结构实例预留空间，也会为 struct inode 数据结构实例分配需要的内存空间，这样可以使两个数据结构的实例相关联。__sock_create 函数代码如下。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="11032"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11033"><span data-slate-object="text" data-key="11034"><span data-slate-leaf="true" data-offset-key="11034:0" data-first-offset="true"><span data-slate-string="true">static </span></span></span><span data-slate-object="text" data-key="11035"><span data-slate-leaf="true" data-offset-key="11035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11036"><span data-slate-leaf="true" data-offset-key="11036:0" data-first-offset="true"><span data-slate-string="true"> __sock_create(</span></span></span><span data-slate-object="text" data-key="11037"><span data-slate-leaf="true" data-offset-key="11037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11038"><span data-slate-leaf="true" data-offset-key="11038:0" data-first-offset="true"><span data-slate-string="true"> net *net, </span></span></span><span data-slate-object="text" data-key="11039"><span data-slate-leaf="true" data-offset-key="11039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11040"><span data-slate-leaf="true" data-offset-key="11040:0" data-first-offset="true"><span data-slate-string="true"> family, </span></span></span><span data-slate-object="text" data-key="11041"><span data-slate-leaf="true" data-offset-key="11041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11042"><span data-slate-leaf="true" data-offset-key="11042:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11043"><span data-slate-leaf="true" data-offset-key="11043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11044"><span data-slate-leaf="true" data-offset-key="11044:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="11045"><span data-slate-leaf="true" data-offset-key="11045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11046"><span data-slate-leaf="true" data-offset-key="11046:0" data-first-offset="true"><span data-slate-string="true"> protocol,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11047"><span data-slate-object="text" data-key="11048"><span data-slate-leaf="true" data-offset-key="11048:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11049"><span data-slate-leaf="true" data-offset-key="11049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11050"><span data-slate-leaf="true" data-offset-key="11050:0" data-first-offset="true"><span data-slate-string="true"> socket **res, </span></span></span><span data-slate-object="text" data-key="11051"><span data-slate-leaf="true" data-offset-key="11051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11052"><span data-slate-leaf="true" data-offset-key="11052:0" data-first-offset="true"><span data-slate-string="true"> kern)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11053"><span data-slate-object="text" data-key="11054"><span data-slate-leaf="true" data-offset-key="11054:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11055"><span data-slate-object="text" data-key="11056"><span data-slate-leaf="true" data-offset-key="11056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11057"><span data-slate-leaf="true" data-offset-key="11057:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11058"><span data-slate-object="text" data-key="11059"><span data-slate-leaf="true" data-offset-key="11059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11060"><span data-slate-leaf="true" data-offset-key="11060:0" data-first-offset="true"><span data-slate-string="true"> socket *sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11061"><span data-slate-object="text" data-key="11062"><span data-slate-leaf="true" data-offset-key="11062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="11063"><span data-slate-leaf="true" data-offset-key="11063:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11064"><span data-slate-leaf="true" data-offset-key="11064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11065"><span data-slate-leaf="true" data-offset-key="11065:0" data-first-offset="true"><span data-slate-string="true"> net_proto_family *pf;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11066"><span data-slate-object="text" data-key="11067"><span data-slate-leaf="true" data-offset-key="11067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 首先检验是否支持协议族</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11068"><span data-slate-object="text" data-key="11069"><span data-slate-leaf="true" data-offset-key="11069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11070"><span data-slate-object="text" data-key="11071"><span data-slate-leaf="true" data-offset-key="11071:0" data-first-offset="true"><span data-slate-string="true">* 检查是否在内核支持的 socket 范围内</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11072"><span data-slate-object="text" data-key="11073"><span data-slate-leaf="true" data-offset-key="11073:0" data-first-offset="true"><span data-slate-string="true">*/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11074"><span data-slate-object="text" data-key="11075"><span data-slate-leaf="true" data-offset-key="11075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11076"><span data-slate-leaf="true" data-offset-key="11076:0" data-first-offset="true"><span data-slate-string="true"> (family &lt; </span></span></span><span data-slate-object="text" data-key="11077"><span data-slate-leaf="true" data-offset-key="11077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11078"><span data-slate-leaf="true" data-offset-key="11078:0" data-first-offset="true"><span data-slate-string="true"> || family &gt;= NPROTO)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11079"><span data-slate-object="text" data-key="11080"><span data-slate-leaf="true" data-offset-key="11080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11081"><span data-slate-leaf="true" data-offset-key="11081:0" data-first-offset="true"><span data-slate-string="true"> -EAFNOSUPPORT;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11082"><span data-slate-object="text" data-key="11083"><span data-slate-leaf="true" data-offset-key="11083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11084"><span data-slate-leaf="true" data-offset-key="11084:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="11085"><span data-slate-leaf="true" data-offset-key="11085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11086"><span data-slate-leaf="true" data-offset-key="11086:0" data-first-offset="true"><span data-slate-string="true"> &lt; </span></span></span><span data-slate-object="text" data-key="11087"><span data-slate-leaf="true" data-offset-key="11087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11088"><span data-slate-leaf="true" data-offset-key="11088:0" data-first-offset="true"><span data-slate-string="true"> || </span></span></span><span data-slate-object="text" data-key="11089"><span data-slate-leaf="true" data-offset-key="11089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11090"><span data-slate-leaf="true" data-offset-key="11090:0" data-first-offset="true"><span data-slate-string="true"> &gt;= SOCK_MAX)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11091"><span data-slate-object="text" data-key="11092"><span data-slate-leaf="true" data-offset-key="11092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11093"><span data-slate-leaf="true" data-offset-key="11093:0" data-first-offset="true"><span data-slate-string="true"> -EINVAL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11094"><span data-slate-object="text" data-key="11095"><span data-slate-leaf="true" data-offset-key="11095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11096"><span data-slate-object="text" data-key="11097"><span data-slate-leaf="true" data-offset-key="11097:0" data-first-offset="true"><span data-slate-string="true">* 为新的套接字分配内存空间，分配成功后返回新的指针</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11098"><span data-slate-object="text" data-key="11099"><span data-slate-leaf="true" data-offset-key="11099:0" data-first-offset="true"><span data-slate-string="true">*/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11100"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11101"><span data-slate-object="text" data-key="11102"><span data-slate-leaf="true" data-offset-key="11102:0" data-first-offset="true"><span data-slate-string="true">sock = sock_alloc();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11103"><span data-slate-object="text" data-key="11104"><span data-slate-leaf="true" data-offset-key="11104:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11105"><span data-slate-object="text" data-key="11106"><span data-slate-leaf="true" data-offset-key="11106:0" data-first-offset="true"><span data-slate-string="true">sock_alloc 函数如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="11107"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11108"><span data-slate-object="text" data-key="11109"><span data-slate-leaf="true" data-offset-key="11109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="11110"><span data-slate-leaf="true" data-offset-key="11110:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11111"><span data-slate-leaf="true" data-offset-key="11111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11112"><span data-slate-leaf="true" data-offset-key="11112:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11113"><span data-slate-leaf="true" data-offset-key="11113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">socket</span></span></span></span><span data-slate-object="text" data-key="11114"><span data-slate-leaf="true" data-offset-key="11114:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="11115"><span data-slate-leaf="true" data-offset-key="11115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sock_alloc</span></span></span></span><span data-slate-object="text" data-key="11116"><span data-slate-leaf="true" data-offset-key="11116:0" data-first-offset="true"><span data-slate-string="true">(void) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11117"><span data-slate-object="text" data-key="11118"><span data-slate-leaf="true" data-offset-key="11118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11119"><span data-slate-leaf="true" data-offset-key="11119:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11120"><span data-slate-leaf="true" data-offset-key="11120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inode</span></span></span></span><span data-slate-object="text" data-key="11121"><span data-slate-leaf="true" data-offset-key="11121:0" data-first-offset="true"><span data-slate-string="true"> *inode;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11122"><span data-slate-object="text" data-key="11123"><span data-slate-leaf="true" data-offset-key="11123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11124"><span data-slate-leaf="true" data-offset-key="11124:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11125"><span data-slate-leaf="true" data-offset-key="11125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">socket</span></span></span></span><span data-slate-object="text" data-key="11126"><span data-slate-leaf="true" data-offset-key="11126:0" data-first-offset="true"><span data-slate-string="true"> *sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11127"><span data-slate-object="text" data-key="11128"><span data-slate-leaf="true" data-offset-key="11128:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11129"><span data-slate-leaf="true" data-offset-key="11129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化一个可用的 inode 节点， 在 fs/inode.c 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11130"><span data-slate-object="text" data-key="11131"><span data-slate-leaf="true" data-offset-key="11131:0" data-first-offset="true"><span data-slate-string="true">    inode = </span></span></span><span data-slate-object="text" data-key="11132"><span data-slate-leaf="true" data-offset-key="11132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_inode</span></span></span></span><span data-slate-object="text" data-key="11133"><span data-slate-leaf="true" data-offset-key="11133:0" data-first-offset="true"><span data-slate-string="true">(sock_mnt</span></span></span><span data-slate-object="text" data-key="11134"><span data-slate-leaf="true" data-offset-key="11134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11135"><span data-slate-leaf="true" data-offset-key="11135:0" data-first-offset="true"><span data-slate-string="true">mnt_sb);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11136"><span data-slate-object="text" data-key="11137"><span data-slate-leaf="true" data-offset-key="11137:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11138"><span data-slate-leaf="true" data-offset-key="11138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11139"><span data-slate-leaf="true" data-offset-key="11139:0" data-first-offset="true"><span data-slate-string="true"> (!inode)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11140"><span data-slate-object="text" data-key="11141"><span data-slate-leaf="true" data-offset-key="11141:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11142"><span data-slate-leaf="true" data-offset-key="11142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11143"><span data-slate-leaf="true" data-offset-key="11143:0" data-first-offset="true"><span data-slate-string="true"> NULL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11144"><span data-slate-object="text" data-key="11145"><span data-slate-leaf="true" data-offset-key="11145:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11146"><span data-slate-leaf="true" data-offset-key="11146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际创建的是 socket_alloc 复合对象，因此要使用 SOCKET_I 宏从 inode 中取出关联的 socket 对象用于返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11147"><span data-slate-object="text" data-key="11148"><span data-slate-leaf="true" data-offset-key="11148:0" data-first-offset="true"><span data-slate-string="true">    sock = </span></span></span><span data-slate-object="text" data-key="11149"><span data-slate-leaf="true" data-offset-key="11149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SOCKET_I</span></span></span></span><span data-slate-object="text" data-key="11150"><span data-slate-leaf="true" data-offset-key="11150:0" data-first-offset="true"><span data-slate-string="true">(inode);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11151"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11152"><span data-slate-object="text" data-key="11153"><span data-slate-leaf="true" data-offset-key="11153:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11154"><span data-slate-leaf="true" data-offset-key="11154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kmemcheck_annotate_bitfield</span></span></span></span><span data-slate-object="text" data-key="11155"><span data-slate-leaf="true" data-offset-key="11155:0" data-first-offset="true"><span data-slate-string="true">(sock, </span></span></span><span data-slate-object="text" data-key="11156"><span data-slate-leaf="true" data-offset-key="11156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="11157"><span data-slate-leaf="true" data-offset-key="11157:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11158"><span data-slate-object="text" data-key="11159"><span data-slate-leaf="true" data-offset-key="11159:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11160"><span data-slate-leaf="true" data-offset-key="11160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 文件类型为套接字</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11161"><span data-slate-object="text" data-key="11162"><span data-slate-leaf="true" data-offset-key="11162:0" data-first-offset="true"><span data-slate-string="true">    inode</span></span></span><span data-slate-object="text" data-key="11163"><span data-slate-leaf="true" data-offset-key="11163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11164"><span data-slate-leaf="true" data-offset-key="11164:0" data-first-offset="true"><span data-slate-string="true">i_mode = S_IFSOCK | S_IRWXUGO;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11165"><span data-slate-object="text" data-key="11166"><span data-slate-leaf="true" data-offset-key="11166:0" data-first-offset="true"><span data-slate-string="true">    inode</span></span></span><span data-slate-object="text" data-key="11167"><span data-slate-leaf="true" data-offset-key="11167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11168"><span data-slate-leaf="true" data-offset-key="11168:0" data-first-offset="true"><span data-slate-string="true">i_uid = </span></span></span><span data-slate-object="text" data-key="11169"><span data-slate-leaf="true" data-offset-key="11169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">current_fsuid</span></span></span></span><span data-slate-object="text" data-key="11170"><span data-slate-leaf="true" data-offset-key="11170:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11171"><span data-slate-object="text" data-key="11172"><span data-slate-leaf="true" data-offset-key="11172:0" data-first-offset="true"><span data-slate-string="true">    inode</span></span></span><span data-slate-object="text" data-key="11173"><span data-slate-leaf="true" data-offset-key="11173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11174"><span data-slate-leaf="true" data-offset-key="11174:0" data-first-offset="true"><span data-slate-string="true">i_gid = </span></span></span><span data-slate-object="text" data-key="11175"><span data-slate-leaf="true" data-offset-key="11175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">current_fsgid</span></span></span></span><span data-slate-object="text" data-key="11176"><span data-slate-leaf="true" data-offset-key="11176:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11177"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11178"><span data-slate-object="text" data-key="11179"><span data-slate-leaf="true" data-offset-key="11179:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11180"><span data-slate-leaf="true" data-offset-key="11180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">percpu_add</span></span></span></span><span data-slate-object="text" data-key="11181"><span data-slate-leaf="true" data-offset-key="11181:0" data-first-offset="true"><span data-slate-string="true">(sockets_in_use, </span></span></span><span data-slate-object="text" data-key="11182"><span data-slate-leaf="true" data-offset-key="11182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="11183"><span data-slate-leaf="true" data-offset-key="11183:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11184"><span data-slate-object="text" data-key="11185"><span data-slate-leaf="true" data-offset-key="11185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11186"><span data-slate-leaf="true" data-offset-key="11186:0" data-first-offset="true"><span data-slate-string="true"> sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11187"><span data-slate-object="text" data-key="11188"><span data-slate-leaf="true" data-offset-key="11188:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11189"><span data-slate-object="text" data-key="11190"><span data-slate-leaf="true" data-offset-key="11190:0" data-first-offset="true"><span data-slate-string="true">当具体的协议与新套接字相连时，其内部状态的管理由协议自身维护。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11191"><span data-slate-object="text" data-key="11192"><span data-slate-leaf="true" data-offset-key="11192:0" data-first-offset="true"><span data-slate-string="true">现在，函数将 struct socket 数据结构的 struct proto_ops *ops 设置为 NULL。随后，当某个协议族中的协议成员的套接字创建函数被调用时，ops 将指向协议实例的操作函数。这时将 struct socket 数据结构的 flags 数据域设置为 0，创建时还没有任何标志需要设置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11193"><span data-slate-object="text" data-key="11194"><span data-slate-leaf="true" data-offset-key="11194:0" data-first-offset="true"><span data-slate-string="true">在之后的调用中，应用程序调用 send 或 receive 套接字库函数时会设置 flags 数据域。最后将其他两个数据域 sk 和 file 初始化为 NULL。sk 数据域随后会把由协议特有的套接字创建函数设置为指向内部套接字结构。file 将在调用 sock_ma_fd 函数时设置为分配的文件返回的指针。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11195"><span data-slate-object="text" data-key="11196"><span data-slate-leaf="true" data-offset-key="11196:0" data-first-offset="true"><span data-slate-string="true">文件指针用于访问打开套接字的虚拟文件系统的文件状态。在 sock_alloc 函数返回后，sock_create 函数调用协议族的套接字创建函数 err =pf-&gt;create (net, sock, protocol)，它通过访问 net_families 数组获取协议族的创建函数，对于 TCP/IP 协议栈，协议族将设置为 AF_INET。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11197" id="sr-toc-3"><span data-slate-object="text" data-key="11198"><span data-slate-leaf="true" data-offset-key="11198:0" data-first-offset="true"><span data-slate-string="true">套接字的绑定</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11199"><span data-slate-object="text" data-key="11200"><span data-slate-leaf="true" data-offset-key="11200:0" data-first-offset="true"><span data-slate-string="true">创建完套接字后，应用程序需要调用 sys_bind 函数把套接字和地址绑定起来，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11201"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11202"><span data-slate-object="text" data-key="11203"><span data-slate-leaf="true" data-offset-key="11203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asmlinkage </span></span></span></span><span data-slate-object="text" data-key="11204"><span data-slate-leaf="true" data-offset-key="11204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="11205"><span data-slate-leaf="true" data-offset-key="11205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11206"><span data-slate-leaf="true" data-offset-key="11206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysbind</span></span></span></span></span><span data-slate-object="text" data-key="11207"><span data-slate-leaf="true" data-offset-key="11207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="11208"><span data-slate-leaf="true" data-offset-key="11208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(bind, </span></span></span></span></span><span data-slate-object="text" data-key="11209"><span data-slate-leaf="true" data-offset-key="11209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="11210"><span data-slate-leaf="true" data-offset-key="11210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, fd, </span></span></span></span></span><span data-slate-object="text" data-key="11211"><span data-slate-leaf="true" data-offset-key="11211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="11212"><span data-slate-leaf="true" data-offset-key="11212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sockaddr __user *, umyaddr, </span></span></span></span></span><span data-slate-object="text" data-key="11213"><span data-slate-leaf="true" data-offset-key="11213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="11214"><span data-slate-leaf="true" data-offset-key="11214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, addrlen)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11215"><span data-slate-object="text" data-key="11216"><span data-slate-leaf="true" data-offset-key="11216:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11217"><span data-slate-object="text" data-key="11218"><span data-slate-leaf="true" data-offset-key="11218:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11219"><span data-slate-leaf="true" data-offset-key="11219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11220"><span data-slate-leaf="true" data-offset-key="11220:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11221"><span data-slate-leaf="true" data-offset-key="11221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">socket</span></span></span></span><span data-slate-object="text" data-key="11222"><span data-slate-leaf="true" data-offset-key="11222:0" data-first-offset="true"><span data-slate-string="true"> *sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11223"><span data-slate-object="text" data-key="11224"><span data-slate-leaf="true" data-offset-key="11224:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11225"><span data-slate-leaf="true" data-offset-key="11225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11226"><span data-slate-leaf="true" data-offset-key="11226:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11227"><span data-slate-leaf="true" data-offset-key="11227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockaddr_storage</span></span></span></span><span data-slate-object="text" data-key="11228"><span data-slate-leaf="true" data-offset-key="11228:0" data-first-offset="true"><span data-slate-string="true"> address;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11229"><span data-slate-object="text" data-key="11230"><span data-slate-leaf="true" data-offset-key="11230:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11231"><span data-slate-leaf="true" data-offset-key="11231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11232"><span data-slate-leaf="true" data-offset-key="11232:0" data-first-offset="true"><span data-slate-string="true"> err, fput_needed;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11233"><span data-slate-object="text" data-key="11234"><span data-slate-leaf="true" data-offset-key="11234:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11235"><span data-slate-object="text" data-key="11236"><span data-slate-leaf="true" data-offset-key="11236:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11237"><span data-slate-leaf="true" data-offset-key="11237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11238"><span data-slate-object="text" data-key="11239"><span data-slate-leaf="true" data-offset-key="11239:0" data-first-offset="true"><span data-slate-string="true">   * 获取 socket 实例。</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11240"><span data-slate-object="text" data-key="11241"><span data-slate-leaf="true" data-offset-key="11241:0" data-first-offset="true"><span data-slate-string="true">   */</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11242"><span data-slate-object="text" data-key="11243"><span data-slate-leaf="true" data-offset-key="11243:0" data-first-offset="true"><span data-slate-string="true">  sock = </span></span></span><span data-slate-object="text" data-key="11244"><span data-slate-leaf="true" data-offset-key="11244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockfd_lookup_light</span></span></span></span><span data-slate-object="text" data-key="11245"><span data-slate-leaf="true" data-offset-key="11245:0" data-first-offset="true"><span data-slate-string="true">(fd, &amp;err, &amp;fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11246"><span data-slate-object="text" data-key="11247"><span data-slate-leaf="true" data-offset-key="11247:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11248"><span data-slate-leaf="true" data-offset-key="11248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11249"><span data-slate-leaf="true" data-offset-key="11249:0" data-first-offset="true"><span data-slate-string="true"> (sock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11250"><span data-slate-object="text" data-key="11251"><span data-slate-leaf="true" data-offset-key="11251:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="11252"><span data-slate-leaf="true" data-offset-key="11252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">move_addr_to_kernel</span></span></span></span><span data-slate-object="text" data-key="11253"><span data-slate-leaf="true" data-offset-key="11253:0" data-first-offset="true"><span data-slate-string="true">(umyaddr, addrlen, (</span></span></span><span data-slate-object="text" data-key="11254"><span data-slate-leaf="true" data-offset-key="11254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11255"><span data-slate-leaf="true" data-offset-key="11255:0" data-first-offset="true"><span data-slate-string="true"> sockaddr *)&amp;address);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11256"><span data-slate-object="text" data-key="11257"><span data-slate-leaf="true" data-offset-key="11257:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11258"><span data-slate-leaf="true" data-offset-key="11258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11259"><span data-slate-leaf="true" data-offset-key="11259:0" data-first-offset="true"><span data-slate-string="true"> (err&gt;= </span></span></span><span data-slate-object="text" data-key="11260"><span data-slate-leaf="true" data-offset-key="11260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11261"><span data-slate-leaf="true" data-offset-key="11261:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11262"><span data-slate-object="text" data-key="11263"><span data-slate-leaf="true" data-offset-key="11263:0" data-first-offset="true"><span data-slate-string="true">      err = </span></span></span><span data-slate-object="text" data-key="11264"><span data-slate-leaf="true" data-offset-key="11264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">security_socket_bind</span></span></span></span><span data-slate-object="text" data-key="11265"><span data-slate-leaf="true" data-offset-key="11265:0" data-first-offset="true"><span data-slate-string="true">(sock,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11266"><span data-slate-object="text" data-key="11267"><span data-slate-leaf="true" data-offset-key="11267:0" data-first-offset="true"><span data-slate-string="true">               (</span></span></span><span data-slate-object="text" data-key="11268"><span data-slate-leaf="true" data-offset-key="11268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11269"><span data-slate-leaf="true" data-offset-key="11269:0" data-first-offset="true"><span data-slate-string="true"> sockaddr *)&amp;address,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11270"><span data-slate-object="text" data-key="11271"><span data-slate-leaf="true" data-offset-key="11271:0" data-first-offset="true"><span data-slate-string="true">               addrlen);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11272"><span data-slate-object="text" data-key="11273"><span data-slate-leaf="true" data-offset-key="11273:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11274"><span data-slate-leaf="true" data-offset-key="11274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/*</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11275"><span data-slate-object="text" data-key="11276"><span data-slate-leaf="true" data-offset-key="11276:0" data-first-offset="true"><span data-slate-string="true">       * 如果是 TCP 套接字，sock-&gt;ops 指向的是 inet_stream_ops，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11277"><span data-slate-object="text" data-key="11278"><span data-slate-leaf="true" data-offset-key="11278:0" data-first-offset="true"><span data-slate-string="true">       * sock-&gt;ops 是在 inet_create () 函数中初始化，所以 bind 接口</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11279"><span data-slate-object="text" data-key="11280"><span data-slate-leaf="true" data-offset-key="11280:0" data-first-offset="true"><span data-slate-string="true">       * 调用的是 inet_bind () 函数。</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11281"><span data-slate-object="text" data-key="11282"><span data-slate-leaf="true" data-offset-key="11282:0" data-first-offset="true"><span data-slate-string="true">       */</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11283"><span data-slate-object="text" data-key="11284"><span data-slate-leaf="true" data-offset-key="11284:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11285"><span data-slate-leaf="true" data-offset-key="11285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11286"><span data-slate-leaf="true" data-offset-key="11286:0" data-first-offset="true"><span data-slate-string="true"> (!err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11287"><span data-slate-object="text" data-key="11288"><span data-slate-leaf="true" data-offset-key="11288:0" data-first-offset="true"><span data-slate-string="true">        err = sock-&gt;ops-&gt;</span></span></span><span data-slate-object="text" data-key="11289"><span data-slate-leaf="true" data-offset-key="11289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bind</span></span></span></span><span data-slate-object="text" data-key="11290"><span data-slate-leaf="true" data-offset-key="11290:0" data-first-offset="true"><span data-slate-string="true">(sock,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11291"><span data-slate-object="text" data-key="11292"><span data-slate-leaf="true" data-offset-key="11292:0" data-first-offset="true"><span data-slate-string="true">                  (</span></span></span><span data-slate-object="text" data-key="11293"><span data-slate-leaf="true" data-offset-key="11293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11294"><span data-slate-leaf="true" data-offset-key="11294:0" data-first-offset="true"><span data-slate-string="true"> sockaddr *)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11295"><span data-slate-object="text" data-key="11296"><span data-slate-leaf="true" data-offset-key="11296:0" data-first-offset="true"><span data-slate-string="true">                  &amp;address, addrlen);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11297"><span data-slate-object="text" data-key="11298"><span data-slate-leaf="true" data-offset-key="11298:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11299"><span data-slate-object="text" data-key="11300"><span data-slate-leaf="true" data-offset-key="11300:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11301"><span data-slate-leaf="true" data-offset-key="11301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fput_light</span></span></span></span><span data-slate-object="text" data-key="11302"><span data-slate-leaf="true" data-offset-key="11302:0" data-first-offset="true"><span data-slate-string="true">(sock-&gt;file, fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11303"><span data-slate-object="text" data-key="11304"><span data-slate-leaf="true" data-offset-key="11304:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11305"><span data-slate-object="text" data-key="11306"><span data-slate-leaf="true" data-offset-key="11306:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11307"><span data-slate-leaf="true" data-offset-key="11307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11308"><span data-slate-leaf="true" data-offset-key="11308:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11309"><span data-slate-object="text" data-key="11310"><span data-slate-leaf="true" data-offset-key="11310:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11311"><span data-slate-object="text" data-key="11312"><span data-slate-leaf="true" data-offset-key="11312:0" data-first-offset="true"><span data-slate-string="true">结合代码，我们可以看到，sys_bind 函数首先会查找套接字对应的 socket 实例，调用 </span></span></span><span data-slate-object="text" data-key="11313"><span data-slate-leaf="true" data-offset-key="11313:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sockfd_lookup_light</span></span></span></span><span data-slate-object="text" data-key="11314"><span data-slate-leaf="true" data-offset-key="11314:0" data-first-offset="true"><span data-slate-string="true">。在绑定之前，将用户空间的地址拷贝到内核空间的缓冲区中，在拷贝过程中会检查用户传入的地址是否正确。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11315"><span data-slate-object="text" data-key="11316"><span data-slate-leaf="true" data-offset-key="11316:0" data-first-offset="true"><span data-slate-string="true">等上述的准备工作完成后，就会调用 </span></span></span><span data-slate-object="text" data-key="11317"><span data-slate-leaf="true" data-offset-key="11317:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">inet_bind 函数</span></span></span></span><span data-slate-object="text" data-key="11318"><span data-slate-leaf="true" data-offset-key="11318:0" data-first-offset="true"><span data-slate-string="true">来完成绑定操作。</span></span></span><span data-slate-object="text" data-key="11319"><span data-slate-leaf="true" data-offset-key="11319:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">inet_bind</span></span></span></span><span data-slate-object="text" data-key="11320"><span data-slate-leaf="true" data-offset-key="11320:0" data-first-offset="true"><span data-slate-string="true"> 函数代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="11321"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11322"><span data-slate-object="text" data-key="11323"><span data-slate-leaf="true" data-offset-key="11323:0" data-first-offset="true"><span data-slate-string="true">int </span></span></span><span data-slate-object="text" data-key="11324"><span data-slate-leaf="true" data-offset-key="11324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_bind</span></span></span></span><span data-slate-object="text" data-key="11325"><span data-slate-leaf="true" data-offset-key="11325:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="11326"><span data-slate-leaf="true" data-offset-key="11326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11327"><span data-slate-leaf="true" data-offset-key="11327:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11328"><span data-slate-leaf="true" data-offset-key="11328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">socket</span></span></span></span><span data-slate-object="text" data-key="11329"><span data-slate-leaf="true" data-offset-key="11329:0" data-first-offset="true"><span data-slate-string="true"> *sock, </span></span></span><span data-slate-object="text" data-key="11330"><span data-slate-leaf="true" data-offset-key="11330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11331"><span data-slate-leaf="true" data-offset-key="11331:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11332"><span data-slate-leaf="true" data-offset-key="11332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockaddr</span></span></span></span><span data-slate-object="text" data-key="11333"><span data-slate-leaf="true" data-offset-key="11333:0" data-first-offset="true"><span data-slate-string="true"> *uaddr, int addr_len)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11334"><span data-slate-object="text" data-key="11335"><span data-slate-leaf="true" data-offset-key="11335:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11336"><span data-slate-object="text" data-key="11337"><span data-slate-leaf="true" data-offset-key="11337:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11338"><span data-slate-leaf="true" data-offset-key="11338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11339"><span data-slate-leaf="true" data-offset-key="11339:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11340"><span data-slate-leaf="true" data-offset-key="11340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockaddr_in</span></span></span></span><span data-slate-object="text" data-key="11341"><span data-slate-leaf="true" data-offset-key="11341:0" data-first-offset="true"><span data-slate-string="true"> *addr = (</span></span></span><span data-slate-object="text" data-key="11342"><span data-slate-leaf="true" data-offset-key="11342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11343"><span data-slate-leaf="true" data-offset-key="11343:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11344"><span data-slate-leaf="true" data-offset-key="11344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockaddr_in</span></span></span></span><span data-slate-object="text" data-key="11345"><span data-slate-leaf="true" data-offset-key="11345:0" data-first-offset="true"><span data-slate-string="true"> *)uaddr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11346"><span data-slate-object="text" data-key="11347"><span data-slate-leaf="true" data-offset-key="11347:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11348"><span data-slate-leaf="true" data-offset-key="11348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11349"><span data-slate-leaf="true" data-offset-key="11349:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11350"><span data-slate-leaf="true" data-offset-key="11350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sock</span></span></span></span><span data-slate-object="text" data-key="11351"><span data-slate-leaf="true" data-offset-key="11351:0" data-first-offset="true"><span data-slate-string="true"> *sk = sock</span></span></span><span data-slate-object="text" data-key="11352"><span data-slate-leaf="true" data-offset-key="11352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11353"><span data-slate-leaf="true" data-offset-key="11353:0" data-first-offset="true"><span data-slate-string="true">sk;  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11354"><span data-slate-object="text" data-key="11355"><span data-slate-leaf="true" data-offset-key="11355:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11356"><span data-slate-leaf="true" data-offset-key="11356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11357"><span data-slate-leaf="true" data-offset-key="11357:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11358"><span data-slate-leaf="true" data-offset-key="11358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_sock</span></span></span></span><span data-slate-object="text" data-key="11359"><span data-slate-leaf="true" data-offset-key="11359:0" data-first-offset="true"><span data-slate-string="true"> *inet = </span></span></span><span data-slate-object="text" data-key="11360"><span data-slate-leaf="true" data-offset-key="11360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_sk</span></span></span></span><span data-slate-object="text" data-key="11361"><span data-slate-leaf="true" data-offset-key="11361:0" data-first-offset="true"><span data-slate-string="true">(sk);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11362"><span data-slate-object="text" data-key="11363"><span data-slate-leaf="true" data-offset-key="11363:0" data-first-offset="true"><span data-slate-string="true">    unsigned short snum;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11364"><span data-slate-object="text" data-key="11365"><span data-slate-leaf="true" data-offset-key="11365:0" data-first-offset="true"><span data-slate-string="true">    int chk_addr_ret;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11366"><span data-slate-object="text" data-key="11367"><span data-slate-leaf="true" data-offset-key="11367:0" data-first-offset="true"><span data-slate-string="true">    int err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11368"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11369"><span data-slate-object="text" data-key="11370"><span data-slate-leaf="true" data-offset-key="11370:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11371"><span data-slate-leaf="true" data-offset-key="11371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11372"><span data-slate-leaf="true" data-offset-key="11372:0" data-first-offset="true"><span data-slate-string="true"> (sk</span></span></span><span data-slate-object="text" data-key="11373"><span data-slate-leaf="true" data-offset-key="11373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11374"><span data-slate-leaf="true" data-offset-key="11374:0" data-first-offset="true"><span data-slate-string="true">sk_prot</span></span></span><span data-slate-object="text" data-key="11375"><span data-slate-leaf="true" data-offset-key="11375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11376"><span data-slate-leaf="true" data-offset-key="11376:0" data-first-offset="true"><span data-slate-string="true">bind) {</span></span></span><span data-slate-object="text" data-key="11377"><span data-slate-leaf="true" data-offset-key="11377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 如果传输层接口上实现了 bind 调用，则回调它。目前只有 SOCK_RAW 类型的传输层实现了该接口 raw_bind */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11378"><span data-slate-object="text" data-key="11379"><span data-slate-leaf="true" data-offset-key="11379:0" data-first-offset="true"><span data-slate-string="true">        err = sk</span></span></span><span data-slate-object="text" data-key="11380"><span data-slate-leaf="true" data-offset-key="11380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11381"><span data-slate-leaf="true" data-offset-key="11381:0" data-first-offset="true"><span data-slate-string="true">sk_prot</span></span></span><span data-slate-object="text" data-key="11382"><span data-slate-leaf="true" data-offset-key="11382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11383"><span data-slate-leaf="true" data-offset-key="11383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bind</span></span></span></span><span data-slate-object="text" data-key="11384"><span data-slate-leaf="true" data-offset-key="11384:0" data-first-offset="true"><span data-slate-string="true">(sk, uaddr, addr_len);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11385"><span data-slate-object="text" data-key="11386"><span data-slate-leaf="true" data-offset-key="11386:0" data-first-offset="true"><span data-slate-string="true">        goto out;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11387"><span data-slate-object="text" data-key="11388"><span data-slate-leaf="true" data-offset-key="11388:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11389"><span data-slate-object="text" data-key="11390"><span data-slate-leaf="true" data-offset-key="11390:0" data-first-offset="true"><span data-slate-string="true">    err = -EINVAL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11391"><span data-slate-object="text" data-key="11392"><span data-slate-leaf="true" data-offset-key="11392:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11393"><span data-slate-leaf="true" data-offset-key="11393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11394"><span data-slate-leaf="true" data-offset-key="11394:0" data-first-offset="true"><span data-slate-string="true"> (addr_len &lt; </span></span></span><span data-slate-object="text" data-key="11395"><span data-slate-leaf="true" data-offset-key="11395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="11396"><span data-slate-leaf="true" data-offset-key="11396:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="11397"><span data-slate-leaf="true" data-offset-key="11397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11398"><span data-slate-leaf="true" data-offset-key="11398:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11399"><span data-slate-leaf="true" data-offset-key="11399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockaddr_in</span></span></span></span><span data-slate-object="text" data-key="11400"><span data-slate-leaf="true" data-offset-key="11400:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11401"><span data-slate-object="text" data-key="11402"><span data-slate-leaf="true" data-offset-key="11402:0" data-first-offset="true"><span data-slate-string="true">        goto out;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11403"><span data-slate-object="text" data-key="11404"><span data-slate-leaf="true" data-offset-key="11404:0" data-first-offset="true"><span data-slate-string="true">    err = -EADDRNOTAVAIL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11405"><span data-slate-object="text" data-key="11406"><span data-slate-leaf="true" data-offset-key="11406:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11407"><span data-slate-leaf="true" data-offset-key="11407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11408"><span data-slate-leaf="true" data-offset-key="11408:0" data-first-offset="true"><span data-slate-string="true"> (!sysctl_ip_nonlocal_bind &amp;&amp;</span></span></span><span data-slate-object="text" data-key="11409"><span data-slate-leaf="true" data-offset-key="11409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 必须绑定到本地接口的地址 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11410"><span data-slate-object="text" data-key="11411"><span data-slate-leaf="true" data-offset-key="11411:0" data-first-offset="true"><span data-slate-string="true">        !inet</span></span></span><span data-slate-object="text" data-key="11412"><span data-slate-leaf="true" data-offset-key="11412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11413"><span data-slate-leaf="true" data-offset-key="11413:0" data-first-offset="true"><span data-slate-string="true">freebind &amp;&amp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11414"><span data-slate-object="text" data-key="11415"><span data-slate-leaf="true" data-offset-key="11415:0" data-first-offset="true"><span data-slate-string="true">        addr</span></span></span><span data-slate-object="text" data-key="11416"><span data-slate-leaf="true" data-offset-key="11416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11417"><span data-slate-leaf="true" data-offset-key="11417:0" data-first-offset="true"><span data-slate-string="true">sin_addr.s_addr != INADDR_ANY &amp;&amp;</span></span></span><span data-slate-object="text" data-key="11418"><span data-slate-leaf="true" data-offset-key="11418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 绑定地址不合法 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11419"><span data-slate-object="text" data-key="11420"><span data-slate-leaf="true" data-offset-key="11420:0" data-first-offset="true"><span data-slate-string="true">        chk_addr_ret != RTN_LOCAL &amp;&amp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11421"><span data-slate-object="text" data-key="11422"><span data-slate-leaf="true" data-offset-key="11422:0" data-first-offset="true"><span data-slate-string="true">        chk_addr_ret != RTN_MULTICAST &amp;&amp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11423"><span data-slate-object="text" data-key="11424"><span data-slate-leaf="true" data-offset-key="11424:0" data-first-offset="true"><span data-slate-string="true">        chk_addr_ret != RTN_BROADCAST)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11425"><span data-slate-object="text" data-key="11426"><span data-slate-leaf="true" data-offset-key="11426:0" data-first-offset="true"><span data-slate-string="true">        goto out;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11427"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11428"><span data-slate-object="text" data-key="11429"><span data-slate-leaf="true" data-offset-key="11429:0" data-first-offset="true"><span data-slate-string="true">    snum = </span></span></span><span data-slate-object="text" data-key="11430"><span data-slate-leaf="true" data-offset-key="11430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ntohs</span></span></span></span><span data-slate-object="text" data-key="11431"><span data-slate-leaf="true" data-offset-key="11431:0" data-first-offset="true"><span data-slate-string="true">(addr</span></span></span><span data-slate-object="text" data-key="11432"><span data-slate-leaf="true" data-offset-key="11432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11433"><span data-slate-leaf="true" data-offset-key="11433:0" data-first-offset="true"><span data-slate-string="true">sin_port);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11434"><span data-slate-object="text" data-key="11435"><span data-slate-leaf="true" data-offset-key="11435:0" data-first-offset="true"><span data-slate-string="true">    err = -EACCES;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11436"><span data-slate-object="text" data-key="11437"><span data-slate-leaf="true" data-offset-key="11437:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11438"><span data-slate-leaf="true" data-offset-key="11438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11439"><span data-slate-leaf="true" data-offset-key="11439:0" data-first-offset="true"><span data-slate-string="true"> (snum &amp;&amp; snum &lt; PROT_SOCK &amp;&amp; !</span></span></span><span data-slate-object="text" data-key="11440"><span data-slate-leaf="true" data-offset-key="11440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">capable</span></span></span></span><span data-slate-object="text" data-key="11441"><span data-slate-leaf="true" data-offset-key="11441:0" data-first-offset="true"><span data-slate-string="true">(CAP_NET_BIND_SERVICE))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11442"><span data-slate-object="text" data-key="11443"><span data-slate-leaf="true" data-offset-key="11443:0" data-first-offset="true"><span data-slate-string="true">        goto out;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11444"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11445"><span data-slate-object="text" data-key="11446"><span data-slate-leaf="true" data-offset-key="11446:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11447"><span data-slate-leaf="true" data-offset-key="11447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">lock_sock</span></span></span></span><span data-slate-object="text" data-key="11448"><span data-slate-leaf="true" data-offset-key="11448:0" data-first-offset="true"><span data-slate-string="true">(sk);</span></span></span><span data-slate-object="text" data-key="11449"><span data-slate-leaf="true" data-offset-key="11449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 对套接口进行加锁，因为后面要对其状态进行判断 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11450"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11451"><span data-slate-object="text" data-key="11452"><span data-slate-leaf="true" data-offset-key="11452:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11453"><span data-slate-leaf="true" data-offset-key="11453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* Check these errors (active socket, double bind). */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11454"><span data-slate-object="text" data-key="11455"><span data-slate-leaf="true" data-offset-key="11455:0" data-first-offset="true"><span data-slate-string="true">    err = -EINVAL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11456"><span data-slate-object="text" data-key="11457"><span data-slate-leaf="true" data-offset-key="11457:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11458"><span data-slate-leaf="true" data-offset-key="11458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/**</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11459"><span data-slate-object="text" data-key="11460"><span data-slate-leaf="true" data-offset-key="11460:0" data-first-offset="true"><span data-slate-string="true">     * 如果状态不为 CLOSE，表示套接口已经处于活动状态，不能再绑定</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11461"><span data-slate-object="text" data-key="11462"><span data-slate-leaf="true" data-offset-key="11462:0" data-first-offset="true"><span data-slate-string="true">     * 或者已经指定了本地端口号，也不能再绑定</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11463"><span data-slate-object="text" data-key="11464"><span data-slate-leaf="true" data-offset-key="11464:0" data-first-offset="true"><span data-slate-string="true">     */</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11465"><span data-slate-object="text" data-key="11466"><span data-slate-leaf="true" data-offset-key="11466:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11467"><span data-slate-leaf="true" data-offset-key="11467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11468"><span data-slate-leaf="true" data-offset-key="11468:0" data-first-offset="true"><span data-slate-string="true"> (sk</span></span></span><span data-slate-object="text" data-key="11469"><span data-slate-leaf="true" data-offset-key="11469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11470"><span data-slate-leaf="true" data-offset-key="11470:0" data-first-offset="true"><span data-slate-string="true">sk_state != TCP_CLOSE || inet</span></span></span><span data-slate-object="text" data-key="11471"><span data-slate-leaf="true" data-offset-key="11471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11472"><span data-slate-leaf="true" data-offset-key="11472:0" data-first-offset="true"><span data-slate-string="true">num)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11473"><span data-slate-object="text" data-key="11474"><span data-slate-leaf="true" data-offset-key="11474:0" data-first-offset="true"><span data-slate-string="true">        goto out_release_sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11475"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11476"><span data-slate-object="text" data-key="11477"><span data-slate-leaf="true" data-offset-key="11477:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11478"><span data-slate-leaf="true" data-offset-key="11478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 设置地址到传输控制块中 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11479"><span data-slate-object="text" data-key="11480"><span data-slate-leaf="true" data-offset-key="11480:0" data-first-offset="true"><span data-slate-string="true">    inet</span></span></span><span data-slate-object="text" data-key="11481"><span data-slate-leaf="true" data-offset-key="11481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11482"><span data-slate-leaf="true" data-offset-key="11482:0" data-first-offset="true"><span data-slate-string="true">rcv_saddr = inet</span></span></span><span data-slate-object="text" data-key="11483"><span data-slate-leaf="true" data-offset-key="11483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11484"><span data-slate-leaf="true" data-offset-key="11484:0" data-first-offset="true"><span data-slate-string="true">saddr = addr</span></span></span><span data-slate-object="text" data-key="11485"><span data-slate-leaf="true" data-offset-key="11485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11486"><span data-slate-leaf="true" data-offset-key="11486:0" data-first-offset="true"><span data-slate-string="true">sin_addr.s_addr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11487"><span data-slate-object="text" data-key="11488"><span data-slate-leaf="true" data-offset-key="11488:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11489"><span data-slate-leaf="true" data-offset-key="11489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 如果是广播或者多播地址，则源地址使用设备地址。 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11490"><span data-slate-object="text" data-key="11491"><span data-slate-leaf="true" data-offset-key="11491:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11492"><span data-slate-leaf="true" data-offset-key="11492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11493"><span data-slate-leaf="true" data-offset-key="11493:0" data-first-offset="true"><span data-slate-string="true"> (chk_addr_ret == RTN_MULTICAST || chk_addr_ret == RTN_BROADCAST)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11494"><span data-slate-object="text" data-key="11495"><span data-slate-leaf="true" data-offset-key="11495:0" data-first-offset="true"><span data-slate-string="true">        inet</span></span></span><span data-slate-object="text" data-key="11496"><span data-slate-leaf="true" data-offset-key="11496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11497"><span data-slate-leaf="true" data-offset-key="11497:0" data-first-offset="true"><span data-slate-string="true">saddr = </span></span></span><span data-slate-object="text" data-key="11498"><span data-slate-leaf="true" data-offset-key="11498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11499"><span data-slate-leaf="true" data-offset-key="11499:0" data-first-offset="true"><span data-slate-string="true">;  </span></span></span><span data-slate-object="text" data-key="11500"><span data-slate-leaf="true" data-offset-key="11500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* Use device */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11501"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11502"><span data-slate-object="text" data-key="11503"><span data-slate-leaf="true" data-offset-key="11503:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11504"><span data-slate-leaf="true" data-offset-key="11504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 调用传输层的 get_port 来进行地址绑定。如 tcp_v4_get_port 或 udp_v4_get_port */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11505"><span data-slate-object="text" data-key="11506"><span data-slate-leaf="true" data-offset-key="11506:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11507"><span data-slate-leaf="true" data-offset-key="11507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11508"><span data-slate-leaf="true" data-offset-key="11508:0" data-first-offset="true"><span data-slate-string="true"> (sk</span></span></span><span data-slate-object="text" data-key="11509"><span data-slate-leaf="true" data-offset-key="11509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11510"><span data-slate-leaf="true" data-offset-key="11510:0" data-first-offset="true"><span data-slate-string="true">sk_prot</span></span></span><span data-slate-object="text" data-key="11511"><span data-slate-leaf="true" data-offset-key="11511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11512"><span data-slate-leaf="true" data-offset-key="11512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get_port</span></span></span></span><span data-slate-object="text" data-key="11513"><span data-slate-leaf="true" data-offset-key="11513:0" data-first-offset="true"><span data-slate-string="true">(sk, snum)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11514"><span data-slate-object="text" data-key="11515"><span data-slate-leaf="true" data-offset-key="11515:0" data-first-offset="true"><span data-slate-string="true">        …</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11516"><span data-slate-object="text" data-key="11517"><span data-slate-leaf="true" data-offset-key="11517:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11518"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11519"><span data-slate-object="text" data-key="11520"><span data-slate-leaf="true" data-offset-key="11520:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11521"><span data-slate-leaf="true" data-offset-key="11521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 设置标志，表示已经绑定了本地地址和端口 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11522"><span data-slate-object="text" data-key="11523"><span data-slate-leaf="true" data-offset-key="11523:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11524"><span data-slate-leaf="true" data-offset-key="11524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11525"><span data-slate-leaf="true" data-offset-key="11525:0" data-first-offset="true"><span data-slate-string="true"> (inet</span></span></span><span data-slate-object="text" data-key="11526"><span data-slate-leaf="true" data-offset-key="11526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11527"><span data-slate-leaf="true" data-offset-key="11527:0" data-first-offset="true"><span data-slate-string="true">rcv_saddr)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11528"><span data-slate-object="text" data-key="11529"><span data-slate-leaf="true" data-offset-key="11529:0" data-first-offset="true"><span data-slate-string="true">        sk</span></span></span><span data-slate-object="text" data-key="11530"><span data-slate-leaf="true" data-offset-key="11530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11531"><span data-slate-leaf="true" data-offset-key="11531:0" data-first-offset="true"><span data-slate-string="true">sk_userlocks |= SOCK_BINDADDR_LOCK;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11532"><span data-slate-object="text" data-key="11533"><span data-slate-leaf="true" data-offset-key="11533:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11534"><span data-slate-leaf="true" data-offset-key="11534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11535"><span data-slate-leaf="true" data-offset-key="11535:0" data-first-offset="true"><span data-slate-string="true"> (snum)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11536"><span data-slate-object="text" data-key="11537"><span data-slate-leaf="true" data-offset-key="11537:0" data-first-offset="true"><span data-slate-string="true">        sk</span></span></span><span data-slate-object="text" data-key="11538"><span data-slate-leaf="true" data-offset-key="11538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11539"><span data-slate-leaf="true" data-offset-key="11539:0" data-first-offset="true"><span data-slate-string="true">sk_userlocks |= SOCK_BINDPORT_LOCK;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11540"><span data-slate-object="text" data-key="11541"><span data-slate-leaf="true" data-offset-key="11541:0" data-first-offset="true"><span data-slate-string="true">    inet</span></span></span><span data-slate-object="text" data-key="11542"><span data-slate-leaf="true" data-offset-key="11542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11543"><span data-slate-leaf="true" data-offset-key="11543:0" data-first-offset="true"><span data-slate-string="true">sport = </span></span></span><span data-slate-object="text" data-key="11544"><span data-slate-leaf="true" data-offset-key="11544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">htons</span></span></span></span><span data-slate-object="text" data-key="11545"><span data-slate-leaf="true" data-offset-key="11545:0" data-first-offset="true"><span data-slate-string="true">(inet</span></span></span><span data-slate-object="text" data-key="11546"><span data-slate-leaf="true" data-offset-key="11546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11547"><span data-slate-leaf="true" data-offset-key="11547:0" data-first-offset="true"><span data-slate-string="true">num);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11548"><span data-slate-object="text" data-key="11549"><span data-slate-leaf="true" data-offset-key="11549:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11550"><span data-slate-leaf="true" data-offset-key="11550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 还没有连接到对方，清除远端地址和端口 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11551"><span data-slate-object="text" data-key="11552"><span data-slate-leaf="true" data-offset-key="11552:0" data-first-offset="true"><span data-slate-string="true">    inet</span></span></span><span data-slate-object="text" data-key="11553"><span data-slate-leaf="true" data-offset-key="11553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11554"><span data-slate-leaf="true" data-offset-key="11554:0" data-first-offset="true"><span data-slate-string="true">daddr = </span></span></span><span data-slate-object="text" data-key="11555"><span data-slate-leaf="true" data-offset-key="11555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11556"><span data-slate-leaf="true" data-offset-key="11556:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11557"><span data-slate-object="text" data-key="11558"><span data-slate-leaf="true" data-offset-key="11558:0" data-first-offset="true"><span data-slate-string="true">    inet</span></span></span><span data-slate-object="text" data-key="11559"><span data-slate-leaf="true" data-offset-key="11559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="11560"><span data-slate-leaf="true" data-offset-key="11560:0" data-first-offset="true"><span data-slate-string="true">dport = </span></span></span><span data-slate-object="text" data-key="11561"><span data-slate-leaf="true" data-offset-key="11561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11562"><span data-slate-leaf="true" data-offset-key="11562:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11563"><span data-slate-object="text" data-key="11564"><span data-slate-leaf="true" data-offset-key="11564:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11565"><span data-slate-leaf="true" data-offset-key="11565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 清除路由缓存 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11566"><span data-slate-object="text" data-key="11567"><span data-slate-leaf="true" data-offset-key="11567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11568"><span data-slate-leaf="true" data-offset-key="11568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sk_dst_reset</span></span></span></span><span data-slate-object="text" data-key="11569"><span data-slate-leaf="true" data-offset-key="11569:0" data-first-offset="true"><span data-slate-string="true">(sk);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11570"><span data-slate-object="text" data-key="11571"><span data-slate-leaf="true" data-offset-key="11571:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="11572"><span data-slate-leaf="true" data-offset-key="11572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11573"><span data-slate-leaf="true" data-offset-key="11573:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11574"><span data-slate-object="text" data-key="11575"><span data-slate-leaf="true" data-offset-key="11575:0" data-first-offset="true"><span data-slate-string="true">out_release_sock:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11576"><span data-slate-object="text" data-key="11577"><span data-slate-leaf="true" data-offset-key="11577:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11578"><span data-slate-leaf="true" data-offset-key="11578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">release_sock</span></span></span></span><span data-slate-object="text" data-key="11579"><span data-slate-leaf="true" data-offset-key="11579:0" data-first-offset="true"><span data-slate-string="true">(sk);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11580"><span data-slate-object="text" data-key="11581"><span data-slate-leaf="true" data-offset-key="11581:0" data-first-offset="true"><span data-slate-string="true">out:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11582"><span data-slate-object="text" data-key="11583"><span data-slate-leaf="true" data-offset-key="11583:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11584"><span data-slate-leaf="true" data-offset-key="11584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11585"><span data-slate-leaf="true" data-offset-key="11585:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11586"><span data-slate-object="text" data-key="11587"><span data-slate-leaf="true" data-offset-key="11587:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11588" id="sr-toc-4"><span data-slate-object="text" data-key="11589"><span data-slate-leaf="true" data-offset-key="11589:0" data-first-offset="true"><span data-slate-string="true">主动连接</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11590"><span data-slate-object="text" data-key="11591"><span data-slate-leaf="true" data-offset-key="11591:0" data-first-offset="true"><span data-slate-string="true">因为应用程序处理的是面向连接的网络服务（SOCK_STREAM 或 SOCK_SEQPACKET），所以在交换数据之前，需要在请求连接服务的进程（客户）与提供服务的进程（服务器）之间建立连接。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11592"><span data-slate-object="text" data-key="11593"><span data-slate-leaf="true" data-offset-key="11593:0" data-first-offset="true"><span data-slate-string="true">当应用程序调用 </span></span></span><span data-slate-object="text" data-key="11594"><span data-slate-leaf="true" data-offset-key="11594:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">connect</span></span></span></span><span data-slate-object="text" data-key="11595"><span data-slate-leaf="true" data-offset-key="11595:0" data-first-offset="true"><span data-slate-string="true"> 函数发出连接请求时，内核会启动函数 </span></span></span><span data-slate-object="text" data-key="11596"><span data-slate-leaf="true" data-offset-key="11596:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_connect</span></span></span></span><span data-slate-object="text" data-key="11597"><span data-slate-leaf="true" data-offset-key="11597:0" data-first-offset="true"><span data-slate-string="true">，详细代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11598"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11599"><span data-slate-object="text" data-key="11600"><span data-slate-leaf="true" data-offset-key="11600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11601"><span data-slate-leaf="true" data-offset-key="11601:0" data-first-offset="true"><span data-slate-string="true"> __sys_connect(</span></span></span><span data-slate-object="text" data-key="11602"><span data-slate-leaf="true" data-offset-key="11602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11603"><span data-slate-leaf="true" data-offset-key="11603:0" data-first-offset="true"><span data-slate-string="true"> fd, </span></span></span><span data-slate-object="text" data-key="11604"><span data-slate-leaf="true" data-offset-key="11604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11605"><span data-slate-leaf="true" data-offset-key="11605:0" data-first-offset="true"><span data-slate-string="true"> sockaddr __user *uservaddr, </span></span></span><span data-slate-object="text" data-key="11606"><span data-slate-leaf="true" data-offset-key="11606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11607"><span data-slate-leaf="true" data-offset-key="11607:0" data-first-offset="true"><span data-slate-string="true"> addrlen)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11608"><span data-slate-object="text" data-key="11609"><span data-slate-leaf="true" data-offset-key="11609:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11610"><span data-slate-object="text" data-key="11611"><span data-slate-leaf="true" data-offset-key="11611:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11612"><span data-slate-leaf="true" data-offset-key="11612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11613"><span data-slate-leaf="true" data-offset-key="11613:0" data-first-offset="true"><span data-slate-string="true"> ret = -EBADF;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11614"><span data-slate-object="text" data-key="11615"><span data-slate-leaf="true" data-offset-key="11615:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11616"><span data-slate-leaf="true" data-offset-key="11616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11617"><span data-slate-leaf="true" data-offset-key="11617:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11618"><span data-slate-leaf="true" data-offset-key="11618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fd</span></span></span></span><span data-slate-object="text" data-key="11619"><span data-slate-leaf="true" data-offset-key="11619:0" data-first-offset="true"><span data-slate-string="true"> f;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11620"><span data-slate-object="text" data-key="11621"><span data-slate-leaf="true" data-offset-key="11621:0" data-first-offset="true"><span data-slate-string="true">  f = </span></span></span><span data-slate-object="text" data-key="11622"><span data-slate-leaf="true" data-offset-key="11622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fdget</span></span></span></span><span data-slate-object="text" data-key="11623"><span data-slate-leaf="true" data-offset-key="11623:0" data-first-offset="true"><span data-slate-string="true">(fd);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11624"><span data-slate-object="text" data-key="11625"><span data-slate-leaf="true" data-offset-key="11625:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11626"><span data-slate-leaf="true" data-offset-key="11626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11627"><span data-slate-leaf="true" data-offset-key="11627:0" data-first-offset="true"><span data-slate-string="true"> (f.file) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11628"><span data-slate-object="text" data-key="11629"><span data-slate-leaf="true" data-offset-key="11629:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11630"><span data-slate-leaf="true" data-offset-key="11630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11631"><span data-slate-leaf="true" data-offset-key="11631:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11632"><span data-slate-leaf="true" data-offset-key="11632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockaddr_storage</span></span></span></span><span data-slate-object="text" data-key="11633"><span data-slate-leaf="true" data-offset-key="11633:0" data-first-offset="true"><span data-slate-string="true"> address;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11634"><span data-slate-object="text" data-key="11635"><span data-slate-leaf="true" data-offset-key="11635:0" data-first-offset="true"><span data-slate-string="true">    ret = </span></span></span><span data-slate-object="text" data-key="11636"><span data-slate-leaf="true" data-offset-key="11636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">move_addr_to_kernel</span></span></span></span><span data-slate-object="text" data-key="11637"><span data-slate-leaf="true" data-offset-key="11637:0" data-first-offset="true"><span data-slate-string="true">(uservaddr, addrlen, &amp;address);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11638"><span data-slate-object="text" data-key="11639"><span data-slate-leaf="true" data-offset-key="11639:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11640"><span data-slate-leaf="true" data-offset-key="11640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11641"><span data-slate-leaf="true" data-offset-key="11641:0" data-first-offset="true"><span data-slate-string="true"> (!ret)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11642"><span data-slate-object="text" data-key="11643"><span data-slate-leaf="true" data-offset-key="11643:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="11644"><span data-slate-leaf="true" data-offset-key="11644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用__sys_connect_file</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11645"><span data-slate-object="text" data-key="11646"><span data-slate-leaf="true" data-offset-key="11646:0" data-first-offset="true"><span data-slate-string="true">      ret = __sys_connect_file(f.file, &amp;address, addrlen, </span></span></span><span data-slate-object="text" data-key="11647"><span data-slate-leaf="true" data-offset-key="11647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11648"><span data-slate-leaf="true" data-offset-key="11648:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11649"><span data-slate-object="text" data-key="11650"><span data-slate-leaf="true" data-offset-key="11650:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11651"><span data-slate-leaf="true" data-offset-key="11651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fdput</span></span></span></span><span data-slate-object="text" data-key="11652"><span data-slate-leaf="true" data-offset-key="11652:0" data-first-offset="true"><span data-slate-string="true">(f);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11653"><span data-slate-object="text" data-key="11654"><span data-slate-leaf="true" data-offset-key="11654:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11655"><span data-slate-object="text" data-key="11656"><span data-slate-leaf="true" data-offset-key="11656:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11657"><span data-slate-leaf="true" data-offset-key="11657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11658"><span data-slate-leaf="true" data-offset-key="11658:0" data-first-offset="true"><span data-slate-string="true"> ret;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11659"><span data-slate-object="text" data-key="11660"><span data-slate-leaf="true" data-offset-key="11660:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11661"><span data-slate-object="text" data-key="11662"><span data-slate-leaf="true" data-offset-key="11662:0" data-first-offset="true"><span data-slate-string="true">连接成功会返回 socket 的描述符，否则会返回一个错误码。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11663" id="sr-toc-5"><span data-slate-object="text" data-key="11664"><span data-slate-leaf="true" data-offset-key="11664:0" data-first-offset="true"><span data-slate-string="true">监听套接字</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11665"><span data-slate-object="text" data-key="11666"><span data-slate-leaf="true" data-offset-key="11666:0" data-first-offset="true"><span data-slate-string="true">调用 listen 函数时，应用程序触发内核的 </span></span></span><span data-slate-object="text" data-key="11667"><span data-slate-leaf="true" data-offset-key="11667:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_listen</span></span></span></span><span data-slate-object="text" data-key="11668"><span data-slate-leaf="true" data-offset-key="11668:0" data-first-offset="true"><span data-slate-string="true"> 函数，把套接字描述符 fd 对应的套接字设置为监听模式，观察连接请求。详细代码你可以看看后面的内容。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="11669"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11670"><span data-slate-object="text" data-key="11671"><span data-slate-leaf="true" data-offset-key="11671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11672"><span data-slate-leaf="true" data-offset-key="11672:0" data-first-offset="true"><span data-slate-string="true"> __sys_listen(</span></span></span><span data-slate-object="text" data-key="11673"><span data-slate-leaf="true" data-offset-key="11673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11674"><span data-slate-leaf="true" data-offset-key="11674:0" data-first-offset="true"><span data-slate-string="true"> fd, </span></span></span><span data-slate-object="text" data-key="11675"><span data-slate-leaf="true" data-offset-key="11675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11676"><span data-slate-leaf="true" data-offset-key="11676:0" data-first-offset="true"><span data-slate-string="true"> backlog)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11677"><span data-slate-object="text" data-key="11678"><span data-slate-leaf="true" data-offset-key="11678:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11679"><span data-slate-object="text" data-key="11680"><span data-slate-leaf="true" data-offset-key="11680:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11681"><span data-slate-leaf="true" data-offset-key="11681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11682"><span data-slate-leaf="true" data-offset-key="11682:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11683"><span data-slate-leaf="true" data-offset-key="11683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">socket</span></span></span></span><span data-slate-object="text" data-key="11684"><span data-slate-leaf="true" data-offset-key="11684:0" data-first-offset="true"><span data-slate-string="true"> *sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11685"><span data-slate-object="text" data-key="11686"><span data-slate-leaf="true" data-offset-key="11686:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11687"><span data-slate-leaf="true" data-offset-key="11687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11688"><span data-slate-leaf="true" data-offset-key="11688:0" data-first-offset="true"><span data-slate-string="true"> err, fput_needed;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11689"><span data-slate-object="text" data-key="11690"><span data-slate-leaf="true" data-offset-key="11690:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11691"><span data-slate-leaf="true" data-offset-key="11691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11692"><span data-slate-leaf="true" data-offset-key="11692:0" data-first-offset="true"><span data-slate-string="true"> somaxconn;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11693"><span data-slate-object="text" data-key="11694"><span data-slate-leaf="true" data-offset-key="11694:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11695"><span data-slate-leaf="true" data-offset-key="11695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过套接字描述符找到 struct socket</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11696"><span data-slate-object="text" data-key="11697"><span data-slate-leaf="true" data-offset-key="11697:0" data-first-offset="true"><span data-slate-string="true">  sock = </span></span></span><span data-slate-object="text" data-key="11698"><span data-slate-leaf="true" data-offset-key="11698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockfd_lookup_light</span></span></span></span><span data-slate-object="text" data-key="11699"><span data-slate-leaf="true" data-offset-key="11699:0" data-first-offset="true"><span data-slate-string="true">(fd, &amp;err, &amp;fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11700"><span data-slate-object="text" data-key="11701"><span data-slate-leaf="true" data-offset-key="11701:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11702"><span data-slate-leaf="true" data-offset-key="11702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11703"><span data-slate-leaf="true" data-offset-key="11703:0" data-first-offset="true"><span data-slate-string="true"> (sock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11704"><span data-slate-object="text" data-key="11705"><span data-slate-leaf="true" data-offset-key="11705:0" data-first-offset="true"><span data-slate-string="true">    somaxconn = </span></span></span><span data-slate-object="text" data-key="11706"><span data-slate-leaf="true" data-offset-key="11706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sock_net</span></span></span></span><span data-slate-object="text" data-key="11707"><span data-slate-leaf="true" data-offset-key="11707:0" data-first-offset="true"><span data-slate-string="true">(sock-&gt;sk)-&gt;core.sysctl_somaxconn;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11708"><span data-slate-object="text" data-key="11709"><span data-slate-leaf="true" data-offset-key="11709:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11710"><span data-slate-leaf="true" data-offset-key="11710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11711"><span data-slate-leaf="true" data-offset-key="11711:0" data-first-offset="true"><span data-slate-string="true"> ((</span></span></span><span data-slate-object="text" data-key="11712"><span data-slate-leaf="true" data-offset-key="11712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="11713"><span data-slate-leaf="true" data-offset-key="11713:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11714"><span data-slate-leaf="true" data-offset-key="11714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11715"><span data-slate-leaf="true" data-offset-key="11715:0" data-first-offset="true"><span data-slate-string="true">)backlog &gt; somaxconn)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11716"><span data-slate-object="text" data-key="11717"><span data-slate-leaf="true" data-offset-key="11717:0" data-first-offset="true"><span data-slate-string="true">      backlog = somaxconn;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11718"><span data-slate-object="text" data-key="11719"><span data-slate-leaf="true" data-offset-key="11719:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="11720"><span data-slate-leaf="true" data-offset-key="11720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">security_socket_listen</span></span></span></span><span data-slate-object="text" data-key="11721"><span data-slate-leaf="true" data-offset-key="11721:0" data-first-offset="true"><span data-slate-string="true">(sock, backlog);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11722"><span data-slate-object="text" data-key="11723"><span data-slate-leaf="true" data-offset-key="11723:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11724"><span data-slate-leaf="true" data-offset-key="11724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11725"><span data-slate-leaf="true" data-offset-key="11725:0" data-first-offset="true"><span data-slate-string="true"> (!err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11726"><span data-slate-object="text" data-key="11727"><span data-slate-leaf="true" data-offset-key="11727:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="11728"><span data-slate-leaf="true" data-offset-key="11728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据套接字类型调用监听函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11729"><span data-slate-object="text" data-key="11730"><span data-slate-leaf="true" data-offset-key="11730:0" data-first-offset="true"><span data-slate-string="true">      err = sock-&gt;ops-&gt;</span></span></span><span data-slate-object="text" data-key="11731"><span data-slate-leaf="true" data-offset-key="11731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">listen</span></span></span></span><span data-slate-object="text" data-key="11732"><span data-slate-leaf="true" data-offset-key="11732:0" data-first-offset="true"><span data-slate-string="true">(sock, backlog);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11733"><span data-slate-object="text" data-key="11734"><span data-slate-leaf="true" data-offset-key="11734:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11735"><span data-slate-leaf="true" data-offset-key="11735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fput_light</span></span></span></span><span data-slate-object="text" data-key="11736"><span data-slate-leaf="true" data-offset-key="11736:0" data-first-offset="true"><span data-slate-string="true">(sock-&gt;file, fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11737"><span data-slate-object="text" data-key="11738"><span data-slate-leaf="true" data-offset-key="11738:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11739"><span data-slate-object="text" data-key="11740"><span data-slate-leaf="true" data-offset-key="11740:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11741"><span data-slate-leaf="true" data-offset-key="11741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11742"><span data-slate-leaf="true" data-offset-key="11742:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11743"><span data-slate-object="text" data-key="11744"><span data-slate-leaf="true" data-offset-key="11744:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11745" id="sr-toc-6"><span data-slate-object="text" data-key="11746"><span data-slate-leaf="true" data-offset-key="11746:0" data-first-offset="true"><span data-slate-string="true">被动接收连接</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11747"><span data-slate-object="text" data-key="11748"><span data-slate-leaf="true" data-offset-key="11748:0" data-first-offset="true"><span data-slate-string="true">前面说过主动连接，我们再来看看被动接受连接的情况。接受一个客户端的连接请求会调用 </span></span></span><span data-slate-object="text" data-key="11749"><span data-slate-leaf="true" data-offset-key="11749:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">accept</span></span></span></span><span data-slate-object="text" data-key="11750"><span data-slate-leaf="true" data-offset-key="11750:0" data-first-offset="true"><span data-slate-string="true"> 函数，应用程序触发内核函数 </span></span></span><span data-slate-object="text" data-key="11751"><span data-slate-leaf="true" data-offset-key="11751:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_accept</span></span></span></span><span data-slate-object="text" data-key="11752"><span data-slate-leaf="true" data-offset-key="11752:0" data-first-offset="true"><span data-slate-string="true">，等待接收连接请求。如果允许连接，则重新创建一个代表该连接的套接字，并返回其套接字描述符，代码如下。</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="11753"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11754"><span data-slate-object="text" data-key="11755"><span data-slate-leaf="true" data-offset-key="11755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11756"><span data-slate-leaf="true" data-offset-key="11756:0" data-first-offset="true"><span data-slate-string="true"> __sys_accept4_file(</span></span></span><span data-slate-object="text" data-key="11757"><span data-slate-leaf="true" data-offset-key="11757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11758"><span data-slate-leaf="true" data-offset-key="11758:0" data-first-offset="true"><span data-slate-string="true"> file *file, </span></span></span><span data-slate-object="text" data-key="11759"><span data-slate-leaf="true" data-offset-key="11759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="11760"><span data-slate-leaf="true" data-offset-key="11760:0" data-first-offset="true"><span data-slate-string="true"> file_flags,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11761"><span data-slate-object="text" data-key="11762"><span data-slate-leaf="true" data-offset-key="11762:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="11763"><span data-slate-leaf="true" data-offset-key="11763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11764"><span data-slate-leaf="true" data-offset-key="11764:0" data-first-offset="true"><span data-slate-string="true"> sockaddr __user *upeer_sockaddr,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11765"><span data-slate-object="text" data-key="11766"><span data-slate-leaf="true" data-offset-key="11766:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="11767"><span data-slate-leaf="true" data-offset-key="11767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11768"><span data-slate-leaf="true" data-offset-key="11768:0" data-first-offset="true"><span data-slate-string="true"> __user *upeer_addrlen, </span></span></span><span data-slate-object="text" data-key="11769"><span data-slate-leaf="true" data-offset-key="11769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11770"><span data-slate-leaf="true" data-offset-key="11770:0" data-first-offset="true"><span data-slate-string="true"> flags,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11771"><span data-slate-object="text" data-key="11772"><span data-slate-leaf="true" data-offset-key="11772:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="11773"><span data-slate-leaf="true" data-offset-key="11773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="11774"><span data-slate-leaf="true" data-offset-key="11774:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11775"><span data-slate-leaf="true" data-offset-key="11775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="11776"><span data-slate-leaf="true" data-offset-key="11776:0" data-first-offset="true"><span data-slate-string="true"> nofile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11777"><span data-slate-object="text" data-key="11778"><span data-slate-leaf="true" data-offset-key="11778:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11779"><span data-slate-object="text" data-key="11780"><span data-slate-leaf="true" data-offset-key="11780:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11781"><span data-slate-leaf="true" data-offset-key="11781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11782"><span data-slate-leaf="true" data-offset-key="11782:0" data-first-offset="true"><span data-slate-string="true"> socket *sock, *newsock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11783"><span data-slate-object="text" data-key="11784"><span data-slate-leaf="true" data-offset-key="11784:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11785"><span data-slate-leaf="true" data-offset-key="11785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11786"><span data-slate-leaf="true" data-offset-key="11786:0" data-first-offset="true"><span data-slate-string="true"> file *newfile;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11787"><span data-slate-object="text" data-key="11788"><span data-slate-leaf="true" data-offset-key="11788:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11789"><span data-slate-leaf="true" data-offset-key="11789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="11790"><span data-slate-leaf="true" data-offset-key="11790:0" data-first-offset="true"><span data-slate-string="true"> err, len, newfd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11791"><span data-slate-object="text" data-key="11792"><span data-slate-leaf="true" data-offset-key="11792:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11793"><span data-slate-leaf="true" data-offset-key="11793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11794"><span data-slate-leaf="true" data-offset-key="11794:0" data-first-offset="true"><span data-slate-string="true"> sockaddr_storage address;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11795"><span data-slate-object="text" data-key="11796"><span data-slate-leaf="true" data-offset-key="11796:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11797"><span data-slate-leaf="true" data-offset-key="11797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11798"><span data-slate-leaf="true" data-offset-key="11798:0" data-first-offset="true"><span data-slate-string="true"> (flags &amp; ~(SOCK_CLOEXEC | SOCK_NONBLOCK))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11799"><span data-slate-object="text" data-key="11800"><span data-slate-leaf="true" data-offset-key="11800:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11801"><span data-slate-leaf="true" data-offset-key="11801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11802"><span data-slate-leaf="true" data-offset-key="11802:0" data-first-offset="true"><span data-slate-string="true"> -EINVAL;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11803"><span data-slate-object="text" data-key="11804"><span data-slate-leaf="true" data-offset-key="11804:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11805"><span data-slate-leaf="true" data-offset-key="11805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11806"><span data-slate-leaf="true" data-offset-key="11806:0" data-first-offset="true"><span data-slate-string="true"> (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11807"><span data-slate-object="text" data-key="11808"><span data-slate-leaf="true" data-offset-key="11808:0" data-first-offset="true"><span data-slate-string="true">    flags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11809"><span data-slate-object="text" data-key="11810"><span data-slate-leaf="true" data-offset-key="11810:0" data-first-offset="true"><span data-slate-string="true">  sock = sock_from_file(file, &amp;err);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11811"><span data-slate-object="text" data-key="11812"><span data-slate-leaf="true" data-offset-key="11812:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11813"><span data-slate-leaf="true" data-offset-key="11813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11814"><span data-slate-leaf="true" data-offset-key="11814:0" data-first-offset="true"><span data-slate-string="true"> (!sock)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11815"><span data-slate-object="text" data-key="11816"><span data-slate-leaf="true" data-offset-key="11816:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11817"><span data-slate-leaf="true" data-offset-key="11817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11818"><span data-slate-leaf="true" data-offset-key="11818:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11819"><span data-slate-leaf="true" data-offset-key="11819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="11820"><span data-slate-leaf="true" data-offset-key="11820:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11821"><span data-slate-object="text" data-key="11822"><span data-slate-leaf="true" data-offset-key="11822:0" data-first-offset="true"><span data-slate-string="true">  err = -ENFILE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11823"><span data-slate-object="text" data-key="11824"><span data-slate-leaf="true" data-offset-key="11824:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11825"><span data-slate-leaf="true" data-offset-key="11825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建一个新套接字</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11826"><span data-slate-object="text" data-key="11827"><span data-slate-leaf="true" data-offset-key="11827:0" data-first-offset="true"><span data-slate-string="true">  newsock = sock_alloc();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11828"><span data-slate-object="text" data-key="11829"><span data-slate-leaf="true" data-offset-key="11829:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11830"><span data-slate-leaf="true" data-offset-key="11830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11831"><span data-slate-leaf="true" data-offset-key="11831:0" data-first-offset="true"><span data-slate-string="true"> (!newsock)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11832"><span data-slate-object="text" data-key="11833"><span data-slate-leaf="true" data-offset-key="11833:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11834"><span data-slate-leaf="true" data-offset-key="11834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11835"><span data-slate-leaf="true" data-offset-key="11835:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11836"><span data-slate-leaf="true" data-offset-key="11836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="11837"><span data-slate-leaf="true" data-offset-key="11837:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11838"><span data-slate-object="text" data-key="11839"><span data-slate-leaf="true" data-offset-key="11839:0" data-first-offset="true"><span data-slate-string="true">  newsock-&gt;type = sock-&gt;type;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11840"><span data-slate-object="text" data-key="11841"><span data-slate-leaf="true" data-offset-key="11841:0" data-first-offset="true"><span data-slate-string="true">  newsock-&gt;ops = sock-&gt;ops;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11842"><span data-slate-object="text" data-key="11843"><span data-slate-leaf="true" data-offset-key="11843:0" data-first-offset="true"><span data-slate-string="true">  __module_get(newsock-&gt;ops-&gt;owner);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11844"><span data-slate-object="text" data-key="11845"><span data-slate-leaf="true" data-offset-key="11845:0" data-first-offset="true"><span data-slate-string="true">  newfd = __get_unused_fd_flags(flags, nofile);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11846"><span data-slate-object="text" data-key="11847"><span data-slate-leaf="true" data-offset-key="11847:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11848"><span data-slate-leaf="true" data-offset-key="11848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11849"><span data-slate-leaf="true" data-offset-key="11849:0" data-first-offset="true"><span data-slate-string="true"> (unlikely(newfd &lt; </span></span></span><span data-slate-object="text" data-key="11850"><span data-slate-leaf="true" data-offset-key="11850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11851"><span data-slate-leaf="true" data-offset-key="11851:0" data-first-offset="true"><span data-slate-string="true">)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11852"><span data-slate-object="text" data-key="11853"><span data-slate-leaf="true" data-offset-key="11853:0" data-first-offset="true"><span data-slate-string="true">    err = newfd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11854"><span data-slate-object="text" data-key="11855"><span data-slate-leaf="true" data-offset-key="11855:0" data-first-offset="true"><span data-slate-string="true">    sock_release(newsock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11856"><span data-slate-object="text" data-key="11857"><span data-slate-leaf="true" data-offset-key="11857:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11858"><span data-slate-leaf="true" data-offset-key="11858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11859"><span data-slate-leaf="true" data-offset-key="11859:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11860"><span data-slate-leaf="true" data-offset-key="11860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="11861"><span data-slate-leaf="true" data-offset-key="11861:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11862"><span data-slate-object="text" data-key="11863"><span data-slate-leaf="true" data-offset-key="11863:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11864"><span data-slate-object="text" data-key="11865"><span data-slate-leaf="true" data-offset-key="11865:0" data-first-offset="true"><span data-slate-string="true">  newfile = sock_alloc_file(newsock, flags, sock-&gt;sk-&gt;sk_prot_creator-&gt;name);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11866"><span data-slate-object="text" data-key="11867"><span data-slate-leaf="true" data-offset-key="11867:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11868"><span data-slate-leaf="true" data-offset-key="11868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11869"><span data-slate-leaf="true" data-offset-key="11869:0" data-first-offset="true"><span data-slate-string="true"> (IS_ERR(newfile)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11870"><span data-slate-object="text" data-key="11871"><span data-slate-leaf="true" data-offset-key="11871:0" data-first-offset="true"><span data-slate-string="true">    err = PTR_ERR(newfile);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11872"><span data-slate-object="text" data-key="11873"><span data-slate-leaf="true" data-offset-key="11873:0" data-first-offset="true"><span data-slate-string="true">    put_unused_fd(newfd);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11874"><span data-slate-object="text" data-key="11875"><span data-slate-leaf="true" data-offset-key="11875:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11876"><span data-slate-leaf="true" data-offset-key="11876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11877"><span data-slate-leaf="true" data-offset-key="11877:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11878"><span data-slate-leaf="true" data-offset-key="11878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="11879"><span data-slate-leaf="true" data-offset-key="11879:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11880"><span data-slate-object="text" data-key="11881"><span data-slate-leaf="true" data-offset-key="11881:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11882"><span data-slate-object="text" data-key="11883"><span data-slate-leaf="true" data-offset-key="11883:0" data-first-offset="true"><span data-slate-string="true">  err = security_socket_accept(sock, newsock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11884"><span data-slate-object="text" data-key="11885"><span data-slate-leaf="true" data-offset-key="11885:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11886"><span data-slate-leaf="true" data-offset-key="11886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11887"><span data-slate-leaf="true" data-offset-key="11887:0" data-first-offset="true"><span data-slate-string="true"> (err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11888"><span data-slate-object="text" data-key="11889"><span data-slate-leaf="true" data-offset-key="11889:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11890"><span data-slate-leaf="true" data-offset-key="11890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11891"><span data-slate-leaf="true" data-offset-key="11891:0" data-first-offset="true"><span data-slate-string="true"> out_fd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11892"><span data-slate-object="text" data-key="11893"><span data-slate-leaf="true" data-offset-key="11893:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11894"><span data-slate-leaf="true" data-offset-key="11894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据套接字类型调用不同的函数 inet_accept</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11895"><span data-slate-object="text" data-key="11896"><span data-slate-leaf="true" data-offset-key="11896:0" data-first-offset="true"><span data-slate-string="true">  err = sock-&gt;ops-&gt;accept(sock, newsock, sock-&gt;file-&gt;f_flags | file_flags,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11897"><span data-slate-object="text" data-key="11898"><span data-slate-leaf="true" data-offset-key="11898:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11899"><span data-slate-leaf="true" data-offset-key="11899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="11900"><span data-slate-leaf="true" data-offset-key="11900:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11901"><span data-slate-object="text" data-key="11902"><span data-slate-leaf="true" data-offset-key="11902:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11903"><span data-slate-leaf="true" data-offset-key="11903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11904"><span data-slate-leaf="true" data-offset-key="11904:0" data-first-offset="true"><span data-slate-string="true"> (err &lt; </span></span></span><span data-slate-object="text" data-key="11905"><span data-slate-leaf="true" data-offset-key="11905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11906"><span data-slate-leaf="true" data-offset-key="11906:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11907"><span data-slate-object="text" data-key="11908"><span data-slate-leaf="true" data-offset-key="11908:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11909"><span data-slate-leaf="true" data-offset-key="11909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11910"><span data-slate-leaf="true" data-offset-key="11910:0" data-first-offset="true"><span data-slate-string="true"> out_fd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11911"><span data-slate-object="text" data-key="11912"><span data-slate-leaf="true" data-offset-key="11912:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11913"><span data-slate-leaf="true" data-offset-key="11913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11914"><span data-slate-leaf="true" data-offset-key="11914:0" data-first-offset="true"><span data-slate-string="true"> (upeer_sockaddr) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11915"><span data-slate-object="text" data-key="11916"><span data-slate-leaf="true" data-offset-key="11916:0" data-first-offset="true"><span data-slate-string="true">    len = newsock-&gt;ops-&gt;getname(newsock,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11917"><span data-slate-object="text" data-key="11918"><span data-slate-leaf="true" data-offset-key="11918:0" data-first-offset="true"><span data-slate-string="true">          (</span></span></span><span data-slate-object="text" data-key="11919"><span data-slate-leaf="true" data-offset-key="11919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="11920"><span data-slate-leaf="true" data-offset-key="11920:0" data-first-offset="true"><span data-slate-string="true"> sockaddr *)&amp;address, </span></span></span><span data-slate-object="text" data-key="11921"><span data-slate-leaf="true" data-offset-key="11921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="11922"><span data-slate-leaf="true" data-offset-key="11922:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11923"><span data-slate-object="text" data-key="11924"><span data-slate-leaf="true" data-offset-key="11924:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11925"><span data-slate-leaf="true" data-offset-key="11925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11926"><span data-slate-leaf="true" data-offset-key="11926:0" data-first-offset="true"><span data-slate-string="true"> (len &lt; </span></span></span><span data-slate-object="text" data-key="11927"><span data-slate-leaf="true" data-offset-key="11927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11928"><span data-slate-leaf="true" data-offset-key="11928:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11929"><span data-slate-object="text" data-key="11930"><span data-slate-leaf="true" data-offset-key="11930:0" data-first-offset="true"><span data-slate-string="true">      err = -ECONNABORTED;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11931"><span data-slate-object="text" data-key="11932"><span data-slate-leaf="true" data-offset-key="11932:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11933"><span data-slate-leaf="true" data-offset-key="11933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11934"><span data-slate-leaf="true" data-offset-key="11934:0" data-first-offset="true"><span data-slate-string="true"> out_fd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11935"><span data-slate-object="text" data-key="11936"><span data-slate-leaf="true" data-offset-key="11936:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11937"><span data-slate-object="text" data-key="11938"><span data-slate-leaf="true" data-offset-key="11938:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11939"><span data-slate-leaf="true" data-offset-key="11939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从内核复制到用户空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11940"><span data-slate-object="text" data-key="11941"><span data-slate-leaf="true" data-offset-key="11941:0" data-first-offset="true"><span data-slate-string="true">    err = move_addr_to_user(&amp;address,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11942"><span data-slate-object="text" data-key="11943"><span data-slate-leaf="true" data-offset-key="11943:0" data-first-offset="true"><span data-slate-string="true">          len, upeer_sockaddr, upeer_addrlen);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11944"><span data-slate-object="text" data-key="11945"><span data-slate-leaf="true" data-offset-key="11945:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11946"><span data-slate-leaf="true" data-offset-key="11946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11947"><span data-slate-leaf="true" data-offset-key="11947:0" data-first-offset="true"><span data-slate-string="true"> (err &lt; </span></span></span><span data-slate-object="text" data-key="11948"><span data-slate-leaf="true" data-offset-key="11948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11949"><span data-slate-leaf="true" data-offset-key="11949:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11950"><span data-slate-object="text" data-key="11951"><span data-slate-leaf="true" data-offset-key="11951:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11952"><span data-slate-leaf="true" data-offset-key="11952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11953"><span data-slate-leaf="true" data-offset-key="11953:0" data-first-offset="true"><span data-slate-string="true"> out_fd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11954"><span data-slate-object="text" data-key="11955"><span data-slate-leaf="true" data-offset-key="11955:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11956"><span data-slate-object="text" data-key="11957"><span data-slate-leaf="true" data-offset-key="11957:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11958"><span data-slate-leaf="true" data-offset-key="11958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* File flags are not inherited via accept() unlike another OSes. */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11959"><span data-slate-object="text" data-key="11960"><span data-slate-leaf="true" data-offset-key="11960:0" data-first-offset="true"><span data-slate-string="true">  fd_install(newfd, newfile);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11961"><span data-slate-object="text" data-key="11962"><span data-slate-leaf="true" data-offset-key="11962:0" data-first-offset="true"><span data-slate-string="true">  err = newfd;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11963"><span data-slate-object="text" data-key="11964"><span data-slate-leaf="true" data-offset-key="11964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="11965"><span data-slate-leaf="true" data-offset-key="11965:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11966"><span data-slate-object="text" data-key="11967"><span data-slate-leaf="true" data-offset-key="11967:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11968"><span data-slate-leaf="true" data-offset-key="11968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="11969"><span data-slate-leaf="true" data-offset-key="11969:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11970"><span data-slate-object="text" data-key="11971"><span data-slate-leaf="true" data-offset-key="11971:0" data-first-offset="true"><span data-slate-string="true">out_fd:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11972"><span data-slate-object="text" data-key="11973"><span data-slate-leaf="true" data-offset-key="11973:0" data-first-offset="true"><span data-slate-string="true">  fput(newfile);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11974"><span data-slate-object="text" data-key="11975"><span data-slate-leaf="true" data-offset-key="11975:0" data-first-offset="true"><span data-slate-string="true">  put_unused_fd(newfd);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11976"><span data-slate-object="text" data-key="11977"><span data-slate-leaf="true" data-offset-key="11977:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11978"><span data-slate-leaf="true" data-offset-key="11978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="11979"><span data-slate-leaf="true" data-offset-key="11979:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11980"><span data-slate-leaf="true" data-offset-key="11980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="11981"><span data-slate-leaf="true" data-offset-key="11981:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11982"><span data-slate-object="text" data-key="11983"><span data-slate-leaf="true" data-offset-key="11983:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11984"><span data-slate-object="text" data-key="11985"><span data-slate-leaf="true" data-offset-key="11985:0" data-first-offset="true"><span data-slate-string="true">这个新的套接字描述符与最初创建套接字时，设置的套接字地址族与套接字类型、使用的协议一样。原来创建的套接字不与连接关联，它继续在原套接字上侦听，以便接收其他连接请求。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11986" id="sr-toc-7"><span data-slate-object="text" data-key="11987"><span data-slate-leaf="true" data-offset-key="11987:0" data-first-offset="true"><span data-slate-string="true">发送数据</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11988"><span data-slate-object="text" data-key="11989"><span data-slate-leaf="true" data-offset-key="11989:0" data-first-offset="true"><span data-slate-string="true">套接字应用中最简单的传送函数是 </span></span></span><span data-slate-object="text" data-key="11990"><span data-slate-leaf="true" data-offset-key="11990:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">send</span></span></span></span><span data-slate-object="text" data-key="11991"><span data-slate-leaf="true" data-offset-key="11991:0" data-first-offset="true"><span data-slate-string="true">，send 函数的作用类似于 write，但 send 函数允许应用程序指定标志，规定如何对待传送数据。调用 send 函数时，会触发内核的 </span></span></span><span data-slate-object="text" data-key="11992"><span data-slate-leaf="true" data-offset-key="11992:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_send</span></span></span></span><span data-slate-object="text" data-key="11993"><span data-slate-leaf="true" data-offset-key="11993:0" data-first-offset="true"><span data-slate-string="true"> 函数，把发送缓冲区的数据发送出去。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11994"><span data-slate-object="text" data-key="11995"><span data-slate-leaf="true" data-offset-key="11995:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_send</span></span></span></span><span data-slate-object="text" data-key="11996"><span data-slate-leaf="true" data-offset-key="11996:0" data-first-offset="true"><span data-slate-string="true"> 函数具体调用流程如下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11997"><span data-slate-object="text" data-key="11998"><span data-slate-leaf="true" data-offset-key="11998:0" data-first-offset="true"><span data-slate-string="true">1. 应用程序的数据被复制到内核后，sys_send 函数调用 </span></span></span><span data-slate-object="text" data-key="11999"><span data-slate-leaf="true" data-offset-key="11999:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sock_sendmsg</span></span></span></span><span data-slate-object="text" data-key="12000"><span data-slate-leaf="true" data-offset-key="12000:0" data-first-offset="true"><span data-slate-string="true">，依据协议族类型来执行发送操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12001"><span data-slate-object="text" data-key="12002"><span data-slate-leaf="true" data-offset-key="12002:0" data-first-offset="true"><span data-slate-string="true">2. 如果是 INET 协议族套接字，sock_sendmsg 将调用 inet_sendmsg 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12003"><span data-slate-object="text" data-key="12004"><span data-slate-leaf="true" data-offset-key="12004:0" data-first-offset="true"><span data-slate-string="true">3. 如果采用 TCP 协议，inet_sendmsg 函数将调用 tcp_sendmsg，并按照 TCP 协议规则来发送数据包。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12005"><span data-slate-object="text" data-key="12006"><span data-slate-leaf="true" data-offset-key="12006:0" data-first-offset="true"><span data-slate-string="true">send 函数返回发送成功，并不意味着在连接的另一端的进程可以收到数据，这里只能保证发送 send 函数执行成功，发送给网络设备驱动程序的数据没有出错。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12007" id="sr-toc-8"><span data-slate-object="text" data-key="12008"><span data-slate-leaf="true" data-offset-key="12008:0" data-first-offset="true"><span data-slate-string="true">接收数据</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12009"><span data-slate-object="text" data-key="12010"><span data-slate-leaf="true" data-offset-key="12010:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">recv</span></span></span></span><span data-slate-object="text" data-key="12011"><span data-slate-leaf="true" data-offset-key="12011:0" data-first-offset="true"><span data-slate-string="true"> 函数与文件读 read 函数类似，recv 函数中可以指定标志来控制如何接收数据，调用 recv 函数时，应用程序会触发内核的 sys_recv 函数，把网络中的数据递交到应用程序。当然，read、recvfrom 函数也会触发 sys_recv 函数。具体流程如下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12012"><span data-slate-object="text" data-key="12013"><span data-slate-leaf="true" data-offset-key="12013:0" data-first-offset="true"><span data-slate-string="true">1. 为把内核的网络数据转入应用程序的接收缓冲区，sys_recv 函数依次调用 </span></span></span><span data-slate-object="text" data-key="12014"><span data-slate-leaf="true" data-offset-key="12014:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_recvfrom、sock_recvfrom 和 __sock_recvmsg</span></span></span></span><span data-slate-object="text" data-key="12015"><span data-slate-leaf="true" data-offset-key="12015:0" data-first-offset="true"><span data-slate-string="true">，并依据协议族类型来执行具体的接收操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12016"><span data-slate-object="text" data-key="12017"><span data-slate-leaf="true" data-offset-key="12017:0" data-first-offset="true"><span data-slate-string="true">2. 如果是 INET 协议族套接字，__sock_recvmsg 将调用 sock_common_recvmsg 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12018"><span data-slate-object="text" data-key="12019"><span data-slate-leaf="true" data-offset-key="12019:0" data-first-offset="true"><span data-slate-string="true">3. 如果采用 TCP 协议，sock_common_recvmsg 函数将调用 tcp_recvmsg，按照 TCP 协议规则来接收数据包</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12020"><span data-slate-object="text" data-key="12021"><span data-slate-leaf="true" data-offset-key="12021:0" data-first-offset="true"><span data-slate-string="true">如果接收方想获取数据包发送端的标识符，应用程序可以调用 </span></span></span><span data-slate-object="text" data-key="12022"><span data-slate-leaf="true" data-offset-key="12022:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_recvfrom</span></span></span></span><span data-slate-object="text" data-key="12023"><span data-slate-leaf="true" data-offset-key="12023:0" data-first-offset="true"><span data-slate-string="true"> 函数来获取数据包发送方的源地址，下面是 </span></span></span><span data-slate-object="text" data-key="12024"><span data-slate-leaf="true" data-offset-key="12024:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sys_recvfrom</span></span></span></span><span data-slate-object="text" data-key="12025"><span data-slate-leaf="true" data-offset-key="12025:0" data-first-offset="true"><span data-slate-string="true"> 函数的实现。</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="12026"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12027"><span data-slate-object="text" data-key="12028"><span data-slate-leaf="true" data-offset-key="12028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12029"><span data-slate-leaf="true" data-offset-key="12029:0" data-first-offset="true"><span data-slate-string="true"> __sys_recvfrom(</span></span></span><span data-slate-object="text" data-key="12030"><span data-slate-leaf="true" data-offset-key="12030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12031"><span data-slate-leaf="true" data-offset-key="12031:0" data-first-offset="true"><span data-slate-string="true"> fd, </span></span></span><span data-slate-object="text" data-key="12032"><span data-slate-leaf="true" data-offset-key="12032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="12033"><span data-slate-leaf="true" data-offset-key="12033:0" data-first-offset="true"><span data-slate-string="true"> __user *ubuf, size_t size, </span></span></span><span data-slate-object="text" data-key="12034"><span data-slate-leaf="true" data-offset-key="12034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="12035"><span data-slate-leaf="true" data-offset-key="12035:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12036"><span data-slate-leaf="true" data-offset-key="12036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12037"><span data-slate-leaf="true" data-offset-key="12037:0" data-first-offset="true"><span data-slate-string="true"> flags,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12038"><span data-slate-object="text" data-key="12039"><span data-slate-leaf="true" data-offset-key="12039:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="12040"><span data-slate-leaf="true" data-offset-key="12040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12041"><span data-slate-leaf="true" data-offset-key="12041:0" data-first-offset="true"><span data-slate-string="true"> sockaddr __user *addr, </span></span></span><span data-slate-object="text" data-key="12042"><span data-slate-leaf="true" data-offset-key="12042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12043"><span data-slate-leaf="true" data-offset-key="12043:0" data-first-offset="true"><span data-slate-string="true"> __user *addr_len)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12044"><span data-slate-object="text" data-key="12045"><span data-slate-leaf="true" data-offset-key="12045:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12046"><span data-slate-object="text" data-key="12047"><span data-slate-leaf="true" data-offset-key="12047:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12048"><span data-slate-leaf="true" data-offset-key="12048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12049"><span data-slate-leaf="true" data-offset-key="12049:0" data-first-offset="true"><span data-slate-string="true"> socket *sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12050"><span data-slate-object="text" data-key="12051"><span data-slate-leaf="true" data-offset-key="12051:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12052"><span data-slate-leaf="true" data-offset-key="12052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12053"><span data-slate-leaf="true" data-offset-key="12053:0" data-first-offset="true"><span data-slate-string="true"> iovec iov;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12054"><span data-slate-object="text" data-key="12055"><span data-slate-leaf="true" data-offset-key="12055:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12056"><span data-slate-leaf="true" data-offset-key="12056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12057"><span data-slate-leaf="true" data-offset-key="12057:0" data-first-offset="true"><span data-slate-string="true"> msghdr msg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12058"><span data-slate-object="text" data-key="12059"><span data-slate-leaf="true" data-offset-key="12059:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12060"><span data-slate-leaf="true" data-offset-key="12060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12061"><span data-slate-leaf="true" data-offset-key="12061:0" data-first-offset="true"><span data-slate-string="true"> sockaddr_storage address;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12062"><span data-slate-object="text" data-key="12063"><span data-slate-leaf="true" data-offset-key="12063:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12064"><span data-slate-leaf="true" data-offset-key="12064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12065"><span data-slate-leaf="true" data-offset-key="12065:0" data-first-offset="true"><span data-slate-string="true"> err, err2;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12066"><span data-slate-object="text" data-key="12067"><span data-slate-leaf="true" data-offset-key="12067:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12068"><span data-slate-leaf="true" data-offset-key="12068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12069"><span data-slate-leaf="true" data-offset-key="12069:0" data-first-offset="true"><span data-slate-string="true"> fput_needed;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12070"><span data-slate-object="text" data-key="12071"><span data-slate-leaf="true" data-offset-key="12071:0" data-first-offset="true"><span data-slate-string="true">  err = import_single_range(READ, ubuf, size, &amp;iov, &amp;msg.msg_iter);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12072"><span data-slate-object="text" data-key="12073"><span data-slate-leaf="true" data-offset-key="12073:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12074"><span data-slate-leaf="true" data-offset-key="12074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12075"><span data-slate-leaf="true" data-offset-key="12075:0" data-first-offset="true"><span data-slate-string="true"> (unlikely(err))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12076"><span data-slate-object="text" data-key="12077"><span data-slate-leaf="true" data-offset-key="12077:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12078"><span data-slate-leaf="true" data-offset-key="12078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12079"><span data-slate-leaf="true" data-offset-key="12079:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12080"><span data-slate-object="text" data-key="12081"><span data-slate-leaf="true" data-offset-key="12081:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12082"><span data-slate-leaf="true" data-offset-key="12082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通过套接字描述符找到 struct socket</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12083"><span data-slate-object="text" data-key="12084"><span data-slate-leaf="true" data-offset-key="12084:0" data-first-offset="true"><span data-slate-string="true">  sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12085"><span data-slate-object="text" data-key="12086"><span data-slate-leaf="true" data-offset-key="12086:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12087"><span data-slate-leaf="true" data-offset-key="12087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12088"><span data-slate-leaf="true" data-offset-key="12088:0" data-first-offset="true"><span data-slate-string="true"> (!sock)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12089"><span data-slate-object="text" data-key="12090"><span data-slate-leaf="true" data-offset-key="12090:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12091"><span data-slate-leaf="true" data-offset-key="12091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="12092"><span data-slate-leaf="true" data-offset-key="12092:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12093"><span data-slate-leaf="true" data-offset-key="12093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="12094"><span data-slate-leaf="true" data-offset-key="12094:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12095"><span data-slate-object="text" data-key="12096"><span data-slate-leaf="true" data-offset-key="12096:0" data-first-offset="true"><span data-slate-string="true">  msg.msg_control = </span></span></span><span data-slate-object="text" data-key="12097"><span data-slate-leaf="true" data-offset-key="12097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12098"><span data-slate-leaf="true" data-offset-key="12098:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12099"><span data-slate-object="text" data-key="12100"><span data-slate-leaf="true" data-offset-key="12100:0" data-first-offset="true"><span data-slate-string="true">  msg.msg_controllen = </span></span></span><span data-slate-object="text" data-key="12101"><span data-slate-leaf="true" data-offset-key="12101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12102"><span data-slate-leaf="true" data-offset-key="12102:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12103"><span data-slate-object="text" data-key="12104"><span data-slate-leaf="true" data-offset-key="12104:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12105"><span data-slate-leaf="true" data-offset-key="12105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* Save some cycles and don't copy the address if not needed */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12106"><span data-slate-object="text" data-key="12107"><span data-slate-leaf="true" data-offset-key="12107:0" data-first-offset="true"><span data-slate-string="true">  msg.msg_name = addr ? (</span></span></span><span data-slate-object="text" data-key="12108"><span data-slate-leaf="true" data-offset-key="12108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12109"><span data-slate-leaf="true" data-offset-key="12109:0" data-first-offset="true"><span data-slate-string="true"> sockaddr *)&amp;address : </span></span></span><span data-slate-object="text" data-key="12110"><span data-slate-leaf="true" data-offset-key="12110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12111"><span data-slate-leaf="true" data-offset-key="12111:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12112"><span data-slate-object="text" data-key="12113"><span data-slate-leaf="true" data-offset-key="12113:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12114"><span data-slate-leaf="true" data-offset-key="12114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* We assume all kernel code knows the size of sockaddr_storage */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12115"><span data-slate-object="text" data-key="12116"><span data-slate-leaf="true" data-offset-key="12116:0" data-first-offset="true"><span data-slate-string="true">  msg.msg_namelen = </span></span></span><span data-slate-object="text" data-key="12117"><span data-slate-leaf="true" data-offset-key="12117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12118"><span data-slate-leaf="true" data-offset-key="12118:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12119"><span data-slate-object="text" data-key="12120"><span data-slate-leaf="true" data-offset-key="12120:0" data-first-offset="true"><span data-slate-string="true">  msg.msg_iocb = </span></span></span><span data-slate-object="text" data-key="12121"><span data-slate-leaf="true" data-offset-key="12121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12122"><span data-slate-leaf="true" data-offset-key="12122:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12123"><span data-slate-object="text" data-key="12124"><span data-slate-leaf="true" data-offset-key="12124:0" data-first-offset="true"><span data-slate-string="true">  msg.msg_flags = </span></span></span><span data-slate-object="text" data-key="12125"><span data-slate-leaf="true" data-offset-key="12125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12126"><span data-slate-leaf="true" data-offset-key="12126:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12127"><span data-slate-object="text" data-key="12128"><span data-slate-leaf="true" data-offset-key="12128:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12129"><span data-slate-leaf="true" data-offset-key="12129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12130"><span data-slate-leaf="true" data-offset-key="12130:0" data-first-offset="true"><span data-slate-string="true"> (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12131"><span data-slate-object="text" data-key="12132"><span data-slate-leaf="true" data-offset-key="12132:0" data-first-offset="true"><span data-slate-string="true">    flags |= MSG_DONTWAIT;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12133"><span data-slate-object="text" data-key="12134"><span data-slate-leaf="true" data-offset-key="12134:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12135"><span data-slate-leaf="true" data-offset-key="12135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//sock_recvmsg 为具体的接收函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12136"><span data-slate-object="text" data-key="12137"><span data-slate-leaf="true" data-offset-key="12137:0" data-first-offset="true"><span data-slate-string="true">  err = sock_recvmsg(sock, &amp;msg, flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12138"><span data-slate-object="text" data-key="12139"><span data-slate-leaf="true" data-offset-key="12139:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12140"><span data-slate-leaf="true" data-offset-key="12140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12141"><span data-slate-leaf="true" data-offset-key="12141:0" data-first-offset="true"><span data-slate-string="true"> (err&gt;= </span></span></span><span data-slate-object="text" data-key="12142"><span data-slate-leaf="true" data-offset-key="12142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12143"><span data-slate-leaf="true" data-offset-key="12143:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; addr != </span></span></span><span data-slate-object="text" data-key="12144"><span data-slate-leaf="true" data-offset-key="12144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12145"><span data-slate-leaf="true" data-offset-key="12145:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12146"><span data-slate-object="text" data-key="12147"><span data-slate-leaf="true" data-offset-key="12147:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12148"><span data-slate-leaf="true" data-offset-key="12148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从内核复制到用户空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12149"><span data-slate-object="text" data-key="12150"><span data-slate-leaf="true" data-offset-key="12150:0" data-first-offset="true"><span data-slate-string="true">    err2 = move_addr_to_user(&amp;address,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12151"><span data-slate-object="text" data-key="12152"><span data-slate-leaf="true" data-offset-key="12152:0" data-first-offset="true"><span data-slate-string="true">           msg.msg_namelen, addr, addr_len);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12153"><span data-slate-object="text" data-key="12154"><span data-slate-leaf="true" data-offset-key="12154:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12155"><span data-slate-leaf="true" data-offset-key="12155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12156"><span data-slate-leaf="true" data-offset-key="12156:0" data-first-offset="true"><span data-slate-string="true"> (err2 &lt; </span></span></span><span data-slate-object="text" data-key="12157"><span data-slate-leaf="true" data-offset-key="12157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="12158"><span data-slate-leaf="true" data-offset-key="12158:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12159"><span data-slate-object="text" data-key="12160"><span data-slate-leaf="true" data-offset-key="12160:0" data-first-offset="true"><span data-slate-string="true">      err = err2;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12161"><span data-slate-object="text" data-key="12162"><span data-slate-leaf="true" data-offset-key="12162:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12163"><span data-slate-object="text" data-key="12164"><span data-slate-leaf="true" data-offset-key="12164:0" data-first-offset="true"><span data-slate-string="true">  fput_light(sock-&gt;file, fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12165"><span data-slate-object="text" data-key="12166"><span data-slate-leaf="true" data-offset-key="12166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="12167"><span data-slate-leaf="true" data-offset-key="12167:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12168"><span data-slate-object="text" data-key="12169"><span data-slate-leaf="true" data-offset-key="12169:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12170"><span data-slate-leaf="true" data-offset-key="12170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12171"><span data-slate-leaf="true" data-offset-key="12171:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12172"><span data-slate-object="text" data-key="12173"><span data-slate-leaf="true" data-offset-key="12173:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="12174" id="sr-toc-9"><span data-slate-object="text" data-key="12175"><span data-slate-leaf="true" data-offset-key="12175:0" data-first-offset="true"><span data-slate-string="true">关闭连接</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="12176"><span data-slate-object="text" data-key="12177"><span data-slate-leaf="true" data-offset-key="12177:0" data-first-offset="true"><span data-slate-string="true">最后，我们来看看如何关闭连接。当应用程序调用 shutdown 函数关闭连接时，内核会启动函数 sys_shutdown，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="12178"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="12179"><span data-slate-object="text" data-key="12180"><span data-slate-leaf="true" data-offset-key="12180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12181"><span data-slate-leaf="true" data-offset-key="12181:0" data-first-offset="true"><span data-slate-string="true"> __sys_shutdown(</span></span></span><span data-slate-object="text" data-key="12182"><span data-slate-leaf="true" data-offset-key="12182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12183"><span data-slate-leaf="true" data-offset-key="12183:0" data-first-offset="true"><span data-slate-string="true"> fd, </span></span></span><span data-slate-object="text" data-key="12184"><span data-slate-leaf="true" data-offset-key="12184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12185"><span data-slate-leaf="true" data-offset-key="12185:0" data-first-offset="true"><span data-slate-string="true"> how)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12186"><span data-slate-object="text" data-key="12187"><span data-slate-leaf="true" data-offset-key="12187:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12188"><span data-slate-object="text" data-key="12189"><span data-slate-leaf="true" data-offset-key="12189:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12190"><span data-slate-leaf="true" data-offset-key="12190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="12191"><span data-slate-leaf="true" data-offset-key="12191:0" data-first-offset="true"><span data-slate-string="true"> err, fput_needed;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12192"><span data-slate-object="text" data-key="12193"><span data-slate-leaf="true" data-offset-key="12193:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12194"><span data-slate-leaf="true" data-offset-key="12194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="12195"><span data-slate-leaf="true" data-offset-key="12195:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="12196"><span data-slate-leaf="true" data-offset-key="12196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">socket</span></span></span></span><span data-slate-object="text" data-key="12197"><span data-slate-leaf="true" data-offset-key="12197:0" data-first-offset="true"><span data-slate-string="true"> *sock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12198"><span data-slate-object="text" data-key="12199"><span data-slate-leaf="true" data-offset-key="12199:0" data-first-offset="true"><span data-slate-string="true">  sock = </span></span></span><span data-slate-object="text" data-key="12200"><span data-slate-leaf="true" data-offset-key="12200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sockfd_lookup_light</span></span></span></span><span data-slate-object="text" data-key="12201"><span data-slate-leaf="true" data-offset-key="12201:0" data-first-offset="true"><span data-slate-string="true">(fd, &amp;err, &amp;fput_needed);</span></span></span><span data-slate-object="text" data-key="12202"><span data-slate-leaf="true" data-offset-key="12202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 通过套接字，描述符找到对应的结构 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12203"><span data-slate-object="text" data-key="12204"><span data-slate-leaf="true" data-offset-key="12204:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12205"><span data-slate-leaf="true" data-offset-key="12205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12206"><span data-slate-leaf="true" data-offset-key="12206:0" data-first-offset="true"><span data-slate-string="true"> (sock != </span></span></span><span data-slate-object="text" data-key="12207"><span data-slate-leaf="true" data-offset-key="12207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="12208"><span data-slate-leaf="true" data-offset-key="12208:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12209"><span data-slate-object="text" data-key="12210"><span data-slate-leaf="true" data-offset-key="12210:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="12211"><span data-slate-leaf="true" data-offset-key="12211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">security_socket_shutdown</span></span></span></span><span data-slate-object="text" data-key="12212"><span data-slate-leaf="true" data-offset-key="12212:0" data-first-offset="true"><span data-slate-string="true">(sock, how);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12213"><span data-slate-object="text" data-key="12214"><span data-slate-leaf="true" data-offset-key="12214:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="12215"><span data-slate-leaf="true" data-offset-key="12215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="12216"><span data-slate-leaf="true" data-offset-key="12216:0" data-first-offset="true"><span data-slate-string="true"> (!err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12217"><span data-slate-object="text" data-key="12218"><span data-slate-leaf="true" data-offset-key="12218:0" data-first-offset="true"><span data-slate-string="true">             </span></span></span><span data-slate-object="text" data-key="12219"><span data-slate-leaf="true" data-offset-key="12219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 根据套接字协议族调用关闭函数 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12220"><span data-slate-object="text" data-key="12221"><span data-slate-leaf="true" data-offset-key="12221:0" data-first-offset="true"><span data-slate-string="true">      err = sock-&gt;ops-&gt;</span></span></span><span data-slate-object="text" data-key="12222"><span data-slate-leaf="true" data-offset-key="12222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span><span data-slate-object="text" data-key="12223"><span data-slate-leaf="true" data-offset-key="12223:0" data-first-offset="true"><span data-slate-string="true">(sock, how);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12224"><span data-slate-object="text" data-key="12225"><span data-slate-leaf="true" data-offset-key="12225:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="12226"><span data-slate-leaf="true" data-offset-key="12226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fput_light</span></span></span></span><span data-slate-object="text" data-key="12227"><span data-slate-leaf="true" data-offset-key="12227:0" data-first-offset="true"><span data-slate-string="true">(sock-&gt;file, fput_needed);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12228"><span data-slate-object="text" data-key="12229"><span data-slate-leaf="true" data-offset-key="12229:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12230"><span data-slate-object="text" data-key="12231"><span data-slate-leaf="true" data-offset-key="12231:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="12232"><span data-slate-leaf="true" data-offset-key="12232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="12233"><span data-slate-leaf="true" data-offset-key="12233:0" data-first-offset="true"><span data-slate-string="true"> err;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="12234"><span data-slate-object="text" data-key="12235"><span data-slate-leaf="true" data-offset-key="12235:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12236" id="sr-toc-10"><span data-slate-object="text" data-key="12237"><span data-slate-leaf="true" data-offset-key="12237:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12238"><span data-slate-object="text" data-key="12239"><span data-slate-leaf="true" data-offset-key="12239:0" data-first-offset="true"><span data-slate-string="true">好，这节课的内容告一段落了，我来给你做个总结。这节课我们继续研究了套接字在 Linux 内核中的实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12240"><span data-slate-object="text" data-key="12241"><span data-slate-leaf="true" data-offset-key="12241:0" data-first-offset="true"><span data-slate-string="true">套接字是 UNIX 兼容系统的一大特色，Linux 在此基础上实现了内核套接字与应用程序套接字接口，在用户地址空间与内核地址空间之间提供了一套标准接口，实现应用套接字库函数与内核功能之间的一一对应，简化了用户地址空间与内核地址空间交换数据的过程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12242"><span data-slate-object="text" data-key="12243"><span data-slate-leaf="true" data-offset-key="12243:0" data-first-offset="true"><span data-slate-string="true">通过应用套接字 API 编写网络应用程序，我们可以利用 Linux 内核 TCP/IP 协议栈提供的网络通信服务，在网络上实现应用数据快速、有效的传送。除此之外，套接字编程还可以使我们获取网络、主机的各种管理、统计信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12244"><span data-slate-object="text" data-key="12245"><span data-slate-leaf="true" data-offset-key="12245:0" data-first-offset="true"><span data-slate-string="true">创建套接字应用程序一般要经过后面这 6 个步骤。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12246"><span data-slate-object="text" data-key="12247"><span data-slate-leaf="true" data-offset-key="12247:0" data-first-offset="true"><span data-slate-string="true">1. 创建套接字。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12248"><span data-slate-object="text" data-key="12249"><span data-slate-leaf="true" data-offset-key="12249:0" data-first-offset="true"><span data-slate-string="true">2. 将套接字与地址绑定，设置套接字选项。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12250"><span data-slate-object="text" data-key="12251"><span data-slate-leaf="true" data-offset-key="12251:0" data-first-offset="true"><span data-slate-string="true">3. 建立套接字之间的连接。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12252"><span data-slate-object="text" data-key="12253"><span data-slate-leaf="true" data-offset-key="12253:0" data-first-offset="true"><span data-slate-string="true">4. 监听套接字</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12254"><span data-slate-object="text" data-key="12255"><span data-slate-leaf="true" data-offset-key="12255:0" data-first-offset="true"><span data-slate-string="true">5. 接收、发送数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12256"><span data-slate-object="text" data-key="12257"><span data-slate-leaf="true" data-offset-key="12257:0" data-first-offset="true"><span data-slate-string="true">6. 关闭、释放套接字。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="12258" id="sr-toc-11"><span data-slate-object="text" data-key="12259"><span data-slate-leaf="true" data-offset-key="12259:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="12260"><span data-slate-object="text" data-key="12261"><span data-slate-leaf="true" data-offset-key="12261:0" data-first-offset="true"><span data-slate-string="true">我们了解的 TCP 三次握手，发生在 socket 的哪几个函数中呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12262"><span data-slate-object="text" data-key="12263"><span data-slate-leaf="true" data-offset-key="12263:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我交流，也推荐你把这节课转发给有需要的朋友。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="12264"><span data-slate-object="text" data-key="12265"><span data-slate-leaf="true" data-offset-key="12265:0" data-first-offset="true"><span data-slate-string="true">我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (9)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>四次挥手过程分析下【V5.8，正常流程】
5、客户端收到 FIN 包，子状态从 TCP_FIN_WAIT2 变为 TCP_TIME_WAIT，返回 ACK 包
A、状态和子状态都为 TCP_TIME_WAIT
【tcp_protocol.handler】tcp_v4_rcv-&gt;
-&gt;if (sk-&gt;sk_state == TCP_TIME_WAIT) goto do_time_wait;
-&gt;do_time_wait:
-&gt;tcp_timewait_state_process
-&gt;-&gt;if (tw-&gt;tw_substate == TCP_FIN_WAIT2)
-&gt;-&gt;tw-&gt;tw_substate = TCP_TIME_WAIT;
-&gt;-&gt;inet_twsk_reschedule，重新设置回调时间
-&gt;-&gt;return TCP_TW_ACK;

B、返回 ACK
-&gt;case TCP_TW_ACK:
-&gt;tcp_v4_timewait_ack (sk, skb);

6、服务端收到 ACK 包，状态从 TCP_LAST_ACK 变为 TCP_CLOSE
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_LAST_ACK:
-&gt;tcp_done
-&gt;-&gt;tcp_set_state (sk, TCP_CLOSE);

7、客户端超时回调
A、超时时间定义
#define TCP_TIMEWAIT_LEN (60*HZ)
#define TCP_FIN_TIMEOUT TCP_TIMEWAIT_LEN

B、超时后，回调 tw_timer_handler-&gt;inet_twsk_kill，进行 inet_timewait_sock 清理工作

C、没有找到状态变从 TCP_TIME_WAIT 变为 TCP_CLOSE 的代码

D、只看没调，有问题的，欢迎小伙伴告诉一下</div><div><p>作者回复: 66666</p></div><div><div>2021-08-15</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>四次挥手过程分析上【V5.8，正常流程】
1、客户端主动断开连接，状态从 TCP_ESTABLISHED 变为 TCP_FIN_WAIT1，发送 FIN 包给服务端
A、状态变为 TCP_FIN_WAIT1
tcp_close-&gt;tcp_close_state
-&gt;tcp_set_state (sk, new_state [TCP_ESTABLISHED])，也就是 TCP_FIN_WAIT1

B、发送 FIN 包
tcp_close-&gt;tcp_close_state
-&gt;tcp_send_fin

2、服务端收到 FIN 包，状态从 TCP_ESTABLISHED 变为 TCP_CLOSE_WAIT，并返回 ACK 包
A、状态变为 TCP_CLOSE_WAIT
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_established
-&gt;tcp_data_queue
-&gt;-&gt;tcp_fin
-&gt;-&gt;-&gt;inet_csk_schedule_ack; 安排 ack
-&gt;-&gt;-&gt;sk-&gt;sk_shutdown |= RCV_SHUTDOWN; 模拟了 close
-&gt;-&gt;-&gt;sock_set_flag (sk, SOCK_DONE);
-&gt;-&gt;-&gt;case TCP_ESTABLISHED:
-&gt;-&gt;-&gt;tcp_set_state (sk, TCP_CLOSE_WAIT); 修改状态
-&gt;-&gt;inet_csk (sk)-&gt;icsk_ack.pending |= ICSK_ACK_NOW;  ACS 是否立即发送

B、发送 ACK 包
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_established【接上面】
-&gt;tcp_ack_snd_check-&gt;__tcp_ack_snd_check-&gt;tcp_send_ack

3、客户端收到 ACK 包，状态从 TCP_FIN_WAIT1 变为 TCP_FIN_WAIT2，然后被替换为状态 TCP_TIME_WAIT，子状态 TCP_FIN_WAIT2
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_FIN_WAIT1:
-&gt;tcp_set_state (sk, TCP_FIN_WAIT2);
-&gt;tcp_time_wait (sk, TCP_FIN_WAIT2, tmo);
-&gt;-&gt;tw = inet_twsk_alloc (sk, tcp_death_row, state);
-&gt;-&gt;-&gt;tw-&gt;tw_state = TCP_TIME_WAIT;   
-&gt;-&gt;-&gt;tw-&gt;tw_substate = TCP_FIN_WAIT2;
-&gt;-&gt;-&gt;timer_setup (&amp;tw-&gt;tw_timer, tw_timer_handler, TIMER_PINNED);

4、服务端状态从 TCP_CLOSE_WAIT 变为 TCP_LAST_ACK，发送 FIN 包
A、状态变为 TCP_LAST_ACK
tcp_close-&gt;tcp_close_state
-&gt;tcp_set_state (sk, new_state [TCP_CLOSE_WAIT])，也就是 TCP_LAST_ACK

B、发送 FIN 包
tcp_close-&gt;tcp_close_state
-&gt;tcp_send_fin</div><div><div>2021-08-15</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>三次握手过程分析【V5.8，正常流程】
1、客户端发起第一次握手，状态调变为 TCP_SYN_SENT，发送 SYN 包
connect-&gt;__sys_connect-&gt;__sys_connect_file-&gt;【sock-&gt;ops-&gt;connect】tcp_v4_connect
A、状态变化
-&gt;tcp_set_state (sk, TCP_SYN_SENT);
B、发送 SYN
-&gt;tcp_connect-&gt;tcp_send_syn_data

2、服务端收到客户端的 SYN 包，初始化 socket，状态从 TCP_LISTEN 变为 TCP_NEW_SYN_RECV，发送第二次握手 SYN_ACK 包
A、收到连接，初始化 socket
accept-&gt;__sys_accept4-&gt;__sys_accept4_file-&gt;【sock-&gt;ops-&gt;accept】inet_csk_accept

B、收到 SYN，改变状态
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process-&gt;
-&gt;case TCP_LISTEN:
-&gt;[sock-&gt;ops-&gt;conn_request] tcp_v4_conn_request-&gt;tcp_conn_request
-&gt;-&gt;inet_reqsk_alloc
-&gt;-&gt;-&gt;ireq-&gt;ireq_state = TCP_NEW_SYN_RECV;

C、发送 SYN_ACK 包
-&gt;[sock-&gt;ops-&gt;conn_request] tcp_v4_conn_request-&gt;tcp_conn_request【和 B 路径一样】
-&gt;-&gt;【af_ops-&gt;send_synack】tcp_v4_send_synack
-&gt;-&gt;-&gt;tcp_make_synack
-&gt;-&gt;-&gt;__tcp_v4_send_check

3、客户端收到 SYN_ACK 包，状态从 TCP_SYN_SENT 变为 TCP_ESTABLISHED，并发送 ACK 包
A、收到 SYN_ACK 包
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_SYN_SENT:
-&gt;tcp_rcv_synsent_state_process-&gt;tcp_finish_connect
-&gt;-&gt;tcp_set_state (sk, TCP_ESTABLISHED);

B、发送 ACK 包
-&gt;tcp_rcv_synsent_state_process-&gt;tcp_send_ack-&gt;__tcp_send_ack

4、服务端收到 ACK 包，状态从 TCP_NEW_SYN_RECV 变为 TCP_SYN_RECV【实际上是新建了一个 sock】
【tcp_protocol.handler】tcp_v4_rcv-&gt;
-&gt;if (sk-&gt;sk_state == TCP_NEW_SYN_RECV)
-&gt;tcp_check_req
-&gt;-&gt;【inet_csk (sk)-&gt;icsk_af_ops-&gt;syn_recv_sock】tcp_v4_syn_recv_sock-&gt;tcp_create_openreq_child-&gt;inet_csk_clone_lock
-&gt;-&gt;-&gt;inet_sk_set_state (newsk, TCP_SYN_RECV);

5、服务端状态从 TCP_SYN_RECV 变为 TCP_ESTABLISHED
【tcp_protocol.handler】tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process
-&gt;case TCP_SYN_RECV:
-&gt;tcp_set_state (sk, TCP_ESTABLISHED);

只看没调，有问题的欢迎各位小伙伴指出。</div><div><p>作者回复：是的 总结到位</p></div><div><div>2021-08-14</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/85/87/727142bc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>MacBao</span></div></div><div>服务器端处于 listen 状态，客户端 connect 发起 TCP 三次握手？</div><div><div>2021-08-09</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>今天的问题不好回答，因为文中无明显三次握手的代码，而且三次握手的机制其实比较复杂，涉及到几个状态和几个队列之间的切换，笼统的 connect 和 accept 函数是说不清楚的，感兴趣可以看看这里：
https://blog.csdn.net/tennysonsky/article/details/45621341

当然这些不能全信，所以还是得自己看 linux 内核代码，待我看了再来补充😂</div><div><p>作者回复：好的 期待</p></div><div><div>2021-08-09</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/b4/7c/59e24b60.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 王子虾</span></div></div><div>老师，有一个问题，tcp 在调用 listen 的时候，有全连接队列的概念，一般上限是 128。但是问题是，我们比如实现单机百万链接的时候，一个 server 端的源组（server_ip+port），比如有 65535 个 client，那会不会受限于这个全连接队列？</div><div><p>作者回复：会，但 linux 可以修改 /proc/sys/net/core/somaxconn</p></div><div><div>2022-04-09</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>if...else...</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>nice</div><div><p>作者回复: good</p></div><div><div>2022-02-25</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>GeekCoder</span></div></div><div>能讲讲 epoll 吗？</div><div><p>作者回复：本课程是 os 实现课程 不会讲到这个</p></div><div><div>2021-10-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>这里有一篇三次握手的源码图解：https://mp.weixin.qq.com/s/vlrzGc5bFrPIr9a7HIr2eA</div><div><p>作者回复：谢谢 老铁</p></div><div><div>2021-08-09</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".s"><outline class="toc-level-h1" data-reactid=".s.0" style="width: 175px;"><active data-reactid=".s.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".s.0.1"><span data-reactid=".s.0.1.0">40 | 瞧一瞧 Linux：详解 socket 的接口实现</span></a></outline><outline class="toc-level-h2" data-reactid=".s.1" style="width: 165px;"><active data-reactid=".s.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".s.1.1"><span data-reactid=".s.1.1.0">套接字接口</span></a></outline><outline class="toc-level-h3" data-reactid=".s.2" style="width: 155px;"><active data-reactid=".s.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".s.2.1"><span data-reactid=".s.2.1.0">套接字的创建</span></a></outline><outline class="toc-level-h3" data-reactid=".s.3" style="width: 155px;"><active data-reactid=".s.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".s.3.1"><span data-reactid=".s.3.1.0">套接字的绑定</span></a></outline><outline class="toc-level-h3" data-reactid=".s.4" style="width: 155px;"><active data-reactid=".s.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".s.4.1"><span data-reactid=".s.4.1.0">主动连接</span></a></outline><outline class="toc-level-h3" data-reactid=".s.5" style="width: 155px;"><active data-reactid=".s.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".s.5.1"><span data-reactid=".s.5.1.0">监听套接字</span></a></outline><outline class="toc-level-h3" data-reactid=".s.6" style="width: 155px;"><active data-reactid=".s.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".s.6.1"><span data-reactid=".s.6.1.0">被动接收连接</span></a></outline><outline class="toc-level-h3" data-reactid=".s.7" style="width: 155px;"><active data-reactid=".s.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".s.7.1"><span data-reactid=".s.7.1.0">发送数据</span></a></outline><outline class="toc-level-h3" data-reactid=".s.8" style="width: 155px;"><active data-reactid=".s.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".s.8.1"><span data-reactid=".s.8.1.0">接收数据</span></a></outline><outline class="toc-level-h3" data-reactid=".s.9" style="width: 155px;"><active data-reactid=".s.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".s.9.1"><span data-reactid=".s.9.1.0">关闭连接</span></a></outline><outline class="toc-level-h2" data-reactid=".s.a" style="width: 165px;"><active data-reactid=".s.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".s.a.1"><span data-reactid=".s.a.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".s.b" style="width: 165px;"><active data-reactid=".s.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".s.b.1"><span data-reactid=".s.b.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".s.c" style="width: 165px;"><active data-reactid=".s.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".s.c.1"><span data-reactid=".s.c.1.0">精选留言 (9)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/405781" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>