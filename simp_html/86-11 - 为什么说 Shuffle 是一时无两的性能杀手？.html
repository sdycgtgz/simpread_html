
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 11 | 为什么说 Shuffle 是一时无两的性能杀手？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>11 | 为什么说 Shuffle 是一时无两的性能杀手？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">你知道 Spark 是如何使用内存的吗？不同的内存区域之间的关系是什么，它们又是如何划分的？今天，我就来和你深入探讨一下。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">11 | 为什么说 Shuffle 是一时无两的性能杀手？</h1><div><span>吴磊</span> <span> 2021-04-07</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e0/c5/e0d924253c53d02676cd2808d6b8fcc5.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：吴磊</span><span>大小：19.26M</span><span> 时长：21:05</span></div></div><audio title="11 | 为什么说Shuffle是一时无两的性能杀手？" src="https://res001.geekbang.org/media/audio/c7/c0/c78d924b9db6931ec74a05c826e069c0/ld/ld.m3u8" __idm_id__="131077"></audio></div><div><div><div><div data-slate-editor="true" data-key="1142" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="1143"><span data-slate-object="text" data-key="1144"><span data-slate-leaf="true" data-offset-key="1144:0" data-first-offset="true"><span data-slate-string="true">你好，我是吴磊。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1145"><span data-slate-object="text" data-key="1146"><span data-slate-leaf="true" data-offset-key="1146:0" data-first-offset="true"><span data-slate-string="true">一提到 Shuffle，你能想到什么？我想很多人的第一反应都是应用中最顽固、最难解决的性能瓶颈。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1147"><span data-slate-object="text" data-key="1148"><span data-slate-leaf="true" data-offset-key="1148:0" data-first-offset="true"><span data-slate-string="true">在之前的课程中，我们也不止一次地提到 Shuffle，尤其是在开发原则那一讲，我还建议你遵循 “能省则省、能拖则拖” 的原则，在应用中尽量去避免 Shuffle，如果受业务逻辑所限确实不能避免，就尽可能地把 Shuffle 往后拖。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1149"><span data-slate-object="text" data-key="1150"><span data-slate-leaf="true" data-offset-key="1150:0" data-first-offset="true"><span data-slate-string="true">那么，为什么我们一谈 Shuffle 就色变，提到它就避之唯恐不及呢？今天这一讲，我就通过实现一个仙女散花游戏的过程，来和你深入探讨 Shuffle 是如何工作的，说说它为什么是分布式应用一时无两的性能杀手。毕竟，只有了解 Shuffle 的工作原理，我们才能更好地避免它。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1151" id="sr-toc-1"><span data-slate-object="text" data-key="1152"><span data-slate-leaf="true" data-offset-key="1152:0" data-first-offset="true"><span data-slate-string="true">如何理解 Shuffle？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1153"><span data-slate-object="text" data-key="1154"><span data-slate-leaf="true" data-offset-key="1154:0" data-first-offset="true"><span data-slate-string="true">假设，你的老板今天给你安排一个开发任务，让你用 Spark 去实现一个游戏需求。这个实现需求来自一个小故事：仙女散花。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1155"><span data-slate-object="text" data-key="1156"><span data-slate-leaf="true" data-offset-key="1156:0" data-first-offset="true"><span data-slate-string="true">很久以前，燕山脚下有个小村庄，村子里有所 “七色光” 小学，方圆百里的孩子都来这里上学。这一天，一年级 2 班的黄老师和班里的五个孩子正在做一个游戏，叫做 “仙女散花”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1157"><span data-slate-object="text" data-key="1158"><span data-slate-leaf="true" data-offset-key="1158:0" data-first-offset="true"><span data-slate-string="true">黄老师的背包里装满了五种不同颜色的花朵，五种颜色分别是红、橙、黄、紫、青。她把背包里的花朵随机地分发给五个小同学：小红、橙橙、黄小乙、阿紫和小青。花朵发完之后，每个同学分到的花朵数量差不多，颜色各有不同。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1159"><span data-slate-object="text" data-key="1160"><span data-slate-leaf="true" data-offset-key="1160:0" data-first-offset="true"><span data-slate-string="true">接着，黄老师开始宣布游戏规则：“你们要一起协作，在最短的时间内，把花朵按照颜色收集在一起。游戏完成的标志是，课桌上有 5 堆花朵，每堆花朵的颜色都是一样的。”</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1161"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7c/yc/7cb3906ecd19fa0521c4a161f079dyyc.jpg?wh=8046*4245"></div><div>仙女散花的游戏</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1162"><span data-slate-object="text" data-key="1163"><span data-slate-leaf="true" data-offset-key="1163:0" data-first-offset="true"><span data-slate-string="true">大家跃跃欲试，黄小乙说：“先别急，我们来制定个策略。先在前面摆上 5 张课桌，然后每个人需要做两件事情，先把自己手里的花朵按照颜色归类分为 5 堆，再把分好颜色的花朵，分别放到相应的课桌上！” 于是，几个小同学按照黄小乙说的策略，不一会儿就完成了游戏。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1164"><span data-slate-object="text" data-key="1165"><span data-slate-leaf="true" data-offset-key="1165:0" data-first-offset="true"><span data-slate-string="true">事实上，仙女散花的游戏过程和 Shuffle 的工作流程大同小异。当然，Shuffle 过程中涉及的步骤和环节，要比 “仙女散花” 复杂一些。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1166"><span data-slate-object="text" data-key="1167"><span data-slate-leaf="true" data-offset-key="1167:0" data-first-offset="true"><span data-slate-string="true">Shuffle 的本意是 “洗牌”，在分布式计算环境中，它有两个阶段。一般来说，前一个阶段叫做 “Map 阶段”，后一个阶段叫做 “Reduce 阶段”。当然，也有人把它们叫做 Shuffle Write 阶段和 Shuffle Read 阶段。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1168"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/c4/d7/c4062c2a0d6fd31b425034a8f53159d7.jpg?wh=8112*4893"></div><div>仙女散花中的 Map 和 Reduce 阶段</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1169"><span data-slate-object="text" data-key="1170"><span data-slate-leaf="true" data-offset-key="1170:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在仙女散花的游戏中，从老师分发花朵，到 5 个小同学把花朵按照颜色归类，对应的是 Shuffle 的 Map 阶段，而大家把归类的花朵分发到相应的课桌，这个过程类似于 Shuffle 的 Reduce 阶段。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1171"><span data-slate-object="text" data-key="1172"><span data-slate-leaf="true" data-offset-key="1172:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就借助这个故事来深入探讨 Shuffle 的两个阶段：Map 阶段和 Reduce 阶段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1173"><span data-slate-object="text" data-key="1174"><span data-slate-leaf="true" data-offset-key="1174:0" data-first-offset="true"><span data-slate-string="true">自 2.0 版本之后，Spark 将 Shuffle 操作统一交由 Sort shuffle manager 来管理。因此，今天这一讲，我们专注于 Sort shuffle manager 实现的 Shuffle 分发过程。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1175" id="sr-toc-2"><span data-slate-object="text" data-key="1176"><span data-slate-leaf="true" data-offset-key="1176:0" data-first-offset="true"><span data-slate-string="true">Map 阶段是如何输出中间文件的？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1177"><span data-slate-object="text" data-key="1178"><span data-slate-leaf="true" data-offset-key="1178:0" data-first-offset="true"><span data-slate-string="true">以终为始、以结果为导向的学习往往效率更高，在深入探讨 Map 阶段如何生产数据之前，我们不妨先来明确：</span></span></span><span data-slate-object="text" data-key="1179"><span data-slate-leaf="true" data-offset-key="1179:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Map 阶段的输出到底是什么？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1180"><span data-slate-object="text" data-key="1181"><span data-slate-leaf="true" data-offset-key="1181:0" data-first-offset="true"><span data-slate-string="true">之前我们也说过，Map 阶段最终生产的数据会以中间文件的形式物化到磁盘中，这些中间文件就存储在 spark.local.dir 设置的文件目录里。中间文件包含两种类型：一类是后缀为 data 的数据文件，</span></span><span data-slate-leaf="true" data-offset-key="1181:1"><span data-slate-object="annotation" data-annotation-key="gkann_ebfd3016" data-attr-id="29721" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">存储的内容是 Map 阶段生产的待分发数据；另一类是后缀为 index 的索引文件，它记录的是数据文件中不同分区的偏移地址。</span></span></span><span data-slate-leaf="true" data-offset-key="1181:2"><span data-slate-string="true">这里的分区是指 Reduce 阶段的分区，</span></span></span><span data-slate-object="text" data-key="1182"><span data-slate-leaf="true" data-offset-key="1182:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">因此，分区数量与 Reduce 阶段的并行度保持一致。</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1183"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/85/c5/85f8e918e65792527889a71e2ca55dc5.jpg?wh=5055*2682"></div><div>Map 阶段输出的数据文件和索引文件</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1184"><span data-slate-object="text" data-key="1185"><span data-slate-leaf="true" data-offset-key="1185:0" data-first-offset="true"><span data-slate-string="true">这样一来，我们就可以把问题进一步聚焦在，Spark 在 Map 阶段是如何生产这些中间文件的。不过，我们首先需要明确的是，Map 阶段每一个 Task 的执行流程都是一样的，每个 Task 最终都会生成一个数据文件和一个索引文件。</span></span></span><span data-slate-object="text" data-key="1186"><span data-slate-leaf="true" data-offset-key="1186:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">因此，中间文件的数量与 Map 阶段的并行度保持一致。</span></span></span></span><span data-slate-object="text" data-key="1187"><span data-slate-leaf="true" data-offset-key="1187:0" data-first-offset="true"><span data-slate-string="true">换句话说，有多少个 Task，Map 阶段就会生产相应数量的数据文件和索引文件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1188"><span data-slate-object="text" data-key="1189"><span data-slate-leaf="true" data-offset-key="1189:0" data-first-offset="true"><span data-slate-string="true">接下来，我带你用 Spark 来实现 “仙女散花” 的游戏，咱们一边做游戏，一边来分析 Map 阶段的中间文件是如何产生的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1190" id="sr-toc-3"><span data-slate-object="text" data-key="1191"><span data-slate-leaf="true" data-offset-key="1191:0" data-first-offset="true"><span data-slate-string="true">用 groupByKey 实现 “仙女散花”</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1192"><span data-slate-object="text" data-key="1193"><span data-slate-leaf="true" data-offset-key="1193:0" data-first-offset="true"><span data-slate-string="true">在 “仙女散花” 的游戏中，黄老师要求大家把同一种花色的花朵</span></span></span><span data-slate-object="text" data-key="1194"><span data-slate-leaf="true" data-offset-key="1194:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">收集</span></span></span></span><span data-slate-object="text" data-key="1195"><span data-slate-leaf="true" data-offset-key="1195:0" data-first-offset="true"><span data-slate-string="true">到一起。那么，在 Spark 的分布式开发框架内，与这个游戏最相仿的计算过程非 groupByKey 莫属，所以我们不妨用 groupByKey 来实现游戏。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1196"><span data-slate-object="text" data-key="1197"><span data-slate-leaf="true" data-offset-key="1197:0" data-first-offset="true"><span data-slate-string="true">首先是 flowers.txt 文件：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="1198"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1199"><span data-slate-object="text" data-key="1200"><span data-slate-leaf="true" data-offset-key="1200:0" data-first-offset="true"><span data-slate-string="true">黄色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1201"><span data-slate-object="text" data-key="1202"><span data-slate-leaf="true" data-offset-key="1202:0" data-first-offset="true"><span data-slate-string="true">紫色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1203"><span data-slate-object="text" data-key="1204"><span data-slate-leaf="true" data-offset-key="1204:0" data-first-offset="true"><span data-slate-string="true">红色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1205"><span data-slate-object="text" data-key="1206"><span data-slate-leaf="true" data-offset-key="1206:0" data-first-offset="true"><span data-slate-string="true">橙色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1207"><span data-slate-object="text" data-key="1208"><span data-slate-leaf="true" data-offset-key="1208:0" data-first-offset="true"><span data-slate-string="true">青色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1209"><span data-slate-object="text" data-key="1210"><span data-slate-leaf="true" data-offset-key="1210:0" data-first-offset="true"><span data-slate-string="true">黄色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1211"><span data-slate-object="text" data-key="1212"><span data-slate-leaf="true" data-offset-key="1212:0" data-first-offset="true"><span data-slate-string="true">紫色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1213"><span data-slate-object="text" data-key="1214"><span data-slate-leaf="true" data-offset-key="1214:0" data-first-offset="true"><span data-slate-string="true">橙色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1215"><span data-slate-object="text" data-key="1216"><span data-slate-leaf="true" data-offset-key="1216:0" data-first-offset="true"><span data-slate-string="true">青色花朵</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1217"><span data-slate-object="text" data-key="1218"><span data-slate-leaf="true" data-offset-key="1218:0" data-first-offset="true"><span data-slate-string="true">......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1219"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1220"><span data-slate-object="text" data-key="1221"><span data-slate-leaf="true" data-offset-key="1221:0" data-first-offset="true"><span data-slate-string="true">其次是同学小 A 接到需求后，用 groupByKey 实现 “仙女散花” 游戏的代码：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1222"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1223"><span data-slate-object="text" data-key="1224"><span data-slate-leaf="true" data-offset-key="1224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1225"><span data-slate-leaf="true" data-offset-key="1225:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1226"><span data-slate-leaf="true" data-offset-key="1226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flowers</span></span></span></span><span data-slate-object="text" data-key="1227"><span data-slate-leaf="true" data-offset-key="1227:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1228"><span data-slate-leaf="true" data-offset-key="1228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1229"><span data-slate-leaf="true" data-offset-key="1229:0" data-first-offset="true"><span data-slate-string="true"> spark.sparkContext.textFile(</span></span></span><span data-slate-object="text" data-key="1230"><span data-slate-leaf="true" data-offset-key="1230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"flowers.txt"</span></span></span></span><span data-slate-object="text" data-key="1231"><span data-slate-leaf="true" data-offset-key="1231:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1232"><span data-slate-object="text" data-key="1233"><span data-slate-leaf="true" data-offset-key="1233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 黄老师给 5 个小同学分发花朵</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1234"><span data-slate-object="text" data-key="1235"><span data-slate-leaf="true" data-offset-key="1235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1236"><span data-slate-leaf="true" data-offset-key="1236:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1237"><span data-slate-leaf="true" data-offset-key="1237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flowersForKids</span></span></span></span><span data-slate-object="text" data-key="1238"><span data-slate-leaf="true" data-offset-key="1238:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1239"><span data-slate-leaf="true" data-offset-key="1239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1240"><span data-slate-leaf="true" data-offset-key="1240:0" data-first-offset="true"><span data-slate-string="true"> flowers.coalesce(</span></span></span><span data-slate-object="text" data-key="1241"><span data-slate-leaf="true" data-offset-key="1241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="1242"><span data-slate-leaf="true" data-offset-key="1242:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1243"><span data-slate-object="text" data-key="1244"><span data-slate-leaf="true" data-offset-key="1244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1245"><span data-slate-leaf="true" data-offset-key="1245:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1246"><span data-slate-leaf="true" data-offset-key="1246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flowersKV</span></span></span></span><span data-slate-object="text" data-key="1247"><span data-slate-leaf="true" data-offset-key="1247:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1248"><span data-slate-leaf="true" data-offset-key="1248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1249"><span data-slate-leaf="true" data-offset-key="1249:0" data-first-offset="true"><span data-slate-string="true"> flowersForKids.map((_, </span></span></span><span data-slate-object="text" data-key="1250"><span data-slate-leaf="true" data-offset-key="1250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1251"><span data-slate-leaf="true" data-offset-key="1251:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1252"><span data-slate-object="text" data-key="1253"><span data-slate-leaf="true" data-offset-key="1253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 黄小乙的两个步骤：大家先各自按颜色归类，然后再把归类后的花朵放到相应的课桌上 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1254"><span data-slate-object="text" data-key="1255"><span data-slate-leaf="true" data-offset-key="1255:0" data-first-offset="true"><span data-slate-string="true">flowersKV.groupByKey.collect</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1256"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1257"><span data-slate-object="text" data-key="1258"><span data-slate-leaf="true" data-offset-key="1258:0" data-first-offset="true"><span data-slate-string="true">我们可以看到，代码步骤与游戏过程基本上一一对应。但是，读取完花朵文件之后，由于 groupByKey 是 pairRDD 算子，需要消费（Key，Value）形式的数据，因此我们需要对原始花朵数据做一次转换。以数据分区 0 为例，数据的转换过程如下图所示，你不妨把数据分区 0 理解为是黄老师分发给小红的花朵。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1259"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/19/e5/199ef31535ccabdcb2fa172cafb036e5.jpg?wh=3699*1269"></div><div>将原始数据转换为 pairRDD</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1260"><span data-slate-object="text" data-key="1261"><span data-slate-leaf="true" data-offset-key="1261:0" data-first-offset="true"><span data-slate-string="true">基于 pairRDD 的 Key，也就是花朵的颜色，Map Task 就可以计算每条数据记录在 Reduce 阶段的目标分区，目标分区也就是游戏中的课桌。在黄小乙制定的策略中，哪种花放到哪张桌子是大家事先商定好的，但在 Spark 中，每条数据记录应该分发到哪个目标分区，是由 Key 的哈希值决定的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1262"><span data-slate-object="text" data-key="1263"><span data-slate-leaf="true" data-offset-key="1263:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">目标分区计算好之后，Map Task 会把每条数据记录和它的目标分区，放到一个特殊的数据结构里，</span></span></span><span data-slate-leaf="true" data-offset-key="1263:1"><span data-slate-object="annotation" data-annotation-key="gkann_ecf11f70" data-attr-id="42327" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这个数据结构叫做 “PartitionedPairBuffer”</span></span></span></span></span><span data-slate-object="text" data-key="1264"><span data-slate-leaf="true" data-offset-key="1264:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_ecf11f70" data-attr-id="42327" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，</span></span></span><span data-slate-leaf="true" data-offset-key="1264:1"><span data-slate-string="true">它本质上就是一种数组形式的缓存结构。它是怎么存储数据记录的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1265"><span data-slate-object="text" data-key="1266"><span data-slate-leaf="true" data-offset-key="1266:0" data-first-offset="true"><span data-slate-string="true">每条数据记录都会占用数组中相邻的两个元素空间，</span></span><span data-slate-leaf="true" data-offset-key="1266:1"><span data-slate-object="annotation" data-annotation-key="gkann_8753043c" data-attr-id="29881" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">第一个元素是（目标分区，Key），第二个元素是 Value。</span></span></span><span data-slate-leaf="true" data-offset-key="1266:2"><span data-slate-string="true">假设 PartitionedPairBuffer 的大小是 4，也就是最多只能存储 4 条数据记录。那么，如果我们还以数据分区 0 为例，小红的前 4 枚花朵在 PartitionedPairBuffer 中的存储状态就会如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1267"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/36/28/36fd9b5318e82bf1a3264fb558c0e128.jpg?wh=4926*1014"></div><div>PartitionedPairBuffer 存储小红的前 4 枚花朵</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1268"><span data-slate-object="text" data-key="1269"><span data-slate-leaf="true" data-offset-key="1269:0" data-first-offset="true"><span data-slate-string="true">对我们来说，最理想的情况当然是 PartitionedPairBuffer 足够大，大到足以容纳 Map Task 所需处理的所有数据。不过，现实总是很骨感，每个 Task 分到的内存空间是有限的，PartitionedPairBuffer 自然也不能保证能容纳分区中的所有数据。因此，</span></span></span><span data-slate-object="text" data-key="1270"><span data-slate-leaf="true" data-offset-key="1270:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Spark 需要一种计算机制，来保障在数据总量超出可用内存的情况下，依然能够完成计算。这种机制就是：排序、溢出、归并。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1271"><span data-slate-object="text" data-key="1272"><span data-slate-leaf="true" data-offset-key="1272:0" data-first-offset="true"><span data-slate-string="true">就拿大小为 4 的 PartitionedPairBuffer 来说，数据分区 0 里面有 16 朵花，对应着 16 条数据记录，它们至少要分 4 批才能依次完成处理。在处理下一批数据之前，Map Task 得先把 PartitionedPairBuffer 中已有的数据腾挪出去，腾挪的方式简单粗暴，Map Task 直接把数据溢出到磁盘中的临时文件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1273"><span data-slate-object="text" data-key="1274"><span data-slate-leaf="true" data-offset-key="1274:0" data-first-offset="true"><span data-slate-string="true">不过，在溢出之前，对于 PartitionedPairBuffer 中已有的数据，Map Task 会先按照数据记录的第一个元素，也就是目标分区 + Key 进行排序。也就是说，尽管数据暂时溢出到了磁盘，但是临时文件中的数据也是有序的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1275"><span data-slate-object="text" data-key="1276"><span data-slate-leaf="true" data-offset-key="1276:0" data-first-offset="true"><span data-slate-string="true">就这样，PartitionedPairBuffer 腾挪了一次又一次，数据分区 0 里面的花朵处理了一批又一批，直到所有的花朵都被处理完。分区 0 有 16 朵花，PartitionedPairBuffer 的大小是 4，因此，PartitionedPairBuffer 总共被腾挪了 3 次，生成了 3 个临时文件，每个临时文件中包含 4 条数据记录。16 条数据，有 12 条分散在 3 个文件中，还有 4 条缓存在 PartitionedPairBuffer 里。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1277"><span data-slate-object="text" data-key="1278"><span data-slate-leaf="true" data-offset-key="1278:0" data-first-offset="true"><span data-slate-string="true">到此为止，我们离 Map 阶段生产的、用于在网络中分发数据的中间文件仅有一步之遥了。还记得吗？Map 阶段生产的中间文件有两类，一类是数据文件，另一类是索引文件。分散在 3 个临时文件和 PartitionedPairBuffer 里的数据记录，就是生成这两类文件的输入源。最终，Map Task 用归并排序的算法，将 4 个输入源中的数据写入到数据文件和索引文件中去，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1279"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/47/9a/4778e6e7ba922b101936a4c983b3ed9a.jpg?wh=6669*5004"></div><div>归并临时文件，生成最终的中间文件</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1280"><span data-slate-object="text" data-key="1281"><span data-slate-leaf="true" data-offset-key="1281:0" data-first-offset="true"><span data-slate-string="true">好了，到目前为止，我们用 groupByKey 实现了 “仙女散花” 的游戏，详细讲解了 Map 阶段生产中间文件的过程。虽然 Map 阶段的计算步骤很多，但其中最主要的环节可以归结为 4 步：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1282"><span data-slate-object="text" data-key="1283"><span data-slate-leaf="true" data-offset-key="1283:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">1.  对于分片中的数据记录，逐一计算其目标分区，并将其填充到 PartitionedPairBuffer；</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1284"><span data-slate-object="text" data-key="1285"><span data-slate-leaf="true" data-offset-key="1285:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">2.  PartitionedPairBuffer 填满后，如果分片中还有未处理的数据记录，就对 Buffer 中的数据记录按（目标分区 ID，Key）进行排序，将所有数据溢出到临时文件，同时清空缓存；</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1286"><span data-slate-object="text" data-key="1287"><span data-slate-leaf="true" data-offset-key="1287:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">3.  重复步骤 1、2，直到分片中所有的数据记录都被处理；</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1288"><span data-slate-object="text" data-key="1289"><span data-slate-leaf="true" data-offset-key="1289:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a38558cb" data-attr-id="35190" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">4.  对所有临时文件和 PartitionedPairBuffer 归并排序，最终生成数据文件和索引文件。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1290"><span data-slate-object="text" data-key="1291"><span data-slate-leaf="true" data-offset-key="1291:0" data-first-offset="true"><span data-slate-string="true">不难发现，仙女散花其实就是个分组、收集的游戏。应该说，用 Spark 来实现分组、收集类的游戏还是比较简单的，那么，如果把仙女散花变成是 “分组、统计” 的游戏，我们该怎么做呢？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1292" id="sr-toc-4"><span data-slate-object="text" data-key="1293"><span data-slate-leaf="true" data-offset-key="1293:0" data-first-offset="true"><span data-slate-string="true">“仙女散花” 游戏升级</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1294"><span data-slate-object="text" data-key="1295"><span data-slate-leaf="true" data-offset-key="1295:0" data-first-offset="true"><span data-slate-string="true">5 个小同学完成游戏之后，离下课时间还早。因此，黄老师调整了游戏规则：“你们五个人还是一起协作，这次要在最短的时间内，统计不同花色花朵的数量。”</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1296"><span data-slate-object="text" data-key="1297"><span data-slate-leaf="true" data-offset-key="1297:0" data-first-offset="true"><span data-slate-string="true">小红迫不及待地说：“很简单！还是按照刚才的策略，先把花朵分好堆，然后我们五个人分别去课桌上数数就好啦！”</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1298"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/d2/11/d2f80245237d63a5b8977107320c2811.jpg?wh=10272*4245"></div><div>小红的主意</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1299"><span data-slate-object="text" data-key="1300"><span data-slate-leaf="true" data-offset-key="1300:0" data-first-offset="true"><span data-slate-string="true">黄小乙皱了皱眉，说道：“别急，新的游戏规则也是有时间限制的，我想了一个和你差不多的办法，一共分三步：第一步，每个人把手里不同花色花朵的数量先算出来；第二步，我们只需要把花朵的数量写到相应的桌子上；第三步，我们分别对五张课桌上的数字求和。这样就能完成得更快了”</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1301"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/df/e3/df99bcca853e4948718617672ebddce3.jpg?wh=10272*4278"></div><div>黄小乙的主意</div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1302" id="sr-toc-5"><span data-slate-object="text" data-key="1303"><span data-slate-leaf="true" data-offset-key="1303:0" data-first-offset="true"><span data-slate-string="true">用 reduceByKey 实现升级后的仙女散花</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1304"><span data-slate-object="text" data-key="1305"><span data-slate-leaf="true" data-offset-key="1305:0" data-first-offset="true"><span data-slate-string="true">如果我们想用 Spark 来实现升级后的游戏，该怎么办呢？其实很简单，只要把 groupByKey 换成 reduceByKey 就好了。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1306"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1307"><span data-slate-object="text" data-key="1308"><span data-slate-leaf="true" data-offset-key="1308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1309"><span data-slate-leaf="true" data-offset-key="1309:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1310"><span data-slate-leaf="true" data-offset-key="1310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flowers</span></span></span></span><span data-slate-object="text" data-key="1311"><span data-slate-leaf="true" data-offset-key="1311:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1312"><span data-slate-leaf="true" data-offset-key="1312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1313"><span data-slate-leaf="true" data-offset-key="1313:0" data-first-offset="true"><span data-slate-string="true"> spark.sparkContext.textFile(</span></span></span><span data-slate-object="text" data-key="1314"><span data-slate-leaf="true" data-offset-key="1314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"flowers.txt"</span></span></span></span><span data-slate-object="text" data-key="1315"><span data-slate-leaf="true" data-offset-key="1315:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1316"><span data-slate-object="text" data-key="1317"><span data-slate-leaf="true" data-offset-key="1317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 黄老师给 5 个小同学分发花朵</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1318"><span data-slate-object="text" data-key="1319"><span data-slate-leaf="true" data-offset-key="1319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1320"><span data-slate-leaf="true" data-offset-key="1320:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1321"><span data-slate-leaf="true" data-offset-key="1321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flowersForKids</span></span></span></span><span data-slate-object="text" data-key="1322"><span data-slate-leaf="true" data-offset-key="1322:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1323"><span data-slate-leaf="true" data-offset-key="1323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1324"><span data-slate-leaf="true" data-offset-key="1324:0" data-first-offset="true"><span data-slate-string="true"> flowers.coalesce(</span></span></span><span data-slate-object="text" data-key="1325"><span data-slate-leaf="true" data-offset-key="1325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="1326"><span data-slate-leaf="true" data-offset-key="1326:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1327"><span data-slate-object="text" data-key="1328"><span data-slate-leaf="true" data-offset-key="1328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1329"><span data-slate-leaf="true" data-offset-key="1329:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1330"><span data-slate-leaf="true" data-offset-key="1330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flowersKV</span></span></span></span><span data-slate-object="text" data-key="1331"><span data-slate-leaf="true" data-offset-key="1331:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1332"><span data-slate-leaf="true" data-offset-key="1332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1333"><span data-slate-leaf="true" data-offset-key="1333:0" data-first-offset="true"><span data-slate-string="true"> flowersForKids.map((_, </span></span></span><span data-slate-object="text" data-key="1334"><span data-slate-leaf="true" data-offset-key="1334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1335"><span data-slate-leaf="true" data-offset-key="1335:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1336"><span data-slate-object="text" data-key="1337"><span data-slate-leaf="true" data-offset-key="1337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 黄小乙的两个步骤：大家先各自按颜色计数，然后再按照课桌统一计数 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1338"><span data-slate-object="text" data-key="1339"><span data-slate-leaf="true" data-offset-key="1339:0" data-first-offset="true"><span data-slate-string="true">flowersKV.reduceByKey(_ + _).collect</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1340"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1341"><span data-slate-object="text" data-key="1342"><span data-slate-leaf="true" data-offset-key="1342:0" data-first-offset="true"><span data-slate-string="true">接下来，我们来分析一下 reduceByKey 的 Map 阶段计算，相比 groupByKey 有何不同。就 Map 端的计算步骤来说，reduceByKey 与刚刚讲的 groupByKey 一样，都是先填充内存数据结构，然后排序溢出，最后归并排序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1343"><span data-slate-object="text" data-key="1344"><span data-slate-leaf="true" data-offset-key="1344:0" data-first-offset="true"><span data-slate-string="true">区别在于，在计算的过程中，</span></span></span><span data-slate-object="text" data-key="1345"><span data-slate-leaf="true" data-offset-key="1345:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">reduceByKey 采用一种叫做 PartitionedAppendOnlyMap 的数据结构来填充数据记录</span></span></span></span><span data-slate-object="text" data-key="1346"><span data-slate-leaf="true" data-offset-key="1346:0" data-first-offset="true"><span data-slate-string="true">。这个数据结构是一种 Map，而 </span></span></span><span data-slate-object="text" data-key="1347"><span data-slate-leaf="true" data-offset-key="1347:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Map 的 Value 值是可累加、可更新的</span></span></span></span><span data-slate-object="text" data-key="1348"><span data-slate-leaf="true" data-offset-key="1348:0" data-first-offset="true"><span data-slate-string="true">。因此，PartitionedAppendOnlyMap 非常适合聚合类的计算场景，如计数、求和、均值计算、极值计算等等。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1349"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a3/a4/a3e397dd3ce348f10eae76f809f37ca4.jpg?wh=4929*1014"></div><div>大小为 4 的 PartitionedAppendOnlyMap</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1350"><span data-slate-object="text" data-key="1351"><span data-slate-leaf="true" data-offset-key="1351:0" data-first-offset="true"><span data-slate-string="true">在上图中，4 个 KV 对的 Value 值，是扫描到数据分区 0 当中青色花朵之前的状态。在 PartitionedAppendOnlyMap 中，由于 Value 是可累加、可更新的，因此这种数据结构可以容纳的花朵数量一定比 4 大。因此，相比 PartitionedPairBuffer，PartitionedAppendOnlyMap 的存储效率要高得多，溢出数据到磁盘文件的频率也要低得多。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1352"><span data-slate-object="text" data-key="1353"><span data-slate-leaf="true" data-offset-key="1353:0" data-first-offset="true"><span data-slate-string="true">以此类推，最终合并的数据文件也会小很多。</span></span></span><span data-slate-object="text" data-key="1354"><span data-slate-leaf="true" data-offset-key="1354:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">依靠高效的内存数据结构、更少的磁盘文件、更小的文件尺寸，我们就能大幅降低了 Shuffle 过程中的磁盘和网络开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1355"><span data-slate-object="text" data-key="1356"><span data-slate-leaf="true" data-offset-key="1356:0" data-first-offset="true"><span data-slate-string="true">事实上，相比 groupByKey、collect_list 这些收集类算子，聚合类算子（reduceByKey、aggregateByKey 等）在执行性能上更占优势。</span></span></span><span data-slate-object="text" data-key="1357"><span data-slate-leaf="true" data-offset-key="1357:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">因此，我们要避免在聚合类的计算需求中，引入收集类的算子。</span></span></span></span><span data-slate-object="text" data-key="1358"><span data-slate-leaf="true" data-offset-key="1358:0" data-first-offset="true"><span data-slate-string="true">虽然这种做法不妨碍业务逻辑实现，但在性能调优上可以说是大忌。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1359" id="sr-toc-6"><span data-slate-object="text" data-key="1360"><span data-slate-leaf="true" data-offset-key="1360:0" data-first-offset="true"><span data-slate-string="true">Reduce 阶段是如何进行数据分发的？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1361"><span data-slate-object="text" data-key="1362"><span data-slate-leaf="true" data-offset-key="1362:0" data-first-offset="true"><span data-slate-string="true">最后，我们再来说说 Reduce 阶段，在 “仙女散花” 的游戏里，每个人把自己的花朵归好类之后，主动地把不同颜色的花朵放到相应的课桌上，这个过程实际上就是 Shuffle 过程中的数据分发。不过，与课桌被动地接收花朵不同的是，Shuffle 在 Reduce 阶段是主动地从 Map 端的中间文件中拉取数据。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1363"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/78/eb/78d2b2e4ee2aba1a0473367f96da7aeb.jpg?wh=5052*2679"></div><div>Map 阶段输出的数据文件和索引文件</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1364"><span data-slate-object="text" data-key="1365"><span data-slate-leaf="true" data-offset-key="1365:0" data-first-offset="true"><span data-slate-string="true">刚刚讲过，每个 Map Task 都会生成如上图所示的中间文件，文件中的分区数与 Reduce 阶段的并行度一致。换句话说，每个 Map Task 生成的数据文件，都包含所有 Reduce Task 所需的部分数据。因此，任何一个 Reduce Task 要想完成计算，必须先从所有 Map Task 的中间文件里去拉取属于自己的那部分数据。索引文件正是用于帮助判定哪部分数据属于哪个 Reduce Task。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1366"><span data-slate-object="text" data-key="1367"><span data-slate-leaf="true" data-offset-key="1367:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Reduce Task 通过网络拉取中间文件的过程，实际上就是不同 Stages 之间数据分发的过程</span></span></span></span><span data-slate-object="text" data-key="1368"><span data-slate-leaf="true" data-offset-key="1368:0" data-first-offset="true"><span data-slate-string="true">。在 “仙女散花” 的游戏中，5 个孩子与 5 张课桌之间，需要往返 25 人次。如果让 100 个孩子把 100 种颜色的花朵，分别收集到 100 张课桌上，那么这 100 个孩子与 100 张课桌之间，就需要 10000 人次的往返！显然，Shuffle 中数据分发的网络开销，会随着 Map Task 与 Reduce Task 的线性增长，呈指数级爆炸。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1369"><span data-slate-object="text" data-key="1370"><span data-slate-leaf="true" data-offset-key="1370:0" data-first-offset="true"><span data-slate-string="true">Reduce Task 将拉取到的数据块填充到读缓冲区，然后按照任务的计算逻辑不停地消费、处理缓冲区中的数据记录，如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1371"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/2c/eb/2c4ec7fb70bfd103f70f24e56yya91eb.jpg?wh=10749*2208"></div><div>Reduce 阶段的计算过程</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1372"><span data-slate-object="text" data-key="1373"><span data-slate-leaf="true" data-offset-key="1373:0" data-first-offset="true"><span data-slate-string="true">我们可以看到，Reduce 阶段用圆圈标记的 1、2、3、4 与 Map 阶段的四个步骤一模一样。没错，因即是果、果即是因，当我们说某个 Stage 是 Map 阶段或是 Reduce 阶段的时候，我们的出发点或者说锚点就是 Shuffle。对于上图的 Shuffle 0 来说，Stage 0 是 Map 阶段，Stage 1 是 Reduce 阶段。但是，对于后面的 Shuffle 1 来说，Stage 1 就变成了 Map 阶段。因此你看，当我们把视角拉宽，Map 和 Reduce 这两个看似对立的东西，其实有很多地方都是相通的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1374" id="sr-toc-7"><span data-slate-object="text" data-key="1375"><span data-slate-leaf="true" data-offset-key="1375:0" data-first-offset="true"><span data-slate-string="true">性能杀手</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1376"><span data-slate-object="text" data-key="1377"><span data-slate-leaf="true" data-offset-key="1377:0" data-first-offset="true"><span data-slate-string="true">想必经过上面两个阶段的分析，你已经对 Shuffle 为何会成为性能瓶颈，有了比较直观的感受。这里，我再带你总结一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1378"><span data-slate-object="text" data-key="1379"><span data-slate-leaf="true" data-offset-key="1379:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先，对于 Shuffle 来说，它需要消耗所有的硬件资源</span></span></span></span><span data-slate-object="text" data-key="1380"><span data-slate-leaf="true" data-offset-key="1380:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1381"><div data-slate-type="list-line" data-slate-object="block" data-key="1382"><span data-slate-object="text" data-key="1383"><span data-slate-leaf="true" data-offset-key="1383:0" data-first-offset="true"><span data-slate-string="true">无论是 PartitionedPairBuffer、PartitionedAppendOnlyMap 这些内存数据结构，还是读写缓冲区，都会消耗宝贵的内存资源；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1384"><span data-slate-object="text" data-key="1385"><span data-slate-leaf="true" data-offset-key="1385:0" data-first-offset="true"><span data-slate-string="true">由于内存空间有限，因此溢出的临时文件会引入大量磁盘 I/O，而且，Map 阶段输出的中间文件也会消耗磁盘；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1386"><span data-slate-object="text" data-key="1387"><span data-slate-leaf="true" data-offset-key="1387:0" data-first-offset="true"><span data-slate-string="true">呈指数级增长的跨节点数据分发，带来的网络开销更是不容小觑。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1388"><span data-slate-object="text" data-key="1389"><span data-slate-leaf="true" data-offset-key="1389:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">其次，Shuffle 消耗的不同硬件资源之间很难达到平衡。</span></span></span></span><span data-slate-object="text" data-key="1390"><span data-slate-leaf="true" data-offset-key="1390:0" data-first-offset="true"><span data-slate-string="true">磁盘和网络的消耗是 Shuffle 中必需的环节。但是，磁盘与网络的处理延迟相比 CPU 和内存要相差好几个数量级。以下表为例，如果以 CPU L1 缓存的处理延迟为基准，把单位从纳秒校准到秒，我们就会惊讶地发现，当 CPU、内存以秒为单位处理数据时，磁盘和网络的处理延迟是以天、月为单位的！</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1391"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/64/50/64c9d3fc8524ba81ca048ab29dd55350.jpeg?wh=1677*747"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1392"><span data-slate-object="text" data-key="1393"><span data-slate-leaf="true" data-offset-key="1393:0" data-first-offset="true"><span data-slate-string="true">正是基于 Shuffle 的这些特点，我们才会 “谈虎色变”，一提到 Shuffle 就避之唯恐不及，强调能省则省、能拖则拖。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1394" id="sr-toc-8"><span data-slate-object="text" data-key="1395"><span data-slate-leaf="true" data-offset-key="1395:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1396"><span data-slate-object="text" data-key="1397"><span data-slate-leaf="true" data-offset-key="1397:0" data-first-offset="true"><span data-slate-string="true">这一讲，我借助实现仙女散花这个游戏的需求，带你直观地认识 Shuffle 的计算过程。Shuffle 有两个计算阶段，Map 阶段和 Reduce 阶段。我们要重点掌握 Map 阶段的计算流程，我把它总结为 4 步：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1398"><div data-slate-type="list-line" data-slate-object="block" data-key="1399"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="1400"><span data-slate-leaf="true" data-offset-key="1400:0" data-first-offset="true"><span data-slate-string="true">对于分片中的数据记录，逐一计算其目标分区，然后填充内存数据结构（PartitionedPairBuffer 或 PartitionedAppendOnlyMap）；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1401"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="1402"><span data-slate-leaf="true" data-offset-key="1402:0" data-first-offset="true"><span data-slate-string="true">当数据结构填满后，如果分片中还有未处理的数据记录，就对结构中的数据记录按（目标分区 ID，Key）排序，将所有数据溢出到临时文件，同时清空数据结构；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1403"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="1404"><span data-slate-leaf="true" data-offset-key="1404:0" data-first-offset="true"><span data-slate-string="true">重复前 2 个步骤，直到分片中所有的数据记录都被处理；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1405"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="1406"><span data-slate-leaf="true" data-offset-key="1406:0" data-first-offset="true"><span data-slate-string="true">对所有临时文件和内存数据结构中剩余的数据记录做归并排序，最终生成数据文件和索引文件。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1407"><span data-slate-object="text" data-key="1408"><span data-slate-leaf="true" data-offset-key="1408:0" data-first-offset="true"><span data-slate-string="true">在 Reduce 阶段我们要注意，Reduce Task 通过网络拉取中间文件的过程，实际上就是不同 Stages 之间数据分发的过程。并且，Shuffle 中数据分发的网络开销，会随着 Map Task 与 Reduce Task 的线性增长，呈指数级爆炸。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1409"><span data-slate-object="text" data-key="1410"><span data-slate-leaf="true" data-offset-key="1410:0" data-first-offset="true"><span data-slate-string="true">最后，从硬件资源的角度来看，Shuffle 对每一种硬件资源都非常地渴求，尤其是内存、磁盘和网络。由于不同硬件资源之间的处理延迟差异巨大，我们很难在 Shuffle 过程中平衡 CPU、内存、磁盘和网络之间的计算开销。因此，对于 Shuffle 我们避之唯恐不及，要能省则省、能拖则拖。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1411" id="sr-toc-9"><span data-slate-object="text" data-key="1412"><span data-slate-leaf="true" data-offset-key="1412:0" data-first-offset="true"><span data-slate-string="true">每日一练</span></span></span></h2><div data-slate-type="list" data-slate-object="block" data-key="1413"><div data-slate-type="list-line" data-slate-object="block" data-key="1414"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="1415"><span data-slate-leaf="true" data-offset-key="1415:0" data-first-offset="true"><span data-slate-string="true">以小红分到的花朵（数据分区 0）为例，你能推导出 reduceByKey 中 Map 阶段的每个环节吗？（提示：PartitionedAppendOnlyMap 需要多少次溢出到磁盘临时文件？每一个临时文件中的内容是什么？最终生成的中间文件，内容分别是什么？和 groupByKey 生成的中间文件一样吗？）</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1416"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="1417"><span data-slate-leaf="true" data-offset-key="1417:0" data-first-offset="true"><span data-slate-string="true">Map 阶段和 Reduce 阶段有不少环节都涉及数据缓存、数据存储，结合上一讲介绍的 Spark 配置项，你能把相关的配置项对号入座吗？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1418"><span data-slate-object="text" data-key="1419"><span data-slate-leaf="true" data-offset-key="1419:0" data-first-offset="true"><span data-slate-string="true">期待在留言区看到你的思考和讨论，我们下一讲见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (32)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/b5/88/477e7812.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>RespectM</span></div></div><div>老师，如何加快 netty 堆外内存的回收啊？snappy+parquet 格式数据会导致，netty 堆外内存增长太快，导致 netty 使用过多 direct memory，然后报错。</div><div><p>作者回复: netty buffer 导致的堆外内存溢出，和 GC 没关系哈，这个问题比较复杂，咱们一步步说。

首先，io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 16777216 byte (s) of direct memory (used: 7633633280, max: 7635730432)，这个问题，往往出现在 Shuffle read 阶段，spark 用 netty 的 client/server 来拉取远端节点数据，并且透过 java.nio.DirectByteBuffers 来缓存接收到的数据块。当数据分布存在比较严重的倾斜问题的时候，就会导致某些 Block 过大，从而导致单个线程占用的 Direct Buffer 超过 16MB，从而报出上面的错误。

因此，要从根本上解决问题，可以先搞定数据倾斜的问题，如果数据倾斜消除了，那么这个问题大概率自己就会消失掉。关于消除数据倾斜的方法，可以参考后面 AQE 那几讲，以及两阶段 Shuffle 那一讲。

接下来，假设你消除了 Data Skew 之后，这个报错还在，那么就继续用下面的办法。DirectByteBuffers 默认的大小就是 spark.executor.memory 的大小，也就是说，它在逻辑上，会 “计入” Executor memory 内存的消耗。spark.executor.memory 这玩意其实指定的 JVM heap 堆内的内存大小，而 DirectByteBuffers 是堆外内存，按理说两者应该区别对待，然而默认情况下，并没有。因此，如果 DirectByteBuffers 消耗非常的过分，那么我们可以在 spark.executor.extraJavaOptions 当中，特意地去指定 - XX:MaxDirectMemorySize 这个参数，这个参数，就是用来指定 DirectByteBuffers 的内存大小，可以把它设置的大一些。

再者，假设上面的设置，还不能解决问题，那么接下来，我们就得做进一步的精细化调优。接下来可能有点复杂，有些参数可能得需要你慢慢消化，不过没关系，公式比较简单。首先，把 spark.reducer.maxSizeInFlight，设置成 - XX:MaxDirectMemorySize /spark.executor.cores ，这个设置的意图，是降低每个线程需要缓存的数据量。然后，把 spark.maxRemoteBlockSizeFetchToMem，设置成 spark.reducer.maxSizeInFlight/ 5，这个设置的意图，是为了把大的 Block 直接落盘，从而迅速释放线程占用的 Direct buffer，降低 Direct buffer（也就是堆外内存）的消耗，从而降低 OOM 的风险。没错，这个问题，本质上还是一种 OOM 问题。

思路大概就这些，老弟不妨一试，有结果了记得说一声哈～不好使的话，咱们继续再调优～加油！</p></div><div><div>2021-06-20</div><div><div><i></i><span>6</span></div><div><i></i><span>18</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/fe/a2/5252a278.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 对方正在输入。。。</span></div></div><div>老师我补充一下，采用 sortShuffle 的方式时，只有满足在 shuffleDependency 里面 aggeragator 或者 sort 这两个字段有效时，才会根据 partitionid 和 key 排序，否则只根据 partitionid 排序。如不会按照 key 排序的算子有 repartition</div><div><p>作者回复：是的，没错！补充的很到位，谢谢哈～</p></div><div><div>2021-04-13</div><div><div><i></i><span>3</span></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 快跑</span></div></div><div>老师你好，针对参数配置有几个疑问，辛苦帮忙解答下疑问

SELECT
	userid, pvid
FROM table
GROUP BY user,pvid

没有额外设置配置的情况下，日志：Stage-0_0: 0 (+1)/1294 Stage-1_0: 0/1099
Stage-0_0，就是读取文件的过程，Task 数据根据数据块决定的。
疑问 1：Stage-1_0，这个阶段的 Task 数量，默认是怎么计算出来的？

我想改变 Stage-1_0 阶段的 Task 并发数量。
通过设置 spark.default.parallelism=2000 和 spark.sql.shuffle.partitions=3000 都没有生效。倒是 mapreduce.job.reduces=1500 配置项生效了。
日志：Stage-0_0: 0 (+1)/1294 Stage-1_0: 0/1500


疑问 2：这种 sql 执行计划中的 groupByKey，属于 spark.sql.shuffle.partitions 所描述的聚合类操作的场景么？
疑问 3：spark.sql.shuffle.partitions 和 mapreduce.job.reduces 怎么理解这两个参数的使用场景</div><div><p>作者回复：看上去你的部署是 Hive on Spark，Stage-1_0: 0/1099 是 Hive 根据运行时，自动计算出来的，也就是 mapreduce.job.reduces 这个配置项是 - 1 的时候，Hive 自动帮你算。不过当你指定 mapreduce.job.reduces 具体值的时候，比如你这里的 1500，那么 Hive 就会让所有的 Spark Reduce 阶段都具有 1500 的并行度。

从这里可以看到：https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-Spark，Hive 接管了 Shuffle Reduce 阶段并行度的计算：
mapreduce.job.reduces
Default Value: -1 (disabled)
Added in: Hive 1.1.0 with HIVE-7567
Sets the number of reduce tasks for each Spark shuffle stage (e.g. the number of partitions when performing a Spark shuffle). This is set to -1 by default (disabled); instead the number of reduce tasks is dynamically calculated based on Hive data statistics. Setting this to a constant value sets the same number of partitions for all Spark shuffle stages.
就是刚才说的，如果不设置，默认 - 1，那么 Hive 自动帮你算，也就是你最开始的并行度：Stage-1_0: 0/1099；后来你手工改成 1500，那么后续的并行度就都是 1500。也就是说，因为这个 Hive on Spark 配置项的存在，Spark 自己的配置项 spark.default.parallelism 和 spark.sql.shuffle.partitions，就都被禁默了。这也是为什么你反复调整这两个参数没什么用的原因～</p></div><div><div>2021-05-21</div><div><div><i></i></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/IcDlyK6DaBrssVGlmosXnahdJ4bwCesjXa98iaapSDozBiagZTqSCok6iaktu2wOibvpNv9Pd6nfwMg7N7KTSTzYRw/132"></div></div><div><div><div><span> 慢慢卢</span></div></div><div>建议老师以同样的思路弄一个 flink 的专栏</div><div><p>作者回复：哈哈，感谢老弟的建议～</p></div><div><div>2021-06-14</div><div><div><i></i><span>2</span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/36/7b/b06aad84.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 空</span></div></div><div>老师，您好，学习了您的专栏受益匪浅，对于您评论里说的每个 task 处理的数据分片 200M 左右最佳，那如果我两个 5Ｔ的大表做 join，那我的 shuffle reduce 的 task 数量岂不是要 26215，那这个磁盘和网络开销不是大的惊人？</div><div><p>作者回复：好问题，关于并行度、并发度与执行内存，三者之间的关系与设置，可以参考第 14 讲说到的 “三足鼎立”：https://time.geekbang.org/column/article/362710。

200MB 是一种经验之谈，也就是大部分情况下的设置。精确的计算，还是要参考三足鼎立说到的方法。其实并行度也好、并发度与执行内存也罢，他们的设置，都不是一成不变的，不然的话，咱们其实也不需要做调优了。200MB 给大家的是个起始值建议，也就是说，当你无从下手的时候，不妨从 200MB 开始。但是有了三足鼎立这种比较系统的方法，你就可以更合理地设置相关参数，让并行度、并发度与执行内存三者之间达到平衡。

举个极端的例子，虽然你数据很大，5TB，但是你的机器内存受限，这个时候数据分片设置成 200M 也没有什么毛病，当然问题就是 tasks 数量太大，但这个是有前提的，前提就是内存受限。相反，如果你内存相对充裕，那么自然可以根据三足鼎立的算法，去相应地调整参数，这个时候，并行度算出来是多少合适，那就设置成多少就可以啦～</p></div><div><div>2021-06-12</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/a1/2d/599e9051.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>CycleGAN</span></div></div><div>老师的这一节讲得真棒，我也看了一些博客和书，但总是乱糟糟的，专栏质量很高，兼顾了深度 + 清晰度 + 新，已推荐同事中，好好看一起跳槽。。
老师我有个两个问题，第一个是针对问题一，每一个分区的（分区 ID，Key）的枚举数目，在初始阶段就应该就确定了，partitionedAppendOnlyMap 中很多时候 key 有时候也就几十几百，这里，是 5 种，而 buffer 只能放 4 种，差这么一种，就增加了很多次的落盘读盘，spark 有针对 buffer 的动态调整吗？
第二个，是对所有临时文件和内存数据结构中剩余的数据记录做归并排序，是结合堆排序的吗，临时文件太多的时候，会不会不能同时打开这么多文件，还是用的类似优化版的两两归并呢？
</div><div><p>作者回复：感谢老弟的认可～一看老弟的 ID 就知道你是搞机器学习的，同行你好，幸会～哈哈！以后找机会可以一起探讨 ML、DL 的应用和实战～

问得都是好问题！先说第一个，你的 sense 非常好，对于 PairBuffer 和 AppendOnlyMap 这些内存数据结构，Spark 确实会对他们做扩容，也就是第一次发现空间不足的时候，Spark 会创建 2 倍于之前的数据结构，然后把之前已经聚合好的结果，迁移到这个新创建的数据结构中来，而且后续的聚合计算，都围绕着新的数据结构进行，也就是这个扩容出来的 2 倍的空间，之前的数据结构惨遭弃用，后续慢慢地被 GC 回收。不过，这种扩容，只做一次，如果后续发现还需要更多内存，那么后续的计算就只能依赖 Spill 来完成了。值得一提的是，如果因为内存受限、或是其他任务的内存抢占，扩容的时候失败了，这个时候就会报 OOM。

再来说第二个问题，确实是好问题，不过 Spark 并没有采用两两归并的优化机制，确实是同时对多个文件流做合并。说说这块为啥没有做优化，我说说我的理解哈，主要是这块的性能开销其实还好，换句话说，需要合并的 spills 的数量，其实还好，没有想象的那么多。为什么这么说呢， 我们来举个例子。通常来说，每个 Task 处理的数据分片大小在 200MB 最佳，这个是结合经验得出的结论。那么我们就可以利用后面说的 “三足鼎立” 来保证每个 Task 的分片大小就在 200MB 左右。在这样的情况下，现代计算机的硬件资源基本上都比较充足，比如说，对于一个有着 5g Execution Memory，32 cores 的 Executors 来说，每个 Task 能分到的内存时 160MB 左右，对于 200MB 的数据分区来说，其实 spills 的数量是有限的，因此这种情况下，同时打开多个临时文件的压力其实还好～</p></div><div><div>2021-05-15</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/f1/bb/547b580a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 苏子浩</span></div></div><div>老师我想确认一下，问题一所提到的 reduceByKey 中 Map 阶段每一个临时文件中的内容是否和该对应数据分区中的数据记录的顺序有关呢？因为分区中数据记录的不同而导致 Map 阶段每一个临时文件中的内容不同。根据在文中提到的 GroupBuKey 算子的计算步骤二：“PartitionedPairBuffer 填满后，如果分片中还有未处理的数据记录，就对 Buffer 中的数据记录按（目标分区 ID，Key）进行排序，将所有数据溢出到临时文件，同时清空缓存。” 那么类比到 ReduceByKey 中，就可以得到 “当 PartitionedAppendOnlyMap 填满后，如果分片中还有未处理的数据记录，就对 Buffer 中的数据记录按（目标分区 ID，Key）进行排序，将所有数据溢出到临时文件，同时清空缓存。” 那么根据您文中所给出的 “数据分区 0” 图片，所可看到的文件顺序是 “红，菊，黄，紫，黄，红，紫，橙，紫，青，青，橙，橙，红，黄，黄”。那么根据上述算法，假设 PartitionedAppendOnlyMap 的 size 为 4。那么在我们处理到第一个 “青” 的时候，触发第一次临时文件的排序与溢出，并清空数据结构。i.e.
溢写出的第一个文件为：
[(分区 id, 红), 2]; [(分区 id, 橙), 2]; [(分区 id, 黄), 2]; [(分区 id, 紫), 3]。继续扫描剩下的数据记录，直到遍历所有数据分区 0 中所有数据记录。此时 partitionedAppendOnlyMap 里的数据为：
[(分区 id, 红), 1]; [(分区 id, 橙), 2]; [(分区 id, 黄), 2]; [(分区 id, 蓝), 2].
此时我们对 partitionedAppendOnlyMap 里的数据排序后，与溢出的临时文件进行归并排序得到输出文件 (数据文件):
[(分区 id, 红), 3]; [(分区 id, 橙), 4]; [(分区 id, 黄), 4]; [(分区 id, 紫), 3]; [(分区 id, 青), 2].
对应的索引文件为:
0,1,2,3,4.
和 groupByKey 生成的中间文件不一样，map 端聚合，降低了数据量。
不好意思，打了这么多字，谢谢！</div><div><p>作者回复：非常赞～👍 思考的很到位，没错，就像你说的那样～

首先，溢出的临时文件的内容，就是和分区数据的顺序有关，你说的没错，同样的分片，换个顺序，溢出的文件内存（对 reduceByKey 来说）大概率是不同的；

再者，不论溢出文件的内容相同与否，同样的分片数据，最终的中间文件是一致的，这个是由最终的 Merge Sort 决定的。

最后，就像你分析的，reduceByKey 溢出的临时文件，一定会比 groupByKey 更少，原因很简单，就像你说的，因为有 Map 端聚合，所以自然节省空间，需要溢出的频率就降低了，溢出文件自然更少。

很棒～耐心地推导了 reduceByKey 的全部过程，赞赞赞～</p></div><div><div>2021-04-19</div><div><div><i></i><span>4</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 快跑</span></div></div><div>老师好，这节学习过后生成许多疑问，请老师帮忙解惑
想就 “千女散花” 的过程详细了解下 spark.shuffle.sort.bypassMergeThreshold
1、“千女散花” 过程中的 groupByKey 和 reduceByKey 是否都不需要引入排序操作？ 目前我觉得是不需要

2、如果满足 spark.shuffle.sort.bypassMergeThreshold 阈值情况下，由这个参数引入排序具体发生在哪阶段？ 
	map 写临时文件阶段
	临时文件归并 merge 阶段
	reduce 拉取数据 merge
这些过程都会有影响么

3、spark.shuffle.sort.bypassMergeThreshold 生效的场景会区分 spark rdd， spark sql，还是 hive on spark 么
</div><div><p>作者回复：好问题，我们一个个来看。

1. 确实都不需要排序，但是，在 Spark 的 byPass 机制下，groupByKey 可以通过设置 spark.shuffle.sort.bypassMergeThreshold 从而跳过排序操作，但是，reduceByKey 不行，因为它有 Aggregate 聚合操作，所以，坦白说，Sort shuffle manager 对于 reduceByKey 这种操作确实不太公平，但是没办法，它的实现机制就是这样。

2. 没错，在默认排序的情况下，你说的这几个步骤，都会有排序，都会受排序影响。

3. spark.shuffle.sort.bypassMergeThreshold 这个参数是控制 shuffle 的，所以不区分是 rdd 还是 DataFrame、Dataset，如果满足 byPass 条件，都会生效的～</p></div><div><div>2021-04-15</div><div><div><i></i><span>3</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/20/2b/86/318e6ff3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 井先生</span></div></div><div>答题 1：
溢写出一个文件
[（分区 id，红），3] ,[（分区 id，橙），4] ,[（分区 id，黄），4] ,[（分区 id，紫），3]
partitionedAppendOnlyMap 里面的数据
[（分区 id，蓝），2] 
归并排序后的输出文件
[（分区 id，红），3] ,[（分区 id，橙），4] ,[（分区 id，黄），4] ,[（分区 id，紫），3]，[（分区 id，蓝），2] 
比 groupByKey 生产的中间文件 size 小，因为做过 map 端的预聚合

疑问：
map 端做归并排序再写文件的目的是为了每一个分区的数据连续，从而让 reduce 端在读文件的时候读连续的记录速度更快吗？</div><div><p>作者回复：第一题满分💯～

map 端聚合，主要是降低数据量，减少磁盘和网络的开销。归并排序主要是保证运行的稳定性，因为归并排序可以通过磁盘来做，也就是用 External Sorter 来做这事，这样不会因为内存受限而频繁地 oom。</p></div><div><div>2021-04-08</div><div><div><i></i><span>3</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/78/a0/7a248ddc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 福</span></div></div><div>真的是希望老师出个 flink 的，写的好 nice 呀</div><div><p>作者回复：感谢老弟的认可～等以后有时间吧，现在有个《零基础入门 Spark》的课程还没完结，实在忙不过来了，哈哈</p></div><div><div>2021-11-09</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/c5/fd/bb7fd00b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 黄宪坤</span></div></div><div>老师您好，有个疑问， PartitionedPairBuffer、PartitionedAppendOnlyMap 这些内存数据结构，与缓冲区内存有什么关系？</div><div><p>作者回复：好问题，PartitionedPairBuffer、PartitionedAppendOnlyMap 这些内存数据结构，主要用于计算，比如 Shuffle 的 Map 阶段，他们消耗的是 Execution Memory。

Map 和 Reduce 的 buffer，也就是你说的缓冲区，主要用于加速数据在网络中的传输效率，虽然这部分内存也消耗 Execution Memory，但是这部分内存是不参与计算的，只负责数据在网络中的传输与交换。</p></div><div><div>2021-08-30</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1e/65/0f/7b9f27f2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 猿鸽君</span></div></div><div>老师好，请问下为什么需要计算 partitionid，直接根据 key 来排序不行吗？相同 key 计算的 partitionid 不是一样的吗，为什么需要根据（partitionid， key）来排？不懂这里计算 partitionid 的用意</div><div><p>作者回复：你说的没错，排序的关键还是 key，毕竟，从用户角度、或者是业务上来说，key 才是我们关心的。

但是，partitionid 同样重要，shuffle manager 把 partitionid 带上，最主要的目的，还是生成 Shuffle 中间文件，也就是每个 Task 生成的 data 文件和 index 文件。有了这些中间文件，Map Tasks 和 Reduce Tasks 才有可能完成数据交换。</p></div><div><div>2021-08-08</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/1d/22/f04cea4c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Fendora 范东_</span></div></div><div>Map 端配置
spark.shuffle.file.buffer  适当调大可以降低落盘次数，以及降低归并排序路数
reduce 端配置
spark.reducer.maxSizeInFlight   可以适当调大减少网络 io 次数


spark.shuffle.sortBypassMergeThreshold  map 端不进行排序的阈值。因为目前 shuffle 操作由 sortshufflemanager 管理，默认在 map 操作时会进行排序，例子中 groupbykey，reducebykey 并不需要排序

请问磊哥，缓存大小调整有啥技巧么，应该不是越大越好吧</div><div><p>作者回复：对，不是越大越好，你前面分析的很到位～ 如果是针对这两个参数调整，不妨以 50%～100% 步进式地调高缓存，对比执行性能变化。当然，这里技巧就比较灵活了，如果这块确实是瓶颈，还可以用二分查找。</p></div><div><div>2021-04-07</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/PNmB3mOQ4jTSoDMGPwp5j8a2NL1Mibu4iaebBNnuDQltb2yZ3sygJpxTHuLrG9ewCDLEialorSK3pzXBCQ3JFCZPA/132"></div></div><div><div><div><span> 果子</span></div></div><div>索引文件正是用于帮助判定哪部分数据属于哪个 Reduce Task。老师，（1）每个 Reduce Task 怎么知道自己的要读哪个索引部分，这个信息谁提供给他的，（2）他知道了后怎么定位自己的索引，二分吗？（3）索引文件记录的是 reduce 阶段的起始索引，每个 redcue task 要读取分区数据的话，是从起始索引一直读到下一个起始索引吗？这样确定一个 partition?</div><div><p>作者回复：好问题～

其实这 3 个问题，可以一起回答。index 文件的格式，就是按照 reduce task 序号来排列的，其中每个 reduce task 的数据，由你说的起始索引到下一个起始索引来标记。

所以，就像你说的，reduce task 只要依序，找到它对应位置的起始索引（两个），就知道属于自己的数据都有哪些啦～</p></div><div><div>2021-10-18</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/00/3f/a0f84788.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Sean</span></div></div><div>磊哥，二刷后又多了两个疑问，辛苦磊哥解答下，这样一条 sql
create table if not exists tmp_a as
select a.id, age, name, sex
from (
         select id, age, name
         from app_info
         group by id, age, name
     ) a
         join

     (
         select a1.id, sex
         from (select id, count (distinct uid) uid_cnt
                  from register_log
                  group by id
                  having uid_cnt &gt; 100
              ) a1
                  join
              (
                  select id, sex
                  from register_log
                  group by id,sex
              ) a2
              on a1.id = a2.id
     ) b
     on a.id = b.id;
运行结束后，产生了 9 个 stage, 发现 ui 上的每个成功的 stage 的 total task 个数不一，在 shuffle read 有数据的 stage 中 (理解为这是 shuffle reduce 阶段，这里会生成 5000 个 task),task 个数并没有达到 5000,9 个 stage 的 task 累加依然没有达到 5000 个 task,
问题 1: 想请教下磊哥这块这个 task 的划分规则是怎么定义的，自己没能定位到这块的源代码
问题 2: 想请教下磊哥这块这个 stage 的划分规则，我理解一个宽依赖一个 stage, 但依然无法还原这 9 个 stage 生成的规则</div><div><p>作者回复：听上去是 Spark UI 的疑问，我看了下 SQL，从 SQL 看的话，应该是 6 个 Stages，没有 9 个那么多。Tasks 这块说的有点晕，一会 5000，一会没有 5000，看懵了。极客时间可能没法发图片，我记得你有我微信，你直接把 Spark UI 截图发我好了，一起看看～

另外，咱们的 Spark UI 加餐终于要上线了，哈哈！应该这周能放出来，到时候老弟可以特别关注下，看看能不能解决你的一些疑问～</p></div><div><div>2021-10-01</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_c17db5</span></div></div><div>老师，reduce 阶段读取 map 阶段写的临时文件，是不是也是按大小分块，分成多个 task 去读的？</div><div><p>作者回复：对的，是的～

其实 Reduce 阶段，本质上，和 Map 阶段一样，也是有并行度的，每个数据分片对应一个 Task，每个数据分片，其实都是从 Map 阶段的中间文件拉过来的。

对于 Reduce，其实可以换个角度理解。你就把 Shuffle 中间文件，当作是 Reduce 阶段的数据源，其他的计算过程，其实和 Map 阶段是一样的～</p></div><div><div>2021-09-18</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/11/20/9f31c4f4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>wow_xiaodi</span></div></div><div>结合本节课程和评论思考了下，有如下问题想请教下老师：
(1) 对于使用 partitionedAppendOnlyMap 时，相当于作了一次 map 端的 combine 操作，请问这个 combine 操作在 spark 里是必须要做的吗？是否有开关去控制呢？
(2) 在使用 partitionedAppendOnlyMap 时，多个溢出的文件需要归并排序，归并排序的过程中是不是对同一个 key 也做了一次 combine 操作？</div><div><p>作者回复：好问题～

1）map 端聚合收益很大，如果满足 map 端聚合条件，那 spark 一定会做，这个没有开关哈

2）并不会，归并排序这个说法，可能有些迷惑性。他实际上就是把多份临时文件 “拼接” 在一起，在拼接的过程中，生成 index 文件，来记录不同 reduce partition 的起始地址。并不是说要把所有文件内容做排序、融合、合并。</p></div><div><div>2021-07-31</div><div><div><i></i><span>4</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/7DL88WEw0QsxHg4HicLyickqGT3C9NLeiaDmPFSENNs0yw2wp2rqLicZ3AY935PKd3WJbcJrn43O3JLYUbmOmfkTnA/132"></div></div><div><div><div><span>Lon_coder</span></div></div><div>老哥请问，partitionedpairbuffer 在内存中不对某个 key 的结果进行聚合，但在文件 merge 过程🀄️会聚合么，因为那时候 key 已经有序了</div><div><p>作者回复：先明确个概念哈～这里的聚合，指的是 By Key 做聚合运算，比如累加、算均值。Spark 底层采用了 partitionedpairbuffer，就说明用户代码中不存在聚合计算的逻辑，那么在 partitionedpairbuffer 不会聚合，在临时文件 merge 的时候，也不会产生聚合计算的，和 Key 是否有序没有关系哈。</p></div><div><div>2021-07-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/PNmB3mOQ4jTSoDMGPwp5j8a2NL1Mibu4iaebBNnuDQltb2yZ3sygJpxTHuLrG9ewCDLEialorSK3pzXBCQ3JFCZPA/132"></div></div><div><div><div><span> 果子</span></div></div><div>老师能讲讲 SPARK 溢写的流程吗？</div><div><p>作者回复：这部分其实比较简单，主要就是两步：
1）在内存数据结构里面，把所有记录按照（partitionID，record key）或是 partitionID 排序；
2）然后把内容溢写到 spark.local.dir 目录下的临时文件，文件名带时间戳

其实就是这两步，当然，我猜你说的溢写流程，可能是 buffer i/o 的过程，这个其实和普通的读写文件没什么两样，I/O 的过程都是一样的。</p></div><div><div>2021-07-01</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/49/fe/48846a6d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Ebdaoli</span></div></div><div>磊哥，有个问题想请教下，在 reduce task 去 每个 map task 拉取属于自己的部分的数据时，如果一个 maptask 下的. data 文件里面有很大的体量都是属于同一个 reducetask 的，是一次性拉取完一个 map task 下的对应数据，还是会多次拉取？</div><div><div>2022-03-10</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".d"><outline class="toc-level-h1" data-reactid=".d.0" style="width: 175px;"><active data-reactid=".d.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".d.0.1"><span data-reactid=".d.0.1.0">11 | 为什么说 Shuffle 是一时无两的性能杀手？</span></a></outline><outline class="toc-level-h2" data-reactid=".d.1" style="width: 165px;"><active data-reactid=".d.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".d.1.1"><span data-reactid=".d.1.1.0">如何理解 Shuffle？</span></a></outline><outline class="toc-level-h2" data-reactid=".d.2" style="width: 165px;"><active data-reactid=".d.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".d.2.1"><span data-reactid=".d.2.1.0">Map 阶段是如何输出中间文件的？</span></a></outline><outline class="toc-level-h3" data-reactid=".d.3" style="width: 155px;"><active data-reactid=".d.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".d.3.1"><span data-reactid=".d.3.1.0">用 groupByKey 实现 “仙女散花”</span></a></outline><outline class="toc-level-h3" data-reactid=".d.4" style="width: 155px;"><active data-reactid=".d.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".d.4.1"><span data-reactid=".d.4.1.0">“仙女散花” 游戏升级</span></a></outline><outline class="toc-level-h3" data-reactid=".d.5" style="width: 155px;"><active data-reactid=".d.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".d.5.1"><span data-reactid=".d.5.1.0">用 reduceByKey 实现升级后的仙女散花</span></a></outline><outline class="toc-level-h2" data-reactid=".d.6" style="width: 165px;"><active data-reactid=".d.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".d.6.1"><span data-reactid=".d.6.1.0">Reduce 阶段是如何进行数据分发的？</span></a></outline><outline class="toc-level-h2" data-reactid=".d.7" style="width: 165px;"><active data-reactid=".d.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".d.7.1"><span data-reactid=".d.7.1.0">性能杀手</span></a></outline><outline class="toc-level-h2" data-reactid=".d.8" style="width: 165px;"><active data-reactid=".d.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".d.8.1"><span data-reactid=".d.8.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".d.9" style="width: 165px;"><active data-reactid=".d.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".d.9.1"><span data-reactid=".d.9.1.0">每日一练</span></a></outline><outline class="toc-level-h2" data-reactid=".d.a" style="width: 165px;"><active data-reactid=".d.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".d.a.1"><span data-reactid=".d.a.1.0">精选留言 (32)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/359907" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>