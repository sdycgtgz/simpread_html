
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 17 | ReplicaStateMachine：揭秘副本状态机实现原理</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>17 | ReplicaStateMachine：揭秘副本状态机实现原理</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">17 | ReplicaStateMachine：揭秘副本状态机实现原理</h1><div><span>胡夕</span> <span> 2020-05-30</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c5/be/c527a7d1b0649a9ccf3e0af8483ff4be.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：19.86M</span><span> 时长：21:41</span></div></div><audio title="17 | ReplicaStateMachine：揭秘副本状态机实现原理" src="https://res001.geekbang.org//media/audio/47/87/47a4f15366c12714bc8fb0c79f7e6b87/ld/ld.m3u8" __idm_id__="49172"></audio></div><div><div><div><div data-slate-editor="true" data-key="18159" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="18160"><span data-slate-object="text" data-key="18161"><span data-slate-leaf="true" data-offset-key="18161:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。今天我们讲副本状态机。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18162"><span data-slate-object="text" data-key="18163"><span data-slate-leaf="true" data-offset-key="18163:0" data-first-offset="true"><span data-slate-string="true">前几节课，在讲 Controller、TopicDeletionManager 时，我反复提到副本状态机和分区状态机这两个组件。现在，你应该知道了，它们分别管理着 Kafka 集群中所有副本和分区的状态转换，但是，你知道副本和分区到底都有哪些状态吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18164"><span data-slate-object="text" data-key="18165"><span data-slate-leaf="true" data-offset-key="18165:0" data-first-offset="true"><span data-slate-string="true">带着这个问题，我们用两节课的时间，重点学习下这两个组件的源码。我们先从副本状态机（ReplicaStateMachine）开始。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18166" id="sr-toc-1"><span data-slate-object="text" data-key="18167"><span data-slate-leaf="true" data-offset-key="18167:0" data-first-offset="true"><span data-slate-string="true">课前导读</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18168"><span data-slate-object="text" data-key="18169"><span data-slate-leaf="true" data-offset-key="18169:0" data-first-offset="true"><span data-slate-string="true">坦率地说，ReplicaStateMachine 不如前面的组件有名气，Kafka 官网文档中甚至没有任何关于它的描述，可见，它是一个内部组件，一般用户感觉不到它的存在。因此，很多人都会有这样的错觉：既然它是外部不可见的组件，那就没有必要学习它的实现代码了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18170"><span data-slate-object="text" data-key="18171"><span data-slate-leaf="true" data-offset-key="18171:0" data-first-offset="true"><span data-slate-string="true">其实不然。弄明白副本状态机的原理，对于我们从根本上定位很多数据不一致问题是有帮助的。下面，我跟你分享一个我的真实经历。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18172"><span data-slate-object="text" data-key="18173"><span data-slate-leaf="true" data-offset-key="18173:0" data-first-offset="true"><span data-slate-string="true">曾经，我们部署过一个 3-Broker 的 Kafka 集群，版本是 2.0.0。假设这 3 个 Broker 是 A、B 和 C，我们在这 3 个 Broker 上创建了一个单分区、双副本的主题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18174"><span data-slate-object="text" data-key="18175"><span data-slate-leaf="true" data-offset-key="18175:0" data-first-offset="true"><span data-slate-string="true">当时，我们发现了一个奇怪的现象：如果两个副本分别位于 A 和 B，而 Controller 在 C 上，那么，当关闭 A、B 之后，ZooKeeper 中会显示该主题的 Leader 是 -1，ISR 为空；但是，如果两个副本依然位于 A 和 B 上，而 Controller 在 B 上，当我们依次关闭 A 和 B 后，该主题在 ZooKeeper 中的 Leader 和 ISR 就变成了 B。这显然和刚刚的情况不符。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18176"><span data-slate-object="text" data-key="18177"><span data-slate-leaf="true" data-offset-key="18177:0" data-first-offset="true"><span data-slate-string="true">虽然这并不是特别严重的问题，可毕竟出现了数据的不一致性，所以还是需要谨慎对待。在仔细查看源码之后，我们找到了造成不一致的原因：原来，在第一种情况下，Controller 会调用 ReplicaStateMachine，调整该主题副本的状态，进而变更了 Leader 和 ISR；而在第二种情况下，Controller 执行了 Failover，但是并未在新 Controller 组件初始化时进行状态转换，因而出现了不一致。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18178"><span data-slate-object="text" data-key="18179"><span data-slate-leaf="true" data-offset-key="18179:0" data-first-offset="true"><span data-slate-string="true">你看，要是不阅读这部分源码，我们肯定是无法定位这个问题的原因的。总之，副本状态机代码定义了 Kafka 副本的状态集合，同时控制了这些状态之间的流转规则。对于想要深入了解内部原理的你来说，短小精悍的 ReplicaStateMachine 源码是绝对不能错过的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18180" id="sr-toc-2"><span data-slate-object="text" data-key="18181"><span data-slate-leaf="true" data-offset-key="18181:0" data-first-offset="true"><span data-slate-string="true">定义与初始化</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18182"><span data-slate-object="text" data-key="18183"><span data-slate-leaf="true" data-offset-key="18183:0" data-first-offset="true"><span data-slate-string="true">今天，我们要关注的源码文件是 controller 包下的 ReplicaStateMachine.scala 文件。它的代码结构非常简单，如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18184"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/0f/ff/0f29451b5050c7053f2ac26488e9d1ff.jpg?wh=2250*1366"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18185"><span data-slate-object="text" data-key="18186"><span data-slate-leaf="true" data-offset-key="18186:0" data-first-offset="true"><span data-slate-string="true">在不到 500 行的源文件中，代码定义了 3 个部分。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18187"><div data-slate-type="list-line" data-slate-object="block" data-key="18188"><span data-slate-object="text" data-key="18189"><span data-slate-leaf="true" data-offset-key="18189:0" data-first-offset="true"><span data-slate-string="true">ReplicaStateMachine：副本状态机抽象类，定义了一些常用方法（如 startup、shutdown 等），以及状态机最重要的处理逻辑方法 handleStateChanges。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18190"><span data-slate-object="text" data-key="18191"><span data-slate-leaf="true" data-offset-key="18191:0" data-first-offset="true"><span data-slate-string="true">ZkReplicaStateMachine：副本状态机具体实现类，重写了 handleStateChanges 方法，实现了副本状态之间的状态转换。目前，ZkReplicaStateMachine 是唯一的 ReplicaStateMachine 子类。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18192"><span data-slate-object="text" data-key="18193"><span data-slate-leaf="true" data-offset-key="18193:0" data-first-offset="true"><span data-slate-string="true">ReplicaState：副本状态集合，Kafka 目前共定义了 7 种副本状态。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18194"><span data-slate-object="text" data-key="18195"><span data-slate-leaf="true" data-offset-key="18195:0" data-first-offset="true"><span data-slate-string="true">下面，我们看下 ReplicaStateMachine 及其子类 ZKReplicaStateMachine 在代码中是如何定义的，请看这两个代码片段：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="18196"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18197"><span data-slate-object="text" data-key="18198"><span data-slate-leaf="true" data-offset-key="18198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ReplicaStateMachine 抽象类定义</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18199"><span data-slate-object="text" data-key="18200"><span data-slate-leaf="true" data-offset-key="18200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">abstract</span></span></span></span><span data-slate-object="text" data-key="18201"><span data-slate-leaf="true" data-offset-key="18201:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18202"><span data-slate-leaf="true" data-offset-key="18202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="18203"><span data-slate-leaf="true" data-offset-key="18203:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18204"><span data-slate-leaf="true" data-offset-key="18204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="18205"><span data-slate-leaf="true" data-offset-key="18205:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18206"><span data-slate-leaf="true" data-offset-key="18206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerContext</span></span></span></span><span data-slate-object="text" data-key="18207"><span data-slate-leaf="true" data-offset-key="18207:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18208"><span data-slate-leaf="true" data-offset-key="18208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerContext</span></span></span></span><span data-slate-object="text" data-key="18209"><span data-slate-leaf="true" data-offset-key="18209:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="18210"><span data-slate-leaf="true" data-offset-key="18210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="18211"><span data-slate-leaf="true" data-offset-key="18211:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18212"><span data-slate-leaf="true" data-offset-key="18212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="18213"><span data-slate-leaf="true" data-offset-key="18213:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18214"><span data-slate-object="text" data-key="18215"><span data-slate-leaf="true" data-offset-key="18215:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18216"><span data-slate-object="text" data-key="18217"><span data-slate-leaf="true" data-offset-key="18217:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18218"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18219"><span data-slate-object="text" data-key="18220"><span data-slate-leaf="true" data-offset-key="18220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ZkReplicaStateMachine 具体实现类定义</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18221"><span data-slate-object="text" data-key="18222"><span data-slate-leaf="true" data-offset-key="18222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="18223"><span data-slate-leaf="true" data-offset-key="18223:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18224"><span data-slate-leaf="true" data-offset-key="18224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZkReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="18225"><span data-slate-leaf="true" data-offset-key="18225:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18226"><span data-slate-leaf="true" data-offset-key="18226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">config</span></span></span></span><span data-slate-object="text" data-key="18227"><span data-slate-leaf="true" data-offset-key="18227:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18228"><span data-slate-leaf="true" data-offset-key="18228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaConfig</span></span></span></span><span data-slate-object="text" data-key="18229"><span data-slate-leaf="true" data-offset-key="18229:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18230"><span data-slate-object="text" data-key="18231"><span data-slate-leaf="true" data-offset-key="18231:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18232"><span data-slate-leaf="true" data-offset-key="18232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stateChangeLogger</span></span></span></span><span data-slate-object="text" data-key="18233"><span data-slate-leaf="true" data-offset-key="18233:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18234"><span data-slate-leaf="true" data-offset-key="18234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StateChangeLogger</span></span></span></span><span data-slate-object="text" data-key="18235"><span data-slate-leaf="true" data-offset-key="18235:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18236"><span data-slate-object="text" data-key="18237"><span data-slate-leaf="true" data-offset-key="18237:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18238"><span data-slate-leaf="true" data-offset-key="18238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerContext</span></span></span></span><span data-slate-object="text" data-key="18239"><span data-slate-leaf="true" data-offset-key="18239:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18240"><span data-slate-leaf="true" data-offset-key="18240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerContext</span></span></span></span><span data-slate-object="text" data-key="18241"><span data-slate-leaf="true" data-offset-key="18241:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18242"><span data-slate-object="text" data-key="18243"><span data-slate-leaf="true" data-offset-key="18243:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18244"><span data-slate-leaf="true" data-offset-key="18244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">zkClient</span></span></span></span><span data-slate-object="text" data-key="18245"><span data-slate-leaf="true" data-offset-key="18245:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18246"><span data-slate-leaf="true" data-offset-key="18246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaZkClient</span></span></span></span><span data-slate-object="text" data-key="18247"><span data-slate-leaf="true" data-offset-key="18247:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18248"><span data-slate-object="text" data-key="18249"><span data-slate-leaf="true" data-offset-key="18249:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18250"><span data-slate-leaf="true" data-offset-key="18250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerBrokerRequestBatch</span></span></span></span><span data-slate-object="text" data-key="18251"><span data-slate-leaf="true" data-offset-key="18251:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18252"><span data-slate-leaf="true" data-offset-key="18252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerBrokerRequestBatch</span></span></span></span><span data-slate-object="text" data-key="18253"><span data-slate-leaf="true" data-offset-key="18253:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18254"><span data-slate-object="text" data-key="18255"><span data-slate-leaf="true" data-offset-key="18255:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18256"><span data-slate-leaf="true" data-offset-key="18256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="18257"><span data-slate-leaf="true" data-offset-key="18257:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18258"><span data-slate-leaf="true" data-offset-key="18258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="18259"><span data-slate-leaf="true" data-offset-key="18259:0" data-first-offset="true"><span data-slate-string="true">(controllerContext) </span></span></span><span data-slate-object="text" data-key="18260"><span data-slate-leaf="true" data-offset-key="18260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">with</span></span></span></span><span data-slate-object="text" data-key="18261"><span data-slate-leaf="true" data-offset-key="18261:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18262"><span data-slate-leaf="true" data-offset-key="18262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="18263"><span data-slate-leaf="true" data-offset-key="18263:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18264"><span data-slate-object="text" data-key="18265"><span data-slate-leaf="true" data-offset-key="18265:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18266"><span data-slate-object="text" data-key="18267"><span data-slate-leaf="true" data-offset-key="18267:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18268"><span data-slate-object="text" data-key="18269"><span data-slate-leaf="true" data-offset-key="18269:0" data-first-offset="true"><span data-slate-string="true">ReplicaStateMachine 只需要接收一个 ControllerContext 对象实例。在前几节课，我反复说过，ControllerContext 封装了 Controller 端保存的所有集群元数据信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18270"><span data-slate-object="text" data-key="18271"><span data-slate-leaf="true" data-offset-key="18271:0" data-first-offset="true"><span data-slate-string="true">ZKReplicaStateMachine 的属性则多一些。如果要构造一个 ZKReplicaStateMachine 实例，除了 ControllerContext 实例，比较重要的属性还有 </span></span></span><span data-slate-object="text" data-key="18272"><span data-slate-leaf="true" data-offset-key="18272:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaZkClient 对象实例</span></span></span></span><span data-slate-object="text" data-key="18273"><span data-slate-leaf="true" data-offset-key="18273:0" data-first-offset="true"><span data-slate-string="true">和 </span></span></span><span data-slate-object="text" data-key="18274"><span data-slate-leaf="true" data-offset-key="18274:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ControllerBrokerRequestBatch 实例</span></span></span></span><span data-slate-object="text" data-key="18275"><span data-slate-leaf="true" data-offset-key="18275:0" data-first-offset="true"><span data-slate-string="true">。前者负责与 ZooKeeper 进行交互；后者用于给集群 Broker 发送控制类请求（也就是咱们在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18276"><span data-slate-object="text" data-key="18277"><span data-slate-leaf="true" data-offset-key="18277:0" data-first-offset="true"><span data-slate-string="true">第 12 节课</span></span></span></a><span data-slate-object="text" data-key="18278"><span data-slate-leaf="true" data-offset-key="18278:0" data-first-offset="true"><span data-slate-string="true">重点讲过的 LeaderAndIsrRequest、StopReplicaRequest 和 UpdateMetadataRequest）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18279"><span data-slate-object="text" data-key="18280"><span data-slate-leaf="true" data-offset-key="18280:0" data-first-offset="true"><span data-slate-string="true">ControllerBrokerRequestBatch 对象的源码位于 ControllerChannelManager.scala 中，这是一个只有 10 行代码的类，主要的功能是将给定的 Request 发送给指定的 Broker，你可以自行探索下它是如何发送请求的。（给你个提示：结合我们在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18281"><span data-slate-object="text" data-key="18282"><span data-slate-leaf="true" data-offset-key="18282:0" data-first-offset="true"><span data-slate-string="true">第 12 节课</span></span></span></a><span data-slate-object="text" data-key="18283"><span data-slate-leaf="true" data-offset-key="18283:0" data-first-offset="true"><span data-slate-string="true">讲到的 ControllerBrokerStateInfo 代码进行思考。）</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18284"><span data-slate-object="text" data-key="18285"><span data-slate-leaf="true" data-offset-key="18285:0" data-first-offset="true"><span data-slate-string="true">在副本状态转换操作的逻辑中，一个很重要的步骤，就是为 Broker 上的副本更新信息，而这是通过 Controller 给 Broker 发送请求实现的，因此，你最好了解下这里的请求发送逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18286"><span data-slate-object="text" data-key="18287"><span data-slate-leaf="true" data-offset-key="18287:0" data-first-offset="true"><span data-slate-string="true">好了，学习了副本状态机类的定义，下面我们看下副本状态机是在何时进行初始化的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18288"><span data-slate-object="text" data-key="18289"><span data-slate-leaf="true" data-offset-key="18289:0" data-first-offset="true"><span data-slate-string="true">一句话总结就是，</span></span></span><span data-slate-object="text" data-key="18290"><span data-slate-leaf="true" data-offset-key="18290:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaController 对象在构建的时候，就会初始化一个 ZkReplicaStateMachine 实例</span></span></span></span><span data-slate-object="text" data-key="18291"><span data-slate-leaf="true" data-offset-key="18291:0" data-first-offset="true"><span data-slate-string="true">，如下列代码所示：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="18292"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18293"><span data-slate-object="text" data-key="18294"><span data-slate-leaf="true" data-offset-key="18294:0" data-first-offset="true"><span data-slate-string="true">val </span></span></span><span data-slate-object="text" data-key="18295"><span data-slate-leaf="true" data-offset-key="18295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="18296"><span data-slate-leaf="true" data-offset-key="18296:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18297"><span data-slate-leaf="true" data-offset-key="18297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="18298"><span data-slate-leaf="true" data-offset-key="18298:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="18299"><span data-slate-leaf="true" data-offset-key="18299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="18300"><span data-slate-leaf="true" data-offset-key="18300:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18301"><span data-slate-object="text" data-key="18302"><span data-slate-leaf="true" data-offset-key="18302:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18303"><span data-slate-leaf="true" data-offset-key="18303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ZkReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="18304"><span data-slate-leaf="true" data-offset-key="18304:0" data-first-offset="true"><span data-slate-string="true">(config, stateChangeLogger, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18305"><span data-slate-object="text" data-key="18306"><span data-slate-leaf="true" data-offset-key="18306:0" data-first-offset="true"><span data-slate-string="true">    controllerContext, zkClient,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18307"><span data-slate-object="text" data-key="18308"><span data-slate-leaf="true" data-offset-key="18308:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18309"><span data-slate-leaf="true" data-offset-key="18309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="18310"><span data-slate-leaf="true" data-offset-key="18310:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18311"><span data-slate-leaf="true" data-offset-key="18311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerBrokerRequestBatch</span></span></span></span><span data-slate-object="text" data-key="18312"><span data-slate-leaf="true" data-offset-key="18312:0" data-first-offset="true"><span data-slate-string="true">(config, controllerChannelManager, eventManager, controllerContext, stateChangeLogger))</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18313"><span data-slate-object="text" data-key="18314"><span data-slate-leaf="true" data-offset-key="18314:0" data-first-offset="true"><span data-slate-string="true">你可能会问：“如果一个 Broker 没有被选举为 Controller，它也会构建 KafkaController 对象实例吗？” 没错！所有 Broker 在启动时，都会创建 KafkaController 实例，因而也会创建 ZKReplicaStateMachine 实例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18315"><span data-slate-object="text" data-key="18316"><span data-slate-leaf="true" data-offset-key="18316:0" data-first-offset="true"><span data-slate-string="true">每个 Broker 都会创建这些实例，并不代表每个 Broker 都会启动副本状态机。事实上，只有在 Controller 所在的 Broker 上，副本状态机才会被启动。具体的启动代码位于 KafkaController 的 onControllerFailover 方法，如下所示：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="18317"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18318"><span data-slate-object="text" data-key="18319"><span data-slate-leaf="true" data-offset-key="18319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="18320"><span data-slate-leaf="true" data-offset-key="18320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="18321"><span data-slate-leaf="true" data-offset-key="18321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">onControllerFailover</span></span></span></span></span><span data-slate-object="text" data-key="18322"><span data-slate-leaf="true" data-offset-key="18322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18323"><span data-slate-leaf="true" data-offset-key="18323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="18324"><span data-slate-leaf="true" data-offset-key="18324:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18325"><span data-slate-object="text" data-key="18326"><span data-slate-leaf="true" data-offset-key="18326:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18327"><span data-slate-object="text" data-key="18328"><span data-slate-leaf="true" data-offset-key="18328:0" data-first-offset="true"><span data-slate-string="true">  replicaStateMachine.</span></span></span><span data-slate-object="text" data-key="18329"><span data-slate-leaf="true" data-offset-key="18329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startup</span></span></span></span><span data-slate-object="text" data-key="18330"><span data-slate-leaf="true" data-offset-key="18330:0" data-first-offset="true"><span data-slate-string="true">() </span></span></span><span data-slate-object="text" data-key="18331"><span data-slate-leaf="true" data-offset-key="18331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动副本状态机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18332"><span data-slate-object="text" data-key="18333"><span data-slate-leaf="true" data-offset-key="18333:0" data-first-offset="true"><span data-slate-string="true">    partitionStateMachine.</span></span></span><span data-slate-object="text" data-key="18334"><span data-slate-leaf="true" data-offset-key="18334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startup</span></span></span></span><span data-slate-object="text" data-key="18335"><span data-slate-leaf="true" data-offset-key="18335:0" data-first-offset="true"><span data-slate-string="true">() </span></span></span><span data-slate-object="text" data-key="18336"><span data-slate-leaf="true" data-offset-key="18336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动分区状态机</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18337"><span data-slate-object="text" data-key="18338"><span data-slate-leaf="true" data-offset-key="18338:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18339"><span data-slate-object="text" data-key="18340"><span data-slate-leaf="true" data-offset-key="18340:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18341"><span data-slate-object="text" data-key="18342"><span data-slate-leaf="true" data-offset-key="18342:0" data-first-offset="true"><span data-slate-string="true">当 Broker 被成功推举为 Controller 后，onControllerFailover 方法会被调用，进而启动该 Broker 早已创建好的副本状态机和分区状态机。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18343" id="sr-toc-3"><span data-slate-object="text" data-key="18344"><span data-slate-leaf="true" data-offset-key="18344:0" data-first-offset="true"><span data-slate-string="true">副本状态及状态管理流程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18345"><span data-slate-object="text" data-key="18346"><span data-slate-leaf="true" data-offset-key="18346:0" data-first-offset="true"><span data-slate-string="true">副本状态机一旦被启动，就意味着它要行使它最重要的职责了：</span></span></span><span data-slate-object="text" data-key="18347"><span data-slate-leaf="true" data-offset-key="18347:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">管理副本状态的转换</span></span></span></span><span data-slate-object="text" data-key="18348"><span data-slate-leaf="true" data-offset-key="18348:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18349"><span data-slate-object="text" data-key="18350"><span data-slate-leaf="true" data-offset-key="18350:0" data-first-offset="true"><span data-slate-string="true">不过，在学习如何管理状态之前，我们必须要弄明白，当前都有哪些状态，以及它们的含义分别是什么。源码中的 ReplicaState 定义了 7 种副本状态。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18351"><div data-slate-type="list-line" data-slate-object="block" data-key="18352"><span data-slate-object="text" data-key="18353"><span data-slate-leaf="true" data-offset-key="18353:0" data-first-offset="true"><span data-slate-string="true">NewReplica：副本被创建之后所处的状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18354"><span data-slate-object="text" data-key="18355"><span data-slate-leaf="true" data-offset-key="18355:0" data-first-offset="true"><span data-slate-string="true">OnlineReplica：副本正常提供服务时所处的状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18356"><span data-slate-object="text" data-key="18357"><span data-slate-leaf="true" data-offset-key="18357:0" data-first-offset="true"><span data-slate-string="true">OfflineReplica：副本服务下线时所处的状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18358"><span data-slate-object="text" data-key="18359"><span data-slate-leaf="true" data-offset-key="18359:0" data-first-offset="true"><span data-slate-string="true">ReplicaDeletionStarted：副本被删除时所处的状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18360"><span data-slate-object="text" data-key="18361"><span data-slate-leaf="true" data-offset-key="18361:0" data-first-offset="true"><span data-slate-string="true">ReplicaDeletionSuccessful：副本被成功删除后所处的状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18362"><span data-slate-object="text" data-key="18363"><span data-slate-leaf="true" data-offset-key="18363:0" data-first-offset="true"><span data-slate-string="true">ReplicaDeletionIneligible：开启副本删除，但副本暂时无法被删除时所处的状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18364"><span data-slate-object="text" data-key="18365"><span data-slate-leaf="true" data-offset-key="18365:0" data-first-offset="true"><span data-slate-string="true">NonExistentReplica：副本从副本状态机被移除前所处的状态。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18366"><span data-slate-object="text" data-key="18367"><span data-slate-leaf="true" data-offset-key="18367:0" data-first-offset="true"><span data-slate-string="true">具体到代码而言，</span></span></span><span data-slate-object="text" data-key="18368"><span data-slate-leaf="true" data-offset-key="18368:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ReplicaState 接口及其实现对象定义了每种状态的序号，以及合法的前置状态</span></span></span></span><span data-slate-object="text" data-key="18369"><span data-slate-leaf="true" data-offset-key="18369:0" data-first-offset="true"><span data-slate-string="true">。我以 OnlineReplica 代码为例进行说明：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="18370"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18371"><span data-slate-object="text" data-key="18372"><span data-slate-leaf="true" data-offset-key="18372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ReplicaState 接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18373"><span data-slate-object="text" data-key="18374"><span data-slate-leaf="true" data-offset-key="18374:0" data-first-offset="true"><span data-slate-string="true">sealed trait </span></span></span><span data-slate-object="text" data-key="18375"><span data-slate-leaf="true" data-offset-key="18375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaState</span></span></span></span><span data-slate-object="text" data-key="18376"><span data-slate-leaf="true" data-offset-key="18376:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18377"><span data-slate-object="text" data-key="18378"><span data-slate-leaf="true" data-offset-key="18378:0" data-first-offset="true"><span data-slate-string="true">  def </span></span></span><span data-slate-object="text" data-key="18379"><span data-slate-leaf="true" data-offset-key="18379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">state</span></span></span></span><span data-slate-object="text" data-key="18380"><span data-slate-leaf="true" data-offset-key="18380:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18381"><span data-slate-leaf="true" data-offset-key="18381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Byte</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18382"><span data-slate-object="text" data-key="18383"><span data-slate-leaf="true" data-offset-key="18383:0" data-first-offset="true"><span data-slate-string="true">  def </span></span></span><span data-slate-object="text" data-key="18384"><span data-slate-leaf="true" data-offset-key="18384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">validPreviousStates</span></span></span></span><span data-slate-object="text" data-key="18385"><span data-slate-leaf="true" data-offset-key="18385:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18386"><span data-slate-leaf="true" data-offset-key="18386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="18387"><span data-slate-leaf="true" data-offset-key="18387:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="18388"><span data-slate-leaf="true" data-offset-key="18388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaState</span></span></span></span><span data-slate-object="text" data-key="18389"><span data-slate-leaf="true" data-offset-key="18389:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="18390"><span data-slate-leaf="true" data-offset-key="18390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义合法的前置状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18391"><span data-slate-object="text" data-key="18392"><span data-slate-leaf="true" data-offset-key="18392:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18393"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18394"><span data-slate-object="text" data-key="18395"><span data-slate-leaf="true" data-offset-key="18395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// OnlineReplica 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18396"><span data-slate-object="text" data-key="18397"><span data-slate-leaf="true" data-offset-key="18397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18398"><span data-slate-leaf="true" data-offset-key="18398:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18399"><span data-slate-leaf="true" data-offset-key="18399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">object</span></span></span></span><span data-slate-object="text" data-key="18400"><span data-slate-leaf="true" data-offset-key="18400:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18401"><span data-slate-leaf="true" data-offset-key="18401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OnlineReplica</span></span></span></span><span data-slate-object="text" data-key="18402"><span data-slate-leaf="true" data-offset-key="18402:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18403"><span data-slate-leaf="true" data-offset-key="18403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="18404"><span data-slate-leaf="true" data-offset-key="18404:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18405"><span data-slate-leaf="true" data-offset-key="18405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaState</span></span></span></span><span data-slate-object="text" data-key="18406"><span data-slate-leaf="true" data-offset-key="18406:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18407"><span data-slate-object="text" data-key="18408"><span data-slate-leaf="true" data-offset-key="18408:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="18409"><span data-slate-leaf="true" data-offset-key="18409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">state</span></span></span></span><span data-slate-object="text" data-key="18410"><span data-slate-leaf="true" data-offset-key="18410:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18411"><span data-slate-leaf="true" data-offset-key="18411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Byte</span></span></span></span><span data-slate-object="text" data-key="18412"><span data-slate-leaf="true" data-offset-key="18412:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="18413"><span data-slate-leaf="true" data-offset-key="18413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18414"><span data-slate-object="text" data-key="18415"><span data-slate-leaf="true" data-offset-key="18415:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="18416"><span data-slate-leaf="true" data-offset-key="18416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">validPreviousStates</span></span></span></span><span data-slate-object="text" data-key="18417"><span data-slate-leaf="true" data-offset-key="18417:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="18418"><span data-slate-leaf="true" data-offset-key="18418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="18419"><span data-slate-leaf="true" data-offset-key="18419:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="18420"><span data-slate-leaf="true" data-offset-key="18420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaState</span></span></span></span><span data-slate-object="text" data-key="18421"><span data-slate-leaf="true" data-offset-key="18421:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="18422"><span data-slate-leaf="true" data-offset-key="18422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="18423"><span data-slate-leaf="true" data-offset-key="18423:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18424"><span data-slate-leaf="true" data-offset-key="18424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewReplica</span></span></span></span><span data-slate-object="text" data-key="18425"><span data-slate-leaf="true" data-offset-key="18425:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18426"><span data-slate-leaf="true" data-offset-key="18426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OnlineReplica</span></span></span></span><span data-slate-object="text" data-key="18427"><span data-slate-leaf="true" data-offset-key="18427:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18428"><span data-slate-leaf="true" data-offset-key="18428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OfflineReplica</span></span></span></span><span data-slate-object="text" data-key="18429"><span data-slate-leaf="true" data-offset-key="18429:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18430"><span data-slate-leaf="true" data-offset-key="18430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaDeletionIneligible</span></span></span></span><span data-slate-object="text" data-key="18431"><span data-slate-leaf="true" data-offset-key="18431:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18432"><span data-slate-object="text" data-key="18433"><span data-slate-leaf="true" data-offset-key="18433:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18434"><span data-slate-object="text" data-key="18435"><span data-slate-leaf="true" data-offset-key="18435:0" data-first-offset="true"><span data-slate-string="true">OnlineReplica 的 validPreviousStates 属性是一个集合类型，里面包含 NewReplica、OnlineReplica、OfflineReplica 和 ReplicaDeletionIneligible。这说明，Kafka 只允许副本从刚刚这 4 种状态变更到 OnlineReplica 状态。如果从 ReplicaDeletionStarted 状态跳转到 OnlineReplica 状态，就是非法的状态转换。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18436"><span data-slate-object="text" data-key="18437"><span data-slate-leaf="true" data-offset-key="18437:0" data-first-offset="true"><span data-slate-string="true">这里，我只列出了 OnlineReplica。实际上，其他 6 种副本状态的代码逻辑也是类似的，因为比较简单，我就不一一介绍了，课下你可以对照着源码自己探索下，重点关注这些状态的 validPreviousStates 字段，看看每个状态合法的前置状态都有哪些。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18438"><span data-slate-object="text" data-key="18439"><span data-slate-leaf="true" data-offset-key="18439:0" data-first-offset="true"><span data-slate-string="true">为了方便你记忆，我直接帮你提炼了出来了。这张图绘制出了完整的状态转换规则：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18440"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1c/9a/1c681e2616d1f156221489fc9376649a.jpg?wh=3016*2293"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18441"><span data-slate-object="text" data-key="18442"><span data-slate-leaf="true" data-offset-key="18442:0" data-first-offset="true"><span data-slate-string="true">图中的单向箭头表示只允许单向状态转换，双向箭头则表示转换方向可以是双向的。比如，OnlineReplica 和 OfflineReplica 之间有一根双向箭头，这就说明，副本可以在 OnlineReplica 和 OfflineReplica 状态之间随意切换。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18443"><span data-slate-object="text" data-key="18444"><span data-slate-leaf="true" data-offset-key="18444:0" data-first-offset="true"><span data-slate-string="true">结合这张图，我再详细解释下各个状态的含义，以及它们的流转过程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18445"><span data-slate-object="text" data-key="18446"><span data-slate-leaf="true" data-offset-key="18446:0" data-first-offset="true"><span data-slate-string="true">当副本对象首次被创建出来后，它会被置于 NewReplica 状态。经过一番初始化之后，当副本对象能够对外提供服务之后，状态机会将其调整为 OnlineReplica，并一直以该状态持续工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18447"><span data-slate-object="text" data-key="18448"><span data-slate-leaf="true" data-offset-key="18448:0" data-first-offset="true"><span data-slate-string="true">如果副本所在的 Broker 关闭或者是因为其他原因不能正常工作了，副本需要从 OnlineReplica 变更为 OfflineReplica，表明副本已处于离线状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18449"><span data-slate-object="text" data-key="18450"><span data-slate-leaf="true" data-offset-key="18450:0" data-first-offset="true"><span data-slate-string="true">一旦开启了如删除主题这样的操作，状态机会将副本状态跳转到 ReplicaDeletionStarted，以表明副本删除已然开启。倘若删除成功，则置为 ReplicaDeletionSuccessful，倘若不满足删除条件（如所在 Broker 处于下线状态），那就设置成 ReplicaDeletionIneligible，以便后面重试。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18451"><span data-slate-object="text" data-key="18452"><span data-slate-leaf="true" data-offset-key="18452:0" data-first-offset="true"><span data-slate-string="true">当副本对象被删除后，其状态会变更为 NonExistentReplica，副本状态机将移除该副本数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18453"><span data-slate-object="text" data-key="18454"><span data-slate-leaf="true" data-offset-key="18454:0" data-first-offset="true"><span data-slate-string="true">这就是一个基本的状态管理流程。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18455" id="sr-toc-4"><span data-slate-object="text" data-key="18456"><span data-slate-leaf="true" data-offset-key="18456:0" data-first-offset="true"><span data-slate-string="true">具体实现类：ZkReplicaStateMachine</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18457"><span data-slate-object="text" data-key="18458"><span data-slate-leaf="true" data-offset-key="18458:0" data-first-offset="true"><span data-slate-string="true">了解了这些状态之后，我们来看下 ZkReplicaStateMachine 类的原理，毕竟，它是副本状态机的具体实现类。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18459"><span data-slate-object="text" data-key="18460"><span data-slate-leaf="true" data-offset-key="18460:0" data-first-offset="true"><span data-slate-string="true">该类定义了 1 个 public 方法和 7 个 private 方法。这个 public 方法是副本状态机最重要的逻辑处理代码，它就是 handleStateChanges 方法。而那 7 个方法全部都是用来辅助 public 方法的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18461" id="sr-toc-5"><span data-slate-object="text" data-key="18462"><span data-slate-leaf="true" data-offset-key="18462:0" data-first-offset="true"><span data-slate-string="true">状态转换方法定义</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18463"><span data-slate-object="text" data-key="18464"><span data-slate-leaf="true" data-offset-key="18464:0" data-first-offset="true"><span data-slate-string="true">在详细介绍 handleStateChanges 方法前，我稍微花点时间，给你简单介绍下其他 7 个方法都是做什么用的。就像前面说过的，这些方法主要是起辅助的作用。只有清楚了这些方法的用途，你才能更好地理解 handleStateChanges 的实现逻辑。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18465"><div data-slate-type="list-line" data-slate-object="block" data-key="18466"><span data-slate-object="text" data-key="18467"><span data-slate-leaf="true" data-offset-key="18467:0" data-first-offset="true"><span data-slate-string="true">logFailedStateChange：仅仅是记录一条错误日志，表明执行了一次无效的状态变更。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18468"><span data-slate-object="text" data-key="18469"><span data-slate-leaf="true" data-offset-key="18469:0" data-first-offset="true"><span data-slate-string="true">logInvalidTransition：同样也是记录错误之用，记录一次非法的状态转换。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18470"><span data-slate-object="text" data-key="18471"><span data-slate-leaf="true" data-offset-key="18471:0" data-first-offset="true"><span data-slate-string="true">logSuccessfulTransition：记录一次成功的状态转换操作。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18472"><span data-slate-object="text" data-key="18473"><span data-slate-leaf="true" data-offset-key="18473:0" data-first-offset="true"><span data-slate-string="true">getTopicPartitionStatesFromZk：从 ZooKeeper 中获取指定分区的状态信息，包括每个分区的 Leader 副本、ISR 集合等数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18474"><span data-slate-object="text" data-key="18475"><span data-slate-leaf="true" data-offset-key="18475:0" data-first-offset="true"><span data-slate-string="true">doRemoveReplicasFromIsr：把给定的副本对象从给定分区 ISR 中移除。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18476"><span data-slate-object="text" data-key="18477"><span data-slate-leaf="true" data-offset-key="18477:0" data-first-offset="true"><span data-slate-string="true">removeReplicasFromIsr：调用 doRemoveReplicasFromIsr 方法，实现将给定的副本对象从给定分区 ISR 中移除的功能。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18478"><span data-slate-object="text" data-key="18479"><span data-slate-leaf="true" data-offset-key="18479:0" data-first-offset="true"><span data-slate-string="true">doHandleStateChanges：执行状态变更和转换操作的主力方法。接下来，我们会详细学习它的源码部分。</span></span></span></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18480" id="sr-toc-6"><span data-slate-object="text" data-key="18481"><span data-slate-leaf="true" data-offset-key="18481:0" data-first-offset="true"><span data-slate-string="true">handleStateChanges 方法</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18482"><span data-slate-object="text" data-key="18483"><span data-slate-leaf="true" data-offset-key="18483:0" data-first-offset="true"><span data-slate-string="true">handleStateChange 方法的作用是处理状态的变更，是对外提供状态转换操作的入口方法。其方法签名如下：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="18484"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18485"><span data-slate-object="text" data-key="18486"><span data-slate-leaf="true" data-offset-key="18486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def</span></span></span></span><span data-slate-object="text" data-key="18487"><span data-slate-leaf="true" data-offset-key="18487:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18488"><span data-slate-leaf="true" data-offset-key="18488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleStateChanges</span></span></span></span><span data-slate-object="text" data-key="18489"><span data-slate-leaf="true" data-offset-key="18489:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18490"><span data-slate-leaf="true" data-offset-key="18490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicas: Seq[PartitionAndReplica], targetState: ReplicaState</span></span></span></span><span data-slate-object="text" data-key="18491"><span data-slate-leaf="true" data-offset-key="18491:0" data-first-offset="true"><span data-slate-string="true">): Unit</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18492"><span data-slate-object="text" data-key="18493"><span data-slate-leaf="true" data-offset-key="18493:0" data-first-offset="true"><span data-slate-string="true">该方法接收两个参数：</span></span></span><span data-slate-object="text" data-key="18494"><span data-slate-leaf="true" data-offset-key="18494:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">replicas</span></span></span></span><span data-slate-object="text" data-key="18495"><span data-slate-leaf="true" data-offset-key="18495:0" data-first-offset="true"><span data-slate-string="true"> 是一组副本对象，每个副本对象都封装了它们各自所属的主题、分区以及副本所在的 Broker ID 数据；</span></span></span><span data-slate-object="text" data-key="18496"><span data-slate-leaf="true" data-offset-key="18496:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">targetState</span></span></span></span><span data-slate-object="text" data-key="18497"><span data-slate-leaf="true" data-offset-key="18497:0" data-first-offset="true"><span data-slate-string="true"> 是这组副本对象要转换成的目标状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18498"><span data-slate-object="text" data-key="18499"><span data-slate-leaf="true" data-offset-key="18499:0" data-first-offset="true"><span data-slate-string="true">这个方法的完整代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="18500"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18501"><span data-slate-object="text" data-key="18502"><span data-slate-leaf="true" data-offset-key="18502:0" data-first-offset="true"><span data-slate-string="true">override def handleStateChanges(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18503"><span data-slate-object="text" data-key="18504"><span data-slate-leaf="true" data-offset-key="18504:0" data-first-offset="true"><span data-slate-string="true">  replicas: Seq[PartitionAndReplica], </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18505"><span data-slate-object="text" data-key="18506"><span data-slate-leaf="true" data-offset-key="18506:0" data-first-offset="true"><span data-slate-string="true">  targetState: ReplicaState): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18507"><span data-slate-object="text" data-key="18508"><span data-slate-leaf="true" data-offset-key="18508:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18509"><span data-slate-leaf="true" data-offset-key="18509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18510"><span data-slate-leaf="true" data-offset-key="18510:0" data-first-offset="true"><span data-slate-string="true"> (replicas.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18511"><span data-slate-object="text" data-key="18512"><span data-slate-leaf="true" data-offset-key="18512:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18513"><span data-slate-leaf="true" data-offset-key="18513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="18514"><span data-slate-leaf="true" data-offset-key="18514:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18515"><span data-slate-object="text" data-key="18516"><span data-slate-leaf="true" data-offset-key="18516:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18517"><span data-slate-leaf="true" data-offset-key="18517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清空 Controller 待发送请求集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18518"><span data-slate-object="text" data-key="18519"><span data-slate-leaf="true" data-offset-key="18519:0" data-first-offset="true"><span data-slate-string="true">      controllerBrokerRequestBatch.newBatch()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18520"><span data-slate-object="text" data-key="18521"><span data-slate-leaf="true" data-offset-key="18521:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18522"><span data-slate-leaf="true" data-offset-key="18522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将所有副本对象按照 Broker 进行分组，依次执行状态转换操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18523"><span data-slate-object="text" data-key="18524"><span data-slate-leaf="true" data-offset-key="18524:0" data-first-offset="true"><span data-slate-string="true">      replicas.groupBy(_.replica).foreach {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18525"><span data-slate-object="text" data-key="18526"><span data-slate-leaf="true" data-offset-key="18526:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18527"><span data-slate-leaf="true" data-offset-key="18527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18528"><span data-slate-leaf="true" data-offset-key="18528:0" data-first-offset="true"><span data-slate-string="true"> (replicaId, replicas) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18529"><span data-slate-object="text" data-key="18530"><span data-slate-leaf="true" data-offset-key="18530:0" data-first-offset="true"><span data-slate-string="true">          doHandleStateChanges(replicaId, replicas, targetState)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18531"><span data-slate-object="text" data-key="18532"><span data-slate-leaf="true" data-offset-key="18532:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18533"><span data-slate-object="text" data-key="18534"><span data-slate-leaf="true" data-offset-key="18534:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18535"><span data-slate-leaf="true" data-offset-key="18535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 发送对应的 Controller 请求给 Broker</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18536"><span data-slate-object="text" data-key="18537"><span data-slate-leaf="true" data-offset-key="18537:0" data-first-offset="true"><span data-slate-string="true">      controllerBrokerRequestBatch.sendRequestsToBrokers(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18538"><span data-slate-object="text" data-key="18539"><span data-slate-leaf="true" data-offset-key="18539:0" data-first-offset="true"><span data-slate-string="true">        controllerContext.epoch)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18540"><span data-slate-object="text" data-key="18541"><span data-slate-leaf="true" data-offset-key="18541:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="18542"><span data-slate-leaf="true" data-offset-key="18542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="18543"><span data-slate-leaf="true" data-offset-key="18543:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18544"><span data-slate-object="text" data-key="18545"><span data-slate-leaf="true" data-offset-key="18545:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18546"><span data-slate-leaf="true" data-offset-key="18546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果 Controller 易主，则记录错误日志然后抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18547"><span data-slate-object="text" data-key="18548"><span data-slate-leaf="true" data-offset-key="18548:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18549"><span data-slate-leaf="true" data-offset-key="18549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18550"><span data-slate-leaf="true" data-offset-key="18550:0" data-first-offset="true"><span data-slate-string="true"> e: ControllerMovedException =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18551"><span data-slate-object="text" data-key="18552"><span data-slate-leaf="true" data-offset-key="18552:0" data-first-offset="true"><span data-slate-string="true">        error(s</span></span></span><span data-slate-object="text" data-key="18553"><span data-slate-leaf="true" data-offset-key="18553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Controller moved to another broker when moving some replicas to </span></span></span></span><span data-slate-object="text" data-key="18554"><span data-slate-leaf="true" data-offset-key="18554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$targetState</span></span></span></span></span><span data-slate-object="text" data-key="18555"><span data-slate-leaf="true" data-offset-key="18555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> state"</span></span></span></span><span data-slate-object="text" data-key="18556"><span data-slate-leaf="true" data-offset-key="18556:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18557"><span data-slate-object="text" data-key="18558"><span data-slate-leaf="true" data-offset-key="18558:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18559"><span data-slate-leaf="true" data-offset-key="18559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="18560"><span data-slate-leaf="true" data-offset-key="18560:0" data-first-offset="true"><span data-slate-string="true"> e</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18561"><span data-slate-object="text" data-key="18562"><span data-slate-leaf="true" data-offset-key="18562:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18563"><span data-slate-leaf="true" data-offset-key="18563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18564"><span data-slate-leaf="true" data-offset-key="18564:0" data-first-offset="true"><span data-slate-string="true"> e: Throwable =&gt; error(s</span></span></span><span data-slate-object="text" data-key="18565"><span data-slate-leaf="true" data-offset-key="18565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Error while moving some replicas to </span></span></span></span><span data-slate-object="text" data-key="18566"><span data-slate-leaf="true" data-offset-key="18566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$targetState</span></span></span></span></span><span data-slate-object="text" data-key="18567"><span data-slate-leaf="true" data-offset-key="18567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> state"</span></span></span></span><span data-slate-object="text" data-key="18568"><span data-slate-leaf="true" data-offset-key="18568:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18569"><span data-slate-object="text" data-key="18570"><span data-slate-leaf="true" data-offset-key="18570:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18571"><span data-slate-object="text" data-key="18572"><span data-slate-leaf="true" data-offset-key="18572:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18573"><span data-slate-object="text" data-key="18574"><span data-slate-leaf="true" data-offset-key="18574:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18575"><span data-slate-object="text" data-key="18576"><span data-slate-leaf="true" data-offset-key="18576:0" data-first-offset="true"><span data-slate-string="true">代码逻辑总体上分为两步：第 1 步是调用 doHandleStateChanges 方法执行真正的副本状态转换；第 2 步是给集群中的相应 Broker 批量发送请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18577"><span data-slate-object="text" data-key="18578"><span data-slate-leaf="true" data-offset-key="18578:0" data-first-offset="true"><span data-slate-string="true">在执行第 1 步的时候，它会将 replicas 按照 Broker ID 进行分组。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18579"><span data-slate-object="text" data-key="18580"><span data-slate-leaf="true" data-offset-key="18580:0" data-first-offset="true"><span data-slate-string="true">举个例子，如果我们使用 &lt;主题名，分区号，副本 Broker ID&gt; 表示副本对象，假设 replicas 为集合（&lt;test, 0, 0&gt;, &lt;test, 0, 1&gt;, &lt;test, 1, 0&gt;, &lt;test, 1, 1&gt;），那么，在调用 doHandleStateChanges 方法前，代码会将 replicas 按照 Broker ID 进行分组，即变成：Map (0 -&gt; Set (&lt;test, 0, 0&gt;, &lt;test, 1, 0&gt;)，1 -&gt; Set (&lt;test, 0, 1&gt;, &lt;test, 1, 1&gt;))。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18581"><span data-slate-object="text" data-key="18582"><span data-slate-leaf="true" data-offset-key="18582:0" data-first-offset="true"><span data-slate-string="true">待这些都做完之后，代码开始调用 doHandleStateChanges 方法，执行状态转换操作。这个方法看着很长，其实都是不同的代码分支。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18583" id="sr-toc-7"><span data-slate-object="text" data-key="18584"><span data-slate-leaf="true" data-offset-key="18584:0" data-first-offset="true"><span data-slate-string="true">doHandleStateChanges 方法</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18585"><span data-slate-object="text" data-key="18586"><span data-slate-leaf="true" data-offset-key="18586:0" data-first-offset="true"><span data-slate-string="true">我先用一张图，帮你梳理下它的流程，然后再具体分析下它的代码：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18587"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/4f/01/4f341dde3cfa4a883ea9f7a82acae301.jpg?wh=2467*2470"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18588"><span data-slate-object="text" data-key="18589"><span data-slate-leaf="true" data-offset-key="18589:0" data-first-offset="true"><span data-slate-string="true">从图中，我们可以发现，代码的第 1 步，会尝试获取给定副本对象在 Controller 端元数据缓存中的当前状态，如果没有保存某个副本对象的状态，代码会将其初始化为 NonExistentReplica 状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18590"><span data-slate-object="text" data-key="18591"><span data-slate-leaf="true" data-offset-key="18591:0" data-first-offset="true"><span data-slate-string="true">第 2 步，代码根据不同 ReplicaState 中定义的合法前置状态集合以及传入的目标状态（targetState），将给定的副本对象集合划分成两部分：能够合法转换的副本对象集合，以及执行非法状态转换的副本对象集合。doHandleStateChanges 方法会为后者中的每个副本对象记录一条错误日志。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18592"><span data-slate-object="text" data-key="18593"><span data-slate-leaf="true" data-offset-key="18593:0" data-first-offset="true"><span data-slate-string="true">第 3 步，代码携带能够执行合法转换的副本对象集合，进入到不同的代码分支。由于当前 Kafka 为副本定义了 7 类状态，因此，这里的代码分支总共有 7 路。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18594"><span data-slate-object="text" data-key="18595"><span data-slate-leaf="true" data-offset-key="18595:0" data-first-offset="true"><span data-slate-string="true">我挑选几路最常见的状态转换路径详细说明下，包括副本被创建时被转换到 NewReplica 状态，副本正常工作时被转换到 OnlineReplica 状态，副本停止服务后被转换到 OfflineReplica 状态。至于剩下的记录代码，你可以在课后自行学习下，它们的转换操作原理大致是相同的。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="18596" id="sr-toc-8"><span data-slate-object="text" data-key="18597"><span data-slate-leaf="true" data-offset-key="18597:0" data-first-offset="true"><span data-slate-string="true">第 1 路：转换到 NewReplica 状态</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="18598"><span data-slate-object="text" data-key="18599"><span data-slate-leaf="true" data-offset-key="18599:0" data-first-offset="true"><span data-slate-string="true">首先，我们先来看第 1 路，即目标状态是 NewReplica 的代码。代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="18600"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18601"><span data-slate-object="text" data-key="18602"><span data-slate-leaf="true" data-offset-key="18602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18603"><span data-slate-leaf="true" data-offset-key="18603:0" data-first-offset="true"><span data-slate-string="true"> NewReplica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18604"><span data-slate-object="text" data-key="18605"><span data-slate-leaf="true" data-offset-key="18605:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18606"><span data-slate-leaf="true" data-offset-key="18606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历所有能够执行转换的副本对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18607"><span data-slate-object="text" data-key="18608"><span data-slate-leaf="true" data-offset-key="18608:0" data-first-offset="true"><span data-slate-string="true">  validReplicas.foreach {replica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18609"><span data-slate-object="text" data-key="18610"><span data-slate-leaf="true" data-offset-key="18610:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18611"><span data-slate-leaf="true" data-offset-key="18611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取该副本对象的分区对象，即 &lt;主题名，分区号&gt; 数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18612"><span data-slate-object="text" data-key="18613"><span data-slate-leaf="true" data-offset-key="18613:0" data-first-offset="true"><span data-slate-string="true">    val partition = replica.topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18614"><span data-slate-object="text" data-key="18615"><span data-slate-leaf="true" data-offset-key="18615:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18616"><span data-slate-leaf="true" data-offset-key="18616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取副本对象的当前状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18617"><span data-slate-object="text" data-key="18618"><span data-slate-leaf="true" data-offset-key="18618:0" data-first-offset="true"><span data-slate-string="true">    val currentState = controllerContext.replicaState(replica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18619"><span data-slate-object="text" data-key="18620"><span data-slate-leaf="true" data-offset-key="18620:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18621"><span data-slate-leaf="true" data-offset-key="18621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 尝试从元数据缓存中获取该分区当前信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18622"><span data-slate-object="text" data-key="18623"><span data-slate-leaf="true" data-offset-key="18623:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18624"><span data-slate-leaf="true" data-offset-key="18624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 包括 Leader 是谁、ISR 都有哪些副本等数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18625"><span data-slate-object="text" data-key="18626"><span data-slate-leaf="true" data-offset-key="18626:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.partitionLeadershipInfo.</span></span></span><span data-slate-object="text" data-key="18627"><span data-slate-leaf="true" data-offset-key="18627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="18628"><span data-slate-leaf="true" data-offset-key="18628:0" data-first-offset="true"><span data-slate-string="true">(partition) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18629"><span data-slate-object="text" data-key="18630"><span data-slate-leaf="true" data-offset-key="18630:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18631"><span data-slate-leaf="true" data-offset-key="18631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果成功拿到分区数据信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18632"><span data-slate-object="text" data-key="18633"><span data-slate-leaf="true" data-offset-key="18633:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18634"><span data-slate-leaf="true" data-offset-key="18634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18635"><span data-slate-leaf="true" data-offset-key="18635:0" data-first-offset="true"><span data-slate-string="true"> Some(leaderIsrAndControllerEpoch) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18636"><span data-slate-object="text" data-key="18637"><span data-slate-leaf="true" data-offset-key="18637:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18638"><span data-slate-leaf="true" data-offset-key="18638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该副本是 Leader 副本</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18639"><span data-slate-object="text" data-key="18640"><span data-slate-leaf="true" data-offset-key="18640:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18641"><span data-slate-leaf="true" data-offset-key="18641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18642"><span data-slate-leaf="true" data-offset-key="18642:0" data-first-offset="true"><span data-slate-string="true"> (leaderIsrAndControllerEpoch.leaderAndIsr.leader == replicaId) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18643"><span data-slate-object="text" data-key="18644"><span data-slate-leaf="true" data-offset-key="18644:0" data-first-offset="true"><span data-slate-string="true">          val exception = </span></span></span><span data-slate-object="text" data-key="18645"><span data-slate-leaf="true" data-offset-key="18645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="18646"><span data-slate-leaf="true" data-offset-key="18646:0" data-first-offset="true"><span data-slate-string="true"> StateChangeFailedException(s</span></span></span><span data-slate-object="text" data-key="18647"><span data-slate-leaf="true" data-offset-key="18647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Replica </span></span></span></span><span data-slate-object="text" data-key="18648"><span data-slate-leaf="true" data-offset-key="18648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$replicaId</span></span></span></span></span><span data-slate-object="text" data-key="18649"><span data-slate-leaf="true" data-offset-key="18649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for partition </span></span></span></span><span data-slate-object="text" data-key="18650"><span data-slate-leaf="true" data-offset-key="18650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$partition</span></span></span></span></span><span data-slate-object="text" data-key="18651"><span data-slate-leaf="true" data-offset-key="18651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> cannot be moved to NewReplica state as it is being requested to become leader"</span></span></span></span><span data-slate-object="text" data-key="18652"><span data-slate-leaf="true" data-offset-key="18652:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18653"><span data-slate-object="text" data-key="18654"><span data-slate-leaf="true" data-offset-key="18654:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18655"><span data-slate-leaf="true" data-offset-key="18655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 记录错误日志。Leader 副本不能被设置成 NewReplica 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18656"><span data-slate-object="text" data-key="18657"><span data-slate-leaf="true" data-offset-key="18657:0" data-first-offset="true"><span data-slate-string="true">          logFailedStateChange(replica, currentState, OfflineReplica, exception)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18658"><span data-slate-object="text" data-key="18659"><span data-slate-leaf="true" data-offset-key="18659:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18660"><span data-slate-leaf="true" data-offset-key="18660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则，给该副本所在的 Broker 发送 LeaderAndIsrRequest</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18661"><span data-slate-object="text" data-key="18662"><span data-slate-leaf="true" data-offset-key="18662:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18663"><span data-slate-leaf="true" data-offset-key="18663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向它同步该分区的数据，之后给集群当前所有 Broker 发送</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18664"><span data-slate-object="text" data-key="18665"><span data-slate-leaf="true" data-offset-key="18665:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18666"><span data-slate-leaf="true" data-offset-key="18666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// UpdateMetadataRequest 通知它们该分区数据发生变更</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18667"><span data-slate-object="text" data-key="18668"><span data-slate-leaf="true" data-offset-key="18668:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="18669"><span data-slate-leaf="true" data-offset-key="18669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="18670"><span data-slate-leaf="true" data-offset-key="18670:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18671"><span data-slate-object="text" data-key="18672"><span data-slate-leaf="true" data-offset-key="18672:0" data-first-offset="true"><span data-slate-string="true">          controllerBrokerRequestBatch</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18673"><span data-slate-object="text" data-key="18674"><span data-slate-leaf="true" data-offset-key="18674:0" data-first-offset="true"><span data-slate-string="true">            .addLeaderAndIsrRequestForBrokers(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18675"><span data-slate-object="text" data-key="18676"><span data-slate-leaf="true" data-offset-key="18676:0" data-first-offset="true"><span data-slate-string="true">              Seq(replicaId),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18677"><span data-slate-object="text" data-key="18678"><span data-slate-leaf="true" data-offset-key="18678:0" data-first-offset="true"><span data-slate-string="true">              replica.topicPartition,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18679"><span data-slate-object="text" data-key="18680"><span data-slate-leaf="true" data-offset-key="18680:0" data-first-offset="true"><span data-slate-string="true">              leaderIsrAndControllerEpoch,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18681"><span data-slate-object="text" data-key="18682"><span data-slate-leaf="true" data-offset-key="18682:0" data-first-offset="true"><span data-slate-string="true">              controllerContext.partitionFullReplicaAssignment(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18683"><span data-slate-object="text" data-key="18684"><span data-slate-leaf="true" data-offset-key="18684:0" data-first-offset="true"><span data-slate-string="true">                replica.topicPartition),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18685"><span data-slate-object="text" data-key="18686"><span data-slate-leaf="true" data-offset-key="18686:0" data-first-offset="true"><span data-slate-string="true">              isNew = </span></span></span><span data-slate-object="text" data-key="18687"><span data-slate-leaf="true" data-offset-key="18687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="18688"><span data-slate-leaf="true" data-offset-key="18688:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18689"><span data-slate-object="text" data-key="18690"><span data-slate-leaf="true" data-offset-key="18690:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18691"><span data-slate-leaf="true" data-offset-key="18691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18692"><span data-slate-leaf="true" data-offset-key="18692:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18693"><span data-slate-object="text" data-key="18694"><span data-slate-leaf="true" data-offset-key="18694:0" data-first-offset="true"><span data-slate-string="true">            logSuccessfulTransition(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18695"><span data-slate-object="text" data-key="18696"><span data-slate-leaf="true" data-offset-key="18696:0" data-first-offset="true"><span data-slate-string="true">              stateLogger, replicaId, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18697"><span data-slate-object="text" data-key="18698"><span data-slate-leaf="true" data-offset-key="18698:0" data-first-offset="true"><span data-slate-string="true">              partition, currentState, NewReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18699"><span data-slate-object="text" data-key="18700"><span data-slate-leaf="true" data-offset-key="18700:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18701"><span data-slate-leaf="true" data-offset-key="18701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新元数据缓存中该副本对象的当前状态为 NewReplica</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18702"><span data-slate-object="text" data-key="18703"><span data-slate-leaf="true" data-offset-key="18703:0" data-first-offset="true"><span data-slate-string="true">          controllerContext.putReplicaState(replica, NewReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18704"><span data-slate-object="text" data-key="18705"><span data-slate-leaf="true" data-offset-key="18705:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18706"><span data-slate-object="text" data-key="18707"><span data-slate-leaf="true" data-offset-key="18707:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18708"><span data-slate-leaf="true" data-offset-key="18708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果没有相应数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18709"><span data-slate-object="text" data-key="18710"><span data-slate-leaf="true" data-offset-key="18710:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18711"><span data-slate-leaf="true" data-offset-key="18711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18712"><span data-slate-leaf="true" data-offset-key="18712:0" data-first-offset="true"><span data-slate-string="true"> None =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18713"><span data-slate-object="text" data-key="18714"><span data-slate-leaf="true" data-offset-key="18714:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18715"><span data-slate-leaf="true" data-offset-key="18715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18716"><span data-slate-leaf="true" data-offset-key="18716:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18717"><span data-slate-object="text" data-key="18718"><span data-slate-leaf="true" data-offset-key="18718:0" data-first-offset="true"><span data-slate-string="true">          logSuccessfulTransition(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18719"><span data-slate-object="text" data-key="18720"><span data-slate-leaf="true" data-offset-key="18720:0" data-first-offset="true"><span data-slate-string="true">            stateLogger, replicaId, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18721"><span data-slate-object="text" data-key="18722"><span data-slate-leaf="true" data-offset-key="18722:0" data-first-offset="true"><span data-slate-string="true">            partition, currentState, NewReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18723"><span data-slate-object="text" data-key="18724"><span data-slate-leaf="true" data-offset-key="18724:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18725"><span data-slate-leaf="true" data-offset-key="18725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 仅仅更新元数据缓存中该副本对象的当前状态为 NewReplica 即可</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18726"><span data-slate-object="text" data-key="18727"><span data-slate-leaf="true" data-offset-key="18727:0" data-first-offset="true"><span data-slate-string="true">        controllerContext.putReplicaState(replica, NewReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18728"><span data-slate-object="text" data-key="18729"><span data-slate-leaf="true" data-offset-key="18729:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18730"><span data-slate-object="text" data-key="18731"><span data-slate-leaf="true" data-offset-key="18731:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18732"><span data-slate-object="text" data-key="18733"><span data-slate-leaf="true" data-offset-key="18733:0" data-first-offset="true"><span data-slate-string="true">看完了代码，你可以再看下这张流程图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18734"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/cf/04/cfb649ec78f789a3889e6920b5413b04.jpg?wh=3042*4124"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18735"><span data-slate-object="text" data-key="18736"><span data-slate-leaf="true" data-offset-key="18736:0" data-first-offset="true"><span data-slate-string="true">这一路主要做的事情是，尝试从元数据缓存中，获取这些副本对象的分区信息数据，包括分区的 Leader 副本在哪个 Broker 上、ISR 中都有哪些副本，等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18737"><span data-slate-object="text" data-key="18738"><span data-slate-leaf="true" data-offset-key="18738:0" data-first-offset="true"><span data-slate-string="true">如果找不到对应的分区数据，就直接把副本状态更新为 NewReplica。否则，代码就需要给该副本所在的 Broker 发送请求，让它知道该分区的信息。同时，代码还要给集群所有运行中的 Broker 发送请求，让它们感知到新副本的加入。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="18739" id="sr-toc-9"><span data-slate-object="text" data-key="18740"><span data-slate-leaf="true" data-offset-key="18740:0" data-first-offset="true"><span data-slate-string="true">第 2 路：转换到 OnlineReplica 状态</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="18741"><span data-slate-object="text" data-key="18742"><span data-slate-leaf="true" data-offset-key="18742:0" data-first-offset="true"><span data-slate-string="true">下面我们来看第 2 路，即转换副本对象到 OnlineReplica。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18743"><span data-slate-object="text" data-key="18744"><span data-slate-leaf="true" data-offset-key="18744:0" data-first-offset="true"><span data-slate-string="true">刚刚我说过，这是副本对象正常工作时所处的状态。我们来看下要转换到这个状态，源码都做了哪些事情：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="18745"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18746"><span data-slate-object="text" data-key="18747"><span data-slate-leaf="true" data-offset-key="18747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18748"><span data-slate-leaf="true" data-offset-key="18748:0" data-first-offset="true"><span data-slate-string="true"> OnlineReplica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18749"><span data-slate-object="text" data-key="18750"><span data-slate-leaf="true" data-offset-key="18750:0" data-first-offset="true"><span data-slate-string="true">  validReplicas.foreach {replica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18751"><span data-slate-object="text" data-key="18752"><span data-slate-leaf="true" data-offset-key="18752:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18753"><span data-slate-leaf="true" data-offset-key="18753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取副本所在分区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18754"><span data-slate-object="text" data-key="18755"><span data-slate-leaf="true" data-offset-key="18755:0" data-first-offset="true"><span data-slate-string="true">    val partition = replica.topicPartition</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18756"><span data-slate-object="text" data-key="18757"><span data-slate-leaf="true" data-offset-key="18757:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18758"><span data-slate-leaf="true" data-offset-key="18758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取副本当前状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18759"><span data-slate-object="text" data-key="18760"><span data-slate-leaf="true" data-offset-key="18760:0" data-first-offset="true"><span data-slate-string="true">    val currentState = controllerContext.replicaState(replica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18761"><span data-slate-object="text" data-key="18762"><span data-slate-leaf="true" data-offset-key="18762:0" data-first-offset="true"><span data-slate-string="true">    currentState match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18763"><span data-slate-object="text" data-key="18764"><span data-slate-leaf="true" data-offset-key="18764:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18765"><span data-slate-leaf="true" data-offset-key="18765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前状态是 NewReplica</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18766"><span data-slate-object="text" data-key="18767"><span data-slate-leaf="true" data-offset-key="18767:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18768"><span data-slate-leaf="true" data-offset-key="18768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18769"><span data-slate-leaf="true" data-offset-key="18769:0" data-first-offset="true"><span data-slate-string="true"> NewReplica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18770"><span data-slate-object="text" data-key="18771"><span data-slate-leaf="true" data-offset-key="18771:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18772"><span data-slate-leaf="true" data-offset-key="18772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从元数据缓存中拿到分区副本列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18773"><span data-slate-object="text" data-key="18774"><span data-slate-leaf="true" data-offset-key="18774:0" data-first-offset="true"><span data-slate-string="true">        val assignment = controllerContext</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18775"><span data-slate-object="text" data-key="18776"><span data-slate-leaf="true" data-offset-key="18776:0" data-first-offset="true"><span data-slate-string="true">          .partitionFullReplicaAssignment(partition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18777"><span data-slate-object="text" data-key="18778"><span data-slate-leaf="true" data-offset-key="18778:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18779"><span data-slate-leaf="true" data-offset-key="18779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果副本列表不包含当前副本，视为异常情况</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18780"><span data-slate-object="text" data-key="18781"><span data-slate-leaf="true" data-offset-key="18781:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18782"><span data-slate-leaf="true" data-offset-key="18782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18783"><span data-slate-leaf="true" data-offset-key="18783:0" data-first-offset="true"><span data-slate-string="true"> (!assignment.replicas.contains(replicaId)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18784"><span data-slate-object="text" data-key="18785"><span data-slate-leaf="true" data-offset-key="18785:0" data-first-offset="true"><span data-slate-string="true">          error(s</span></span></span><span data-slate-object="text" data-key="18786"><span data-slate-leaf="true" data-offset-key="18786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Adding replica (</span></span></span></span><span data-slate-object="text" data-key="18787"><span data-slate-leaf="true" data-offset-key="18787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$replicaId</span></span></span></span></span><span data-slate-object="text" data-key="18788"><span data-slate-leaf="true" data-offset-key="18788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) that is not part of the assignment </span></span></span></span><span data-slate-object="text" data-key="18789"><span data-slate-leaf="true" data-offset-key="18789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$assignment</span></span></span></span></span><span data-slate-object="text" data-key="18790"><span data-slate-leaf="true" data-offset-key="18790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="18791"><span data-slate-leaf="true" data-offset-key="18791:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18792"><span data-slate-object="text" data-key="18793"><span data-slate-leaf="true" data-offset-key="18793:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18794"><span data-slate-leaf="true" data-offset-key="18794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将该副本加入到副本列表中，并更新元数据缓存中该分区的副本列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18795"><span data-slate-object="text" data-key="18796"><span data-slate-leaf="true" data-offset-key="18796:0" data-first-offset="true"><span data-slate-string="true">          val newAssignment = assignment.copy(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18797"><span data-slate-object="text" data-key="18798"><span data-slate-leaf="true" data-offset-key="18798:0" data-first-offset="true"><span data-slate-string="true">            replicas = assignment.replicas :+ replicaId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18799"><span data-slate-object="text" data-key="18800"><span data-slate-leaf="true" data-offset-key="18800:0" data-first-offset="true"><span data-slate-string="true">          controllerContext.updatePartitionFullReplicaAssignment(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18801"><span data-slate-object="text" data-key="18802"><span data-slate-leaf="true" data-offset-key="18802:0" data-first-offset="true"><span data-slate-string="true">            partition, newAssignment)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18803"><span data-slate-object="text" data-key="18804"><span data-slate-leaf="true" data-offset-key="18804:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18805"><span data-slate-object="text" data-key="18806"><span data-slate-leaf="true" data-offset-key="18806:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18807"><span data-slate-leaf="true" data-offset-key="18807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前状态是其他状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18808"><span data-slate-object="text" data-key="18809"><span data-slate-leaf="true" data-offset-key="18809:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18810"><span data-slate-leaf="true" data-offset-key="18810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18811"><span data-slate-leaf="true" data-offset-key="18811:0" data-first-offset="true"><span data-slate-string="true"> _ =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18812"><span data-slate-object="text" data-key="18813"><span data-slate-leaf="true" data-offset-key="18813:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18814"><span data-slate-leaf="true" data-offset-key="18814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 尝试获取该分区当前信息数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18815"><span data-slate-object="text" data-key="18816"><span data-slate-leaf="true" data-offset-key="18816:0" data-first-offset="true"><span data-slate-string="true">        controllerContext.partitionLeadershipInfo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18817"><span data-slate-object="text" data-key="18818"><span data-slate-leaf="true" data-offset-key="18818:0" data-first-offset="true"><span data-slate-string="true">          .</span></span></span><span data-slate-object="text" data-key="18819"><span data-slate-leaf="true" data-offset-key="18819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="18820"><span data-slate-leaf="true" data-offset-key="18820:0" data-first-offset="true"><span data-slate-string="true">(partition) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18821"><span data-slate-object="text" data-key="18822"><span data-slate-leaf="true" data-offset-key="18822:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18823"><span data-slate-leaf="true" data-offset-key="18823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果存在分区信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18824"><span data-slate-object="text" data-key="18825"><span data-slate-leaf="true" data-offset-key="18825:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18826"><span data-slate-leaf="true" data-offset-key="18826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向该副本对象所在 Broker 发送请求，令其同步该分区数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18827"><span data-slate-object="text" data-key="18828"><span data-slate-leaf="true" data-offset-key="18828:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18829"><span data-slate-leaf="true" data-offset-key="18829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18830"><span data-slate-leaf="true" data-offset-key="18830:0" data-first-offset="true"><span data-slate-string="true"> Some(leaderIsrAndControllerEpoch) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18831"><span data-slate-object="text" data-key="18832"><span data-slate-leaf="true" data-offset-key="18832:0" data-first-offset="true"><span data-slate-string="true">            controllerBrokerRequestBatch</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18833"><span data-slate-object="text" data-key="18834"><span data-slate-leaf="true" data-offset-key="18834:0" data-first-offset="true"><span data-slate-string="true">              .addLeaderAndIsrRequestForBrokers(Seq(replicaId),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18835"><span data-slate-object="text" data-key="18836"><span data-slate-leaf="true" data-offset-key="18836:0" data-first-offset="true"><span data-slate-string="true">                replica.topicPartition,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18837"><span data-slate-object="text" data-key="18838"><span data-slate-leaf="true" data-offset-key="18838:0" data-first-offset="true"><span data-slate-string="true">                leaderIsrAndControllerEpoch,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18839"><span data-slate-object="text" data-key="18840"><span data-slate-leaf="true" data-offset-key="18840:0" data-first-offset="true"><span data-slate-string="true">                controllerContext</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18841"><span data-slate-object="text" data-key="18842"><span data-slate-leaf="true" data-offset-key="18842:0" data-first-offset="true"><span data-slate-string="true">                  .partitionFullReplicaAssignment(partition), </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18843"><span data-slate-object="text" data-key="18844"><span data-slate-leaf="true" data-offset-key="18844:0" data-first-offset="true"><span data-slate-string="true">                isNew = </span></span></span><span data-slate-object="text" data-key="18845"><span data-slate-leaf="true" data-offset-key="18845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="18846"><span data-slate-leaf="true" data-offset-key="18846:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18847"><span data-slate-object="text" data-key="18848"><span data-slate-leaf="true" data-offset-key="18848:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18849"><span data-slate-leaf="true" data-offset-key="18849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18850"><span data-slate-leaf="true" data-offset-key="18850:0" data-first-offset="true"><span data-slate-string="true"> None =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18851"><span data-slate-object="text" data-key="18852"><span data-slate-leaf="true" data-offset-key="18852:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18853"><span data-slate-object="text" data-key="18854"><span data-slate-leaf="true" data-offset-key="18854:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18855"><span data-slate-object="text" data-key="18856"><span data-slate-leaf="true" data-offset-key="18856:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18857"><span data-slate-leaf="true" data-offset-key="18857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18858"><span data-slate-leaf="true" data-offset-key="18858:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18859"><span data-slate-object="text" data-key="18860"><span data-slate-leaf="true" data-offset-key="18860:0" data-first-offset="true"><span data-slate-string="true">      logSuccessfulTransition(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18861"><span data-slate-object="text" data-key="18862"><span data-slate-leaf="true" data-offset-key="18862:0" data-first-offset="true"><span data-slate-string="true">        stateLogger, replicaId, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18863"><span data-slate-object="text" data-key="18864"><span data-slate-leaf="true" data-offset-key="18864:0" data-first-offset="true"><span data-slate-string="true">        partition, currentState, OnlineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18865"><span data-slate-object="text" data-key="18866"><span data-slate-leaf="true" data-offset-key="18866:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18867"><span data-slate-leaf="true" data-offset-key="18867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将该副本对象设置成 OnlineReplica 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18868"><span data-slate-object="text" data-key="18869"><span data-slate-leaf="true" data-offset-key="18869:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.putReplicaState(replica, OnlineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18870"><span data-slate-object="text" data-key="18871"><span data-slate-leaf="true" data-offset-key="18871:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18872"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18873"><span data-slate-object="text" data-key="18874"><span data-slate-leaf="true" data-offset-key="18874:0" data-first-offset="true"><span data-slate-string="true">我同样使用一张图来说明：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18875"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/c7/90/c72643c179f8cf72bd054138c5a1c990.jpg?wh=3017*4182"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18876"><span data-slate-object="text" data-key="18877"><span data-slate-leaf="true" data-offset-key="18877:0" data-first-offset="true"><span data-slate-string="true">代码依然会对副本对象进行遍历，并依次执行下面的几个步骤。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18878"><div data-slate-type="list-line" data-slate-object="block" data-key="18879"><span data-slate-object="text" data-key="18880"><span data-slate-leaf="true" data-offset-key="18880:0" data-first-offset="true"><span data-slate-string="true">第 1 步，获取元数据中该副本所属的分区对象，以及该副本的当前状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18881"><span data-slate-object="text" data-key="18882"><span data-slate-leaf="true" data-offset-key="18882:0" data-first-offset="true"><span data-slate-string="true">第 2 步，查看当前状态是否是 NewReplica。如果是，则获取分区的副本列表，并判断该副本是否在当前的副本列表中，假如不在，就记录错误日志，并更新元数据中的副本列表；如果状态不是 NewReplica，就说明，这是一个已存在的副本对象，那么，源码会获取对应分区的详细数据，然后向该副本对象所在的 Broker 发送 LeaderAndIsrRequest 请求，令其同步获知，并保存该分区数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18883"><span data-slate-object="text" data-key="18884"><span data-slate-leaf="true" data-offset-key="18884:0" data-first-offset="true"><span data-slate-string="true">第 3 步，将该副本对象状态变更为 OnlineReplica。至此，该副本处于正常工作状态。</span></span></span></div></div><h4 data-slate-type="heading" data-slate-object="block" data-key="18885" id="sr-toc-10"><span data-slate-object="text" data-key="18886"><span data-slate-leaf="true" data-offset-key="18886:0" data-first-offset="true"><span data-slate-string="true">第 3 路：转换到 OfflineReplica 状态</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="18887"><span data-slate-object="text" data-key="18888"><span data-slate-leaf="true" data-offset-key="18888:0" data-first-offset="true"><span data-slate-string="true">最后，再来看下第 3 路分支。这路分支要将副本对象的状态转换成 OfflineReplica。我依然以代码注释的方式给出主要的代码逻辑：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="18889"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18890"><span data-slate-object="text" data-key="18891"><span data-slate-leaf="true" data-offset-key="18891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18892"><span data-slate-leaf="true" data-offset-key="18892:0" data-first-offset="true"><span data-slate-string="true"> OfflineReplica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18893"><span data-slate-object="text" data-key="18894"><span data-slate-leaf="true" data-offset-key="18894:0" data-first-offset="true"><span data-slate-string="true">  validReplicas.foreach {replica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18895"><span data-slate-object="text" data-key="18896"><span data-slate-leaf="true" data-offset-key="18896:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18897"><span data-slate-leaf="true" data-offset-key="18897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向副本所在 Broker 发送 StopReplicaRequest 请求，停止对应副本</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18898"><span data-slate-object="text" data-key="18899"><span data-slate-leaf="true" data-offset-key="18899:0" data-first-offset="true"><span data-slate-string="true">    controllerBrokerRequestBatch</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18900"><span data-slate-object="text" data-key="18901"><span data-slate-leaf="true" data-offset-key="18901:0" data-first-offset="true"><span data-slate-string="true">      .addStopReplicaRequestForBrokers(Seq(replicaId), </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18902"><span data-slate-object="text" data-key="18903"><span data-slate-leaf="true" data-offset-key="18903:0" data-first-offset="true"><span data-slate-string="true">        replica.topicPartition, deletePartition = </span></span></span><span data-slate-object="text" data-key="18904"><span data-slate-leaf="true" data-offset-key="18904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="18905"><span data-slate-leaf="true" data-offset-key="18905:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18906"><span data-slate-object="text" data-key="18907"><span data-slate-leaf="true" data-offset-key="18907:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18908"><span data-slate-object="text" data-key="18909"><span data-slate-leaf="true" data-offset-key="18909:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18910"><span data-slate-leaf="true" data-offset-key="18910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将副本对象集合划分成有 Leader 信息的副本集合和无 Leader 信息的副本集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18911"><span data-slate-object="text" data-key="18912"><span data-slate-leaf="true" data-offset-key="18912:0" data-first-offset="true"><span data-slate-string="true">  val (replicasWithLeadershipInfo, replicasWithoutLeadershipInfo) = </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18913"><span data-slate-object="text" data-key="18914"><span data-slate-leaf="true" data-offset-key="18914:0" data-first-offset="true"><span data-slate-string="true">    validReplicas.partition {replica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18915"><span data-slate-object="text" data-key="18916"><span data-slate-leaf="true" data-offset-key="18916:0" data-first-offset="true"><span data-slate-string="true">      controllerContext.partitionLeadershipInfo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18917"><span data-slate-object="text" data-key="18918"><span data-slate-leaf="true" data-offset-key="18918:0" data-first-offset="true"><span data-slate-string="true">        .contains(replica.topicPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18919"><span data-slate-object="text" data-key="18920"><span data-slate-leaf="true" data-offset-key="18920:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18921"><span data-slate-object="text" data-key="18922"><span data-slate-leaf="true" data-offset-key="18922:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18923"><span data-slate-leaf="true" data-offset-key="18923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对于有 Leader 信息的副本集合而言从，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18924"><span data-slate-object="text" data-key="18925"><span data-slate-leaf="true" data-offset-key="18925:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18926"><span data-slate-leaf="true" data-offset-key="18926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 它们对应的所有分区中移除该副本对象并更新 ZooKeeper 节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18927"><span data-slate-object="text" data-key="18928"><span data-slate-leaf="true" data-offset-key="18928:0" data-first-offset="true"><span data-slate-string="true">  val updatedLeaderIsrAndControllerEpochs = </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18929"><span data-slate-object="text" data-key="18930"><span data-slate-leaf="true" data-offset-key="18930:0" data-first-offset="true"><span data-slate-string="true">    removeReplicasFromIsr(replicaId,  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18931"><span data-slate-object="text" data-key="18932"><span data-slate-leaf="true" data-offset-key="18932:0" data-first-offset="true"><span data-slate-string="true">      replicasWithLeadershipInfo.map(_.topicPartition))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18933"><span data-slate-object="text" data-key="18934"><span data-slate-leaf="true" data-offset-key="18934:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18935"><span data-slate-leaf="true" data-offset-key="18935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历每个更新过的分区信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18936"><span data-slate-object="text" data-key="18937"><span data-slate-leaf="true" data-offset-key="18937:0" data-first-offset="true"><span data-slate-string="true">  updatedLeaderIsrAndControllerEpochs.foreach {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18938"><span data-slate-object="text" data-key="18939"><span data-slate-leaf="true" data-offset-key="18939:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18940"><span data-slate-leaf="true" data-offset-key="18940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18941"><span data-slate-leaf="true" data-offset-key="18941:0" data-first-offset="true"><span data-slate-string="true"> (partition, leaderIsrAndControllerEpoch) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18942"><span data-slate-object="text" data-key="18943"><span data-slate-leaf="true" data-offset-key="18943:0" data-first-offset="true"><span data-slate-string="true">      stateLogger.info(s</span></span></span><span data-slate-object="text" data-key="18944"><span data-slate-leaf="true" data-offset-key="18944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Partition </span></span></span></span><span data-slate-object="text" data-key="18945"><span data-slate-leaf="true" data-offset-key="18945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$partition</span></span></span></span></span><span data-slate-object="text" data-key="18946"><span data-slate-leaf="true" data-offset-key="18946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> state changed to </span></span></span></span><span data-slate-object="text" data-key="18947"><span data-slate-leaf="true" data-offset-key="18947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$leaderIsrAndControllerEpoch</span></span></span></span></span><span data-slate-object="text" data-key="18948"><span data-slate-leaf="true" data-offset-key="18948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> after removing replica </span></span></span></span><span data-slate-object="text" data-key="18949"><span data-slate-leaf="true" data-offset-key="18949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$replicaId</span></span></span></span></span><span data-slate-object="text" data-key="18950"><span data-slate-leaf="true" data-offset-key="18950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> from the ISR as part of transition to </span></span></span></span><span data-slate-object="text" data-key="18951"><span data-slate-leaf="true" data-offset-key="18951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$OfflineReplica</span></span></span></span></span><span data-slate-object="text" data-key="18952"><span data-slate-leaf="true" data-offset-key="18952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="18953"><span data-slate-leaf="true" data-offset-key="18953:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18954"><span data-slate-object="text" data-key="18955"><span data-slate-leaf="true" data-offset-key="18955:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18956"><span data-slate-leaf="true" data-offset-key="18956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果分区对应主题并未被删除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18957"><span data-slate-object="text" data-key="18958"><span data-slate-leaf="true" data-offset-key="18958:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18959"><span data-slate-leaf="true" data-offset-key="18959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18960"><span data-slate-leaf="true" data-offset-key="18960:0" data-first-offset="true"><span data-slate-string="true"> (!controllerContext.isTopicQueuedUpForDeletion(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18961"><span data-slate-object="text" data-key="18962"><span data-slate-leaf="true" data-offset-key="18962:0" data-first-offset="true"><span data-slate-string="true">        partition.topic)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18963"><span data-slate-object="text" data-key="18964"><span data-slate-leaf="true" data-offset-key="18964:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18965"><span data-slate-leaf="true" data-offset-key="18965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取该分区除给定副本以外的其他副本所在的 Broker  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18966"><span data-slate-object="text" data-key="18967"><span data-slate-leaf="true" data-offset-key="18967:0" data-first-offset="true"><span data-slate-string="true">        val recipients = controllerContext</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18968"><span data-slate-object="text" data-key="18969"><span data-slate-leaf="true" data-offset-key="18969:0" data-first-offset="true"><span data-slate-string="true">          .partitionReplicaAssignment(partition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18970"><span data-slate-object="text" data-key="18971"><span data-slate-leaf="true" data-offset-key="18971:0" data-first-offset="true"><span data-slate-string="true">          .filterNot(_ == replicaId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18972"><span data-slate-object="text" data-key="18973"><span data-slate-leaf="true" data-offset-key="18973:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18974"><span data-slate-leaf="true" data-offset-key="18974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向这些 Broker 发送请求更新该分区更新过的分区 LeaderAndIsr 数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18975"><span data-slate-object="text" data-key="18976"><span data-slate-leaf="true" data-offset-key="18976:0" data-first-offset="true"><span data-slate-string="true">        controllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18977"><span data-slate-object="text" data-key="18978"><span data-slate-leaf="true" data-offset-key="18978:0" data-first-offset="true"><span data-slate-string="true">          recipients,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18979"><span data-slate-object="text" data-key="18980"><span data-slate-leaf="true" data-offset-key="18980:0" data-first-offset="true"><span data-slate-string="true">          partition,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18981"><span data-slate-object="text" data-key="18982"><span data-slate-leaf="true" data-offset-key="18982:0" data-first-offset="true"><span data-slate-string="true">          leaderIsrAndControllerEpoch,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18983"><span data-slate-object="text" data-key="18984"><span data-slate-leaf="true" data-offset-key="18984:0" data-first-offset="true"><span data-slate-string="true">          controllerContext.partitionFullReplicaAssignment(partition), </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18985"><span data-slate-object="text" data-key="18986"><span data-slate-leaf="true" data-offset-key="18986:0" data-first-offset="true"><span data-slate-string="true">          isNew = </span></span></span><span data-slate-object="text" data-key="18987"><span data-slate-leaf="true" data-offset-key="18987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="18988"><span data-slate-leaf="true" data-offset-key="18988:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18989"><span data-slate-object="text" data-key="18990"><span data-slate-leaf="true" data-offset-key="18990:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18991"><span data-slate-object="text" data-key="18992"><span data-slate-leaf="true" data-offset-key="18992:0" data-first-offset="true"><span data-slate-string="true">      val replica = PartitionAndReplica(partition, replicaId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18993"><span data-slate-object="text" data-key="18994"><span data-slate-leaf="true" data-offset-key="18994:0" data-first-offset="true"><span data-slate-string="true">      val currentState = controllerContext.replicaState(replica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18995"><span data-slate-object="text" data-key="18996"><span data-slate-leaf="true" data-offset-key="18996:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18997"><span data-slate-leaf="true" data-offset-key="18997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18998"><span data-slate-leaf="true" data-offset-key="18998:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18999"><span data-slate-object="text" data-key="19000"><span data-slate-leaf="true" data-offset-key="19000:0" data-first-offset="true"><span data-slate-string="true">        logSuccessfulTransition(stateLogger, replicaId, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19001"><span data-slate-object="text" data-key="19002"><span data-slate-leaf="true" data-offset-key="19002:0" data-first-offset="true"><span data-slate-string="true">          partition, currentState, OfflineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19003"><span data-slate-object="text" data-key="19004"><span data-slate-leaf="true" data-offset-key="19004:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19005"><span data-slate-leaf="true" data-offset-key="19005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置该分区给定副本的状态为 OfflineReplica</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19006"><span data-slate-object="text" data-key="19007"><span data-slate-leaf="true" data-offset-key="19007:0" data-first-offset="true"><span data-slate-string="true">      controllerContext.putReplicaState(replica, OfflineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19008"><span data-slate-object="text" data-key="19009"><span data-slate-leaf="true" data-offset-key="19009:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19010"><span data-slate-object="text" data-key="19011"><span data-slate-leaf="true" data-offset-key="19011:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19012"><span data-slate-leaf="true" data-offset-key="19012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历无 Leader 信息的所有副本对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19013"><span data-slate-object="text" data-key="19014"><span data-slate-leaf="true" data-offset-key="19014:0" data-first-offset="true"><span data-slate-string="true">  replicasWithoutLeadershipInfo.foreach {replica =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19015"><span data-slate-object="text" data-key="19016"><span data-slate-leaf="true" data-offset-key="19016:0" data-first-offset="true"><span data-slate-string="true">    val currentState = controllerContext.replicaState(replica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19017"><span data-slate-object="text" data-key="19018"><span data-slate-leaf="true" data-offset-key="19018:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19019"><span data-slate-leaf="true" data-offset-key="19019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19020"><span data-slate-leaf="true" data-offset-key="19020:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19021"><span data-slate-object="text" data-key="19022"><span data-slate-leaf="true" data-offset-key="19022:0" data-first-offset="true"><span data-slate-string="true">      logSuccessfulTransition(stateLogger, replicaId, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19023"><span data-slate-object="text" data-key="19024"><span data-slate-leaf="true" data-offset-key="19024:0" data-first-offset="true"><span data-slate-string="true">        replica.topicPartition, currentState, OfflineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19025"><span data-slate-object="text" data-key="19026"><span data-slate-leaf="true" data-offset-key="19026:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="19027"><span data-slate-leaf="true" data-offset-key="19027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向集群所有 Broker 发送请求，更新对应分区的元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19028"><span data-slate-object="text" data-key="19029"><span data-slate-leaf="true" data-offset-key="19029:0" data-first-offset="true"><span data-slate-string="true">    controllerBrokerRequestBatch.addUpdateMetadataRequestForBrokers(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19030"><span data-slate-object="text" data-key="19031"><span data-slate-leaf="true" data-offset-key="19031:0" data-first-offset="true"><span data-slate-string="true">      controllerContext.liveOrShuttingDownBrokerIds.toSeq,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19032"><span data-slate-object="text" data-key="19033"><span data-slate-leaf="true" data-offset-key="19033:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19034"><span data-slate-leaf="true" data-offset-key="19034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="19035"><span data-slate-leaf="true" data-offset-key="19035:0" data-first-offset="true"><span data-slate-string="true">(replica.topicPartition))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19036"><span data-slate-object="text" data-key="19037"><span data-slate-leaf="true" data-offset-key="19037:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19038"><span data-slate-leaf="true" data-offset-key="19038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置该分区给定副本的状态为 OfflineReplica</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19039"><span data-slate-object="text" data-key="19040"><span data-slate-leaf="true" data-offset-key="19040:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.putReplicaState(replica, OfflineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19041"><span data-slate-object="text" data-key="19042"><span data-slate-leaf="true" data-offset-key="19042:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19043"><span data-slate-object="text" data-key="19044"><span data-slate-leaf="true" data-offset-key="19044:0" data-first-offset="true"><span data-slate-string="true">我依然用一张图来说明它的执行流程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="19045"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/ac/18/ace407b3bf74852dbc5506af1cae2318.jpg?wh=2712*4774"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19046"><span data-slate-object="text" data-key="19047"><span data-slate-leaf="true" data-offset-key="19047:0" data-first-offset="true"><span data-slate-string="true">首先，代码会给所有符合状态转换的副本所在的 Broker，发送 StopReplicaRequest 请求，显式地告诉这些 Broker 停掉其上的对应副本。Kafka 的副本管理器组件（ReplicaManager）负责处理这个逻辑。后面我们会用两节课的时间专门讨论 ReplicaManager 的实现，这里你只需要了解，StopReplica 请求被发送出去之后，这些 Broker 上对应的副本就停止工作了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19048"><span data-slate-object="text" data-key="19049"><span data-slate-leaf="true" data-offset-key="19049:0" data-first-offset="true"><span data-slate-string="true">其次，代码根据分区是否保存了 Leader 信息，将副本集合划分成两个子集：有 Leader 副本集合和无 Leader 副本集合。有无 Leader 信息并不仅仅包含 Leader，还有 ISR 和 controllerEpoch 等数据。不过，你大致可以认为，副本集合是根据有无 Leader 进行划分的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19050"><span data-slate-object="text" data-key="19051"><span data-slate-leaf="true" data-offset-key="19051:0" data-first-offset="true"><span data-slate-string="true">接下来，源码会遍历有 Leader 的子集合，向这些副本所在的 Broker 发送 LeaderAndIsrRequest 请求，去更新停止副本操作之后的分区信息，再把这些分区状态设置为 OfflineReplica。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19052"><span data-slate-object="text" data-key="19053"><span data-slate-leaf="true" data-offset-key="19053:0" data-first-offset="true"><span data-slate-string="true">最后，源码遍历无 Leader 的子集合，执行与上一步非常类似的操作。只不过，对于无 Leader 而言，因为我们没有执行任何 Leader 选举操作，所以给这些副本所在的 Broker 发送的就不是 LeaderAndIsrRequest 请求了，而是 UpdateMetadataRequest 请求，显式去告知它们更新对应分区的元数据即可，然后再把副本状态设置为 OfflineReplica。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19054"><span data-slate-object="text" data-key="19055"><span data-slate-leaf="true" data-offset-key="19055:0" data-first-offset="true"><span data-slate-string="true">从这段描述中，我们可以知道，把副本状态变更为 OfflineReplica 的主要逻辑，其实就是停止对应副本 + 更新远端 Broker 元数据的操作。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19056" id="sr-toc-11"><span data-slate-object="text" data-key="19057"><span data-slate-leaf="true" data-offset-key="19057:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19058"><span data-slate-object="text" data-key="19059"><span data-slate-leaf="true" data-offset-key="19059:0" data-first-offset="true"><span data-slate-string="true">今天，我们重点学习了 Kafka 的副本状态机实现原理，还仔细研读了这部分的源码。我们简单回顾一下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="19060"><div data-slate-type="list-line" data-slate-object="block" data-key="19061"><span data-slate-object="text" data-key="19062"><span data-slate-leaf="true" data-offset-key="19062:0" data-first-offset="true"><span data-slate-string="true">副本状态机：ReplicaStateMachine 是 Kafka Broker 端源码中控制副本状态流转的实现类。每个 Broker 启动时都会创建 ReplicaStateMachine 实例，但只有 Controller 组件所在的 Broker 才会启动它。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="19063"><span data-slate-object="text" data-key="19064"><span data-slate-leaf="true" data-offset-key="19064:0" data-first-offset="true"><span data-slate-string="true">副本状态：当前，Kafka 定义了 7 类副本状态。同时，它还规定了每类状态合法的前置状态。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="19065"><span data-slate-object="text" data-key="19066"><span data-slate-leaf="true" data-offset-key="19066:0" data-first-offset="true"><span data-slate-string="true">handleStateChanges：用于执行状态转换的核心方法。底层调用 doHandleStateChanges 方法，以 7 路 case 分支的形式穷举每类状态的转换逻辑。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="19067"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/27/29/272df3f3b024c34fde619e122eeba429.jpg?wh=2250*1701"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19068"><span data-slate-object="text" data-key="19069"><span data-slate-leaf="true" data-offset-key="19069:0" data-first-offset="true"><span data-slate-string="true">下节课，我将带你学习 Kafka 中另一类著名的状态机：分区状态机。掌握了这两个状态机，你就能清楚地知道 Kafka Broker 端管理分区和副本对象的完整流程和手段了。事实上，弄明白了这两个组件之后，Controller 负责主题方面的所有工作内容基本上都不会难倒你了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19070" id="sr-toc-12"><span data-slate-object="text" data-key="19071"><span data-slate-leaf="true" data-offset-key="19071:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19072"><span data-slate-object="text" data-key="19073"><span data-slate-leaf="true" data-offset-key="19073:0" data-first-offset="true"><span data-slate-string="true">请尝试分析 doHandleStateChanges 方法中最后一路分支的代码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19074"><span data-slate-object="text" data-key="19075"><span data-slate-leaf="true" data-offset-key="19075:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-13">精选留言 (5)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们结合源码重点了解了 TopicDeletionManager 类以及 Topic 的被删除流程。课后我请你思考 markTopicIneligibleForDeletion 方法是做什么用的以及实现原理是怎么样的。我来给出我的思考：markTopicIneligibleForDeletion 方法的主要作用是标记给定主题为” 暂时不可删除 "。它的实现原理非常简单，就是将给定的待删除主题加入到 ControllerContext 的 topicsIneligibleForDeletion 集合中。后面 TopicDeletionManager 在恢复主题删除过程中会再次尝试对 topicsIneligibleForDeletion 集合中的主题进行删除。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-06-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>NonExistentReplica 分支，会更新 controllerContext 中当前 currentAssignedReplicas 的副本 AR 集合，纪录成功状态转换，之后删除这个副本。这里说的状态转换成功只是内存缓存更新成功，zookeeper 还未成功的，有延时。NonExistentReplica 分支，会更新 controllerContext 中当前 currentAssignedReplicas 的副本 AR 集合，纪录成功状态转换，之后删除这个副本。这里说的状态转换成功只是内存缓存更新成功，zookeeper 还未成功的，有延时。</div><div><p>作者回复：很详细的分析～</p></div><div><div>2020-05-30</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 张子涵</span></div></div><div> case NonExistentReplica =&gt;
        // 遍历所有可执行转换的副本对象
        validReplicas.foreach {replica =&gt;
		  // 获取副本对象的当前状态
          val currentState = controllerContext.replicaState (replica)
		  // 获取分区列表  执行 removeReplica 操作 剔除相等的 replica
          val newAssignedReplicas = controllerContext
            .partitionFullReplicaAssignment (replica.topicPartition)
            .removeReplica (replica.replica)
          // 底层调用 getOrElseUpdate 方法 更新 partition 及 newAssignedReplicas 信息
          controllerContext.updatePartitionFullReplicaAssignment (replica.topicPartition, newAssignedReplicas)
		  // 记录成功转换状态的操作
          logSuccessfulTransition (replicaId, replica.topicPartition, currentState, NonExistentReplica)
		  // 最后调用 removeReplicaState 方法
          controllerContext.removeReplicaState (replica)
        }
		
def updatePartitionFullReplicaAssignment (topicPartition: TopicPartition, newAssignment: ReplicaAssignment): Unit = {
    val assignments = partitionAssignments.getOrElseUpdate (topicPartition.topic, mutable.Map.empty)
    assignments.put (topicPartition.partition, newAssignment)
  }
def removeReplicaState (replica: PartitionAndReplica): Unit = {
    replicaStates.remove (replica)
  }
def removeReplica (replica: Int): ReplicaAssignment = {
    ReplicaAssignment (
      replicas.filterNot (_ == replica),  -- 将不符合的结果返回
      addingReplicas.filterNot (_ == replica),
      removingReplicas.filterNot (_ == replica)
    )
  }	
建议同学们学习的时候，可以多看一些底层方法，这样理解的更快些</div><div><p>作者回复: ������</p></div><div><div>2020-08-26</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 张子涵</span></div></div><div>直到这节课，愈发觉得源码真的不是读读方法那么简单的，串联起来的理解更为重要</div><div><p>作者回复：嗯嗯，有机会分享你的源码学习心得：）</p></div><div><div>2020-08-26</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132"></div></div><div><div><div><span>RonnieXie</span></div></div><div>老师，请问如果 doHandleStateChanges 完成状态转换操作，但是 doHandleStateChanges 发送请求给 Broker 失败了，是否要回滚？似乎源码中没有这块处理逻辑，是什么逻辑保障了这异常场景？</div><div><p>作者回复：嗯，确实没有状态回滚机制，只是记录错误日志。我想这是目前部分状态不一致的原因之一吧</p></div><div><div>2020-06-02</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1m"><outline class="toc-level-h1" data-reactid=".1m.0" style="width: 175px;"><active data-reactid=".1m.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1m.0.1"><span data-reactid=".1m.0.1.0">17 | ReplicaStateMachine：揭秘副本状态机实现原理</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.1" style="width: 165px;"><active data-reactid=".1m.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1m.1.1"><span data-reactid=".1m.1.1.0">课前导读</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.2" style="width: 165px;"><active data-reactid=".1m.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1m.2.1"><span data-reactid=".1m.2.1.0">定义与初始化</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.3" style="width: 165px;"><active data-reactid=".1m.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1m.3.1"><span data-reactid=".1m.3.1.0">副本状态及状态管理流程</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.4" style="width: 165px;"><active data-reactid=".1m.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1m.4.1"><span data-reactid=".1m.4.1.0">具体实现类：ZkReplicaStateMachine</span></a></outline><outline class="toc-level-h3" data-reactid=".1m.5" style="width: 155px;"><active data-reactid=".1m.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1m.5.1"><span data-reactid=".1m.5.1.0">状态转换方法定义</span></a></outline><outline class="toc-level-h3" data-reactid=".1m.6" style="width: 155px;"><active data-reactid=".1m.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1m.6.1"><span data-reactid=".1m.6.1.0">handleStateChanges 方法</span></a></outline><outline class="toc-level-h3" data-reactid=".1m.7" style="width: 155px;"><active data-reactid=".1m.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1m.7.1"><span data-reactid=".1m.7.1.0">doHandleStateChanges 方法</span></a></outline><outline class="toc-level-h4" data-reactid=".1m.8" style="width: 145px;"><active data-reactid=".1m.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1m.8.1"><span data-reactid=".1m.8.1.0">第 1 路：转换到 NewReplica 状态</span></a></outline><outline class="toc-level-h4" data-reactid=".1m.9" style="width: 145px;"><active data-reactid=".1m.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1m.9.1"><span data-reactid=".1m.9.1.0">第 2 路：转换到 OnlineReplica 状态</span></a></outline><outline class="toc-level-h4" data-reactid=".1m.a" style="width: 145px;"><active data-reactid=".1m.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1m.a.1"><span data-reactid=".1m.a.1.0">第 3 路：转换到 OfflineReplica 状态</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.b" style="width: 165px;"><active data-reactid=".1m.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1m.b.1"><span data-reactid=".1m.b.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.c" style="width: 165px;"><active data-reactid=".1m.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".1m.c.1"><span data-reactid=".1m.c.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".1m.d" style="width: 165px;"><active data-reactid=".1m.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".1m.d.1"><span data-reactid=".1m.d.1.0">精选留言 (5)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/242663" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>