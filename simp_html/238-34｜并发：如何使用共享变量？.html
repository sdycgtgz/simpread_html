
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 34｜并发：如何使用共享变量？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>34｜并发：如何使用共享变量？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">今天，我会讲解 Go 语言提供的另一种分支控制结构：switch 语句。和 if 分支语句相比，在一些执行分支较多的场景下，使用 switch 分支控制语</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 34｜并发：如何使用共享变量？</h1><div><span>Tony Bai</span> <span>2022-01-14</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/cf/b4/cf82f29bd943db4670af118860cf3bb4.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：Tony Bai</span><span> 大小：15.92M</span><span> 时长：17:26</span></div></div><audio title="34｜并发：如何使用共享变量？" src="https://res001.geekbang.org/media/audio/c6/d6/c6f0af848a13fa534a7ea0e0bebb1ed6/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="18430" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="18431"><span data-slate-object="text" data-key="18432"><span data-slate-leaf="true" data-offset-key="18432:0" data-first-offset="true"><span data-slate-string="true">你好，我是 Tony Bai。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18433"><span data-slate-object="text" data-key="18434"><span data-slate-leaf="true" data-offset-key="18434:0" data-first-offset="true"><span data-slate-string="true">在前面的讲解中，我们学习了 Go 的并发实现方案，知道了 Go 基于 Tony Hoare 的 </span></span></span><span data-slate-object="text" data-key="18435"><span data-slate-leaf="true" data-offset-key="18435:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">CSP 并发模型</span></span></span></span><span data-slate-object="text" data-key="18436"><span data-slate-leaf="true" data-offset-key="18436:0" data-first-offset="true"><span data-slate-string="true">理论，实现了 Goroutine、channel 等并发原语。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18437"><span data-slate-object="text" data-key="18438"><span data-slate-leaf="true" data-offset-key="18438:0" data-first-offset="true"><span data-slate-string="true">并且，Go 语言之父 Rob Pike 还有一句经典名言：“不要通过共享内存来通信，应该通过通信来共享内存（Don’t communicate by sharing memory, share memory by communicating）”，这就奠定了 Go 应用并发设计的主流风格：</span></span></span><span data-slate-object="text" data-key="18439"><span data-slate-leaf="true" data-offset-key="18439:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">使用 channel 进行不同 Goroutine 间的通信</span></span></span></span><span data-slate-object="text" data-key="18440"><span data-slate-leaf="true" data-offset-key="18440:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18441"><span data-slate-object="text" data-key="18442"><span data-slate-leaf="true" data-offset-key="18442:0" data-first-offset="true"><span data-slate-string="true">不过，Go 也并没有彻底放弃基于共享内存的并发模型，而是在提供 CSP 并发模型原语的同时，还通过标准库的 sync 包，提供了针对传统的、基于共享内存并发模型的低级同步原语，包括：互斥锁（sync.Mutex）、读写锁（sync.RWMutex）、条件变量（sync.Cond）等，并通过 atomic 包提供了原子操作原语等等。显然，基于共享内存的并发模型在 Go 语言中依然有它的 “用武之地”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18443"><span data-slate-object="text" data-key="18444"><span data-slate-leaf="true" data-offset-key="18444:0" data-first-offset="true"><span data-slate-string="true">所以，在并发的最后一讲，我们就围绕 sync 包中的几个同步结构与对应的方法，聊聊基于共享内存的并发模型在 Go 中的应用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18445"><span data-slate-object="text" data-key="18446"><span data-slate-leaf="true" data-offset-key="18446:0" data-first-offset="true"><span data-slate-string="true">我们先来看看在哪些场景下，我们需要用到 sync 包提供的低级同步原语。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18447" id="sr-toc-1"><span data-slate-object="text" data-key="18448"><span data-slate-leaf="true" data-offset-key="18448:0" data-first-offset="true"><span data-slate-string="true">sync 包低级同步原语可以用在哪？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18449"><span data-slate-object="text" data-key="18450"><span data-slate-leaf="true" data-offset-key="18450:0" data-first-offset="true"><span data-slate-string="true">这里我要先强调一句，一般情况下，我建议你优先使用 CSP 并发模型进行并发程序设计。但是在下面一些场景中，我们依然需要 sync 包提供的低级同步原语。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18451"><span data-slate-object="text" data-key="18452"><span data-slate-leaf="true" data-offset-key="18452:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b05a1ef4" data-attr-id="41741" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先是需要高性能的临界区（critical section）同步机制场景。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18453"><span data-slate-object="text" data-key="18454"><span data-slate-leaf="true" data-offset-key="18454:0" data-first-offset="true"><span data-slate-string="true">在 Go 中，channel 并发原语也可以用于对数据对象访问的同步，我们可以把 channel 看成是一种高级的同步原语，它自身的实现也是建构在低级同步原语之上的。也正因为如此，</span></span><span data-slate-leaf="true" data-offset-key="18454:1"><span data-slate-object="annotation" data-annotation-key="gkann_760a2016" data-attr-id="33957" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">channel 自身的性能与低级同步原语相比要略微逊色，开销要更大。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18455"><span data-slate-object="text" data-key="18456"><span data-slate-leaf="true" data-offset-key="18456:0" data-first-offset="true"><span data-slate-string="true">这里，关于 sync.Mutex 和 channel 各自实现的临界区同步机制，我做了一个简单的性能基准测试对比，通过对比结果，我们可以很容易看出两者的性能差异：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18457"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18458"><span data-slate-object="text" data-key="18459"><span data-slate-leaf="true" data-offset-key="18459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18460"><span data-slate-leaf="true" data-offset-key="18460:0" data-first-offset="true"><span data-slate-string="true"> cs = </span></span></span><span data-slate-object="text" data-key="18461"><span data-slate-leaf="true" data-offset-key="18461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18462"><span data-slate-leaf="true" data-offset-key="18462:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18463"><span data-slate-leaf="true" data-offset-key="18463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 模拟临界区要保护的数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18464"><span data-slate-object="text" data-key="18465"><span data-slate-leaf="true" data-offset-key="18465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18466"><span data-slate-leaf="true" data-offset-key="18466:0" data-first-offset="true"><span data-slate-string="true"> mu sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18467"><span data-slate-object="text" data-key="18468"><span data-slate-leaf="true" data-offset-key="18468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18469"><span data-slate-leaf="true" data-offset-key="18469:0" data-first-offset="true"><span data-slate-string="true"> c = </span></span></span><span data-slate-object="text" data-key="18470"><span data-slate-leaf="true" data-offset-key="18470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="18471"><span data-slate-leaf="true" data-offset-key="18471:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18472"><span data-slate-leaf="true" data-offset-key="18472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="18473"><span data-slate-leaf="true" data-offset-key="18473:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18474"><span data-slate-leaf="true" data-offset-key="18474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="18475"><span data-slate-leaf="true" data-offset-key="18475:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="18476"><span data-slate-leaf="true" data-offset-key="18476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="18477"><span data-slate-leaf="true" data-offset-key="18477:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18478"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18479"><span data-slate-object="text" data-key="18480"><span data-slate-leaf="true" data-offset-key="18480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18481"><span data-slate-leaf="true" data-offset-key="18481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18482"><span data-slate-leaf="true" data-offset-key="18482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">criticalSectionSyncByMutex</span></span></span></span></span><span data-slate-object="text" data-key="18483"><span data-slate-leaf="true" data-offset-key="18483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18484"><span data-slate-leaf="true" data-offset-key="18484:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18485"><span data-slate-object="text" data-key="18486"><span data-slate-leaf="true" data-offset-key="18486:0" data-first-offset="true"><span data-slate-string="true">    mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18487"><span data-slate-object="text" data-key="18488"><span data-slate-leaf="true" data-offset-key="18488:0" data-first-offset="true"><span data-slate-string="true">    cs++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18489"><span data-slate-object="text" data-key="18490"><span data-slate-leaf="true" data-offset-key="18490:0" data-first-offset="true"><span data-slate-string="true">    mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18491"><span data-slate-object="text" data-key="18492"><span data-slate-leaf="true" data-offset-key="18492:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18493"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18494"><span data-slate-object="text" data-key="18495"><span data-slate-leaf="true" data-offset-key="18495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18496"><span data-slate-leaf="true" data-offset-key="18496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18497"><span data-slate-leaf="true" data-offset-key="18497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">criticalSectionSyncByChan</span></span></span></span></span><span data-slate-object="text" data-key="18498"><span data-slate-leaf="true" data-offset-key="18498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18499"><span data-slate-leaf="true" data-offset-key="18499:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18500"><span data-slate-object="text" data-key="18501"><span data-slate-leaf="true" data-offset-key="18501:0" data-first-offset="true"><span data-slate-string="true">    c &lt;- </span></span></span><span data-slate-object="text" data-key="18502"><span data-slate-leaf="true" data-offset-key="18502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="18503"><span data-slate-leaf="true" data-offset-key="18503:0" data-first-offset="true"><span data-slate-string="true">{}{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18504"><span data-slate-object="text" data-key="18505"><span data-slate-leaf="true" data-offset-key="18505:0" data-first-offset="true"><span data-slate-string="true">    cs++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18506"><span data-slate-object="text" data-key="18507"><span data-slate-leaf="true" data-offset-key="18507:0" data-first-offset="true"><span data-slate-string="true">    &lt;-c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18508"><span data-slate-object="text" data-key="18509"><span data-slate-leaf="true" data-offset-key="18509:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18510"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18511"><span data-slate-object="text" data-key="18512"><span data-slate-leaf="true" data-offset-key="18512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18513"><span data-slate-leaf="true" data-offset-key="18513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18514"><span data-slate-leaf="true" data-offset-key="18514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkCriticalSectionSyncByMutex</span></span></span></span></span><span data-slate-object="text" data-key="18515"><span data-slate-leaf="true" data-offset-key="18515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18516"><span data-slate-leaf="true" data-offset-key="18516:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18517"><span data-slate-object="text" data-key="18518"><span data-slate-leaf="true" data-offset-key="18518:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18519"><span data-slate-leaf="true" data-offset-key="18519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18520"><span data-slate-leaf="true" data-offset-key="18520:0" data-first-offset="true"><span data-slate-string="true"> n := </span></span></span><span data-slate-object="text" data-key="18521"><span data-slate-leaf="true" data-offset-key="18521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18522"><span data-slate-leaf="true" data-offset-key="18522:0" data-first-offset="true"><span data-slate-string="true">; n &lt; b.N; n++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18523"><span data-slate-object="text" data-key="18524"><span data-slate-leaf="true" data-offset-key="18524:0" data-first-offset="true"><span data-slate-string="true">        criticalSectionSyncByMutex()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18525"><span data-slate-object="text" data-key="18526"><span data-slate-leaf="true" data-offset-key="18526:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18527"><span data-slate-object="text" data-key="18528"><span data-slate-leaf="true" data-offset-key="18528:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18529"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18530"><span data-slate-object="text" data-key="18531"><span data-slate-leaf="true" data-offset-key="18531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18532"><span data-slate-leaf="true" data-offset-key="18532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18533"><span data-slate-leaf="true" data-offset-key="18533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkCriticalSectionSyncByMutexInParallel</span></span></span></span></span><span data-slate-object="text" data-key="18534"><span data-slate-leaf="true" data-offset-key="18534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18535"><span data-slate-leaf="true" data-offset-key="18535:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18536"><span data-slate-object="text" data-key="18537"><span data-slate-leaf="true" data-offset-key="18537:0" data-first-offset="true"><span data-slate-string="true">    b.RunParallel(</span></span></span><span data-slate-object="text" data-key="18538"><span data-slate-leaf="true" data-offset-key="18538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18539"><span data-slate-leaf="true" data-offset-key="18539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="18540"><span data-slate-leaf="true" data-offset-key="18540:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18541"><span data-slate-object="text" data-key="18542"><span data-slate-leaf="true" data-offset-key="18542:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18543"><span data-slate-leaf="true" data-offset-key="18543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18544"><span data-slate-leaf="true" data-offset-key="18544:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18545"><span data-slate-object="text" data-key="18546"><span data-slate-leaf="true" data-offset-key="18546:0" data-first-offset="true"><span data-slate-string="true">            criticalSectionSyncByMutex()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18547"><span data-slate-object="text" data-key="18548"><span data-slate-leaf="true" data-offset-key="18548:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18549"><span data-slate-object="text" data-key="18550"><span data-slate-leaf="true" data-offset-key="18550:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18551"><span data-slate-object="text" data-key="18552"><span data-slate-leaf="true" data-offset-key="18552:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18553"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18554"><span data-slate-object="text" data-key="18555"><span data-slate-leaf="true" data-offset-key="18555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18556"><span data-slate-leaf="true" data-offset-key="18556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18557"><span data-slate-leaf="true" data-offset-key="18557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkCriticalSectionSyncByChan</span></span></span></span></span><span data-slate-object="text" data-key="18558"><span data-slate-leaf="true" data-offset-key="18558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18559"><span data-slate-leaf="true" data-offset-key="18559:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18560"><span data-slate-object="text" data-key="18561"><span data-slate-leaf="true" data-offset-key="18561:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18562"><span data-slate-leaf="true" data-offset-key="18562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18563"><span data-slate-leaf="true" data-offset-key="18563:0" data-first-offset="true"><span data-slate-string="true"> n := </span></span></span><span data-slate-object="text" data-key="18564"><span data-slate-leaf="true" data-offset-key="18564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18565"><span data-slate-leaf="true" data-offset-key="18565:0" data-first-offset="true"><span data-slate-string="true">; n &lt; b.N; n++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18566"><span data-slate-object="text" data-key="18567"><span data-slate-leaf="true" data-offset-key="18567:0" data-first-offset="true"><span data-slate-string="true">        criticalSectionSyncByChan()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18568"><span data-slate-object="text" data-key="18569"><span data-slate-leaf="true" data-offset-key="18569:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18570"><span data-slate-object="text" data-key="18571"><span data-slate-leaf="true" data-offset-key="18571:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18572"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18573"><span data-slate-object="text" data-key="18574"><span data-slate-leaf="true" data-offset-key="18574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18575"><span data-slate-leaf="true" data-offset-key="18575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18576"><span data-slate-leaf="true" data-offset-key="18576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkCriticalSectionSyncByChanInParallel</span></span></span></span></span><span data-slate-object="text" data-key="18577"><span data-slate-leaf="true" data-offset-key="18577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18578"><span data-slate-leaf="true" data-offset-key="18578:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18579"><span data-slate-object="text" data-key="18580"><span data-slate-leaf="true" data-offset-key="18580:0" data-first-offset="true"><span data-slate-string="true">    b.RunParallel(</span></span></span><span data-slate-object="text" data-key="18581"><span data-slate-leaf="true" data-offset-key="18581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18582"><span data-slate-leaf="true" data-offset-key="18582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="18583"><span data-slate-leaf="true" data-offset-key="18583:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18584"><span data-slate-object="text" data-key="18585"><span data-slate-leaf="true" data-offset-key="18585:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18586"><span data-slate-leaf="true" data-offset-key="18586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18587"><span data-slate-leaf="true" data-offset-key="18587:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18588"><span data-slate-object="text" data-key="18589"><span data-slate-leaf="true" data-offset-key="18589:0" data-first-offset="true"><span data-slate-string="true">            criticalSectionSyncByChan()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18590"><span data-slate-object="text" data-key="18591"><span data-slate-leaf="true" data-offset-key="18591:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18592"><span data-slate-object="text" data-key="18593"><span data-slate-leaf="true" data-offset-key="18593:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18594"><span data-slate-object="text" data-key="18595"><span data-slate-leaf="true" data-offset-key="18595:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18596"><span data-slate-object="text" data-key="18597"><span data-slate-leaf="true" data-offset-key="18597:0" data-first-offset="true"><span data-slate-string="true">运行这个对比测试（Go 1.17），我们得到：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="18598"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18599"><span data-slate-object="text" data-key="18600"><span data-slate-leaf="true" data-offset-key="18600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="18601"><span data-slate-leaf="true" data-offset-key="18601:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18602"><span data-slate-leaf="true" data-offset-key="18602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="18603"><span data-slate-leaf="true" data-offset-key="18603:0" data-first-offset="true"><span data-slate-string="true"> -bench .</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18604"><span data-slate-object="text" data-key="18605"><span data-slate-leaf="true" data-offset-key="18605:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18606"><span data-slate-object="text" data-key="18607"><span data-slate-leaf="true" data-offset-key="18607:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18608"><span data-slate-object="text" data-key="18609"><span data-slate-leaf="true" data-offset-key="18609:0" data-first-offset="true"><span data-slate-string="true">... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18610"><span data-slate-object="text" data-key="18611"><span data-slate-leaf="true" data-offset-key="18611:0" data-first-offset="true"><span data-slate-string="true">BenchmarkCriticalSectionSyncByMutex-8               88083549          13.64 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18612"><span data-slate-object="text" data-key="18613"><span data-slate-leaf="true" data-offset-key="18613:0" data-first-offset="true"><span data-slate-string="true">BenchmarkCriticalSectionSyncByMutexInParallel-8     22337848          55.29 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18614"><span data-slate-object="text" data-key="18615"><span data-slate-leaf="true" data-offset-key="18615:0" data-first-offset="true"><span data-slate-string="true">BenchmarkCriticalSectionSyncByChan-8                28172056          42.48 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18616"><span data-slate-object="text" data-key="18617"><span data-slate-leaf="true" data-offset-key="18617:0" data-first-offset="true"><span data-slate-string="true">BenchmarkCriticalSectionSyncByChanInParallel-8       5722972         208.1 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18618"><span data-slate-object="text" data-key="18619"><span data-slate-leaf="true" data-offset-key="18619:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18620"><span data-slate-object="text" data-key="18621"><span data-slate-leaf="true" data-offset-key="18621:0" data-first-offset="true"><span data-slate-string="true">通过这个对比实验，我们可以看到，无论是在单 Goroutine 情况下，还是在并发测试情况下，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18622"><span data-slate-object="text" data-key="18623"><span data-slate-leaf="true" data-offset-key="18623:0" data-first-offset="true"><span data-slate-string="true">sync.Mutex</span></span></span></span><span data-slate-object="text" data-key="18624"><span data-slate-leaf="true" data-offset-key="18624:0" data-first-offset="true"><span data-slate-string="true"> 实现的同步机制的性能，都要比 channel 实现的高出三倍多。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18625"><span data-slate-object="text" data-key="18626"><span data-slate-leaf="true" data-offset-key="18626:0" data-first-offset="true"><span data-slate-string="true">因此，</span></span><span data-slate-leaf="true" data-offset-key="18626:1"><span data-slate-object="annotation" data-annotation-key="gkann_1f3bbf19" data-attr-id="43630" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">通常在需要高性能的临界区（critical section）同步机制的情况下，</span></span></span><span data-slate-leaf="true" data-offset-key="18626:2"><span data-slate-string="true">sync 包提供的低级同步原语更为适合。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18627"><span data-slate-object="text" data-key="18628"><span data-slate-leaf="true" data-offset-key="18628:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第二种就是在不想转移结构体对象所有权，但又要保证结构体内部状态数据的同步访问的场景。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18629"><span data-slate-object="text" data-key="18630"><span data-slate-leaf="true" data-offset-key="18630:0" data-first-offset="true"><span data-slate-string="true">基于 channel 的并发设计，有一个特点：在 Goroutine 间通过 channel 转移数据对象的所有权。所以，只有拥有数据对象所有权（从 channel 接收到该数据）的 Goroutine 才可以对该数据对象进行状态变更。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18631"><span data-slate-object="text" data-key="18632"><span data-slate-leaf="true" data-offset-key="18632:0" data-first-offset="true"><span data-slate-string="true">如果你的设计中没有转移结构体对象所有权，但又要保证结构体内部状态数据在多个 Goroutine 之间同步访问，那么你可以使用 sync 包提供的低级同步原语来实现，比如最常用的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18633"><span data-slate-object="text" data-key="18634"><span data-slate-leaf="true" data-offset-key="18634:0" data-first-offset="true"><span data-slate-string="true"> sync.Mutex</span></span></span></span><span data-slate-object="text" data-key="18635"><span data-slate-leaf="true" data-offset-key="18635:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18636"><span data-slate-object="text" data-key="18637"><span data-slate-leaf="true" data-offset-key="18637:0" data-first-offset="true"><span data-slate-string="true">了解了这些应用场景之后，接着我们就来看看如何使用 sync 包中的各个同步结构，不过在使用之前，我们需要先看看一个 sync 包中同步原语使用的注意事项。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18638" id="sr-toc-2"><span data-slate-object="text" data-key="18639"><span data-slate-leaf="true" data-offset-key="18639:0" data-first-offset="true"><span data-slate-string="true">sync 包中同步原语使用的注意事项</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18640"><span data-slate-object="text" data-key="18641"><span data-slate-leaf="true" data-offset-key="18641:0" data-first-offset="true"><span data-slate-string="true">在 sync 包的注释中（在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18642"><span data-slate-object="text" data-key="18643"><span data-slate-leaf="true" data-offset-key="18643:0" data-first-offset="true"><span data-slate-string="true"> $GOROOT/src/sync/mutex.go</span></span></span></span><span data-slate-object="text" data-key="18644"><span data-slate-leaf="true" data-offset-key="18644:0" data-first-offset="true"><span data-slate-string="true"> 文件的头部注释），我们看到这样一行说明：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="18645"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18646"><span data-slate-object="text" data-key="18647"><span data-slate-leaf="true" data-offset-key="18647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Values containing the types defined in this package should not be copied.</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18648"><span data-slate-object="text" data-key="18649"><span data-slate-leaf="true" data-offset-key="18649:0" data-first-offset="true"><span data-slate-string="true">翻译过来就是：“不应复制那些包含了此包中类型的值”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18650"><span data-slate-object="text" data-key="18651"><span data-slate-leaf="true" data-offset-key="18651:0" data-first-offset="true"><span data-slate-string="true">在 sync 包的其他源文件中，我们同样看到类似的一些注释：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="18652"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18653"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18654"><span data-slate-object="text" data-key="18655"><span data-slate-leaf="true" data-offset-key="18655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/sync/mutex.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18656"><span data-slate-object="text" data-key="18657"><span data-slate-leaf="true" data-offset-key="18657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// A Mutex must not be copied after first use. （禁止复制首次使用后的 Mutex）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18658"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18659"><span data-slate-object="text" data-key="18660"><span data-slate-leaf="true" data-offset-key="18660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/sync/rwmutex.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18661"><span data-slate-object="text" data-key="18662"><span data-slate-leaf="true" data-offset-key="18662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// A RWMutex must not be copied after first use.（禁止复制首次使用后的 RWMutex）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18663"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18664"><span data-slate-object="text" data-key="18665"><span data-slate-leaf="true" data-offset-key="18665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/sync/cond.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18666"><span data-slate-object="text" data-key="18667"><span data-slate-leaf="true" data-offset-key="18667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// A Cond must not be copied after first use.（禁止复制首次使用后的 Cond）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18668"><span data-slate-object="text" data-key="18669"><span data-slate-leaf="true" data-offset-key="18669:0" data-first-offset="true"><span data-slate-string="true">... ...</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18670"><span data-slate-object="text" data-key="18671"><span data-slate-leaf="true" data-offset-key="18671:0" data-first-offset="true"><span data-slate-string="true">那么，为什么首次使用 Mutex 等 sync 包中定义的结构类型后，我们不应该再对它们进行复制操作呢？我们以 Mutex 这个同步原语为例，看看它的实现是怎样的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18672"><span data-slate-object="text" data-key="18673"><span data-slate-leaf="true" data-offset-key="18673:0" data-first-offset="true"><span data-slate-string="true">Go 标准库中 sync.Mutex 的定义是这样的：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18674"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18675"><span data-slate-object="text" data-key="18676"><span data-slate-leaf="true" data-offset-key="18676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/sync/mutex.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18677"><span data-slate-object="text" data-key="18678"><span data-slate-leaf="true" data-offset-key="18678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="18679"><span data-slate-leaf="true" data-offset-key="18679:0" data-first-offset="true"><span data-slate-string="true"> Mutex </span></span></span><span data-slate-object="text" data-key="18680"><span data-slate-leaf="true" data-offset-key="18680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="18681"><span data-slate-leaf="true" data-offset-key="18681:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18682"><span data-slate-object="text" data-key="18683"><span data-slate-leaf="true" data-offset-key="18683:0" data-first-offset="true"><span data-slate-string="true">    state </span></span></span><span data-slate-object="text" data-key="18684"><span data-slate-leaf="true" data-offset-key="18684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int32</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18685"><span data-slate-object="text" data-key="18686"><span data-slate-leaf="true" data-offset-key="18686:0" data-first-offset="true"><span data-slate-string="true">    sema  </span></span></span><span data-slate-object="text" data-key="18687"><span data-slate-leaf="true" data-offset-key="18687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint32</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18688"><span data-slate-object="text" data-key="18689"><span data-slate-leaf="true" data-offset-key="18689:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18690"><span data-slate-object="text" data-key="18691"><span data-slate-leaf="true" data-offset-key="18691:0" data-first-offset="true"><span data-slate-string="true">我们看到，Mutex 的定义非常简单，由两个整型字段 state 和 sema 组成：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18692"><div data-slate-type="list-line" data-slate-object="block" data-key="18693"><span data-slate-object="text" data-key="18694"><span data-slate-leaf="true" data-offset-key="18694:0" data-first-offset="true"><span data-slate-string="true">state：表示当前互斥锁的状态；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18695"><span data-slate-object="text" data-key="18696"><span data-slate-leaf="true" data-offset-key="18696:0" data-first-offset="true"><span data-slate-string="true">sema：用于控制锁状态的信号量。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18697"><span data-slate-object="text" data-key="18698"><span data-slate-leaf="true" data-offset-key="18698:0" data-first-offset="true"><span data-slate-string="true">初始情况下，Mutex 的实例处于 </span></span></span><span data-slate-object="text" data-key="18699"><span data-slate-leaf="true" data-offset-key="18699:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Unlocked</span></span></span></span><span data-slate-object="text" data-key="18700"><span data-slate-leaf="true" data-offset-key="18700:0" data-first-offset="true"><span data-slate-string="true"> 状态（state 和 sema 均为 0）。对 Mutex 实例的复制也就是两个整型字段的复制。一旦发生复制，原变量与副本就是两个单独的内存块，各自发挥同步作用，互相就没有了关联。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18701"><span data-slate-object="text" data-key="18702"><span data-slate-leaf="true" data-offset-key="18702:0" data-first-offset="true"><span data-slate-string="true">如果发生复制后，你仍然认为原变量与副本保护的是同一个数据对象，那可就大错特错了。我们来看一个例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18703"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18704"><span data-slate-object="text" data-key="18705"><span data-slate-leaf="true" data-offset-key="18705:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18706"><span data-slate-leaf="true" data-offset-key="18706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18707"><span data-slate-leaf="true" data-offset-key="18707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18708"><span data-slate-leaf="true" data-offset-key="18708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="18709"><span data-slate-leaf="true" data-offset-key="18709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="18710"><span data-slate-leaf="true" data-offset-key="18710:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18711"><span data-slate-object="text" data-key="18712"><span data-slate-leaf="true" data-offset-key="18712:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="18713"><span data-slate-leaf="true" data-offset-key="18713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18714"><span data-slate-leaf="true" data-offset-key="18714:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18715"><span data-slate-object="text" data-key="18716"><span data-slate-leaf="true" data-offset-key="18716:0" data-first-offset="true"><span data-slate-string="true">     i := </span></span></span><span data-slate-object="text" data-key="18717"><span data-slate-leaf="true" data-offset-key="18717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18718"><span data-slate-object="text" data-key="18719"><span data-slate-leaf="true" data-offset-key="18719:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="18720"><span data-slate-leaf="true" data-offset-key="18720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18721"><span data-slate-leaf="true" data-offset-key="18721:0" data-first-offset="true"><span data-slate-string="true"> mu sync.Mutex </span></span></span><span data-slate-object="text" data-key="18722"><span data-slate-leaf="true" data-offset-key="18722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 负责对 i 的同步访问</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18723"><span data-slate-object="text" data-key="18724"><span data-slate-leaf="true" data-offset-key="18724:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18725"><span data-slate-object="text" data-key="18726"><span data-slate-leaf="true" data-offset-key="18726:0" data-first-offset="true"><span data-slate-string="true">     wg.Add(</span></span></span><span data-slate-object="text" data-key="18727"><span data-slate-leaf="true" data-offset-key="18727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="18728"><span data-slate-leaf="true" data-offset-key="18728:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18729"><span data-slate-object="text" data-key="18730"><span data-slate-leaf="true" data-offset-key="18730:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="18731"><span data-slate-leaf="true" data-offset-key="18731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// g1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18732"><span data-slate-object="text" data-key="18733"><span data-slate-leaf="true" data-offset-key="18733:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="18734"><span data-slate-leaf="true" data-offset-key="18734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="18735"><span data-slate-leaf="true" data-offset-key="18735:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18736"><span data-slate-leaf="true" data-offset-key="18736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18737"><span data-slate-leaf="true" data-offset-key="18737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mu1 sync.Mutex)</span></span></span></span></span><span data-slate-object="text" data-key="18738"><span data-slate-leaf="true" data-offset-key="18738:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18739"><span data-slate-object="text" data-key="18740"><span data-slate-leaf="true" data-offset-key="18740:0" data-first-offset="true"><span data-slate-string="true">         mu1.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18741"><span data-slate-object="text" data-key="18742"><span data-slate-leaf="true" data-offset-key="18742:0" data-first-offset="true"><span data-slate-string="true">         i = </span></span></span><span data-slate-object="text" data-key="18743"><span data-slate-leaf="true" data-offset-key="18743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18744"><span data-slate-object="text" data-key="18745"><span data-slate-leaf="true" data-offset-key="18745:0" data-first-offset="true"><span data-slate-string="true">         time.Sleep(</span></span></span><span data-slate-object="text" data-key="18746"><span data-slate-leaf="true" data-offset-key="18746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="18747"><span data-slate-leaf="true" data-offset-key="18747:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18748"><span data-slate-object="text" data-key="18749"><span data-slate-leaf="true" data-offset-key="18749:0" data-first-offset="true"><span data-slate-string="true">         fmt.Printf(</span></span></span><span data-slate-object="text" data-key="18750"><span data-slate-leaf="true" data-offset-key="18750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g1: i = %d\n"</span></span></span></span><span data-slate-object="text" data-key="18751"><span data-slate-leaf="true" data-offset-key="18751:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18752"><span data-slate-object="text" data-key="18753"><span data-slate-leaf="true" data-offset-key="18753:0" data-first-offset="true"><span data-slate-string="true">         mu1.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18754"><span data-slate-object="text" data-key="18755"><span data-slate-leaf="true" data-offset-key="18755:0" data-first-offset="true"><span data-slate-string="true">         wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18756"><span data-slate-object="text" data-key="18757"><span data-slate-leaf="true" data-offset-key="18757:0" data-first-offset="true"><span data-slate-string="true">     }(mu)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18758"><span data-slate-object="text" data-key="18759"><span data-slate-leaf="true" data-offset-key="18759:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18760"><span data-slate-object="text" data-key="18761"><span data-slate-leaf="true" data-offset-key="18761:0" data-first-offset="true"><span data-slate-string="true">     time.Sleep(time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18762"><span data-slate-object="text" data-key="18763"><span data-slate-leaf="true" data-offset-key="18763:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18764"><span data-slate-object="text" data-key="18765"><span data-slate-leaf="true" data-offset-key="18765:0" data-first-offset="true"><span data-slate-string="true">     mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18766"><span data-slate-object="text" data-key="18767"><span data-slate-leaf="true" data-offset-key="18767:0" data-first-offset="true"><span data-slate-string="true">     i = </span></span></span><span data-slate-object="text" data-key="18768"><span data-slate-leaf="true" data-offset-key="18768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18769"><span data-slate-object="text" data-key="18770"><span data-slate-leaf="true" data-offset-key="18770:0" data-first-offset="true"><span data-slate-string="true">     fmt.Printf(</span></span></span><span data-slate-object="text" data-key="18771"><span data-slate-leaf="true" data-offset-key="18771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g0: i = %d\n"</span></span></span></span><span data-slate-object="text" data-key="18772"><span data-slate-leaf="true" data-offset-key="18772:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18773"><span data-slate-object="text" data-key="18774"><span data-slate-leaf="true" data-offset-key="18774:0" data-first-offset="true"><span data-slate-string="true">     mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18775"><span data-slate-object="text" data-key="18776"><span data-slate-leaf="true" data-offset-key="18776:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18777"><span data-slate-object="text" data-key="18778"><span data-slate-leaf="true" data-offset-key="18778:0" data-first-offset="true"><span data-slate-string="true">     wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18779"><span data-slate-object="text" data-key="18780"><span data-slate-leaf="true" data-offset-key="18780:0" data-first-offset="true"><span data-slate-string="true"> }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18781"><span data-slate-object="text" data-key="18782"><span data-slate-leaf="true" data-offset-key="18782:0" data-first-offset="true"><span data-slate-string="true">在这个例子中，我们使用一个 sync.Mutex 类型变量 mu 来同步对整型变量 i 的访问。我们创建一个新 Goroutine：g1，g1 通过函数参数得到 mu 的一份拷贝 mu1，然后 g1 会通过 mu1 来同步对整型变量 i 的访问。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18783"><span data-slate-object="text" data-key="18784"><span data-slate-leaf="true" data-offset-key="18784:0" data-first-offset="true"><span data-slate-string="true">那么，g0 通过 mu 和 g1 通过 mu 的拷贝 mu1，是否能实现对同一个变量 i 的同步访问呢？我们来看看运行这个示例的运行结果：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="18785"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18786"><span data-slate-object="text" data-key="18787"><span data-slate-leaf="true" data-offset-key="18787:0" data-first-offset="true"><span data-slate-string="true">g0: i = 1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18788"><span data-slate-object="text" data-key="18789"><span data-slate-leaf="true" data-offset-key="18789:0" data-first-offset="true"><span data-slate-string="true">g1: i = 1</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18790"><span data-slate-object="text" data-key="18791"><span data-slate-leaf="true" data-offset-key="18791:0" data-first-offset="true"><span data-slate-string="true">从结果来看，这个程序并没有实现对 i 的同步访问，第 9 行 g1 对 mu1 的加锁操作，并没能阻塞第 19 行 g0 对 mu 的加锁。于是，g1 刚刚将 i 赋值为 10 后，g0 就又将 i 赋值为 1 了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18792"><span data-slate-object="text" data-key="18793"><span data-slate-leaf="true" data-offset-key="18793:0" data-first-offset="true"><span data-slate-string="true">出现这种结果的原因就是我们前面分析的情况，一旦 Mutex 类型变量被拷贝，原变量与副本就各自发挥作用，互相没有关联了。</span></span><span data-slate-leaf="true" data-offset-key="18793:1"><span data-slate-object="annotation" data-annotation-key="gkann_4d322965" data-attr-id="42490" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">甚至，如果拷贝的时机不对，比如在一个 mutex 处于 locked 的状态时对它进行了拷贝，就会对副本进行加锁操作，将导致加锁的 Goroutine 永远阻塞下去。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18794"><span data-slate-object="text" data-key="18795"><span data-slate-leaf="true" data-offset-key="18795:0" data-first-offset="true"><span data-slate-string="true">通过前面这个例子，我们可以很直观地看到：如果对使用过的、sync 包中的类型的示例进行复制，并使用了复制后得到的副本，将导致不可预期的结果。所以，在使用 sync 包中的类型的时候，</span></span><span data-slate-leaf="true" data-offset-key="18795:1"><span data-slate-object="annotation" data-annotation-key="gkann_934d202e" data-attr-id="33866" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们推荐通过</span></span></span></span><span data-slate-object="text" data-key="18796"><span data-slate-leaf="true" data-offset-key="18796:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_934d202e" data-attr-id="33866" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">闭包</span></span></span></span></span><span data-slate-object="text" data-key="18797"><span data-slate-leaf="true" data-offset-key="18797:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_934d202e" data-attr-id="33866" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">方式，或者是</span></span></span></span><span data-slate-object="text" data-key="18798"><span data-slate-leaf="true" data-offset-key="18798:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_934d202e" data-attr-id="33866" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">传递类型实例（或包裹该类型的类型实例）的地址（指针）</span></span></span></span></span><span data-slate-object="text" data-key="18799"><span data-slate-leaf="true" data-offset-key="18799:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_934d202e" data-attr-id="33866" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">的方式进行。</span></span></span><span data-slate-leaf="true" data-offset-key="18799:1"><span data-slate-string="true">这就是使用 sync 包时最值得我们注意的事项。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18800"><span data-slate-object="text" data-key="18801"><span data-slate-leaf="true" data-offset-key="18801:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就来逐个分析日常使用较多的 sync 包中同步原语。我们先来看看互斥锁与读写锁。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18802" id="sr-toc-3"><span data-slate-object="text" data-key="18803"><span data-slate-leaf="true" data-offset-key="18803:0" data-first-offset="true"><span data-slate-string="true">互斥锁（Mutex）还是读写锁（RWMutex）？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18804"><span data-slate-object="text" data-key="18805"><span data-slate-leaf="true" data-offset-key="18805:0" data-first-offset="true"><span data-slate-string="true">sync 包提供了两种用于临界区同步的原语：互斥锁（Mutex）和读写锁（RWMutex）。它们都是零值可用的数据类型，也就是不需要显式初始化就可以使用，并且使用方法都比较简单。在上面的示例中，我们已经看到了 Mutex 的应用方法，这里再总结一下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="18806"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18807"><span data-slate-object="text" data-key="18808"><span data-slate-leaf="true" data-offset-key="18808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18809"><span data-slate-leaf="true" data-offset-key="18809:0" data-first-offset="true"><span data-slate-string="true"> mu </span></span></span><span data-slate-object="text" data-key="18810"><span data-slate-leaf="true" data-offset-key="18810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sync</span></span></span></span><span data-slate-object="text" data-key="18811"><span data-slate-leaf="true" data-offset-key="18811:0" data-first-offset="true"><span data-slate-string="true">.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18812"><span data-slate-object="text" data-key="18813"><span data-slate-leaf="true" data-offset-key="18813:0" data-first-offset="true"><span data-slate-string="true">mu.Lock()   </span></span></span><span data-slate-object="text" data-key="18814"><span data-slate-leaf="true" data-offset-key="18814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18815"><span data-slate-object="text" data-key="18816"><span data-slate-leaf="true" data-offset-key="18816:0" data-first-offset="true"><span data-slate-string="true">doSomething()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18817"><span data-slate-object="text" data-key="18818"><span data-slate-leaf="true" data-offset-key="18818:0" data-first-offset="true"><span data-slate-string="true">mu.Unlock() </span></span></span><span data-slate-object="text" data-key="18819"><span data-slate-leaf="true" data-offset-key="18819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18820"><span data-slate-object="text" data-key="18821"><span data-slate-leaf="true" data-offset-key="18821:0" data-first-offset="true"><span data-slate-string="true">一旦某个 Goroutine 调用的 Mutex 执行 Lock 操作成功，它将成功持有这把互斥锁。这个时候，如果有其他 Goroutine 执行 Lock 操作，就会阻塞在这把互斥锁上，直到持有这把锁的 Goroutine 调用 Unlock 释放掉这把锁后，才会抢到这把锁的持有权并进入临界区。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18822"><span data-slate-object="text" data-key="18823"><span data-slate-leaf="true" data-offset-key="18823:0" data-first-offset="true"><span data-slate-string="true">由此，我们也可以得到使用互斥锁的两个原则：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18824"><div data-slate-type="list-line" data-slate-object="block" data-key="18825"><span data-slate-object="text" data-key="18826"><span data-slate-leaf="true" data-offset-key="18826:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">尽量减少在锁中的操作</span></span></span></span><span data-slate-object="text" data-key="18827"><span data-slate-leaf="true" data-offset-key="18827:0" data-first-offset="true"><span data-slate-string="true">。这可以减少其他因 Goroutine 阻塞而带来的损耗与延迟。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18828"><span data-slate-object="text" data-key="18829"><span data-slate-leaf="true" data-offset-key="18829:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一定要记得调用 Unlock 解锁</span></span></span></span><span data-slate-object="text" data-key="18830"><span data-slate-leaf="true" data-offset-key="18830:0" data-first-offset="true"><span data-slate-string="true">。忘记解锁会导致程序局部死锁，甚至是整个程序死锁，会导致严重的后果。同时，我们也可以结合第 23 讲学习到的 defer，优雅地执行解锁操作。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18831"><span data-slate-object="text" data-key="18832"><span data-slate-leaf="true" data-offset-key="18832:0" data-first-offset="true"><span data-slate-string="true">读写锁与互斥锁用法大致相同，只不过多了一组加读锁和解读锁的方法：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="18833"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18834"><span data-slate-object="text" data-key="18835"><span data-slate-leaf="true" data-offset-key="18835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18836"><span data-slate-leaf="true" data-offset-key="18836:0" data-first-offset="true"><span data-slate-string="true"> rwmu </span></span></span><span data-slate-object="text" data-key="18837"><span data-slate-leaf="true" data-offset-key="18837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sync</span></span></span></span><span data-slate-object="text" data-key="18838"><span data-slate-leaf="true" data-offset-key="18838:0" data-first-offset="true"><span data-slate-string="true">.RWMutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18839"><span data-slate-object="text" data-key="18840"><span data-slate-leaf="true" data-offset-key="18840:0" data-first-offset="true"><span data-slate-string="true">rwmu.RLock()   </span></span></span><span data-slate-object="text" data-key="18841"><span data-slate-leaf="true" data-offset-key="18841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加读锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18842"><span data-slate-object="text" data-key="18843"><span data-slate-leaf="true" data-offset-key="18843:0" data-first-offset="true"><span data-slate-string="true">readSomething()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18844"><span data-slate-object="text" data-key="18845"><span data-slate-leaf="true" data-offset-key="18845:0" data-first-offset="true"><span data-slate-string="true">rwmu.RUnlock() </span></span></span><span data-slate-object="text" data-key="18846"><span data-slate-leaf="true" data-offset-key="18846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解读锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18847"><span data-slate-object="text" data-key="18848"><span data-slate-leaf="true" data-offset-key="18848:0" data-first-offset="true"><span data-slate-string="true">rwmu.Lock()    </span></span></span><span data-slate-object="text" data-key="18849"><span data-slate-leaf="true" data-offset-key="18849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加写锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18850"><span data-slate-object="text" data-key="18851"><span data-slate-leaf="true" data-offset-key="18851:0" data-first-offset="true"><span data-slate-string="true">changeSomething()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18852"><span data-slate-object="text" data-key="18853"><span data-slate-leaf="true" data-offset-key="18853:0" data-first-offset="true"><span data-slate-string="true">rwmu.Unlock()  </span></span></span><span data-slate-object="text" data-key="18854"><span data-slate-leaf="true" data-offset-key="18854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解写锁</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18855"><span data-slate-object="text" data-key="18856"><span data-slate-leaf="true" data-offset-key="18856:0" data-first-offset="true"><span data-slate-string="true">写锁与 Mutex 的行为十分类似，一旦某 Goroutine 持有写锁，其他 Goroutine 无论是尝试加读锁，还是加写锁，都会被阻塞在写锁上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18857"><span data-slate-object="text" data-key="18858"><span data-slate-leaf="true" data-offset-key="18858:0" data-first-offset="true"><span data-slate-string="true">但读锁就宽松多了，一旦某个 Goroutine 持有读锁，它不会阻塞其他尝试加读锁的 Goroutine，但加写锁的 Goroutine 依然会被阻塞住。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18859"><span data-slate-object="text" data-key="18860"><span data-slate-leaf="true" data-offset-key="18860:0" data-first-offset="true"><span data-slate-string="true">通常，</span></span></span><span data-slate-object="text" data-key="18861"><span data-slate-leaf="true" data-offset-key="18861:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">互斥锁（Mutex）是临时区同步原语的首选</span></span></span></span><span data-slate-object="text" data-key="18862"><span data-slate-leaf="true" data-offset-key="18862:0" data-first-offset="true"><span data-slate-string="true">，它常被用来对结构体对象的内部状态、缓存等进行保护，是使用最为广泛的临界区同步原语。相比之下，读写锁的应用就没那么广泛了，只活跃于它擅长的场景下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18863"><span data-slate-object="text" data-key="18864"><span data-slate-leaf="true" data-offset-key="18864:0" data-first-offset="true"><span data-slate-string="true">那读写锁（RWMutex）究竟擅长在哪种场景下呢？我们先来看一组基准测试：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18865"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18866"><span data-slate-object="text" data-key="18867"><span data-slate-leaf="true" data-offset-key="18867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18868"><span data-slate-leaf="true" data-offset-key="18868:0" data-first-offset="true"><span data-slate-string="true"> cs1 = </span></span></span><span data-slate-object="text" data-key="18869"><span data-slate-leaf="true" data-offset-key="18869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18870"><span data-slate-leaf="true" data-offset-key="18870:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18871"><span data-slate-leaf="true" data-offset-key="18871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 模拟临界区要保护的数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18872"><span data-slate-object="text" data-key="18873"><span data-slate-leaf="true" data-offset-key="18873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18874"><span data-slate-leaf="true" data-offset-key="18874:0" data-first-offset="true"><span data-slate-string="true"> mu1 sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18875"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18876"><span data-slate-object="text" data-key="18877"><span data-slate-leaf="true" data-offset-key="18877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18878"><span data-slate-leaf="true" data-offset-key="18878:0" data-first-offset="true"><span data-slate-string="true"> cs2 = </span></span></span><span data-slate-object="text" data-key="18879"><span data-slate-leaf="true" data-offset-key="18879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18880"><span data-slate-leaf="true" data-offset-key="18880:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18881"><span data-slate-leaf="true" data-offset-key="18881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 模拟临界区要保护的数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18882"><span data-slate-object="text" data-key="18883"><span data-slate-leaf="true" data-offset-key="18883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="18884"><span data-slate-leaf="true" data-offset-key="18884:0" data-first-offset="true"><span data-slate-string="true"> mu2 sync.RWMutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18885"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18886"><span data-slate-object="text" data-key="18887"><span data-slate-leaf="true" data-offset-key="18887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18888"><span data-slate-leaf="true" data-offset-key="18888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18889"><span data-slate-leaf="true" data-offset-key="18889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkWriteSyncByMutex</span></span></span></span></span><span data-slate-object="text" data-key="18890"><span data-slate-leaf="true" data-offset-key="18890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18891"><span data-slate-leaf="true" data-offset-key="18891:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18892"><span data-slate-object="text" data-key="18893"><span data-slate-leaf="true" data-offset-key="18893:0" data-first-offset="true"><span data-slate-string="true">    b.RunParallel(</span></span></span><span data-slate-object="text" data-key="18894"><span data-slate-leaf="true" data-offset-key="18894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18895"><span data-slate-leaf="true" data-offset-key="18895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="18896"><span data-slate-leaf="true" data-offset-key="18896:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18897"><span data-slate-object="text" data-key="18898"><span data-slate-leaf="true" data-offset-key="18898:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18899"><span data-slate-leaf="true" data-offset-key="18899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18900"><span data-slate-leaf="true" data-offset-key="18900:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18901"><span data-slate-object="text" data-key="18902"><span data-slate-leaf="true" data-offset-key="18902:0" data-first-offset="true"><span data-slate-string="true">            mu1.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18903"><span data-slate-object="text" data-key="18904"><span data-slate-leaf="true" data-offset-key="18904:0" data-first-offset="true"><span data-slate-string="true">            cs1++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18905"><span data-slate-object="text" data-key="18906"><span data-slate-leaf="true" data-offset-key="18906:0" data-first-offset="true"><span data-slate-string="true">            mu1.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18907"><span data-slate-object="text" data-key="18908"><span data-slate-leaf="true" data-offset-key="18908:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18909"><span data-slate-object="text" data-key="18910"><span data-slate-leaf="true" data-offset-key="18910:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18911"><span data-slate-object="text" data-key="18912"><span data-slate-leaf="true" data-offset-key="18912:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18913"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18914"><span data-slate-object="text" data-key="18915"><span data-slate-leaf="true" data-offset-key="18915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18916"><span data-slate-leaf="true" data-offset-key="18916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18917"><span data-slate-leaf="true" data-offset-key="18917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkReadSyncByMutex</span></span></span></span></span><span data-slate-object="text" data-key="18918"><span data-slate-leaf="true" data-offset-key="18918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18919"><span data-slate-leaf="true" data-offset-key="18919:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18920"><span data-slate-object="text" data-key="18921"><span data-slate-leaf="true" data-offset-key="18921:0" data-first-offset="true"><span data-slate-string="true">    b.RunParallel(</span></span></span><span data-slate-object="text" data-key="18922"><span data-slate-leaf="true" data-offset-key="18922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18923"><span data-slate-leaf="true" data-offset-key="18923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="18924"><span data-slate-leaf="true" data-offset-key="18924:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18925"><span data-slate-object="text" data-key="18926"><span data-slate-leaf="true" data-offset-key="18926:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18927"><span data-slate-leaf="true" data-offset-key="18927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18928"><span data-slate-leaf="true" data-offset-key="18928:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18929"><span data-slate-object="text" data-key="18930"><span data-slate-leaf="true" data-offset-key="18930:0" data-first-offset="true"><span data-slate-string="true">            mu1.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18931"><span data-slate-object="text" data-key="18932"><span data-slate-leaf="true" data-offset-key="18932:0" data-first-offset="true"><span data-slate-string="true">            _ = cs1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18933"><span data-slate-object="text" data-key="18934"><span data-slate-leaf="true" data-offset-key="18934:0" data-first-offset="true"><span data-slate-string="true">            mu1.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18935"><span data-slate-object="text" data-key="18936"><span data-slate-leaf="true" data-offset-key="18936:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18937"><span data-slate-object="text" data-key="18938"><span data-slate-leaf="true" data-offset-key="18938:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18939"><span data-slate-object="text" data-key="18940"><span data-slate-leaf="true" data-offset-key="18940:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18941"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18942"><span data-slate-object="text" data-key="18943"><span data-slate-leaf="true" data-offset-key="18943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18944"><span data-slate-leaf="true" data-offset-key="18944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18945"><span data-slate-leaf="true" data-offset-key="18945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkReadSyncByRWMutex</span></span></span></span></span><span data-slate-object="text" data-key="18946"><span data-slate-leaf="true" data-offset-key="18946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18947"><span data-slate-leaf="true" data-offset-key="18947:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18948"><span data-slate-object="text" data-key="18949"><span data-slate-leaf="true" data-offset-key="18949:0" data-first-offset="true"><span data-slate-string="true">    b.RunParallel(</span></span></span><span data-slate-object="text" data-key="18950"><span data-slate-leaf="true" data-offset-key="18950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18951"><span data-slate-leaf="true" data-offset-key="18951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="18952"><span data-slate-leaf="true" data-offset-key="18952:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18953"><span data-slate-object="text" data-key="18954"><span data-slate-leaf="true" data-offset-key="18954:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18955"><span data-slate-leaf="true" data-offset-key="18955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18956"><span data-slate-leaf="true" data-offset-key="18956:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18957"><span data-slate-object="text" data-key="18958"><span data-slate-leaf="true" data-offset-key="18958:0" data-first-offset="true"><span data-slate-string="true">            mu2.RLock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18959"><span data-slate-object="text" data-key="18960"><span data-slate-leaf="true" data-offset-key="18960:0" data-first-offset="true"><span data-slate-string="true">            _ = cs2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18961"><span data-slate-object="text" data-key="18962"><span data-slate-leaf="true" data-offset-key="18962:0" data-first-offset="true"><span data-slate-string="true">            mu2.RUnlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18963"><span data-slate-object="text" data-key="18964"><span data-slate-leaf="true" data-offset-key="18964:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18965"><span data-slate-object="text" data-key="18966"><span data-slate-leaf="true" data-offset-key="18966:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18967"><span data-slate-object="text" data-key="18968"><span data-slate-leaf="true" data-offset-key="18968:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18969"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18970"><span data-slate-object="text" data-key="18971"><span data-slate-leaf="true" data-offset-key="18971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18972"><span data-slate-leaf="true" data-offset-key="18972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18973"><span data-slate-leaf="true" data-offset-key="18973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkWriteSyncByRWMutex</span></span></span></span></span><span data-slate-object="text" data-key="18974"><span data-slate-leaf="true" data-offset-key="18974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="18975"><span data-slate-leaf="true" data-offset-key="18975:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18976"><span data-slate-object="text" data-key="18977"><span data-slate-leaf="true" data-offset-key="18977:0" data-first-offset="true"><span data-slate-string="true">    b.RunParallel(</span></span></span><span data-slate-object="text" data-key="18978"><span data-slate-leaf="true" data-offset-key="18978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18979"><span data-slate-leaf="true" data-offset-key="18979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="18980"><span data-slate-leaf="true" data-offset-key="18980:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18981"><span data-slate-object="text" data-key="18982"><span data-slate-leaf="true" data-offset-key="18982:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18983"><span data-slate-leaf="true" data-offset-key="18983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18984"><span data-slate-leaf="true" data-offset-key="18984:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18985"><span data-slate-object="text" data-key="18986"><span data-slate-leaf="true" data-offset-key="18986:0" data-first-offset="true"><span data-slate-string="true">            mu2.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18987"><span data-slate-object="text" data-key="18988"><span data-slate-leaf="true" data-offset-key="18988:0" data-first-offset="true"><span data-slate-string="true">            cs2++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18989"><span data-slate-object="text" data-key="18990"><span data-slate-leaf="true" data-offset-key="18990:0" data-first-offset="true"><span data-slate-string="true">            mu2.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18991"><span data-slate-object="text" data-key="18992"><span data-slate-leaf="true" data-offset-key="18992:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18993"><span data-slate-object="text" data-key="18994"><span data-slate-leaf="true" data-offset-key="18994:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18995"><span data-slate-object="text" data-key="18996"><span data-slate-leaf="true" data-offset-key="18996:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18997"><span data-slate-object="text" data-key="18998"><span data-slate-leaf="true" data-offset-key="18998:0" data-first-offset="true"><span data-slate-string="true">这些基准测试都是并发测试，度量的是 Mutex、RWMutex 在并发下的读写性能。我们分别在 cpu=2、8、16、32 的情况下运行这个并发性能测试，测试结果如下：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="18999"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19000"><span data-slate-object="text" data-key="19001"><span data-slate-leaf="true" data-offset-key="19001:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19002"><span data-slate-object="text" data-key="19003"><span data-slate-leaf="true" data-offset-key="19003:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19004"><span data-slate-object="text" data-key="19005"><span data-slate-leaf="true" data-offset-key="19005:0" data-first-offset="true"><span data-slate-string="true">... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19006"><span data-slate-object="text" data-key="19007"><span data-slate-leaf="true" data-offset-key="19007:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByMutex-2       73423770          16.12 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19008"><span data-slate-object="text" data-key="19009"><span data-slate-leaf="true" data-offset-key="19009:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByMutex-2        84031135          15.08 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19010"><span data-slate-object="text" data-key="19011"><span data-slate-leaf="true" data-offset-key="19011:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex-2      37182219          31.87 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19012"><span data-slate-object="text" data-key="19013"><span data-slate-leaf="true" data-offset-key="19013:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByRWMutex-2     40727782          29.08 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19014"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19015"><span data-slate-object="text" data-key="19016"><span data-slate-leaf="true" data-offset-key="19016:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByMutex-8       22153354          56.39 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19017"><span data-slate-object="text" data-key="19018"><span data-slate-leaf="true" data-offset-key="19018:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByMutex-8        24164278          51.12 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19019"><span data-slate-object="text" data-key="19020"><span data-slate-leaf="true" data-offset-key="19020:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex-8      38589122          31.17 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19021"><span data-slate-object="text" data-key="19022"><span data-slate-leaf="true" data-offset-key="19022:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByRWMutex-8     18482208          65.27 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19023"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19024"><span data-slate-object="text" data-key="19025"><span data-slate-leaf="true" data-offset-key="19025:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByMutex-16        20672842          62.94 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19026"><span data-slate-object="text" data-key="19027"><span data-slate-leaf="true" data-offset-key="19027:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByMutex-16         19247158          62.94 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19028"><span data-slate-object="text" data-key="19029"><span data-slate-leaf="true" data-offset-key="19029:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex-16       29978614          39.98 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19030"><span data-slate-object="text" data-key="19031"><span data-slate-leaf="true" data-offset-key="19031:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByRWMutex-16      16095952          78.19 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19032"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19033"><span data-slate-object="text" data-key="19034"><span data-slate-leaf="true" data-offset-key="19034:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByMutex-32        20539290          60.20 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19035"><span data-slate-object="text" data-key="19036"><span data-slate-leaf="true" data-offset-key="19036:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByMutex-32         18807060          72.61 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19037"><span data-slate-object="text" data-key="19038"><span data-slate-leaf="true" data-offset-key="19038:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex-32       29772936          40.45 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19039"><span data-slate-object="text" data-key="19040"><span data-slate-leaf="true" data-offset-key="19040:0" data-first-offset="true"><span data-slate-string="true">BenchmarkWriteSyncByRWMutex-32      13320544          86.53 ns/op</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19041"><span data-slate-object="text" data-key="19042"><span data-slate-leaf="true" data-offset-key="19042:0" data-first-offset="true"><span data-slate-string="true">通过测试结果对比，我们得到了一些结论：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="19043"><div data-slate-type="list-line" data-slate-object="block" data-key="19044"><span data-slate-object="text" data-key="19045"><span data-slate-leaf="true" data-offset-key="19045:0" data-first-offset="true"><span data-slate-string="true">并发量较小的情况下，Mutex 性能最好；随着并发量增大，Mutex 的竞争激烈，导致加锁和解锁性能下降；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="19046"><span data-slate-object="text" data-key="19047"><span data-slate-leaf="true" data-offset-key="19047:0" data-first-offset="true"><span data-slate-string="true">RWMutex 的读锁性能并没有随着并发量的增大，而发生较大变化，性能始终恒定在 40ns 左右；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="19048"><span data-slate-object="text" data-key="19049"><span data-slate-leaf="true" data-offset-key="19049:0" data-first-offset="true"><span data-slate-string="true">在并发量较大的情况下，RWMutex 的写锁性能和 Mutex、RWMutex 读锁相比，是最差的，并且随着并发量增大，RWMutex 写锁性能有继续下降趋势。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19050"><span data-slate-object="text" data-key="19051"><span data-slate-leaf="true" data-offset-key="19051:0" data-first-offset="true"><span data-slate-string="true">由此，我们就可以看出，</span></span></span><span data-slate-object="text" data-key="19052"><span data-slate-leaf="true" data-offset-key="19052:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b145a8cb" data-attr-id="41763" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">读写锁适合应用在具有一定并发量且读多写少的场合</span></span></span></span></span><span data-slate-object="text" data-key="19053"><span data-slate-leaf="true" data-offset-key="19053:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b145a8cb" data-attr-id="41763" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span><span data-slate-leaf="true" data-offset-key="19053:1"><span data-slate-string="true">在大量并发读的情况下，多个 Goroutine 可以同时持有读锁，从而减少在锁竞争中等待的时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19054"><span data-slate-object="text" data-key="19055"><span data-slate-leaf="true" data-offset-key="19055:0" data-first-offset="true"><span data-slate-string="true">而互斥锁，即便是读请求的场合，同一时刻也只能有一个 Goroutine 持有锁，其他 Goroutine 只能阻塞在加锁操作上等待被调度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19056"><span data-slate-object="text" data-key="19057"><span data-slate-leaf="true" data-offset-key="19057:0" data-first-offset="true"><span data-slate-string="true">接下来，我们继续看条件变量 sync.Cond。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19058" id="sr-toc-4"><span data-slate-object="text" data-key="19059"><span data-slate-leaf="true" data-offset-key="19059:0" data-first-offset="true"><span data-slate-string="true">条件变量</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19060"><span data-slate-type="code" data-slate-object="inline" data-key="19061"><span data-slate-object="text" data-key="19062"><span data-slate-leaf="true" data-offset-key="19062:0" data-first-offset="true"><span data-slate-string="true">sync.Cond</span></span></span></span><span data-slate-object="text" data-key="19063"><span data-slate-leaf="true" data-offset-key="19063:0" data-first-offset="true"><span data-slate-string="true"> 是传统的条件变量原语概念在 Go 语言中的实现。</span></span><span data-slate-leaf="true" data-offset-key="19063:1"><span data-slate-object="annotation" data-annotation-key="gkann_a5203b25" data-attr-id="39412" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们可以把一个条件变量理解为一个容器，这个容器中存放着一个或一组等待着某个条件成立的 Goroutine。</span></span></span><span data-slate-leaf="true" data-offset-key="19063:2"><span data-slate-string="true">当条件成立后，这些处于等待状态的 Goroutine 将得到通知，并被唤醒继续进行后续的工作。这与百米飞人大战赛场上，各位运动员等待裁判员的发令枪声的情形十分类似。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19064"><span data-slate-object="text" data-key="19065"><span data-slate-leaf="true" data-offset-key="19065:0" data-first-offset="true"><span data-slate-string="true">条件变量是同步原语的一种，如果没有条件变量，开发人员可能需要在 Goroutine 中通过连续轮询的方式，检查某条件是否为真，这种连续轮询非常消耗资源，因为 Goroutine 在这个过程中是处于活动状态的，但它的工作又没有进展。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19066"><span data-slate-object="text" data-key="19067"><span data-slate-leaf="true" data-offset-key="19067:0" data-first-offset="true"><span data-slate-string="true">这里我们先看一个用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19068"><span data-slate-object="text" data-key="19069"><span data-slate-leaf="true" data-offset-key="19069:0" data-first-offset="true"><span data-slate-string="true"> sync.Mutex</span></span></span></span><span data-slate-object="text" data-key="19070"><span data-slate-leaf="true" data-offset-key="19070:0" data-first-offset="true"><span data-slate-string="true"> 实现对条件轮询等待的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="19071"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19072"><span data-slate-object="text" data-key="19073"><span data-slate-leaf="true" data-offset-key="19073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="19074"><span data-slate-leaf="true" data-offset-key="19074:0" data-first-offset="true"><span data-slate-string="true"> signal </span></span></span><span data-slate-object="text" data-key="19075"><span data-slate-leaf="true" data-offset-key="19075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="19076"><span data-slate-leaf="true" data-offset-key="19076:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19077"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19078"><span data-slate-object="text" data-key="19079"><span data-slate-leaf="true" data-offset-key="19079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19080"><span data-slate-leaf="true" data-offset-key="19080:0" data-first-offset="true"><span data-slate-string="true"> ready </span></span></span><span data-slate-object="text" data-key="19081"><span data-slate-leaf="true" data-offset-key="19081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19082"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19083"><span data-slate-object="text" data-key="19084"><span data-slate-leaf="true" data-offset-key="19084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19085"><span data-slate-leaf="true" data-offset-key="19085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19086"><span data-slate-leaf="true" data-offset-key="19086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="19087"><span data-slate-leaf="true" data-offset-key="19087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="19088"><span data-slate-leaf="true" data-offset-key="19088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="19089"><span data-slate-leaf="true" data-offset-key="19089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19090"><span data-slate-leaf="true" data-offset-key="19090:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19091"><span data-slate-object="text" data-key="19092"><span data-slate-leaf="true" data-offset-key="19092:0" data-first-offset="true"><span data-slate-string="true">  fmt.Printf(</span></span></span><span data-slate-object="text" data-key="19093"><span data-slate-leaf="true" data-offset-key="19093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: is working...\n"</span></span></span></span><span data-slate-object="text" data-key="19094"><span data-slate-leaf="true" data-offset-key="19094:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19095"><span data-slate-object="text" data-key="19096"><span data-slate-leaf="true" data-offset-key="19096:0" data-first-offset="true"><span data-slate-string="true">  time.Sleep(</span></span></span><span data-slate-object="text" data-key="19097"><span data-slate-leaf="true" data-offset-key="19097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19098"><span data-slate-leaf="true" data-offset-key="19098:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19099"><span data-slate-object="text" data-key="19100"><span data-slate-leaf="true" data-offset-key="19100:0" data-first-offset="true"><span data-slate-string="true">  fmt.Printf(</span></span></span><span data-slate-object="text" data-key="19101"><span data-slate-leaf="true" data-offset-key="19101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: works done\n"</span></span></span></span><span data-slate-object="text" data-key="19102"><span data-slate-leaf="true" data-offset-key="19102:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19103"><span data-slate-object="text" data-key="19104"><span data-slate-leaf="true" data-offset-key="19104:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19105"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19106"><span data-slate-object="text" data-key="19107"><span data-slate-leaf="true" data-offset-key="19107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19108"><span data-slate-leaf="true" data-offset-key="19108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19109"><span data-slate-leaf="true" data-offset-key="19109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spawnGroup</span></span></span></span></span><span data-slate-object="text" data-key="19110"><span data-slate-leaf="true" data-offset-key="19110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(f </span></span></span></span></span><span data-slate-object="text" data-key="19111"><span data-slate-leaf="true" data-offset-key="19111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span></span><span data-slate-object="text" data-key="19112"><span data-slate-leaf="true" data-offset-key="19112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="19113"><span data-slate-leaf="true" data-offset-key="19113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="19114"><span data-slate-leaf="true" data-offset-key="19114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19115"><span data-slate-leaf="true" data-offset-key="19115:0" data-first-offset="true"><span data-slate-string="true">, num </span></span></span><span data-slate-object="text" data-key="19116"><span data-slate-leaf="true" data-offset-key="19116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="19117"><span data-slate-leaf="true" data-offset-key="19117:0" data-first-offset="true"><span data-slate-string="true">, mu *sync.Mutex) &lt;-</span></span></span><span data-slate-object="text" data-key="19118"><span data-slate-leaf="true" data-offset-key="19118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="19119"><span data-slate-leaf="true" data-offset-key="19119:0" data-first-offset="true"><span data-slate-string="true"> signal {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19120"><span data-slate-object="text" data-key="19121"><span data-slate-leaf="true" data-offset-key="19121:0" data-first-offset="true"><span data-slate-string="true">  c := </span></span></span><span data-slate-object="text" data-key="19122"><span data-slate-leaf="true" data-offset-key="19122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="19123"><span data-slate-leaf="true" data-offset-key="19123:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19124"><span data-slate-leaf="true" data-offset-key="19124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="19125"><span data-slate-leaf="true" data-offset-key="19125:0" data-first-offset="true"><span data-slate-string="true"> signal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19126"><span data-slate-object="text" data-key="19127"><span data-slate-leaf="true" data-offset-key="19127:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19128"><span data-slate-leaf="true" data-offset-key="19128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19129"><span data-slate-leaf="true" data-offset-key="19129:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19130"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19131"><span data-slate-object="text" data-key="19132"><span data-slate-leaf="true" data-offset-key="19132:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19133"><span data-slate-leaf="true" data-offset-key="19133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19134"><span data-slate-leaf="true" data-offset-key="19134:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="19135"><span data-slate-leaf="true" data-offset-key="19135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19136"><span data-slate-leaf="true" data-offset-key="19136:0" data-first-offset="true"><span data-slate-string="true">; i &lt; num; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19137"><span data-slate-object="text" data-key="19138"><span data-slate-leaf="true" data-offset-key="19138:0" data-first-offset="true"><span data-slate-string="true">    wg.Add(</span></span></span><span data-slate-object="text" data-key="19139"><span data-slate-leaf="true" data-offset-key="19139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19140"><span data-slate-leaf="true" data-offset-key="19140:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19141"><span data-slate-object="text" data-key="19142"><span data-slate-leaf="true" data-offset-key="19142:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19143"><span data-slate-leaf="true" data-offset-key="19143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="19144"><span data-slate-leaf="true" data-offset-key="19144:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19145"><span data-slate-leaf="true" data-offset-key="19145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19146"><span data-slate-leaf="true" data-offset-key="19146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="19147"><span data-slate-leaf="true" data-offset-key="19147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="19148"><span data-slate-leaf="true" data-offset-key="19148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19149"><span data-slate-leaf="true" data-offset-key="19149:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19150"><span data-slate-object="text" data-key="19151"><span data-slate-leaf="true" data-offset-key="19151:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19152"><span data-slate-leaf="true" data-offset-key="19152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19153"><span data-slate-leaf="true" data-offset-key="19153:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19154"><span data-slate-object="text" data-key="19155"><span data-slate-leaf="true" data-offset-key="19155:0" data-first-offset="true"><span data-slate-string="true">        mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19156"><span data-slate-object="text" data-key="19157"><span data-slate-leaf="true" data-offset-key="19157:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19158"><span data-slate-leaf="true" data-offset-key="19158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19159"><span data-slate-leaf="true" data-offset-key="19159:0" data-first-offset="true"><span data-slate-string="true"> !ready {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19160"><span data-slate-object="text" data-key="19161"><span data-slate-leaf="true" data-offset-key="19161:0" data-first-offset="true"><span data-slate-string="true">          mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19162"><span data-slate-object="text" data-key="19163"><span data-slate-leaf="true" data-offset-key="19163:0" data-first-offset="true"><span data-slate-string="true">          time.Sleep(</span></span></span><span data-slate-object="text" data-key="19164"><span data-slate-leaf="true" data-offset-key="19164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">100</span></span></span></span><span data-slate-object="text" data-key="19165"><span data-slate-leaf="true" data-offset-key="19165:0" data-first-offset="true"><span data-slate-string="true"> * time.Millisecond)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19166"><span data-slate-object="text" data-key="19167"><span data-slate-leaf="true" data-offset-key="19167:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19168"><span data-slate-leaf="true" data-offset-key="19168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19169"><span data-slate-object="text" data-key="19170"><span data-slate-leaf="true" data-offset-key="19170:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19171"><span data-slate-object="text" data-key="19172"><span data-slate-leaf="true" data-offset-key="19172:0" data-first-offset="true"><span data-slate-string="true">        mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19173"><span data-slate-object="text" data-key="19174"><span data-slate-leaf="true" data-offset-key="19174:0" data-first-offset="true"><span data-slate-string="true">        fmt.Printf(</span></span></span><span data-slate-object="text" data-key="19175"><span data-slate-leaf="true" data-offset-key="19175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: start to work...\n"</span></span></span></span><span data-slate-object="text" data-key="19176"><span data-slate-leaf="true" data-offset-key="19176:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19177"><span data-slate-object="text" data-key="19178"><span data-slate-leaf="true" data-offset-key="19178:0" data-first-offset="true"><span data-slate-string="true">        f(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19179"><span data-slate-object="text" data-key="19180"><span data-slate-leaf="true" data-offset-key="19180:0" data-first-offset="true"><span data-slate-string="true">        wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19181"><span data-slate-object="text" data-key="19182"><span data-slate-leaf="true" data-offset-key="19182:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19183"><span data-slate-leaf="true" data-offset-key="19183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19184"><span data-slate-object="text" data-key="19185"><span data-slate-leaf="true" data-offset-key="19185:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19186"><span data-slate-object="text" data-key="19187"><span data-slate-leaf="true" data-offset-key="19187:0" data-first-offset="true"><span data-slate-string="true">    }(i + </span></span></span><span data-slate-object="text" data-key="19188"><span data-slate-leaf="true" data-offset-key="19188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19189"><span data-slate-leaf="true" data-offset-key="19189:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19190"><span data-slate-object="text" data-key="19191"><span data-slate-leaf="true" data-offset-key="19191:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19192"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19193"><span data-slate-object="text" data-key="19194"><span data-slate-leaf="true" data-offset-key="19194:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19195"><span data-slate-leaf="true" data-offset-key="19195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="19196"><span data-slate-leaf="true" data-offset-key="19196:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19197"><span data-slate-leaf="true" data-offset-key="19197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19198"><span data-slate-leaf="true" data-offset-key="19198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="19199"><span data-slate-leaf="true" data-offset-key="19199:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19200"><span data-slate-object="text" data-key="19201"><span data-slate-leaf="true" data-offset-key="19201:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19202"><span data-slate-object="text" data-key="19203"><span data-slate-leaf="true" data-offset-key="19203:0" data-first-offset="true"><span data-slate-string="true">    c &lt;- signal(</span></span></span><span data-slate-object="text" data-key="19204"><span data-slate-leaf="true" data-offset-key="19204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="19205"><span data-slate-leaf="true" data-offset-key="19205:0" data-first-offset="true"><span data-slate-string="true">{}{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19206"><span data-slate-object="text" data-key="19207"><span data-slate-leaf="true" data-offset-key="19207:0" data-first-offset="true"><span data-slate-string="true">  }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19208"><span data-slate-object="text" data-key="19209"><span data-slate-leaf="true" data-offset-key="19209:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19210"><span data-slate-leaf="true" data-offset-key="19210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19211"><span data-slate-leaf="true" data-offset-key="19211:0" data-first-offset="true"><span data-slate-string="true"> c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19212"><span data-slate-object="text" data-key="19213"><span data-slate-leaf="true" data-offset-key="19213:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19214"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19215"><span data-slate-object="text" data-key="19216"><span data-slate-leaf="true" data-offset-key="19216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19217"><span data-slate-leaf="true" data-offset-key="19217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19218"><span data-slate-leaf="true" data-offset-key="19218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="19219"><span data-slate-leaf="true" data-offset-key="19219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="19220"><span data-slate-leaf="true" data-offset-key="19220:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19221"><span data-slate-object="text" data-key="19222"><span data-slate-leaf="true" data-offset-key="19222:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="19223"><span data-slate-leaf="true" data-offset-key="19223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start a group of workers..."</span></span></span></span><span data-slate-object="text" data-key="19224"><span data-slate-leaf="true" data-offset-key="19224:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19225"><span data-slate-object="text" data-key="19226"><span data-slate-leaf="true" data-offset-key="19226:0" data-first-offset="true"><span data-slate-string="true">  mu := &amp;sync.Mutex{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19227"><span data-slate-object="text" data-key="19228"><span data-slate-leaf="true" data-offset-key="19228:0" data-first-offset="true"><span data-slate-string="true">  c := spawnGroup(worker, </span></span></span><span data-slate-object="text" data-key="19229"><span data-slate-leaf="true" data-offset-key="19229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19230"><span data-slate-leaf="true" data-offset-key="19230:0" data-first-offset="true"><span data-slate-string="true">, mu)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19231"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19232"><span data-slate-object="text" data-key="19233"><span data-slate-leaf="true" data-offset-key="19233:0" data-first-offset="true"><span data-slate-string="true">  time.Sleep(</span></span></span><span data-slate-object="text" data-key="19234"><span data-slate-leaf="true" data-offset-key="19234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19235"><span data-slate-leaf="true" data-offset-key="19235:0" data-first-offset="true"><span data-slate-string="true"> * time.Second) </span></span></span><span data-slate-object="text" data-key="19236"><span data-slate-leaf="true" data-offset-key="19236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 模拟 ready 前的准备工作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19237"><span data-slate-object="text" data-key="19238"><span data-slate-leaf="true" data-offset-key="19238:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="19239"><span data-slate-leaf="true" data-offset-key="19239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"the group of workers start to work..."</span></span></span></span><span data-slate-object="text" data-key="19240"><span data-slate-leaf="true" data-offset-key="19240:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19241"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19242"><span data-slate-object="text" data-key="19243"><span data-slate-leaf="true" data-offset-key="19243:0" data-first-offset="true"><span data-slate-string="true">  mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19244"><span data-slate-object="text" data-key="19245"><span data-slate-leaf="true" data-offset-key="19245:0" data-first-offset="true"><span data-slate-string="true">  ready = </span></span></span><span data-slate-object="text" data-key="19246"><span data-slate-leaf="true" data-offset-key="19246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19247"><span data-slate-object="text" data-key="19248"><span data-slate-leaf="true" data-offset-key="19248:0" data-first-offset="true"><span data-slate-string="true">  mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19249"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19250"><span data-slate-object="text" data-key="19251"><span data-slate-leaf="true" data-offset-key="19251:0" data-first-offset="true"><span data-slate-string="true">  &lt;-c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19252"><span data-slate-object="text" data-key="19253"><span data-slate-leaf="true" data-offset-key="19253:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="19254"><span data-slate-leaf="true" data-offset-key="19254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"the group of workers work done!"</span></span></span></span><span data-slate-object="text" data-key="19255"><span data-slate-leaf="true" data-offset-key="19255:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19256"><span data-slate-object="text" data-key="19257"><span data-slate-leaf="true" data-offset-key="19257:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19258"><span data-slate-object="text" data-key="19259"><span data-slate-leaf="true" data-offset-key="19259:0" data-first-offset="true"><span data-slate-string="true">就像前面提到的，轮询的方式开销大，轮询间隔设置的不同，条件检查的及时性也会受到影响。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19260"><span data-slate-type="code" data-slate-object="inline" data-key="19261"><span data-slate-object="text" data-key="19262"><span data-slate-leaf="true" data-offset-key="19262:0" data-first-offset="true"><span data-slate-string="true">sync.Cond</span></span></span></span><span data-slate-object="text" data-key="19263"><span data-slate-leaf="true" data-offset-key="19263:0" data-first-offset="true"><span data-slate-string="true"> 为 Goroutine 在这个场景下提供了另一种可选的、资源消耗更小、使用体验更佳的同步方式。使用条件变量原语，我们可以在实现相同目标的同时，避免对条件的轮询。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19264"><span data-slate-object="text" data-key="19265"><span data-slate-leaf="true" data-offset-key="19265:0" data-first-offset="true"><span data-slate-string="true">我们用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19266"><span data-slate-object="text" data-key="19267"><span data-slate-leaf="true" data-offset-key="19267:0" data-first-offset="true"><span data-slate-string="true"> sync.Cond</span></span></span></span><span data-slate-object="text" data-key="19268"><span data-slate-leaf="true" data-offset-key="19268:0" data-first-offset="true"><span data-slate-string="true"> 对上面的例子进行改造，改造后的代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="19269"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19270"><span data-slate-object="text" data-key="19271"><span data-slate-leaf="true" data-offset-key="19271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="19272"><span data-slate-leaf="true" data-offset-key="19272:0" data-first-offset="true"><span data-slate-string="true"> signal </span></span></span><span data-slate-object="text" data-key="19273"><span data-slate-leaf="true" data-offset-key="19273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="19274"><span data-slate-leaf="true" data-offset-key="19274:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19275"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19276"><span data-slate-object="text" data-key="19277"><span data-slate-leaf="true" data-offset-key="19277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19278"><span data-slate-leaf="true" data-offset-key="19278:0" data-first-offset="true"><span data-slate-string="true"> ready </span></span></span><span data-slate-object="text" data-key="19279"><span data-slate-leaf="true" data-offset-key="19279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19280"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19281"><span data-slate-object="text" data-key="19282"><span data-slate-leaf="true" data-offset-key="19282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19283"><span data-slate-leaf="true" data-offset-key="19283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19284"><span data-slate-leaf="true" data-offset-key="19284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="19285"><span data-slate-leaf="true" data-offset-key="19285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="19286"><span data-slate-leaf="true" data-offset-key="19286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="19287"><span data-slate-leaf="true" data-offset-key="19287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19288"><span data-slate-leaf="true" data-offset-key="19288:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19289"><span data-slate-object="text" data-key="19290"><span data-slate-leaf="true" data-offset-key="19290:0" data-first-offset="true"><span data-slate-string="true">  fmt.Printf(</span></span></span><span data-slate-object="text" data-key="19291"><span data-slate-leaf="true" data-offset-key="19291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: is working...\n"</span></span></span></span><span data-slate-object="text" data-key="19292"><span data-slate-leaf="true" data-offset-key="19292:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19293"><span data-slate-object="text" data-key="19294"><span data-slate-leaf="true" data-offset-key="19294:0" data-first-offset="true"><span data-slate-string="true">  time.Sleep(</span></span></span><span data-slate-object="text" data-key="19295"><span data-slate-leaf="true" data-offset-key="19295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19296"><span data-slate-leaf="true" data-offset-key="19296:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19297"><span data-slate-object="text" data-key="19298"><span data-slate-leaf="true" data-offset-key="19298:0" data-first-offset="true"><span data-slate-string="true">  fmt.Printf(</span></span></span><span data-slate-object="text" data-key="19299"><span data-slate-leaf="true" data-offset-key="19299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: works done\n"</span></span></span></span><span data-slate-object="text" data-key="19300"><span data-slate-leaf="true" data-offset-key="19300:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19301"><span data-slate-object="text" data-key="19302"><span data-slate-leaf="true" data-offset-key="19302:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19303"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19304"><span data-slate-object="text" data-key="19305"><span data-slate-leaf="true" data-offset-key="19305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19306"><span data-slate-leaf="true" data-offset-key="19306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19307"><span data-slate-leaf="true" data-offset-key="19307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spawnGroup</span></span></span></span></span><span data-slate-object="text" data-key="19308"><span data-slate-leaf="true" data-offset-key="19308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(f </span></span></span></span></span><span data-slate-object="text" data-key="19309"><span data-slate-leaf="true" data-offset-key="19309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span></span><span data-slate-object="text" data-key="19310"><span data-slate-leaf="true" data-offset-key="19310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="19311"><span data-slate-leaf="true" data-offset-key="19311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="19312"><span data-slate-leaf="true" data-offset-key="19312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19313"><span data-slate-leaf="true" data-offset-key="19313:0" data-first-offset="true"><span data-slate-string="true">, num </span></span></span><span data-slate-object="text" data-key="19314"><span data-slate-leaf="true" data-offset-key="19314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="19315"><span data-slate-leaf="true" data-offset-key="19315:0" data-first-offset="true"><span data-slate-string="true">, groupSignal *sync.Cond) &lt;-</span></span></span><span data-slate-object="text" data-key="19316"><span data-slate-leaf="true" data-offset-key="19316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="19317"><span data-slate-leaf="true" data-offset-key="19317:0" data-first-offset="true"><span data-slate-string="true"> signal {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19318"><span data-slate-object="text" data-key="19319"><span data-slate-leaf="true" data-offset-key="19319:0" data-first-offset="true"><span data-slate-string="true">  c := </span></span></span><span data-slate-object="text" data-key="19320"><span data-slate-leaf="true" data-offset-key="19320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="19321"><span data-slate-leaf="true" data-offset-key="19321:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19322"><span data-slate-leaf="true" data-offset-key="19322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="19323"><span data-slate-leaf="true" data-offset-key="19323:0" data-first-offset="true"><span data-slate-string="true"> signal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19324"><span data-slate-object="text" data-key="19325"><span data-slate-leaf="true" data-offset-key="19325:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19326"><span data-slate-leaf="true" data-offset-key="19326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19327"><span data-slate-leaf="true" data-offset-key="19327:0" data-first-offset="true"><span data-slate-string="true"> wg sync.WaitGroup</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19328"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19329"><span data-slate-object="text" data-key="19330"><span data-slate-leaf="true" data-offset-key="19330:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19331"><span data-slate-leaf="true" data-offset-key="19331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19332"><span data-slate-leaf="true" data-offset-key="19332:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="19333"><span data-slate-leaf="true" data-offset-key="19333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19334"><span data-slate-leaf="true" data-offset-key="19334:0" data-first-offset="true"><span data-slate-string="true">; i &lt; num; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19335"><span data-slate-object="text" data-key="19336"><span data-slate-leaf="true" data-offset-key="19336:0" data-first-offset="true"><span data-slate-string="true">    wg.Add(</span></span></span><span data-slate-object="text" data-key="19337"><span data-slate-leaf="true" data-offset-key="19337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19338"><span data-slate-leaf="true" data-offset-key="19338:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19339"><span data-slate-object="text" data-key="19340"><span data-slate-leaf="true" data-offset-key="19340:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19341"><span data-slate-leaf="true" data-offset-key="19341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="19342"><span data-slate-leaf="true" data-offset-key="19342:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19343"><span data-slate-leaf="true" data-offset-key="19343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19344"><span data-slate-leaf="true" data-offset-key="19344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(i </span></span></span></span></span><span data-slate-object="text" data-key="19345"><span data-slate-leaf="true" data-offset-key="19345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="19346"><span data-slate-leaf="true" data-offset-key="19346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19347"><span data-slate-leaf="true" data-offset-key="19347:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19348"><span data-slate-object="text" data-key="19349"><span data-slate-leaf="true" data-offset-key="19349:0" data-first-offset="true"><span data-slate-string="true">      groupSignal.L.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19350"><span data-slate-object="text" data-key="19351"><span data-slate-leaf="true" data-offset-key="19351:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19352"><span data-slate-leaf="true" data-offset-key="19352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19353"><span data-slate-leaf="true" data-offset-key="19353:0" data-first-offset="true"><span data-slate-string="true"> !ready {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19354"><span data-slate-object="text" data-key="19355"><span data-slate-leaf="true" data-offset-key="19355:0" data-first-offset="true"><span data-slate-string="true">        groupSignal.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19356"><span data-slate-object="text" data-key="19357"><span data-slate-leaf="true" data-offset-key="19357:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19358"><span data-slate-object="text" data-key="19359"><span data-slate-leaf="true" data-offset-key="19359:0" data-first-offset="true"><span data-slate-string="true">      groupSignal.L.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19360"><span data-slate-object="text" data-key="19361"><span data-slate-leaf="true" data-offset-key="19361:0" data-first-offset="true"><span data-slate-string="true">      fmt.Printf(</span></span></span><span data-slate-object="text" data-key="19362"><span data-slate-leaf="true" data-offset-key="19362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"worker %d: start to work...\n"</span></span></span></span><span data-slate-object="text" data-key="19363"><span data-slate-leaf="true" data-offset-key="19363:0" data-first-offset="true"><span data-slate-string="true">, i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19364"><span data-slate-object="text" data-key="19365"><span data-slate-leaf="true" data-offset-key="19365:0" data-first-offset="true"><span data-slate-string="true">      f(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19366"><span data-slate-object="text" data-key="19367"><span data-slate-leaf="true" data-offset-key="19367:0" data-first-offset="true"><span data-slate-string="true">      wg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19368"><span data-slate-object="text" data-key="19369"><span data-slate-leaf="true" data-offset-key="19369:0" data-first-offset="true"><span data-slate-string="true">    }(i + </span></span></span><span data-slate-object="text" data-key="19370"><span data-slate-leaf="true" data-offset-key="19370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19371"><span data-slate-leaf="true" data-offset-key="19371:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19372"><span data-slate-object="text" data-key="19373"><span data-slate-leaf="true" data-offset-key="19373:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19374"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19375"><span data-slate-object="text" data-key="19376"><span data-slate-leaf="true" data-offset-key="19376:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19377"><span data-slate-leaf="true" data-offset-key="19377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="19378"><span data-slate-leaf="true" data-offset-key="19378:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19379"><span data-slate-leaf="true" data-offset-key="19379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19380"><span data-slate-leaf="true" data-offset-key="19380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="19381"><span data-slate-leaf="true" data-offset-key="19381:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19382"><span data-slate-object="text" data-key="19383"><span data-slate-leaf="true" data-offset-key="19383:0" data-first-offset="true"><span data-slate-string="true">    wg.Wait()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19384"><span data-slate-object="text" data-key="19385"><span data-slate-leaf="true" data-offset-key="19385:0" data-first-offset="true"><span data-slate-string="true">    c &lt;- signal(</span></span></span><span data-slate-object="text" data-key="19386"><span data-slate-leaf="true" data-offset-key="19386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="19387"><span data-slate-leaf="true" data-offset-key="19387:0" data-first-offset="true"><span data-slate-string="true">{}{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19388"><span data-slate-object="text" data-key="19389"><span data-slate-leaf="true" data-offset-key="19389:0" data-first-offset="true"><span data-slate-string="true">  }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19390"><span data-slate-object="text" data-key="19391"><span data-slate-leaf="true" data-offset-key="19391:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19392"><span data-slate-leaf="true" data-offset-key="19392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19393"><span data-slate-leaf="true" data-offset-key="19393:0" data-first-offset="true"><span data-slate-string="true"> c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19394"><span data-slate-object="text" data-key="19395"><span data-slate-leaf="true" data-offset-key="19395:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19396"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19397"><span data-slate-object="text" data-key="19398"><span data-slate-leaf="true" data-offset-key="19398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19399"><span data-slate-leaf="true" data-offset-key="19399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19400"><span data-slate-leaf="true" data-offset-key="19400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="19401"><span data-slate-leaf="true" data-offset-key="19401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="19402"><span data-slate-leaf="true" data-offset-key="19402:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19403"><span data-slate-object="text" data-key="19404"><span data-slate-leaf="true" data-offset-key="19404:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="19405"><span data-slate-leaf="true" data-offset-key="19405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start a group of workers..."</span></span></span></span><span data-slate-object="text" data-key="19406"><span data-slate-leaf="true" data-offset-key="19406:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19407"><span data-slate-object="text" data-key="19408"><span data-slate-leaf="true" data-offset-key="19408:0" data-first-offset="true"><span data-slate-string="true">  groupSignal := sync.NewCond(&amp;sync.Mutex{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19409"><span data-slate-object="text" data-key="19410"><span data-slate-leaf="true" data-offset-key="19410:0" data-first-offset="true"><span data-slate-string="true">  c := spawnGroup(worker, </span></span></span><span data-slate-object="text" data-key="19411"><span data-slate-leaf="true" data-offset-key="19411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19412"><span data-slate-leaf="true" data-offset-key="19412:0" data-first-offset="true"><span data-slate-string="true">, groupSignal)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19413"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19414"><span data-slate-object="text" data-key="19415"><span data-slate-leaf="true" data-offset-key="19415:0" data-first-offset="true"><span data-slate-string="true">  time.Sleep(</span></span></span><span data-slate-object="text" data-key="19416"><span data-slate-leaf="true" data-offset-key="19416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19417"><span data-slate-leaf="true" data-offset-key="19417:0" data-first-offset="true"><span data-slate-string="true"> * time.Second) </span></span></span><span data-slate-object="text" data-key="19418"><span data-slate-leaf="true" data-offset-key="19418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 模拟 ready 前的准备工作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19419"><span data-slate-object="text" data-key="19420"><span data-slate-leaf="true" data-offset-key="19420:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="19421"><span data-slate-leaf="true" data-offset-key="19421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"the group of workers start to work..."</span></span></span></span><span data-slate-object="text" data-key="19422"><span data-slate-leaf="true" data-offset-key="19422:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19423"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19424"><span data-slate-object="text" data-key="19425"><span data-slate-leaf="true" data-offset-key="19425:0" data-first-offset="true"><span data-slate-string="true">  groupSignal.L.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19426"><span data-slate-object="text" data-key="19427"><span data-slate-leaf="true" data-offset-key="19427:0" data-first-offset="true"><span data-slate-string="true">  ready = </span></span></span><span data-slate-object="text" data-key="19428"><span data-slate-leaf="true" data-offset-key="19428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19429"><span data-slate-object="text" data-key="19430"><span data-slate-leaf="true" data-offset-key="19430:0" data-first-offset="true"><span data-slate-string="true">  groupSignal.Broadcast()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19431"><span data-slate-object="text" data-key="19432"><span data-slate-leaf="true" data-offset-key="19432:0" data-first-offset="true"><span data-slate-string="true">  groupSignal.L.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19433"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19434"><span data-slate-object="text" data-key="19435"><span data-slate-leaf="true" data-offset-key="19435:0" data-first-offset="true"><span data-slate-string="true">  &lt;-c</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19436"><span data-slate-object="text" data-key="19437"><span data-slate-leaf="true" data-offset-key="19437:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="19438"><span data-slate-leaf="true" data-offset-key="19438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"the group of workers work done!"</span></span></span></span><span data-slate-object="text" data-key="19439"><span data-slate-leaf="true" data-offset-key="19439:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19440"><span data-slate-object="text" data-key="19441"><span data-slate-leaf="true" data-offset-key="19441:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19442"><span data-slate-object="text" data-key="19443"><span data-slate-leaf="true" data-offset-key="19443:0" data-first-offset="true"><span data-slate-string="true">我们运行这个示例程序，得到：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="19444"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19445"><span data-slate-object="text" data-key="19446"><span data-slate-leaf="true" data-offset-key="19446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19447"><span data-slate-leaf="true" data-offset-key="19447:0" data-first-offset="true"><span data-slate-string="true"> a </span></span></span><span data-slate-object="text" data-key="19448"><span data-slate-leaf="true" data-offset-key="19448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group</span></span></span></span><span data-slate-object="text" data-key="19449"><span data-slate-leaf="true" data-offset-key="19449:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19450"><span data-slate-leaf="true" data-offset-key="19450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">of</span></span></span></span><span data-slate-object="text" data-key="19451"><span data-slate-leaf="true" data-offset-key="19451:0" data-first-offset="true"><span data-slate-string="true"> workers...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19452"><span data-slate-object="text" data-key="19453"><span data-slate-leaf="true" data-offset-key="19453:0" data-first-offset="true"><span data-slate-string="true">the </span></span></span><span data-slate-object="text" data-key="19454"><span data-slate-leaf="true" data-offset-key="19454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group</span></span></span></span><span data-slate-object="text" data-key="19455"><span data-slate-leaf="true" data-offset-key="19455:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19456"><span data-slate-leaf="true" data-offset-key="19456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">of</span></span></span></span><span data-slate-object="text" data-key="19457"><span data-slate-leaf="true" data-offset-key="19457:0" data-first-offset="true"><span data-slate-string="true"> workers </span></span></span><span data-slate-object="text" data-key="19458"><span data-slate-leaf="true" data-offset-key="19458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19459"><span data-slate-leaf="true" data-offset-key="19459:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19460"><span data-slate-leaf="true" data-offset-key="19460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="19461"><span data-slate-leaf="true" data-offset-key="19461:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19462"><span data-slate-object="text" data-key="19463"><span data-slate-leaf="true" data-offset-key="19463:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19464"><span data-slate-leaf="true" data-offset-key="19464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="19465"><span data-slate-leaf="true" data-offset-key="19465:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19466"><span data-slate-leaf="true" data-offset-key="19466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19467"><span data-slate-leaf="true" data-offset-key="19467:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19468"><span data-slate-leaf="true" data-offset-key="19468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="19469"><span data-slate-leaf="true" data-offset-key="19469:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19470"><span data-slate-object="text" data-key="19471"><span data-slate-leaf="true" data-offset-key="19471:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19472"><span data-slate-leaf="true" data-offset-key="19472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="19473"><span data-slate-leaf="true" data-offset-key="19473:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19474"><span data-slate-leaf="true" data-offset-key="19474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="19475"><span data-slate-leaf="true" data-offset-key="19475:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19476"><span data-slate-object="text" data-key="19477"><span data-slate-leaf="true" data-offset-key="19477:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19478"><span data-slate-leaf="true" data-offset-key="19478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="19479"><span data-slate-leaf="true" data-offset-key="19479:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19480"><span data-slate-leaf="true" data-offset-key="19480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19481"><span data-slate-leaf="true" data-offset-key="19481:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19482"><span data-slate-leaf="true" data-offset-key="19482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="19483"><span data-slate-leaf="true" data-offset-key="19483:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19484"><span data-slate-object="text" data-key="19485"><span data-slate-leaf="true" data-offset-key="19485:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19486"><span data-slate-leaf="true" data-offset-key="19486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="19487"><span data-slate-leaf="true" data-offset-key="19487:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19488"><span data-slate-leaf="true" data-offset-key="19488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="19489"><span data-slate-leaf="true" data-offset-key="19489:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19490"><span data-slate-object="text" data-key="19491"><span data-slate-leaf="true" data-offset-key="19491:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19492"><span data-slate-leaf="true" data-offset-key="19492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19493"><span data-slate-leaf="true" data-offset-key="19493:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19494"><span data-slate-leaf="true" data-offset-key="19494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19495"><span data-slate-leaf="true" data-offset-key="19495:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19496"><span data-slate-leaf="true" data-offset-key="19496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="19497"><span data-slate-leaf="true" data-offset-key="19497:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19498"><span data-slate-object="text" data-key="19499"><span data-slate-leaf="true" data-offset-key="19499:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19500"><span data-slate-leaf="true" data-offset-key="19500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19501"><span data-slate-leaf="true" data-offset-key="19501:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19502"><span data-slate-leaf="true" data-offset-key="19502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="19503"><span data-slate-leaf="true" data-offset-key="19503:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19504"><span data-slate-object="text" data-key="19505"><span data-slate-leaf="true" data-offset-key="19505:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19506"><span data-slate-leaf="true" data-offset-key="19506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="19507"><span data-slate-leaf="true" data-offset-key="19507:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19508"><span data-slate-leaf="true" data-offset-key="19508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19509"><span data-slate-leaf="true" data-offset-key="19509:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19510"><span data-slate-leaf="true" data-offset-key="19510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="19511"><span data-slate-leaf="true" data-offset-key="19511:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19512"><span data-slate-object="text" data-key="19513"><span data-slate-leaf="true" data-offset-key="19513:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19514"><span data-slate-leaf="true" data-offset-key="19514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19515"><span data-slate-leaf="true" data-offset-key="19515:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19516"><span data-slate-leaf="true" data-offset-key="19516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="19517"><span data-slate-leaf="true" data-offset-key="19517:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19518"><span data-slate-leaf="true" data-offset-key="19518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">to</span></span></span></span><span data-slate-object="text" data-key="19519"><span data-slate-leaf="true" data-offset-key="19519:0" data-first-offset="true"><span data-slate-string="true"> work...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19520"><span data-slate-object="text" data-key="19521"><span data-slate-leaf="true" data-offset-key="19521:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19522"><span data-slate-leaf="true" data-offset-key="19522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19523"><span data-slate-leaf="true" data-offset-key="19523:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19524"><span data-slate-leaf="true" data-offset-key="19524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="19525"><span data-slate-leaf="true" data-offset-key="19525:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19526"><span data-slate-object="text" data-key="19527"><span data-slate-leaf="true" data-offset-key="19527:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19528"><span data-slate-leaf="true" data-offset-key="19528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="19529"><span data-slate-leaf="true" data-offset-key="19529:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="19530"><span data-slate-leaf="true" data-offset-key="19530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">is</span></span></span></span><span data-slate-object="text" data-key="19531"><span data-slate-leaf="true" data-offset-key="19531:0" data-first-offset="true"><span data-slate-string="true"> working...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19532"><span data-slate-object="text" data-key="19533"><span data-slate-leaf="true" data-offset-key="19533:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19534"><span data-slate-leaf="true" data-offset-key="19534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="19535"><span data-slate-leaf="true" data-offset-key="19535:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19536"><span data-slate-object="text" data-key="19537"><span data-slate-leaf="true" data-offset-key="19537:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19538"><span data-slate-leaf="true" data-offset-key="19538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="19539"><span data-slate-leaf="true" data-offset-key="19539:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19540"><span data-slate-object="text" data-key="19541"><span data-slate-leaf="true" data-offset-key="19541:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19542"><span data-slate-leaf="true" data-offset-key="19542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="19543"><span data-slate-leaf="true" data-offset-key="19543:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19544"><span data-slate-object="text" data-key="19545"><span data-slate-leaf="true" data-offset-key="19545:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19546"><span data-slate-leaf="true" data-offset-key="19546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19547"><span data-slate-leaf="true" data-offset-key="19547:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19548"><span data-slate-object="text" data-key="19549"><span data-slate-leaf="true" data-offset-key="19549:0" data-first-offset="true"><span data-slate-string="true">worker </span></span></span><span data-slate-object="text" data-key="19550"><span data-slate-leaf="true" data-offset-key="19550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="19551"><span data-slate-leaf="true" data-offset-key="19551:0" data-first-offset="true"><span data-slate-string="true">: works done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19552"><span data-slate-object="text" data-key="19553"><span data-slate-leaf="true" data-offset-key="19553:0" data-first-offset="true"><span data-slate-string="true">the </span></span></span><span data-slate-object="text" data-key="19554"><span data-slate-leaf="true" data-offset-key="19554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">group</span></span></span></span><span data-slate-object="text" data-key="19555"><span data-slate-leaf="true" data-offset-key="19555:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19556"><span data-slate-leaf="true" data-offset-key="19556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">of</span></span></span></span><span data-slate-object="text" data-key="19557"><span data-slate-leaf="true" data-offset-key="19557:0" data-first-offset="true"><span data-slate-string="true"> workers work done</span></span></span><span data-slate-object="text" data-key="19558"><span data-slate-leaf="true" data-offset-key="19558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">!</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19559"><span data-slate-object="text" data-key="19560"><span data-slate-leaf="true" data-offset-key="19560:0" data-first-offset="true"><span data-slate-string="true">我们看到，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19561"><span data-slate-object="text" data-key="19562"><span data-slate-leaf="true" data-offset-key="19562:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_aa1bcb2e" data-attr-id="36470" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">sync.Cond</span></span></span></span></span><span data-slate-object="text" data-key="19563"><span data-slate-leaf="true" data-offset-key="19563:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_aa1bcb2e" data-attr-id="36470" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> 实例的初始化，需要一个满足实现了</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19564"><span data-slate-object="text" data-key="19565"><span data-slate-leaf="true" data-offset-key="19565:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_aa1bcb2e" data-attr-id="36470" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> sync.Locker</span></span></span></span></span><span data-slate-object="text" data-key="19566"><span data-slate-leaf="true" data-offset-key="19566:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_aa1bcb2e" data-attr-id="36470" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> 接口的类型实例，通常我们使用</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19567"><span data-slate-object="text" data-key="19568"><span data-slate-leaf="true" data-offset-key="19568:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_aa1bcb2e" data-attr-id="36470" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> sync.Mutex</span></span></span></span></span><span data-slate-object="text" data-key="19569"><span data-slate-leaf="true" data-offset-key="19569:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_aa1bcb2e" data-attr-id="36470" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19570"><span data-slate-object="text" data-key="19571"><span data-slate-leaf="true" data-offset-key="19571:0" data-first-offset="true"><span data-slate-string="true">条件变量需要这个互斥锁来同步临界区，保护用作条件的数据。加锁后，各个等待条件成立的 Goroutine 判断条件是否成立，</span></span><span data-slate-leaf="true" data-offset-key="19571:1"><span data-slate-object="annotation" data-annotation-key="gkann_354c9b25" data-attr-id="33867" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果不成立，则调用</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19572"><span data-slate-object="text" data-key="19573"><span data-slate-leaf="true" data-offset-key="19573:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_354c9b25" data-attr-id="33867" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> sync.Cond</span></span></span></span></span><span data-slate-object="text" data-key="19574"><span data-slate-leaf="true" data-offset-key="19574:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_354c9b25" data-attr-id="33867" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> 的 Wait 方法进入等待状态。Wait 方法在 Goroutine 挂起前会进行 Unlock 操作。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19575"><span data-slate-object="text" data-key="19576"><span data-slate-leaf="true" data-offset-key="19576:0" data-first-offset="true"><span data-slate-string="true">当 main goroutine 将</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19577"><span data-slate-object="text" data-key="19578"><span data-slate-leaf="true" data-offset-key="19578:0" data-first-offset="true"><span data-slate-string="true"> ready</span></span></span></span><span data-slate-object="text" data-key="19579"><span data-slate-leaf="true" data-offset-key="19579:0" data-first-offset="true"><span data-slate-string="true"> 置为 true，并调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19580"><span data-slate-object="text" data-key="19581"><span data-slate-leaf="true" data-offset-key="19581:0" data-first-offset="true"><span data-slate-string="true"> sync.Cond</span></span></span></span><span data-slate-object="text" data-key="19582"><span data-slate-leaf="true" data-offset-key="19582:0" data-first-offset="true"><span data-slate-string="true"> 的 Broadcast 方法后，各个阻塞的 Goroutine 将被唤醒，并从 Wait 方法中返回。Wait 方法返回前，Wait 方法会再次加锁让 Goroutine 进入临界区。接下来 Goroutine 会再次对条件数据进行判定，如果条件成立，就会解锁并进入下一个工作阶段；如果条件依旧不成立，那么会再次进入循环体，并调用 Wait 方法挂起等待。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19583"><span data-slate-object="text" data-key="19584"><span data-slate-leaf="true" data-offset-key="19584:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19585"><span data-slate-object="text" data-key="19586"><span data-slate-leaf="true" data-offset-key="19586:0" data-first-offset="true"><span data-slate-string="true"> sync.Mutex</span></span></span></span><span data-slate-object="text" data-key="19587"><span data-slate-leaf="true" data-offset-key="19587:0" data-first-offset="true"><span data-slate-string="true"> 、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19588"><span data-slate-object="text" data-key="19589"><span data-slate-leaf="true" data-offset-key="19589:0" data-first-offset="true"><span data-slate-string="true">sync.RWMutex</span></span></span></span><span data-slate-object="text" data-key="19590"><span data-slate-leaf="true" data-offset-key="19590:0" data-first-offset="true"><span data-slate-string="true"> 等相比，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19591"><span data-slate-object="text" data-key="19592"><span data-slate-leaf="true" data-offset-key="19592:0" data-first-offset="true"><span data-slate-string="true">sync.Cond</span></span></span></span><span data-slate-object="text" data-key="19593"><span data-slate-leaf="true" data-offset-key="19593:0" data-first-offset="true"><span data-slate-string="true"> 应用的场景更为有限，只有在需要 “等待某个条件成立” 的场景下，Cond 才有用武之地。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19594"><span data-slate-object="text" data-key="19595"><span data-slate-leaf="true" data-offset-key="19595:0" data-first-offset="true"><span data-slate-string="true">其实，面向 CSP 并发模型的 channel 原语和面向传统共享内存并发模型的 sync 包提供的原语，已经能够满足 Go 语言应用并发设计中 99.9% 的并发同步需求了。而剩余那 0.1% 的需求，我们可以使用 Go 标准库提供的 atomic 包来实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19596" id="sr-toc-5"><span data-slate-object="text" data-key="19597"><span data-slate-leaf="true" data-offset-key="19597:0" data-first-offset="true"><span data-slate-string="true">原子操作（atomic operations）</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19598"><span data-slate-object="text" data-key="19599"><span data-slate-leaf="true" data-offset-key="19599:0" data-first-offset="true"><span data-slate-string="true">atomic 包是 Go 语言给用户提供的原子操作原语的相关接口。原子操作（atomic operations）是相对于普通指令操作而言的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19600"><span data-slate-object="text" data-key="19601"><span data-slate-leaf="true" data-offset-key="19601:0" data-first-offset="true"><span data-slate-string="true">我们以一个整型变量自增的语句为例说明一下：</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="19602"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19603"><span data-slate-object="text" data-key="19604"><span data-slate-leaf="true" data-offset-key="19604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19605"><span data-slate-leaf="true" data-offset-key="19605:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19606"><span data-slate-leaf="true" data-offset-key="19606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">a</span></span></span></span><span data-slate-object="text" data-key="19607"><span data-slate-leaf="true" data-offset-key="19607:0" data-first-offset="true"><span data-slate-string="true"> int</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19608"><span data-slate-object="text" data-key="19609"><span data-slate-leaf="true" data-offset-key="19609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">a</span></span></span></span><span data-slate-object="text" data-key="19610"><span data-slate-leaf="true" data-offset-key="19610:0" data-first-offset="true"><span data-slate-string="true">++</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19611"><span data-slate-object="text" data-key="19612"><span data-slate-leaf="true" data-offset-key="19612:0" data-first-offset="true"><span data-slate-string="true">a++ 这行语句需要 3 条普通机器指令来完成变量 a 的自增：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="19613"><div data-slate-type="list-line" data-slate-object="block" data-key="19614"><span data-slate-object="text" data-key="19615"><span data-slate-leaf="true" data-offset-key="19615:0" data-first-offset="true"><span data-slate-string="true">LOAD：将变量从内存加载到 CPU 寄存器；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="19616"><span data-slate-object="text" data-key="19617"><span data-slate-leaf="true" data-offset-key="19617:0" data-first-offset="true"><span data-slate-string="true">ADD：执行加法指令；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="19618"><span data-slate-object="text" data-key="19619"><span data-slate-leaf="true" data-offset-key="19619:0" data-first-offset="true"><span data-slate-string="true">STORE：将结果存储回原内存地址中。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19620"><span data-slate-object="text" data-key="19621"><span data-slate-leaf="true" data-offset-key="19621:0" data-first-offset="true"><span data-slate-string="true">这 3 条普通指令在执行过程中是可以被中断的。而原子操作的指令是不可中断的，它就好比一个事务，要么不执行，一旦执行就一次性全部执行完毕，中间不可分割。也正因为如此，原子操作也可以被用于共享数据的并发同步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19622"><span data-slate-object="text" data-key="19623"><span data-slate-leaf="true" data-offset-key="19623:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_2b2390c7" data-attr-id="35424" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">原子操作由底层硬件直接提供支持，是一种硬件实现的指令级的 “事务”，</span></span></span><span data-slate-leaf="true" data-offset-key="19623:1"><span data-slate-string="true">因此相对于操作系统层面和 Go 运行时层面提供的同步技术而言，它更为原始。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19624"><span data-slate-object="text" data-key="19625"><span data-slate-leaf="true" data-offset-key="19625:0" data-first-offset="true"><span data-slate-string="true">atomic 包封装了 CPU 实现的部分原子操作指令，为用户层提供体验良好的原子操作函数，因此 atomic 包中提供的原语更接近硬件底层，也更为低级，它也常被用于实现更为高级的并发同步技术，比如 channel 和 sync 包中的同步原语。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19626"><span data-slate-object="text" data-key="19627"><span data-slate-leaf="true" data-offset-key="19627:0" data-first-offset="true"><span data-slate-string="true">我们以 atomic.SwapInt64 函数在 x86_64 平台上的实现为例，看看这个函数的实现方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="19628"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19629"><span data-slate-object="text" data-key="19630"><span data-slate-leaf="true" data-offset-key="19630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/sync/atomic/doc.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19631"><span data-slate-object="text" data-key="19632"><span data-slate-leaf="true" data-offset-key="19632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19633"><span data-slate-leaf="true" data-offset-key="19633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19634"><span data-slate-leaf="true" data-offset-key="19634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SwapInt64</span></span></span></span></span><span data-slate-object="text" data-key="19635"><span data-slate-leaf="true" data-offset-key="19635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(addr *</span></span></span></span></span><span data-slate-object="text" data-key="19636"><span data-slate-leaf="true" data-offset-key="19636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></span></span><span data-slate-object="text" data-key="19637"><span data-slate-leaf="true" data-offset-key="19637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, </span></span></span></span></span><span data-slate-object="text" data-key="19638"><span data-slate-leaf="true" data-offset-key="19638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span></span></span><span data-slate-object="text" data-key="19639"><span data-slate-leaf="true" data-offset-key="19639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="19640"><span data-slate-leaf="true" data-offset-key="19640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></span></span><span data-slate-object="text" data-key="19641"><span data-slate-leaf="true" data-offset-key="19641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19642"><span data-slate-leaf="true" data-offset-key="19642:0" data-first-offset="true"><span data-slate-string="true"> (old </span></span></span><span data-slate-object="text" data-key="19643"><span data-slate-leaf="true" data-offset-key="19643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="19644"><span data-slate-leaf="true" data-offset-key="19644:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19645"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19646"><span data-slate-object="text" data-key="19647"><span data-slate-leaf="true" data-offset-key="19647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/sync/atomic/asm.s</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19648"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19649"><span data-slate-object="text" data-key="19650"><span data-slate-leaf="true" data-offset-key="19650:0" data-first-offset="true"><span data-slate-string="true">TEXT ·SwapInt64(SB),NOSPLIT,$</span></span></span><span data-slate-object="text" data-key="19651"><span data-slate-leaf="true" data-offset-key="19651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19652"><span data-slate-object="text" data-key="19653"><span data-slate-leaf="true" data-offset-key="19653:0" data-first-offset="true"><span data-slate-string="true">        JMP     runtime∕internal∕atomic·Xchg64(SB)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19654"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19655"><span data-slate-object="text" data-key="19656"><span data-slate-leaf="true" data-offset-key="19656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/runtime/internal/atomic/asm_amd64.s</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19657"><span data-slate-object="text" data-key="19658"><span data-slate-leaf="true" data-offset-key="19658:0" data-first-offset="true"><span data-slate-string="true">TEXT runtime∕internal∕atomic·Xchg64(SB), NOSPLIT, $</span></span></span><span data-slate-object="text" data-key="19659"><span data-slate-leaf="true" data-offset-key="19659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19660"><span data-slate-leaf="true" data-offset-key="19660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-24</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19661"><span data-slate-object="text" data-key="19662"><span data-slate-leaf="true" data-offset-key="19662:0" data-first-offset="true"><span data-slate-string="true">        MOVQ    ptr+</span></span></span><span data-slate-object="text" data-key="19663"><span data-slate-leaf="true" data-offset-key="19663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19664"><span data-slate-leaf="true" data-offset-key="19664:0" data-first-offset="true"><span data-slate-string="true">(FP), BX</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19665"><span data-slate-object="text" data-key="19666"><span data-slate-leaf="true" data-offset-key="19666:0" data-first-offset="true"><span data-slate-string="true">        MOVQ    </span></span></span><span data-slate-object="text" data-key="19667"><span data-slate-leaf="true" data-offset-key="19667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="19668"><span data-slate-leaf="true" data-offset-key="19668:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-object="text" data-key="19669"><span data-slate-leaf="true" data-offset-key="19669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span><span data-slate-object="text" data-key="19670"><span data-slate-leaf="true" data-offset-key="19670:0" data-first-offset="true"><span data-slate-string="true">(FP), AX</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19671"><span data-slate-object="text" data-key="19672"><span data-slate-leaf="true" data-offset-key="19672:0" data-first-offset="true"><span data-slate-string="true">        XCHGQ   AX, </span></span></span><span data-slate-object="text" data-key="19673"><span data-slate-leaf="true" data-offset-key="19673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19674"><span data-slate-leaf="true" data-offset-key="19674:0" data-first-offset="true"><span data-slate-string="true">(BX)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19675"><span data-slate-object="text" data-key="19676"><span data-slate-leaf="true" data-offset-key="19676:0" data-first-offset="true"><span data-slate-string="true">        MOVQ    AX, ret+</span></span></span><span data-slate-object="text" data-key="19677"><span data-slate-leaf="true" data-offset-key="19677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="19678"><span data-slate-leaf="true" data-offset-key="19678:0" data-first-offset="true"><span data-slate-string="true">(FP)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19679"><span data-slate-object="text" data-key="19680"><span data-slate-leaf="true" data-offset-key="19680:0" data-first-offset="true"><span data-slate-string="true">        RET</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19681"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19682"><span data-slate-object="text" data-key="19683"><span data-slate-leaf="true" data-offset-key="19683:0" data-first-offset="true"><span data-slate-string="true">从函数 SwapInt64 的实现中，我们可以看到：它基本就是对 x86_64 CPU 实现的原子操作指令</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="19684"><span data-slate-object="text" data-key="19685"><span data-slate-leaf="true" data-offset-key="19685:0" data-first-offset="true"><span data-slate-string="true"> XCHGQ</span></span></span></span><span data-slate-object="text" data-key="19686"><span data-slate-leaf="true" data-offset-key="19686:0" data-first-offset="true"><span data-slate-string="true"> 的直接封装。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19687"><span data-slate-object="text" data-key="19688"><span data-slate-leaf="true" data-offset-key="19688:0" data-first-offset="true"><span data-slate-string="true">原子操作的特性，让 atomic 包也可以被用作对共享数据的并发同步，那么和更为高级的 channel 以及 sync 包中原语相比，我们究竟该怎么选择呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19689"><span data-slate-object="text" data-key="19690"><span data-slate-leaf="true" data-offset-key="19690:0" data-first-offset="true"><span data-slate-string="true">我们先来看看 atomic 包提供了哪些能力。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19691"><span data-slate-object="text" data-key="19692"><span data-slate-leaf="true" data-offset-key="19692:0" data-first-offset="true"><span data-slate-string="true">atomic 包提供了两大类原子操作接口，一类是针对整型变量的，包括有符号整型、无符号整型以及对应的指针类型；另外一类是针对自定义类型的。因此，第一类原子操作接口的存在让 atomic 包天然适合去实现某一个共享整型变量的并发同步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19693"><span data-slate-object="text" data-key="19694"><span data-slate-leaf="true" data-offset-key="19694:0" data-first-offset="true"><span data-slate-string="true">我们再看一个例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="19695"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19696"><span data-slate-object="text" data-key="19697"><span data-slate-leaf="true" data-offset-key="19697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19698"><span data-slate-leaf="true" data-offset-key="19698:0" data-first-offset="true"><span data-slate-string="true"> n1 </span></span></span><span data-slate-object="text" data-key="19699"><span data-slate-leaf="true" data-offset-key="19699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19700"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19701"><span data-slate-object="text" data-key="19702"><span data-slate-leaf="true" data-offset-key="19702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19703"><span data-slate-leaf="true" data-offset-key="19703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19704"><span data-slate-leaf="true" data-offset-key="19704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addSyncByAtomic</span></span></span></span></span><span data-slate-object="text" data-key="19705"><span data-slate-leaf="true" data-offset-key="19705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(delta </span></span></span></span></span><span data-slate-object="text" data-key="19706"><span data-slate-leaf="true" data-offset-key="19706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></span></span><span data-slate-object="text" data-key="19707"><span data-slate-leaf="true" data-offset-key="19707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19708"><span data-slate-leaf="true" data-offset-key="19708:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19709"><span data-slate-leaf="true" data-offset-key="19709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="19710"><span data-slate-leaf="true" data-offset-key="19710:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19711"><span data-slate-object="text" data-key="19712"><span data-slate-leaf="true" data-offset-key="19712:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19713"><span data-slate-leaf="true" data-offset-key="19713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19714"><span data-slate-leaf="true" data-offset-key="19714:0" data-first-offset="true"><span data-slate-string="true"> atomic.AddInt64(&amp;n1, delta)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19715"><span data-slate-object="text" data-key="19716"><span data-slate-leaf="true" data-offset-key="19716:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19717"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19718"><span data-slate-object="text" data-key="19719"><span data-slate-leaf="true" data-offset-key="19719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19720"><span data-slate-leaf="true" data-offset-key="19720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19721"><span data-slate-leaf="true" data-offset-key="19721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readSyncByAtomic</span></span></span></span></span><span data-slate-object="text" data-key="19722"><span data-slate-leaf="true" data-offset-key="19722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="19723"><span data-slate-leaf="true" data-offset-key="19723:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19724"><span data-slate-leaf="true" data-offset-key="19724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="19725"><span data-slate-leaf="true" data-offset-key="19725:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19726"><span data-slate-object="text" data-key="19727"><span data-slate-leaf="true" data-offset-key="19727:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19728"><span data-slate-leaf="true" data-offset-key="19728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19729"><span data-slate-leaf="true" data-offset-key="19729:0" data-first-offset="true"><span data-slate-string="true"> atomic.LoadInt64(&amp;n1)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19730"><span data-slate-object="text" data-key="19731"><span data-slate-leaf="true" data-offset-key="19731:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19732"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19733"><span data-slate-object="text" data-key="19734"><span data-slate-leaf="true" data-offset-key="19734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19735"><span data-slate-leaf="true" data-offset-key="19735:0" data-first-offset="true"><span data-slate-string="true"> n2 </span></span></span><span data-slate-object="text" data-key="19736"><span data-slate-leaf="true" data-offset-key="19736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19737"><span data-slate-object="text" data-key="19738"><span data-slate-leaf="true" data-offset-key="19738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19739"><span data-slate-leaf="true" data-offset-key="19739:0" data-first-offset="true"><span data-slate-string="true"> rwmu sync.RWMutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19740"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19741"><span data-slate-object="text" data-key="19742"><span data-slate-leaf="true" data-offset-key="19742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19743"><span data-slate-leaf="true" data-offset-key="19743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19744"><span data-slate-leaf="true" data-offset-key="19744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addSyncByRWMutex</span></span></span></span></span><span data-slate-object="text" data-key="19745"><span data-slate-leaf="true" data-offset-key="19745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(delta </span></span></span></span></span><span data-slate-object="text" data-key="19746"><span data-slate-leaf="true" data-offset-key="19746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></span></span><span data-slate-object="text" data-key="19747"><span data-slate-leaf="true" data-offset-key="19747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19748"><span data-slate-leaf="true" data-offset-key="19748:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19749"><span data-slate-object="text" data-key="19750"><span data-slate-leaf="true" data-offset-key="19750:0" data-first-offset="true"><span data-slate-string="true">  rwmu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19751"><span data-slate-object="text" data-key="19752"><span data-slate-leaf="true" data-offset-key="19752:0" data-first-offset="true"><span data-slate-string="true">  n2 += delta</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19753"><span data-slate-object="text" data-key="19754"><span data-slate-leaf="true" data-offset-key="19754:0" data-first-offset="true"><span data-slate-string="true">  rwmu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19755"><span data-slate-object="text" data-key="19756"><span data-slate-leaf="true" data-offset-key="19756:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19757"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19758"><span data-slate-object="text" data-key="19759"><span data-slate-leaf="true" data-offset-key="19759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19760"><span data-slate-leaf="true" data-offset-key="19760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19761"><span data-slate-leaf="true" data-offset-key="19761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">readSyncByRWMutex</span></span></span></span></span><span data-slate-object="text" data-key="19762"><span data-slate-leaf="true" data-offset-key="19762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="19763"><span data-slate-leaf="true" data-offset-key="19763:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19764"><span data-slate-leaf="true" data-offset-key="19764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="19765"><span data-slate-leaf="true" data-offset-key="19765:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19766"><span data-slate-object="text" data-key="19767"><span data-slate-leaf="true" data-offset-key="19767:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19768"><span data-slate-leaf="true" data-offset-key="19768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="19769"><span data-slate-leaf="true" data-offset-key="19769:0" data-first-offset="true"><span data-slate-string="true"> n </span></span></span><span data-slate-object="text" data-key="19770"><span data-slate-leaf="true" data-offset-key="19770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19771"><span data-slate-object="text" data-key="19772"><span data-slate-leaf="true" data-offset-key="19772:0" data-first-offset="true"><span data-slate-string="true">  rwmu.RLock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19773"><span data-slate-object="text" data-key="19774"><span data-slate-leaf="true" data-offset-key="19774:0" data-first-offset="true"><span data-slate-string="true">  n = n2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19775"><span data-slate-object="text" data-key="19776"><span data-slate-leaf="true" data-offset-key="19776:0" data-first-offset="true"><span data-slate-string="true">  rwmu.RUnlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19777"><span data-slate-object="text" data-key="19778"><span data-slate-leaf="true" data-offset-key="19778:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="19779"><span data-slate-leaf="true" data-offset-key="19779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19780"><span data-slate-leaf="true" data-offset-key="19780:0" data-first-offset="true"><span data-slate-string="true"> n</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19781"><span data-slate-object="text" data-key="19782"><span data-slate-leaf="true" data-offset-key="19782:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19783"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19784"><span data-slate-object="text" data-key="19785"><span data-slate-leaf="true" data-offset-key="19785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19786"><span data-slate-leaf="true" data-offset-key="19786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19787"><span data-slate-leaf="true" data-offset-key="19787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkAddSyncByAtomic</span></span></span></span></span><span data-slate-object="text" data-key="19788"><span data-slate-leaf="true" data-offset-key="19788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="19789"><span data-slate-leaf="true" data-offset-key="19789:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19790"><span data-slate-object="text" data-key="19791"><span data-slate-leaf="true" data-offset-key="19791:0" data-first-offset="true"><span data-slate-string="true">  b.RunParallel(</span></span></span><span data-slate-object="text" data-key="19792"><span data-slate-leaf="true" data-offset-key="19792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19793"><span data-slate-leaf="true" data-offset-key="19793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="19794"><span data-slate-leaf="true" data-offset-key="19794:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19795"><span data-slate-object="text" data-key="19796"><span data-slate-leaf="true" data-offset-key="19796:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19797"><span data-slate-leaf="true" data-offset-key="19797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19798"><span data-slate-leaf="true" data-offset-key="19798:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19799"><span data-slate-object="text" data-key="19800"><span data-slate-leaf="true" data-offset-key="19800:0" data-first-offset="true"><span data-slate-string="true">      addSyncByAtomic(</span></span></span><span data-slate-object="text" data-key="19801"><span data-slate-leaf="true" data-offset-key="19801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19802"><span data-slate-leaf="true" data-offset-key="19802:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19803"><span data-slate-object="text" data-key="19804"><span data-slate-leaf="true" data-offset-key="19804:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19805"><span data-slate-object="text" data-key="19806"><span data-slate-leaf="true" data-offset-key="19806:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19807"><span data-slate-object="text" data-key="19808"><span data-slate-leaf="true" data-offset-key="19808:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19809"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19810"><span data-slate-object="text" data-key="19811"><span data-slate-leaf="true" data-offset-key="19811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19812"><span data-slate-leaf="true" data-offset-key="19812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19813"><span data-slate-leaf="true" data-offset-key="19813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkReadSyncByAtomic</span></span></span></span></span><span data-slate-object="text" data-key="19814"><span data-slate-leaf="true" data-offset-key="19814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="19815"><span data-slate-leaf="true" data-offset-key="19815:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19816"><span data-slate-object="text" data-key="19817"><span data-slate-leaf="true" data-offset-key="19817:0" data-first-offset="true"><span data-slate-string="true">  b.RunParallel(</span></span></span><span data-slate-object="text" data-key="19818"><span data-slate-leaf="true" data-offset-key="19818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19819"><span data-slate-leaf="true" data-offset-key="19819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="19820"><span data-slate-leaf="true" data-offset-key="19820:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19821"><span data-slate-object="text" data-key="19822"><span data-slate-leaf="true" data-offset-key="19822:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19823"><span data-slate-leaf="true" data-offset-key="19823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19824"><span data-slate-leaf="true" data-offset-key="19824:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19825"><span data-slate-object="text" data-key="19826"><span data-slate-leaf="true" data-offset-key="19826:0" data-first-offset="true"><span data-slate-string="true">      readSyncByAtomic()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19827"><span data-slate-object="text" data-key="19828"><span data-slate-leaf="true" data-offset-key="19828:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19829"><span data-slate-object="text" data-key="19830"><span data-slate-leaf="true" data-offset-key="19830:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19831"><span data-slate-object="text" data-key="19832"><span data-slate-leaf="true" data-offset-key="19832:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19833"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19834"><span data-slate-object="text" data-key="19835"><span data-slate-leaf="true" data-offset-key="19835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19836"><span data-slate-leaf="true" data-offset-key="19836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19837"><span data-slate-leaf="true" data-offset-key="19837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkAddSyncByRWMutex</span></span></span></span></span><span data-slate-object="text" data-key="19838"><span data-slate-leaf="true" data-offset-key="19838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="19839"><span data-slate-leaf="true" data-offset-key="19839:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19840"><span data-slate-object="text" data-key="19841"><span data-slate-leaf="true" data-offset-key="19841:0" data-first-offset="true"><span data-slate-string="true">  b.RunParallel(</span></span></span><span data-slate-object="text" data-key="19842"><span data-slate-leaf="true" data-offset-key="19842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19843"><span data-slate-leaf="true" data-offset-key="19843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="19844"><span data-slate-leaf="true" data-offset-key="19844:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19845"><span data-slate-object="text" data-key="19846"><span data-slate-leaf="true" data-offset-key="19846:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19847"><span data-slate-leaf="true" data-offset-key="19847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19848"><span data-slate-leaf="true" data-offset-key="19848:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19849"><span data-slate-object="text" data-key="19850"><span data-slate-leaf="true" data-offset-key="19850:0" data-first-offset="true"><span data-slate-string="true">      addSyncByRWMutex(</span></span></span><span data-slate-object="text" data-key="19851"><span data-slate-leaf="true" data-offset-key="19851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="19852"><span data-slate-leaf="true" data-offset-key="19852:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19853"><span data-slate-object="text" data-key="19854"><span data-slate-leaf="true" data-offset-key="19854:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19855"><span data-slate-object="text" data-key="19856"><span data-slate-leaf="true" data-offset-key="19856:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19857"><span data-slate-object="text" data-key="19858"><span data-slate-leaf="true" data-offset-key="19858:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19859"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19860"><span data-slate-object="text" data-key="19861"><span data-slate-leaf="true" data-offset-key="19861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19862"><span data-slate-leaf="true" data-offset-key="19862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19863"><span data-slate-leaf="true" data-offset-key="19863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkReadSyncByRWMutex</span></span></span></span></span><span data-slate-object="text" data-key="19864"><span data-slate-leaf="true" data-offset-key="19864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="19865"><span data-slate-leaf="true" data-offset-key="19865:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19866"><span data-slate-object="text" data-key="19867"><span data-slate-leaf="true" data-offset-key="19867:0" data-first-offset="true"><span data-slate-string="true">  b.RunParallel(</span></span></span><span data-slate-object="text" data-key="19868"><span data-slate-leaf="true" data-offset-key="19868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="19869"><span data-slate-leaf="true" data-offset-key="19869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(pb *testing.PB)</span></span></span></span></span><span data-slate-object="text" data-key="19870"><span data-slate-leaf="true" data-offset-key="19870:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19871"><span data-slate-object="text" data-key="19872"><span data-slate-leaf="true" data-offset-key="19872:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19873"><span data-slate-leaf="true" data-offset-key="19873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="19874"><span data-slate-leaf="true" data-offset-key="19874:0" data-first-offset="true"><span data-slate-string="true"> pb.Next() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19875"><span data-slate-object="text" data-key="19876"><span data-slate-leaf="true" data-offset-key="19876:0" data-first-offset="true"><span data-slate-string="true">      readSyncByRWMutex()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19877"><span data-slate-object="text" data-key="19878"><span data-slate-leaf="true" data-offset-key="19878:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19879"><span data-slate-object="text" data-key="19880"><span data-slate-leaf="true" data-offset-key="19880:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19881"><span data-slate-object="text" data-key="19882"><span data-slate-leaf="true" data-offset-key="19882:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19883"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19884"><span data-slate-object="text" data-key="19885"><span data-slate-leaf="true" data-offset-key="19885:0" data-first-offset="true"><span data-slate-string="true">我们分别在 cpu=2、 8、16、32 的情况下运行上述性能基准测试，得到结果如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="19886"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19887"><span data-slate-object="text" data-key="19888"><span data-slate-leaf="true" data-offset-key="19888:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19889"><span data-slate-object="text" data-key="19890"><span data-slate-leaf="true" data-offset-key="19890:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19891"><span data-slate-object="text" data-key="19892"><span data-slate-leaf="true" data-offset-key="19892:0" data-first-offset="true"><span data-slate-string="true">... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19893"><span data-slate-object="text" data-key="19894"><span data-slate-leaf="true" data-offset-key="19894:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19895"><span data-slate-leaf="true" data-offset-key="19895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-2</span></span></span></span><span data-slate-object="text" data-key="19896"><span data-slate-leaf="true" data-offset-key="19896:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="19897"><span data-slate-leaf="true" data-offset-key="19897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">75426774</span></span></span></span><span data-slate-object="text" data-key="19898"><span data-slate-leaf="true" data-offset-key="19898:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19899"><span data-slate-leaf="true" data-offset-key="19899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17.69</span></span></span></span><span data-slate-object="text" data-key="19900"><span data-slate-leaf="true" data-offset-key="19900:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19901"><span data-slate-object="text" data-key="19902"><span data-slate-leaf="true" data-offset-key="19902:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19903"><span data-slate-leaf="true" data-offset-key="19903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-2</span></span></span></span><span data-slate-object="text" data-key="19904"><span data-slate-leaf="true" data-offset-key="19904:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19905"><span data-slate-leaf="true" data-offset-key="19905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000000000</span></span></span></span><span data-slate-object="text" data-key="19906"><span data-slate-leaf="true" data-offset-key="19906:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="19907"><span data-slate-leaf="true" data-offset-key="19907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0.7437</span></span></span></span><span data-slate-object="text" data-key="19908"><span data-slate-leaf="true" data-offset-key="19908:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19909"><span data-slate-object="text" data-key="19910"><span data-slate-leaf="true" data-offset-key="19910:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="19911"><span data-slate-leaf="true" data-offset-key="19911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-2</span></span></span></span><span data-slate-object="text" data-key="19912"><span data-slate-leaf="true" data-offset-key="19912:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19913"><span data-slate-leaf="true" data-offset-key="19913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">39041671</span></span></span></span><span data-slate-object="text" data-key="19914"><span data-slate-leaf="true" data-offset-key="19914:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19915"><span data-slate-leaf="true" data-offset-key="19915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">30.16</span></span></span></span><span data-slate-object="text" data-key="19916"><span data-slate-leaf="true" data-offset-key="19916:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19917"><span data-slate-object="text" data-key="19918"><span data-slate-leaf="true" data-offset-key="19918:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="19919"><span data-slate-leaf="true" data-offset-key="19919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-2</span></span></span></span><span data-slate-object="text" data-key="19920"><span data-slate-leaf="true" data-offset-key="19920:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="19921"><span data-slate-leaf="true" data-offset-key="19921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">41325093</span></span></span></span><span data-slate-object="text" data-key="19922"><span data-slate-leaf="true" data-offset-key="19922:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19923"><span data-slate-leaf="true" data-offset-key="19923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">28.48</span></span></span></span><span data-slate-object="text" data-key="19924"><span data-slate-leaf="true" data-offset-key="19924:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19925"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19926"><span data-slate-object="text" data-key="19927"><span data-slate-leaf="true" data-offset-key="19927:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19928"><span data-slate-leaf="true" data-offset-key="19928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-8</span></span></span></span><span data-slate-object="text" data-key="19929"><span data-slate-leaf="true" data-offset-key="19929:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="19930"><span data-slate-leaf="true" data-offset-key="19930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">77497987</span></span></span></span><span data-slate-object="text" data-key="19931"><span data-slate-leaf="true" data-offset-key="19931:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19932"><span data-slate-leaf="true" data-offset-key="19932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">15.25</span></span></span></span><span data-slate-object="text" data-key="19933"><span data-slate-leaf="true" data-offset-key="19933:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19934"><span data-slate-object="text" data-key="19935"><span data-slate-leaf="true" data-offset-key="19935:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19936"><span data-slate-leaf="true" data-offset-key="19936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-8</span></span></span></span><span data-slate-object="text" data-key="19937"><span data-slate-leaf="true" data-offset-key="19937:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19938"><span data-slate-leaf="true" data-offset-key="19938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000000000</span></span></span></span><span data-slate-object="text" data-key="19939"><span data-slate-leaf="true" data-offset-key="19939:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="19940"><span data-slate-leaf="true" data-offset-key="19940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0.2395</span></span></span></span><span data-slate-object="text" data-key="19941"><span data-slate-leaf="true" data-offset-key="19941:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19942"><span data-slate-object="text" data-key="19943"><span data-slate-leaf="true" data-offset-key="19943:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="19944"><span data-slate-leaf="true" data-offset-key="19944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-8</span></span></span></span><span data-slate-object="text" data-key="19945"><span data-slate-leaf="true" data-offset-key="19945:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19946"><span data-slate-leaf="true" data-offset-key="19946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17702034</span></span></span></span><span data-slate-object="text" data-key="19947"><span data-slate-leaf="true" data-offset-key="19947:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19948"><span data-slate-leaf="true" data-offset-key="19948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">67.16</span></span></span></span><span data-slate-object="text" data-key="19949"><span data-slate-leaf="true" data-offset-key="19949:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19950"><span data-slate-object="text" data-key="19951"><span data-slate-leaf="true" data-offset-key="19951:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="19952"><span data-slate-leaf="true" data-offset-key="19952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-8</span></span></span></span><span data-slate-object="text" data-key="19953"><span data-slate-leaf="true" data-offset-key="19953:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="19954"><span data-slate-leaf="true" data-offset-key="19954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29966182</span></span></span></span><span data-slate-object="text" data-key="19955"><span data-slate-leaf="true" data-offset-key="19955:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19956"><span data-slate-leaf="true" data-offset-key="19956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">40.37</span></span></span></span><span data-slate-object="text" data-key="19957"><span data-slate-leaf="true" data-offset-key="19957:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19958"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19959"><span data-slate-object="text" data-key="19960"><span data-slate-leaf="true" data-offset-key="19960:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19961"><span data-slate-leaf="true" data-offset-key="19961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-16</span></span></span></span><span data-slate-object="text" data-key="19962"><span data-slate-leaf="true" data-offset-key="19962:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19963"><span data-slate-leaf="true" data-offset-key="19963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">57727968</span></span></span></span><span data-slate-object="text" data-key="19964"><span data-slate-leaf="true" data-offset-key="19964:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19965"><span data-slate-leaf="true" data-offset-key="19965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20.39</span></span></span></span><span data-slate-object="text" data-key="19966"><span data-slate-leaf="true" data-offset-key="19966:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19967"><span data-slate-object="text" data-key="19968"><span data-slate-leaf="true" data-offset-key="19968:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19969"><span data-slate-leaf="true" data-offset-key="19969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-16</span></span></span></span><span data-slate-object="text" data-key="19970"><span data-slate-leaf="true" data-offset-key="19970:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="19971"><span data-slate-leaf="true" data-offset-key="19971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000000000</span></span></span></span><span data-slate-object="text" data-key="19972"><span data-slate-leaf="true" data-offset-key="19972:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="19973"><span data-slate-leaf="true" data-offset-key="19973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0.2536</span></span></span></span><span data-slate-object="text" data-key="19974"><span data-slate-leaf="true" data-offset-key="19974:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19975"><span data-slate-object="text" data-key="19976"><span data-slate-leaf="true" data-offset-key="19976:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="19977"><span data-slate-leaf="true" data-offset-key="19977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-16</span></span></span></span><span data-slate-object="text" data-key="19978"><span data-slate-leaf="true" data-offset-key="19978:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="19979"><span data-slate-leaf="true" data-offset-key="19979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">15029635</span></span></span></span><span data-slate-object="text" data-key="19980"><span data-slate-leaf="true" data-offset-key="19980:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19981"><span data-slate-leaf="true" data-offset-key="19981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">78.61</span></span></span></span><span data-slate-object="text" data-key="19982"><span data-slate-leaf="true" data-offset-key="19982:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19983"><span data-slate-object="text" data-key="19984"><span data-slate-leaf="true" data-offset-key="19984:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="19985"><span data-slate-leaf="true" data-offset-key="19985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-16</span></span></span></span><span data-slate-object="text" data-key="19986"><span data-slate-leaf="true" data-offset-key="19986:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="19987"><span data-slate-leaf="true" data-offset-key="19987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29722464</span></span></span></span><span data-slate-object="text" data-key="19988"><span data-slate-leaf="true" data-offset-key="19988:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19989"><span data-slate-leaf="true" data-offset-key="19989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">40.28</span></span></span></span><span data-slate-object="text" data-key="19990"><span data-slate-leaf="true" data-offset-key="19990:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19991"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19992"><span data-slate-object="text" data-key="19993"><span data-slate-leaf="true" data-offset-key="19993:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByAtomic</span></span></span><span data-slate-object="text" data-key="19994"><span data-slate-leaf="true" data-offset-key="19994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-32</span></span></span></span><span data-slate-object="text" data-key="19995"><span data-slate-leaf="true" data-offset-key="19995:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19996"><span data-slate-leaf="true" data-offset-key="19996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">58010497</span></span></span></span><span data-slate-object="text" data-key="19997"><span data-slate-leaf="true" data-offset-key="19997:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="19998"><span data-slate-leaf="true" data-offset-key="19998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20.40</span></span></span></span><span data-slate-object="text" data-key="19999"><span data-slate-leaf="true" data-offset-key="19999:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20000"><span data-slate-object="text" data-key="20001"><span data-slate-leaf="true" data-offset-key="20001:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByAtomic</span></span></span><span data-slate-object="text" data-key="20002"><span data-slate-leaf="true" data-offset-key="20002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-32</span></span></span></span><span data-slate-object="text" data-key="20003"><span data-slate-leaf="true" data-offset-key="20003:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="20004"><span data-slate-leaf="true" data-offset-key="20004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000000000</span></span></span></span><span data-slate-object="text" data-key="20005"><span data-slate-leaf="true" data-offset-key="20005:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="20006"><span data-slate-leaf="true" data-offset-key="20006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0.2402</span></span></span></span><span data-slate-object="text" data-key="20007"><span data-slate-leaf="true" data-offset-key="20007:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20008"><span data-slate-object="text" data-key="20009"><span data-slate-leaf="true" data-offset-key="20009:0" data-first-offset="true"><span data-slate-string="true">BenchmarkAddSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="20010"><span data-slate-leaf="true" data-offset-key="20010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-32</span></span></span></span><span data-slate-object="text" data-key="20011"><span data-slate-leaf="true" data-offset-key="20011:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="20012"><span data-slate-leaf="true" data-offset-key="20012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11748312</span></span></span></span><span data-slate-object="text" data-key="20013"><span data-slate-leaf="true" data-offset-key="20013:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="20014"><span data-slate-leaf="true" data-offset-key="20014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">93.15</span></span></span></span><span data-slate-object="text" data-key="20015"><span data-slate-leaf="true" data-offset-key="20015:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20016"><span data-slate-object="text" data-key="20017"><span data-slate-leaf="true" data-offset-key="20017:0" data-first-offset="true"><span data-slate-string="true">BenchmarkReadSyncByRWMutex</span></span></span><span data-slate-object="text" data-key="20018"><span data-slate-leaf="true" data-offset-key="20018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-32</span></span></span></span><span data-slate-object="text" data-key="20019"><span data-slate-leaf="true" data-offset-key="20019:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="20020"><span data-slate-leaf="true" data-offset-key="20020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29845912</span></span></span></span><span data-slate-object="text" data-key="20021"><span data-slate-leaf="true" data-offset-key="20021:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="20022"><span data-slate-leaf="true" data-offset-key="20022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">40.54</span></span></span></span><span data-slate-object="text" data-key="20023"><span data-slate-leaf="true" data-offset-key="20023:0" data-first-offset="true"><span data-slate-string="true"> ns/op</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20024"><span data-slate-object="text" data-key="20025"><span data-slate-leaf="true" data-offset-key="20025:0" data-first-offset="true"><span data-slate-string="true">通过这个运行结果，我们可以得出一些结论：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="20026"><div data-slate-type="list-line" data-slate-object="block" data-key="20027"><span data-slate-object="text" data-key="20028"><span data-slate-leaf="true" data-offset-key="20028:0" data-first-offset="true"><span data-slate-string="true">读写锁的性能随着并发量增大的情况，与前面讲解的 sync.RWMutex 一致；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="20029"><span data-slate-object="text" data-key="20030"><span data-slate-leaf="true" data-offset-key="20030:0" data-first-offset="true"><span data-slate-string="true">利用原子操作的无锁并发写的性能，随着并发量增大几乎保持恒定；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="20031"><span data-slate-object="text" data-key="20032"><span data-slate-leaf="true" data-offset-key="20032:0" data-first-offset="true"><span data-slate-string="true">利用原子操作的无锁并发读的性能，随着并发量增大有持续提升的趋势，并且性能是读锁的约 200 倍。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20033"><span data-slate-object="text" data-key="20034"><span data-slate-leaf="true" data-offset-key="20034:0" data-first-offset="true"><span data-slate-string="true">通过这些结论，我们大致可以看到 atomic 原子操作的特性：随着并发量提升，使用 atomic 实现的</span></span></span><span data-slate-object="text" data-key="20035"><span data-slate-leaf="true" data-offset-key="20035:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">共享变量</span></span></span></span><span data-slate-object="text" data-key="20036"><span data-slate-leaf="true" data-offset-key="20036:0" data-first-offset="true"><span data-slate-string="true">的并发读写性能表现更为稳定，尤其是原子读操作，和 sync 包中的读写锁原语比起来，atomic 表现出了更好的伸缩性和高性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20037"><span data-slate-object="text" data-key="20038"><span data-slate-leaf="true" data-offset-key="20038:0" data-first-offset="true"><span data-slate-string="true">由此，我们也可以看出 atomic 包更适合</span></span></span><span data-slate-object="text" data-key="20039"><span data-slate-leaf="true" data-offset-key="20039:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一些对性能十分敏感、并发量较大且读多写少的场合</span></span></span></span><span data-slate-object="text" data-key="20040"><span data-slate-leaf="true" data-offset-key="20040:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20041"><span data-slate-object="text" data-key="20042"><span data-slate-leaf="true" data-offset-key="20042:0" data-first-offset="true"><span data-slate-string="true">不过，</span></span><span data-slate-leaf="true" data-offset-key="20042:1"><span data-slate-object="annotation" data-annotation-key="gkann_2c742ed6" data-attr-id="36475" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">atomic 原子操作可用来同步的范围有比较大限制，只能同步一个整型变量或自定义类型变量。如果我们要对一个复杂的临界区数据进行同步，那么首选的依旧是 sync 包中的原语。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="20043" id="sr-toc-6"><span data-slate-object="text" data-key="20044"><span data-slate-leaf="true" data-offset-key="20044:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="20045"><span data-slate-object="text" data-key="20046"><span data-slate-leaf="true" data-offset-key="20046:0" data-first-offset="true"><span data-slate-string="true">好了，今天的课讲到这里就结束了，现在我们一起来回顾一下吧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20047"><span data-slate-object="text" data-key="20048"><span data-slate-leaf="true" data-offset-key="20048:0" data-first-offset="true"><span data-slate-string="true">虽然 Go 推荐基于通信来共享内存的并发设计风格，但 Go 并没有彻底抛弃对基于共享内存并发模型的支持，Go 通过标准库的 sync 包以及 atomic 包提供了低级同步原语。这些原语有着它们自己的应用场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20049"><span data-slate-object="text" data-key="20050"><span data-slate-leaf="true" data-offset-key="20050:0" data-first-offset="true"><span data-slate-string="true">如果我们考虑使用低级同步原语，一般都是因为低级同步原语可以提供</span></span></span><span data-slate-object="text" data-key="20051"><span data-slate-leaf="true" data-offset-key="20051:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">更佳的性能表现</span></span></span></span><span data-slate-object="text" data-key="20052"><span data-slate-leaf="true" data-offset-key="20052:0" data-first-offset="true"><span data-slate-string="true">，性能基准测试结果告诉我们，使用低级同步原语的性能可以高出 channel 许多倍。在性能敏感的场景下，我们依然离不开这些低级同步原语。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20053"><span data-slate-object="text" data-key="20054"><span data-slate-leaf="true" data-offset-key="20054:0" data-first-offset="true"><span data-slate-string="true">在使用 sync 包提供的同步原语之前，我们一定要牢记这些原语使用的注意事项：</span></span></span><span data-slate-object="text" data-key="20055"><span data-slate-leaf="true" data-offset-key="20055:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不要复制首次使用后的 Mutex/RWMutex/Cond 等</span></span></span></span><span data-slate-object="text" data-key="20056"><span data-slate-leaf="true" data-offset-key="20056:0" data-first-offset="true"><span data-slate-string="true">。一旦复制，你将很大可能得到意料之外的运行结果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20057"><span data-slate-object="text" data-key="20058"><span data-slate-leaf="true" data-offset-key="20058:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5701a849" data-attr-id="39339" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">sync 包中的低级同步原语各有各的擅长领域，你可以记住：</span></span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="20059"><div data-slate-type="list-line" data-slate-object="block" data-key="20060"><span data-slate-object="text" data-key="20061"><span data-slate-leaf="true" data-offset-key="20061:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_eff1f7ba" data-attr-id="39340" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在具有一定并发量且读多写少的场合使用 RWMutex；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="20062"><span data-slate-object="text" data-key="20063"><span data-slate-leaf="true" data-offset-key="20063:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_24d5efb8" data-attr-id="39341" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在需要 “等待某个条件成立” 的场景下使用 Cond；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="20064"><span data-slate-object="text" data-key="20065"><span data-slate-leaf="true" data-offset-key="20065:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e420e0fe" data-attr-id="39342" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">当你不确定使用什么原语时，那就使用 Mutex 吧。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20066"><span data-slate-object="text" data-key="20067"><span data-slate-leaf="true" data-offset-key="20067:0" data-first-offset="true"><span data-slate-string="true">如果你对同步的性能有极致要求，且并发量较大，读多写少，那么可以考虑一下 atomic 包提供的原子操作函数。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="20068" id="sr-toc-7"><span data-slate-object="text" data-key="20069"><span data-slate-leaf="true" data-offset-key="20069:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="20070"><span data-slate-object="text" data-key="20071"><span data-slate-leaf="true" data-offset-key="20071:0" data-first-offset="true"><span data-slate-string="true">使用基于共享内存的并发模型时，最令人头疼的可能就是 “死锁” 问题的存在了。你了解死锁的产生条件么？能编写一个程序模拟一下死锁的发生么？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20072"><span data-slate-object="text" data-key="20073"><span data-slate-leaf="true" data-offset-key="20073:0" data-first-offset="true"><span data-slate-string="true">欢迎你把这节课分享给更多对 Go 并发感兴趣的朋友。我是 Tony Bai，我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>20</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-8">精选留言 (14)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>罗杰</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>连续三节课都是需要花费 30 分钟才能阅读完，即使是复习也要超过 20 分钟，这几节的内容真的好充实。</div><div><p>作者回复: 👍</p></div><div><div>2022-01-14</div><div><div><i></i><span>6</span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eoibQLsjsrjiasFUaPdjib95Jk4y3ZMD6zXyEud7bCvibrjrPia3RCib0zTD7MahQJ41icOicIWXfbq8JpnGQ/132"></div></div><div><div><div><span> 步比天下</span></div></div><div>老师，我想问个低级的问题，什么是临界区啊，不太懂</div><div><p>作者回复：临界区其实就是一个代码片段。但这个代码片段中有共享的数据，这些数据不支持多个 goroutine 的并发访问，只能通过像 channel、锁等机制同步各个 goroutine 的访问。同一时间，只能有一个 goroutine 访问这段代码，修改或读取这段代码所共享的数据。</p></div><div><div>2022-01-16</div><div><div><i></i><span>3</span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Calvin</span></div></div><div>思考题：
死锁产生的 4 个必要条件：1) 不可剥夺；2) 请求与保持；3) 循环等待；4) 互斥。

以下模块程序会发生死锁，报 fatal error: all goroutines are asleep - deadlock!

func op1 (mu1, mu2 *sync.Mutex, wg *sync.WaitGroup) {
	mu1.Lock ()
	time.Sleep (1 * time.Second)
	mu2.Lock ()
	println ("op1: do something...")
	mu2.Unlock ()
	mu1.Unlock ()
	wg.Done ()
}

func op2 (mu1, mu2 *sync.Mutex, wg *sync.WaitGroup) {
	mu2.Lock ()
	time.Sleep (2 * time.Second)
	mu1.Lock ()
	println ("op2: do something...")
	mu1.Unlock ()
	mu2.Unlock ()
	wg.Done ()
}

func TestDeadLock (t *testing.T) {
	var mu1 sync.Mutex
	var mu2 sync.Mutex

	var wg sync.WaitGroup
	wg.Add (2)
	go op1 (&amp;mu1, &amp;mu2, &amp;wg)
	go op2 (&amp;mu1, &amp;mu2, &amp;wg)
	wg.Wait ()
}</div><div><p>作者回复: 👍</p></div><div><div>2022-01-15</div><div><div><i></i><span>4</span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/1d/de/62bfa83f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>aoe</span></div></div><div>读到这里，明白了 Go 的并发不是万能的！
1. Go 基于 Tony Hoare 的 CSP 并发模型理论，实现了 Goroutine、channel 等并发原语；
2. 使用低级同步原语（标准库的 sync 包以及 atomic 包提供了低级同步原语：Mutex/RWMutex/Cond 等）的性能可以高出 channel 许多倍
3. 有锁的地方就有江湖，高并发下的性能主要拼的是算法，没有一门语言有压倒性优势</div><div><p>作者回复: 👍</p></div><div><div>2022-01-18</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/20/e2/d7/8e2e0579.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_62c21a</span></div></div><div>老师，有两个问题请教您
1，wg.Done () 是不是在函数开始的地方写成 defer wg.Done () 会好点呢？
2，条件变量 broadcast 的时候，以下两种写法有区别吗？
第一种：
groupSignal.L.Lock () 
ready = true 
groupSignal.Broadcast ()
groupSignal.L.Unlock ()
第二种：
groupSignal.L.Lock () 
ready = true 
groupSignal.L.Unlock ()
groupSignal.Broadcast ()</div><div><p>作者回复: 1. 可以的。
2. 虽然 Broadcast 的参考文档也提到了：It is allowed but not required for the caller to hold c.L during the call. 对于例子来说两种写法都是 ok 的。但条件变量的测试条件表达式，比如本例子中的 ready 最好是始终在 lock 的保护下的。所以这里我建议用了第一种。否则在复杂的场景下，一旦 unlock，条件变量测试表达式 就不受控了。</p></div><div><div>2022-04-25</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Calvin</span></div></div><div>老师，Go 中没有可重入的锁吗？</div><div><p>作者回复：没有。Go 团队认为递归锁或可重入锁是一个 bad idea，所以不支持。</p></div><div><div>2022-01-15</div><div><div><i></i><span>9</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Calvin</span></div></div><div>老师，sync 包中还有其他的一些同步原语，后面会继续说下吗？比如前面课程和本节课中都有使用到的 sync.WaitGroup 就没有说到，直接就使用上了，另外还有 sync.Map，sync.Pool 等。</div><div><p>作者回复：好问题👍！虽然都在 sync 包中，但 sync.WaitGroup,Map，Pool 层级更 high 一些，是基于 Mutex、RWMutex 和 Cond 这三个基本原语之上实现的机制。考虑到篇幅，这里 focus Mutex、RWMutex 和 Cond 这几个基本的原语结构了。至于 “sync.WaitGroup 就没有说到，直接就使用上了”， 一是用起来很简单，二是有些时候不得不用，没有可替代手段😁。</p></div><div><div>2022-01-15</div><div><div><i></i><span>4</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/84/13/9570f522.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 非梧桐不止</span></div></div><div>老师，既然共享内存的性能比 channel 好，为什么 Go 倡导用通信去共享内存呢？</div><div><p>作者回复：多数情况下，对性能没有那么高要求，采用基于 csp 模型的并发设计是主流。</p></div><div><div>2022-05-27</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/03/c5/600fd645.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>tianbingJ</span></div></div><div>请问老师，atomic.LoadInt64 (&amp;x)  和直接读取 x 的区别是什么？ 这里怎么体现 atomic 呢？</div><div><p>作者回复：在并发的情况下，采用直接读取 x 的方式读取到的不一定是 x 的最新值。</p></div><div><div>2022-03-31</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2a/f9/73/01eafd3c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>singularity of space time</span></div></div><div>老师，请问一下 Go 在没有 volatile 的情况下如何保证共享变量在不同 Goroutine 的可见性？如果可见性不能保证的话，那么 CAS 的正确性应该也不能保证吧？还是说 CAS 内部的实现已经保证了可见性呢？</div><div><p>作者回复: Go 中没有 volatile。但 go 给出了自己的 memory model，https://go.dev/ref/mem 这个也许能回答你的问题。</p></div><div><div>2022-02-06</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/5c/da/0a8bc27b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>文经</span></div></div><div>白老师，我觉得条件变量的例子完全可以用 channel 来实现，代码逻辑还会更简单一些。
使用条件变量，跟 Mutex 一样，是基于性能的考虑吗？</div><div><p>作者回复：你的想法没错。但条件变量的性能我还真没有和 channel 对比过，介绍条件变量只是为了给大家 “科普” 一下它的存在和适合的场景。说实话，条件变量使用的很少。</p></div><div><div>2022-01-21</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/5c/da/0a8bc27b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 文经</span></div></div><div>白老师：
“atomic 原子操作可用来同步的范围有比较大限制，只能同步一个整型变量或自定义类型变量。如果我们要对一个复杂的临界区数据进行同步，那么首选的依旧是 sync 包中的原语。”
这里说的整型变量和自定义类型变量，是不是可以理解为一个字长的大小。在 64 位 cpu 上就是 8 个字节。因为 CPU 通过数据总线，一次从内存中最多只能获取一个字长的信息。所以 atomic 的限制也是一个字长。</div><div><p>作者回复：你说的没错，无论整型变量和自定义类型变量，atomic 的操作实质上针对的都是字长长度的指针。但我说的复杂临界区，还有另外一个情况，那就是在锁内部有着对数据的更为复杂的判断与操作，而不仅仅是 + n,-n, 或 cas。</p></div><div><div>2022-01-21</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lesserror</span></div></div><div>关于 Go 的并发，内容挺多的。专门讲 Go 并发编程的书籍都有不少。大白老师这里带领我们通俗易懂地入门了。另有几个小问题。

1. 文中说：“甚至，如果拷贝的时机不对，比如在一个 mutex 处于 locked 的状态时对它进行了拷贝，就会对副本进行加锁操作，将导致加锁的 Goroutine 永远阻塞下去。”  这里不是互不相关吗？ 为什么还会对副本加锁呢？

2. 另外，好像也没讲到空结构体在 channel 中传递的好处？ 

3.  $GOROOT/src/runtime/internal/asm_amd64.s 这个文件未找到（Mac Book 上面）。</div><div><p>作者回复: 1. 当原 mutex 出于加锁状态时被 copy，copy 后的 mutex 本身就是加锁状态，后者被使用时就会被阻塞。
2. 记得之前的某讲里提到过
3. 路径的确不对，应该是 $GOROOT/src/runtime/internal/atomic/asm_amd64.s , 后续让编辑老师更新一下。</p></div><div><div>2022-01-20</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/46/15/0f215f66.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>BinyGo</span></div></div><div>并发每篇都干货满满，3 刷 4 刷都还没完全消化完，加油～</div><div><p>作者回复: 👍</p></div><div><div>2022-01-15</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1a"><outline class="toc-level-h1" data-reactid=".1a.0" style="width: 175px;"><active data-reactid=".1a.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1a.0.1"><span data-reactid=".1a.0.1.0"> 34｜并发：如何使用共享变量？</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.1" style="width: 165px;"><active data-reactid=".1a.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1a.1.1"><span data-reactid=".1a.1.1.0">sync 包低级同步原语可以用在哪？</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.2" style="width: 165px;"><active data-reactid=".1a.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1a.2.1"><span data-reactid=".1a.2.1.0">sync 包中同步原语使用的注意事项</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.3" style="width: 165px;"><active data-reactid=".1a.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1a.3.1"><span data-reactid=".1a.3.1.0">互斥锁（Mutex）还是读写锁（RWMutex）？</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.4" style="width: 165px;"><active data-reactid=".1a.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1a.4.1"><span data-reactid=".1a.4.1.0">条件变量</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.5" style="width: 165px;"><active data-reactid=".1a.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1a.5.1"><span data-reactid=".1a.5.1.0">原子操作（atomic operations）</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.6" style="width: 165px;"><active data-reactid=".1a.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1a.6.1"><span data-reactid=".1a.6.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.7" style="width: 165px;"><active data-reactid=".1a.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1a.7.1"><span data-reactid=".1a.7.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.8" style="width: 165px;"><active data-reactid=".1a.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1a.8.1"><span data-reactid=".1a.8.1.0">精选留言 (14)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/478192" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>