
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 16 | TopicDeletionManager： Topic 是怎么被删除的？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>16 | TopicDeletionManager： Topic 是怎么被删除的？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">16 | TopicDeletionManager： Topic 是怎么被删除的？</h1><div><span>胡夕</span> <span> 2020-05-28</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1b/f2/1b1bf0d2a891c80a46c41f956979aaf2.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：18.40M</span><span> 时长：20:05</span></div></div><audio title="16 | TopicDeletionManager： Topic是怎么被删除的？" src="https://res001.geekbang.org//media/audio/9f/22/9fdf4de216c6431cc1324361c5132222/ld/ld.m3u8" __idm_id__="49171"></audio></div><div><div><div><div data-slate-editor="true" data-key="17475" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="17476"><span data-slate-object="text" data-key="17477"><span data-slate-leaf="true" data-offset-key="17477:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。今天，我们正式进入到第四大模块 “状态机” 的学习。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17478"><span data-slate-object="text" data-key="17479"><span data-slate-leaf="true" data-offset-key="17479:0" data-first-offset="true"><span data-slate-string="true">Kafka 源码中有很多状态机和管理器，比如之前我们学过的 Controller 通道管理器 ControllerChannelManager、处理 Controller 事件的 ControllerEventManager，等等。这些管理器和状态机，大多与各自的 “宿主” 组件关系密切，可以说是大小不同、功能各异。就比如 Controller 的这两个管理器，必须要与 Controller 组件紧耦合在一起才能实现各自的功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17480"><span data-slate-object="text" data-key="17481"><span data-slate-leaf="true" data-offset-key="17481:0" data-first-offset="true"><span data-slate-string="true">不过，Kafka 中还是有一些状态机和管理器具有相对独立的功能框架，不严重依赖使用方，也就是我在这个模块为你精选的 TopicDeletionManager（主题删除管理器）、ReplicaStateMachine（副本状态机）和 PartitionStateMachine（分区状态机）。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17482"><div data-slate-type="list-line" data-slate-object="block" data-key="17483"><span data-slate-object="text" data-key="17484"><span data-slate-leaf="true" data-offset-key="17484:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager：负责对指定 Kafka 主题执行删除操作，清除待删除主题在集群上的各类 “痕迹”。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17485"><span data-slate-object="text" data-key="17486"><span data-slate-leaf="true" data-offset-key="17486:0" data-first-offset="true"><span data-slate-string="true">ReplicaStateMachine：负责定义 Kafka 副本状态、合法的状态转换，以及管理状态之间的转换。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17487"><span data-slate-object="text" data-key="17488"><span data-slate-leaf="true" data-offset-key="17488:0" data-first-offset="true"><span data-slate-string="true">PartitionStateMachine：负责定义 Kafka 分区状态、合法的状态转换，以及管理状态之间的转换。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17489"><span data-slate-object="text" data-key="17490"><span data-slate-leaf="true" data-offset-key="17490:0" data-first-offset="true"><span data-slate-string="true">无论是主题、分区，还是副本，它们在 Kafka 中的生命周期通常都有多个状态。而这 3 个状态机，就是来管理这些状态的。而如何实现正确、高效的管理，就是源码要解决的核心问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17491"><span data-slate-object="text" data-key="17492"><span data-slate-leaf="true" data-offset-key="17492:0" data-first-offset="true"><span data-slate-string="true">今天，我们先来学习 TopicDeletionManager，看一下 Kafka 是如何删除一个主题的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17493" id="sr-toc-1"><span data-slate-object="text" data-key="17494"><span data-slate-leaf="true" data-offset-key="17494:0" data-first-offset="true"><span data-slate-string="true">课前导读</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17495"><span data-slate-object="text" data-key="17496"><span data-slate-leaf="true" data-offset-key="17496:0" data-first-offset="true"><span data-slate-string="true">刚开始学习 Kafka 的时候，我对 Kafka 删除主题的认识非常 “浅薄”。之前我以为成功执行了 kafka-topics.sh --delete 命令后，主题就会被删除。我相信，很多人可能都有过这样的错误理解。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17497"><span data-slate-object="text" data-key="17498"><span data-slate-leaf="true" data-offset-key="17498:0" data-first-offset="true"><span data-slate-string="true">这种不正确的认知产生的一个结果就是，我们经常发现主题没有被删除干净。于是，网上流传着一套终极 “武林秘籍”：手动删除磁盘上的日志文件，以及手动删除 ZooKeeper 下关于主题的各个节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17499"><span data-slate-object="text" data-key="17500"><span data-slate-leaf="true" data-offset-key="17500:0" data-first-offset="true"><span data-slate-string="true">就我个人而言，我始终不推荐你使用这套 “秘籍”，理由有二：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17501"><div data-slate-type="list-line" data-slate-object="block" data-key="17502"><span data-slate-object="text" data-key="17503"><span data-slate-leaf="true" data-offset-key="17503:0" data-first-offset="true"><span data-slate-string="true">它并不完整。事实上，除非你重启 Broker，否则，这套 “秘籍” 无法清理 Controller 端和各个 Broker 上元数据缓存中的待删除主题的相关条目。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17504"><span data-slate-object="text" data-key="17505"><span data-slate-leaf="true" data-offset-key="17505:0" data-first-offset="true"><span data-slate-string="true">它并没有被官方所认证，换句话说就是后果自负。从某种程度上说，它会带来什么不好的结果，是你没法把控的。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17506"><span data-slate-object="text" data-key="17507"><span data-slate-leaf="true" data-offset-key="17507:0" data-first-offset="true"><span data-slate-string="true">所谓 “本事大不如不摊上”，我们与其琢磨删除主题失败之后怎么自救，不如踏踏实实地研究下 Kafka 底层是怎么执行这个操作的。搞明白它的原理之后，再有针对性地使用 “秘籍”，才能做到有的放矢。你说是不是？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17508" id="sr-toc-2"><span data-slate-object="text" data-key="17509"><span data-slate-leaf="true" data-offset-key="17509:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager 概览</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17510"><span data-slate-object="text" data-key="17511"><span data-slate-leaf="true" data-offset-key="17511:0" data-first-offset="true"><span data-slate-string="true">好了，我们就正式开始学习 TopicDeletionManager 吧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17512"><span data-slate-object="text" data-key="17513"><span data-slate-leaf="true" data-offset-key="17513:0" data-first-offset="true"><span data-slate-string="true">这个管理器位于 kafka.controller 包下，文件名是 TopicDeletionManager.scala。在总共不到 400 行的源码中，它定义了 3 个类结构以及 20 多个方法。总体而言，它还是比较容易学习的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17514"><span data-slate-object="text" data-key="17515"><span data-slate-leaf="true" data-offset-key="17515:0" data-first-offset="true"><span data-slate-string="true">为了让你先有个感性认识，我画了一张 TopicDeletionManager.scala 的代码 UML 图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17516"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/52/f9/52032b5ccf820b10090b5a4ad78d8ff9.jpg?wh=3208*2957"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17517"><span data-slate-object="text" data-key="17518"><span data-slate-leaf="true" data-offset-key="17518:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager.scala 这个源文件，包括 3 个部分。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17519"><div data-slate-type="list-line" data-slate-object="block" data-key="17520"><span data-slate-object="text" data-key="17521"><span data-slate-leaf="true" data-offset-key="17521:0" data-first-offset="true"><span data-slate-string="true">DeletionClient 接口：负责实现删除主题以及后续的动作，比如更新元数据等。这个接口里定义了 4 个方法，分别是 deleteTopic、deleteTopicDeletions、mutePartitionModifications 和 sendMetadataUpdate。我们后面再详细学习它们的代码。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17522"><span data-slate-object="text" data-key="17523"><span data-slate-leaf="true" data-offset-key="17523:0" data-first-offset="true"><span data-slate-string="true">ControllerDeletionClient 类：实现 DeletionClient 接口的类，分别实现了刚刚说到的那 4 个方法。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17524"><span data-slate-object="text" data-key="17525"><span data-slate-leaf="true" data-offset-key="17525:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager 类：主题删除管理器类，定义了若干个方法维护主题删除前后集群状态的正确性。比如，什么时候才能删除主题、什么时候主题不能被删除、主题删除过程中要规避哪些操作，等等。</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17526" id="sr-toc-3"><span data-slate-object="text" data-key="17527"><span data-slate-leaf="true" data-offset-key="17527:0" data-first-offset="true"><span data-slate-string="true">DeletionClient 接口及其实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17528"><span data-slate-object="text" data-key="17529"><span data-slate-leaf="true" data-offset-key="17529:0" data-first-offset="true"><span data-slate-string="true">接下来，我们逐一讨论下这 3 部分。首先是 DeletionClient 接口及其实现类。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17530"><span data-slate-object="text" data-key="17531"><span data-slate-leaf="true" data-offset-key="17531:0" data-first-offset="true"><span data-slate-string="true">就像前面说的，DeletionClient 接口定义的方法用于删除主题，并将删除主题这件事儿同步给其他 Broker。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17532"><span data-slate-object="text" data-key="17533"><span data-slate-leaf="true" data-offset-key="17533:0" data-first-offset="true"><span data-slate-string="true">目前，DeletionClient 这个接口只有一个实现类，即 ControllerDeletionClient。我们看下这个实现类的代码：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="17534"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17535"><span data-slate-object="text" data-key="17536"><span data-slate-leaf="true" data-offset-key="17536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="17537"><span data-slate-leaf="true" data-offset-key="17537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17538"><span data-slate-leaf="true" data-offset-key="17538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerDeletionClient</span></span></span></span></span><span data-slate-object="text" data-key="17539"><span data-slate-leaf="true" data-offset-key="17539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(controller: KafkaController, zkClient: KafkaZkClient)</span></span></span></span></span><span data-slate-object="text" data-key="17540"><span data-slate-leaf="true" data-offset-key="17540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> extends DeletionClient </span></span></span></span><span data-slate-object="text" data-key="17541"><span data-slate-leaf="true" data-offset-key="17541:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17542"><span data-slate-object="text" data-key="17543"><span data-slate-leaf="true" data-offset-key="17543:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17544"><span data-slate-leaf="true" data-offset-key="17544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除给定主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17545"><span data-slate-object="text" data-key="17546"><span data-slate-leaf="true" data-offset-key="17546:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17547"><span data-slate-leaf="true" data-offset-key="17547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="17548"><span data-slate-leaf="true" data-offset-key="17548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="17549"><span data-slate-leaf="true" data-offset-key="17549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopic</span></span></span></span></span><span data-slate-object="text" data-key="17550"><span data-slate-leaf="true" data-offset-key="17550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topic: String, epochZkVersion: Int)</span></span></span></span></span><span data-slate-object="text" data-key="17551"><span data-slate-leaf="true" data-offset-key="17551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="17552"><span data-slate-leaf="true" data-offset-key="17552:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17553"><span data-slate-object="text" data-key="17554"><span data-slate-leaf="true" data-offset-key="17554:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17555"><span data-slate-leaf="true" data-offset-key="17555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除 /brokers/topics/&lt;topic&gt; 节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17556"><span data-slate-object="text" data-key="17557"><span data-slate-leaf="true" data-offset-key="17557:0" data-first-offset="true"><span data-slate-string="true">    zkClient.</span></span></span><span data-slate-object="text" data-key="17558"><span data-slate-leaf="true" data-offset-key="17558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopicZNode</span></span></span></span><span data-slate-object="text" data-key="17559"><span data-slate-leaf="true" data-offset-key="17559:0" data-first-offset="true"><span data-slate-string="true">(topic, epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17560"><span data-slate-object="text" data-key="17561"><span data-slate-leaf="true" data-offset-key="17561:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17562"><span data-slate-leaf="true" data-offset-key="17562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除 /config/topics/&lt;topic&gt; 节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17563"><span data-slate-object="text" data-key="17564"><span data-slate-leaf="true" data-offset-key="17564:0" data-first-offset="true"><span data-slate-string="true">    zkClient.</span></span></span><span data-slate-object="text" data-key="17565"><span data-slate-leaf="true" data-offset-key="17565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopicConfigs</span></span></span></span><span data-slate-object="text" data-key="17566"><span data-slate-leaf="true" data-offset-key="17566:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17567"><span data-slate-leaf="true" data-offset-key="17567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Seq</span></span></span></span><span data-slate-object="text" data-key="17568"><span data-slate-leaf="true" data-offset-key="17568:0" data-first-offset="true"><span data-slate-string="true">(topic), epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17569"><span data-slate-object="text" data-key="17570"><span data-slate-leaf="true" data-offset-key="17570:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17571"><span data-slate-leaf="true" data-offset-key="17571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除 /admin/delete_topics/&lt;topic&gt; 节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17572"><span data-slate-object="text" data-key="17573"><span data-slate-leaf="true" data-offset-key="17573:0" data-first-offset="true"><span data-slate-string="true">    zkClient.</span></span></span><span data-slate-object="text" data-key="17574"><span data-slate-leaf="true" data-offset-key="17574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopicDeletions</span></span></span></span><span data-slate-object="text" data-key="17575"><span data-slate-leaf="true" data-offset-key="17575:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17576"><span data-slate-leaf="true" data-offset-key="17576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Seq</span></span></span></span><span data-slate-object="text" data-key="17577"><span data-slate-leaf="true" data-offset-key="17577:0" data-first-offset="true"><span data-slate-string="true">(topic), epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17578"><span data-slate-object="text" data-key="17579"><span data-slate-leaf="true" data-offset-key="17579:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17580"><span data-slate-object="text" data-key="17581"><span data-slate-leaf="true" data-offset-key="17581:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17582"><span data-slate-leaf="true" data-offset-key="17582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除 /admin/delete_topics 下的给定 topic 子节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17583"><span data-slate-object="text" data-key="17584"><span data-slate-leaf="true" data-offset-key="17584:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17585"><span data-slate-leaf="true" data-offset-key="17585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="17586"><span data-slate-leaf="true" data-offset-key="17586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="17587"><span data-slate-leaf="true" data-offset-key="17587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopicDeletions</span></span></span></span></span><span data-slate-object="text" data-key="17588"><span data-slate-leaf="true" data-offset-key="17588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topics: Seq[String], epochZkVersion: Int)</span></span></span></span></span><span data-slate-object="text" data-key="17589"><span data-slate-leaf="true" data-offset-key="17589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="17590"><span data-slate-leaf="true" data-offset-key="17590:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17591"><span data-slate-object="text" data-key="17592"><span data-slate-leaf="true" data-offset-key="17592:0" data-first-offset="true"><span data-slate-string="true">    zkClient.</span></span></span><span data-slate-object="text" data-key="17593"><span data-slate-leaf="true" data-offset-key="17593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopicDeletions</span></span></span></span><span data-slate-object="text" data-key="17594"><span data-slate-leaf="true" data-offset-key="17594:0" data-first-offset="true"><span data-slate-string="true">(topics, epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17595"><span data-slate-object="text" data-key="17596"><span data-slate-leaf="true" data-offset-key="17596:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17597"><span data-slate-object="text" data-key="17598"><span data-slate-leaf="true" data-offset-key="17598:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17599"><span data-slate-leaf="true" data-offset-key="17599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消 /brokers/topics/&lt;topic&gt; 节点数据变更的监听</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17600"><span data-slate-object="text" data-key="17601"><span data-slate-leaf="true" data-offset-key="17601:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17602"><span data-slate-leaf="true" data-offset-key="17602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="17603"><span data-slate-leaf="true" data-offset-key="17603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="17604"><span data-slate-leaf="true" data-offset-key="17604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutePartitionModifications</span></span></span></span></span><span data-slate-object="text" data-key="17605"><span data-slate-leaf="true" data-offset-key="17605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topic: String)</span></span></span></span></span><span data-slate-object="text" data-key="17606"><span data-slate-leaf="true" data-offset-key="17606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="17607"><span data-slate-leaf="true" data-offset-key="17607:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17608"><span data-slate-object="text" data-key="17609"><span data-slate-leaf="true" data-offset-key="17609:0" data-first-offset="true"><span data-slate-string="true">    controller.</span></span></span><span data-slate-object="text" data-key="17610"><span data-slate-leaf="true" data-offset-key="17610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unregisterPartitionModificationsHandlers</span></span></span></span><span data-slate-object="text" data-key="17611"><span data-slate-leaf="true" data-offset-key="17611:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17612"><span data-slate-leaf="true" data-offset-key="17612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Seq</span></span></span></span><span data-slate-object="text" data-key="17613"><span data-slate-leaf="true" data-offset-key="17613:0" data-first-offset="true"><span data-slate-string="true">(topic))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17614"><span data-slate-object="text" data-key="17615"><span data-slate-leaf="true" data-offset-key="17615:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17616"><span data-slate-object="text" data-key="17617"><span data-slate-leaf="true" data-offset-key="17617:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17618"><span data-slate-leaf="true" data-offset-key="17618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向集群 Broker 发送指定分区的元数据更新请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17619"><span data-slate-object="text" data-key="17620"><span data-slate-leaf="true" data-offset-key="17620:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17621"><span data-slate-leaf="true" data-offset-key="17621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="17622"><span data-slate-leaf="true" data-offset-key="17622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="17623"><span data-slate-leaf="true" data-offset-key="17623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendMetadataUpdate</span></span></span></span></span><span data-slate-object="text" data-key="17624"><span data-slate-leaf="true" data-offset-key="17624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(partitions: Set[TopicPartition])</span></span></span></span></span><span data-slate-object="text" data-key="17625"><span data-slate-leaf="true" data-offset-key="17625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="17626"><span data-slate-leaf="true" data-offset-key="17626:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17627"><span data-slate-object="text" data-key="17628"><span data-slate-leaf="true" data-offset-key="17628:0" data-first-offset="true"><span data-slate-string="true">    controller.</span></span></span><span data-slate-object="text" data-key="17629"><span data-slate-leaf="true" data-offset-key="17629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendUpdateMetadataRequest</span></span></span></span><span data-slate-object="text" data-key="17630"><span data-slate-leaf="true" data-offset-key="17630:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17631"><span data-slate-object="text" data-key="17632"><span data-slate-leaf="true" data-offset-key="17632:0" data-first-offset="true"><span data-slate-string="true">      controller.controllerContext.liveOrShuttingDownBrokerIds.toSeq, partitions)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17633"><span data-slate-object="text" data-key="17634"><span data-slate-leaf="true" data-offset-key="17634:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17635"><span data-slate-object="text" data-key="17636"><span data-slate-leaf="true" data-offset-key="17636:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17637"><span data-slate-object="text" data-key="17638"><span data-slate-leaf="true" data-offset-key="17638:0" data-first-offset="true"><span data-slate-string="true">这个类的构造函数接收两个字段。同时，由于是 DeletionClient 接口的实现类，因而该类实现了 DeletionClient 接口定义的四个方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17639"><span data-slate-object="text" data-key="17640"><span data-slate-leaf="true" data-offset-key="17640:0" data-first-offset="true"><span data-slate-string="true">先来说构造函数的两个字段：KafkaController 实例和 KafkaZkClient 实例。KafkaController 实例，我们已经很熟悉了，就是 Controller 组件对象；而 KafkaZkClient 实例，就是 Kafka 与 ZooKeeper 交互的客户端对象。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17641"><span data-slate-object="text" data-key="17642"><span data-slate-leaf="true" data-offset-key="17642:0" data-first-offset="true"><span data-slate-string="true">接下来，我们再结合代码看下 DeletionClient 接口实现类 ControllerDeletionClient 定义的 4 个方法。我来简单介绍下这 4 个方法大致是做什么的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17643"><span data-slate-object="text" data-key="17644"><span data-slate-leaf="true" data-offset-key="17644:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">1.deleteTopic</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17645"><span data-slate-object="text" data-key="17646"><span data-slate-leaf="true" data-offset-key="17646:0" data-first-offset="true"><span data-slate-string="true">它用于删除主题在 ZooKeeper 上的所有 “痕迹”。具体方法是，分别调用 KafkaZkClient 的 3 个方法去删除 ZooKeeper 下 /brokers/topics/</span></span></span><span data-slate-object="text" data-key="17647"><span data-slate-leaf="true" data-offset-key="17647:0" data-first-offset="true"><span data-slate-string="true"> 节点、/config/topics/</span></span></span><span data-slate-object="text" data-key="17648"><span data-slate-leaf="true" data-offset-key="17648:0" data-first-offset="true"><span data-slate-string="true"> 节点和 /admin/delete_topics/</span></span></span><span data-slate-object="text" data-key="17649"><span data-slate-leaf="true" data-offset-key="17649:0" data-first-offset="true"><span data-slate-string="true"> 节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17650"><span data-slate-object="text" data-key="17651"><span data-slate-leaf="true" data-offset-key="17651:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">2.deleteTopicDeletions</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17652"><span data-slate-object="text" data-key="17653"><span data-slate-leaf="true" data-offset-key="17653:0" data-first-offset="true"><span data-slate-string="true">它用于删除 ZooKeeper 下待删除主题的标记节点。具体方法是，调用 KafkaZkClient 的 deleteTopicDeletions 方法，批量删除一组主题在 /admin/delete_topics 下的子节点。注意，deleteTopicDeletions 这个方法名结尾的 Deletions，表示 /admin/delete_topics 下的子节点。所以，deleteTopic 是删除主题，deleteTopicDeletions 是删除 /admin/delete_topics 下的对应子节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17654"><span data-slate-object="text" data-key="17655"><span data-slate-leaf="true" data-offset-key="17655:0" data-first-offset="true"><span data-slate-string="true">到这里，我们还要注意的一点是，这两个方法里都有一个 epochZkVersion 的字段，代表期望的 Controller Epoch 版本号。如果你使用一个旧的 Epoch 版本号执行这些方法，ZooKeeper 会拒绝，因为和它自己保存的版本号不匹配。</span></span><span data-slate-leaf="true" data-offset-key="17655:1"><span data-slate-object="annotation" data-annotation-key="gkann_c4b3bf6c" data-attr-id="32484" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果一个 Controller 的 Epoch 值小于 ZooKeeper 中保存的，</span></span></span><span data-slate-leaf="true" data-offset-key="17655:2"><span data-slate-string="true">那么这个 Controller 很可能是已经过期的 Controller。这种 Controller 就被称为 Zombie Controller。epochZkVersion 字段的作用，就是隔离 Zombie Controller 发送的操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17656"><span data-slate-object="text" data-key="17657"><span data-slate-leaf="true" data-offset-key="17657:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">3.mutePartitionModifications</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17658"><span data-slate-object="text" data-key="17659"><span data-slate-leaf="true" data-offset-key="17659:0" data-first-offset="true"><span data-slate-string="true">它的作用是屏蔽主题分区数据变更监听器，具体实现原理其实就是取消 /brokers/topics/</span></span></span><span data-slate-object="text" data-key="17660"><span data-slate-leaf="true" data-offset-key="17660:0" data-first-offset="true"><span data-slate-string="true"> 节点数据变更的监听。这样当该主题的分区数据发生变更后，由于对应的 ZooKeeper 监听器已经被取消了，因此不会触发 Controller 相应的处理逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17661"><span data-slate-object="text" data-key="17662"><span data-slate-leaf="true" data-offset-key="17662:0" data-first-offset="true"><span data-slate-string="true">那为什么要取消这个监听器呢？其实，主要是为了避免操作之间的相互干扰。设想下，用户 A 发起了主题删除，而同时用户 B 为这个主题新增了分区。此时，这两个操作就会相互冲突，如果允许 Controller 同时处理这两个操作，势必会造成逻辑上的混乱以及状态的不一致。为了应对这种情况，在移除主题副本和分区对象前，代码要先执行这个方法，以确保不再响应用户对该主题的其他操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17663"><span data-slate-object="text" data-key="17664"><span data-slate-leaf="true" data-offset-key="17664:0" data-first-offset="true"><span data-slate-string="true">mutePartitionModifications 方法的实现原理很简单，它会调用 unregisterPartitionModificationsHandlers，并接着调用 KafkaZkClient 的 unregisterZNodeChangeHandler 方法，取消 ZooKeeper 上对给定主题的分区节点数据变更的监听。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17665"><span data-slate-object="text" data-key="17666"><span data-slate-leaf="true" data-offset-key="17666:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">4.sendMetadataUpdate</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17667"><span data-slate-object="text" data-key="17668"><span data-slate-leaf="true" data-offset-key="17668:0" data-first-offset="true"><span data-slate-string="true">它会调用 KafkaController 的 sendUpdateMetadataRequest 方法，给集群所有 Broker 发送更新请求，告诉它们不要再为已删除主题的分区提供服务。代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="17669"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17670"><span data-slate-object="text" data-key="17671"><span data-slate-leaf="true" data-offset-key="17671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="17672"><span data-slate-leaf="true" data-offset-key="17672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="17673"><span data-slate-leaf="true" data-offset-key="17673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendMetadataUpdate</span></span></span></span></span><span data-slate-object="text" data-key="17674"><span data-slate-leaf="true" data-offset-key="17674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(partitions: Set[TopicPartition])</span></span></span></span></span><span data-slate-object="text" data-key="17675"><span data-slate-leaf="true" data-offset-key="17675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="17676"><span data-slate-leaf="true" data-offset-key="17676:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17677"><span data-slate-object="text" data-key="17678"><span data-slate-leaf="true" data-offset-key="17678:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17679"><span data-slate-leaf="true" data-offset-key="17679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 给集群所有 Broker 发送 UpdateMetadataRequest</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17680"><span data-slate-object="text" data-key="17681"><span data-slate-leaf="true" data-offset-key="17681:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17682"><span data-slate-leaf="true" data-offset-key="17682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通知它们给定 partitions 的状态变化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17683"><span data-slate-object="text" data-key="17684"><span data-slate-leaf="true" data-offset-key="17684:0" data-first-offset="true"><span data-slate-string="true">  controller.</span></span></span><span data-slate-object="text" data-key="17685"><span data-slate-leaf="true" data-offset-key="17685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendUpdateMetadataRequest</span></span></span></span><span data-slate-object="text" data-key="17686"><span data-slate-leaf="true" data-offset-key="17686:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17687"><span data-slate-object="text" data-key="17688"><span data-slate-leaf="true" data-offset-key="17688:0" data-first-offset="true"><span data-slate-string="true">    controller.controllerContext.liveOrShuttingDownBrokerIds.toSeq, partitions)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17689"><span data-slate-object="text" data-key="17690"><span data-slate-leaf="true" data-offset-key="17690:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17691"><span data-slate-object="text" data-key="17692"><span data-slate-leaf="true" data-offset-key="17692:0" data-first-offset="true"><span data-slate-string="true">该方法会给集群中的所有 Broker 发送更新元数据请求，告知它们要同步给定分区的状态。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17693" id="sr-toc-4"><span data-slate-object="text" data-key="17694"><span data-slate-leaf="true" data-offset-key="17694:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager 定义及初始化</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17695"><span data-slate-object="text" data-key="17696"><span data-slate-leaf="true" data-offset-key="17696:0" data-first-offset="true"><span data-slate-string="true">有了这些铺垫，我们再来看主题删除管理器的主要入口：TopicDeletionManager 类。这个类的定义代码，如下：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="17697"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17698"><span data-slate-object="text" data-key="17699"><span data-slate-leaf="true" data-offset-key="17699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="17700"><span data-slate-leaf="true" data-offset-key="17700:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17701"><span data-slate-leaf="true" data-offset-key="17701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicDeletionManager</span></span></span></span><span data-slate-object="text" data-key="17702"><span data-slate-leaf="true" data-offset-key="17702:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17703"><span data-slate-object="text" data-key="17704"><span data-slate-leaf="true" data-offset-key="17704:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17705"><span data-slate-leaf="true" data-offset-key="17705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// KafkaConfig 类，保存 Broker 端参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17706"><span data-slate-object="text" data-key="17707"><span data-slate-leaf="true" data-offset-key="17707:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17708"><span data-slate-leaf="true" data-offset-key="17708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">config</span></span></span></span><span data-slate-object="text" data-key="17709"><span data-slate-leaf="true" data-offset-key="17709:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="17710"><span data-slate-leaf="true" data-offset-key="17710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaConfig</span></span></span></span><span data-slate-object="text" data-key="17711"><span data-slate-leaf="true" data-offset-key="17711:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17712"><span data-slate-object="text" data-key="17713"><span data-slate-leaf="true" data-offset-key="17713:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17714"><span data-slate-leaf="true" data-offset-key="17714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 集群元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17715"><span data-slate-object="text" data-key="17716"><span data-slate-leaf="true" data-offset-key="17716:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17717"><span data-slate-leaf="true" data-offset-key="17717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerContext</span></span></span></span><span data-slate-object="text" data-key="17718"><span data-slate-leaf="true" data-offset-key="17718:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="17719"><span data-slate-leaf="true" data-offset-key="17719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerContext</span></span></span></span><span data-slate-object="text" data-key="17720"><span data-slate-leaf="true" data-offset-key="17720:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17721"><span data-slate-object="text" data-key="17722"><span data-slate-leaf="true" data-offset-key="17722:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17723"><span data-slate-leaf="true" data-offset-key="17723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 副本状态机，用于设置副本状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17724"><span data-slate-object="text" data-key="17725"><span data-slate-leaf="true" data-offset-key="17725:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17726"><span data-slate-leaf="true" data-offset-key="17726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="17727"><span data-slate-leaf="true" data-offset-key="17727:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="17728"><span data-slate-leaf="true" data-offset-key="17728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReplicaStateMachine</span></span></span></span><span data-slate-object="text" data-key="17729"><span data-slate-leaf="true" data-offset-key="17729:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17730"><span data-slate-object="text" data-key="17731"><span data-slate-leaf="true" data-offset-key="17731:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17732"><span data-slate-leaf="true" data-offset-key="17732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分区状态机，用于设置分区状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17733"><span data-slate-object="text" data-key="17734"><span data-slate-leaf="true" data-offset-key="17734:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17735"><span data-slate-leaf="true" data-offset-key="17735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionStateMachine</span></span></span></span><span data-slate-object="text" data-key="17736"><span data-slate-leaf="true" data-offset-key="17736:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="17737"><span data-slate-leaf="true" data-offset-key="17737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">PartitionStateMachine</span></span></span></span><span data-slate-object="text" data-key="17738"><span data-slate-leaf="true" data-offset-key="17738:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17739"><span data-slate-object="text" data-key="17740"><span data-slate-leaf="true" data-offset-key="17740:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17741"><span data-slate-leaf="true" data-offset-key="17741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// DeletionClient 接口，实现主题删除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17742"><span data-slate-object="text" data-key="17743"><span data-slate-leaf="true" data-offset-key="17743:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17744"><span data-slate-leaf="true" data-offset-key="17744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">client</span></span></span></span><span data-slate-object="text" data-key="17745"><span data-slate-leaf="true" data-offset-key="17745:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="17746"><span data-slate-leaf="true" data-offset-key="17746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">DeletionClient</span></span></span></span><span data-slate-object="text" data-key="17747"><span data-slate-leaf="true" data-offset-key="17747:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="17748"><span data-slate-leaf="true" data-offset-key="17748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="17749"><span data-slate-leaf="true" data-offset-key="17749:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17750"><span data-slate-leaf="true" data-offset-key="17750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="17751"><span data-slate-leaf="true" data-offset-key="17751:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17752"><span data-slate-object="text" data-key="17753"><span data-slate-leaf="true" data-offset-key="17753:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17754"><span data-slate-leaf="true" data-offset-key="17754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="17755"><span data-slate-leaf="true" data-offset-key="17755:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="17756"><span data-slate-leaf="true" data-offset-key="17756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logIdent</span></span></span></span><span data-slate-object="text" data-key="17757"><span data-slate-leaf="true" data-offset-key="17757:0" data-first-offset="true"><span data-slate-string="true"> = s</span></span></span><span data-slate-object="text" data-key="17758"><span data-slate-leaf="true" data-offset-key="17758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[Topic Deletion Manager ${config.brokerId}]"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17759"><span data-slate-object="text" data-key="17760"><span data-slate-leaf="true" data-offset-key="17760:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17761"><span data-slate-leaf="true" data-offset-key="17761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否允许删除主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17762"><span data-slate-object="text" data-key="17763"><span data-slate-leaf="true" data-offset-key="17763:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="17764"><span data-slate-leaf="true" data-offset-key="17764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">isDeleteTopicEnabled</span></span></span></span><span data-slate-object="text" data-key="17765"><span data-slate-leaf="true" data-offset-key="17765:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="17766"><span data-slate-leaf="true" data-offset-key="17766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Boolean</span></span></span></span><span data-slate-object="text" data-key="17767"><span data-slate-leaf="true" data-offset-key="17767:0" data-first-offset="true"><span data-slate-string="true"> = config.</span></span></span><span data-slate-object="text" data-key="17768"><span data-slate-leaf="true" data-offset-key="17768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deleteTopicEnable</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17769"><span data-slate-object="text" data-key="17770"><span data-slate-leaf="true" data-offset-key="17770:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17771"><span data-slate-object="text" data-key="17772"><span data-slate-leaf="true" data-offset-key="17772:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17773"><span data-slate-object="text" data-key="17774"><span data-slate-leaf="true" data-offset-key="17774:0" data-first-offset="true"><span data-slate-string="true">该类主要的属性有 6 个，我们分别来看看。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17775"><div data-slate-type="list-line" data-slate-object="block" data-key="17776"><span data-slate-object="text" data-key="17777"><span data-slate-leaf="true" data-offset-key="17777:0" data-first-offset="true"><span data-slate-string="true">config：KafkaConfig 实例，可以用作获取 Broker 端参数 delete.topic.enable 的值。该参数用于控制是否允许删除主题，默认值是 true，即 Kafka 默认允许用户删除主题。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17778"><span data-slate-object="text" data-key="17779"><span data-slate-leaf="true" data-offset-key="17779:0" data-first-offset="true"><span data-slate-string="true">controllerContext：Controller 端保存的元数据信息。删除主题必然要变更集群元数据信息，因此 TopicDeletionManager 需要用到 controllerContext 的方法，去更新它保存的数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17780"><span data-slate-object="text" data-key="17781"><span data-slate-leaf="true" data-offset-key="17781:0" data-first-offset="true"><span data-slate-string="true">replicaStateMachine 和 partitionStateMachine：副本状态机和分区状态机。它们各自负责副本和分区的状态转换，以保持副本对象和分区对象在集群上的一致性状态。这两个状态机是后面两讲的重要知识点。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17782"><span data-slate-object="text" data-key="17783"><span data-slate-leaf="true" data-offset-key="17783:0" data-first-offset="true"><span data-slate-string="true">client：前面介绍的 DeletionClient 接口。TopicDeletionManager 通过该接口执行 ZooKeeper 上节点的相应更新。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17784"><span data-slate-object="text" data-key="17785"><span data-slate-leaf="true" data-offset-key="17785:0" data-first-offset="true"><span data-slate-string="true">isDeleteTopicEnabled：表明主题是否允许被删除。它是 Broker 端参数 delete.topic.enable 的值，默认是 true，表示 Kafka 允许删除主题。源码中大量使用这个字段判断主题的可删除性。前面的 config 参数的主要目的就是设置这个字段的值。被设定之后，config 就不再被源码使用了。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17786"><span data-slate-object="text" data-key="17787"><span data-slate-leaf="true" data-offset-key="17787:0" data-first-offset="true"><span data-slate-string="true">好了，知道这些字段的含义，我们再看看 TopicDeletionManager 类实例是如何被创建的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17788"><span data-slate-object="text" data-key="17789"><span data-slate-leaf="true" data-offset-key="17789:0" data-first-offset="true"><span data-slate-string="true">实际上，这个实例是在 KafkaController 类初始化时被创建的。在 KafkaController 类的源码中，你可以很容易地找到这行代码：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="17790"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17791"><span data-slate-object="text" data-key="17792"><span data-slate-leaf="true" data-offset-key="17792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17793"><span data-slate-leaf="true" data-offset-key="17793:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17794"><span data-slate-leaf="true" data-offset-key="17794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicDeletionManager</span></span></span></span><span data-slate-object="text" data-key="17795"><span data-slate-leaf="true" data-offset-key="17795:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17796"><span data-slate-leaf="true" data-offset-key="17796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17797"><span data-slate-leaf="true" data-offset-key="17797:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17798"><span data-slate-leaf="true" data-offset-key="17798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="17799"><span data-slate-leaf="true" data-offset-key="17799:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17800"><span data-slate-leaf="true" data-offset-key="17800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicDeletionManager</span></span></span></span><span data-slate-object="text" data-key="17801"><span data-slate-leaf="true" data-offset-key="17801:0" data-first-offset="true"><span data-slate-string="true">(config, controllerContext, replicaStateMachine,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17802"><span data-slate-object="text" data-key="17803"><span data-slate-leaf="true" data-offset-key="17803:0" data-first-offset="true"><span data-slate-string="true">  partitionStateMachine, </span></span></span><span data-slate-object="text" data-key="17804"><span data-slate-leaf="true" data-offset-key="17804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="17805"><span data-slate-leaf="true" data-offset-key="17805:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17806"><span data-slate-leaf="true" data-offset-key="17806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerDeletionClient</span></span></span></span><span data-slate-object="text" data-key="17807"><span data-slate-leaf="true" data-offset-key="17807:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17808"><span data-slate-leaf="true" data-offset-key="17808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="17809"><span data-slate-leaf="true" data-offset-key="17809:0" data-first-offset="true"><span data-slate-string="true">, zkClient))</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17810"><span data-slate-object="text" data-key="17811"><span data-slate-leaf="true" data-offset-key="17811:0" data-first-offset="true"><span data-slate-string="true">可以看到，代码实例化了一个全新的 ControllerDeletionClient 对象，然后利用这个对象实例和 replicaStateMachine、partitionStateMachine，一起创建 TopicDeletionManager 实例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17812"><span data-slate-object="text" data-key="17813"><span data-slate-leaf="true" data-offset-key="17813:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解，我再给你画一张流程图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17814"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/89/e6/89733b9e03df6e1450ba81e082187ce6.jpg?wh=1449*2175"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17815" id="sr-toc-5"><span data-slate-object="text" data-key="17816"><span data-slate-leaf="true" data-offset-key="17816:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager 重要方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17817"><span data-slate-object="text" data-key="17818"><span data-slate-leaf="true" data-offset-key="17818:0" data-first-offset="true"><span data-slate-string="true">除了类定义和初始化，TopicDeletionManager 类还定义了 16 个方法。在这些方法中，最重要的当属 resumeDeletions 方法。它是重启主题删除操作过程的方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17819"><span data-slate-object="text" data-key="17820"><span data-slate-leaf="true" data-offset-key="17820:0" data-first-offset="true"><span data-slate-string="true">主题因为某些事件可能一时无法完成删除，比如主题分区正在进行副本重分配等。一旦这些事件完成后，主题重新具备可删除的资格。此时，代码就需要调用 resumeDeletions 重启删除操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17821"><span data-slate-object="text" data-key="17822"><span data-slate-leaf="true" data-offset-key="17822:0" data-first-offset="true"><span data-slate-string="true">这个方法之所以很重要，是因为它还串联了 TopicDeletionManager 类的很多方法，如 completeDeleteTopic 和 onTopicDeletion 等。因此，你完全可以从 resumeDeletions 方法开始，逐渐深入到其他方法代码的学习。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17823"><span data-slate-object="text" data-key="17824"><span data-slate-leaf="true" data-offset-key="17824:0" data-first-offset="true"><span data-slate-string="true">那我们就先学习 resumeDeletions 的实现代码吧。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="17825"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17826"><span data-slate-object="text" data-key="17827"><span data-slate-leaf="true" data-offset-key="17827:0" data-first-offset="true"><span data-slate-string="true">private def resumeDeletions(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17828"><span data-slate-object="text" data-key="17829"><span data-slate-leaf="true" data-offset-key="17829:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17830"><span data-slate-leaf="true" data-offset-key="17830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从元数据缓存中获取要删除的主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17831"><span data-slate-object="text" data-key="17832"><span data-slate-leaf="true" data-offset-key="17832:0" data-first-offset="true"><span data-slate-string="true">  val topicsQueuedForDeletion = </span></span></span><span data-slate-object="text" data-key="17833"><span data-slate-leaf="true" data-offset-key="17833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="17834"><span data-slate-leaf="true" data-offset-key="17834:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="17835"><span data-slate-leaf="true" data-offset-key="17835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="17836"><span data-slate-leaf="true" data-offset-key="17836:0" data-first-offset="true"><span data-slate-string="true">] ++ controllerContext.topicsToBeDeleted</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17837"><span data-slate-object="text" data-key="17838"><span data-slate-leaf="true" data-offset-key="17838:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17839"><span data-slate-leaf="true" data-offset-key="17839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 待重试主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17840"><span data-slate-object="text" data-key="17841"><span data-slate-leaf="true" data-offset-key="17841:0" data-first-offset="true"><span data-slate-string="true">  val topicsEligibleForRetry = mutable.</span></span></span><span data-slate-object="text" data-key="17842"><span data-slate-leaf="true" data-offset-key="17842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="17843"><span data-slate-leaf="true" data-offset-key="17843:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="17844"><span data-slate-leaf="true" data-offset-key="17844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="17845"><span data-slate-leaf="true" data-offset-key="17845:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17846"><span data-slate-object="text" data-key="17847"><span data-slate-leaf="true" data-offset-key="17847:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17848"><span data-slate-leaf="true" data-offset-key="17848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 待删除主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17849"><span data-slate-object="text" data-key="17850"><span data-slate-leaf="true" data-offset-key="17850:0" data-first-offset="true"><span data-slate-string="true">  val topicsEligibleForDeletion = mutable.</span></span></span><span data-slate-object="text" data-key="17851"><span data-slate-leaf="true" data-offset-key="17851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="17852"><span data-slate-leaf="true" data-offset-key="17852:0" data-first-offset="true"><span data-slate-string="true">.empty[</span></span></span><span data-slate-object="text" data-key="17853"><span data-slate-leaf="true" data-offset-key="17853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="17854"><span data-slate-leaf="true" data-offset-key="17854:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17855"><span data-slate-object="text" data-key="17856"><span data-slate-leaf="true" data-offset-key="17856:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17857"><span data-slate-leaf="true" data-offset-key="17857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17858"><span data-slate-leaf="true" data-offset-key="17858:0" data-first-offset="true"><span data-slate-string="true"> (topicsQueuedForDeletion.nonEmpty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17859"><span data-slate-object="text" data-key="17860"><span data-slate-leaf="true" data-offset-key="17860:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="17861"><span data-slate-leaf="true" data-offset-key="17861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Handling deletion for topics </span></span></span></span><span data-slate-object="text" data-key="17862"><span data-slate-leaf="true" data-offset-key="17862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${topicsQueuedForDeletion.mkString(</span></span></span></span></span><span data-slate-object="text" data-key="17863"><span data-slate-leaf="true" data-offset-key="17863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">","</span></span></span></span></span><span data-slate-object="text" data-key="17864"><span data-slate-leaf="true" data-offset-key="17864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)}</span></span></span></span></span><span data-slate-object="text" data-key="17865"><span data-slate-leaf="true" data-offset-key="17865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="17866"><span data-slate-leaf="true" data-offset-key="17866:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17867"><span data-slate-object="text" data-key="17868"><span data-slate-leaf="true" data-offset-key="17868:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17869"><span data-slate-leaf="true" data-offset-key="17869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历每个待删除主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17870"><span data-slate-object="text" data-key="17871"><span data-slate-leaf="true" data-offset-key="17871:0" data-first-offset="true"><span data-slate-string="true">  topicsQueuedForDeletion.foreach {topic =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17872"><span data-slate-object="text" data-key="17873"><span data-slate-leaf="true" data-offset-key="17873:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17874"><span data-slate-leaf="true" data-offset-key="17874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该主题所有副本已经是 ReplicaDeletionSuccessful 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17875"><span data-slate-object="text" data-key="17876"><span data-slate-leaf="true" data-offset-key="17876:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17877"><span data-slate-leaf="true" data-offset-key="17877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 即该主题已经被删除  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17878"><span data-slate-object="text" data-key="17879"><span data-slate-leaf="true" data-offset-key="17879:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17880"><span data-slate-leaf="true" data-offset-key="17880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17881"><span data-slate-leaf="true" data-offset-key="17881:0" data-first-offset="true"><span data-slate-string="true"> (controllerContext.areAllReplicasInState(topic, ReplicaDeletionSuccessful)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17882"><span data-slate-object="text" data-key="17883"><span data-slate-leaf="true" data-offset-key="17883:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17884"><span data-slate-leaf="true" data-offset-key="17884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 completeDeleteTopic 方法完成后续操作即可</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17885"><span data-slate-object="text" data-key="17886"><span data-slate-leaf="true" data-offset-key="17886:0" data-first-offset="true"><span data-slate-string="true">      completeDeleteTopic(topic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17887"><span data-slate-object="text" data-key="17888"><span data-slate-leaf="true" data-offset-key="17888:0" data-first-offset="true"><span data-slate-string="true">      info(s</span></span></span><span data-slate-object="text" data-key="17889"><span data-slate-leaf="true" data-offset-key="17889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Deletion of topic </span></span></span></span><span data-slate-object="text" data-key="17890"><span data-slate-leaf="true" data-offset-key="17890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topic</span></span></span></span></span><span data-slate-object="text" data-key="17891"><span data-slate-leaf="true" data-offset-key="17891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> successfully completed"</span></span></span></span><span data-slate-object="text" data-key="17892"><span data-slate-leaf="true" data-offset-key="17892:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17893"><span data-slate-object="text" data-key="17894"><span data-slate-leaf="true" data-offset-key="17894:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="17895"><span data-slate-leaf="true" data-offset-key="17895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果主题删除尚未开始并且主题当前无法执行删除的话</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17896"><span data-slate-object="text" data-key="17897"><span data-slate-leaf="true" data-offset-key="17897:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="17898"><span data-slate-leaf="true" data-offset-key="17898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17899"><span data-slate-leaf="true" data-offset-key="17899:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17900"><span data-slate-leaf="true" data-offset-key="17900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17901"><span data-slate-leaf="true" data-offset-key="17901:0" data-first-offset="true"><span data-slate-string="true"> (!controllerContext.isAnyReplicaInState(topic, ReplicaDeletionStarted)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17902"><span data-slate-object="text" data-key="17903"><span data-slate-leaf="true" data-offset-key="17903:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17904"><span data-slate-leaf="true" data-offset-key="17904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17905"><span data-slate-leaf="true" data-offset-key="17905:0" data-first-offset="true"><span data-slate-string="true"> (controllerContext.isAnyReplicaInState(topic, ReplicaDeletionIneligible)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17906"><span data-slate-object="text" data-key="17907"><span data-slate-leaf="true" data-offset-key="17907:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17908"><span data-slate-leaf="true" data-offset-key="17908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把该主题加到待重试主题列表中用于后续重试</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17909"><span data-slate-object="text" data-key="17910"><span data-slate-leaf="true" data-offset-key="17910:0" data-first-offset="true"><span data-slate-string="true">        topicsEligibleForRetry += topic</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17911"><span data-slate-object="text" data-key="17912"><span data-slate-leaf="true" data-offset-key="17912:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17913"><span data-slate-object="text" data-key="17914"><span data-slate-leaf="true" data-offset-key="17914:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17915"><span data-slate-object="text" data-key="17916"><span data-slate-leaf="true" data-offset-key="17916:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17917"><span data-slate-leaf="true" data-offset-key="17917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该主题能够被删除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17918"><span data-slate-object="text" data-key="17919"><span data-slate-leaf="true" data-offset-key="17919:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17920"><span data-slate-leaf="true" data-offset-key="17920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17921"><span data-slate-leaf="true" data-offset-key="17921:0" data-first-offset="true"><span data-slate-string="true"> (isTopicEligibleForDeletion(topic)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17922"><span data-slate-object="text" data-key="17923"><span data-slate-leaf="true" data-offset-key="17923:0" data-first-offset="true"><span data-slate-string="true">      info(s</span></span></span><span data-slate-object="text" data-key="17924"><span data-slate-leaf="true" data-offset-key="17924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Deletion of topic </span></span></span></span><span data-slate-object="text" data-key="17925"><span data-slate-leaf="true" data-offset-key="17925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$topic</span></span></span></span></span><span data-slate-object="text" data-key="17926"><span data-slate-leaf="true" data-offset-key="17926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> (re)started"</span></span></span></span><span data-slate-object="text" data-key="17927"><span data-slate-leaf="true" data-offset-key="17927:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17928"><span data-slate-object="text" data-key="17929"><span data-slate-leaf="true" data-offset-key="17929:0" data-first-offset="true"><span data-slate-string="true">      topicsEligibleForDeletion += topic</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17930"><span data-slate-object="text" data-key="17931"><span data-slate-leaf="true" data-offset-key="17931:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17932"><span data-slate-object="text" data-key="17933"><span data-slate-leaf="true" data-offset-key="17933:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17934"><span data-slate-object="text" data-key="17935"><span data-slate-leaf="true" data-offset-key="17935:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17936"><span data-slate-leaf="true" data-offset-key="17936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 重试待重试主题列表中的主题删除操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17937"><span data-slate-object="text" data-key="17938"><span data-slate-leaf="true" data-offset-key="17938:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17939"><span data-slate-leaf="true" data-offset-key="17939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17940"><span data-slate-leaf="true" data-offset-key="17940:0" data-first-offset="true"><span data-slate-string="true"> (topicsEligibleForRetry.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17941"><span data-slate-object="text" data-key="17942"><span data-slate-leaf="true" data-offset-key="17942:0" data-first-offset="true"><span data-slate-string="true">    retryDeletionForIneligibleReplicas(topicsEligibleForRetry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17943"><span data-slate-object="text" data-key="17944"><span data-slate-leaf="true" data-offset-key="17944:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17945"><span data-slate-object="text" data-key="17946"><span data-slate-leaf="true" data-offset-key="17946:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17947"><span data-slate-leaf="true" data-offset-key="17947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 onTopicDeletion 方法，对待删除主题列表中的主题执行删除操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17948"><span data-slate-object="text" data-key="17949"><span data-slate-leaf="true" data-offset-key="17949:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17950"><span data-slate-leaf="true" data-offset-key="17950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17951"><span data-slate-leaf="true" data-offset-key="17951:0" data-first-offset="true"><span data-slate-string="true"> (topicsEligibleForDeletion.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17952"><span data-slate-object="text" data-key="17953"><span data-slate-leaf="true" data-offset-key="17953:0" data-first-offset="true"><span data-slate-string="true">    onTopicDeletion(topicsEligibleForDeletion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17954"><span data-slate-object="text" data-key="17955"><span data-slate-leaf="true" data-offset-key="17955:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17956"><span data-slate-object="text" data-key="17957"><span data-slate-leaf="true" data-offset-key="17957:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17958"><span data-slate-object="text" data-key="17959"><span data-slate-leaf="true" data-offset-key="17959:0" data-first-offset="true"><span data-slate-string="true">通过代码我们发现，这个方法</span></span></span><span data-slate-object="text" data-key="17960"><span data-slate-leaf="true" data-offset-key="17960:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先</span></span></span></span><span data-slate-object="text" data-key="17961"><span data-slate-leaf="true" data-offset-key="17961:0" data-first-offset="true"><span data-slate-string="true">从元数据缓存中获取要删除的主题列表，之后定义了两个空的主题列表，分别保存待重试删除主题和待删除主题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17962"><span data-slate-object="text" data-key="17963"><span data-slate-leaf="true" data-offset-key="17963:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">然后</span></span></span></span><span data-slate-object="text" data-key="17964"><span data-slate-leaf="true" data-offset-key="17964:0" data-first-offset="true"><span data-slate-string="true">，代码遍历每个要删除的主题，去看它所有副本的状态。如果副本状态都是 ReplicaDeletionSuccessful，就表明该主题已经被成功删除，此时，再调用 completeDeleteTopic 方法，完成后续的操作就可以了。对于那些删除操作尚未开始，并且暂时无法执行删除的主题，源码会把这类主题加到待重试主题列表中，用于后续重试；如果主题是能够被删除的，就将其加入到待删除列表中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17965"><span data-slate-object="text" data-key="17966"><span data-slate-leaf="true" data-offset-key="17966:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最后</span></span></span></span><span data-slate-object="text" data-key="17967"><span data-slate-leaf="true" data-offset-key="17967:0" data-first-offset="true"><span data-slate-string="true">，该方法调用 retryDeletionForIneligibleReplicas 方法，来重试待重试主题列表中的主题删除操作。对于待删除主题列表中的主题则调用 onTopicDeletion 删除之。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17968"><span data-slate-object="text" data-key="17969"><span data-slate-leaf="true" data-offset-key="17969:0" data-first-offset="true"><span data-slate-string="true">值得一提的是，retryDeletionForIneligibleReplicas 方法用于重试主题删除。这是通过将对应主题副本的状态，从 ReplicaDeletionIneligible 变更到 OfflineReplica 来完成的。这样，后续再次调用 resumeDeletions 时，会尝试重新删除主题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17970"><span data-slate-object="text" data-key="17971"><span data-slate-leaf="true" data-offset-key="17971:0" data-first-offset="true"><span data-slate-string="true">看到这里，我们再次发现，Kafka 的方法命名真的是非常规范。得益于这一点，很多时候，我们不用深入到方法内部，就能知道这个方法大致是做什么用的。比如：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17972"><div data-slate-type="list-line" data-slate-object="block" data-key="17973"><span data-slate-object="text" data-key="17974"><span data-slate-leaf="true" data-offset-key="17974:0" data-first-offset="true"><span data-slate-string="true">topicsQueuedForDeletion 方法，应该是保存待删除的主题列表；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17975"><span data-slate-object="text" data-key="17976"><span data-slate-leaf="true" data-offset-key="17976:0" data-first-offset="true"><span data-slate-string="true">controllerContext.isAnyReplicaInState 方法，应该是判断某个主题下是否有副本处于某种状态；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17977"><span data-slate-object="text" data-key="17978"><span data-slate-leaf="true" data-offset-key="17978:0" data-first-offset="true"><span data-slate-string="true">而 onTopicDeletion 方法，应该就是执行主题删除操作用的。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17979"><span data-slate-object="text" data-key="17980"><span data-slate-leaf="true" data-offset-key="17980:0" data-first-offset="true"><span data-slate-string="true">这时，你再去阅读这 3 个方法的源码，就会发现它们的作用确实如其名字标识的那样。这也再次证明了 Kafka 源码质量是非常不错的。因此，不管你是不是 Kafka 的使用者，都可以把 Kafka 的源码作为阅读开源框架源码、提升自己竞争力的一个选择。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17981"><span data-slate-object="text" data-key="17982"><span data-slate-leaf="true" data-offset-key="17982:0" data-first-offset="true"><span data-slate-string="true">下面，我再用一张图来解释下 resumeDeletions 方法的执行流程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17983"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/d1/34/d165193d4f27ffe18e038643ea050534.jpg?wh=2504*3969"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17984"><span data-slate-object="text" data-key="17985"><span data-slate-leaf="true" data-offset-key="17985:0" data-first-offset="true"><span data-slate-string="true">到这里，resumeDeletions 方法的逻辑我就讲完了，它果然是串联起了 TopicDeletionManger 中定义的很多方法。其中，比较关键的两个操作是 </span></span></span><span data-slate-object="text" data-key="17986"><span data-slate-leaf="true" data-offset-key="17986:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">completeDeleteTopic</span></span></span></span><span data-slate-object="text" data-key="17987"><span data-slate-leaf="true" data-offset-key="17987:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><span data-slate-object="text" data-key="17988"><span data-slate-leaf="true" data-offset-key="17988:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">onTopicDeletion</span></span></span></span><span data-slate-object="text" data-key="17989"><span data-slate-leaf="true" data-offset-key="17989:0" data-first-offset="true"><span data-slate-string="true">。接下来，我们就分别看看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17990"><span data-slate-object="text" data-key="17991"><span data-slate-leaf="true" data-offset-key="17991:0" data-first-offset="true"><span data-slate-string="true">先来看 completeDeleteTopic 方法代码，我给每行代码都加标了注解。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="17992"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17993"><span data-slate-object="text" data-key="17994"><span data-slate-leaf="true" data-offset-key="17994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="17995"><span data-slate-leaf="true" data-offset-key="17995:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="17996"><span data-slate-leaf="true" data-offset-key="17996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">completeDeleteTopic</span></span></span></span><span data-slate-object="text" data-key="17997"><span data-slate-leaf="true" data-offset-key="17997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topic: String)</span></span></span></span><span data-slate-object="text" data-key="17998"><span data-slate-leaf="true" data-offset-key="17998:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17999"><span data-slate-object="text" data-key="18000"><span data-slate-leaf="true" data-offset-key="18000:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18001"><span data-slate-leaf="true" data-offset-key="18001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：注销分区变更监听器，防止删除过程中因分区数据变更</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18002"><span data-slate-object="text" data-key="18003"><span data-slate-leaf="true" data-offset-key="18003:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18004"><span data-slate-leaf="true" data-offset-key="18004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 导致监听器被触发，引起状态不一致</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18005"><span data-slate-object="text" data-key="18006"><span data-slate-leaf="true" data-offset-key="18006:0" data-first-offset="true"><span data-slate-string="true">  client.mutePartitionModifications(topic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18007"><span data-slate-object="text" data-key="18008"><span data-slate-leaf="true" data-offset-key="18008:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18009"><span data-slate-leaf="true" data-offset-key="18009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：获取该主题下处于 ReplicaDeletionSuccessful 状态的所有副本对象，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18010"><span data-slate-object="text" data-key="18011"><span data-slate-leaf="true" data-offset-key="18011:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18012"><span data-slate-leaf="true" data-offset-key="18012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 即所有已经被成功删除的副本对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18013"><span data-slate-object="text" data-key="18014"><span data-slate-leaf="true" data-offset-key="18014:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18015"><span data-slate-leaf="true" data-offset-key="18015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="18016"><span data-slate-leaf="true" data-offset-key="18016:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18017"><span data-slate-leaf="true" data-offset-key="18017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">replicasForDeletedTopic</span></span></span></span><span data-slate-object="text" data-key="18018"><span data-slate-leaf="true" data-offset-key="18018:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18019"><span data-slate-leaf="true" data-offset-key="18019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="18020"><span data-slate-leaf="true" data-offset-key="18020:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.replicasInState(topic, ReplicaDeletionSuccessful)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18021"><span data-slate-object="text" data-key="18022"><span data-slate-leaf="true" data-offset-key="18022:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18023"><span data-slate-leaf="true" data-offset-key="18023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：利用副本状态机将这些副本对象转换成 NonExistentReplica 状态。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18024"><span data-slate-object="text" data-key="18025"><span data-slate-leaf="true" data-offset-key="18025:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18026"><span data-slate-leaf="true" data-offset-key="18026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等同于在状态机中删除这些副本</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18027"><span data-slate-object="text" data-key="18028"><span data-slate-leaf="true" data-offset-key="18028:0" data-first-offset="true"><span data-slate-string="true">  replicaStateMachine.handleStateChanges(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18029"><span data-slate-object="text" data-key="18030"><span data-slate-leaf="true" data-offset-key="18030:0" data-first-offset="true"><span data-slate-string="true">    replicasForDeletedTopic.toSeq, NonExistentReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18031"><span data-slate-object="text" data-key="18032"><span data-slate-leaf="true" data-offset-key="18032:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18033"><span data-slate-leaf="true" data-offset-key="18033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 4 步：更新元数据缓存中的待删除主题列表和已开始删除的主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18034"><span data-slate-object="text" data-key="18035"><span data-slate-leaf="true" data-offset-key="18035:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18036"><span data-slate-leaf="true" data-offset-key="18036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 因为主题已经成功删除了，没有必要出现在这两个列表中了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18037"><span data-slate-object="text" data-key="18038"><span data-slate-leaf="true" data-offset-key="18038:0" data-first-offset="true"><span data-slate-string="true">  controllerContext.topicsToBeDeleted -= topic</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18039"><span data-slate-object="text" data-key="18040"><span data-slate-leaf="true" data-offset-key="18040:0" data-first-offset="true"><span data-slate-string="true">  controllerContext.topicsWithDeletionStarted -= topic</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18041"><span data-slate-object="text" data-key="18042"><span data-slate-leaf="true" data-offset-key="18042:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18043"><span data-slate-leaf="true" data-offset-key="18043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 5 步：移除 ZooKeeper 上关于该主题的一切 “痕迹”</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18044"><span data-slate-object="text" data-key="18045"><span data-slate-leaf="true" data-offset-key="18045:0" data-first-offset="true"><span data-slate-string="true">  client.deleteTopic(topic, controllerContext.epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18046"><span data-slate-object="text" data-key="18047"><span data-slate-leaf="true" data-offset-key="18047:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18048"><span data-slate-leaf="true" data-offset-key="18048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 6 步：移除元数据缓存中关于该主题的一切 “痕迹”</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18049"><span data-slate-object="text" data-key="18050"><span data-slate-leaf="true" data-offset-key="18050:0" data-first-offset="true"><span data-slate-string="true">  controllerContext.removeTopic(topic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18051"><span data-slate-object="text" data-key="18052"><span data-slate-leaf="true" data-offset-key="18052:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18053"><span data-slate-object="text" data-key="18054"><span data-slate-leaf="true" data-offset-key="18054:0" data-first-offset="true"><span data-slate-string="true">整个过程如行云流水般一气呵成，非常容易理解，我就不多解释了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18055"><span data-slate-object="text" data-key="18056"><span data-slate-leaf="true" data-offset-key="18056:0" data-first-offset="true"><span data-slate-string="true">再来看看 onTopicDeletion 方法的代码：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="18057"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18058"><span data-slate-object="text" data-key="18059"><span data-slate-leaf="true" data-offset-key="18059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="18060"><span data-slate-leaf="true" data-offset-key="18060:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="18061"><span data-slate-leaf="true" data-offset-key="18061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">onTopicDeletion</span></span></span></span><span data-slate-object="text" data-key="18062"><span data-slate-leaf="true" data-offset-key="18062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topics: Set[String])</span></span></span></span><span data-slate-object="text" data-key="18063"><span data-slate-leaf="true" data-offset-key="18063:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18064"><span data-slate-object="text" data-key="18065"><span data-slate-leaf="true" data-offset-key="18065:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18066"><span data-slate-leaf="true" data-offset-key="18066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找出给定待删除主题列表中那些尚未开启删除操作的所有主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18067"><span data-slate-object="text" data-key="18068"><span data-slate-leaf="true" data-offset-key="18068:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18069"><span data-slate-leaf="true" data-offset-key="18069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="18070"><span data-slate-leaf="true" data-offset-key="18070:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18071"><span data-slate-leaf="true" data-offset-key="18071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unseenTopicsForDeletion</span></span></span></span><span data-slate-object="text" data-key="18072"><span data-slate-leaf="true" data-offset-key="18072:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18073"><span data-slate-leaf="true" data-offset-key="18073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="18074"><span data-slate-leaf="true" data-offset-key="18074:0" data-first-offset="true"><span data-slate-string="true"> topics.diff(controllerContext.topicsWithDeletionStarted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18075"><span data-slate-object="text" data-key="18076"><span data-slate-leaf="true" data-offset-key="18076:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18077"><span data-slate-leaf="true" data-offset-key="18077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18078"><span data-slate-leaf="true" data-offset-key="18078:0" data-first-offset="true"><span data-slate-string="true"> (unseenTopicsForDeletion.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18079"><span data-slate-object="text" data-key="18080"><span data-slate-leaf="true" data-offset-key="18080:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18081"><span data-slate-leaf="true" data-offset-key="18081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取到这些主题的所有分区对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18082"><span data-slate-object="text" data-key="18083"><span data-slate-leaf="true" data-offset-key="18083:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18084"><span data-slate-leaf="true" data-offset-key="18084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="18085"><span data-slate-leaf="true" data-offset-key="18085:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18086"><span data-slate-leaf="true" data-offset-key="18086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unseenPartitionsForDeletion</span></span></span></span><span data-slate-object="text" data-key="18087"><span data-slate-leaf="true" data-offset-key="18087:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18088"><span data-slate-leaf="true" data-offset-key="18088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="18089"><span data-slate-leaf="true" data-offset-key="18089:0" data-first-offset="true"><span data-slate-string="true"> unseenTopicsForDeletion.flatMap(controllerContext.partitionsForTopic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18090"><span data-slate-object="text" data-key="18091"><span data-slate-leaf="true" data-offset-key="18091:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18092"><span data-slate-leaf="true" data-offset-key="18092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将这些分区的状态依次调整成 OfflinePartition 和 NonExistentPartition</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18093"><span data-slate-object="text" data-key="18094"><span data-slate-leaf="true" data-offset-key="18094:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18095"><span data-slate-leaf="true" data-offset-key="18095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等同于将这些分区从分区状态机中删除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18096"><span data-slate-object="text" data-key="18097"><span data-slate-leaf="true" data-offset-key="18097:0" data-first-offset="true"><span data-slate-string="true">    partitionStateMachine.handleStateChanges(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18098"><span data-slate-object="text" data-key="18099"><span data-slate-leaf="true" data-offset-key="18099:0" data-first-offset="true"><span data-slate-string="true">      unseenPartitionsForDeletion.toSeq, OfflinePartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18100"><span data-slate-object="text" data-key="18101"><span data-slate-leaf="true" data-offset-key="18101:0" data-first-offset="true"><span data-slate-string="true">    partitionStateMachine.handleStateChanges(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18102"><span data-slate-object="text" data-key="18103"><span data-slate-leaf="true" data-offset-key="18103:0" data-first-offset="true"><span data-slate-string="true">      unseenPartitionsForDeletion.toSeq, NonExistentPartition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18104"><span data-slate-object="text" data-key="18105"><span data-slate-leaf="true" data-offset-key="18105:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18106"><span data-slate-leaf="true" data-offset-key="18106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把这些主题加到 “已开启删除操作” 主题列表中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18107"><span data-slate-object="text" data-key="18108"><span data-slate-leaf="true" data-offset-key="18108:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.beginTopicDeletion(unseenTopicsForDeletion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18109"><span data-slate-object="text" data-key="18110"><span data-slate-leaf="true" data-offset-key="18110:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18111"><span data-slate-object="text" data-key="18112"><span data-slate-leaf="true" data-offset-key="18112:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18113"><span data-slate-leaf="true" data-offset-key="18113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 给集群所有 Broker 发送元数据更新请求，告诉它们不要再为这些主题处理数据了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18114"><span data-slate-object="text" data-key="18115"><span data-slate-leaf="true" data-offset-key="18115:0" data-first-offset="true"><span data-slate-string="true">  client.sendMetadataUpdate(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18116"><span data-slate-object="text" data-key="18117"><span data-slate-leaf="true" data-offset-key="18117:0" data-first-offset="true"><span data-slate-string="true">    topics.flatMap(controllerContext.partitionsForTopic))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18118"><span data-slate-object="text" data-key="18119"><span data-slate-leaf="true" data-offset-key="18119:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18120"><span data-slate-leaf="true" data-offset-key="18120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分区删除操作会执行底层的物理磁盘文件删除动作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18121"><span data-slate-object="text" data-key="18122"><span data-slate-leaf="true" data-offset-key="18122:0" data-first-offset="true"><span data-slate-string="true">  onPartitionDeletion(topics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18123"><span data-slate-object="text" data-key="18124"><span data-slate-leaf="true" data-offset-key="18124:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18125"><span data-slate-object="text" data-key="18126"><span data-slate-leaf="true" data-offset-key="18126:0" data-first-offset="true"><span data-slate-string="true">我在代码中用注释的方式，已经把 onTopicDeletion 方法的逻辑解释清楚了。你可以发现，这个方法也基本是串行化的流程，没什么难理解的。我再给你梳理下其中的核心点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18127"><span data-slate-object="text" data-key="18128"><span data-slate-leaf="true" data-offset-key="18128:0" data-first-offset="true"><span data-slate-string="true">onTopicDeletion 方法会多次使用分区状态机，来调整待删除主题的分区状态。在后两讲的分区状态机和副本状态机的课里面，我还会和你详细讲解它们，包括它们都定义了哪些状态，这些状态彼此之间的转换规则都是什么，等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18129"><span data-slate-object="text" data-key="18130"><span data-slate-leaf="true" data-offset-key="18130:0" data-first-offset="true"><span data-slate-string="true">onTopicDeletion 方法的最后一行调用了 onPartitionDeletion 方法，来执行真正的底层物理磁盘文件删除。实际上，这是通过副本状态机状态转换操作完成的。下节课，我会和你详细聊聊这个事情。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18131"><span data-slate-object="text" data-key="18132"><span data-slate-leaf="true" data-offset-key="18132:0" data-first-offset="true"><span data-slate-string="true">学到这里，我还想提醒你的是，在学习 TopicDeletionManager 方法的时候，非常重要一点的是，你要理解主题删除的脉络。对于其他部分的源码，也是这个道理。一旦你掌握了整体的流程，阅读那些细枝末节的方法代码就没有任何难度了。照着这个方法去读源码，搞懂 Kafka 源码也不是什么难事！</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18133" id="sr-toc-6"><span data-slate-object="text" data-key="18134"><span data-slate-leaf="true" data-offset-key="18134:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18135"><span data-slate-object="text" data-key="18136"><span data-slate-leaf="true" data-offset-key="18136:0" data-first-offset="true"><span data-slate-string="true">今天，我们主要学习了 TopicDeletionManager.scala 中关于主题删除的代码。这里有几个要点，需要你记住。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18137"><div data-slate-type="list-line" data-slate-object="block" data-key="18138"><span data-slate-object="text" data-key="18139"><span data-slate-leaf="true" data-offset-key="18139:0" data-first-offset="true"><span data-slate-string="true">在主题删除过程中，Kafka 会调整集群中三个地方的数据：ZooKeeper、元数据缓存和磁盘日志文件。删除主题时，ZooKeeper 上与该主题相关的所有 ZNode 节点必须被清除；Controller 端元数据缓存中的相关项，也必须要被处理，并且要被同步到集群的其他 Broker 上；而磁盘日志文件，更是要清理的首要目标。这三个地方必须要统一处理，就好似我们常说的原子性操作一样。现在回想下开篇提到的那个 “秘籍”，你就会发现它缺少了非常重要的一环，那就是：</span></span></span><span data-slate-object="text" data-key="18140"><span data-slate-leaf="true" data-offset-key="18140:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">无法清除 Controller 端的元数据缓存项</span></span></span></span><span data-slate-object="text" data-key="18141"><span data-slate-leaf="true" data-offset-key="18141:0" data-first-offset="true"><span data-slate-string="true">。因此，你要尽力避免使用这个 “大招”。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18142"><span data-slate-object="text" data-key="18143"><span data-slate-leaf="true" data-offset-key="18143:0" data-first-offset="true"><span data-slate-string="true">DeletionClient 接口的作用，主要是操作 ZooKeeper，实现 ZooKeeper 节点的删除等操作。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18144"><span data-slate-object="text" data-key="18145"><span data-slate-leaf="true" data-offset-key="18145:0" data-first-offset="true"><span data-slate-string="true">TopicDeletionManager，是在 KafkaController 创建过程中被初始化的，主要通过与元数据缓存进行交互的方式，来更新各类数据。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="18146"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/3a/3c/3a47958f44b81cef7b502da53495ef3c.jpg?wh=2250*1332"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18147"><span data-slate-object="text" data-key="18148"><span data-slate-leaf="true" data-offset-key="18148:0" data-first-offset="true"><span data-slate-string="true">今天我们看到的代码中出现了大量的 replicaStateMachine 和 partitionStateMachine，其实这就是我今天反复提到的副本状态机和分区状态机。接下来两讲，我会逐步带你走进它们的代码世界，让你领略下 Kafka 通过状态机机制管理副本和分区的风采。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18149" id="sr-toc-7"><span data-slate-object="text" data-key="18150"><span data-slate-leaf="true" data-offset-key="18150:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18151"><span data-slate-object="text" data-key="18152"><span data-slate-leaf="true" data-offset-key="18152:0" data-first-offset="true"><span data-slate-string="true">上节课，我们在学习 processTopicDeletion 方法的代码时，看到了一个名为 markTopicIneligibleForDeletion 的方法，这也是和主题删除相关的方法。现在，你能说说，它是做什么用的、它的实现原理又是怎样的吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18153"><span data-slate-object="text" data-key="18154"><span data-slate-leaf="true" data-offset-key="18154:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区畅所欲言，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-8">精选留言 (8)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们结合源码重点了解了 Controller 在集群中的作用。课后我请你思考这样一个问题：如果我们想要使用脚本命令增加一个主题的分区，你知道应该用 KafkaController 类中的哪个方法吗？其实，KafkaController 的 onNewPartitionCreation 方法是处理新分区增加逻辑的。它包括要将新分区状态调整到 Online 状态以及将对应副本的状态设置成 Online。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-05-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/a1/46/3136ac25.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>是男人就开巴巴托斯</span></div></div><div>mutePartitionModifications 是为了不要让 watcher 响应 zk topic 各个分区子节点逐个被删除的变化。
删除是从分区节点到 topic 节点递归执行的，因为 zk 不能在有子节点的情况下直接删除父节点。

新加分区与删除 topic 节点的互斥还是在 handleCreatePartitionsRequest 函数里做的 check。</div><div><div>2021-01-11</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/66/d1/8664c464.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>flyCoder</span></div></div><div>胡老师，遇到了这个问题，能帮忙分析下吗？https://www.orchome.com/1085</div><div><p>作者回复：打开文件数太多这件事社区曾经有几个 bug 跟过，在新一点的版本（比如 2.0 之后）之后已经不太常见了，不妨升级下看看。另外 ulimit -n 不妨设置大一点。</p></div><div><div>2020-11-16</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div>def enqueueTopicsForDeletion (topics: Set [String]): Unit = {
    if (isDeleteTopicEnabled) {
      controllerContext.queueTopicDeletion (topics)
      resumeDeletions ()
    }
  } 刚去研究了一下 enqueueTopicsForDeletion 方法源码
val isDeleteTopicEnabled: Boolean = config.deleteTopicEnable

 def queueTopicDeletion (topics: Set [String]): Unit = {
    topicsToBeDeleted ++= topics
}
可以删除的 topic 会添加进删除队列，不可删除的会重新调用 resumeDeletions 方法
</div><div><div>2020-08-25</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div>if (config.deleteTopicEnable) {
      if (topicsToBeDeleted.nonEmpty) {
        info (s"Starting topic deletion for topics ${topicsToBeDeleted.mkString (",")}")
        //mark topic ineligible for deletion if other state changes are in progress
        topicsToBeDeleted.foreach { topic =&gt;
          val partitionReassignmentInProgress =
            controllerContext.partitionsBeingReassigned.map (_.topic).contains (topic)
          if (partitionReassignmentInProgress)
            topicDeletionManager.markTopicIneligibleForDeletion (Set (topic),
              reason = "topic reassignment in progress")
        }
        //add topic to deletion list
        topicDeletionManager.enqueueTopicsForDeletion (topicsToBeDeleted)
      }  
①根据配置信息是否进行主题删除 是则进行下一步
②判断要删除的主题是否为空，不为空则进行下一步
③进行迭代判断，主题是否在 partitionsBeingReassigned 集合中，如果在，则将主题添加进 markTopicIneligibleForDeletion 标志为主题正在重新分配 不可删除

有一点疑问是为什么没有从 topicsToBeDeleted 集合中把不可删除主题移除的步骤，然后就直接将 topicsToBeDeleted 添加进删除队列了</div><div><div>2020-08-25</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/54/b5/310dae7b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>小刀</span></div></div><div>stream DSL 中除了通过缩短时间窗口可以减小 state.dir（/tmp/kafka-streams）的大小之外还有别的方式么？</div><div><p>作者回复：没有太好的方法</p></div><div><div>2020-07-04</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>曾轼麟</span></div></div><div>controllerContext 中的 topicsToBeDeleted （待删除主题列表）和 zk 中的 /delete_topics 列表 进行 &amp; 得到暂时不可删除的 topic。
暂时不可删除的原因：
1、topic 存在的部分副本 down 了
2、当前 topic 的部分分区正在 reassignment
我理解为是 controllerContext 缓存中的数据，可能会和当前的状态不一致的情况</div><div><p>作者回复: “controllerContext 缓存中的数据，可能会和当前的状态不一致的情况”  比如？能否举个例子？</p></div><div><div>2020-06-27</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>不符合删除的条件 在这里实现，副本关闭停止删除，正在重新分区（扩容到新的 broker）的不可删除。主要做逻辑与 “&amp;” 操作得到不符合删除的 topic。不符合删除的条件 在这里实现，副本关闭停止删除，正在重新分区（扩容到新的 broker）的不可删除。主要做逻辑与 “&amp;” 操作得到不符合删除的 topic。</div><div><p>作者回复: 👍</p></div><div><div>2020-05-30</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1j"><outline class="toc-level-h1" data-reactid=".1j.0" style="width: 175px;"><active data-reactid=".1j.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1j.0.1"><span data-reactid=".1j.0.1.0">16 | TopicDeletionManager： Topic 是怎么被删除的？</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.1" style="width: 165px;"><active data-reactid=".1j.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1j.1.1"><span data-reactid=".1j.1.1.0">课前导读</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.2" style="width: 165px;"><active data-reactid=".1j.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1j.2.1"><span data-reactid=".1j.2.1.0">TopicDeletionManager 概览</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.3" style="width: 165px;"><active data-reactid=".1j.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1j.3.1"><span data-reactid=".1j.3.1.0">DeletionClient 接口及其实现</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.4" style="width: 165px;"><active data-reactid=".1j.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1j.4.1"><span data-reactid=".1j.4.1.0">TopicDeletionManager 定义及初始化</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.5" style="width: 165px;"><active data-reactid=".1j.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1j.5.1"><span data-reactid=".1j.5.1.0">TopicDeletionManager 重要方法</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.6" style="width: 165px;"><active data-reactid=".1j.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1j.6.1"><span data-reactid=".1j.6.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.7" style="width: 165px;"><active data-reactid=".1j.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1j.7.1"><span data-reactid=".1j.7.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.8" style="width: 165px;"><active data-reactid=".1j.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1j.8.1"><span data-reactid=".1j.8.1.0">精选留言 (8)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/241066" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>