
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 12 | ControllerChannelManager：Controller 如何管理请求发送？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>12 | ControllerChannelManager：Controller 如何管理请求发送？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">12 | ControllerChannelManager：Controller 如何管理请求发送？</h1><div><span>胡夕</span> <span> 2020-05-16</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/9a/ef/9a28662042adcd4f9d0cd324974d3aef.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：17.20M</span><span> 时长：18:47</span></div></div><audio title="12 | ControllerChannelManager：Controller如何管理请求发送？" src="https://res001.geekbang.org//media/audio/27/03/2788d6cb2b61d63a9dd239be95b61d03/ld/ld.m3u8" __idm_id__="49167"></audio></div><div><div><div><div data-slate-editor="true" data-key="13208" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="13209"><span data-slate-object="text" data-key="13210"><span data-slate-leaf="true" data-offset-key="13210:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。上节课，我们深入研究了 ControllerContext.scala 源码文件，掌握了 Kafka 集群定义的重要元数据。今天，我们来学习下 Controller 是如何给其他 Broker 发送请求的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13211"><span data-slate-object="text" data-key="13212"><span data-slate-leaf="true" data-offset-key="13212:0" data-first-offset="true"><span data-slate-string="true">掌握了这部分实现原理，你就能更好地了解 Controller 究竟是如何与集群 Broker 进行交互，从而实现管理集群元数据的功能的。而且，阅读这部分源码，还能帮你定位和解决线上问题。我先跟你分享一个真实的案例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13213"><span data-slate-object="text" data-key="13214"><span data-slate-leaf="true" data-offset-key="13214:0" data-first-offset="true"><span data-slate-string="true">当时还是在 Kafka 0.10.0.1 时代，我们突然发现，在线上环境中，很多元数据变更无法在集群的所有 Broker 上同步了。具体表现为，创建了主题后，有些 Broker 依然无法感知到。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13215"><span data-slate-object="text" data-key="13216"><span data-slate-leaf="true" data-offset-key="13216:0" data-first-offset="true"><span data-slate-string="true">我的第一感觉是 Controller 出现了问题，但又苦于无从排查和验证。后来，我想到，会不会是 Controller 端请求队列中积压的请求太多造成的呢？因为当时 Controller 所在的 Broker 本身承载着非常重的业务，这是非常有可能的原因。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13217"><span data-slate-object="text" data-key="13218"><span data-slate-leaf="true" data-offset-key="13218:0" data-first-offset="true"><span data-slate-string="true">在看了相关代码后，我们就在相应的源码中新加了一个监控指标，用于实时监控 Controller 的请求队列长度。当更新到生产环境后，我们很轻松地定位了问题。果然，由于 Controller 所在的 Broker 自身负载过大，导致 Controller 端的请求积压，从而造成了元数据更新的滞后。精准定位了问题之后，解决起来就很容易了。后来，社区于 0.11 版本正式引入了相关的监控指标。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13219"><span data-slate-object="text" data-key="13220"><span data-slate-leaf="true" data-offset-key="13220:0" data-first-offset="true"><span data-slate-string="true">你看，阅读源码，除了可以学习优秀开发人员编写的代码之外，我们还能根据自身的实际情况做定制化方案，实现一些非开箱即用的功能。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13221" id="sr-toc-1"><span data-slate-object="text" data-key="13222"><span data-slate-leaf="true" data-offset-key="13222:0" data-first-offset="true"><span data-slate-string="true">Controller 发送请求类型</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13223"><span data-slate-object="text" data-key="13224"><span data-slate-leaf="true" data-offset-key="13224:0" data-first-offset="true"><span data-slate-string="true">下面，我们就正式进入到 Controller 请求发送管理部分的学习。你可能会问：“Controller 也会给 Broker 发送请求吗？” 当然！</span></span></span><span data-slate-object="text" data-key="13225"><span data-slate-leaf="true" data-offset-key="13225:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Controller 会给集群中的所有 Broker（包括它自己所在的 Broker）机器发送网络请求</span></span></span></span><span data-slate-object="text" data-key="13226"><span data-slate-leaf="true" data-offset-key="13226:0" data-first-offset="true"><span data-slate-string="true">。发送请求的目的，是让 Broker 执行相应的指令。我用一张图，来展示下 Controller 都会发送哪些请求，如下所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13227"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/3e/f7/3e8b0a34f003db5d67d5adafe8781ef7.jpg?wh=1403*1254"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13228"><span data-slate-object="text" data-key="13229"><span data-slate-leaf="true" data-offset-key="13229:0" data-first-offset="true"><span data-slate-string="true">当前，Controller 只会向 Broker 发送三类请求，分别是 LeaderAndIsrRequest、StopReplicaRequest 和 UpdateMetadataRequest。注意，这里我使用的是 “当前”！我只是说，目前仅有这三类，不代表以后不会有变化。事实上，我几乎可以肯定，以后能发送的 RPC 协议种类一定会变化的。因此，你需要掌握请求发送的原理。毕竟，所有请求发送都是通过相同的机制完成的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13230"><span data-slate-object="text" data-key="13231"><span data-slate-leaf="true" data-offset-key="13231:0" data-first-offset="true"><span data-slate-string="true">还记得我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="13232"><span data-slate-object="text" data-key="13233"><span data-slate-leaf="true" data-offset-key="13233:0" data-first-offset="true"><span data-slate-string="true">第 8 节课</span></span></span></a><span data-slate-object="text" data-key="13234"><span data-slate-leaf="true" data-offset-key="13234:0" data-first-offset="true"><span data-slate-string="true">提到的控制类请求吗？没错，这三类请求就是典型的控制类请求。我来解释下它们的作用。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13235"><div data-slate-type="list-line" data-slate-object="block" data-key="13236"><span data-slate-object="text" data-key="13237"><span data-slate-leaf="true" data-offset-key="13237:0" data-first-offset="true"><span data-slate-string="true">LeaderAndIsrRequest：最主要的功能是，告诉 Broker 相关主题各个分区的 Leader 副本位于哪台 Broker 上、ISR 中的副本都在哪些 Broker 上。在我看来，</span></span></span><span data-slate-object="text" data-key="13238"><span data-slate-leaf="true" data-offset-key="13238:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">它应该被赋予最高的优先级，毕竟，它有令数据类请求直接失效的本领</span></span></span></span><span data-slate-object="text" data-key="13239"><span data-slate-leaf="true" data-offset-key="13239:0" data-first-offset="true"><span data-slate-string="true">。试想一下，如果这个请求中的 Leader 副本变更了，之前发往老的 Leader 的 PRODUCE 请求是不是全部失效了？因此，我认为它是非常重要的控制类请求。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13240"><span data-slate-object="text" data-key="13241"><span data-slate-leaf="true" data-offset-key="13241:0" data-first-offset="true"><span data-slate-string="true">StopReplicaRequest：告知指定 Broker 停止它上面的副本对象，该请求甚至还能删除副本底层的日志数据。这个请求主要的使用场景，是</span></span></span><span data-slate-object="text" data-key="13242"><span data-slate-leaf="true" data-offset-key="13242:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">分区副本迁移</span></span></span></span><span data-slate-object="text" data-key="13243"><span data-slate-leaf="true" data-offset-key="13243:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><span data-slate-object="text" data-key="13244"><span data-slate-leaf="true" data-offset-key="13244:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">删除主题</span></span></span></span><span data-slate-object="text" data-key="13245"><span data-slate-leaf="true" data-offset-key="13245:0" data-first-offset="true"><span data-slate-string="true">。在这两个场景下，都要涉及停掉 Broker 上的副本操作。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13246"><span data-slate-object="text" data-key="13247"><span data-slate-leaf="true" data-offset-key="13247:0" data-first-offset="true"><span data-slate-string="true">UpdateMetadataRequest：顾名思义，该请求会更新 Broker 上的元数据缓存。</span></span><span data-slate-leaf="true" data-offset-key="13247:1"><span data-slate-object="annotation" data-annotation-key="gkann_fed32a90" data-attr-id="32464" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">集群上的所有元数据变更，都首先发生在 Controller 端，然后再经由这个请求广播给集群上的所有 Broker。</span></span></span><span data-slate-leaf="true" data-offset-key="13247:2"><span data-slate-string="true">在我刚刚分享的案例中，正是因为这个请求被处理得不及时，才导致集群 Broker 无法获取到最新的元数据信息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13248"><span data-slate-object="text" data-key="13249"><span data-slate-leaf="true" data-offset-key="13249:0" data-first-offset="true"><span data-slate-string="true">现在，社区越来越倾向于</span></span></span><span data-slate-object="text" data-key="13250"><span data-slate-leaf="true" data-offset-key="13250:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">将重要的数据结构源代码从服务器端的 core 工程移动到客户端的 clients 工程中</span></span></span></span><span data-slate-object="text" data-key="13251"><span data-slate-leaf="true" data-offset-key="13251:0" data-first-offset="true"><span data-slate-string="true">。这三类请求 Java 类的定义就封装在 clients 中，它们的抽象基类是 AbstractControlRequest 类，这个类定义了这三类请求的公共字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13252"><span data-slate-object="text" data-key="13253"><span data-slate-leaf="true" data-offset-key="13253:0" data-first-offset="true"><span data-slate-string="true">我用代码展示下这三类请求及其抽象父类的定义，以便让你对 Controller 发送的请求类型有个基本的认识。这些类位于 clients 工程下的 src/main/java/org/apache/kafka/common/requests 路径下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13254"><span data-slate-object="text" data-key="13255"><span data-slate-leaf="true" data-offset-key="13255:0" data-first-offset="true"><span data-slate-string="true">先来看 AbstractControlRequest 类的主要代码：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13256"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13257"><span data-slate-object="text" data-key="13258"><span data-slate-leaf="true" data-offset-key="13258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="13259"><span data-slate-leaf="true" data-offset-key="13259:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13260"><span data-slate-leaf="true" data-offset-key="13260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">abstract</span></span></span></span><span data-slate-object="text" data-key="13261"><span data-slate-leaf="true" data-offset-key="13261:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13262"><span data-slate-leaf="true" data-offset-key="13262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13263"><span data-slate-leaf="true" data-offset-key="13263:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13264"><span data-slate-leaf="true" data-offset-key="13264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest</span></span></span></span><span data-slate-object="text" data-key="13265"><span data-slate-leaf="true" data-offset-key="13265:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13266"><span data-slate-leaf="true" data-offset-key="13266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13267"><span data-slate-leaf="true" data-offset-key="13267:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13268"><span data-slate-leaf="true" data-offset-key="13268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractRequest</span></span></span></span><span data-slate-object="text" data-key="13269"><span data-slate-leaf="true" data-offset-key="13269:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13270"><span data-slate-object="text" data-key="13271"><span data-slate-leaf="true" data-offset-key="13271:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13272"><span data-slate-leaf="true" data-offset-key="13272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="13273"><span data-slate-leaf="true" data-offset-key="13273:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13274"><span data-slate-leaf="true" data-offset-key="13274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="13275"><span data-slate-leaf="true" data-offset-key="13275:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13276"><span data-slate-leaf="true" data-offset-key="13276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="13277"><span data-slate-leaf="true" data-offset-key="13277:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13278"><span data-slate-leaf="true" data-offset-key="13278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13279"><span data-slate-leaf="true" data-offset-key="13279:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13280"><span data-slate-leaf="true" data-offset-key="13280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">UNKNOWN_BROKER_EPOCH</span></span></span></span><span data-slate-object="text" data-key="13281"><span data-slate-leaf="true" data-offset-key="13281:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13282"><span data-slate-leaf="true" data-offset-key="13282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13283"><span data-slate-leaf="true" data-offset-key="13283:0" data-first-offset="true"><span data-slate-string="true"> -</span></span></span><span data-slate-object="text" data-key="13284"><span data-slate-leaf="true" data-offset-key="13284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1L</span></span></span></span><span data-slate-object="text" data-key="13285"><span data-slate-leaf="true" data-offset-key="13285:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13286"><span data-slate-object="text" data-key="13287"><span data-slate-leaf="true" data-offset-key="13287:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13288"><span data-slate-leaf="true" data-offset-key="13288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="13289"><span data-slate-leaf="true" data-offset-key="13289:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13290"><span data-slate-leaf="true" data-offset-key="13290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="13291"><span data-slate-leaf="true" data-offset-key="13291:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13292"><span data-slate-leaf="true" data-offset-key="13292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">abstract</span></span></span></span><span data-slate-object="text" data-key="13293"><span data-slate-leaf="true" data-offset-key="13293:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13294"><span data-slate-leaf="true" data-offset-key="13294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13295"><span data-slate-leaf="true" data-offset-key="13295:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13296"><span data-slate-leaf="true" data-offset-key="13296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Builder</span></span></span></span><span data-slate-object="text" data-key="13297"><span data-slate-leaf="true" data-offset-key="13297:0" data-first-offset="true"><span data-slate-string="true">&lt;T </span></span></span><span data-slate-object="text" data-key="13298"><span data-slate-leaf="true" data-offset-key="13298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13299"><span data-slate-leaf="true" data-offset-key="13299:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13300"><span data-slate-leaf="true" data-offset-key="13300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractRequest</span></span></span></span><span data-slate-object="text" data-key="13301"><span data-slate-leaf="true" data-offset-key="13301:0" data-first-offset="true"><span data-slate-string="true">&gt; </span></span></span><span data-slate-object="text" data-key="13302"><span data-slate-leaf="true" data-offset-key="13302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13303"><span data-slate-leaf="true" data-offset-key="13303:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13304"><span data-slate-leaf="true" data-offset-key="13304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractRequest</span></span></span></span><span data-slate-object="text" data-key="13305"><span data-slate-leaf="true" data-offset-key="13305:0" data-first-offset="true"><span data-slate-string="true">.Builder&lt;T&gt; {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13306"><span data-slate-object="text" data-key="13307"><span data-slate-leaf="true" data-offset-key="13307:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13308"><span data-slate-leaf="true" data-offset-key="13308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected</span></span></span></span><span data-slate-object="text" data-key="13309"><span data-slate-leaf="true" data-offset-key="13309:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13310"><span data-slate-leaf="true" data-offset-key="13310:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="13311"><span data-slate-leaf="true" data-offset-key="13311:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13312"><span data-slate-leaf="true" data-offset-key="13312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13313"><span data-slate-leaf="true" data-offset-key="13313:0" data-first-offset="true"><span data-slate-string="true"> controllerId;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13314"><span data-slate-object="text" data-key="13315"><span data-slate-leaf="true" data-offset-key="13315:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13316"><span data-slate-leaf="true" data-offset-key="13316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected</span></span></span></span><span data-slate-object="text" data-key="13317"><span data-slate-leaf="true" data-offset-key="13317:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13318"><span data-slate-leaf="true" data-offset-key="13318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="13319"><span data-slate-leaf="true" data-offset-key="13319:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13320"><span data-slate-leaf="true" data-offset-key="13320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="13321"><span data-slate-leaf="true" data-offset-key="13321:0" data-first-offset="true"><span data-slate-string="true"> controllerEpoch;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13322"><span data-slate-object="text" data-key="13323"><span data-slate-leaf="true" data-offset-key="13323:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13324"><span data-slate-leaf="true" data-offset-key="13324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected</span></span></span></span><span data-slate-object="text" data-key="13325"><span data-slate-leaf="true" data-offset-key="13325:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13326"><span data-slate-leaf="true" data-offset-key="13326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="13327"><span data-slate-leaf="true" data-offset-key="13327:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13328"><span data-slate-leaf="true" data-offset-key="13328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="13329"><span data-slate-leaf="true" data-offset-key="13329:0" data-first-offset="true"><span data-slate-string="true"> brokerEpoch;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13330"><span data-slate-object="text" data-key="13331"><span data-slate-leaf="true" data-offset-key="13331:0" data-first-offset="true"><span data-slate-string="true">        ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13332"><span data-slate-object="text" data-key="13333"><span data-slate-leaf="true" data-offset-key="13333:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13334"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13335"><span data-slate-object="text" data-key="13336"><span data-slate-leaf="true" data-offset-key="13336:0" data-first-offset="true"><span data-slate-string="true">区别于其他的数据类请求，抽象类请求必然包含 3 个字段。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13337"><div data-slate-type="list-line" data-slate-object="block" data-key="13338"><span data-slate-object="text" data-key="13339"><span data-slate-leaf="true" data-offset-key="13339:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">controllerId</span></span></span></span><span data-slate-object="text" data-key="13340"><span data-slate-leaf="true" data-offset-key="13340:0" data-first-offset="true"><span data-slate-string="true">：Controller 所在的 Broker ID。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13341"><span data-slate-object="text" data-key="13342"><span data-slate-leaf="true" data-offset-key="13342:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">controllerEpoch</span></span></span></span><span data-slate-object="text" data-key="13343"><span data-slate-leaf="true" data-offset-key="13343:0" data-first-offset="true"><span data-slate-string="true">：Controller 的版本信息。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13344"><span data-slate-object="text" data-key="13345"><span data-slate-leaf="true" data-offset-key="13345:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerEpoch</span></span></span></span><span data-slate-object="text" data-key="13346"><span data-slate-leaf="true" data-offset-key="13346:0" data-first-offset="true"><span data-slate-string="true">：目标 Broker 的 Epoch。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13347"><span data-slate-object="text" data-key="13348"><span data-slate-leaf="true" data-offset-key="13348:0" data-first-offset="true"><span data-slate-string="true">后面这两个 Epoch 字段用于隔离 Zombie Controller 和 Zombie Broker，以保证集群的一致性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13349"><span data-slate-object="text" data-key="13350"><span data-slate-leaf="true" data-offset-key="13350:0" data-first-offset="true"><span data-slate-string="true">在同一源码路径下，你能找到 LeaderAndIsrRequest、StopReplicaRequest 和 UpdateMetadataRequest 的定义，如下所示：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13351"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13352"><span data-slate-object="text" data-key="13353"><span data-slate-leaf="true" data-offset-key="13353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="13354"><span data-slate-leaf="true" data-offset-key="13354:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13355"><span data-slate-leaf="true" data-offset-key="13355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13356"><span data-slate-leaf="true" data-offset-key="13356:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13357"><span data-slate-leaf="true" data-offset-key="13357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">LeaderAndIsrRequest</span></span></span></span><span data-slate-object="text" data-key="13358"><span data-slate-leaf="true" data-offset-key="13358:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13359"><span data-slate-leaf="true" data-offset-key="13359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13360"><span data-slate-leaf="true" data-offset-key="13360:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13361"><span data-slate-leaf="true" data-offset-key="13361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest</span></span></span></span><span data-slate-object="text" data-key="13362"><span data-slate-leaf="true" data-offset-key="13362:0" data-first-offset="true"><span data-slate-string="true"> {......}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13363"><span data-slate-object="text" data-key="13364"><span data-slate-leaf="true" data-offset-key="13364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="13365"><span data-slate-leaf="true" data-offset-key="13365:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13366"><span data-slate-leaf="true" data-offset-key="13366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13367"><span data-slate-leaf="true" data-offset-key="13367:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13368"><span data-slate-leaf="true" data-offset-key="13368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StopReplicaRequest</span></span></span></span><span data-slate-object="text" data-key="13369"><span data-slate-leaf="true" data-offset-key="13369:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13370"><span data-slate-leaf="true" data-offset-key="13370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13371"><span data-slate-leaf="true" data-offset-key="13371:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13372"><span data-slate-leaf="true" data-offset-key="13372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest</span></span></span></span><span data-slate-object="text" data-key="13373"><span data-slate-leaf="true" data-offset-key="13373:0" data-first-offset="true"><span data-slate-string="true"> {......}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13374"><span data-slate-object="text" data-key="13375"><span data-slate-leaf="true" data-offset-key="13375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="13376"><span data-slate-leaf="true" data-offset-key="13376:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13377"><span data-slate-leaf="true" data-offset-key="13377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13378"><span data-slate-leaf="true" data-offset-key="13378:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13379"><span data-slate-leaf="true" data-offset-key="13379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">UpdateMetadataRequest</span></span></span></span><span data-slate-object="text" data-key="13380"><span data-slate-leaf="true" data-offset-key="13380:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13381"><span data-slate-leaf="true" data-offset-key="13381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13382"><span data-slate-leaf="true" data-offset-key="13382:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13383"><span data-slate-leaf="true" data-offset-key="13383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest</span></span></span></span><span data-slate-object="text" data-key="13384"><span data-slate-leaf="true" data-offset-key="13384:0" data-first-offset="true"><span data-slate-string="true"> {......}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13385" id="sr-toc-2"><span data-slate-object="text" data-key="13386"><span data-slate-leaf="true" data-offset-key="13386:0" data-first-offset="true"><span data-slate-string="true">RequestSendThread</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13387"><span data-slate-object="text" data-key="13388"><span data-slate-leaf="true" data-offset-key="13388:0" data-first-offset="true"><span data-slate-string="true">说完了 Controller 发送什么请求，接下来我们说说怎么发。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13389"><span data-slate-object="text" data-key="13390"><span data-slate-leaf="true" data-offset-key="13390:0" data-first-offset="true"><span data-slate-string="true">Kafka 源码非常喜欢生产者 - 消费者模式。该模式的好处在于，</span></span></span><span data-slate-object="text" data-key="13391"><span data-slate-leaf="true" data-offset-key="13391:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">解耦生产者和消费者逻辑，分离两者的集中性交互</span></span></span></span><span data-slate-object="text" data-key="13392"><span data-slate-leaf="true" data-offset-key="13392:0" data-first-offset="true"><span data-slate-string="true">。学完了 “请求处理” 模块，现在，你一定很赞同这个说法吧。还记得 Broker 端的 SocketServer 组件吗？它就在内部定义了一个线程共享的请求队列：它下面的 Processor 线程扮演 Producer，而 KafkaRequestHandler 线程扮演 Consumer。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13393"><span data-slate-object="text" data-key="13394"><span data-slate-leaf="true" data-offset-key="13394:0" data-first-offset="true"><span data-slate-string="true">对于 Controller 而言，源码同样使用了这个模式：它依然是一个线程安全的阻塞队列，Controller 事件处理线程（第 13 节课会详细说它）负责向这个队列写入待发送的请求，而一个名为 RequestSendThread 的线程负责执行真正的请求发送。如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13395"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/82/21/825d084eb1517daace5532d1c93b0321.jpg?wh=2186*1232"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13396"><span data-slate-object="text" data-key="13397"><span data-slate-leaf="true" data-offset-key="13397:0" data-first-offset="true"><span data-slate-string="true">Controller 会为集群中的每个 Broker 都创建一个对应的 RequestSendThread 线程。Broker 上的这个线程，持续地从阻塞队列中获取待发送的请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13398"><span data-slate-object="text" data-key="13399"><span data-slate-leaf="true" data-offset-key="13399:0" data-first-offset="true"><span data-slate-string="true">那么，Controller 往阻塞队列上放什么数据呢？这其实是由源码中的 QueueItem 类定义的。代码如下：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13400"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13401"><span data-slate-object="text" data-key="13402"><span data-slate-leaf="true" data-offset-key="13402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13403"><span data-slate-leaf="true" data-offset-key="13403:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13404"><span data-slate-leaf="true" data-offset-key="13404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13405"><span data-slate-leaf="true" data-offset-key="13405:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13406"><span data-slate-leaf="true" data-offset-key="13406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">QueueItem</span></span></span></span><span data-slate-object="text" data-key="13407"><span data-slate-leaf="true" data-offset-key="13407:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13408"><span data-slate-leaf="true" data-offset-key="13408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">apiKey</span></span></span></span><span data-slate-object="text" data-key="13409"><span data-slate-leaf="true" data-offset-key="13409:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13410"><span data-slate-leaf="true" data-offset-key="13410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ApiKeys</span></span></span></span><span data-slate-object="text" data-key="13411"><span data-slate-leaf="true" data-offset-key="13411:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13412"><span data-slate-leaf="true" data-offset-key="13412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">request</span></span></span></span><span data-slate-object="text" data-key="13413"><span data-slate-leaf="true" data-offset-key="13413:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13414"><span data-slate-leaf="true" data-offset-key="13414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest</span></span></span></span><span data-slate-object="text" data-key="13415"><span data-slate-leaf="true" data-offset-key="13415:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="13416"><span data-slate-leaf="true" data-offset-key="13416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Builder</span></span></span></span><span data-slate-object="text" data-key="13417"><span data-slate-leaf="true" data-offset-key="13417:0" data-first-offset="true"><span data-slate-string="true">[_ &lt;: </span></span></span><span data-slate-object="text" data-key="13418"><span data-slate-leaf="true" data-offset-key="13418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest</span></span></span></span><span data-slate-object="text" data-key="13419"><span data-slate-leaf="true" data-offset-key="13419:0" data-first-offset="true"><span data-slate-string="true">], </span></span></span><span data-slate-object="text" data-key="13420"><span data-slate-leaf="true" data-offset-key="13420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">callback</span></span></span></span><span data-slate-object="text" data-key="13421"><span data-slate-leaf="true" data-offset-key="13421:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13422"><span data-slate-leaf="true" data-offset-key="13422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AbstractResponse</span></span></span></span></span><span data-slate-object="text" data-key="13423"><span data-slate-leaf="true" data-offset-key="13423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span><span data-slate-object="text" data-key="13424"><span data-slate-leaf="true" data-offset-key="13424:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13425"><span data-slate-leaf="true" data-offset-key="13425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unit</span></span></span></span><span data-slate-object="text" data-key="13426"><span data-slate-leaf="true" data-offset-key="13426:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13427"><span data-slate-leaf="true" data-offset-key="13427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">enqueueTimeMs</span></span></span></span><span data-slate-object="text" data-key="13428"><span data-slate-leaf="true" data-offset-key="13428:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13429"><span data-slate-leaf="true" data-offset-key="13429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Long</span></span></span></span><span data-slate-object="text" data-key="13430"><span data-slate-leaf="true" data-offset-key="13430:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13431"><span data-slate-object="text" data-key="13432"><span data-slate-leaf="true" data-offset-key="13432:0" data-first-offset="true"><span data-slate-string="true">每个 QueueItem 的核心字段都是 </span></span></span><span data-slate-object="text" data-key="13433"><span data-slate-leaf="true" data-offset-key="13433:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">AbstractControlRequest.Builder 对象</span></span></span></span><span data-slate-object="text" data-key="13434"><span data-slate-leaf="true" data-offset-key="13434:0" data-first-offset="true"><span data-slate-string="true">。你基本上可以认为，它就是阻塞队列上 AbstractControlRequest 类型。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13435"><span data-slate-object="text" data-key="13436"><span data-slate-leaf="true" data-offset-key="13436:0" data-first-offset="true"><span data-slate-string="true">需要注意的是这里的 “&lt;:” 符号，它在 Scala 中表示</span></span></span><span data-slate-object="text" data-key="13437"><span data-slate-leaf="true" data-offset-key="13437:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">上边界</span></span></span></span><span data-slate-object="text" data-key="13438"><span data-slate-leaf="true" data-offset-key="13438:0" data-first-offset="true"><span data-slate-string="true">的意思，即字段 request 必须是 AbstractControlRequest 的子类，也就是上面说到的那三类请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13439"><span data-slate-object="text" data-key="13440"><span data-slate-leaf="true" data-offset-key="13440:0" data-first-offset="true"><span data-slate-string="true">这也就是说，每个 QueueItem 实际保存的都是那三类请求中的其中一类。如果使用一个 BlockingQueue 对象来保存这些 QueueItem，那么，代码就实现了一个请求阻塞队列。这就是 RequestSendThread 类做的事情。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13441"><span data-slate-object="text" data-key="13442"><span data-slate-leaf="true" data-offset-key="13442:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就来学习下 RequestSendThread 类的定义。我给一些主要的字段添加了注释。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13443"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13444"><span data-slate-object="text" data-key="13445"><span data-slate-leaf="true" data-offset-key="13445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13446"><span data-slate-leaf="true" data-offset-key="13446:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13447"><span data-slate-leaf="true" data-offset-key="13447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestSendThread</span></span></span></span><span data-slate-object="text" data-key="13448"><span data-slate-leaf="true" data-offset-key="13448:0" data-first-offset="true"><span data-slate-string="true">(val </span></span></span><span data-slate-object="text" data-key="13449"><span data-slate-leaf="true" data-offset-key="13449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerId</span></span></span></span><span data-slate-object="text" data-key="13450"><span data-slate-leaf="true" data-offset-key="13450:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13451"><span data-slate-leaf="true" data-offset-key="13451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="13452"><span data-slate-leaf="true" data-offset-key="13452:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13453"><span data-slate-leaf="true" data-offset-key="13453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 所在 Broker 的 Id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13454"><span data-slate-object="text" data-key="13455"><span data-slate-leaf="true" data-offset-key="13455:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13456"><span data-slate-leaf="true" data-offset-key="13456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerContext</span></span></span></span><span data-slate-object="text" data-key="13457"><span data-slate-leaf="true" data-offset-key="13457:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13458"><span data-slate-leaf="true" data-offset-key="13458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerContext</span></span></span></span><span data-slate-object="text" data-key="13459"><span data-slate-leaf="true" data-offset-key="13459:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13460"><span data-slate-leaf="true" data-offset-key="13460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller 元数据信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13461"><span data-slate-object="text" data-key="13462"><span data-slate-leaf="true" data-offset-key="13462:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13463"><span data-slate-leaf="true" data-offset-key="13463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">queue</span></span></span></span><span data-slate-object="text" data-key="13464"><span data-slate-leaf="true" data-offset-key="13464:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13465"><span data-slate-leaf="true" data-offset-key="13465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BlockingQueue</span></span></span></span><span data-slate-object="text" data-key="13466"><span data-slate-leaf="true" data-offset-key="13466:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13467"><span data-slate-leaf="true" data-offset-key="13467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">QueueItem</span></span></span></span><span data-slate-object="text" data-key="13468"><span data-slate-leaf="true" data-offset-key="13468:0" data-first-offset="true"><span data-slate-string="true">], </span></span></span><span data-slate-object="text" data-key="13469"><span data-slate-leaf="true" data-offset-key="13469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 请求阻塞队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13470"><span data-slate-object="text" data-key="13471"><span data-slate-leaf="true" data-offset-key="13471:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13472"><span data-slate-leaf="true" data-offset-key="13472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">networkClient</span></span></span></span><span data-slate-object="text" data-key="13473"><span data-slate-leaf="true" data-offset-key="13473:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13474"><span data-slate-leaf="true" data-offset-key="13474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NetworkClient</span></span></span></span><span data-slate-object="text" data-key="13475"><span data-slate-leaf="true" data-offset-key="13475:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13476"><span data-slate-leaf="true" data-offset-key="13476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于执行发送的网络 I/O 类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13477"><span data-slate-object="text" data-key="13478"><span data-slate-leaf="true" data-offset-key="13478:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13479"><span data-slate-leaf="true" data-offset-key="13479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerNode</span></span></span></span><span data-slate-object="text" data-key="13480"><span data-slate-leaf="true" data-offset-key="13480:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13481"><span data-slate-leaf="true" data-offset-key="13481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Node</span></span></span></span><span data-slate-object="text" data-key="13482"><span data-slate-leaf="true" data-offset-key="13482:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13483"><span data-slate-leaf="true" data-offset-key="13483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 目标 Broker 节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13484"><span data-slate-object="text" data-key="13485"><span data-slate-leaf="true" data-offset-key="13485:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13486"><span data-slate-leaf="true" data-offset-key="13486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">config</span></span></span></span><span data-slate-object="text" data-key="13487"><span data-slate-leaf="true" data-offset-key="13487:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13488"><span data-slate-leaf="true" data-offset-key="13488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaConfig</span></span></span></span><span data-slate-object="text" data-key="13489"><span data-slate-leaf="true" data-offset-key="13489:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="13490"><span data-slate-leaf="true" data-offset-key="13490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Kafka 配置信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13491"><span data-slate-object="text" data-key="13492"><span data-slate-leaf="true" data-offset-key="13492:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13493"><span data-slate-leaf="true" data-offset-key="13493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">time</span></span></span></span><span data-slate-object="text" data-key="13494"><span data-slate-leaf="true" data-offset-key="13494:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13495"><span data-slate-leaf="true" data-offset-key="13495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Time</span></span></span></span><span data-slate-object="text" data-key="13496"><span data-slate-leaf="true" data-offset-key="13496:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13497"><span data-slate-object="text" data-key="13498"><span data-slate-leaf="true" data-offset-key="13498:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13499"><span data-slate-leaf="true" data-offset-key="13499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestRateAndQueueTimeMetrics</span></span></span></span><span data-slate-object="text" data-key="13500"><span data-slate-leaf="true" data-offset-key="13500:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13501"><span data-slate-leaf="true" data-offset-key="13501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Timer</span></span></span></span><span data-slate-object="text" data-key="13502"><span data-slate-leaf="true" data-offset-key="13502:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13503"><span data-slate-object="text" data-key="13504"><span data-slate-leaf="true" data-offset-key="13504:0" data-first-offset="true"><span data-slate-string="true">    val </span></span></span><span data-slate-object="text" data-key="13505"><span data-slate-leaf="true" data-offset-key="13505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stateChangeLogger</span></span></span></span><span data-slate-object="text" data-key="13506"><span data-slate-leaf="true" data-offset-key="13506:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13507"><span data-slate-leaf="true" data-offset-key="13507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StateChangeLogger</span></span></span></span><span data-slate-object="text" data-key="13508"><span data-slate-leaf="true" data-offset-key="13508:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13509"><span data-slate-object="text" data-key="13510"><span data-slate-leaf="true" data-offset-key="13510:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13511"><span data-slate-leaf="true" data-offset-key="13511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">name</span></span></span></span><span data-slate-object="text" data-key="13512"><span data-slate-leaf="true" data-offset-key="13512:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13513"><span data-slate-leaf="true" data-offset-key="13513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="13514"><span data-slate-leaf="true" data-offset-key="13514:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="13515"><span data-slate-leaf="true" data-offset-key="13515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="13516"><span data-slate-leaf="true" data-offset-key="13516:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13517"><span data-slate-leaf="true" data-offset-key="13517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ShutdownableThread</span></span></span></span><span data-slate-object="text" data-key="13518"><span data-slate-leaf="true" data-offset-key="13518:0" data-first-offset="true"><span data-slate-string="true">(name = name) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13519"><span data-slate-object="text" data-key="13520"><span data-slate-leaf="true" data-offset-key="13520:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13521"><span data-slate-object="text" data-key="13522"><span data-slate-leaf="true" data-offset-key="13522:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13523"><span data-slate-object="text" data-key="13524"><span data-slate-leaf="true" data-offset-key="13524:0" data-first-offset="true"><span data-slate-string="true">其实，RequestSendThread 最重要的是它的 </span></span></span><span data-slate-object="text" data-key="13525"><span data-slate-leaf="true" data-offset-key="13525:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">doWork 方法</span></span></span></span><span data-slate-object="text" data-key="13526"><span data-slate-leaf="true" data-offset-key="13526:0" data-first-offset="true"><span data-slate-string="true">，也就是执行线程逻辑的方法：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="13527"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13528"><span data-slate-object="text" data-key="13529"><span data-slate-leaf="true" data-offset-key="13529:0" data-first-offset="true"><span data-slate-string="true">override def doWork(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13530"><span data-slate-object="text" data-key="13531"><span data-slate-leaf="true" data-offset-key="13531:0" data-first-offset="true"><span data-slate-string="true">    def backoff(): Unit = pause(</span></span></span><span data-slate-object="text" data-key="13532"><span data-slate-leaf="true" data-offset-key="13532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">100</span></span></span></span><span data-slate-object="text" data-key="13533"><span data-slate-leaf="true" data-offset-key="13533:0" data-first-offset="true"><span data-slate-string="true">, TimeUnit.MILLISECONDS)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13534"><span data-slate-object="text" data-key="13535"><span data-slate-leaf="true" data-offset-key="13535:0" data-first-offset="true"><span data-slate-string="true">    val QueueItem(apiKey, requestBuilder, callback, enqueueTimeMs) = queue.take() </span></span></span><span data-slate-object="text" data-key="13536"><span data-slate-leaf="true" data-offset-key="13536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 以阻塞的方式从阻塞队列中取出请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13537"><span data-slate-object="text" data-key="13538"><span data-slate-leaf="true" data-offset-key="13538:0" data-first-offset="true"><span data-slate-string="true">    requestRateAndQueueTimeMetrics.update(time.milliseconds() - enqueueTimeMs, TimeUnit.MILLISECONDS) </span></span></span><span data-slate-object="text" data-key="13539"><span data-slate-leaf="true" data-offset-key="13539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新统计信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13540"><span data-slate-object="text" data-key="13541"><span data-slate-leaf="true" data-offset-key="13541:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13542"><span data-slate-leaf="true" data-offset-key="13542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="13543"><span data-slate-leaf="true" data-offset-key="13543:0" data-first-offset="true"><span data-slate-string="true"> clientResponse: ClientResponse = </span></span></span><span data-slate-object="text" data-key="13544"><span data-slate-leaf="true" data-offset-key="13544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13545"><span data-slate-object="text" data-key="13546"><span data-slate-leaf="true" data-offset-key="13546:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13547"><span data-slate-leaf="true" data-offset-key="13547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="13548"><span data-slate-leaf="true" data-offset-key="13548:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13549"><span data-slate-object="text" data-key="13550"><span data-slate-leaf="true" data-offset-key="13550:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13551"><span data-slate-leaf="true" data-offset-key="13551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="13552"><span data-slate-leaf="true" data-offset-key="13552:0" data-first-offset="true"><span data-slate-string="true"> isSendSuccessful = </span></span></span><span data-slate-object="text" data-key="13553"><span data-slate-leaf="true" data-offset-key="13553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13554"><span data-slate-object="text" data-key="13555"><span data-slate-leaf="true" data-offset-key="13555:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13556"><span data-slate-leaf="true" data-offset-key="13556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="13557"><span data-slate-leaf="true" data-offset-key="13557:0" data-first-offset="true"><span data-slate-string="true"> (isRunning &amp;&amp; !isSendSuccessful) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13558"><span data-slate-object="text" data-key="13559"><span data-slate-leaf="true" data-offset-key="13559:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13560"><span data-slate-leaf="true" data-offset-key="13560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="13561"><span data-slate-leaf="true" data-offset-key="13561:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13562"><span data-slate-object="text" data-key="13563"><span data-slate-leaf="true" data-offset-key="13563:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13564"><span data-slate-leaf="true" data-offset-key="13564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果没有创建与目标 Broker 的 TCP 连接，或连接暂时不可用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13565"><span data-slate-object="text" data-key="13566"><span data-slate-leaf="true" data-offset-key="13566:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13567"><span data-slate-leaf="true" data-offset-key="13567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13568"><span data-slate-leaf="true" data-offset-key="13568:0" data-first-offset="true"><span data-slate-string="true"> (!brokerReady()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13569"><span data-slate-object="text" data-key="13570"><span data-slate-leaf="true" data-offset-key="13570:0" data-first-offset="true"><span data-slate-string="true">            isSendSuccessful = </span></span></span><span data-slate-object="text" data-key="13571"><span data-slate-leaf="true" data-offset-key="13571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13572"><span data-slate-object="text" data-key="13573"><span data-slate-leaf="true" data-offset-key="13573:0" data-first-offset="true"><span data-slate-string="true">            backoff() </span></span></span><span data-slate-object="text" data-key="13574"><span data-slate-leaf="true" data-offset-key="13574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待重试</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13575"><span data-slate-object="text" data-key="13576"><span data-slate-leaf="true" data-offset-key="13576:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13577"><span data-slate-object="text" data-key="13578"><span data-slate-leaf="true" data-offset-key="13578:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13579"><span data-slate-leaf="true" data-offset-key="13579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="13580"><span data-slate-leaf="true" data-offset-key="13580:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13581"><span data-slate-object="text" data-key="13582"><span data-slate-leaf="true" data-offset-key="13582:0" data-first-offset="true"><span data-slate-string="true">            val clientRequest = networkClient.newClientRequest(brokerNode.idString, requestBuilder,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13583"><span data-slate-object="text" data-key="13584"><span data-slate-leaf="true" data-offset-key="13584:0" data-first-offset="true"><span data-slate-string="true">              time.milliseconds(), </span></span></span><span data-slate-object="text" data-key="13585"><span data-slate-leaf="true" data-offset-key="13585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="13586"><span data-slate-leaf="true" data-offset-key="13586:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13587"><span data-slate-object="text" data-key="13588"><span data-slate-leaf="true" data-offset-key="13588:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13589"><span data-slate-leaf="true" data-offset-key="13589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 发送请求，等待接收 Response</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13590"><span data-slate-object="text" data-key="13591"><span data-slate-leaf="true" data-offset-key="13591:0" data-first-offset="true"><span data-slate-string="true">            clientResponse = NetworkClientUtils.sendAndReceive(networkClient, clientRequest, time)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13592"><span data-slate-object="text" data-key="13593"><span data-slate-leaf="true" data-offset-key="13593:0" data-first-offset="true"><span data-slate-string="true">            isSendSuccessful = </span></span></span><span data-slate-object="text" data-key="13594"><span data-slate-leaf="true" data-offset-key="13594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13595"><span data-slate-object="text" data-key="13596"><span data-slate-leaf="true" data-offset-key="13596:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13597"><span data-slate-object="text" data-key="13598"><span data-slate-leaf="true" data-offset-key="13598:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="13599"><span data-slate-leaf="true" data-offset-key="13599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="13600"><span data-slate-leaf="true" data-offset-key="13600:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13601"><span data-slate-object="text" data-key="13602"><span data-slate-leaf="true" data-offset-key="13602:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13603"><span data-slate-leaf="true" data-offset-key="13603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13604"><span data-slate-leaf="true" data-offset-key="13604:0" data-first-offset="true"><span data-slate-string="true"> e: Throwable =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13605"><span data-slate-object="text" data-key="13606"><span data-slate-leaf="true" data-offset-key="13606:0" data-first-offset="true"><span data-slate-string="true">            warn(s</span></span></span><span data-slate-object="text" data-key="13607"><span data-slate-leaf="true" data-offset-key="13607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Controller </span></span></span></span><span data-slate-object="text" data-key="13608"><span data-slate-leaf="true" data-offset-key="13608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerId</span></span></span></span></span><span data-slate-object="text" data-key="13609"><span data-slate-leaf="true" data-offset-key="13609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> epoch </span></span></span></span><span data-slate-object="text" data-key="13610"><span data-slate-leaf="true" data-offset-key="13610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${controllerContext.epoch}</span></span></span></span></span><span data-slate-object="text" data-key="13611"><span data-slate-leaf="true" data-offset-key="13611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> fails to send request </span></span></span></span><span data-slate-object="text" data-key="13612"><span data-slate-leaf="true" data-offset-key="13612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$requestBuilder</span></span></span></span></span><span data-slate-object="text" data-key="13613"><span data-slate-leaf="true" data-offset-key="13613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> "</span></span></span></span><span data-slate-object="text" data-key="13614"><span data-slate-leaf="true" data-offset-key="13614:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13615"><span data-slate-object="text" data-key="13616"><span data-slate-leaf="true" data-offset-key="13616:0" data-first-offset="true"><span data-slate-string="true">              s</span></span></span><span data-slate-object="text" data-key="13617"><span data-slate-leaf="true" data-offset-key="13617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"to broker </span></span></span></span><span data-slate-object="text" data-key="13618"><span data-slate-leaf="true" data-offset-key="13618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$brokerNode</span></span></span></span></span><span data-slate-object="text" data-key="13619"><span data-slate-leaf="true" data-offset-key="13619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">. Reconnecting to broker."</span></span></span></span><span data-slate-object="text" data-key="13620"><span data-slate-leaf="true" data-offset-key="13620:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13621"><span data-slate-object="text" data-key="13622"><span data-slate-leaf="true" data-offset-key="13622:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="13623"><span data-slate-leaf="true" data-offset-key="13623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果出现异常，关闭与对应 Broker 的连接</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13624"><span data-slate-object="text" data-key="13625"><span data-slate-leaf="true" data-offset-key="13625:0" data-first-offset="true"><span data-slate-string="true">            networkClient.close(brokerNode.idString)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13626"><span data-slate-object="text" data-key="13627"><span data-slate-leaf="true" data-offset-key="13627:0" data-first-offset="true"><span data-slate-string="true">            isSendSuccessful = </span></span></span><span data-slate-object="text" data-key="13628"><span data-slate-leaf="true" data-offset-key="13628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13629"><span data-slate-object="text" data-key="13630"><span data-slate-leaf="true" data-offset-key="13630:0" data-first-offset="true"><span data-slate-string="true">            backoff()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13631"><span data-slate-object="text" data-key="13632"><span data-slate-leaf="true" data-offset-key="13632:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13633"><span data-slate-object="text" data-key="13634"><span data-slate-leaf="true" data-offset-key="13634:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13635"><span data-slate-object="text" data-key="13636"><span data-slate-leaf="true" data-offset-key="13636:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13637"><span data-slate-leaf="true" data-offset-key="13637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果接收到了 Response</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13638"><span data-slate-object="text" data-key="13639"><span data-slate-leaf="true" data-offset-key="13639:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13640"><span data-slate-leaf="true" data-offset-key="13640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13641"><span data-slate-leaf="true" data-offset-key="13641:0" data-first-offset="true"><span data-slate-string="true"> (clientResponse != </span></span></span><span data-slate-object="text" data-key="13642"><span data-slate-leaf="true" data-offset-key="13642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="13643"><span data-slate-leaf="true" data-offset-key="13643:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13644"><span data-slate-object="text" data-key="13645"><span data-slate-leaf="true" data-offset-key="13645:0" data-first-offset="true"><span data-slate-string="true">        val requestHeader = clientResponse.requestHeader</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13646"><span data-slate-object="text" data-key="13647"><span data-slate-leaf="true" data-offset-key="13647:0" data-first-offset="true"><span data-slate-string="true">        val api = requestHeader.apiKey</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13648"><span data-slate-object="text" data-key="13649"><span data-slate-leaf="true" data-offset-key="13649:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13650"><span data-slate-leaf="true" data-offset-key="13650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 此 Response 的请求类型必须是 LeaderAndIsrRequest、StopReplicaRequest 或 UpdateMetadataRequest 中的一种</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13651"><span data-slate-object="text" data-key="13652"><span data-slate-leaf="true" data-offset-key="13652:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13653"><span data-slate-leaf="true" data-offset-key="13653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13654"><span data-slate-leaf="true" data-offset-key="13654:0" data-first-offset="true"><span data-slate-string="true"> (api != ApiKeys.LEADER_AND_ISR &amp;&amp; api != ApiKeys.STOP_REPLICA &amp;&amp; api != ApiKeys.UPDATE_METADATA)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13655"><span data-slate-object="text" data-key="13656"><span data-slate-leaf="true" data-offset-key="13656:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="13657"><span data-slate-leaf="true" data-offset-key="13657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="13658"><span data-slate-leaf="true" data-offset-key="13658:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13659"><span data-slate-leaf="true" data-offset-key="13659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13660"><span data-slate-leaf="true" data-offset-key="13660:0" data-first-offset="true"><span data-slate-string="true"> KafkaException(s</span></span></span><span data-slate-object="text" data-key="13661"><span data-slate-leaf="true" data-offset-key="13661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Unexpected apiKey received: </span></span></span></span><span data-slate-object="text" data-key="13662"><span data-slate-leaf="true" data-offset-key="13662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$apiKey</span></span></span></span></span><span data-slate-object="text" data-key="13663"><span data-slate-leaf="true" data-offset-key="13663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13664"><span data-slate-leaf="true" data-offset-key="13664:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13665"><span data-slate-object="text" data-key="13666"><span data-slate-leaf="true" data-offset-key="13666:0" data-first-offset="true"><span data-slate-string="true">        val response = clientResponse.responseBody</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13667"><span data-slate-object="text" data-key="13668"><span data-slate-leaf="true" data-offset-key="13668:0" data-first-offset="true"><span data-slate-string="true">        stateChangeLogger.withControllerEpoch(controllerContext.epoch)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13669"><span data-slate-object="text" data-key="13670"><span data-slate-leaf="true" data-offset-key="13670:0" data-first-offset="true"><span data-slate-string="true">          .trace(s</span></span></span><span data-slate-object="text" data-key="13671"><span data-slate-leaf="true" data-offset-key="13671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Received response"</span></span></span></span><span data-slate-object="text" data-key="13672"><span data-slate-leaf="true" data-offset-key="13672:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13673"><span data-slate-object="text" data-key="13674"><span data-slate-leaf="true" data-offset-key="13674:0" data-first-offset="true"><span data-slate-string="true">          s</span></span></span><span data-slate-object="text" data-key="13675"><span data-slate-leaf="true" data-offset-key="13675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13676"><span data-slate-leaf="true" data-offset-key="13676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${response.toString(requestHeader.apiVersion)}</span></span></span></span></span><span data-slate-object="text" data-key="13677"><span data-slate-leaf="true" data-offset-key="13677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for request </span></span></span></span><span data-slate-object="text" data-key="13678"><span data-slate-leaf="true" data-offset-key="13678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$api</span></span></span></span></span><span data-slate-object="text" data-key="13679"><span data-slate-leaf="true" data-offset-key="13679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with correlation id "</span></span></span></span><span data-slate-object="text" data-key="13680"><span data-slate-leaf="true" data-offset-key="13680:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13681"><span data-slate-object="text" data-key="13682"><span data-slate-leaf="true" data-offset-key="13682:0" data-first-offset="true"><span data-slate-string="true">          s</span></span></span><span data-slate-object="text" data-key="13683"><span data-slate-leaf="true" data-offset-key="13683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13684"><span data-slate-leaf="true" data-offset-key="13684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${requestHeader.correlationId}</span></span></span></span></span><span data-slate-object="text" data-key="13685"><span data-slate-leaf="true" data-offset-key="13685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sent to broker </span></span></span></span><span data-slate-object="text" data-key="13686"><span data-slate-leaf="true" data-offset-key="13686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$brokerNode</span></span></span></span></span><span data-slate-object="text" data-key="13687"><span data-slate-leaf="true" data-offset-key="13687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13688"><span data-slate-leaf="true" data-offset-key="13688:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13689"></div><div data-slate-type="code-line" data-slate-object="block" data-key="13690"><span data-slate-object="text" data-key="13691"><span data-slate-leaf="true" data-offset-key="13691:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13692"><span data-slate-leaf="true" data-offset-key="13692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13693"><span data-slate-leaf="true" data-offset-key="13693:0" data-first-offset="true"><span data-slate-string="true"> (callback != </span></span></span><span data-slate-object="text" data-key="13694"><span data-slate-leaf="true" data-offset-key="13694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="13695"><span data-slate-leaf="true" data-offset-key="13695:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13696"><span data-slate-object="text" data-key="13697"><span data-slate-leaf="true" data-offset-key="13697:0" data-first-offset="true"><span data-slate-string="true">          callback(response) </span></span></span><span data-slate-object="text" data-key="13698"><span data-slate-leaf="true" data-offset-key="13698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 处理回调</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13699"><span data-slate-object="text" data-key="13700"><span data-slate-leaf="true" data-offset-key="13700:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13701"><span data-slate-object="text" data-key="13702"><span data-slate-leaf="true" data-offset-key="13702:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13703"><span data-slate-object="text" data-key="13704"><span data-slate-leaf="true" data-offset-key="13704:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="13705"><span data-slate-leaf="true" data-offset-key="13705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="13706"><span data-slate-leaf="true" data-offset-key="13706:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13707"><span data-slate-object="text" data-key="13708"><span data-slate-leaf="true" data-offset-key="13708:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13709"><span data-slate-leaf="true" data-offset-key="13709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13710"><span data-slate-leaf="true" data-offset-key="13710:0" data-first-offset="true"><span data-slate-string="true"> e: Throwable =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13711"><span data-slate-object="text" data-key="13712"><span data-slate-leaf="true" data-offset-key="13712:0" data-first-offset="true"><span data-slate-string="true">        error(s</span></span></span><span data-slate-object="text" data-key="13713"><span data-slate-leaf="true" data-offset-key="13713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Controller </span></span></span></span><span data-slate-object="text" data-key="13714"><span data-slate-leaf="true" data-offset-key="13714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerId</span></span></span></span></span><span data-slate-object="text" data-key="13715"><span data-slate-leaf="true" data-offset-key="13715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> fails to send a request to broker </span></span></span></span><span data-slate-object="text" data-key="13716"><span data-slate-leaf="true" data-offset-key="13716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$brokerNode</span></span></span></span></span><span data-slate-object="text" data-key="13717"><span data-slate-leaf="true" data-offset-key="13717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="13718"><span data-slate-leaf="true" data-offset-key="13718:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13719"><span data-slate-object="text" data-key="13720"><span data-slate-leaf="true" data-offset-key="13720:0" data-first-offset="true"><span data-slate-string="true">        networkClient.close(brokerNode.idString)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13721"><span data-slate-object="text" data-key="13722"><span data-slate-leaf="true" data-offset-key="13722:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13723"><span data-slate-object="text" data-key="13724"><span data-slate-leaf="true" data-offset-key="13724:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13725"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13726"><span data-slate-object="text" data-key="13727"><span data-slate-leaf="true" data-offset-key="13727:0" data-first-offset="true"><span data-slate-string="true">我用一张图来说明 doWork 的执行逻辑：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="13728"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/86/19/869727e22f882509a149d1065a8a1719.jpg?wh=1799*2675"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13729"><span data-slate-object="text" data-key="13730"><span data-slate-leaf="true" data-offset-key="13730:0" data-first-offset="true"><span data-slate-string="true">总体上来看，doWork 的逻辑很直观。它的主要作用是从阻塞队列中取出待发送的请求，然后把它发送出去，之后等待 Response 的返回。在等待 Response 的过程中，线程将一直处于阻塞状态。当接收到 Response 之后，调用 callback 执行请求处理完成后的回调逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13731"><span data-slate-object="text" data-key="13732"><span data-slate-leaf="true" data-offset-key="13732:0" data-first-offset="true"><span data-slate-string="true">需要注意的是，RequestSendThread 线程对请求发送的处理方式与 Broker 处理请求不太一样。它调用的 sendAndReceive 方法在发送完请求之后，会原地进入阻塞状态，等待 Response 返回。只有接收到 Response，并执行完回调逻辑之后，该线程才能从阻塞队列中取出下一个待发送请求进行处理。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="13733" id="sr-toc-3"><span data-slate-object="text" data-key="13734"><span data-slate-leaf="true" data-offset-key="13734:0" data-first-offset="true"><span data-slate-string="true">ControllerChannelManager</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="13735"><span data-slate-object="text" data-key="13736"><span data-slate-leaf="true" data-offset-key="13736:0" data-first-offset="true"><span data-slate-string="true">了解了 RequestSendThread 线程的源码之后，我们进入到 ControllerChannelManager 类的学习。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13737"><span data-slate-object="text" data-key="13738"><span data-slate-leaf="true" data-offset-key="13738:0" data-first-offset="true"><span data-slate-string="true">这个类和 RequestSendThread 是合作共赢的关系。在我看来，它有两大类任务。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13739"><div data-slate-type="list-line" data-slate-object="block" data-key="13740"><span data-slate-object="text" data-key="13741"><span data-slate-leaf="true" data-offset-key="13741:0" data-first-offset="true"><span data-slate-string="true">管理 Controller 与集群 Broker 之间的连接，</span></span><span data-slate-leaf="true" data-offset-key="13741:1"><span data-slate-object="annotation" data-annotation-key="gkann_8ac7fa9c" data-attr-id="32465" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">并为每个 Broker 创建 RequestSendThread 线程实例；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13742"><span data-slate-object="text" data-key="13743"><span data-slate-leaf="true" data-offset-key="13743:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3deff023" data-attr-id="36206" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">将要发送的请求放入到指定 Broker 的阻塞队列中，等待该 Broker 专属的 RequestSendThread 线程进行处理。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13744"><span data-slate-object="text" data-key="13745"><span data-slate-leaf="true" data-offset-key="13745:0" data-first-offset="true"><span data-slate-string="true">由此可见，它们是紧密相连的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13746"><span data-slate-object="text" data-key="13747"><span data-slate-leaf="true" data-offset-key="13747:0" data-first-offset="true"><span data-slate-string="true">ControllerChannelManager 类最重要的数据结构是 brokerStateInfo，它是在下面这行代码中定义的：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13748"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13749"><span data-slate-object="text" data-key="13750"><span data-slate-leaf="true" data-offset-key="13750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected</span></span></span></span><span data-slate-object="text" data-key="13751"><span data-slate-leaf="true" data-offset-key="13751:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13752"><span data-slate-leaf="true" data-offset-key="13752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13753"><span data-slate-leaf="true" data-offset-key="13753:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13754"><span data-slate-leaf="true" data-offset-key="13754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerStateInfo</span></span></span></span><span data-slate-object="text" data-key="13755"><span data-slate-leaf="true" data-offset-key="13755:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13756"><span data-slate-leaf="true" data-offset-key="13756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13757"><span data-slate-leaf="true" data-offset-key="13757:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13758"><span data-slate-leaf="true" data-offset-key="13758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13759"><span data-slate-leaf="true" data-offset-key="13759:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13760"><span data-slate-leaf="true" data-offset-key="13760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="13761"><span data-slate-leaf="true" data-offset-key="13761:0" data-first-offset="true"><span data-slate-string="true">[Int, ControllerBrokerStateInfo]</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13762"><span data-slate-object="text" data-key="13763"><span data-slate-leaf="true" data-offset-key="13763:0" data-first-offset="true"><span data-slate-string="true">这是一个 HashMap 类型，Key 是 Integer 类型，其实就是集群中 Broker 的 ID 信息，而 Value 是一个 ControllerBrokerStateInfo。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13764"><span data-slate-object="text" data-key="13765"><span data-slate-leaf="true" data-offset-key="13765:0" data-first-offset="true"><span data-slate-string="true">你可能不太清楚 ControllerBrokerStateInfo 类是什么，我先解释一下。它本质上是一个 POJO 类，仅仅是承载若干数据结构的容器，如下所示：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="13766"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13767"><span data-slate-object="text" data-key="13768"><span data-slate-leaf="true" data-offset-key="13768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="13769"><span data-slate-leaf="true" data-offset-key="13769:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13770"><span data-slate-leaf="true" data-offset-key="13770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="13771"><span data-slate-leaf="true" data-offset-key="13771:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13772"><span data-slate-leaf="true" data-offset-key="13772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ControllerBrokerStateInfo</span></span></span></span><span data-slate-object="text" data-key="13773"><span data-slate-leaf="true" data-offset-key="13773:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="13774"><span data-slate-leaf="true" data-offset-key="13774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">networkClient</span></span></span></span><span data-slate-object="text" data-key="13775"><span data-slate-leaf="true" data-offset-key="13775:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13776"><span data-slate-leaf="true" data-offset-key="13776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NetworkClient</span></span></span></span><span data-slate-object="text" data-key="13777"><span data-slate-leaf="true" data-offset-key="13777:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13778"><span data-slate-object="text" data-key="13779"><span data-slate-leaf="true" data-offset-key="13779:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13780"><span data-slate-leaf="true" data-offset-key="13780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerNode</span></span></span></span><span data-slate-object="text" data-key="13781"><span data-slate-leaf="true" data-offset-key="13781:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13782"><span data-slate-leaf="true" data-offset-key="13782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Node</span></span></span></span><span data-slate-object="text" data-key="13783"><span data-slate-leaf="true" data-offset-key="13783:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13784"><span data-slate-object="text" data-key="13785"><span data-slate-leaf="true" data-offset-key="13785:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13786"><span data-slate-leaf="true" data-offset-key="13786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">messageQueue</span></span></span></span><span data-slate-object="text" data-key="13787"><span data-slate-leaf="true" data-offset-key="13787:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13788"><span data-slate-leaf="true" data-offset-key="13788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BlockingQueue</span></span></span></span><span data-slate-object="text" data-key="13789"><span data-slate-leaf="true" data-offset-key="13789:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13790"><span data-slate-leaf="true" data-offset-key="13790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">QueueItem</span></span></span></span><span data-slate-object="text" data-key="13791"><span data-slate-leaf="true" data-offset-key="13791:0" data-first-offset="true"><span data-slate-string="true">],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13792"><span data-slate-object="text" data-key="13793"><span data-slate-leaf="true" data-offset-key="13793:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13794"><span data-slate-leaf="true" data-offset-key="13794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestSendThread</span></span></span></span><span data-slate-object="text" data-key="13795"><span data-slate-leaf="true" data-offset-key="13795:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13796"><span data-slate-leaf="true" data-offset-key="13796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestSendThread</span></span></span></span><span data-slate-object="text" data-key="13797"><span data-slate-leaf="true" data-offset-key="13797:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13798"><span data-slate-object="text" data-key="13799"><span data-slate-leaf="true" data-offset-key="13799:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13800"><span data-slate-leaf="true" data-offset-key="13800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">queueSizeGauge</span></span></span></span><span data-slate-object="text" data-key="13801"><span data-slate-leaf="true" data-offset-key="13801:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13802"><span data-slate-leaf="true" data-offset-key="13802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Gauge</span></span></span></span><span data-slate-object="text" data-key="13803"><span data-slate-leaf="true" data-offset-key="13803:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13804"><span data-slate-leaf="true" data-offset-key="13804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="13805"><span data-slate-leaf="true" data-offset-key="13805:0" data-first-offset="true"><span data-slate-string="true">],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13806"><span data-slate-object="text" data-key="13807"><span data-slate-leaf="true" data-offset-key="13807:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13808"><span data-slate-leaf="true" data-offset-key="13808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestRateAndTimeMetrics</span></span></span></span><span data-slate-object="text" data-key="13809"><span data-slate-leaf="true" data-offset-key="13809:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13810"><span data-slate-leaf="true" data-offset-key="13810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Timer</span></span></span></span><span data-slate-object="text" data-key="13811"><span data-slate-leaf="true" data-offset-key="13811:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13812"><span data-slate-object="text" data-key="13813"><span data-slate-leaf="true" data-offset-key="13813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">reconfigurableChannelBuilder</span></span></span></span><span data-slate-object="text" data-key="13814"><span data-slate-leaf="true" data-offset-key="13814:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="13815"><span data-slate-leaf="true" data-offset-key="13815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Option</span></span></span></span><span data-slate-object="text" data-key="13816"><span data-slate-leaf="true" data-offset-key="13816:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="13817"><span data-slate-leaf="true" data-offset-key="13817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Reconfigurable</span></span></span></span><span data-slate-object="text" data-key="13818"><span data-slate-leaf="true" data-offset-key="13818:0" data-first-offset="true"><span data-slate-string="true">])</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13819"><span data-slate-object="text" data-key="13820"><span data-slate-leaf="true" data-offset-key="13820:0" data-first-offset="true"><span data-slate-string="true">它有三个非常关键的字段。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13821"><div data-slate-type="list-line" data-slate-object="block" data-key="13822"><span data-slate-object="text" data-key="13823"><span data-slate-leaf="true" data-offset-key="13823:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerNode</span></span></span></span><span data-slate-object="text" data-key="13824"><span data-slate-leaf="true" data-offset-key="13824:0" data-first-offset="true"><span data-slate-string="true">：目标 Broker 节点对象，里面封装了目标 Broker 的连接信息，比如主机名、端口号等。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13825"><span data-slate-object="text" data-key="13826"><span data-slate-leaf="true" data-offset-key="13826:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">messageQueue</span></span></span></span><span data-slate-object="text" data-key="13827"><span data-slate-leaf="true" data-offset-key="13827:0" data-first-offset="true"><span data-slate-string="true">：请求消息阻塞队列。你可以发现，Controller 为每个目标 Broker 都创建了一个消息队列。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13828"><span data-slate-object="text" data-key="13829"><span data-slate-leaf="true" data-offset-key="13829:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">requestSendThread</span></span></span></span><span data-slate-object="text" data-key="13830"><span data-slate-leaf="true" data-offset-key="13830:0" data-first-offset="true"><span data-slate-string="true">：Controller 使用这个线程给目标 Broker 发送请求。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13831"><span data-slate-object="text" data-key="13832"><span data-slate-leaf="true" data-offset-key="13832:0" data-first-offset="true"><span data-slate-string="true">你一定要记住这三个字段，因为它们是实现 Controller 发送请求的关键因素。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13833"><span data-slate-object="text" data-key="13834"><span data-slate-leaf="true" data-offset-key="13834:0" data-first-offset="true"><span data-slate-string="true">为什么呢？我们思考一下，如果 Controller 要给 Broker 发送请求，肯定需要解决三个问题：发给谁？发什么？怎么发？“发给谁” 就是由 brokerNode 决定的；messageQueue 里面保存了要发送的请求，因而解决了 “发什么” 的问题；最后的 “怎么发” 就是依赖 requestSendThread 变量实现的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13835"><span data-slate-object="text" data-key="13836"><span data-slate-leaf="true" data-offset-key="13836:0" data-first-offset="true"><span data-slate-string="true">好了，我们现在回到 ControllerChannelManager。它定义了 5 个 public 方法，我来一一介绍下。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13837"><div data-slate-type="list-line" data-slate-object="block" data-key="13838"><span data-slate-object="text" data-key="13839"><span data-slate-leaf="true" data-offset-key="13839:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">startup 方法</span></span></span></span><span data-slate-object="text" data-key="13840"><span data-slate-leaf="true" data-offset-key="13840:0" data-first-offset="true"><span data-slate-string="true">：Controller 组件在启动时，会调用 ControllerChannelManager 的 startup 方法。该方法会从元数据信息中找到集群的 Broker 列表，然后依次为它们调用 addBroker 方法，把它们加到 brokerStateInfo 变量中，最后再依次启动 brokerStateInfo 中的 RequestSendThread 线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13841"><span data-slate-object="text" data-key="13842"><span data-slate-leaf="true" data-offset-key="13842:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">shutdown 方法</span></span></span></span><span data-slate-object="text" data-key="13843"><span data-slate-leaf="true" data-offset-key="13843:0" data-first-offset="true"><span data-slate-string="true">：关闭所有 RequestSendThread 线程，并清空必要的资源。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13844"><span data-slate-object="text" data-key="13845"><span data-slate-leaf="true" data-offset-key="13845:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">sendRequest 方法</span></span></span></span><span data-slate-object="text" data-key="13846"><span data-slate-leaf="true" data-offset-key="13846:0" data-first-offset="true"><span data-slate-string="true">：从名字看，就是发送请求，实际上就是把请求对象提交到请求队列。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13847"><span data-slate-object="text" data-key="13848"><span data-slate-leaf="true" data-offset-key="13848:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">addBroker 方法</span></span></span></span><span data-slate-object="text" data-key="13849"><span data-slate-leaf="true" data-offset-key="13849:0" data-first-offset="true"><span data-slate-string="true">：添加目标 Broker 到 brokerStateInfo 数据结构中，并创建必要的配套资源，如请求队列、RequestSendThread 线程对象等。最后，RequestSendThread 启动线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="13850"><span data-slate-object="text" data-key="13851"><span data-slate-leaf="true" data-offset-key="13851:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">removeBroker 方法</span></span></span></span><span data-slate-object="text" data-key="13852"><span data-slate-leaf="true" data-offset-key="13852:0" data-first-offset="true"><span data-slate-string="true">：从 brokerStateInfo 移除目标 Broker 的相关数据。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13853"><span data-slate-object="text" data-key="13854"><span data-slate-leaf="true" data-offset-key="13854:0" data-first-offset="true"><span data-slate-string="true">这里面大部分的方法逻辑都很简单，从方法名字就可以看得出来。我重点说一下 </span></span></span><span data-slate-object="text" data-key="13855"><span data-slate-leaf="true" data-offset-key="13855:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">addBroker</span></span></span></span><span data-slate-object="text" data-key="13856"><span data-slate-leaf="true" data-offset-key="13856:0" data-first-offset="true"><span data-slate-string="true">，以及</span></span></span><span data-slate-object="text" data-key="13857"><span data-slate-leaf="true" data-offset-key="13857:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">底层相关的私有方法 addNewBroker 和 startRequestSendThread 方法</span></span></span></span><span data-slate-object="text" data-key="13858"><span data-slate-leaf="true" data-offset-key="13858:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13859"><span data-slate-object="text" data-key="13860"><span data-slate-leaf="true" data-offset-key="13860:0" data-first-offset="true"><span data-slate-string="true">毕竟，addBroker 是最重要的逻辑。每当集群中扩容了新的 Broker 时，Controller 就会调用这个方法为新 Broker 增加新的 RequestSendThread 线程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13861"><span data-slate-object="text" data-key="13862"><span data-slate-leaf="true" data-offset-key="13862:0" data-first-offset="true"><span data-slate-string="true">我们先来看 addBroker：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="13863"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13864"><span data-slate-object="text" data-key="13865"><span data-slate-leaf="true" data-offset-key="13865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="13866"><span data-slate-leaf="true" data-offset-key="13866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addBroker</span></span></span></span></span><span data-slate-object="text" data-key="13867"><span data-slate-leaf="true" data-offset-key="13867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(broker: Broker)</span></span></span></span></span><span data-slate-object="text" data-key="13868"><span data-slate-leaf="true" data-offset-key="13868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="13869"><span data-slate-leaf="true" data-offset-key="13869:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13870"><span data-slate-object="text" data-key="13871"><span data-slate-leaf="true" data-offset-key="13871:0" data-first-offset="true"><span data-slate-string="true">    brokerLock </span></span></span><span data-slate-object="text" data-key="13872"><span data-slate-leaf="true" data-offset-key="13872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="13873"><span data-slate-leaf="true" data-offset-key="13873:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13874"><span data-slate-object="text" data-key="13875"><span data-slate-leaf="true" data-offset-key="13875:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13876"><span data-slate-leaf="true" data-offset-key="13876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该 Broker 是新 Broker 的话</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13877"><span data-slate-object="text" data-key="13878"><span data-slate-leaf="true" data-offset-key="13878:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="13879"><span data-slate-leaf="true" data-offset-key="13879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="13880"><span data-slate-leaf="true" data-offset-key="13880:0" data-first-offset="true"><span data-slate-string="true"> (!brokerStateInfo.</span></span></span><span data-slate-object="text" data-key="13881"><span data-slate-leaf="true" data-offset-key="13881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">contains</span></span></span></span><span data-slate-object="text" data-key="13882"><span data-slate-leaf="true" data-offset-key="13882:0" data-first-offset="true"><span data-slate-string="true">(broker.id)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13883"><span data-slate-object="text" data-key="13884"><span data-slate-leaf="true" data-offset-key="13884:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13885"><span data-slate-leaf="true" data-offset-key="13885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将新 Broker 加入到 Controller 管理，并创建对应的 RequestSendThread 线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13886"><span data-slate-object="text" data-key="13887"><span data-slate-leaf="true" data-offset-key="13887:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13888"><span data-slate-leaf="true" data-offset-key="13888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addNewBroker</span></span></span></span><span data-slate-object="text" data-key="13889"><span data-slate-leaf="true" data-offset-key="13889:0" data-first-offset="true"><span data-slate-string="true">(broker) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13890"><span data-slate-object="text" data-key="13891"><span data-slate-leaf="true" data-offset-key="13891:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13892"><span data-slate-leaf="true" data-offset-key="13892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动 RequestSendThread 线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13893"><span data-slate-object="text" data-key="13894"><span data-slate-leaf="true" data-offset-key="13894:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="13895"><span data-slate-leaf="true" data-offset-key="13895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startRequestSendThread</span></span></span></span><span data-slate-object="text" data-key="13896"><span data-slate-leaf="true" data-offset-key="13896:0" data-first-offset="true"><span data-slate-string="true">(broker.id)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13897"><span data-slate-object="text" data-key="13898"><span data-slate-leaf="true" data-offset-key="13898:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13899"><span data-slate-object="text" data-key="13900"><span data-slate-leaf="true" data-offset-key="13900:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13901"><span data-slate-object="text" data-key="13902"><span data-slate-leaf="true" data-offset-key="13902:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13903"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13904"><span data-slate-object="text" data-key="13905"><span data-slate-leaf="true" data-offset-key="13905:0" data-first-offset="true"><span data-slate-string="true">整个代码段被 brokerLock 保护起来了。还记得 brokerStateInfo 的定义吗？它仅仅是一个 HashMap 对象，因为不是线程安全的，所以任何访问该变量的地方，都需要锁的保护。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13906"><span data-slate-object="text" data-key="13907"><span data-slate-leaf="true" data-offset-key="13907:0" data-first-offset="true"><span data-slate-string="true">这段代码的逻辑是，判断目标 Broker 的序号，是否已经保存在 brokerStateInfo 中。如果是，就说明这个 Broker 之前已经添加过了，就没必要再次添加了；否则，addBroker 方法会对目前的 Broker 执行两个操作：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="13908"><div data-slate-type="list-line" data-slate-object="block" data-key="13909"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="13910"><span data-slate-leaf="true" data-offset-key="13910:0" data-first-offset="true"><span data-slate-string="true">把该 Broker 节点添加到 brokerStateInfo 中；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="13911"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="13912"><span data-slate-leaf="true" data-offset-key="13912:0" data-first-offset="true"><span data-slate-string="true">启动与该 Broker 对应的 RequestSendThread 线程。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13913"><span data-slate-object="text" data-key="13914"><span data-slate-leaf="true" data-offset-key="13914:0" data-first-offset="true"><span data-slate-string="true">这两步分别是由 addNewBroker 和 startRequestSendThread 方法实现的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="13915"><span data-slate-object="text" data-key="13916"><span data-slate-leaf="true" data-offset-key="13916:0" data-first-offset="true"><span data-slate-string="true">addNewBroker 方法的逻辑比较复杂，我用注释的方式给出主要步骤：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="13917"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div><div data-code-line-number="78"></div><div data-code-line-number="79"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13918"><span data-slate-object="text" data-key="13919"><span data-slate-leaf="true" data-offset-key="13919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="13920"><span data-slate-leaf="true" data-offset-key="13920:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="13921"><span data-slate-leaf="true" data-offset-key="13921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addNewBroker</span></span></span></span><span data-slate-object="text" data-key="13922"><span data-slate-leaf="true" data-offset-key="13922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(broker: Broker)</span></span></span></span><span data-slate-object="text" data-key="13923"><span data-slate-leaf="true" data-offset-key="13923:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13924"><span data-slate-object="text" data-key="13925"><span data-slate-leaf="true" data-offset-key="13925:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13926"><span data-slate-leaf="true" data-offset-key="13926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为该 Broker 构造请求阻塞队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13927"><span data-slate-object="text" data-key="13928"><span data-slate-leaf="true" data-offset-key="13928:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13929"><span data-slate-leaf="true" data-offset-key="13929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13930"><span data-slate-leaf="true" data-offset-key="13930:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13931"><span data-slate-leaf="true" data-offset-key="13931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">messageQueue</span></span></span></span><span data-slate-object="text" data-key="13932"><span data-slate-leaf="true" data-offset-key="13932:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13933"><span data-slate-leaf="true" data-offset-key="13933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13934"><span data-slate-leaf="true" data-offset-key="13934:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13935"><span data-slate-leaf="true" data-offset-key="13935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13936"><span data-slate-leaf="true" data-offset-key="13936:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13937"><span data-slate-leaf="true" data-offset-key="13937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">LinkedBlockingQueue</span></span></span></span><span data-slate-object="text" data-key="13938"><span data-slate-leaf="true" data-offset-key="13938:0" data-first-offset="true"><span data-slate-string="true">[QueueItem]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13939"><span data-slate-object="text" data-key="13940"><span data-slate-leaf="true" data-offset-key="13940:0" data-first-offset="true"><span data-slate-string="true">  debug(s</span></span></span><span data-slate-object="text" data-key="13941"><span data-slate-leaf="true" data-offset-key="13941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Controller ${config.brokerId} trying to connect to broker ${broker.id}"</span></span></span></span><span data-slate-object="text" data-key="13942"><span data-slate-leaf="true" data-offset-key="13942:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13943"><span data-slate-object="text" data-key="13944"><span data-slate-leaf="true" data-offset-key="13944:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13945"><span data-slate-leaf="true" data-offset-key="13945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13946"><span data-slate-leaf="true" data-offset-key="13946:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13947"><span data-slate-leaf="true" data-offset-key="13947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerToBrokerListenerName</span></span></span></span><span data-slate-object="text" data-key="13948"><span data-slate-leaf="true" data-offset-key="13948:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13949"><span data-slate-leaf="true" data-offset-key="13949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13950"><span data-slate-leaf="true" data-offset-key="13950:0" data-first-offset="true"><span data-slate-string="true"> config.controlPlaneListenerName.getOrElse(config.interBrokerListenerName)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13951"><span data-slate-object="text" data-key="13952"><span data-slate-leaf="true" data-offset-key="13952:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13953"><span data-slate-leaf="true" data-offset-key="13953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13954"><span data-slate-leaf="true" data-offset-key="13954:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13955"><span data-slate-leaf="true" data-offset-key="13955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerToBrokerSecurityProtocol</span></span></span></span><span data-slate-object="text" data-key="13956"><span data-slate-leaf="true" data-offset-key="13956:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13957"><span data-slate-leaf="true" data-offset-key="13957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13958"><span data-slate-leaf="true" data-offset-key="13958:0" data-first-offset="true"><span data-slate-string="true"> config.controlPlaneSecurityProtocol.getOrElse(config.interBrokerSecurityProtocol)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13959"><span data-slate-object="text" data-key="13960"><span data-slate-leaf="true" data-offset-key="13960:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13961"><span data-slate-leaf="true" data-offset-key="13961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取待连接 Broker 节点对象信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13962"><span data-slate-object="text" data-key="13963"><span data-slate-leaf="true" data-offset-key="13963:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13964"><span data-slate-leaf="true" data-offset-key="13964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13965"><span data-slate-leaf="true" data-offset-key="13965:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13966"><span data-slate-leaf="true" data-offset-key="13966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerNode</span></span></span></span><span data-slate-object="text" data-key="13967"><span data-slate-leaf="true" data-offset-key="13967:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13968"><span data-slate-leaf="true" data-offset-key="13968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13969"><span data-slate-leaf="true" data-offset-key="13969:0" data-first-offset="true"><span data-slate-string="true"> broker.node(controllerToBrokerListenerName)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13970"><span data-slate-object="text" data-key="13971"><span data-slate-leaf="true" data-offset-key="13971:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="13972"><span data-slate-leaf="true" data-offset-key="13972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13973"><span data-slate-leaf="true" data-offset-key="13973:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13974"><span data-slate-leaf="true" data-offset-key="13974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">logContext</span></span></span></span><span data-slate-object="text" data-key="13975"><span data-slate-leaf="true" data-offset-key="13975:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13976"><span data-slate-leaf="true" data-offset-key="13976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13977"><span data-slate-leaf="true" data-offset-key="13977:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13978"><span data-slate-leaf="true" data-offset-key="13978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="13979"><span data-slate-leaf="true" data-offset-key="13979:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13980"><span data-slate-leaf="true" data-offset-key="13980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">LogContext</span></span></span></span><span data-slate-object="text" data-key="13981"><span data-slate-leaf="true" data-offset-key="13981:0" data-first-offset="true"><span data-slate-string="true">(s</span></span></span><span data-slate-object="text" data-key="13982"><span data-slate-leaf="true" data-offset-key="13982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[Controller id=${config.brokerId}, targetBrokerId=${brokerNode.idString}]"</span></span></span></span><span data-slate-object="text" data-key="13983"><span data-slate-leaf="true" data-offset-key="13983:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13984"><span data-slate-object="text" data-key="13985"><span data-slate-leaf="true" data-offset-key="13985:0" data-first-offset="true"><span data-slate-string="true">  val (networkClient, reconfigurableChannelBuilder) = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13986"><span data-slate-object="text" data-key="13987"><span data-slate-leaf="true" data-offset-key="13987:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="13988"><span data-slate-leaf="true" data-offset-key="13988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="13989"><span data-slate-leaf="true" data-offset-key="13989:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13990"><span data-slate-leaf="true" data-offset-key="13990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">channelBuilder</span></span></span></span><span data-slate-object="text" data-key="13991"><span data-slate-leaf="true" data-offset-key="13991:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="13992"><span data-slate-leaf="true" data-offset-key="13992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="13993"><span data-slate-leaf="true" data-offset-key="13993:0" data-first-offset="true"><span data-slate-string="true"> ChannelBuilders.clientChannelBuilder(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13994"><span data-slate-object="text" data-key="13995"><span data-slate-leaf="true" data-offset-key="13995:0" data-first-offset="true"><span data-slate-string="true">      controllerToBrokerSecurityProtocol,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13996"><span data-slate-object="text" data-key="13997"><span data-slate-leaf="true" data-offset-key="13997:0" data-first-offset="true"><span data-slate-string="true">      JaasContext.Type.SERVER,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="13998"><span data-slate-object="text" data-key="13999"><span data-slate-leaf="true" data-offset-key="13999:0" data-first-offset="true"><span data-slate-string="true">      config,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14000"><span data-slate-object="text" data-key="14001"><span data-slate-leaf="true" data-offset-key="14001:0" data-first-offset="true"><span data-slate-string="true">      controllerToBrokerListenerName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14002"><span data-slate-object="text" data-key="14003"><span data-slate-leaf="true" data-offset-key="14003:0" data-first-offset="true"><span data-slate-string="true">      config.saslMechanismInterBrokerProtocol,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14004"><span data-slate-object="text" data-key="14005"><span data-slate-leaf="true" data-offset-key="14005:0" data-first-offset="true"><span data-slate-string="true">      time,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14006"><span data-slate-object="text" data-key="14007"><span data-slate-leaf="true" data-offset-key="14007:0" data-first-offset="true"><span data-slate-string="true">      config.saslInterBrokerHandshakeRequestEnable,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14008"><span data-slate-object="text" data-key="14009"><span data-slate-leaf="true" data-offset-key="14009:0" data-first-offset="true"><span data-slate-string="true">      logContext</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14010"><span data-slate-object="text" data-key="14011"><span data-slate-leaf="true" data-offset-key="14011:0" data-first-offset="true"><span data-slate-string="true">    )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14012"><span data-slate-object="text" data-key="14013"><span data-slate-leaf="true" data-offset-key="14013:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14014"><span data-slate-leaf="true" data-offset-key="14014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14015"><span data-slate-leaf="true" data-offset-key="14015:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14016"><span data-slate-leaf="true" data-offset-key="14016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">reconfigurableChannelBuilder</span></span></span></span><span data-slate-object="text" data-key="14017"><span data-slate-leaf="true" data-offset-key="14017:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14018"><span data-slate-leaf="true" data-offset-key="14018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14019"><span data-slate-leaf="true" data-offset-key="14019:0" data-first-offset="true"><span data-slate-string="true"> channelBuilder match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14020"><span data-slate-object="text" data-key="14021"><span data-slate-leaf="true" data-offset-key="14021:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14022"><span data-slate-leaf="true" data-offset-key="14022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14023"><span data-slate-leaf="true" data-offset-key="14023:0" data-first-offset="true"><span data-slate-string="true"> reconfigurable: Reconfigurable =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14024"><span data-slate-object="text" data-key="14025"><span data-slate-leaf="true" data-offset-key="14025:0" data-first-offset="true"><span data-slate-string="true">        config.addReconfigurable(reconfigurable)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14026"><span data-slate-object="text" data-key="14027"><span data-slate-leaf="true" data-offset-key="14027:0" data-first-offset="true"><span data-slate-string="true">        Some(reconfigurable)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14028"><span data-slate-object="text" data-key="14029"><span data-slate-leaf="true" data-offset-key="14029:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14030"><span data-slate-leaf="true" data-offset-key="14030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14031"><span data-slate-leaf="true" data-offset-key="14031:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14032"><span data-slate-leaf="true" data-offset-key="14032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">_</span></span></span></span><span data-slate-object="text" data-key="14033"><span data-slate-leaf="true" data-offset-key="14033:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14034"><span data-slate-leaf="true" data-offset-key="14034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14035"><span data-slate-leaf="true" data-offset-key="14035:0" data-first-offset="true"><span data-slate-string="true">&gt; None</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14036"><span data-slate-object="text" data-key="14037"><span data-slate-leaf="true" data-offset-key="14037:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14038"><span data-slate-object="text" data-key="14039"><span data-slate-leaf="true" data-offset-key="14039:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14040"><span data-slate-leaf="true" data-offset-key="14040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 NIO Selector 实例用于网络数据传输</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14041"><span data-slate-object="text" data-key="14042"><span data-slate-leaf="true" data-offset-key="14042:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14043"><span data-slate-leaf="true" data-offset-key="14043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14044"><span data-slate-leaf="true" data-offset-key="14044:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14045"><span data-slate-leaf="true" data-offset-key="14045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">selector</span></span></span></span><span data-slate-object="text" data-key="14046"><span data-slate-leaf="true" data-offset-key="14046:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14047"><span data-slate-leaf="true" data-offset-key="14047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14048"><span data-slate-leaf="true" data-offset-key="14048:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14049"><span data-slate-leaf="true" data-offset-key="14049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="14050"><span data-slate-leaf="true" data-offset-key="14050:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14051"><span data-slate-leaf="true" data-offset-key="14051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Selector</span></span></span></span><span data-slate-object="text" data-key="14052"><span data-slate-leaf="true" data-offset-key="14052:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14053"><span data-slate-object="text" data-key="14054"><span data-slate-leaf="true" data-offset-key="14054:0" data-first-offset="true"><span data-slate-string="true">      NetworkReceive.UNLIMITED,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14055"><span data-slate-object="text" data-key="14056"><span data-slate-leaf="true" data-offset-key="14056:0" data-first-offset="true"><span data-slate-string="true">      Selector.NO_IDLE_TIMEOUT_MS,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14057"><span data-slate-object="text" data-key="14058"><span data-slate-leaf="true" data-offset-key="14058:0" data-first-offset="true"><span data-slate-string="true">      metrics,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14059"><span data-slate-object="text" data-key="14060"><span data-slate-leaf="true" data-offset-key="14060:0" data-first-offset="true"><span data-slate-string="true">      time,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14061"><span data-slate-object="text" data-key="14062"><span data-slate-leaf="true" data-offset-key="14062:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14063"><span data-slate-leaf="true" data-offset-key="14063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"controller-channel"</span></span></span></span><span data-slate-object="text" data-key="14064"><span data-slate-leaf="true" data-offset-key="14064:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14065"><span data-slate-object="text" data-key="14066"><span data-slate-leaf="true" data-offset-key="14066:0" data-first-offset="true"><span data-slate-string="true">      Map(</span></span></span><span data-slate-object="text" data-key="14067"><span data-slate-leaf="true" data-offset-key="14067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"broker-id"</span></span></span></span><span data-slate-object="text" data-key="14068"><span data-slate-leaf="true" data-offset-key="14068:0" data-first-offset="true"><span data-slate-string="true"> -&gt; brokerNode.idString).asJava,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14069"><span data-slate-object="text" data-key="14070"><span data-slate-leaf="true" data-offset-key="14070:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14071"><span data-slate-leaf="true" data-offset-key="14071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="14072"><span data-slate-leaf="true" data-offset-key="14072:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14073"><span data-slate-object="text" data-key="14074"><span data-slate-leaf="true" data-offset-key="14074:0" data-first-offset="true"><span data-slate-string="true">      channelBuilder,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14075"><span data-slate-object="text" data-key="14076"><span data-slate-leaf="true" data-offset-key="14076:0" data-first-offset="true"><span data-slate-string="true">      logContext</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14077"><span data-slate-object="text" data-key="14078"><span data-slate-leaf="true" data-offset-key="14078:0" data-first-offset="true"><span data-slate-string="true">    )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14079"><span data-slate-object="text" data-key="14080"><span data-slate-leaf="true" data-offset-key="14080:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14081"><span data-slate-leaf="true" data-offset-key="14081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 NetworkClient 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14082"><span data-slate-object="text" data-key="14083"><span data-slate-leaf="true" data-offset-key="14083:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14084"><span data-slate-leaf="true" data-offset-key="14084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// NetworkClient 类是 Kafka clients 工程封装的顶层网络客户端 API</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14085"><span data-slate-object="text" data-key="14086"><span data-slate-leaf="true" data-offset-key="14086:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14087"><span data-slate-leaf="true" data-offset-key="14087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 提供了丰富的方法实现网络层 IO 数据传输</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14088"><span data-slate-object="text" data-key="14089"><span data-slate-leaf="true" data-offset-key="14089:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14090"><span data-slate-leaf="true" data-offset-key="14090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14091"><span data-slate-leaf="true" data-offset-key="14091:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14092"><span data-slate-leaf="true" data-offset-key="14092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">networkClient</span></span></span></span><span data-slate-object="text" data-key="14093"><span data-slate-leaf="true" data-offset-key="14093:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14094"><span data-slate-leaf="true" data-offset-key="14094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14095"><span data-slate-leaf="true" data-offset-key="14095:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14096"><span data-slate-leaf="true" data-offset-key="14096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="14097"><span data-slate-leaf="true" data-offset-key="14097:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14098"><span data-slate-leaf="true" data-offset-key="14098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NetworkClient</span></span></span></span><span data-slate-object="text" data-key="14099"><span data-slate-leaf="true" data-offset-key="14099:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14100"><span data-slate-object="text" data-key="14101"><span data-slate-leaf="true" data-offset-key="14101:0" data-first-offset="true"><span data-slate-string="true">      selector,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14102"><span data-slate-object="text" data-key="14103"><span data-slate-leaf="true" data-offset-key="14103:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14104"><span data-slate-leaf="true" data-offset-key="14104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="14105"><span data-slate-leaf="true" data-offset-key="14105:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14106"><span data-slate-leaf="true" data-offset-key="14106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ManualMetadataUpdater</span></span></span></span><span data-slate-object="text" data-key="14107"><span data-slate-leaf="true" data-offset-key="14107:0" data-first-offset="true"><span data-slate-string="true">(Seq(brokerNode).asJava),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14108"><span data-slate-object="text" data-key="14109"><span data-slate-leaf="true" data-offset-key="14109:0" data-first-offset="true"><span data-slate-string="true">      config.brokerId.toString,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14110"><span data-slate-object="text" data-key="14111"><span data-slate-leaf="true" data-offset-key="14111:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14112"><span data-slate-leaf="true" data-offset-key="14112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="14113"><span data-slate-leaf="true" data-offset-key="14113:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14114"><span data-slate-object="text" data-key="14115"><span data-slate-leaf="true" data-offset-key="14115:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14116"><span data-slate-leaf="true" data-offset-key="14116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14117"><span data-slate-leaf="true" data-offset-key="14117:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14118"><span data-slate-object="text" data-key="14119"><span data-slate-leaf="true" data-offset-key="14119:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14120"><span data-slate-leaf="true" data-offset-key="14120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="14121"><span data-slate-leaf="true" data-offset-key="14121:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14122"><span data-slate-object="text" data-key="14123"><span data-slate-leaf="true" data-offset-key="14123:0" data-first-offset="true"><span data-slate-string="true">      Selectable.USE_DEFAULT_BUFFER_SIZE,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14124"><span data-slate-object="text" data-key="14125"><span data-slate-leaf="true" data-offset-key="14125:0" data-first-offset="true"><span data-slate-string="true">      Selectable.USE_DEFAULT_BUFFER_SIZE,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14126"><span data-slate-object="text" data-key="14127"><span data-slate-leaf="true" data-offset-key="14127:0" data-first-offset="true"><span data-slate-string="true">      config.requestTimeoutMs,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14128"><span data-slate-object="text" data-key="14129"><span data-slate-leaf="true" data-offset-key="14129:0" data-first-offset="true"><span data-slate-string="true">      ClientDnsLookup.DEFAULT,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14130"><span data-slate-object="text" data-key="14131"><span data-slate-leaf="true" data-offset-key="14131:0" data-first-offset="true"><span data-slate-string="true">      time,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14132"><span data-slate-object="text" data-key="14133"><span data-slate-leaf="true" data-offset-key="14133:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14134"><span data-slate-leaf="true" data-offset-key="14134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="14135"><span data-slate-leaf="true" data-offset-key="14135:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14136"><span data-slate-object="text" data-key="14137"><span data-slate-leaf="true" data-offset-key="14137:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="14138"><span data-slate-leaf="true" data-offset-key="14138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="14139"><span data-slate-leaf="true" data-offset-key="14139:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14140"><span data-slate-leaf="true" data-offset-key="14140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ApiVersions</span></span></span></span><span data-slate-object="text" data-key="14141"><span data-slate-leaf="true" data-offset-key="14141:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14142"><span data-slate-object="text" data-key="14143"><span data-slate-leaf="true" data-offset-key="14143:0" data-first-offset="true"><span data-slate-string="true">      logContext</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14144"><span data-slate-object="text" data-key="14145"><span data-slate-leaf="true" data-offset-key="14145:0" data-first-offset="true"><span data-slate-string="true">    )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14146"><span data-slate-object="text" data-key="14147"><span data-slate-leaf="true" data-offset-key="14147:0" data-first-offset="true"><span data-slate-string="true">    (networkClient, reconfigurableChannelBuilder)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14148"><span data-slate-object="text" data-key="14149"><span data-slate-leaf="true" data-offset-key="14149:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14150"><span data-slate-object="text" data-key="14151"><span data-slate-leaf="true" data-offset-key="14151:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14152"><span data-slate-leaf="true" data-offset-key="14152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为这个 RequestSendThread 线程设置线程名称</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14153"><span data-slate-object="text" data-key="14154"><span data-slate-leaf="true" data-offset-key="14154:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14155"><span data-slate-leaf="true" data-offset-key="14155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14156"><span data-slate-leaf="true" data-offset-key="14156:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14157"><span data-slate-leaf="true" data-offset-key="14157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">threadName</span></span></span></span><span data-slate-object="text" data-key="14158"><span data-slate-leaf="true" data-offset-key="14158:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14159"><span data-slate-leaf="true" data-offset-key="14159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14160"><span data-slate-leaf="true" data-offset-key="14160:0" data-first-offset="true"><span data-slate-string="true"> threadNamePrefix match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14161"><span data-slate-object="text" data-key="14162"><span data-slate-leaf="true" data-offset-key="14162:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14163"><span data-slate-leaf="true" data-offset-key="14163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14164"><span data-slate-leaf="true" data-offset-key="14164:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14165"><span data-slate-leaf="true" data-offset-key="14165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">None</span></span></span></span><span data-slate-object="text" data-key="14166"><span data-slate-leaf="true" data-offset-key="14166:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14167"><span data-slate-leaf="true" data-offset-key="14167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14168"><span data-slate-leaf="true" data-offset-key="14168:0" data-first-offset="true"><span data-slate-string="true">&gt; s</span></span></span><span data-slate-object="text" data-key="14169"><span data-slate-leaf="true" data-offset-key="14169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Controller-${config.brokerId}-to-broker-${broker.id}-send-thread"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14170"><span data-slate-object="text" data-key="14171"><span data-slate-leaf="true" data-offset-key="14171:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14172"><span data-slate-leaf="true" data-offset-key="14172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="14173"><span data-slate-leaf="true" data-offset-key="14173:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14174"><span data-slate-leaf="true" data-offset-key="14174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Some</span></span></span></span><span data-slate-object="text" data-key="14175"><span data-slate-leaf="true" data-offset-key="14175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(name)</span></span></span></span><span data-slate-object="text" data-key="14176"><span data-slate-leaf="true" data-offset-key="14176:0" data-first-offset="true"><span data-slate-string="true"> =&gt; s</span></span></span><span data-slate-object="text" data-key="14177"><span data-slate-leaf="true" data-offset-key="14177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"$name:Controller-${config.brokerId}-to-broker-${broker.id}-send-thread"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14178"><span data-slate-object="text" data-key="14179"><span data-slate-leaf="true" data-offset-key="14179:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14180"><span data-slate-object="text" data-key="14181"><span data-slate-leaf="true" data-offset-key="14181:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14182"><span data-slate-leaf="true" data-offset-key="14182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构造请求处理速率监控指标</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14183"><span data-slate-object="text" data-key="14184"><span data-slate-leaf="true" data-offset-key="14184:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14185"><span data-slate-leaf="true" data-offset-key="14185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14186"><span data-slate-leaf="true" data-offset-key="14186:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14187"><span data-slate-leaf="true" data-offset-key="14187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestRateAndQueueTimeMetrics</span></span></span></span><span data-slate-object="text" data-key="14188"><span data-slate-leaf="true" data-offset-key="14188:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14189"><span data-slate-leaf="true" data-offset-key="14189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14190"><span data-slate-leaf="true" data-offset-key="14190:0" data-first-offset="true"><span data-slate-string="true"> newTimer(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14191"><span data-slate-object="text" data-key="14192"><span data-slate-leaf="true" data-offset-key="14192:0" data-first-offset="true"><span data-slate-string="true">    RequestRateAndQueueTimeMetricName, TimeUnit.MILLISECONDS, TimeUnit.SECONDS, brokerMetricTags(broker.id)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14193"><span data-slate-object="text" data-key="14194"><span data-slate-leaf="true" data-offset-key="14194:0" data-first-offset="true"><span data-slate-string="true">  )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14195"><span data-slate-object="text" data-key="14196"><span data-slate-leaf="true" data-offset-key="14196:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14197"><span data-slate-leaf="true" data-offset-key="14197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 RequestSendThread 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14198"><span data-slate-object="text" data-key="14199"><span data-slate-leaf="true" data-offset-key="14199:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14200"><span data-slate-leaf="true" data-offset-key="14200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14201"><span data-slate-leaf="true" data-offset-key="14201:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14202"><span data-slate-leaf="true" data-offset-key="14202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestThread</span></span></span></span><span data-slate-object="text" data-key="14203"><span data-slate-leaf="true" data-offset-key="14203:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14204"><span data-slate-leaf="true" data-offset-key="14204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14205"><span data-slate-leaf="true" data-offset-key="14205:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14206"><span data-slate-leaf="true" data-offset-key="14206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="14207"><span data-slate-leaf="true" data-offset-key="14207:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14208"><span data-slate-leaf="true" data-offset-key="14208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestSendThread</span></span></span></span><span data-slate-object="text" data-key="14209"><span data-slate-leaf="true" data-offset-key="14209:0" data-first-offset="true"><span data-slate-string="true">(config.brokerId, controllerContext, messageQueue, networkClient,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14210"><span data-slate-object="text" data-key="14211"><span data-slate-leaf="true" data-offset-key="14211:0" data-first-offset="true"><span data-slate-string="true">    brokerNode, config, time, requestRateAndQueueTimeMetrics, stateChangeLogger, threadName)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14212"><span data-slate-object="text" data-key="14213"><span data-slate-leaf="true" data-offset-key="14213:0" data-first-offset="true"><span data-slate-string="true">  requestThread.setDaemon(</span></span></span><span data-slate-object="text" data-key="14214"><span data-slate-leaf="true" data-offset-key="14214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="14215"><span data-slate-leaf="true" data-offset-key="14215:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14216"></div><div data-slate-type="code-line" data-slate-object="block" data-key="14217"><span data-slate-object="text" data-key="14218"><span data-slate-leaf="true" data-offset-key="14218:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14219"><span data-slate-leaf="true" data-offset-key="14219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14220"><span data-slate-leaf="true" data-offset-key="14220:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14221"><span data-slate-leaf="true" data-offset-key="14221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">queueSizeGauge</span></span></span></span><span data-slate-object="text" data-key="14222"><span data-slate-leaf="true" data-offset-key="14222:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14223"><span data-slate-leaf="true" data-offset-key="14223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14224"><span data-slate-leaf="true" data-offset-key="14224:0" data-first-offset="true"><span data-slate-string="true"> newGauge(QueueSizeMetricName, () =&gt; messageQueue.size, brokerMetricTags(broker.id))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14225"><span data-slate-object="text" data-key="14226"><span data-slate-leaf="true" data-offset-key="14226:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14227"><span data-slate-leaf="true" data-offset-key="14227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建该 Broker 专属的 ControllerBrokerStateInfo 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14228"><span data-slate-object="text" data-key="14229"><span data-slate-leaf="true" data-offset-key="14229:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14230"><span data-slate-leaf="true" data-offset-key="14230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 并将其加入到 brokerStateInfo 统一管理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14231"><span data-slate-object="text" data-key="14232"><span data-slate-leaf="true" data-offset-key="14232:0" data-first-offset="true"><span data-slate-string="true">  brokerStateInfo.put(broker.id, ControllerBrokerStateInfo(networkClient, brokerNode, messageQueue,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14233"><span data-slate-object="text" data-key="14234"><span data-slate-leaf="true" data-offset-key="14234:0" data-first-offset="true"><span data-slate-string="true">    requestThread, queueSizeGauge, requestRateAndQueueTimeMetrics, reconfigurableChannelBuilder))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14235"><span data-slate-object="text" data-key="14236"><span data-slate-leaf="true" data-offset-key="14236:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14237"><span data-slate-object="text" data-key="14238"><span data-slate-leaf="true" data-offset-key="14238:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解，我还画了一张流程图形象说明它的执行流程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14239"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/4f/22/4f34c319f9480c16ac12dee78d5ba322.jpg?wh=4470*2201"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14240"><span data-slate-object="text" data-key="14241"><span data-slate-leaf="true" data-offset-key="14241:0" data-first-offset="true"><span data-slate-string="true">addNewBroker 的关键在于，</span></span></span><span data-slate-object="text" data-key="14242"><span data-slate-leaf="true" data-offset-key="14242:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">要为目标 Broker 创建一系列的配套资源</span></span></span></span><span data-slate-object="text" data-key="14243"><span data-slate-leaf="true" data-offset-key="14243:0" data-first-offset="true"><span data-slate-string="true">，比如，NetworkClient 用于网络 I/O 操作、messageQueue 用于阻塞队列、requestThread 用于发送请求，等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14244"><span data-slate-object="text" data-key="14245"><span data-slate-leaf="true" data-offset-key="14245:0" data-first-offset="true"><span data-slate-string="true">至于 startRequestSendThread 方法，就简单得多了，只有几行代码而已。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="14246"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="14247"><span data-slate-object="text" data-key="14248"><span data-slate-leaf="true" data-offset-key="14248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected</span></span></span></span><span data-slate-object="text" data-key="14249"><span data-slate-leaf="true" data-offset-key="14249:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="14250"><span data-slate-leaf="true" data-offset-key="14250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startRequestSendThread</span></span></span></span><span data-slate-object="text" data-key="14251"><span data-slate-leaf="true" data-offset-key="14251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(brokerId: Int)</span></span></span></span><span data-slate-object="text" data-key="14252"><span data-slate-leaf="true" data-offset-key="14252:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14253"><span data-slate-object="text" data-key="14254"><span data-slate-leaf="true" data-offset-key="14254:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14255"><span data-slate-leaf="true" data-offset-key="14255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取指定 Broker 的专属 RequestSendThread 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14256"><span data-slate-object="text" data-key="14257"><span data-slate-leaf="true" data-offset-key="14257:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14258"><span data-slate-leaf="true" data-offset-key="14258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="14259"><span data-slate-leaf="true" data-offset-key="14259:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14260"><span data-slate-leaf="true" data-offset-key="14260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestThread</span></span></span></span><span data-slate-object="text" data-key="14261"><span data-slate-leaf="true" data-offset-key="14261:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14262"><span data-slate-leaf="true" data-offset-key="14262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="14263"><span data-slate-leaf="true" data-offset-key="14263:0" data-first-offset="true"><span data-slate-string="true"> brokerStateInfo(brokerId).requestSendThread</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14264"><span data-slate-object="text" data-key="14265"><span data-slate-leaf="true" data-offset-key="14265:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="14266"><span data-slate-leaf="true" data-offset-key="14266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="14267"><span data-slate-leaf="true" data-offset-key="14267:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="14268"><span data-slate-leaf="true" data-offset-key="14268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(requestThread.getState == Thread.State.NEW)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14269"><span data-slate-object="text" data-key="14270"><span data-slate-leaf="true" data-offset-key="14270:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="14271"><span data-slate-leaf="true" data-offset-key="14271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14272"><span data-slate-object="text" data-key="14273"><span data-slate-leaf="true" data-offset-key="14273:0" data-first-offset="true"><span data-slate-string="true">    requestThread.start()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="14274"><span data-slate-object="text" data-key="14275"><span data-slate-leaf="true" data-offset-key="14275:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14276"><span data-slate-object="text" data-key="14277"><span data-slate-leaf="true" data-offset-key="14277:0" data-first-offset="true"><span data-slate-string="true">它首先根据给定的 Broker 序号信息，从 brokerStateInfo 中找出对应的 ControllerBrokerStateInfo 对象。有了这个对象，也就有了为该目标 Broker 服务的所有配套资源。下一步就是从 ControllerBrokerStateInfo 中拿出 RequestSendThread 对象，再启动它就好了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14278" id="sr-toc-4"><span data-slate-object="text" data-key="14279"><span data-slate-leaf="true" data-offset-key="14279:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14280"><span data-slate-object="text" data-key="14281"><span data-slate-leaf="true" data-offset-key="14281:0" data-first-offset="true"><span data-slate-string="true">今天，我结合 ControllerChannelManager.scala 文件，重点分析了 Controller 向 Broker 发送请求机制的实现原理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14282"><span data-slate-object="text" data-key="14283"><span data-slate-leaf="true" data-offset-key="14283:0" data-first-offset="true"><span data-slate-string="true">Controller 主要通过 ControllerChannelManager 类来实现与其他 Broker 之间的请求发送。其中，ControllerChannelManager 类中定义的 RequestSendThread 是主要的线程实现类，用于实际发送请求给集群 Broker。除了 RequestSendThread 之外，ControllerChannelManager 还定义了相应的管理方法，如添加 Broker、移除 Broker 等。通过这些管理方法，Controller 在集群扩缩容时能够快速地响应到这些变化，完成对应 Broker 连接的创建与销毁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14284"><span data-slate-object="text" data-key="14285"><span data-slate-leaf="true" data-offset-key="14285:0" data-first-offset="true"><span data-slate-string="true">我们来回顾下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="14286"><div data-slate-type="list-line" data-slate-object="block" data-key="14287"><span data-slate-object="text" data-key="14288"><span data-slate-leaf="true" data-offset-key="14288:0" data-first-offset="true"><span data-slate-string="true">Controller 端请求：Controller 发送三类请求给 Broker，分别是 LeaderAndIsrRequest、StopReplicaRequest 和 UpdateMetadataRequest。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14289"><span data-slate-object="text" data-key="14290"><span data-slate-leaf="true" data-offset-key="14290:0" data-first-offset="true"><span data-slate-string="true">RequestSendThread：该线程负责将请求发送给集群中的相关或所有 Broker。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="14291"><span data-slate-object="text" data-key="14292"><span data-slate-leaf="true" data-offset-key="14292:0" data-first-offset="true"><span data-slate-string="true">请求阻塞队列 +RequestSendThread：Controller 会为集群上所有 Broker 创建对应的请求阻塞队列和 RequestSendThread 线程。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14293"><span data-slate-object="text" data-key="14294"><span data-slate-leaf="true" data-offset-key="14294:0" data-first-offset="true"><span data-slate-string="true">其实，今天讲的所有东西都只是这节课的第二张图中 “消费者” 的部分，我们并没有详细了解请求是怎么被放到请求队列中的。接下来，我们就会针对这个问题，深入地去探讨 Controller 单线程的事件处理器是如何实现的。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="14295"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/00/b9/00fce28d26a94389f2bb5e957b650bb9.jpg?wh=2308*1068"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="14296" id="sr-toc-5"><span data-slate-object="text" data-key="14297"><span data-slate-leaf="true" data-offset-key="14297:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="14298"><span data-slate-object="text" data-key="14299"><span data-slate-leaf="true" data-offset-key="14299:0" data-first-offset="true"><span data-slate-string="true">你觉得，为每个 Broker 都创建一个 RequestSendThread 的方案有什么优缺点？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="14300"><span data-slate-object="text" data-key="14301"><span data-slate-leaf="true" data-offset-key="14301:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-6">精选留言 (5)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们重点了解了 Controller 元数据类 ControllerContext。课后我请你自行分析下 partitionLeadershipInfo 里面保存的内容。实际上，这是一个按照主题分区分组的分区详细数据容器。它保存了每个分区 Leader 副本位于哪个 Broker、Leader Epoch 值是多少、ISR 集合都有哪些副本以及 Controller Epoch 值。其中 Leader 副本和 ISR 副本集合是分区最重要的数据。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-05-19</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/07/41/2d477385.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>柠檬 C</span></div></div><div>RequestSendThread 线程的 doWork 方法中，发送请求是同步的，如果共用一个线程，可能会因为某个 broker 长时间不响应，影响其他 broker 的请求发送，老师，是这个原因吗？</div><div><p>作者回复：嗯嗯，差不多是这个意思</p></div><div><div>2020-09-15</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/55/a9/5282a560.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yic</span></div></div><div>胡老师，学到这节课，发现生产者 - 消费者在多线程场景确实是很好用，我想问一下，还有其他模式可以比较好的处理多线程场景吗？</div><div><p>作者回复：你指的多线程场景具体是什么场景呢？还是要具体问题具体分析下：）</p></div><div><div>2020-08-06</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>曾轼麟</span></div></div><div>为每个 Broker 都创建一个 RequestSendThread：
优点：
1、broker 和 broker 之间有较好的隔离性，因为每个控制类请求需要等待响应后才会发送下一个，通过这种方式避免 broker 之间相互影响
2、可以对每个线程维护自己的队列，这样队列里面的数据本身在一个线程底下可以避免一定成都的并发
3、如果一个集群里面有多个版本的 broker，也容易拓展功能，针对不同版本类型的 broker 执行不同的发送方式

缺点：
1、随着 broker 的数量增加，需要的线程数量也必然增加
2、需要监控指标需要做在每个线程内部，多线程的情况下也需要对多个线程进行监控</div><div><p>作者回复：非常好的总结。你觉得还能怎么优化下吗：）</p></div><div><div>2020-06-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/f0/9f/6689d26e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>花轮君</span></div></div><div>从另外一个角度看，如果 controller 只有单线程去调用所有的 broker，那如果中间某一台的 broker 交互阻塞，势必会影响到整个集群。采用 broker 维护 request 的方案在于必须加上对应的监控</div><div><p>作者回复：很有道理：）</p></div><div><div>2020-05-16</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".17"><outline class="toc-level-h1" data-reactid=".17.0" style="width: 175px;"><active data-reactid=".17.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".17.0.1"><span data-reactid=".17.0.1.0">12 | ControllerChannelManager：Controller 如何管理请求发送？</span></a></outline><outline class="toc-level-h2" data-reactid=".17.1" style="width: 165px;"><active data-reactid=".17.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".17.1.1"><span data-reactid=".17.1.1.0">Controller 发送请求类型</span></a></outline><outline class="toc-level-h2" data-reactid=".17.2" style="width: 165px;"><active data-reactid=".17.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".17.2.1"><span data-reactid=".17.2.1.0">RequestSendThread</span></a></outline><outline class="toc-level-h2" data-reactid=".17.3" style="width: 165px;"><active data-reactid=".17.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".17.3.1"><span data-reactid=".17.3.1.0">ControllerChannelManager</span></a></outline><outline class="toc-level-h2" data-reactid=".17.4" style="width: 165px;"><active data-reactid=".17.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".17.4.1"><span data-reactid=".17.4.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".17.5" style="width: 165px;"><active data-reactid=".17.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".17.5.1"><span data-reactid=".17.5.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".17.6" style="width: 165px;"><active data-reactid=".17.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".17.6.1"><span data-reactid=".17.6.1.0">精选留言 (5)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/235904" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>