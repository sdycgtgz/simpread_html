
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 26 | MetadataCache：Broker 是怎么异步更新元数据缓存的？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>26 | MetadataCache：Broker 是怎么异步更新元数据缓存的？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">学完了今天的课程之后，你不但能够说出 4 种 Leader 选举的场景，还能总结出它们的共性。对于面试来说，绝对是个加分项！</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">26 | MetadataCache：Broker 是怎么异步更新元数据缓存的？</h1><div><span>胡夕</span> <span> 2020-06-25</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7c/86/7c07dbbd02a2d8978e3337632e361686.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：17.37M</span><span> 时长：18:58</span></div></div><audio title="26 | MetadataCache：Broker是怎么异步更新元数据缓存的？" src="https://res001.geekbang.org/media/audio/38/35/38de7daf20406dcfe3f6aeeaa5a28735/ld/ld.m3u8" __idm_id__="57353"></audio></div><div><div><div><div data-slate-editor="true" data-key="8247" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="8248"><span data-slate-object="text" data-key="8249"><span data-slate-leaf="true" data-offset-key="8249:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。今天，我们学习 Broker 上的元数据缓存（MetadataCache）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8250"><span data-slate-object="text" data-key="8251"><span data-slate-leaf="true" data-offset-key="8251:0" data-first-offset="true"><span data-slate-string="true">你肯定很好奇，前面我们不是学过 Controller 端的元数据缓存了吗？这里的元数据缓存又是啥呢？其实，这里的 MetadataCache 是指 Broker 上的元数据缓存，这些数据是 Controller 通过 UpdateMetadataRequest 请求发送给 Broker 的。换句话说，Controller 实现了一个异步更新机制，能够将最新的集群信息广播给所有 Broker。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8252"><span data-slate-object="text" data-key="8253"><span data-slate-leaf="true" data-offset-key="8253:0" data-first-offset="true"><span data-slate-string="true">那么，为什么每台 Broker 上都要保存这份相同的数据呢？这里有两个原因。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8254"><span data-slate-object="text" data-key="8255"><span data-slate-leaf="true" data-offset-key="8255:0" data-first-offset="true"><span data-slate-string="true">第一个，也是最重要的原因，就是保存了这部分数据，Broker 就能够及时</span></span></span><span data-slate-object="text" data-key="8256"><span data-slate-leaf="true" data-offset-key="8256:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">响应客户端发送的元数据请求，也就是处理 Metadata 请求</span></span></span></span><span data-slate-object="text" data-key="8257"><span data-slate-leaf="true" data-offset-key="8257:0" data-first-offset="true"><span data-slate-string="true">。Metadata 请求是为数不多的能够被集群任意 Broker 处理的请求类型之一，也就是说，客户端程序能够随意地向任何一个 Broker 发送 Metadata 请求，去获取集群的元数据信息，这完全得益于 MetadataCache 的存在。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8258"><span data-slate-object="text" data-key="8259"><span data-slate-leaf="true" data-offset-key="8259:0" data-first-offset="true"><span data-slate-string="true">第二个原因是，Kafka 的一些重要组件会用到这部分数据。比如副本管理器会使用它来获取 Broker 的节点信息，事务管理器会使用它来获取分区 Leader 副本的信息，等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8260"><span data-slate-object="text" data-key="8261"><span data-slate-leaf="true" data-offset-key="8261:0" data-first-offset="true"><span data-slate-string="true">总之，MetadataCache 是每台 Broker 上都会保存的数据。Kafka 通过异步更新机制来保证所有 Broker 上的元数据缓存实现最终一致性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8262"><span data-slate-object="text" data-key="8263"><span data-slate-leaf="true" data-offset-key="8263:0" data-first-offset="true"><span data-slate-string="true">在实际使用的过程中，你可能会碰到这样一种场景：集群明明新创建了主题，但是消费者端却报错说 “找不到主题信息”，这种情况通常只持续很短的时间。不知道你是否思考过这里面的原因，其实说白了，很简单，这就是因为元数据是异步同步的，因此，在某一时刻，某些 Broker 尚未更新元数据，它们保存的数据就是过期的元数据，无法识别最新的主题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8264"><span data-slate-object="text" data-key="8265"><span data-slate-leaf="true" data-offset-key="8265:0" data-first-offset="true"><span data-slate-string="true">等你今天学完了 MetadataCache 类，特别是元数据的更新之后，就会彻底明白这个问题了。下面，我们就来学习下 MetadataCache 的类代码。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8266" id="sr-toc-1"><span data-slate-object="text" data-key="8267"><span data-slate-leaf="true" data-offset-key="8267:0" data-first-offset="true"><span data-slate-string="true">MetadataCache 类</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8268"><span data-slate-object="text" data-key="8269"><span data-slate-leaf="true" data-offset-key="8269:0" data-first-offset="true"><span data-slate-string="true">MetadataCache 类位于 server 包下的同名 scala 文件中。这是一个不到 400 行的小文件，里面的代码结构非常简单，该文件只定义了一个类，那就是 MetadataCache。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8270"><span data-slate-object="text" data-key="8271"><span data-slate-leaf="true" data-offset-key="8271:0" data-first-offset="true"><span data-slate-string="true">MetadataCache 的实例化是在 Kafka Broker 启动时完成的，具体的调用发生在 KafkaServer 类的 startup 方法中。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8272"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8273"><span data-slate-object="text" data-key="8274"><span data-slate-leaf="true" data-offset-key="8274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// KafkaServer.scala</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8275"><span data-slate-object="text" data-key="8276"><span data-slate-leaf="true" data-offset-key="8276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="8277"><span data-slate-leaf="true" data-offset-key="8277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">startup</span></span></span></span></span><span data-slate-object="text" data-key="8278"><span data-slate-leaf="true" data-offset-key="8278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8279"><span data-slate-leaf="true" data-offset-key="8279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="8280"><span data-slate-leaf="true" data-offset-key="8280:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8281"><span data-slate-object="text" data-key="8282"><span data-slate-leaf="true" data-offset-key="8282:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8283"><span data-slate-leaf="true" data-offset-key="8283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="8284"><span data-slate-leaf="true" data-offset-key="8284:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8285"><span data-slate-object="text" data-key="8286"><span data-slate-leaf="true" data-offset-key="8286:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8287"><span data-slate-object="text" data-key="8288"><span data-slate-leaf="true" data-offset-key="8288:0" data-first-offset="true"><span data-slate-string="true">    metadataCache = </span></span></span><span data-slate-object="text" data-key="8289"><span data-slate-leaf="true" data-offset-key="8289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8290"><span data-slate-leaf="true" data-offset-key="8290:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8291"><span data-slate-leaf="true" data-offset-key="8291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">MetadataCache</span></span></span></span><span data-slate-object="text" data-key="8292"><span data-slate-leaf="true" data-offset-key="8292:0" data-first-offset="true"><span data-slate-string="true">(config.brokerId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8293"><span data-slate-object="text" data-key="8294"><span data-slate-leaf="true" data-offset-key="8294:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8295"><span data-slate-object="text" data-key="8296"><span data-slate-leaf="true" data-offset-key="8296:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8297"><span data-slate-object="text" data-key="8298"><span data-slate-leaf="true" data-offset-key="8298:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8299"><span data-slate-leaf="true" data-offset-key="8299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="8300"><span data-slate-leaf="true" data-offset-key="8300:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8301"><span data-slate-object="text" data-key="8302"><span data-slate-leaf="true" data-offset-key="8302:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8303"><span data-slate-leaf="true" data-offset-key="8303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8304"><span data-slate-leaf="true" data-offset-key="8304:0" data-first-offset="true"><span data-slate-string="true"> e: Throwable =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8305"><span data-slate-object="text" data-key="8306"><span data-slate-leaf="true" data-offset-key="8306:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8307"><span data-slate-object="text" data-key="8308"><span data-slate-leaf="true" data-offset-key="8308:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8309"><span data-slate-object="text" data-key="8310"><span data-slate-leaf="true" data-offset-key="8310:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8311"><span data-slate-object="text" data-key="8312"><span data-slate-leaf="true" data-offset-key="8312:0" data-first-offset="true"><span data-slate-string="true">一旦实例被成功创建，就会被 Kafka 的 4 个组件使用。我来给你解释一下这 4 个组件的名称，以及它们各自使用该实例的主要目的。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8313"><div data-slate-type="list-line" data-slate-object="block" data-key="8314"><span data-slate-object="text" data-key="8315"><span data-slate-leaf="true" data-offset-key="8315:0" data-first-offset="true"><span data-slate-string="true">KafkaApis：这是源码入口类。它是执行 Kafka 各类请求逻辑的地方。该类大量使用 MetadataCache 中的主题分区和 Broker 数据，执行主题相关的判断与比较，以及获取 Broker 信息。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8316"><span data-slate-object="text" data-key="8317"><span data-slate-leaf="true" data-offset-key="8317:0" data-first-offset="true"><span data-slate-string="true">AdminManager：这是 Kafka 定义的专门用于管理主题的管理器，里面定义了很多与主题相关的方法。同 KafkaApis 类似，它会用到 MetadataCache 中的主题信息和 Broker 数据，以获取主题和 Broker 列表。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8318"><span data-slate-object="text" data-key="8319"><span data-slate-leaf="true" data-offset-key="8319:0" data-first-offset="true"><span data-slate-string="true">ReplicaManager：这是我们刚刚学过的副本管理器。它需要获取主题分区和 Broker 数据，同时还会更新 MetadataCache。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8320"><span data-slate-object="text" data-key="8321"><span data-slate-leaf="true" data-offset-key="8321:0" data-first-offset="true"><span data-slate-string="true">TransactionCoordinator：这是管理 Kafka 事务的协调者组件，它需要用到 MetadataCache 中的主题分区的 Leader 副本所在的 Broker 数据，向指定 Broker 发送事务标记。</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8322" id="sr-toc-2"><span data-slate-object="text" data-key="8323"><span data-slate-leaf="true" data-offset-key="8323:0" data-first-offset="true"><span data-slate-string="true">类定义及字段</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8324"><span data-slate-object="text" data-key="8325"><span data-slate-leaf="true" data-offset-key="8325:0" data-first-offset="true"><span data-slate-string="true">搞清楚了 MetadataCache 类被创建的时机以及它的调用方，我们就了解了它的典型使用场景，即作为集群元数据集散地，它保存了集群中关于主题和 Broker 的所有重要数据。那么，接下来，我们来看下这些数据到底都是什么。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="8326"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8327"><span data-slate-object="text" data-key="8328"><span data-slate-leaf="true" data-offset-key="8328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="8329"><span data-slate-leaf="true" data-offset-key="8329:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8330"><span data-slate-leaf="true" data-offset-key="8330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">MetadataCache</span></span></span></span><span data-slate-object="text" data-key="8331"><span data-slate-leaf="true" data-offset-key="8331:0" data-first-offset="true"><span data-slate-string="true">(brokerId: Int) </span></span></span><span data-slate-object="text" data-key="8332"><span data-slate-leaf="true" data-offset-key="8332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="8333"><span data-slate-leaf="true" data-offset-key="8333:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8334"><span data-slate-leaf="true" data-offset-key="8334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="8335"><span data-slate-leaf="true" data-offset-key="8335:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8336"><span data-slate-object="text" data-key="8337"><span data-slate-leaf="true" data-offset-key="8337:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8338"><span data-slate-leaf="true" data-offset-key="8338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8339"><span data-slate-leaf="true" data-offset-key="8339:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8340"><span data-slate-leaf="true" data-offset-key="8340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8341"><span data-slate-leaf="true" data-offset-key="8341:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8342"><span data-slate-leaf="true" data-offset-key="8342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionMetadataLock</span></span></span></span><span data-slate-object="text" data-key="8343"><span data-slate-leaf="true" data-offset-key="8343:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8344"><span data-slate-leaf="true" data-offset-key="8344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8345"><span data-slate-leaf="true" data-offset-key="8345:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8346"><span data-slate-leaf="true" data-offset-key="8346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8347"><span data-slate-leaf="true" data-offset-key="8347:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8348"><span data-slate-leaf="true" data-offset-key="8348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ReentrantReadWriteLock</span></span></span></span><span data-slate-object="text" data-key="8349"><span data-slate-leaf="true" data-offset-key="8349:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8350"><span data-slate-object="text" data-key="8351"><span data-slate-leaf="true" data-offset-key="8351:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8352"><span data-slate-leaf="true" data-offset-key="8352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="8353"><span data-slate-leaf="true" data-offset-key="8353:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8354"><span data-slate-leaf="true" data-offset-key="8354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8355"><span data-slate-leaf="true" data-offset-key="8355:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8356"><span data-slate-leaf="true" data-offset-key="8356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8357"><span data-slate-leaf="true" data-offset-key="8357:0" data-first-offset="true"><span data-slate-string="true"> metadataSnapshot: MetadataSnapshot = MetadataSnapshot(partitionStates = mutable.AnyRefMap.empty,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8358"><span data-slate-object="text" data-key="8359"><span data-slate-leaf="true" data-offset-key="8359:0" data-first-offset="true"><span data-slate-string="true">    controllerId = None, aliveBrokers = mutable.LongMap.empty, aliveNodes = mutable.LongMap.empty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8360"><span data-slate-object="text" data-key="8361"><span data-slate-leaf="true" data-offset-key="8361:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8362"><span data-slate-leaf="true" data-offset-key="8362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="8363"><span data-slate-leaf="true" data-offset-key="8363:0" data-first-offset="true"><span data-slate-string="true">.logIdent = s</span></span></span><span data-slate-object="text" data-key="8364"><span data-slate-leaf="true" data-offset-key="8364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[MetadataCache brokerId=$brokerId]"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8365"><span data-slate-object="text" data-key="8366"><span data-slate-leaf="true" data-offset-key="8366:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8367"><span data-slate-leaf="true" data-offset-key="8367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8368"><span data-slate-leaf="true" data-offset-key="8368:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8369"><span data-slate-leaf="true" data-offset-key="8369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8370"><span data-slate-leaf="true" data-offset-key="8370:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8371"><span data-slate-leaf="true" data-offset-key="8371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">stateChangeLogger</span></span></span></span><span data-slate-object="text" data-key="8372"><span data-slate-leaf="true" data-offset-key="8372:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8373"><span data-slate-leaf="true" data-offset-key="8373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8374"><span data-slate-leaf="true" data-offset-key="8374:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8375"><span data-slate-leaf="true" data-offset-key="8375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8376"><span data-slate-leaf="true" data-offset-key="8376:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8377"><span data-slate-leaf="true" data-offset-key="8377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">StateChangeLogger</span></span></span></span><span data-slate-object="text" data-key="8378"><span data-slate-leaf="true" data-offset-key="8378:0" data-first-offset="true"><span data-slate-string="true">(brokerId, inControllerContext = </span></span></span><span data-slate-object="text" data-key="8379"><span data-slate-leaf="true" data-offset-key="8379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="8380"><span data-slate-leaf="true" data-offset-key="8380:0" data-first-offset="true"><span data-slate-string="true">, None)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8381"><span data-slate-object="text" data-key="8382"><span data-slate-leaf="true" data-offset-key="8382:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8383"><span data-slate-object="text" data-key="8384"><span data-slate-leaf="true" data-offset-key="8384:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8385"><span data-slate-object="text" data-key="8386"><span data-slate-leaf="true" data-offset-key="8386:0" data-first-offset="true"><span data-slate-string="true">MetadataCache 类构造函数只需要一个参数：</span></span></span><span data-slate-object="text" data-key="8387"><span data-slate-leaf="true" data-offset-key="8387:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerId</span></span></span></span><span data-slate-object="text" data-key="8388"><span data-slate-leaf="true" data-offset-key="8388:0" data-first-offset="true"><span data-slate-string="true">，即 Broker 的 ID 序号。除了这个参数，该类还定义了 4 个字段。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8389"><span data-slate-object="text" data-key="8390"><span data-slate-leaf="true" data-offset-key="8390:0" data-first-offset="true"><span data-slate-string="true">partitionMetadataLock 字段是保护它写入的锁对象，logIndent 和 stateChangeLogger 字段仅仅用于日志输出，而 metadataSnapshot 字段保存了实际的元数据信息，它是 MetadataCache 类中最重要的字段，我们要重点关注一下它。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8391"><span data-slate-object="text" data-key="8392"><span data-slate-leaf="true" data-offset-key="8392:0" data-first-offset="true"><span data-slate-string="true">该字段的类型是 MetadataSnapshot 类，该类是 MetadataCache 中定义的一个嵌套类。以下是该嵌套类的源码：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8393"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8394"><span data-slate-object="text" data-key="8395"><span data-slate-leaf="true" data-offset-key="8395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span></span><span data-slate-object="text" data-key="8396"><span data-slate-leaf="true" data-offset-key="8396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8397"><span data-slate-leaf="true" data-offset-key="8397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="8398"><span data-slate-leaf="true" data-offset-key="8398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8399"><span data-slate-leaf="true" data-offset-key="8399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">MetadataSnapshot</span></span></span></span></span><span data-slate-object="text" data-key="8400"><span data-slate-leaf="true" data-offset-key="8400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(partitionStates: </span></span></span></span></span><span data-slate-object="text" data-key="8401"><span data-slate-leaf="true" data-offset-key="8401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span></span></span><span data-slate-object="text" data-key="8402"><span data-slate-leaf="true" data-offset-key="8402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.AnyRefMap</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8403"><span data-slate-object="text" data-key="8404"><span data-slate-leaf="true" data-offset-key="8404:0" data-first-offset="true"><span data-slate-string="true">  [String, </span></span></span><span data-slate-object="text" data-key="8405"><span data-slate-leaf="true" data-offset-key="8405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span><span data-slate-object="text" data-key="8406"><span data-slate-leaf="true" data-offset-key="8406:0" data-first-offset="true"><span data-slate-string="true">.LongMap[UpdateMetadataPartitionState]],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8407"><span data-slate-object="text" data-key="8408"><span data-slate-leaf="true" data-offset-key="8408:0" data-first-offset="true"><span data-slate-string="true">  controllerId: Option[Int],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8409"><span data-slate-object="text" data-key="8410"><span data-slate-leaf="true" data-offset-key="8410:0" data-first-offset="true"><span data-slate-string="true">  aliveBrokers: </span></span></span><span data-slate-object="text" data-key="8411"><span data-slate-leaf="true" data-offset-key="8411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span><span data-slate-object="text" data-key="8412"><span data-slate-leaf="true" data-offset-key="8412:0" data-first-offset="true"><span data-slate-string="true">.LongMap[Broker],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8413"><span data-slate-object="text" data-key="8414"><span data-slate-leaf="true" data-offset-key="8414:0" data-first-offset="true"><span data-slate-string="true">  aliveNodes: </span></span></span><span data-slate-object="text" data-key="8415"><span data-slate-leaf="true" data-offset-key="8415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span><span data-slate-object="text" data-key="8416"><span data-slate-leaf="true" data-offset-key="8416:0" data-first-offset="true"><span data-slate-string="true">.LongMap[collection.Map[ListenerName, Node]])</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8417"><span data-slate-object="text" data-key="8418"><span data-slate-leaf="true" data-offset-key="8418:0" data-first-offset="true"><span data-slate-string="true">从源码可知，它是一个 case 类，相当于 Java 中配齐了 Getter 方法的 POJO 类。同时，它也是一个不可变类（Immutable Class）。正因为它的不可变性，其字段值是不允许修改的，我们只能重新创建一个新的实例，来保存更新后的字段值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8419"><span data-slate-object="text" data-key="8420"><span data-slate-leaf="true" data-offset-key="8420:0" data-first-offset="true"><span data-slate-string="true">我们看下它的各个字段的含义。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8421"><div data-slate-type="list-line" data-slate-object="block" data-key="8422"><span data-slate-object="text" data-key="8423"><span data-slate-leaf="true" data-offset-key="8423:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">partitionStates</span></span></span></span><span data-slate-object="text" data-key="8424"><span data-slate-leaf="true" data-offset-key="8424:0" data-first-offset="true"><span data-slate-string="true">：这是一个 Map 类型。Key 是主题名称，Value 又是一个 Map 类型，其 Key 是分区号，Value 是一个 UpdateMetadataPartitionState 类型的字段。UpdateMetadataPartitionState 类型是 UpdateMetadataRequest 请求内部所需的数据结构。一会儿我们再说这个类型都有哪些数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8425"><span data-slate-object="text" data-key="8426"><span data-slate-leaf="true" data-offset-key="8426:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">controllerId</span></span></span></span><span data-slate-object="text" data-key="8427"><span data-slate-leaf="true" data-offset-key="8427:0" data-first-offset="true"><span data-slate-string="true">：Controller 所在 Broker 的 ID。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8428"><span data-slate-object="text" data-key="8429"><span data-slate-leaf="true" data-offset-key="8429:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">aliveBrokers</span></span></span></span><span data-slate-object="text" data-key="8430"><span data-slate-leaf="true" data-offset-key="8430:0" data-first-offset="true"><span data-slate-string="true">：当前集群中所有存活着的 Broker 对象列表。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="8431"><span data-slate-object="text" data-key="8432"><span data-slate-leaf="true" data-offset-key="8432:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">aliveNodes</span></span></span></span><span data-slate-object="text" data-key="8433"><span data-slate-leaf="true" data-offset-key="8433:0" data-first-offset="true"><span data-slate-string="true">：这也是一个 Map 的 Map 类型。其 Key 是 Broker ID 序号，Value 是 Map 类型，其 Key 是 ListenerName，即 Broker 监听器类型，而 Value 是 Broker 节点对象。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8434"><span data-slate-object="text" data-key="8435"><span data-slate-leaf="true" data-offset-key="8435:0" data-first-offset="true"><span data-slate-string="true">现在，我们说说 UpdateMetadataPartitionState 类型。这个类型的源码是由 Kafka 工程自动生成的。UpdateMetadataRequest 请求所需的字段用 JSON 格式表示，由 Kafka 的 generator 工程负责为 JSON 格式自动生成对应的 Java 文件，生成的类是一个 POJO 类，其定义如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="8436"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8437"><span data-slate-object="text" data-key="8438"><span data-slate-leaf="true" data-offset-key="8438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="8439"><span data-slate-leaf="true" data-offset-key="8439:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8440"><span data-slate-leaf="true" data-offset-key="8440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="8441"><span data-slate-leaf="true" data-offset-key="8441:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8442"><span data-slate-leaf="true" data-offset-key="8442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="8443"><span data-slate-leaf="true" data-offset-key="8443:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8444"><span data-slate-leaf="true" data-offset-key="8444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">UpdateMetadataPartitionState</span></span></span></span><span data-slate-object="text" data-key="8445"><span data-slate-leaf="true" data-offset-key="8445:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8446"><span data-slate-leaf="true" data-offset-key="8446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">implements</span></span></span></span><span data-slate-object="text" data-key="8447"><span data-slate-leaf="true" data-offset-key="8447:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8448"><span data-slate-leaf="true" data-offset-key="8448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Message</span></span></span></span><span data-slate-object="text" data-key="8449"><span data-slate-leaf="true" data-offset-key="8449:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8450"><span data-slate-object="text" data-key="8451"><span data-slate-leaf="true" data-offset-key="8451:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8452"><span data-slate-leaf="true" data-offset-key="8452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8453"><span data-slate-leaf="true" data-offset-key="8453:0" data-first-offset="true"><span data-slate-string="true"> String topicName;     </span></span></span><span data-slate-object="text" data-key="8454"><span data-slate-leaf="true" data-offset-key="8454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 主题名称</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8455"><span data-slate-object="text" data-key="8456"><span data-slate-leaf="true" data-offset-key="8456:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8457"><span data-slate-leaf="true" data-offset-key="8457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8458"><span data-slate-leaf="true" data-offset-key="8458:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8459"><span data-slate-leaf="true" data-offset-key="8459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8460"><span data-slate-leaf="true" data-offset-key="8460:0" data-first-offset="true"><span data-slate-string="true"> partitionIndex;   </span></span></span><span data-slate-object="text" data-key="8461"><span data-slate-leaf="true" data-offset-key="8461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分区号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8462"><span data-slate-object="text" data-key="8463"><span data-slate-leaf="true" data-offset-key="8463:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8464"><span data-slate-leaf="true" data-offset-key="8464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8465"><span data-slate-leaf="true" data-offset-key="8465:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8466"><span data-slate-leaf="true" data-offset-key="8466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8467"><span data-slate-leaf="true" data-offset-key="8467:0" data-first-offset="true"><span data-slate-string="true"> controllerEpoch;  </span></span></span><span data-slate-object="text" data-key="8468"><span data-slate-leaf="true" data-offset-key="8468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Controller Epoch 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8469"><span data-slate-object="text" data-key="8470"><span data-slate-leaf="true" data-offset-key="8470:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8471"><span data-slate-leaf="true" data-offset-key="8471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8472"><span data-slate-leaf="true" data-offset-key="8472:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8473"><span data-slate-leaf="true" data-offset-key="8473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8474"><span data-slate-leaf="true" data-offset-key="8474:0" data-first-offset="true"><span data-slate-string="true"> leader;           </span></span></span><span data-slate-object="text" data-key="8475"><span data-slate-leaf="true" data-offset-key="8475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Leader 副本所在 Broker ID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8476"><span data-slate-object="text" data-key="8477"><span data-slate-leaf="true" data-offset-key="8477:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8478"><span data-slate-leaf="true" data-offset-key="8478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8479"><span data-slate-leaf="true" data-offset-key="8479:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8480"><span data-slate-leaf="true" data-offset-key="8480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8481"><span data-slate-leaf="true" data-offset-key="8481:0" data-first-offset="true"><span data-slate-string="true"> leaderEpoch;      </span></span></span><span data-slate-object="text" data-key="8482"><span data-slate-leaf="true" data-offset-key="8482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Leader Epoch 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8483"><span data-slate-object="text" data-key="8484"><span data-slate-leaf="true" data-offset-key="8484:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8485"><span data-slate-leaf="true" data-offset-key="8485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8486"><span data-slate-leaf="true" data-offset-key="8486:0" data-first-offset="true"><span data-slate-string="true"> List&lt;Integer&gt; isr;    </span></span></span><span data-slate-object="text" data-key="8487"><span data-slate-leaf="true" data-offset-key="8487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ISR 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8488"><span data-slate-object="text" data-key="8489"><span data-slate-leaf="true" data-offset-key="8489:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8490"><span data-slate-leaf="true" data-offset-key="8490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8491"><span data-slate-leaf="true" data-offset-key="8491:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8492"><span data-slate-leaf="true" data-offset-key="8492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="8493"><span data-slate-leaf="true" data-offset-key="8493:0" data-first-offset="true"><span data-slate-string="true"> zkVersion;        </span></span></span><span data-slate-object="text" data-key="8494"><span data-slate-leaf="true" data-offset-key="8494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ZooKeeper 节点 Stat 统计信息中的版本号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8495"><span data-slate-object="text" data-key="8496"><span data-slate-leaf="true" data-offset-key="8496:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8497"><span data-slate-leaf="true" data-offset-key="8497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8498"><span data-slate-leaf="true" data-offset-key="8498:0" data-first-offset="true"><span data-slate-string="true"> List&lt;Integer&gt; replicas;  </span></span></span><span data-slate-object="text" data-key="8499"><span data-slate-leaf="true" data-offset-key="8499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 副本列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8500"><span data-slate-object="text" data-key="8501"><span data-slate-leaf="true" data-offset-key="8501:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8502"><span data-slate-leaf="true" data-offset-key="8502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8503"><span data-slate-leaf="true" data-offset-key="8503:0" data-first-offset="true"><span data-slate-string="true"> List&lt;Integer&gt; offlineReplicas;  </span></span></span><span data-slate-object="text" data-key="8504"><span data-slate-leaf="true" data-offset-key="8504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 离线副本列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8505"><span data-slate-object="text" data-key="8506"><span data-slate-leaf="true" data-offset-key="8506:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8507"><span data-slate-leaf="true" data-offset-key="8507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="8508"><span data-slate-leaf="true" data-offset-key="8508:0" data-first-offset="true"><span data-slate-string="true"> List&lt;RawTaggedField&gt; _unknownTaggedFields; </span></span></span><span data-slate-object="text" data-key="8509"><span data-slate-leaf="true" data-offset-key="8509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 未知字段列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8510"><span data-slate-object="text" data-key="8511"><span data-slate-leaf="true" data-offset-key="8511:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8512"><span data-slate-object="text" data-key="8513"><span data-slate-leaf="true" data-offset-key="8513:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8514"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8515"><span data-slate-object="text" data-key="8516"><span data-slate-leaf="true" data-offset-key="8516:0" data-first-offset="true"><span data-slate-string="true">可以看到，UpdateMetadataPartitionState 类的字段信息非常丰富，它包含了一个主题分区非常详尽的数据，从主题名称、分区号、Leader 副本、ISR 列表到 Controller Epoch、ZooKeeper 版本号等信息，一应俱全。从宏观角度来看，Kafka 集群元数据由主题数据和 Broker 数据两部分构成。所以，可以这么说，MetadataCache 中的这个字段撑起了元数据缓存的 “一半天空”。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8517" id="sr-toc-3"><span data-slate-object="text" data-key="8518"><span data-slate-leaf="true" data-offset-key="8518:0" data-first-offset="true"><span data-slate-string="true">重要方法</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8519"><span data-slate-object="text" data-key="8520"><span data-slate-leaf="true" data-offset-key="8520:0" data-first-offset="true"><span data-slate-string="true">接下来，我们学习下 MetadataCache 类的重要方法。你需要记住的是，这个类最重要的方法就是</span></span></span><span data-slate-object="text" data-key="8521"><span data-slate-leaf="true" data-offset-key="8521:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">操作 metadataSnapshot 字段的方法</span></span></span></span><span data-slate-object="text" data-key="8522"><span data-slate-leaf="true" data-offset-key="8522:0" data-first-offset="true"><span data-slate-string="true">，毕竟，所谓的元数据缓存，就是指 MetadataSnapshot 类中承载的东西。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8523"><span data-slate-object="text" data-key="8524"><span data-slate-leaf="true" data-offset-key="8524:0" data-first-offset="true"><span data-slate-string="true">我把 MetadataCache 类的方法大致分为三大类：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8525"><div data-slate-type="list-line" data-slate-object="block" data-key="8526"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="8527"><span data-slate-leaf="true" data-offset-key="8527:0" data-first-offset="true"><span data-slate-string="true">判断类；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="8528"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="8529"><span data-slate-leaf="true" data-offset-key="8529:0" data-first-offset="true"><span data-slate-string="true">获取类；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="8530"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="8531"><span data-slate-leaf="true" data-offset-key="8531:0" data-first-offset="true"><span data-slate-string="true">更新类。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8532"><span data-slate-object="text" data-key="8533"><span data-slate-leaf="true" data-offset-key="8533:0" data-first-offset="true"><span data-slate-string="true">这三大类方法是由浅入深的关系，我们先从简单的判断类方法开始。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8534" id="sr-toc-4"><span data-slate-object="text" data-key="8535"><span data-slate-leaf="true" data-offset-key="8535:0" data-first-offset="true"><span data-slate-string="true">判断类方法</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8536"><span data-slate-object="text" data-key="8537"><span data-slate-leaf="true" data-offset-key="8537:0" data-first-offset="true"><span data-slate-string="true">所谓的判断类方法，就是判断给定主题或主题分区是否包含在元数据缓存中的方法。MetadataCache 类提供了两个判断类的方法，方法名都是 </span></span></span><span data-slate-object="text" data-key="8538"><span data-slate-leaf="true" data-offset-key="8538:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">contains</span></span></span></span><span data-slate-object="text" data-key="8539"><span data-slate-leaf="true" data-offset-key="8539:0" data-first-offset="true"><span data-slate-string="true">，只是输入参数不同。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8540"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8541"><span data-slate-object="text" data-key="8542"><span data-slate-leaf="true" data-offset-key="8542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断给定主题是否包含在元数据缓存中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8543"><span data-slate-object="text" data-key="8544"><span data-slate-leaf="true" data-offset-key="8544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="8545"><span data-slate-leaf="true" data-offset-key="8545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">contains</span></span></span></span></span><span data-slate-object="text" data-key="8546"><span data-slate-leaf="true" data-offset-key="8546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topic: String)</span></span></span></span></span><span data-slate-object="text" data-key="8547"><span data-slate-leaf="true" data-offset-key="8547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Boolean =</span></span></span></span><span data-slate-object="text" data-key="8548"><span data-slate-leaf="true" data-offset-key="8548:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8549"><span data-slate-object="text" data-key="8550"><span data-slate-leaf="true" data-offset-key="8550:0" data-first-offset="true"><span data-slate-string="true">  metadataSnapshot.partitionStates.</span></span></span><span data-slate-object="text" data-key="8551"><span data-slate-leaf="true" data-offset-key="8551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">contains</span></span></span></span><span data-slate-object="text" data-key="8552"><span data-slate-leaf="true" data-offset-key="8552:0" data-first-offset="true"><span data-slate-string="true">(topic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8553"><span data-slate-object="text" data-key="8554"><span data-slate-leaf="true" data-offset-key="8554:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8555"><span data-slate-object="text" data-key="8556"><span data-slate-leaf="true" data-offset-key="8556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断给定主题分区是否包含在元数据缓存中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8557"><span data-slate-object="text" data-key="8558"><span data-slate-leaf="true" data-offset-key="8558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="8559"><span data-slate-leaf="true" data-offset-key="8559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">contains</span></span></span></span></span><span data-slate-object="text" data-key="8560"><span data-slate-leaf="true" data-offset-key="8560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(tp: TopicPartition)</span></span></span></span></span><span data-slate-object="text" data-key="8561"><span data-slate-leaf="true" data-offset-key="8561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Boolean =</span></span></span></span><span data-slate-object="text" data-key="8562"><span data-slate-leaf="true" data-offset-key="8562:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8563"><span data-slate-leaf="true" data-offset-key="8563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getPartitionInfo</span></span></span></span><span data-slate-object="text" data-key="8564"><span data-slate-leaf="true" data-offset-key="8564:0" data-first-offset="true"><span data-slate-string="true">(tp.topic, tp.partition).isDefined</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8565"><span data-slate-object="text" data-key="8566"><span data-slate-leaf="true" data-offset-key="8566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取给定主题分区的详细数据信息。如果没有找到对应记录，返回 None</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8567"><span data-slate-object="text" data-key="8568"><span data-slate-leaf="true" data-offset-key="8568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="8569"><span data-slate-leaf="true" data-offset-key="8569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getPartitionInfo</span></span></span></span></span><span data-slate-object="text" data-key="8570"><span data-slate-leaf="true" data-offset-key="8570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(topic: String, </span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8571"><span data-slate-object="text" data-key="8572"><span data-slate-leaf="true" data-offset-key="8572:0" data-first-offset="true"><span data-slate-string="true">  partitionId: Int): Option[UpdateMetadataPartitionState] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8573"><span data-slate-object="text" data-key="8574"><span data-slate-leaf="true" data-offset-key="8574:0" data-first-offset="true"><span data-slate-string="true">  metadataSnapshot.partitionStates.</span></span></span><span data-slate-object="text" data-key="8575"><span data-slate-leaf="true" data-offset-key="8575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="8576"><span data-slate-leaf="true" data-offset-key="8576:0" data-first-offset="true"><span data-slate-string="true">(topic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8577"><span data-slate-object="text" data-key="8578"><span data-slate-leaf="true" data-offset-key="8578:0" data-first-offset="true"><span data-slate-string="true">    .</span></span></span><span data-slate-object="text" data-key="8579"><span data-slate-leaf="true" data-offset-key="8579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flatMap</span></span></span></span><span data-slate-object="text" data-key="8580"><span data-slate-leaf="true" data-offset-key="8580:0" data-first-offset="true"><span data-slate-string="true">(_.</span></span></span><span data-slate-object="text" data-key="8581"><span data-slate-leaf="true" data-offset-key="8581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="8582"><span data-slate-leaf="true" data-offset-key="8582:0" data-first-offset="true"><span data-slate-string="true">(partitionId))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8583"><span data-slate-object="text" data-key="8584"><span data-slate-leaf="true" data-offset-key="8584:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8585"><span data-slate-object="text" data-key="8586"><span data-slate-leaf="true" data-offset-key="8586:0" data-first-offset="true"><span data-slate-string="true">第一个 contains 方法用于判断给定主题是否包含在元数据缓存中，比较简单，只需要判断 metadataSnapshot 中 partitionStates 的所有 Key 是否包含指定主题就行了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8587"><span data-slate-object="text" data-key="8588"><span data-slate-leaf="true" data-offset-key="8588:0" data-first-offset="true"><span data-slate-string="true">第二个 contains 方法相对复杂一点。它首先要从 metadataSnapshot 中获取指定主题分区的分区数据信息，然后根据分区数据是否存在，来判断给定主题分区是否包含在元数据缓存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8589"><span data-slate-object="text" data-key="8590"><span data-slate-leaf="true" data-offset-key="8590:0" data-first-offset="true"><span data-slate-string="true">判断类的方法实现都很简单，代码也不多，很好理解，我就不多说了。接下来，我们来看获取类方法。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8591" id="sr-toc-5"><span data-slate-object="text" data-key="8592"><span data-slate-leaf="true" data-offset-key="8592:0" data-first-offset="true"><span data-slate-string="true">获取类方法</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8593"><span data-slate-object="text" data-key="8594"><span data-slate-leaf="true" data-offset-key="8594:0" data-first-offset="true"><span data-slate-string="true">MetadataCache 类的 getXXX 方法非常多，其中，比较有代表性的是 getAllTopics 方法、getAllPartitions 方法和 getPartitionReplicaEndpoints，它们分别是获取主题、分区和副本对象的方法。在我看来，这是最基础的元数据获取方法了，非常值得我们学习。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8595"><span data-slate-object="text" data-key="8596"><span data-slate-leaf="true" data-offset-key="8596:0" data-first-offset="true"><span data-slate-string="true">首先，我们来看入门级的 get 方法，即 getAllTopics 方法。该方法返回当前集群元数据缓存中的所有主题。代码如下：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="8597"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8598"><span data-slate-object="text" data-key="8599"><span data-slate-leaf="true" data-offset-key="8599:0" data-first-offset="true"><span data-slate-string="true">private </span></span></span><span data-slate-object="text" data-key="8600"><span data-slate-leaf="true" data-offset-key="8600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def</span></span></span></span><span data-slate-object="text" data-key="8601"><span data-slate-leaf="true" data-offset-key="8601:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8602"><span data-slate-leaf="true" data-offset-key="8602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getAllTopics</span></span></span></span><span data-slate-object="text" data-key="8603"><span data-slate-leaf="true" data-offset-key="8603:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8604"><span data-slate-leaf="true" data-offset-key="8604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">snapshot: MetadataSnapshot</span></span></span></span><span data-slate-object="text" data-key="8605"><span data-slate-leaf="true" data-offset-key="8605:0" data-first-offset="true"><span data-slate-string="true">): </span></span></span><span data-slate-object="text" data-key="8606"><span data-slate-leaf="true" data-offset-key="8606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="8607"><span data-slate-leaf="true" data-offset-key="8607:0" data-first-offset="true"><span data-slate-string="true">[String] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8608"><span data-slate-object="text" data-key="8609"><span data-slate-leaf="true" data-offset-key="8609:0" data-first-offset="true"><span data-slate-string="true">  snapshot.partitionStates.keySet</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8610"><span data-slate-object="text" data-key="8611"><span data-slate-leaf="true" data-offset-key="8611:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8612"><span data-slate-object="text" data-key="8613"><span data-slate-leaf="true" data-offset-key="8613:0" data-first-offset="true"><span data-slate-string="true">它仅仅是返回 MetadataSnapshot 数据类型中 partitionStates 字段的所有 Key 字段。前面说过，partitionStates 是一个 Map 类型，Key 就是主题。怎么样，简单吧？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8614"><span data-slate-object="text" data-key="8615"><span data-slate-leaf="true" data-offset-key="8615:0" data-first-offset="true"><span data-slate-string="true">如果我们要获取元数据缓存中的分区对象，该怎么写呢？来看看 </span></span></span><span data-slate-object="text" data-key="8616"><span data-slate-leaf="true" data-offset-key="8616:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">getAllPartitions 方法</span></span></span></span><span data-slate-object="text" data-key="8617"><span data-slate-leaf="true" data-offset-key="8617:0" data-first-offset="true"><span data-slate-string="true">的实现。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="8618"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8619"><span data-slate-object="text" data-key="8620"><span data-slate-leaf="true" data-offset-key="8620:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="8621"><span data-slate-leaf="true" data-offset-key="8621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getAllPartitions</span></span></span></span><span data-slate-object="text" data-key="8622"><span data-slate-leaf="true" data-offset-key="8622:0" data-first-offset="true"><span data-slate-string="true">(): </span></span></span><span data-slate-object="text" data-key="8623"><span data-slate-leaf="true" data-offset-key="8623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="8624"><span data-slate-leaf="true" data-offset-key="8624:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="8625"><span data-slate-leaf="true" data-offset-key="8625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicPartition</span></span></span></span><span data-slate-object="text" data-key="8626"><span data-slate-leaf="true" data-offset-key="8626:0" data-first-offset="true"><span data-slate-string="true">] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8627"><span data-slate-object="text" data-key="8628"><span data-slate-leaf="true" data-offset-key="8628:0" data-first-offset="true"><span data-slate-string="true">  metadataSnapshot.</span></span></span><span data-slate-object="text" data-key="8629"><span data-slate-leaf="true" data-offset-key="8629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionStates</span></span></span></span><span data-slate-object="text" data-key="8630"><span data-slate-leaf="true" data-offset-key="8630:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="8631"><span data-slate-leaf="true" data-offset-key="8631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flatMap</span></span></span></span><span data-slate-object="text" data-key="8632"><span data-slate-leaf="true" data-offset-key="8632:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="8633"><span data-slate-leaf="true" data-offset-key="8633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8634"><span data-slate-leaf="true" data-offset-key="8634:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8635"><span data-slate-leaf="true" data-offset-key="8635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="8636"><span data-slate-leaf="true" data-offset-key="8636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicName, partitionsAndStates</span></span></span></span></span><span data-slate-object="text" data-key="8637"><span data-slate-leaf="true" data-offset-key="8637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) =&gt;</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8638"><span data-slate-object="text" data-key="8639"><span data-slate-leaf="true" data-offset-key="8639:0" data-first-offset="true"><span data-slate-string="true">    partitionsAndStates.</span></span></span><span data-slate-object="text" data-key="8640"><span data-slate-leaf="true" data-offset-key="8640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">keys</span></span></span></span><span data-slate-object="text" data-key="8641"><span data-slate-leaf="true" data-offset-key="8641:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="8642"><span data-slate-leaf="true" data-offset-key="8642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="8643"><span data-slate-leaf="true" data-offset-key="8643:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8644"><span data-slate-leaf="true" data-offset-key="8644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionId</span></span></span></span></span><span data-slate-object="text" data-key="8645"><span data-slate-leaf="true" data-offset-key="8645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt;</span></span></span></span><span data-slate-object="text" data-key="8646"><span data-slate-leaf="true" data-offset-key="8646:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8647"><span data-slate-leaf="true" data-offset-key="8647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8648"><span data-slate-leaf="true" data-offset-key="8648:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8649"><span data-slate-leaf="true" data-offset-key="8649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicPartition</span></span></span></span><span data-slate-object="text" data-key="8650"><span data-slate-leaf="true" data-offset-key="8650:0" data-first-offset="true"><span data-slate-string="true">(topicName, partitionId.</span></span></span><span data-slate-object="text" data-key="8651"><span data-slate-leaf="true" data-offset-key="8651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">toInt</span></span></span></span><span data-slate-object="text" data-key="8652"><span data-slate-leaf="true" data-offset-key="8652:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8653"><span data-slate-object="text" data-key="8654"><span data-slate-leaf="true" data-offset-key="8654:0" data-first-offset="true"><span data-slate-string="true">  }.</span></span></span><span data-slate-object="text" data-key="8655"><span data-slate-leaf="true" data-offset-key="8655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">toSet</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8656"><span data-slate-object="text" data-key="8657"><span data-slate-leaf="true" data-offset-key="8657:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8658"><span data-slate-object="text" data-key="8659"><span data-slate-leaf="true" data-offset-key="8659:0" data-first-offset="true"><span data-slate-string="true">和 getAllTopics 方法类似，它的主要思想也是遍历 partitionStates，取出分区号后，构建 TopicPartition 实例，并加入到返回集合中返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8660"><span data-slate-object="text" data-key="8661"><span data-slate-leaf="true" data-offset-key="8661:0" data-first-offset="true"><span data-slate-string="true">最后，我们看一个相对复杂一点的 get 方法：getPartitionReplicaEndpoints。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="8662"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8663"><span data-slate-object="text" data-key="8664"><span data-slate-leaf="true" data-offset-key="8664:0" data-first-offset="true"><span data-slate-string="true">def getPartitionReplicaEndpoints(tp: TopicPartition, listenerName: ListenerName): </span></span></span><span data-slate-object="text" data-key="8665"><span data-slate-leaf="true" data-offset-key="8665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="8666"><span data-slate-leaf="true" data-offset-key="8666:0" data-first-offset="true"><span data-slate-string="true">[Int, Node] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8667"><span data-slate-object="text" data-key="8668"><span data-slate-leaf="true" data-offset-key="8668:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8669"><span data-slate-leaf="true" data-offset-key="8669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用局部变量获取当前元数据缓存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8670"><span data-slate-object="text" data-key="8671"><span data-slate-leaf="true" data-offset-key="8671:0" data-first-offset="true"><span data-slate-string="true">  val snapshot = metadataSnapshot</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8672"><span data-slate-object="text" data-key="8673"><span data-slate-leaf="true" data-offset-key="8673:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8674"><span data-slate-leaf="true" data-offset-key="8674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取给定主题分区的数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8675"><span data-slate-object="text" data-key="8676"><span data-slate-leaf="true" data-offset-key="8676:0" data-first-offset="true"><span data-slate-string="true">  snapshot.partitionStates.</span></span></span><span data-slate-object="text" data-key="8677"><span data-slate-leaf="true" data-offset-key="8677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="8678"><span data-slate-leaf="true" data-offset-key="8678:0" data-first-offset="true"><span data-slate-string="true">(tp.topic).flatMap(_.</span></span></span><span data-slate-object="text" data-key="8679"><span data-slate-leaf="true" data-offset-key="8679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="8680"><span data-slate-leaf="true" data-offset-key="8680:0" data-first-offset="true"><span data-slate-string="true">(tp.partition))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8681"><span data-slate-object="text" data-key="8682"><span data-slate-leaf="true" data-offset-key="8682:0" data-first-offset="true"><span data-slate-string="true">    .map {partitionInfo =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8683"><span data-slate-object="text" data-key="8684"><span data-slate-leaf="true" data-offset-key="8684:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8685"><span data-slate-leaf="true" data-offset-key="8685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 拿到副本 Id 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8686"><span data-slate-object="text" data-key="8687"><span data-slate-leaf="true" data-offset-key="8687:0" data-first-offset="true"><span data-slate-string="true">    val replicaIds = partitionInfo.replicas</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8688"><span data-slate-object="text" data-key="8689"><span data-slate-leaf="true" data-offset-key="8689:0" data-first-offset="true"><span data-slate-string="true">    replicaIds.asScala</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8690"><span data-slate-object="text" data-key="8691"><span data-slate-leaf="true" data-offset-key="8691:0" data-first-offset="true"><span data-slate-string="true">      .map(replicaId =&gt; replicaId.intValue() -&gt; {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8692"><span data-slate-object="text" data-key="8693"><span data-slate-leaf="true" data-offset-key="8693:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8694"><span data-slate-leaf="true" data-offset-key="8694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取副本所在的 Broker Id</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8695"><span data-slate-object="text" data-key="8696"><span data-slate-leaf="true" data-offset-key="8696:0" data-first-offset="true"><span data-slate-string="true">        snapshot.aliveBrokers.</span></span></span><span data-slate-object="text" data-key="8697"><span data-slate-leaf="true" data-offset-key="8697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="8698"><span data-slate-leaf="true" data-offset-key="8698:0" data-first-offset="true"><span data-slate-string="true">(replicaId.longValue()) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8699"><span data-slate-object="text" data-key="8700"><span data-slate-leaf="true" data-offset-key="8700:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="8701"><span data-slate-leaf="true" data-offset-key="8701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8702"><span data-slate-leaf="true" data-offset-key="8702:0" data-first-offset="true"><span data-slate-string="true"> Some(broker) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8703"><span data-slate-object="text" data-key="8704"><span data-slate-leaf="true" data-offset-key="8704:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="8705"><span data-slate-leaf="true" data-offset-key="8705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据 Broker Id 去获取对应的 Broker 节点对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8706"><span data-slate-object="text" data-key="8707"><span data-slate-leaf="true" data-offset-key="8707:0" data-first-offset="true"><span data-slate-string="true">            broker.getNode(listenerName).getOrElse(Node.noNode())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8708"><span data-slate-object="text" data-key="8709"><span data-slate-leaf="true" data-offset-key="8709:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="8710"><span data-slate-leaf="true" data-offset-key="8710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8711"><span data-slate-leaf="true" data-offset-key="8711:0" data-first-offset="true"><span data-slate-string="true"> None =&gt; </span></span></span><span data-slate-object="text" data-key="8712"><span data-slate-leaf="true" data-offset-key="8712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果找不到节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8713"><span data-slate-object="text" data-key="8714"><span data-slate-leaf="true" data-offset-key="8714:0" data-first-offset="true"><span data-slate-string="true">            Node.noNode()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8715"><span data-slate-object="text" data-key="8716"><span data-slate-leaf="true" data-offset-key="8716:0" data-first-offset="true"><span data-slate-string="true">        }}).toMap</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8717"><span data-slate-object="text" data-key="8718"><span data-slate-leaf="true" data-offset-key="8718:0" data-first-offset="true"><span data-slate-string="true">      .filter(pair =&gt; pair match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8719"><span data-slate-object="text" data-key="8720"><span data-slate-leaf="true" data-offset-key="8720:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8721"><span data-slate-leaf="true" data-offset-key="8721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8722"><span data-slate-leaf="true" data-offset-key="8722:0" data-first-offset="true"><span data-slate-string="true"> (_, node) =&gt; !node.isEmpty</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8723"><span data-slate-object="text" data-key="8724"><span data-slate-leaf="true" data-offset-key="8724:0" data-first-offset="true"><span data-slate-string="true">      })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8725"><span data-slate-object="text" data-key="8726"><span data-slate-leaf="true" data-offset-key="8726:0" data-first-offset="true"><span data-slate-string="true">  }.getOrElse(</span></span></span><span data-slate-object="text" data-key="8727"><span data-slate-leaf="true" data-offset-key="8727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="8728"><span data-slate-leaf="true" data-offset-key="8728:0" data-first-offset="true"><span data-slate-string="true">.empty[Int, Node])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8729"><span data-slate-object="text" data-key="8730"><span data-slate-leaf="true" data-offset-key="8730:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8731"><span data-slate-object="text" data-key="8732"><span data-slate-leaf="true" data-offset-key="8732:0" data-first-offset="true"><span data-slate-string="true">这个 getPartitionReplicaEndpoints 方法接收主题分区和 ListenerName，以获取指定监听器类型下该主题分区所有副本的 Broker 节点对象，并按照 Broker ID 进行分组。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8733"><span data-slate-object="text" data-key="8734"><span data-slate-leaf="true" data-offset-key="8734:0" data-first-offset="true"><span data-slate-string="true">首先，代码使用局部变量获取当前的元数据缓存。这样做的好处在于，不需要使用锁技术，但是，就像我开头说过的，这里有一个可能的问题是，读到的数据可能是过期的数据。不过，好在 Kafka 能够自行处理过期元数据的问题。当客户端因为拿到过期元数据而向 Broker 发出错误的指令时，Broker 会显式地通知客户端错误原因。客户端接收到错误后，会尝试再次拉取最新的元数据。这个过程能够保证，客户端最终可以取得最新的元数据信息。总体而言，过期元数据的不良影响是存在的，但在实际场景中并不是太严重。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8735"><span data-slate-object="text" data-key="8736"><span data-slate-leaf="true" data-offset-key="8736:0" data-first-offset="true"><span data-slate-string="true">拿到主题分区数据之后，代码会获取副本 ID 列表，接着遍历该列表，依次获取每个副本所在的 Broker ID，再根据这个 Broker ID 去获取对应的 Broker 节点对象。最后，将这些节点对象封装到返回结果中并返回。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8737" id="sr-toc-6"><span data-slate-object="text" data-key="8738"><span data-slate-leaf="true" data-offset-key="8738:0" data-first-offset="true"><span data-slate-string="true">更新类方法</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8739"><span data-slate-object="text" data-key="8740"><span data-slate-leaf="true" data-offset-key="8740:0" data-first-offset="true"><span data-slate-string="true">下面，我们进入到今天的 “重头戏”：Broker 端元数据缓存的更新方法。说它是重头戏，有两个原因：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8741"><div data-slate-type="list-line" data-slate-object="block" data-key="8742"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="8743"><span data-slate-leaf="true" data-offset-key="8743:0" data-first-offset="true"><span data-slate-string="true">跟前两类方法相比，它的代码实现要复杂得多，因此，我们需要花更多的时间去学习；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="8744"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="8745"><span data-slate-leaf="true" data-offset-key="8745:0" data-first-offset="true"><span data-slate-string="true">元数据缓存只有被更新了，才能被读取。从某种程度上说，它是后续所有 getXXX 方法的前提条件。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8746"><span data-slate-object="text" data-key="8747"><span data-slate-leaf="true" data-offset-key="8747:0" data-first-offset="true"><span data-slate-string="true">源码中实现更新的方法只有一个：</span></span></span><span data-slate-object="text" data-key="8748"><span data-slate-leaf="true" data-offset-key="8748:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">updateMetadata 方法</span></span></span></span><span data-slate-object="text" data-key="8749"><span data-slate-leaf="true" data-offset-key="8749:0" data-first-offset="true"><span data-slate-string="true">。该方法的代码比较长，我先画一张流程图，帮助你理解它做了什么事情。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="8750"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/2a/03/2abcce0bb1e7e4d1ac3d8bbc41c3f803.jpg?wh=2536*4873"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8751"><span data-slate-object="text" data-key="8752"><span data-slate-leaf="true" data-offset-key="8752:0" data-first-offset="true"><span data-slate-string="true">updateMetadata 方法的主要逻辑，就是</span></span></span><span data-slate-object="text" data-key="8753"><span data-slate-leaf="true" data-offset-key="8753:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">读取 UpdateMetadataRequest 请求中的分区数据，然后更新本地元数据缓存</span></span></span></span><span data-slate-object="text" data-key="8754"><span data-slate-leaf="true" data-offset-key="8754:0" data-first-offset="true"><span data-slate-string="true">。接下来，我们详细地学习一下它的实现逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8755"><span data-slate-object="text" data-key="8756"><span data-slate-leaf="true" data-offset-key="8756:0" data-first-offset="true"><span data-slate-string="true">为了方便你掌握，我将该方法分成几个部分来讲，首先来看第一部分代码：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="8757"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8758"><span data-slate-object="text" data-key="8759"><span data-slate-leaf="true" data-offset-key="8759:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="8760"><span data-slate-leaf="true" data-offset-key="8760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">updateMetadata</span></span></span></span><span data-slate-object="text" data-key="8761"><span data-slate-leaf="true" data-offset-key="8761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(correlationId: Int, updateMetadataRequest: UpdateMetadataRequest)</span></span></span></span><span data-slate-object="text" data-key="8762"><span data-slate-leaf="true" data-offset-key="8762:0" data-first-offset="true"><span data-slate-string="true">: Seq[TopicPartition] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8763"><span data-slate-object="text" data-key="8764"><span data-slate-leaf="true" data-offset-key="8764:0" data-first-offset="true"><span data-slate-string="true">  inWriteLock(partitionMetadataLock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8765"><span data-slate-object="text" data-key="8766"><span data-slate-leaf="true" data-offset-key="8766:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8767"><span data-slate-leaf="true" data-offset-key="8767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存存活 Broker 对象。Key 是 Broker ID，Value 是 Broker 对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8768"><span data-slate-object="text" data-key="8769"><span data-slate-leaf="true" data-offset-key="8769:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8770"><span data-slate-leaf="true" data-offset-key="8770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8771"><span data-slate-leaf="true" data-offset-key="8771:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8772"><span data-slate-leaf="true" data-offset-key="8772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">aliveBrokers</span></span></span></span><span data-slate-object="text" data-key="8773"><span data-slate-leaf="true" data-offset-key="8773:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8774"><span data-slate-leaf="true" data-offset-key="8774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8775"><span data-slate-leaf="true" data-offset-key="8775:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8776"><span data-slate-leaf="true" data-offset-key="8776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8777"><span data-slate-leaf="true" data-offset-key="8777:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8778"><span data-slate-leaf="true" data-offset-key="8778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span><span data-slate-object="text" data-key="8779"><span data-slate-leaf="true" data-offset-key="8779:0" data-first-offset="true"><span data-slate-string="true">.LongMap[Broker](metadataSnapshot.aliveBrokers.size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8780"><span data-slate-object="text" data-key="8781"><span data-slate-leaf="true" data-offset-key="8781:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8782"><span data-slate-leaf="true" data-offset-key="8782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保存存活节点对象。Key 是 Broker ID，Value 是监听器 -&gt; 节点对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8783"><span data-slate-object="text" data-key="8784"><span data-slate-leaf="true" data-offset-key="8784:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8785"><span data-slate-leaf="true" data-offset-key="8785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8786"><span data-slate-leaf="true" data-offset-key="8786:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8787"><span data-slate-leaf="true" data-offset-key="8787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">aliveNodes</span></span></span></span><span data-slate-object="text" data-key="8788"><span data-slate-leaf="true" data-offset-key="8788:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8789"><span data-slate-leaf="true" data-offset-key="8789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8790"><span data-slate-leaf="true" data-offset-key="8790:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8791"><span data-slate-leaf="true" data-offset-key="8791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8792"><span data-slate-leaf="true" data-offset-key="8792:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8793"><span data-slate-leaf="true" data-offset-key="8793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span><span data-slate-object="text" data-key="8794"><span data-slate-leaf="true" data-offset-key="8794:0" data-first-offset="true"><span data-slate-string="true">.LongMap[collection.Map[ListenerName, Node]](metadataSnapshot.aliveNodes.size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8795"><span data-slate-object="text" data-key="8796"><span data-slate-leaf="true" data-offset-key="8796:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8797"><span data-slate-leaf="true" data-offset-key="8797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 UpdateMetadataRequest 中获取 Controller 所在的 Broker ID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8798"><span data-slate-object="text" data-key="8799"><span data-slate-leaf="true" data-offset-key="8799:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8800"><span data-slate-leaf="true" data-offset-key="8800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果当前没有 Controller，赋值为 None</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8801"><span data-slate-object="text" data-key="8802"><span data-slate-leaf="true" data-offset-key="8802:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8803"><span data-slate-leaf="true" data-offset-key="8803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8804"><span data-slate-leaf="true" data-offset-key="8804:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8805"><span data-slate-leaf="true" data-offset-key="8805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">controllerIdOpt</span></span></span></span><span data-slate-object="text" data-key="8806"><span data-slate-leaf="true" data-offset-key="8806:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8807"><span data-slate-leaf="true" data-offset-key="8807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8808"><span data-slate-leaf="true" data-offset-key="8808:0" data-first-offset="true"><span data-slate-string="true"> updateMetadataRequest.controllerId match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8809"><span data-slate-object="text" data-key="8810"><span data-slate-leaf="true" data-offset-key="8810:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8811"><span data-slate-leaf="true" data-offset-key="8811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8812"><span data-slate-leaf="true" data-offset-key="8812:0" data-first-offset="true"><span data-slate-string="true"> id </span></span></span><span data-slate-object="text" data-key="8813"><span data-slate-leaf="true" data-offset-key="8813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8814"><span data-slate-leaf="true" data-offset-key="8814:0" data-first-offset="true"><span data-slate-string="true"> id &lt; </span></span></span><span data-slate-object="text" data-key="8815"><span data-slate-leaf="true" data-offset-key="8815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8816"><span data-slate-leaf="true" data-offset-key="8816:0" data-first-offset="true"><span data-slate-string="true"> =&gt; None</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8817"><span data-slate-object="text" data-key="8818"><span data-slate-leaf="true" data-offset-key="8818:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8819"><span data-slate-leaf="true" data-offset-key="8819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8820"><span data-slate-leaf="true" data-offset-key="8820:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8821"><span data-slate-leaf="true" data-offset-key="8821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">id</span></span></span></span><span data-slate-object="text" data-key="8822"><span data-slate-leaf="true" data-offset-key="8822:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8823"><span data-slate-leaf="true" data-offset-key="8823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8824"><span data-slate-leaf="true" data-offset-key="8824:0" data-first-offset="true"><span data-slate-string="true">&gt; Some(id)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8825"><span data-slate-object="text" data-key="8826"><span data-slate-leaf="true" data-offset-key="8826:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8827"><span data-slate-object="text" data-key="8828"><span data-slate-leaf="true" data-offset-key="8828:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8829"><span data-slate-leaf="true" data-offset-key="8829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历 UpdateMetadataRequest 请求中的所有存活 Broker 对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8830"><span data-slate-object="text" data-key="8831"><span data-slate-leaf="true" data-offset-key="8831:0" data-first-offset="true"><span data-slate-string="true">    updateMetadataRequest.liveBrokers.forEach {broker =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8832"><span data-slate-object="text" data-key="8833"><span data-slate-leaf="true" data-offset-key="8833:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8834"><span data-slate-leaf="true" data-offset-key="8834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8835"><span data-slate-leaf="true" data-offset-key="8835:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8836"><span data-slate-leaf="true" data-offset-key="8836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nodes</span></span></span></span><span data-slate-object="text" data-key="8837"><span data-slate-leaf="true" data-offset-key="8837:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8838"><span data-slate-leaf="true" data-offset-key="8838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8839"><span data-slate-leaf="true" data-offset-key="8839:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8840"><span data-slate-leaf="true" data-offset-key="8840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8841"><span data-slate-leaf="true" data-offset-key="8841:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8842"><span data-slate-leaf="true" data-offset-key="8842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">java</span></span></span></span><span data-slate-object="text" data-key="8843"><span data-slate-leaf="true" data-offset-key="8843:0" data-first-offset="true"><span data-slate-string="true">.util.HashMap[ListenerName, Node]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8844"><span data-slate-object="text" data-key="8845"><span data-slate-leaf="true" data-offset-key="8845:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8846"><span data-slate-leaf="true" data-offset-key="8846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8847"><span data-slate-leaf="true" data-offset-key="8847:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8848"><span data-slate-leaf="true" data-offset-key="8848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endPoints</span></span></span></span><span data-slate-object="text" data-key="8849"><span data-slate-leaf="true" data-offset-key="8849:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8850"><span data-slate-leaf="true" data-offset-key="8850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8851"><span data-slate-leaf="true" data-offset-key="8851:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8852"><span data-slate-leaf="true" data-offset-key="8852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8853"><span data-slate-leaf="true" data-offset-key="8853:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8854"><span data-slate-leaf="true" data-offset-key="8854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">mutable</span></span></span></span><span data-slate-object="text" data-key="8855"><span data-slate-leaf="true" data-offset-key="8855:0" data-first-offset="true"><span data-slate-string="true">.ArrayBuffer[EndPoint]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8856"><span data-slate-object="text" data-key="8857"><span data-slate-leaf="true" data-offset-key="8857:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8858"><span data-slate-leaf="true" data-offset-key="8858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历它的所有 EndPoint 类型，也就是为 Broker 配置的监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8859"><span data-slate-object="text" data-key="8860"><span data-slate-leaf="true" data-offset-key="8860:0" data-first-offset="true"><span data-slate-string="true">      broker.endpoints.forEach {ep =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8861"><span data-slate-object="text" data-key="8862"><span data-slate-leaf="true" data-offset-key="8862:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8863"><span data-slate-leaf="true" data-offset-key="8863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="8864"><span data-slate-leaf="true" data-offset-key="8864:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8865"><span data-slate-leaf="true" data-offset-key="8865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">listenerName</span></span></span></span><span data-slate-object="text" data-key="8866"><span data-slate-leaf="true" data-offset-key="8866:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8867"><span data-slate-leaf="true" data-offset-key="8867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="8868"><span data-slate-leaf="true" data-offset-key="8868:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8869"><span data-slate-leaf="true" data-offset-key="8869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8870"><span data-slate-leaf="true" data-offset-key="8870:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8871"><span data-slate-leaf="true" data-offset-key="8871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ListenerName</span></span></span></span><span data-slate-object="text" data-key="8872"><span data-slate-leaf="true" data-offset-key="8872:0" data-first-offset="true"><span data-slate-string="true">(ep.listener)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8873"><span data-slate-object="text" data-key="8874"><span data-slate-leaf="true" data-offset-key="8874:0" data-first-offset="true"><span data-slate-string="true">        endPoints += </span></span></span><span data-slate-object="text" data-key="8875"><span data-slate-leaf="true" data-offset-key="8875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8876"><span data-slate-leaf="true" data-offset-key="8876:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8877"><span data-slate-leaf="true" data-offset-key="8877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">EndPoint</span></span></span></span><span data-slate-object="text" data-key="8878"><span data-slate-leaf="true" data-offset-key="8878:0" data-first-offset="true"><span data-slate-string="true">(ep.host, ep.port, listenerName, SecurityProtocol.forId(ep.securityProtocol))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8879"><span data-slate-object="text" data-key="8880"><span data-slate-leaf="true" data-offset-key="8880:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8881"><span data-slate-leaf="true" data-offset-key="8881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 &lt;监听器，Broker 节点对象&gt; 对保存起来</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8882"><span data-slate-object="text" data-key="8883"><span data-slate-leaf="true" data-offset-key="8883:0" data-first-offset="true"><span data-slate-string="true">        nodes.put(listenerName, </span></span></span><span data-slate-object="text" data-key="8884"><span data-slate-leaf="true" data-offset-key="8884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8885"><span data-slate-leaf="true" data-offset-key="8885:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8886"><span data-slate-leaf="true" data-offset-key="8886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Node</span></span></span></span><span data-slate-object="text" data-key="8887"><span data-slate-leaf="true" data-offset-key="8887:0" data-first-offset="true"><span data-slate-string="true">(broker.id, ep.host, ep.port))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8888"><span data-slate-object="text" data-key="8889"><span data-slate-leaf="true" data-offset-key="8889:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8890"><span data-slate-object="text" data-key="8891"><span data-slate-leaf="true" data-offset-key="8891:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8892"><span data-slate-leaf="true" data-offset-key="8892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 Broker 加入到存活 Broker 对象集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8893"><span data-slate-object="text" data-key="8894"><span data-slate-leaf="true" data-offset-key="8894:0" data-first-offset="true"><span data-slate-string="true">      aliveBrokers(broker.id) = Broker(broker.id, endPoints, Option(broker.rack))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8895"><span data-slate-object="text" data-key="8896"><span data-slate-leaf="true" data-offset-key="8896:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8897"><span data-slate-leaf="true" data-offset-key="8897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 Broker 节点加入到存活节点对象集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8898"><span data-slate-object="text" data-key="8899"><span data-slate-leaf="true" data-offset-key="8899:0" data-first-offset="true"><span data-slate-string="true">      aliveNodes(broker.id) = nodes.asScala</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8900"><span data-slate-object="text" data-key="8901"><span data-slate-leaf="true" data-offset-key="8901:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8902"><span data-slate-object="text" data-key="8903"><span data-slate-leaf="true" data-offset-key="8903:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8904"><span data-slate-object="text" data-key="8905"><span data-slate-leaf="true" data-offset-key="8905:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8906"><span data-slate-object="text" data-key="8907"><span data-slate-leaf="true" data-offset-key="8907:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8908"><span data-slate-object="text" data-key="8909"><span data-slate-leaf="true" data-offset-key="8909:0" data-first-offset="true"><span data-slate-string="true">这部分代码的主要作用是给后面的操作准备数据，即 aliveBrokers 和 aliveNodes 两个字段中保存的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8910"><span data-slate-object="text" data-key="8911"><span data-slate-leaf="true" data-offset-key="8911:0" data-first-offset="true"><span data-slate-string="true">因此，首先，代码会创建这两个字段，分别保存存活 Broker 对象和存活节点对象。aliveBrokers 的 Key 类型是 Broker ID，而 Value 类型是 Broker 对象；aliveNodes 的 Key 类型也是 Broker ID，Value 类型是 &lt;监听器，节点对象&gt; 对。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8912"><span data-slate-object="text" data-key="8913"><span data-slate-leaf="true" data-offset-key="8913:0" data-first-offset="true"><span data-slate-string="true">然后，该方法从 UpdateMetadataRequest 中获取 Controller 所在的 Broker ID，并赋值给 controllerIdOpt 字段。如果集群没有 Controller，则赋值该字段为 None。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8914"><span data-slate-object="text" data-key="8915"><span data-slate-leaf="true" data-offset-key="8915:0" data-first-offset="true"><span data-slate-string="true">接着，代码会遍历 UpdateMetadataRequest 请求中的所有存活 Broker 对象。取出它配置的所有 EndPoint 类型，也就是 Broker 配置的所有监听器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8916"><span data-slate-object="text" data-key="8917"><span data-slate-leaf="true" data-offset-key="8917:0" data-first-offset="true"><span data-slate-string="true">最后，代码会遍历它配置的监听器，并将 &lt;监听器，Broker 节点对象&gt; 对保存起来，再将 Broker 加入到存活 Broker 对象集合和存活节点对象集合。至此，第一部分代码逻辑完成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8918"><span data-slate-object="text" data-key="8919"><span data-slate-leaf="true" data-offset-key="8919:0" data-first-offset="true"><span data-slate-string="true">再来看第二部分的代码。这一部分的主要工作是</span></span></span><span data-slate-object="text" data-key="8920"><span data-slate-leaf="true" data-offset-key="8920:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">确保集群 Broker 配置了相同的监听器，同时初始化已删除分区数组对象，等待下一部分代码逻辑对它进行操作</span></span></span></span><span data-slate-object="text" data-key="8921"><span data-slate-leaf="true" data-offset-key="8921:0" data-first-offset="true"><span data-slate-string="true">。代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="8922"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8923"><span data-slate-object="text" data-key="8924"><span data-slate-leaf="true" data-offset-key="8924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用上一部分中的存活 Broker 节点对象，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8925"><span data-slate-object="text" data-key="8926"><span data-slate-leaf="true" data-offset-key="8926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取当前 Broker 所有的 &lt;监听器，节点&gt; 对</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8927"><span data-slate-object="text" data-key="8928"><span data-slate-leaf="true" data-offset-key="8928:0" data-first-offset="true"><span data-slate-string="true">aliveNodes.</span></span></span><span data-slate-object="text" data-key="8929"><span data-slate-leaf="true" data-offset-key="8929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="8930"><span data-slate-leaf="true" data-offset-key="8930:0" data-first-offset="true"><span data-slate-string="true">(brokerId).foreach { listenerMap =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8931"><span data-slate-object="text" data-key="8932"><span data-slate-leaf="true" data-offset-key="8932:0" data-first-offset="true"><span data-slate-string="true">  val listeners = listenerMap.keySet</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8933"><span data-slate-object="text" data-key="8934"><span data-slate-leaf="true" data-offset-key="8934:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8935"><span data-slate-leaf="true" data-offset-key="8935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果发现当前 Broker 配置的监听器与其他 Broker 有不同之处，记录错误日志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8936"><span data-slate-object="text" data-key="8937"><span data-slate-leaf="true" data-offset-key="8937:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8938"><span data-slate-leaf="true" data-offset-key="8938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8939"><span data-slate-leaf="true" data-offset-key="8939:0" data-first-offset="true"><span data-slate-string="true"> (!aliveNodes.values.forall(_.keySet == listeners))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8940"><span data-slate-object="text" data-key="8941"><span data-slate-leaf="true" data-offset-key="8941:0" data-first-offset="true"><span data-slate-string="true">    error(s</span></span></span><span data-slate-object="text" data-key="8942"><span data-slate-leaf="true" data-offset-key="8942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Listeners are not identical across brokers: </span></span></span></span><span data-slate-object="text" data-key="8943"><span data-slate-leaf="true" data-offset-key="8943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$aliveNodes</span></span></span></span></span><span data-slate-object="text" data-key="8944"><span data-slate-leaf="true" data-offset-key="8944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="8945"><span data-slate-leaf="true" data-offset-key="8945:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8946"><span data-slate-object="text" data-key="8947"><span data-slate-leaf="true" data-offset-key="8947:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8948"><span data-slate-object="text" data-key="8949"><span data-slate-leaf="true" data-offset-key="8949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构造已删除分区数组，将其作为方法返回结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8950"><span data-slate-object="text" data-key="8951"><span data-slate-leaf="true" data-offset-key="8951:0" data-first-offset="true"><span data-slate-string="true">val deletedPartitions = </span></span></span><span data-slate-object="text" data-key="8952"><span data-slate-leaf="true" data-offset-key="8952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8953"><span data-slate-leaf="true" data-offset-key="8953:0" data-first-offset="true"><span data-slate-string="true"> mutable.ArrayBuffer[TopicPartition]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8954"><span data-slate-object="text" data-key="8955"><span data-slate-leaf="true" data-offset-key="8955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// UpdateMetadataRequest 请求没有携带任何分区信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8956"><span data-slate-object="text" data-key="8957"><span data-slate-leaf="true" data-offset-key="8957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8958"><span data-slate-leaf="true" data-offset-key="8958:0" data-first-offset="true"><span data-slate-string="true"> (!updateMetadataRequest.partitionStates.iterator.hasNext) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8959"><span data-slate-object="text" data-key="8960"><span data-slate-leaf="true" data-offset-key="8960:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8961"><span data-slate-leaf="true" data-offset-key="8961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构造新的 MetadataSnapshot 对象，使用之前的分区信息和新的 Broker 列表信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8962"><span data-slate-object="text" data-key="8963"><span data-slate-leaf="true" data-offset-key="8963:0" data-first-offset="true"><span data-slate-string="true">  metadataSnapshot = MetadataSnapshot(metadataSnapshot.partitionStates, controllerIdOpt, aliveBrokers, aliveNodes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8964"><span data-slate-object="text" data-key="8965"><span data-slate-leaf="true" data-offset-key="8965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则，进入到方法最后一部分</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8966"><span data-slate-object="text" data-key="8967"><span data-slate-leaf="true" data-offset-key="8967:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="8968"><span data-slate-leaf="true" data-offset-key="8968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="8969"><span data-slate-leaf="true" data-offset-key="8969:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8970"><span data-slate-object="text" data-key="8971"><span data-slate-leaf="true" data-offset-key="8971:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8972"><span data-slate-object="text" data-key="8973"><span data-slate-leaf="true" data-offset-key="8973:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8974"><span data-slate-object="text" data-key="8975"><span data-slate-leaf="true" data-offset-key="8975:0" data-first-offset="true"><span data-slate-string="true">这部分代码首先使用上一部分中的存活 Broker 节点对象，获取当前 Broker 所有的 &lt;监听器，节点&gt; 对。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8976"><span data-slate-object="text" data-key="8977"><span data-slate-leaf="true" data-offset-key="8977:0" data-first-offset="true"><span data-slate-string="true">之后，拿到为当前 Broker 配置的所有监听器。如果发现配置的监听器与其他 Broker 有不同之处，则记录一条错误日志。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8978"><span data-slate-object="text" data-key="8979"><span data-slate-leaf="true" data-offset-key="8979:0" data-first-offset="true"><span data-slate-string="true">接下来，代码会构造一个已删除分区数组，将其作为方法返回结果。然后判断 UpdateMetadataRequest 请求是否携带了任何分区信息，如果没有，则构造一个新的 MetadataSnapshot 对象，使用之前的分区信息和新的 Broker 列表信息；如果有，代码进入到该方法的最后一个部分。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8980"><span data-slate-object="text" data-key="8981"><span data-slate-leaf="true" data-offset-key="8981:0" data-first-offset="true"><span data-slate-string="true">最后一部分全部位于上面代码中的 else 分支上。这部分的主要工作是</span></span></span><span data-slate-object="text" data-key="8982"><span data-slate-leaf="true" data-offset-key="8982:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">提取 UpdateMetadataRequest 请求中的数据，然后填充元数据缓存</span></span></span></span><span data-slate-object="text" data-key="8983"><span data-slate-leaf="true" data-offset-key="8983:0" data-first-offset="true"><span data-slate-string="true">。代码如下：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="8984"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8985"><span data-slate-object="text" data-key="8986"><span data-slate-leaf="true" data-offset-key="8986:0" data-first-offset="true"><span data-slate-string="true">val partitionStates = </span></span></span><span data-slate-object="text" data-key="8987"><span data-slate-leaf="true" data-offset-key="8987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="8988"><span data-slate-leaf="true" data-offset-key="8988:0" data-first-offset="true"><span data-slate-string="true"> mutable.AnyRefMap[</span></span></span><span data-slate-object="text" data-key="8989"><span data-slate-leaf="true" data-offset-key="8989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="8990"><span data-slate-leaf="true" data-offset-key="8990:0" data-first-offset="true"><span data-slate-string="true">, mutable.LongMap[UpdateMetadataPartitionState]](metadataSnapshot.partitionStates.size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8991"><span data-slate-object="text" data-key="8992"><span data-slate-leaf="true" data-offset-key="8992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 备份现有元数据缓存中的分区数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8993"><span data-slate-object="text" data-key="8994"><span data-slate-leaf="true" data-offset-key="8994:0" data-first-offset="true"><span data-slate-string="true">metadataSnapshot.partitionStates.foreach { </span></span></span><span data-slate-object="text" data-key="8995"><span data-slate-leaf="true" data-offset-key="8995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8996"><span data-slate-leaf="true" data-offset-key="8996:0" data-first-offset="true"><span data-slate-string="true"> (topic, oldPartitionStates) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8997"><span data-slate-object="text" data-key="8998"><span data-slate-leaf="true" data-offset-key="8998:0" data-first-offset="true"><span data-slate-string="true">  val copy = </span></span></span><span data-slate-object="text" data-key="8999"><span data-slate-leaf="true" data-offset-key="8999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="9000"><span data-slate-leaf="true" data-offset-key="9000:0" data-first-offset="true"><span data-slate-string="true"> mutable.LongMap[UpdateMetadataPartitionState](oldPartitionStates.size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9001"><span data-slate-object="text" data-key="9002"><span data-slate-leaf="true" data-offset-key="9002:0" data-first-offset="true"><span data-slate-string="true">  copy ++= oldPartitionStates</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9003"><span data-slate-object="text" data-key="9004"><span data-slate-leaf="true" data-offset-key="9004:0" data-first-offset="true"><span data-slate-string="true">  partitionStates(topic) = copy</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9005"><span data-slate-object="text" data-key="9006"><span data-slate-leaf="true" data-offset-key="9006:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9007"><span data-slate-object="text" data-key="9008"><span data-slate-leaf="true" data-offset-key="9008:0" data-first-offset="true"><span data-slate-string="true">val traceEnabled = stateChangeLogger.isTraceEnabled</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9009"><span data-slate-object="text" data-key="9010"><span data-slate-leaf="true" data-offset-key="9010:0" data-first-offset="true"><span data-slate-string="true">val controllerId = updateMetadataRequest.controllerId</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9011"><span data-slate-object="text" data-key="9012"><span data-slate-leaf="true" data-offset-key="9012:0" data-first-offset="true"><span data-slate-string="true">val controllerEpoch = updateMetadataRequest.controllerEpoch</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9013"><span data-slate-object="text" data-key="9014"><span data-slate-leaf="true" data-offset-key="9014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取 UpdateMetadataRequest 请求中携带的所有分区数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9015"><span data-slate-object="text" data-key="9016"><span data-slate-leaf="true" data-offset-key="9016:0" data-first-offset="true"><span data-slate-string="true">val newStates = updateMetadataRequest.partitionStates.asScala</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9017"><span data-slate-object="text" data-key="9018"><span data-slate-leaf="true" data-offset-key="9018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历分区数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9019"><span data-slate-object="text" data-key="9020"><span data-slate-leaf="true" data-offset-key="9020:0" data-first-offset="true"><span data-slate-string="true">newStates.foreach {state =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9021"><span data-slate-object="text" data-key="9022"><span data-slate-leaf="true" data-offset-key="9022:0" data-first-offset="true"><span data-slate-string="true">  val tp = </span></span></span><span data-slate-object="text" data-key="9023"><span data-slate-leaf="true" data-offset-key="9023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="9024"><span data-slate-leaf="true" data-offset-key="9024:0" data-first-offset="true"><span data-slate-string="true"> TopicPartition(state.topicName, state.partitionIndex)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9025"><span data-slate-object="text" data-key="9026"><span data-slate-leaf="true" data-offset-key="9026:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9027"><span data-slate-leaf="true" data-offset-key="9027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果分区处于被删除过程中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9028"><span data-slate-object="text" data-key="9029"><span data-slate-leaf="true" data-offset-key="9029:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9030"><span data-slate-leaf="true" data-offset-key="9030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9031"><span data-slate-leaf="true" data-offset-key="9031:0" data-first-offset="true"><span data-slate-string="true"> (state.leader == LeaderAndIsr.LeaderDuringDelete) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9032"><span data-slate-object="text" data-key="9033"><span data-slate-leaf="true" data-offset-key="9033:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9034"><span data-slate-leaf="true" data-offset-key="9034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将分区从元数据缓存中移除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9035"><span data-slate-object="text" data-key="9036"><span data-slate-leaf="true" data-offset-key="9036:0" data-first-offset="true"><span data-slate-string="true">    removePartitionInfo(partitionStates, tp.topic, tp.partition)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9037"><span data-slate-object="text" data-key="9038"><span data-slate-leaf="true" data-offset-key="9038:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9039"><span data-slate-leaf="true" data-offset-key="9039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9040"><span data-slate-leaf="true" data-offset-key="9040:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9041"><span data-slate-object="text" data-key="9042"><span data-slate-leaf="true" data-offset-key="9042:0" data-first-offset="true"><span data-slate-string="true">      stateChangeLogger.trace(s</span></span></span><span data-slate-object="text" data-key="9043"><span data-slate-leaf="true" data-offset-key="9043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Deleted partition </span></span></span></span><span data-slate-object="text" data-key="9044"><span data-slate-leaf="true" data-offset-key="9044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$tp</span></span></span></span></span><span data-slate-object="text" data-key="9045"><span data-slate-leaf="true" data-offset-key="9045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> from metadata cache in response to UpdateMetadata "</span></span></span></span><span data-slate-object="text" data-key="9046"><span data-slate-leaf="true" data-offset-key="9046:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9047"><span data-slate-object="text" data-key="9048"><span data-slate-leaf="true" data-offset-key="9048:0" data-first-offset="true"><span data-slate-string="true">        s</span></span></span><span data-slate-object="text" data-key="9049"><span data-slate-leaf="true" data-offset-key="9049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"request sent by controller </span></span></span></span><span data-slate-object="text" data-key="9050"><span data-slate-leaf="true" data-offset-key="9050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerId</span></span></span></span></span><span data-slate-object="text" data-key="9051"><span data-slate-leaf="true" data-offset-key="9051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> epoch </span></span></span></span><span data-slate-object="text" data-key="9052"><span data-slate-leaf="true" data-offset-key="9052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerEpoch</span></span></span></span></span><span data-slate-object="text" data-key="9053"><span data-slate-leaf="true" data-offset-key="9053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with correlation id </span></span></span></span><span data-slate-object="text" data-key="9054"><span data-slate-leaf="true" data-offset-key="9054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$correlationId</span></span></span></span></span><span data-slate-object="text" data-key="9055"><span data-slate-leaf="true" data-offset-key="9055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="9056"><span data-slate-leaf="true" data-offset-key="9056:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9057"><span data-slate-object="text" data-key="9058"><span data-slate-leaf="true" data-offset-key="9058:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9059"><span data-slate-leaf="true" data-offset-key="9059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将分区加入到返回结果数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9060"><span data-slate-object="text" data-key="9061"><span data-slate-leaf="true" data-offset-key="9061:0" data-first-offset="true"><span data-slate-string="true">    deletedPartitions += tp</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9062"><span data-slate-object="text" data-key="9063"><span data-slate-leaf="true" data-offset-key="9063:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="9064"><span data-slate-leaf="true" data-offset-key="9064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="9065"><span data-slate-leaf="true" data-offset-key="9065:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9066"><span data-slate-object="text" data-key="9067"><span data-slate-leaf="true" data-offset-key="9067:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9068"><span data-slate-leaf="true" data-offset-key="9068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将分区加入到元数据缓存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9069"><span data-slate-object="text" data-key="9070"><span data-slate-leaf="true" data-offset-key="9070:0" data-first-offset="true"><span data-slate-string="true">    addOrUpdatePartitionInfo(partitionStates, tp.topic, tp.partition, state)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9071"><span data-slate-object="text" data-key="9072"><span data-slate-leaf="true" data-offset-key="9072:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9073"><span data-slate-leaf="true" data-offset-key="9073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9074"><span data-slate-leaf="true" data-offset-key="9074:0" data-first-offset="true"><span data-slate-string="true"> (traceEnabled)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9075"><span data-slate-object="text" data-key="9076"><span data-slate-leaf="true" data-offset-key="9076:0" data-first-offset="true"><span data-slate-string="true">      stateChangeLogger.trace(s</span></span></span><span data-slate-object="text" data-key="9077"><span data-slate-leaf="true" data-offset-key="9077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Cached leader info </span></span></span></span><span data-slate-object="text" data-key="9078"><span data-slate-leaf="true" data-offset-key="9078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$state</span></span></span></span></span><span data-slate-object="text" data-key="9079"><span data-slate-leaf="true" data-offset-key="9079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for partition </span></span></span></span><span data-slate-object="text" data-key="9080"><span data-slate-leaf="true" data-offset-key="9080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$tp</span></span></span></span></span><span data-slate-object="text" data-key="9081"><span data-slate-leaf="true" data-offset-key="9081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> in response to "</span></span></span></span><span data-slate-object="text" data-key="9082"><span data-slate-leaf="true" data-offset-key="9082:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9083"><span data-slate-object="text" data-key="9084"><span data-slate-leaf="true" data-offset-key="9084:0" data-first-offset="true"><span data-slate-string="true">        s</span></span></span><span data-slate-object="text" data-key="9085"><span data-slate-leaf="true" data-offset-key="9085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"UpdateMetadata request sent by controller </span></span></span></span><span data-slate-object="text" data-key="9086"><span data-slate-leaf="true" data-offset-key="9086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerId</span></span></span></span></span><span data-slate-object="text" data-key="9087"><span data-slate-leaf="true" data-offset-key="9087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> epoch </span></span></span></span><span data-slate-object="text" data-key="9088"><span data-slate-leaf="true" data-offset-key="9088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerEpoch</span></span></span></span></span><span data-slate-object="text" data-key="9089"><span data-slate-leaf="true" data-offset-key="9089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with correlation id </span></span></span></span><span data-slate-object="text" data-key="9090"><span data-slate-leaf="true" data-offset-key="9090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$correlationId</span></span></span></span></span><span data-slate-object="text" data-key="9091"><span data-slate-leaf="true" data-offset-key="9091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="9092"><span data-slate-leaf="true" data-offset-key="9092:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9093"><span data-slate-object="text" data-key="9094"><span data-slate-leaf="true" data-offset-key="9094:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9095"><span data-slate-object="text" data-key="9096"><span data-slate-leaf="true" data-offset-key="9096:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9097"><span data-slate-object="text" data-key="9098"><span data-slate-leaf="true" data-offset-key="9098:0" data-first-offset="true"><span data-slate-string="true">val cachedPartitionsCount = newStates.size - deletedPartitions.size</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9099"><span data-slate-object="text" data-key="9100"><span data-slate-leaf="true" data-offset-key="9100:0" data-first-offset="true"><span data-slate-string="true">stateChangeLogger.info(s</span></span></span><span data-slate-object="text" data-key="9101"><span data-slate-leaf="true" data-offset-key="9101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Add </span></span></span></span><span data-slate-object="text" data-key="9102"><span data-slate-leaf="true" data-offset-key="9102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$cachedPartitionsCount</span></span></span></span></span><span data-slate-object="text" data-key="9103"><span data-slate-leaf="true" data-offset-key="9103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> partitions and deleted </span></span></span></span><span data-slate-object="text" data-key="9104"><span data-slate-leaf="true" data-offset-key="9104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${deletedPartitions.size}</span></span></span></span></span><span data-slate-object="text" data-key="9105"><span data-slate-leaf="true" data-offset-key="9105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> partitions from metadata cache "</span></span></span></span><span data-slate-object="text" data-key="9106"><span data-slate-leaf="true" data-offset-key="9106:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9107"><span data-slate-object="text" data-key="9108"><span data-slate-leaf="true" data-offset-key="9108:0" data-first-offset="true"><span data-slate-string="true">  s</span></span></span><span data-slate-object="text" data-key="9109"><span data-slate-leaf="true" data-offset-key="9109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"in response to UpdateMetadata request sent by controller </span></span></span></span><span data-slate-object="text" data-key="9110"><span data-slate-leaf="true" data-offset-key="9110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerId</span></span></span></span></span><span data-slate-object="text" data-key="9111"><span data-slate-leaf="true" data-offset-key="9111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> epoch </span></span></span></span><span data-slate-object="text" data-key="9112"><span data-slate-leaf="true" data-offset-key="9112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$controllerEpoch</span></span></span></span></span><span data-slate-object="text" data-key="9113"><span data-slate-leaf="true" data-offset-key="9113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> with correlation id </span></span></span></span><span data-slate-object="text" data-key="9114"><span data-slate-leaf="true" data-offset-key="9114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$correlationId</span></span></span></span></span><span data-slate-object="text" data-key="9115"><span data-slate-leaf="true" data-offset-key="9115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="9116"><span data-slate-leaf="true" data-offset-key="9116:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9117"><span data-slate-object="text" data-key="9118"><span data-slate-leaf="true" data-offset-key="9118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用更新过的分区元数据，和第一部分计算的存活 Broker 列表及节点列表，构建最新的元数据缓存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9119"><span data-slate-object="text" data-key="9120"><span data-slate-leaf="true" data-offset-key="9120:0" data-first-offset="true"><span data-slate-string="true">metadataSnapshot = </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9121"><span data-slate-object="text" data-key="9122"><span data-slate-leaf="true" data-offset-key="9122:0" data-first-offset="true"><span data-slate-string="true">  MetadataSnapshot(partitionStates, controllerIdOpt, aliveBrokers, aliveNodes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9123"><span data-slate-object="text" data-key="9124"><span data-slate-leaf="true" data-offset-key="9124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回已删除分区列表数组</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9125"><span data-slate-object="text" data-key="9126"><span data-slate-leaf="true" data-offset-key="9126:0" data-first-offset="true"><span data-slate-string="true">deletedPartitions</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9127"><span data-slate-object="text" data-key="9128"><span data-slate-leaf="true" data-offset-key="9128:0" data-first-offset="true"><span data-slate-string="true">首先，该方法会备份现有元数据缓存中的分区数据到 partitionStates 的局部变量中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9129"><span data-slate-object="text" data-key="9130"><span data-slate-leaf="true" data-offset-key="9130:0" data-first-offset="true"><span data-slate-string="true">之后，获取 UpdateMetadataRequest 请求中携带的所有分区数据，并遍历每个分区数据。如果发现分区处于被删除的过程中，就将分区从元数据缓存中移除，并把分区加入到已删除分区数组中。否则的话，代码就将分区加入到元数据缓存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9131"><span data-slate-object="text" data-key="9132"><span data-slate-leaf="true" data-offset-key="9132:0" data-first-offset="true"><span data-slate-string="true">最后，方法使用更新过的分区元数据，和第一部分计算的存活 Broker 列表及节点列表，构建最新的元数据缓存，然后返回已删除分区列表数组。至此，updateMetadata 方法结束。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9133" id="sr-toc-7"><span data-slate-object="text" data-key="9134"><span data-slate-leaf="true" data-offset-key="9134:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9135"><span data-slate-object="text" data-key="9136"><span data-slate-leaf="true" data-offset-key="9136:0" data-first-offset="true"><span data-slate-string="true">今天，我们学习了 Broker 端的 MetadataCache 类，即所谓的元数据缓存类。该类保存了当前集群上的主题分区详细数据和 Broker 数据。每台 Broker 都维护了一个 MetadataCache 实例。Controller 通过给 Broker 发送 UpdateMetadataRequest 请求的方式，来异步更新这部分缓存数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9137"><span data-slate-object="text" data-key="9138"><span data-slate-leaf="true" data-offset-key="9138:0" data-first-offset="true"><span data-slate-string="true">我们来回顾下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9139"><div data-slate-type="list-line" data-slate-object="block" data-key="9140"><span data-slate-object="text" data-key="9141"><span data-slate-leaf="true" data-offset-key="9141:0" data-first-offset="true"><span data-slate-string="true">MetadataCache 类：Broker 元数据缓存类，保存了分区详细数据和 Broker 节点数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9142"><span data-slate-object="text" data-key="9143"><span data-slate-leaf="true" data-offset-key="9143:0" data-first-offset="true"><span data-slate-string="true">四大调用方：分别是 ReplicaManager、KafkaApis、TransactionCoordinator 和 AdminManager。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9144"><span data-slate-object="text" data-key="9145"><span data-slate-leaf="true" data-offset-key="9145:0" data-first-offset="true"><span data-slate-string="true">updateMetadata 方法：Controller 给 Broker 发送 UpdateMetadataRequest 请求时，触发更新。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="9146"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e9/81/e95db24997c6cb615150ccc269aeb781.jpg?wh=2250*2112"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9147"><span data-slate-object="text" data-key="9148"><span data-slate-leaf="true" data-offset-key="9148:0" data-first-offset="true"><span data-slate-string="true">最后，我想和你讨论一个话题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9149"><span data-slate-object="text" data-key="9150"><span data-slate-leaf="true" data-offset-key="9150:0" data-first-offset="true"><span data-slate-string="true">有人认为，Kafka Broker 是无状态的。学完了今天的内容，现在你应该知道了，Broker 并非是无状态的节点，它需要从 Controller 端异步更新保存集群的元数据信息。由于 Kafka 采用的是 Leader/Follower 模式，跟多 Leader 架构和无 Leader 架构相比，这种分布式架构的一致性是最容易保证的，因此，Broker 间元数据的最终一致性是有保证的。不过，就像我前面说过的，你需要处理 Follower 滞后或数据过期的问题。需要注意的是，这里的 Leader 其实是指 Controller，而 Follower 是指普通的 Broker 节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9151"><span data-slate-object="text" data-key="9152"><span data-slate-leaf="true" data-offset-key="9152:0" data-first-offset="true"><span data-slate-string="true">总之，这一路学到现在，不知道你有没有这样的感受，很多分布式架构设计的问题与方案是相通的。比如，在应对数据备份这个问题上，元数据缓存和 Kafka 副本其实都是相同的设计思路，即使用单 Leader 的架构，令 Leader 对外提供服务，Follower 只是被动地同步 Leader 上的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9153"><span data-slate-object="text" data-key="9154"><span data-slate-leaf="true" data-offset-key="9154:0" data-first-offset="true"><span data-slate-string="true">每次学到新的内容之后，希望你不要把它们当作单一的知识看待，要善于进行思考和总结，做到融会贯通。源码学习固然重要，但能让学习源码引领我们升级架构思想，其实是更难得的收获！</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9155" id="sr-toc-8"><span data-slate-object="text" data-key="9156"><span data-slate-leaf="true" data-offset-key="9156:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9157"><span data-slate-object="text" data-key="9158"><span data-slate-leaf="true" data-offset-key="9158:0" data-first-offset="true"><span data-slate-string="true">前面说到，Controller 发送 UpdateMetadataRequest 请求给 Broker 时，会更新 MetadataCache，你能在源码中找到更新元数据缓存的完整调用路径吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9159"><span data-slate-object="text" data-key="9160"><span data-slate-leaf="true" data-offset-key="9160:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区写下你的思考和答案，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-9">精选留言 (4)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，我们重点学习了副本管理器是管理副本的。课后我请你去研究下 maybePropagateIsrChanges 源码中 isrChangeSet 字段在哪里被更新的。实际上，该字段被更新的时机有两个：ISR 扩容和 ISR 收缩时。

ReplicaManager 启动时会创建一个异步线程 isr-expiration，定期去查看是否需要为集群中所有 online 分区执行 ISR 收缩。一旦成功执行了收缩，那么代码就会调用 ReplicaManager.recordIsrChange 方法将相应分区加入到 isrChangeSet 中。

Follower 副本从 Leader 副本拉取消息后会尝试将自己加入到 ISR 中，此时可能执行 ISR 扩容操作。代码同样会调用 ReplicaManager.recordIsrChange 方法将相应分区加入到 isrChangeSet 中。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-06-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI34ZlT6HSOtJBeTvTvfNLfYECDdJXnHCMj2BHdrRaqRLnZiafnxmKQ2aXoQkW1RLQOyt0tlyzEWIA/132"></div></div><div><div><div><span>ahu0605</span></div></div><div>您好，胡老师，在生产环境，应用跑了一段时间，我的 producer 经常抛出 "topic xxx not present in metadata after 60000ms", 我排查了 broker 日志并没有重选举，我怀疑是 producer 网络过于繁忙，导致 networkclient poll 超时，也可能是这篇文章描述的 broker metadata 异步请求所导致，这个问题如何排查呢？</div><div><div>2022-05-04</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132"></div></div><div><div><div><span>RonnieXie</span></div></div><div>老师，我这边有个疑问，如果更新数据过程，Controller 宕机，一部分 broker 更新成功，一部分 broker 更新失败，kafka 是如何保证数据一致性？</div><div><p>作者回复：更新失败的 broker 会再次请求元数据的</p></div><div><div>2020-08-23</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>Controller 要更新 metadataCache 缓存，肯定通过远程调用事件，也就是之前讲解 controller 中 controllerChannelManager 发送请求，严格来说就是 ControllerBrokerRequestBatch 定义了 updateMetadataRequestBrokerSet 和 updateMetadataRequestPartitionInfoMap 两个集合，在 controller 中通过分区状态机和副本状态机注册 ControllerBrokerRequestBatch 类，通过 controllerChannelManager.sendRequest 更新 metadatacache 请求。有些乱，请作者原谅～</div><div><p>作者回复：嗯，没问题的，哈哈哈：）</p></div><div><div>2020-06-26</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".p"><outline class="toc-level-h1" data-reactid=".p.0" style="width: 175px;"><active data-reactid=".p.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".p.0.1"><span data-reactid=".p.0.1.0">26 | MetadataCache：Broker 是怎么异步更新元数据缓存的？</span></a></outline><outline class="toc-level-h2" data-reactid=".p.1" style="width: 165px;"><active data-reactid=".p.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".p.1.1"><span data-reactid=".p.1.1.0">MetadataCache 类</span></a></outline><outline class="toc-level-h2" data-reactid=".p.2" style="width: 165px;"><active data-reactid=".p.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".p.2.1"><span data-reactid=".p.2.1.0">类定义及字段</span></a></outline><outline class="toc-level-h2" data-reactid=".p.3" style="width: 165px;"><active data-reactid=".p.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".p.3.1"><span data-reactid=".p.3.1.0">重要方法</span></a></outline><outline class="toc-level-h3" data-reactid=".p.4" style="width: 155px;"><active data-reactid=".p.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".p.4.1"><span data-reactid=".p.4.1.0">判断类方法</span></a></outline><outline class="toc-level-h3" data-reactid=".p.5" style="width: 155px;"><active data-reactid=".p.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".p.5.1"><span data-reactid=".p.5.1.0">获取类方法</span></a></outline><outline class="toc-level-h3" data-reactid=".p.6" style="width: 155px;"><active data-reactid=".p.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".p.6.1"><span data-reactid=".p.6.1.0">更新类方法</span></a></outline><outline class="toc-level-h2" data-reactid=".p.7" style="width: 165px;"><active data-reactid=".p.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".p.7.1"><span data-reactid=".p.7.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".p.8" style="width: 165px;"><active data-reactid=".p.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".p.8.1"><span data-reactid=".p.8.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".p.9" style="width: 165px;"><active data-reactid=".p.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".p.9.1"><span data-reactid=".p.9.1.0">精选留言 (4)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/253108" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>