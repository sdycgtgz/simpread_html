
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 15 | 如何理解 Controller 在 Kafka 集群中的作用？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>15 | 如何理解 Controller 在 Kafka 集群中的作用？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">15 | 如何理解 Controller 在 Kafka 集群中的作用？</h1><div><span>胡夕</span> <span> 2020-05-23</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/8f/3f/8fb7ccabed2ed968857f647c6bcb573f.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：14.76M</span><span> 时长：16:07</span></div></div><audio title="15 | 如何理解Controller在Kafka集群中的作用？" src="https://res001.geekbang.org//media/audio/5a/41/5afb796241d45b2e75d1f295067f0441/ld/ld.m3u8" __idm_id__="49170"></audio></div><div><div><div><div data-slate-editor="true" data-key="16471" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="16472"><span data-slate-object="text" data-key="16473"><span data-slate-leaf="true" data-offset-key="16473:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16474"><span data-slate-object="text" data-key="16475"><span data-slate-leaf="true" data-offset-key="16475:0" data-first-offset="true"><span data-slate-string="true">上节课，我们学习了 Controller 选举的源码，了解了 Controller 组件的选举触发场景，以及它是如何被选举出来的。Controller 就绪之后，就会行使它作为控制器的重要权利了，包括管理集群成员、维护主题、操作元数据，等等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16476"><span data-slate-object="text" data-key="16477"><span data-slate-leaf="true" data-offset-key="16477:0" data-first-offset="true"><span data-slate-string="true">之前在学习 Kafka 的时候，我一直很好奇，新启动的 Broker 是如何加入到集群中的。官方文档里的解释是：“Adding servers to a Kafka cluster is easy, just assign them a unique broker id and start up Kafka on your new servers.” 显然，你只要启动 Broker 进程，就可以实现集群的扩展，甚至包括集群元数据信息的同步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16478"><span data-slate-object="text" data-key="16479"><span data-slate-leaf="true" data-offset-key="16479:0" data-first-offset="true"><span data-slate-string="true">不过，你是否思考过，这一切是怎么做到的呢？其实，这就是 Controller 组件源码提供的一个重要功能：管理新集群成员。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16480"><span data-slate-object="text" data-key="16481"><span data-slate-leaf="true" data-offset-key="16481:0" data-first-offset="true"><span data-slate-string="true">当然，作为核心组件，Controller 提供的功能非常多。除了集群成员管理，主题管理也是一个极其重要的功能。今天，我就带你深入了解下它们的实现代码。可以说，这是 Controller 最核心的两个功能，它们几乎涉及到了集群元数据中的所有重要数据。掌握了这些，之后你在探索 Controller 的其他代码时，会更加游刃有余。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16482" id="sr-toc-1"><span data-slate-object="text" data-key="16483"><span data-slate-leaf="true" data-offset-key="16483:0" data-first-offset="true"><span data-slate-string="true">集群成员管理</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16484"><span data-slate-object="text" data-key="16485"><span data-slate-leaf="true" data-offset-key="16485:0" data-first-offset="true"><span data-slate-string="true">首先，我们来看 Controller 管理集群成员部分的代码。这里的成员管理包含两个方面：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16486"><div data-slate-type="list-line" data-slate-object="block" data-key="16487"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="16488"><span data-slate-leaf="true" data-offset-key="16488:0" data-first-offset="true"><span data-slate-string="true">成员数量的管理，主要体现在新增成员和移除现有成员；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="16489"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="16490"><span data-slate-leaf="true" data-offset-key="16490:0" data-first-offset="true"><span data-slate-string="true">单个成员的管理，如变更单个 Broker 的数据等。</span></span></span></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16491" id="sr-toc-2"><span data-slate-object="text" data-key="16492"><span data-slate-leaf="true" data-offset-key="16492:0" data-first-offset="true"><span data-slate-string="true">成员数量管理</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16493"><span data-slate-object="text" data-key="16494"><span data-slate-leaf="true" data-offset-key="16494:0" data-first-offset="true"><span data-slate-string="true">每个 Broker 在启动的时候，会在 ZooKeeper 的 /brokers/ids 节点下创建一个名为 broker.id 参数值的临时节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16495"><span data-slate-object="text" data-key="16496"><span data-slate-leaf="true" data-offset-key="16496:0" data-first-offset="true"><span data-slate-string="true">举个例子，假设 Broker 的 broker.id 参数值设置为 1001，那么，当 Broker 启动后，你会在 ZooKeeper 的 /brokers/ids 下观测到一个名为 1001 的子节点。该节点的内容包括了 Broker 配置的主机名、端口号以及所用监听器的信息（注意：这里的监听器和上面说的 ZooKeeper 监听器不是一回事）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16497"><span data-slate-object="text" data-key="16498"><span data-slate-leaf="true" data-offset-key="16498:0" data-first-offset="true"><span data-slate-string="true">当该 Broker 正常关闭或意外退出时，ZooKeeper 上对应的临时节点会自动消失。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16499"><span data-slate-object="text" data-key="16500"><span data-slate-leaf="true" data-offset-key="16500:0" data-first-offset="true"><span data-slate-string="true">基于这种临时节点的机制，Controller 定义了 BrokerChangeHandler 监听器，专门负责监听 /brokers/ids 下的子节点数量变化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16501"><span data-slate-object="text" data-key="16502"><span data-slate-leaf="true" data-offset-key="16502:0" data-first-offset="true"><span data-slate-string="true">一旦发现新增或删除 Broker，/brokers/ids 下的子节点数目一定会发生变化。这会被 Controller 侦测到，进而触发 BrokerChangeHandler 的处理方法，即 handleChildChange 方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16503"><span data-slate-object="text" data-key="16504"><span data-slate-leaf="true" data-offset-key="16504:0" data-first-offset="true"><span data-slate-string="true">我给出 BrokerChangeHandler 的代码。可以看到，这里面定义了 handleChildChange 方法：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="16505"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16506"><span data-slate-object="text" data-key="16507"><span data-slate-leaf="true" data-offset-key="16507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="16508"><span data-slate-leaf="true" data-offset-key="16508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16509"><span data-slate-leaf="true" data-offset-key="16509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerChangeHandler</span></span></span></span></span><span data-slate-object="text" data-key="16510"><span data-slate-leaf="true" data-offset-key="16510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(eventManager: ControllerEventManager)</span></span></span></span></span><span data-slate-object="text" data-key="16511"><span data-slate-leaf="true" data-offset-key="16511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> extends ZNodeChildChangeHandler </span></span></span></span><span data-slate-object="text" data-key="16512"><span data-slate-leaf="true" data-offset-key="16512:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16513"><span data-slate-object="text" data-key="16514"><span data-slate-leaf="true" data-offset-key="16514:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16515"><span data-slate-leaf="true" data-offset-key="16515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Broker ZooKeeper ZNode: /brokers/ids </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16516"><span data-slate-object="text" data-key="16517"><span data-slate-leaf="true" data-offset-key="16517:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16518"><span data-slate-leaf="true" data-offset-key="16518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="16519"><span data-slate-leaf="true" data-offset-key="16519:0" data-first-offset="true"><span data-slate-string="true"> val path: String = BrokerIdsZNode.path</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16520"><span data-slate-object="text" data-key="16521"><span data-slate-leaf="true" data-offset-key="16521:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16522"><span data-slate-leaf="true" data-offset-key="16522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="16523"><span data-slate-leaf="true" data-offset-key="16523:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="16524"><span data-slate-leaf="true" data-offset-key="16524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleChildChange</span></span></span></span><span data-slate-object="text" data-key="16525"><span data-slate-leaf="true" data-offset-key="16525:0" data-first-offset="true"><span data-slate-string="true">(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16526"><span data-slate-object="text" data-key="16527"><span data-slate-leaf="true" data-offset-key="16527:0" data-first-offset="true"><span data-slate-string="true">    eventManager.</span></span></span><span data-slate-object="text" data-key="16528"><span data-slate-leaf="true" data-offset-key="16528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="16529"><span data-slate-leaf="true" data-offset-key="16529:0" data-first-offset="true"><span data-slate-string="true">(BrokerChange) </span></span></span><span data-slate-object="text" data-key="16530"><span data-slate-leaf="true" data-offset-key="16530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 仅仅是向事件队列写入 BrokerChange 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16531"><span data-slate-object="text" data-key="16532"><span data-slate-leaf="true" data-offset-key="16532:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16533"><span data-slate-object="text" data-key="16534"><span data-slate-leaf="true" data-offset-key="16534:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16535"><span data-slate-object="text" data-key="16536"><span data-slate-leaf="true" data-offset-key="16536:0" data-first-offset="true"><span data-slate-string="true">该方法的作用就是向 Controller 事件队列写入一个 BrokerChange 事件。</span></span></span><span data-slate-object="text" data-key="16537"><span data-slate-leaf="true" data-offset-key="16537:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">事实上，Controller 端定义的所有 Handler 的处理逻辑，都是向事件队列写入相应的 ControllerEvent，真正的事件处理逻辑位于 KafkaController 类的 process 方法中。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16538"><span data-slate-object="text" data-key="16539"><span data-slate-leaf="true" data-offset-key="16539:0" data-first-offset="true"><span data-slate-string="true">那么，接下来，我们就来看 process 方法。你会发现，处理 BrokerChange 事件的方法实际上是 processBrokerChange，代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="16540"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16541"><span data-slate-object="text" data-key="16542"><span data-slate-leaf="true" data-offset-key="16542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="16543"><span data-slate-leaf="true" data-offset-key="16543:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="16544"><span data-slate-leaf="true" data-offset-key="16544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processBrokerChange</span></span></span></span><span data-slate-object="text" data-key="16545"><span data-slate-leaf="true" data-offset-key="16545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="16546"><span data-slate-leaf="true" data-offset-key="16546:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16547"><span data-slate-object="text" data-key="16548"><span data-slate-leaf="true" data-offset-key="16548:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16549"><span data-slate-leaf="true" data-offset-key="16549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该 Broker 不是 Controller，自然无权处理，直接返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16550"><span data-slate-object="text" data-key="16551"><span data-slate-leaf="true" data-offset-key="16551:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16552"><span data-slate-leaf="true" data-offset-key="16552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16553"><span data-slate-leaf="true" data-offset-key="16553:0" data-first-offset="true"><span data-slate-string="true"> (!isActive) </span></span></span><span data-slate-object="text" data-key="16554"><span data-slate-leaf="true" data-offset-key="16554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16555"><span data-slate-object="text" data-key="16556"><span data-slate-leaf="true" data-offset-key="16556:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16557"><span data-slate-leaf="true" data-offset-key="16557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：从 ZooKeeper 中获取集群 Broker 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16558"><span data-slate-object="text" data-key="16559"><span data-slate-leaf="true" data-offset-key="16559:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16560"><span data-slate-leaf="true" data-offset-key="16560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16561"><span data-slate-leaf="true" data-offset-key="16561:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16562"><span data-slate-leaf="true" data-offset-key="16562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curBrokerAndEpochs</span></span></span></span><span data-slate-object="text" data-key="16563"><span data-slate-leaf="true" data-offset-key="16563:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16564"><span data-slate-leaf="true" data-offset-key="16564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16565"><span data-slate-leaf="true" data-offset-key="16565:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getAllBrokerAndEpochsInCluster</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16566"><span data-slate-object="text" data-key="16567"><span data-slate-leaf="true" data-offset-key="16567:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16568"><span data-slate-leaf="true" data-offset-key="16568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16569"><span data-slate-leaf="true" data-offset-key="16569:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16570"><span data-slate-leaf="true" data-offset-key="16570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curBrokerIdAndEpochs</span></span></span></span><span data-slate-object="text" data-key="16571"><span data-slate-leaf="true" data-offset-key="16571:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16572"><span data-slate-leaf="true" data-offset-key="16572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16573"><span data-slate-leaf="true" data-offset-key="16573:0" data-first-offset="true"><span data-slate-string="true"> curBrokerAndEpochs map { </span></span></span><span data-slate-object="text" data-key="16574"><span data-slate-leaf="true" data-offset-key="16574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16575"><span data-slate-leaf="true" data-offset-key="16575:0" data-first-offset="true"><span data-slate-string="true"> (broker, epoch) =&gt; (broker.id, epoch) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16576"><span data-slate-object="text" data-key="16577"><span data-slate-leaf="true" data-offset-key="16577:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16578"><span data-slate-leaf="true" data-offset-key="16578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16579"><span data-slate-leaf="true" data-offset-key="16579:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16580"><span data-slate-leaf="true" data-offset-key="16580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curBrokerIds</span></span></span></span><span data-slate-object="text" data-key="16581"><span data-slate-leaf="true" data-offset-key="16581:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16582"><span data-slate-leaf="true" data-offset-key="16582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16583"><span data-slate-leaf="true" data-offset-key="16583:0" data-first-offset="true"><span data-slate-string="true"> curBrokerIdAndEpochs.keySet</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16584"><span data-slate-object="text" data-key="16585"><span data-slate-leaf="true" data-offset-key="16585:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16586"><span data-slate-leaf="true" data-offset-key="16586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：获取 Controller 当前保存的 Broker 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16587"><span data-slate-object="text" data-key="16588"><span data-slate-leaf="true" data-offset-key="16588:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16589"><span data-slate-leaf="true" data-offset-key="16589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16590"><span data-slate-leaf="true" data-offset-key="16590:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16591"><span data-slate-leaf="true" data-offset-key="16591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">liveOrShuttingDownBrokerIds</span></span></span></span><span data-slate-object="text" data-key="16592"><span data-slate-leaf="true" data-offset-key="16592:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16593"><span data-slate-leaf="true" data-offset-key="16593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16594"><span data-slate-leaf="true" data-offset-key="16594:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.liveOrShuttingDownBrokerIds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16595"><span data-slate-object="text" data-key="16596"><span data-slate-leaf="true" data-offset-key="16596:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16597"><span data-slate-leaf="true" data-offset-key="16597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：比较两个列表，获取新增 Broker 列表、待移除 Broker 列表、</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16598"><span data-slate-object="text" data-key="16599"><span data-slate-leaf="true" data-offset-key="16599:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16600"><span data-slate-leaf="true" data-offset-key="16600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 已重启 Broker 列表和当前运行中的 Broker 列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16601"><span data-slate-object="text" data-key="16602"><span data-slate-leaf="true" data-offset-key="16602:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16603"><span data-slate-leaf="true" data-offset-key="16603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16604"><span data-slate-leaf="true" data-offset-key="16604:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16605"><span data-slate-leaf="true" data-offset-key="16605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newBrokerIds</span></span></span></span><span data-slate-object="text" data-key="16606"><span data-slate-leaf="true" data-offset-key="16606:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16607"><span data-slate-leaf="true" data-offset-key="16607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16608"><span data-slate-leaf="true" data-offset-key="16608:0" data-first-offset="true"><span data-slate-string="true"> curBrokerIds.diff(liveOrShuttingDownBrokerIds)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16609"><span data-slate-object="text" data-key="16610"><span data-slate-leaf="true" data-offset-key="16610:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16611"><span data-slate-leaf="true" data-offset-key="16611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16612"><span data-slate-leaf="true" data-offset-key="16612:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16613"><span data-slate-leaf="true" data-offset-key="16613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deadBrokerIds</span></span></span></span><span data-slate-object="text" data-key="16614"><span data-slate-leaf="true" data-offset-key="16614:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16615"><span data-slate-leaf="true" data-offset-key="16615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16616"><span data-slate-leaf="true" data-offset-key="16616:0" data-first-offset="true"><span data-slate-string="true"> liveOrShuttingDownBrokerIds.diff(curBrokerIds)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16617"><span data-slate-object="text" data-key="16618"><span data-slate-leaf="true" data-offset-key="16618:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16619"><span data-slate-leaf="true" data-offset-key="16619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16620"><span data-slate-leaf="true" data-offset-key="16620:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16621"><span data-slate-leaf="true" data-offset-key="16621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bouncedBrokerIds</span></span></span></span><span data-slate-object="text" data-key="16622"><span data-slate-leaf="true" data-offset-key="16622:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16623"><span data-slate-leaf="true" data-offset-key="16623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16624"><span data-slate-leaf="true" data-offset-key="16624:0" data-first-offset="true"><span data-slate-string="true"> (curBrokerIds &amp; liveOrShuttingDownBrokerIds)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16625"><span data-slate-object="text" data-key="16626"><span data-slate-leaf="true" data-offset-key="16626:0" data-first-offset="true"><span data-slate-string="true">    .filter(brokerId =&gt; curBrokerIdAndEpochs(brokerId) &gt; controllerContext.liveBrokerIdAndEpochs(brokerId))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16627"><span data-slate-object="text" data-key="16628"><span data-slate-leaf="true" data-offset-key="16628:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16629"><span data-slate-leaf="true" data-offset-key="16629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16630"><span data-slate-leaf="true" data-offset-key="16630:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16631"><span data-slate-leaf="true" data-offset-key="16631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newBrokerAndEpochs</span></span></span></span><span data-slate-object="text" data-key="16632"><span data-slate-leaf="true" data-offset-key="16632:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16633"><span data-slate-leaf="true" data-offset-key="16633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16634"><span data-slate-leaf="true" data-offset-key="16634:0" data-first-offset="true"><span data-slate-string="true"> curBrokerAndEpochs.filter { </span></span></span><span data-slate-object="text" data-key="16635"><span data-slate-leaf="true" data-offset-key="16635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16636"><span data-slate-leaf="true" data-offset-key="16636:0" data-first-offset="true"><span data-slate-string="true"> (broker, _) =&gt; newBrokerIds.contains(broker.id) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16637"><span data-slate-object="text" data-key="16638"><span data-slate-leaf="true" data-offset-key="16638:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16639"><span data-slate-leaf="true" data-offset-key="16639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16640"><span data-slate-leaf="true" data-offset-key="16640:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16641"><span data-slate-leaf="true" data-offset-key="16641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bouncedBrokerAndEpochs</span></span></span></span><span data-slate-object="text" data-key="16642"><span data-slate-leaf="true" data-offset-key="16642:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16643"><span data-slate-leaf="true" data-offset-key="16643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16644"><span data-slate-leaf="true" data-offset-key="16644:0" data-first-offset="true"><span data-slate-string="true"> curBrokerAndEpochs.filter { </span></span></span><span data-slate-object="text" data-key="16645"><span data-slate-leaf="true" data-offset-key="16645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16646"><span data-slate-leaf="true" data-offset-key="16646:0" data-first-offset="true"><span data-slate-string="true"> (broker, _) =&gt; bouncedBrokerIds.contains(broker.id) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16647"><span data-slate-object="text" data-key="16648"><span data-slate-leaf="true" data-offset-key="16648:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16649"><span data-slate-leaf="true" data-offset-key="16649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16650"><span data-slate-leaf="true" data-offset-key="16650:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16651"><span data-slate-leaf="true" data-offset-key="16651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newBrokerIdsSorted</span></span></span></span><span data-slate-object="text" data-key="16652"><span data-slate-leaf="true" data-offset-key="16652:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16653"><span data-slate-leaf="true" data-offset-key="16653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16654"><span data-slate-leaf="true" data-offset-key="16654:0" data-first-offset="true"><span data-slate-string="true"> newBrokerIds.toSeq.sorted</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16655"><span data-slate-object="text" data-key="16656"><span data-slate-leaf="true" data-offset-key="16656:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16657"><span data-slate-leaf="true" data-offset-key="16657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16658"><span data-slate-leaf="true" data-offset-key="16658:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16659"><span data-slate-leaf="true" data-offset-key="16659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deadBrokerIdsSorted</span></span></span></span><span data-slate-object="text" data-key="16660"><span data-slate-leaf="true" data-offset-key="16660:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16661"><span data-slate-leaf="true" data-offset-key="16661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16662"><span data-slate-leaf="true" data-offset-key="16662:0" data-first-offset="true"><span data-slate-string="true"> deadBrokerIds.toSeq.sorted</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16663"><span data-slate-object="text" data-key="16664"><span data-slate-leaf="true" data-offset-key="16664:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16665"><span data-slate-leaf="true" data-offset-key="16665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16666"><span data-slate-leaf="true" data-offset-key="16666:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16667"><span data-slate-leaf="true" data-offset-key="16667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">liveBrokerIdsSorted</span></span></span></span><span data-slate-object="text" data-key="16668"><span data-slate-leaf="true" data-offset-key="16668:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16669"><span data-slate-leaf="true" data-offset-key="16669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16670"><span data-slate-leaf="true" data-offset-key="16670:0" data-first-offset="true"><span data-slate-string="true"> curBrokerIds.toSeq.sorted</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16671"><span data-slate-object="text" data-key="16672"><span data-slate-leaf="true" data-offset-key="16672:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16673"><span data-slate-leaf="true" data-offset-key="16673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16674"><span data-slate-leaf="true" data-offset-key="16674:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16675"><span data-slate-leaf="true" data-offset-key="16675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bouncedBrokerIdsSorted</span></span></span></span><span data-slate-object="text" data-key="16676"><span data-slate-leaf="true" data-offset-key="16676:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16677"><span data-slate-leaf="true" data-offset-key="16677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16678"><span data-slate-leaf="true" data-offset-key="16678:0" data-first-offset="true"><span data-slate-string="true"> bouncedBrokerIds.toSeq.sorted</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16679"><span data-slate-object="text" data-key="16680"><span data-slate-leaf="true" data-offset-key="16680:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16681"><span data-slate-leaf="true" data-offset-key="16681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">info</span></span></span></span><span data-slate-object="text" data-key="16682"><span data-slate-leaf="true" data-offset-key="16682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s</span></span></span></span><span data-slate-object="text" data-key="16683"><span data-slate-leaf="true" data-offset-key="16683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Newly added brokers: ${newBrokerIdsSorted.mkString("</span></span></span></span></span><span data-slate-object="text" data-key="16684"><span data-slate-leaf="true" data-offset-key="16684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,</span></span></span></span><span data-slate-object="text" data-key="16685"><span data-slate-leaf="true" data-offset-key="16685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")},"</span></span></span></span></span><span data-slate-object="text" data-key="16686"><span data-slate-leaf="true" data-offset-key="16686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> +</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16687"><span data-slate-object="text" data-key="16688"><span data-slate-leaf="true" data-offset-key="16688:0" data-first-offset="true"><span data-slate-string="true">    s</span></span></span><span data-slate-object="text" data-key="16689"><span data-slate-leaf="true" data-offset-key="16689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"deleted brokers: ${deadBrokerIdsSorted.mkString("</span></span></span></span><span data-slate-object="text" data-key="16690"><span data-slate-leaf="true" data-offset-key="16690:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="16691"><span data-slate-leaf="true" data-offset-key="16691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")},"</span></span></span></span><span data-slate-object="text" data-key="16692"><span data-slate-leaf="true" data-offset-key="16692:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16693"><span data-slate-object="text" data-key="16694"><span data-slate-leaf="true" data-offset-key="16694:0" data-first-offset="true"><span data-slate-string="true">    s</span></span></span><span data-slate-object="text" data-key="16695"><span data-slate-leaf="true" data-offset-key="16695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"bounced brokers: ${bouncedBrokerIdsSorted.mkString("</span></span></span></span><span data-slate-object="text" data-key="16696"><span data-slate-leaf="true" data-offset-key="16696:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="16697"><span data-slate-leaf="true" data-offset-key="16697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")},"</span></span></span></span><span data-slate-object="text" data-key="16698"><span data-slate-leaf="true" data-offset-key="16698:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16699"><span data-slate-object="text" data-key="16700"><span data-slate-leaf="true" data-offset-key="16700:0" data-first-offset="true"><span data-slate-string="true">    s</span></span></span><span data-slate-object="text" data-key="16701"><span data-slate-leaf="true" data-offset-key="16701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"all live brokers: ${liveBrokerIdsSorted.mkString("</span></span></span></span><span data-slate-object="text" data-key="16702"><span data-slate-leaf="true" data-offset-key="16702:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="16703"><span data-slate-leaf="true" data-offset-key="16703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")}"</span></span></span></span><span data-slate-object="text" data-key="16704"><span data-slate-leaf="true" data-offset-key="16704:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16705"><span data-slate-object="text" data-key="16706"><span data-slate-leaf="true" data-offset-key="16706:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16707"><span data-slate-leaf="true" data-offset-key="16707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 4 步：为每个新增 Broker 创建与之连接的通道管理器和</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16708"><span data-slate-object="text" data-key="16709"><span data-slate-leaf="true" data-offset-key="16709:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16710"><span data-slate-leaf="true" data-offset-key="16710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 底层的请求发送线程（RequestSendThread）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16711"><span data-slate-object="text" data-key="16712"><span data-slate-leaf="true" data-offset-key="16712:0" data-first-offset="true"><span data-slate-string="true">  newBrokerAndEpochs.keySet.foreach(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16713"><span data-slate-object="text" data-key="16714"><span data-slate-leaf="true" data-offset-key="16714:0" data-first-offset="true"><span data-slate-string="true">    controllerChannelManager.addBroker)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16715"><span data-slate-object="text" data-key="16716"><span data-slate-leaf="true" data-offset-key="16716:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16717"><span data-slate-leaf="true" data-offset-key="16717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 5 步：为每个已重启的 Broker 移除它们现有的配套资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16718"><span data-slate-object="text" data-key="16719"><span data-slate-leaf="true" data-offset-key="16719:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16720"><span data-slate-leaf="true" data-offset-key="16720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//（通道管理器、RequestSendThread 等），并重新添加它们</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16721"><span data-slate-object="text" data-key="16722"><span data-slate-leaf="true" data-offset-key="16722:0" data-first-offset="true"><span data-slate-string="true">  bouncedBrokerIds.foreach(controllerChannelManager.removeBroker)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16723"><span data-slate-object="text" data-key="16724"><span data-slate-leaf="true" data-offset-key="16724:0" data-first-offset="true"><span data-slate-string="true">  bouncedBrokerAndEpochs.keySet.foreach(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16725"><span data-slate-object="text" data-key="16726"><span data-slate-leaf="true" data-offset-key="16726:0" data-first-offset="true"><span data-slate-string="true">    controllerChannelManager.addBroker)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16727"><span data-slate-object="text" data-key="16728"><span data-slate-leaf="true" data-offset-key="16728:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16729"><span data-slate-leaf="true" data-offset-key="16729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 6 步：为每个待移除 Broker 移除对应的配套资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16730"><span data-slate-object="text" data-key="16731"><span data-slate-leaf="true" data-offset-key="16731:0" data-first-offset="true"><span data-slate-string="true">  deadBrokerIds.foreach(controllerChannelManager.removeBroker)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16732"><span data-slate-object="text" data-key="16733"><span data-slate-leaf="true" data-offset-key="16733:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16734"><span data-slate-leaf="true" data-offset-key="16734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 7 步：为新增 Broker 执行更新 Controller 元数据和 Broker 启动逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16735"><span data-slate-object="text" data-key="16736"><span data-slate-leaf="true" data-offset-key="16736:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16737"><span data-slate-leaf="true" data-offset-key="16737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16738"><span data-slate-leaf="true" data-offset-key="16738:0" data-first-offset="true"><span data-slate-string="true"> (newBrokerIds.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16739"><span data-slate-object="text" data-key="16740"><span data-slate-leaf="true" data-offset-key="16740:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.addLiveBrokers(newBrokerAndEpochs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16741"><span data-slate-object="text" data-key="16742"><span data-slate-leaf="true" data-offset-key="16742:0" data-first-offset="true"><span data-slate-string="true">    onBrokerStartup(newBrokerIdsSorted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16743"><span data-slate-object="text" data-key="16744"><span data-slate-leaf="true" data-offset-key="16744:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16745"><span data-slate-object="text" data-key="16746"><span data-slate-leaf="true" data-offset-key="16746:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16747"><span data-slate-leaf="true" data-offset-key="16747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 8 步：为已重启 Broker 执行重添加逻辑，包含</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16748"><span data-slate-object="text" data-key="16749"><span data-slate-leaf="true" data-offset-key="16749:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16750"><span data-slate-leaf="true" data-offset-key="16750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 ControllerContext、执行 Broker 重启动逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16751"><span data-slate-object="text" data-key="16752"><span data-slate-leaf="true" data-offset-key="16752:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16753"><span data-slate-leaf="true" data-offset-key="16753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16754"><span data-slate-leaf="true" data-offset-key="16754:0" data-first-offset="true"><span data-slate-string="true"> (bouncedBrokerIds.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16755"><span data-slate-object="text" data-key="16756"><span data-slate-leaf="true" data-offset-key="16756:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.removeLiveBrokers(bouncedBrokerIds)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16757"><span data-slate-object="text" data-key="16758"><span data-slate-leaf="true" data-offset-key="16758:0" data-first-offset="true"><span data-slate-string="true">    onBrokerFailure(bouncedBrokerIdsSorted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16759"><span data-slate-object="text" data-key="16760"><span data-slate-leaf="true" data-offset-key="16760:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.addLiveBrokers(bouncedBrokerAndEpochs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16761"><span data-slate-object="text" data-key="16762"><span data-slate-leaf="true" data-offset-key="16762:0" data-first-offset="true"><span data-slate-string="true">    onBrokerStartup(bouncedBrokerIdsSorted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16763"><span data-slate-object="text" data-key="16764"><span data-slate-leaf="true" data-offset-key="16764:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16765"><span data-slate-object="text" data-key="16766"><span data-slate-leaf="true" data-offset-key="16766:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16767"><span data-slate-leaf="true" data-offset-key="16767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 9 步：为待移除 Broker 执行移除 ControllerContext 和 Broker 终止逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16768"><span data-slate-object="text" data-key="16769"><span data-slate-leaf="true" data-offset-key="16769:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16770"><span data-slate-leaf="true" data-offset-key="16770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16771"><span data-slate-leaf="true" data-offset-key="16771:0" data-first-offset="true"><span data-slate-string="true"> (deadBrokerIds.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16772"><span data-slate-object="text" data-key="16773"><span data-slate-leaf="true" data-offset-key="16773:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.removeLiveBrokers(deadBrokerIds)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16774"><span data-slate-object="text" data-key="16775"><span data-slate-leaf="true" data-offset-key="16775:0" data-first-offset="true"><span data-slate-string="true">    onBrokerFailure(deadBrokerIdsSorted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16776"><span data-slate-object="text" data-key="16777"><span data-slate-leaf="true" data-offset-key="16777:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16778"><span data-slate-object="text" data-key="16779"><span data-slate-leaf="true" data-offset-key="16779:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16780"><span data-slate-leaf="true" data-offset-key="16780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16781"><span data-slate-leaf="true" data-offset-key="16781:0" data-first-offset="true"><span data-slate-string="true"> (newBrokerIds.nonEmpty || deadBrokerIds.nonEmpty ||</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16782"><span data-slate-object="text" data-key="16783"><span data-slate-leaf="true" data-offset-key="16783:0" data-first-offset="true"><span data-slate-string="true">   bouncedBrokerIds.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16784"><span data-slate-object="text" data-key="16785"><span data-slate-leaf="true" data-offset-key="16785:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="16786"><span data-slate-leaf="true" data-offset-key="16786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Updated broker epochs cache: ${controllerContext.liveBrokerIdAndEpochs}"</span></span></span></span><span data-slate-object="text" data-key="16787"><span data-slate-leaf="true" data-offset-key="16787:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16788"><span data-slate-object="text" data-key="16789"><span data-slate-leaf="true" data-offset-key="16789:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16790"><span data-slate-object="text" data-key="16791"><span data-slate-leaf="true" data-offset-key="16791:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16792"><span data-slate-object="text" data-key="16793"><span data-slate-leaf="true" data-offset-key="16793:0" data-first-offset="true"><span data-slate-string="true">代码有点长，你可以看下我添加的重点注释。同时，我再画一张图，帮你梳理下这个方法做的事情。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16794"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/ff/d3/fffc8456d8ede9219462e607fa4241d3.jpg?wh=2800*1784"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16795"><span data-slate-object="text" data-key="16796"><span data-slate-leaf="true" data-offset-key="16796:0" data-first-offset="true"><span data-slate-string="true">整个方法共有 9 步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16797"><span data-slate-object="text" data-key="16798"><span data-slate-leaf="true" data-offset-key="16798:0" data-first-offset="true"><span data-slate-string="true">第 1~3 步：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16799"><span data-slate-object="text" data-key="16800"><span data-slate-leaf="true" data-offset-key="16800:0" data-first-offset="true"><span data-slate-string="true">前两步分别是从 ZooKeeper 和 ControllerContext 中获取 Broker 列表；第 3 步是获取 4 个 Broker 列表：新增 Broker 列表、待移除 Broker 列表、已重启的 Broker 列表和当前运行中的 Broker 列表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16801"><span data-slate-object="text" data-key="16802"><span data-slate-leaf="true" data-offset-key="16802:0" data-first-offset="true"><span data-slate-string="true">假设前两步中的 Broker 列表分别用 A 和 B 表示，由于 Kafka 以 ZooKeeper 上的数据为权威数据，因此，A 就是最新的运行中 Broker 列表，“A-B” 就表示新增的 Broker，“B-A” 就表示待移除的 Broker。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16803"><span data-slate-object="text" data-key="16804"><span data-slate-leaf="true" data-offset-key="16804:0" data-first-offset="true"><span data-slate-string="true">已重启的 Broker 的判断逻辑要复杂一些，它判断的是 A∧B 集合中的那些 Epoch 值变更了的 Broker。你大体上可以把 Epoch 值理解为 Broker 的版本或重启的次数。显然，Epoch 值变更了，就说明 Broker 发生了重启行为。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16805"><span data-slate-object="text" data-key="16806"><span data-slate-leaf="true" data-offset-key="16806:0" data-first-offset="true"><span data-slate-string="true">第 4~9 步：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16807"><span data-slate-object="text" data-key="16808"><span data-slate-leaf="true" data-offset-key="16808:0" data-first-offset="true"><span data-slate-string="true">拿到这些集合之后，Controller 会分别为这 4 个 Broker 列表执行相应的操作，也就是这个方法中第 4~9 步要做的事情。总体上，这些相应的操作分为 3 类。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16809"><div data-slate-type="list-line" data-slate-object="block" data-key="16810"><span data-slate-object="text" data-key="16811"><span data-slate-leaf="true" data-offset-key="16811:0" data-first-offset="true"><span data-slate-string="true">执行元数据更新操作：调用 ControllerContext 类的各个方法，更新不同的集群元数据信息。比如需要将新增 Broker 加入到集群元数据，将待移除 Broker 从元数据中移除等。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16812"><span data-slate-object="text" data-key="16813"><span data-slate-leaf="true" data-offset-key="16813:0" data-first-offset="true"><span data-slate-string="true">执行 Broker 终止操作：为待移除 Broker 和已重启 Broker 调用 onBrokerFailure 方法。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16814"><span data-slate-object="text" data-key="16815"><span data-slate-leaf="true" data-offset-key="16815:0" data-first-offset="true"><span data-slate-string="true">执行 Broker 启动操作：为已重启 Broker 和新增 Broker 调用 onBrokerStartup 方法。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16816"><span data-slate-object="text" data-key="16817"><span data-slate-leaf="true" data-offset-key="16817:0" data-first-offset="true"><span data-slate-string="true">下面我们深入了解下 onBrokerFailure 和 onBrokerStartup 方法的逻辑。相比于其他方法，这两个方法的代码逻辑有些复杂，要做的事情也很多，因此，我们重点研究下它们。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16818"><span data-slate-object="text" data-key="16819"><span data-slate-leaf="true" data-offset-key="16819:0" data-first-offset="true"><span data-slate-string="true">首先是处理 Broker 终止逻辑的 onBrokerFailure 方法，代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="16820"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16821"><span data-slate-object="text" data-key="16822"><span data-slate-leaf="true" data-offset-key="16822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="16823"><span data-slate-leaf="true" data-offset-key="16823:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="16824"><span data-slate-leaf="true" data-offset-key="16824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">onBrokerFailure</span></span></span></span><span data-slate-object="text" data-key="16825"><span data-slate-leaf="true" data-offset-key="16825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(deadBrokers: Seq[Int])</span></span></span></span><span data-slate-object="text" data-key="16826"><span data-slate-leaf="true" data-offset-key="16826:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16827"><span data-slate-object="text" data-key="16828"><span data-slate-leaf="true" data-offset-key="16828:0" data-first-offset="true"><span data-slate-string="true">  info(s</span></span></span><span data-slate-object="text" data-key="16829"><span data-slate-leaf="true" data-offset-key="16829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Broker failure callback for ${deadBrokers.mkString("</span></span></span></span><span data-slate-object="text" data-key="16830"><span data-slate-leaf="true" data-offset-key="16830:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="16831"><span data-slate-leaf="true" data-offset-key="16831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")}"</span></span></span></span><span data-slate-object="text" data-key="16832"><span data-slate-leaf="true" data-offset-key="16832:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16833"><span data-slate-object="text" data-key="16834"><span data-slate-leaf="true" data-offset-key="16834:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16835"><span data-slate-leaf="true" data-offset-key="16835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：为每个待移除 Broker，删除元数据对象中的相关项</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16836"><span data-slate-object="text" data-key="16837"><span data-slate-leaf="true" data-offset-key="16837:0" data-first-offset="true"><span data-slate-string="true">  deadBrokers.foreach(controllerContext.replicasOnOfflineDirs.remove</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16838"><span data-slate-object="text" data-key="16839"><span data-slate-leaf="true" data-offset-key="16839:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16840"><span data-slate-leaf="true" data-offset-key="16840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：将待移除 Broker 从元数据对象中处于已关闭状态的 Broker 列表中去除             </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16841"><span data-slate-object="text" data-key="16842"><span data-slate-leaf="true" data-offset-key="16842:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16843"><span data-slate-leaf="true" data-offset-key="16843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16844"><span data-slate-leaf="true" data-offset-key="16844:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16845"><span data-slate-leaf="true" data-offset-key="16845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deadBrokersThatWereShuttingDown</span></span></span></span><span data-slate-object="text" data-key="16846"><span data-slate-leaf="true" data-offset-key="16846:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16847"><span data-slate-leaf="true" data-offset-key="16847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16848"><span data-slate-object="text" data-key="16849"><span data-slate-leaf="true" data-offset-key="16849:0" data-first-offset="true"><span data-slate-string="true">    deadBrokers.filter(id =&gt; controllerContext.shuttingDownBrokerIds.remove(id))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16850"><span data-slate-object="text" data-key="16851"><span data-slate-leaf="true" data-offset-key="16851:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16852"><span data-slate-leaf="true" data-offset-key="16852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16853"><span data-slate-leaf="true" data-offset-key="16853:0" data-first-offset="true"><span data-slate-string="true"> (deadBrokersThatWereShuttingDown.nonEmpty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16854"><span data-slate-object="text" data-key="16855"><span data-slate-leaf="true" data-offset-key="16855:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="16856"><span data-slate-leaf="true" data-offset-key="16856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Removed ${deadBrokersThatWereShuttingDown.mkString("</span></span></span></span><span data-slate-object="text" data-key="16857"><span data-slate-leaf="true" data-offset-key="16857:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="16858"><span data-slate-leaf="true" data-offset-key="16858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")} from list of shutting down brokers."</span></span></span></span><span data-slate-object="text" data-key="16859"><span data-slate-leaf="true" data-offset-key="16859:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16860"><span data-slate-object="text" data-key="16861"><span data-slate-leaf="true" data-offset-key="16861:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16862"><span data-slate-leaf="true" data-offset-key="16862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：找出待移除 Broker 上的所有副本对象，执行相应操作，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16863"><span data-slate-object="text" data-key="16864"><span data-slate-leaf="true" data-offset-key="16864:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16865"><span data-slate-leaf="true" data-offset-key="16865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将其置为 “不可用状态”（即 Offline）  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16866"><span data-slate-object="text" data-key="16867"><span data-slate-leaf="true" data-offset-key="16867:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16868"><span data-slate-leaf="true" data-offset-key="16868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="16869"><span data-slate-leaf="true" data-offset-key="16869:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16870"><span data-slate-leaf="true" data-offset-key="16870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">allReplicasOnDeadBrokers</span></span></span></span><span data-slate-object="text" data-key="16871"><span data-slate-leaf="true" data-offset-key="16871:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16872"><span data-slate-leaf="true" data-offset-key="16872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="16873"><span data-slate-leaf="true" data-offset-key="16873:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.replicasOnBrokers(deadBrokers.toSet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16874"><span data-slate-object="text" data-key="16875"><span data-slate-leaf="true" data-offset-key="16875:0" data-first-offset="true"><span data-slate-string="true">  onReplicasBecomeOffline(allReplicasOnDeadBrokers)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16876"><span data-slate-object="text" data-key="16877"><span data-slate-leaf="true" data-offset-key="16877:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16878"><span data-slate-leaf="true" data-offset-key="16878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 4 步：注销注册的 BrokerModificationsHandler 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16879"><span data-slate-object="text" data-key="16880"><span data-slate-leaf="true" data-offset-key="16880:0" data-first-offset="true"><span data-slate-string="true">  unregisterBrokerModificationsHandler(deadBrokers)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16881"><span data-slate-object="text" data-key="16882"><span data-slate-leaf="true" data-offset-key="16882:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16883"><span data-slate-object="text" data-key="16884"><span data-slate-leaf="true" data-offset-key="16884:0" data-first-offset="true"><span data-slate-string="true">Broker 终止，意味着我们必须要删除 Controller 元数据缓存中与之相关的所有项，还要处理这些 Broker 上保存的副本。最后，我们还要注销之前为该 Broker 注册的 BrokerModificationsHandler 监听器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16885"><span data-slate-object="text" data-key="16886"><span data-slate-leaf="true" data-offset-key="16886:0" data-first-offset="true"><span data-slate-string="true">其实，主体逻辑在于如何处理 Broker 上的副本对象，即 onReplicasBecomeOffline 方法。该方法大量调用了 Kafka 副本管理器和分区管理器的相关功能，后面我们会专门学习这两个管理器，因此这里我就不展开讲了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16887"><span data-slate-object="text" data-key="16888"><span data-slate-leaf="true" data-offset-key="16888:0" data-first-offset="true"><span data-slate-string="true">现在，我们看 onBrokerStartup 方法。它是处理 Broker 启动的方法，也就是 Controller 端应对集群新增 Broker 启动的方法。同样，我先给出带注释的完整方法代码：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="16889"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16890"><span data-slate-object="text" data-key="16891"><span data-slate-leaf="true" data-offset-key="16891:0" data-first-offset="true"><span data-slate-string="true">private def onBrokerStartup(newBrokers: Seq[Int]): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16892"><span data-slate-object="text" data-key="16893"><span data-slate-leaf="true" data-offset-key="16893:0" data-first-offset="true"><span data-slate-string="true">  info(s</span></span></span><span data-slate-object="text" data-key="16894"><span data-slate-leaf="true" data-offset-key="16894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"New broker startup callback for </span></span></span></span><span data-slate-object="text" data-key="16895"><span data-slate-leaf="true" data-offset-key="16895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${newBrokers.mkString(</span></span></span></span></span><span data-slate-object="text" data-key="16896"><span data-slate-leaf="true" data-offset-key="16896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">","</span></span></span></span></span><span data-slate-object="text" data-key="16897"><span data-slate-leaf="true" data-offset-key="16897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)}</span></span></span></span></span><span data-slate-object="text" data-key="16898"><span data-slate-leaf="true" data-offset-key="16898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="16899"><span data-slate-leaf="true" data-offset-key="16899:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16900"><span data-slate-object="text" data-key="16901"><span data-slate-leaf="true" data-offset-key="16901:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16902"><span data-slate-leaf="true" data-offset-key="16902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：移除元数据中新增 Broker 对应的副本集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16903"><span data-slate-object="text" data-key="16904"><span data-slate-leaf="true" data-offset-key="16904:0" data-first-offset="true"><span data-slate-string="true">  newBrokers.foreach(controllerContext.replicasOnOfflineDirs.remove)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16905"><span data-slate-object="text" data-key="16906"><span data-slate-leaf="true" data-offset-key="16906:0" data-first-offset="true"><span data-slate-string="true">  val newBrokersSet = newBrokers.toSet</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16907"><span data-slate-object="text" data-key="16908"><span data-slate-leaf="true" data-offset-key="16908:0" data-first-offset="true"><span data-slate-string="true">  val existingBrokers = controllerContext.</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16909"><span data-slate-object="text" data-key="16910"><span data-slate-leaf="true" data-offset-key="16910:0" data-first-offset="true"><span data-slate-string="true">    liveOrShuttingDownBrokerIds.diff(newBrokersSet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16911"><span data-slate-object="text" data-key="16912"><span data-slate-leaf="true" data-offset-key="16912:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16913"><span data-slate-leaf="true" data-offset-key="16913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：给集群现有 Broker 发送元数据更新请求，令它们感知到新增 Broker 的到来</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16914"><span data-slate-object="text" data-key="16915"><span data-slate-leaf="true" data-offset-key="16915:0" data-first-offset="true"><span data-slate-string="true">  sendUpdateMetadataRequest(existingBrokers.toSeq, </span></span></span><span data-slate-object="text" data-key="16916"><span data-slate-leaf="true" data-offset-key="16916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="16917"><span data-slate-leaf="true" data-offset-key="16917:0" data-first-offset="true"><span data-slate-string="true">.empty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16918"><span data-slate-object="text" data-key="16919"><span data-slate-leaf="true" data-offset-key="16919:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16920"><span data-slate-leaf="true" data-offset-key="16920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：给新增 Broker 发送元数据更新请求，令它们同步集群当前的所有分区数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16921"><span data-slate-object="text" data-key="16922"><span data-slate-leaf="true" data-offset-key="16922:0" data-first-offset="true"><span data-slate-string="true">  sendUpdateMetadataRequest(newBrokers, controllerContext.partitionLeadershipInfo.keySet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16923"><span data-slate-object="text" data-key="16924"><span data-slate-leaf="true" data-offset-key="16924:0" data-first-offset="true"><span data-slate-string="true">  val allReplicasOnNewBrokers = controllerContext.replicasOnBrokers(newBrokersSet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16925"><span data-slate-object="text" data-key="16926"><span data-slate-leaf="true" data-offset-key="16926:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16927"><span data-slate-leaf="true" data-offset-key="16927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 4 步：将新增 Broker 上的所有副本设置为 Online 状态，即可用状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16928"><span data-slate-object="text" data-key="16929"><span data-slate-leaf="true" data-offset-key="16929:0" data-first-offset="true"><span data-slate-string="true">  replicaStateMachine.handleStateChanges(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16930"><span data-slate-object="text" data-key="16931"><span data-slate-leaf="true" data-offset-key="16931:0" data-first-offset="true"><span data-slate-string="true">    allReplicasOnNewBrokers.toSeq, OnlineReplica)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16932"><span data-slate-object="text" data-key="16933"><span data-slate-leaf="true" data-offset-key="16933:0" data-first-offset="true"><span data-slate-string="true">  partitionStateMachine.triggerOnlinePartitionStateChange()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16934"><span data-slate-object="text" data-key="16935"><span data-slate-leaf="true" data-offset-key="16935:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16936"><span data-slate-leaf="true" data-offset-key="16936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 5 步：重启之前暂停的副本迁移操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16937"><span data-slate-object="text" data-key="16938"><span data-slate-leaf="true" data-offset-key="16938:0" data-first-offset="true"><span data-slate-string="true">  maybeResumeReassignments {(_, assignment) =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16939"><span data-slate-object="text" data-key="16940"><span data-slate-leaf="true" data-offset-key="16940:0" data-first-offset="true"><span data-slate-string="true">    assignment.targetReplicas.exists(newBrokersSet.contains)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16941"><span data-slate-object="text" data-key="16942"><span data-slate-leaf="true" data-offset-key="16942:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16943"><span data-slate-object="text" data-key="16944"><span data-slate-leaf="true" data-offset-key="16944:0" data-first-offset="true"><span data-slate-string="true">  val replicasForTopicsToBeDeleted = allReplicasOnNewBrokers.filter(p =&gt; topicDeletionManager.isTopicQueuedUpForDeletion(p.topic))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16945"><span data-slate-object="text" data-key="16946"><span data-slate-leaf="true" data-offset-key="16946:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16947"><span data-slate-leaf="true" data-offset-key="16947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 6 步：重启之前暂停的主题删除操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16948"><span data-slate-object="text" data-key="16949"><span data-slate-leaf="true" data-offset-key="16949:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16950"><span data-slate-leaf="true" data-offset-key="16950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16951"><span data-slate-leaf="true" data-offset-key="16951:0" data-first-offset="true"><span data-slate-string="true"> (replicasForTopicsToBeDeleted.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16952"><span data-slate-object="text" data-key="16953"><span data-slate-leaf="true" data-offset-key="16953:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="16954"><span data-slate-leaf="true" data-offset-key="16954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Some replicas </span></span></span></span><span data-slate-object="text" data-key="16955"><span data-slate-leaf="true" data-offset-key="16955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${replicasForTopicsToBeDeleted.mkString(</span></span></span></span></span><span data-slate-object="text" data-key="16956"><span data-slate-leaf="true" data-offset-key="16956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">","</span></span></span></span></span><span data-slate-object="text" data-key="16957"><span data-slate-leaf="true" data-offset-key="16957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)}</span></span></span></span></span><span data-slate-object="text" data-key="16958"><span data-slate-leaf="true" data-offset-key="16958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> for topics scheduled for deletion "</span></span></span></span><span data-slate-object="text" data-key="16959"><span data-slate-leaf="true" data-offset-key="16959:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16960"><span data-slate-object="text" data-key="16961"><span data-slate-leaf="true" data-offset-key="16961:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="16962"><span data-slate-leaf="true" data-offset-key="16962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="16963"><span data-slate-leaf="true" data-offset-key="16963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${controllerContext.topicsToBeDeleted.mkString(</span></span></span></span></span><span data-slate-object="text" data-key="16964"><span data-slate-leaf="true" data-offset-key="16964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">","</span></span></span></span></span><span data-slate-object="text" data-key="16965"><span data-slate-leaf="true" data-offset-key="16965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)}</span></span></span></span></span><span data-slate-object="text" data-key="16966"><span data-slate-leaf="true" data-offset-key="16966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> are on the newly restarted brokers "</span></span></span></span><span data-slate-object="text" data-key="16967"><span data-slate-leaf="true" data-offset-key="16967:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16968"><span data-slate-object="text" data-key="16969"><span data-slate-leaf="true" data-offset-key="16969:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="16970"><span data-slate-leaf="true" data-offset-key="16970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="16971"><span data-slate-leaf="true" data-offset-key="16971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${newBrokers.mkString(</span></span></span></span></span><span data-slate-object="text" data-key="16972"><span data-slate-leaf="true" data-offset-key="16972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">","</span></span></span></span></span><span data-slate-object="text" data-key="16973"><span data-slate-leaf="true" data-offset-key="16973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)}</span></span></span></span></span><span data-slate-object="text" data-key="16974"><span data-slate-leaf="true" data-offset-key="16974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">. Signaling restart of topic deletion for these topics"</span></span></span></span><span data-slate-object="text" data-key="16975"><span data-slate-leaf="true" data-offset-key="16975:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16976"><span data-slate-object="text" data-key="16977"><span data-slate-leaf="true" data-offset-key="16977:0" data-first-offset="true"><span data-slate-string="true">   topicDeletionManager.resumeDeletionForTopics(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16978"><span data-slate-object="text" data-key="16979"><span data-slate-leaf="true" data-offset-key="16979:0" data-first-offset="true"><span data-slate-string="true">     replicasForTopicsToBeDeleted.map(_.topic))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16980"><span data-slate-object="text" data-key="16981"><span data-slate-leaf="true" data-offset-key="16981:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16982"><span data-slate-object="text" data-key="16983"><span data-slate-leaf="true" data-offset-key="16983:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16984"><span data-slate-leaf="true" data-offset-key="16984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 7 步：为新增 Broker 注册 BrokerModificationsHandler 监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16985"><span data-slate-object="text" data-key="16986"><span data-slate-leaf="true" data-offset-key="16986:0" data-first-offset="true"><span data-slate-string="true">  registerBrokerModificationsHandler(newBrokers)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16987"><span data-slate-object="text" data-key="16988"><span data-slate-leaf="true" data-offset-key="16988:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16989"><span data-slate-object="text" data-key="16990"><span data-slate-leaf="true" data-offset-key="16990:0" data-first-offset="true"><span data-slate-string="true">如代码所示，第 1 步是移除新增 Broker 在元数据缓存中的信息。你可能会问：“这些 Broker 不都是新增的吗？元数据缓存中有它们的数据吗？” 实际上，这里的 newBrokers 仅仅表示新启动的 Broker，它们不一定是全新的 Broker。因此，这里的删除元数据缓存是非常安全的做法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16991"><span data-slate-object="text" data-key="16992"><span data-slate-leaf="true" data-offset-key="16992:0" data-first-offset="true"><span data-slate-string="true">第 2、3 步：分别给集群的已有 Broker 和新增 Broker 发送更新元数据请求。这样一来，整个集群上的 Broker 就可以互相感知到彼此，而且最终所有的 Broker 都能保存相同的分区数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16993"><span data-slate-object="text" data-key="16994"><span data-slate-leaf="true" data-offset-key="16994:0" data-first-offset="true"><span data-slate-string="true">第 4 步：将新增 Broker 上的副本状态置为 Online 状态。Online 状态表示这些副本正常提供服务，即 Leader 副本对外提供读写服务，Follower 副本自动向 Leader 副本同步消息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16995"><span data-slate-object="text" data-key="16996"><span data-slate-leaf="true" data-offset-key="16996:0" data-first-offset="true"><span data-slate-string="true">第 5、6 步：分别重启可能因为新增 Broker 启动、而能够重新被执行的副本迁移和主题删除操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16997"><span data-slate-object="text" data-key="16998"><span data-slate-leaf="true" data-offset-key="16998:0" data-first-offset="true"><span data-slate-string="true">第 7 步：为所有新增 Broker 注册 BrokerModificationsHandler 监听器，允许 Controller 监控它们在 ZooKeeper 上的节点的数据变更。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16999" id="sr-toc-3"><span data-slate-object="text" data-key="17000"><span data-slate-leaf="true" data-offset-key="17000:0" data-first-offset="true"><span data-slate-string="true">成员信息管理</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17001"><span data-slate-object="text" data-key="17002"><span data-slate-leaf="true" data-offset-key="17002:0" data-first-offset="true"><span data-slate-string="true">了解了 Controller 管理集群成员数量的机制之后，接下来，我们要重点学习下 Controller 如何监听 Broker 端信息的变更，以及具体的操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17003"><span data-slate-object="text" data-key="17004"><span data-slate-leaf="true" data-offset-key="17004:0" data-first-offset="true"><span data-slate-string="true">和管理集群成员类似，Controller 也是通过 ZooKeeper 监听器的方式来应对 Broker 的变化。这个监听器就是 BrokerModificationsHandler。一旦 Broker 的信息发生变更，该监听器的 handleDataChange 方法就会被调用，向事件队列写入 BrokerModifications 事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17005"><span data-slate-object="text" data-key="17006"><span data-slate-leaf="true" data-offset-key="17006:0" data-first-offset="true"><span data-slate-string="true">KafkaController 类的 processBrokerModification 方法负责处理这类事件，代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="17007"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17008"><span data-slate-object="text" data-key="17009"><span data-slate-leaf="true" data-offset-key="17009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="17010"><span data-slate-leaf="true" data-offset-key="17010:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="17011"><span data-slate-leaf="true" data-offset-key="17011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processBrokerModification</span></span></span></span><span data-slate-object="text" data-key="17012"><span data-slate-leaf="true" data-offset-key="17012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(brokerId: Int)</span></span></span></span><span data-slate-object="text" data-key="17013"><span data-slate-leaf="true" data-offset-key="17013:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17014"><span data-slate-object="text" data-key="17015"><span data-slate-leaf="true" data-offset-key="17015:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17016"><span data-slate-leaf="true" data-offset-key="17016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17017"><span data-slate-leaf="true" data-offset-key="17017:0" data-first-offset="true"><span data-slate-string="true"> (!isActive) </span></span></span><span data-slate-object="text" data-key="17018"><span data-slate-leaf="true" data-offset-key="17018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17019"><span data-slate-object="text" data-key="17020"><span data-slate-leaf="true" data-offset-key="17020:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17021"><span data-slate-leaf="true" data-offset-key="17021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：获取目标 Broker 的详细数据，</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17022"><span data-slate-object="text" data-key="17023"><span data-slate-leaf="true" data-offset-key="17023:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17024"><span data-slate-leaf="true" data-offset-key="17024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 包括每套监听器配置的主机名、端口号以及所使用的安全协议等</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17025"><span data-slate-object="text" data-key="17026"><span data-slate-leaf="true" data-offset-key="17026:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17027"><span data-slate-leaf="true" data-offset-key="17027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17028"><span data-slate-leaf="true" data-offset-key="17028:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17029"><span data-slate-leaf="true" data-offset-key="17029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newMetadataOpt</span></span></span></span><span data-slate-object="text" data-key="17030"><span data-slate-leaf="true" data-offset-key="17030:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17031"><span data-slate-leaf="true" data-offset-key="17031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17032"><span data-slate-leaf="true" data-offset-key="17032:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getBroker(brokerId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17033"><span data-slate-object="text" data-key="17034"><span data-slate-leaf="true" data-offset-key="17034:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17035"><span data-slate-leaf="true" data-offset-key="17035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：从元数据缓存中获得目标 Broker 的详细数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17036"><span data-slate-object="text" data-key="17037"><span data-slate-leaf="true" data-offset-key="17037:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17038"><span data-slate-leaf="true" data-offset-key="17038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17039"><span data-slate-leaf="true" data-offset-key="17039:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17040"><span data-slate-leaf="true" data-offset-key="17040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">oldMetadataOpt</span></span></span></span><span data-slate-object="text" data-key="17041"><span data-slate-leaf="true" data-offset-key="17041:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17042"><span data-slate-leaf="true" data-offset-key="17042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17043"><span data-slate-leaf="true" data-offset-key="17043:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.liveOrShuttingDownBroker(brokerId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17044"><span data-slate-object="text" data-key="17045"><span data-slate-leaf="true" data-offset-key="17045:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17046"><span data-slate-leaf="true" data-offset-key="17046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17047"><span data-slate-leaf="true" data-offset-key="17047:0" data-first-offset="true"><span data-slate-string="true"> (newMetadataOpt.nonEmpty &amp;&amp; oldMetadataOpt.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17048"><span data-slate-object="text" data-key="17049"><span data-slate-leaf="true" data-offset-key="17049:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17050"><span data-slate-leaf="true" data-offset-key="17050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17051"><span data-slate-leaf="true" data-offset-key="17051:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17052"><span data-slate-leaf="true" data-offset-key="17052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">oldMetadata</span></span></span></span><span data-slate-object="text" data-key="17053"><span data-slate-leaf="true" data-offset-key="17053:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17054"><span data-slate-leaf="true" data-offset-key="17054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17055"><span data-slate-leaf="true" data-offset-key="17055:0" data-first-offset="true"><span data-slate-string="true"> oldMetadataOpt.get</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17056"><span data-slate-object="text" data-key="17057"><span data-slate-leaf="true" data-offset-key="17057:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17058"><span data-slate-leaf="true" data-offset-key="17058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17059"><span data-slate-leaf="true" data-offset-key="17059:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17060"><span data-slate-leaf="true" data-offset-key="17060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newMetadata</span></span></span></span><span data-slate-object="text" data-key="17061"><span data-slate-leaf="true" data-offset-key="17061:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17062"><span data-slate-leaf="true" data-offset-key="17062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17063"><span data-slate-leaf="true" data-offset-key="17063:0" data-first-offset="true"><span data-slate-string="true"> newMetadataOpt.get</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17064"><span data-slate-object="text" data-key="17065"><span data-slate-leaf="true" data-offset-key="17065:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17066"><span data-slate-leaf="true" data-offset-key="17066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：如果两者不相等，说明 Broker 数据发生了变更</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17067"><span data-slate-object="text" data-key="17068"><span data-slate-leaf="true" data-offset-key="17068:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17069"><span data-slate-leaf="true" data-offset-key="17069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 那么，更新元数据缓存，以及执行 onBrokerUpdate 方法处理 Broker 更新的逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17070"><span data-slate-object="text" data-key="17071"><span data-slate-leaf="true" data-offset-key="17071:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17072"><span data-slate-leaf="true" data-offset-key="17072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17073"><span data-slate-leaf="true" data-offset-key="17073:0" data-first-offset="true"><span data-slate-string="true"> (newMetadata.endPoints != oldMetadata.endPoints) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17074"><span data-slate-object="text" data-key="17075"><span data-slate-leaf="true" data-offset-key="17075:0" data-first-offset="true"><span data-slate-string="true">      info(s</span></span></span><span data-slate-object="text" data-key="17076"><span data-slate-leaf="true" data-offset-key="17076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Updated broker metadata: $oldMetadata -&gt; $newMetadata"</span></span></span></span><span data-slate-object="text" data-key="17077"><span data-slate-leaf="true" data-offset-key="17077:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17078"><span data-slate-object="text" data-key="17079"><span data-slate-leaf="true" data-offset-key="17079:0" data-first-offset="true"><span data-slate-string="true">      controllerContext.updateBrokerMetadata(oldMetadata, newMetadata)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17080"><span data-slate-object="text" data-key="17081"><span data-slate-leaf="true" data-offset-key="17081:0" data-first-offset="true"><span data-slate-string="true">      onBrokerUpdate(brokerId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17082"><span data-slate-object="text" data-key="17083"><span data-slate-leaf="true" data-offset-key="17083:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17084"><span data-slate-object="text" data-key="17085"><span data-slate-leaf="true" data-offset-key="17085:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17086"><span data-slate-object="text" data-key="17087"><span data-slate-leaf="true" data-offset-key="17087:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17088"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17089"><span data-slate-object="text" data-key="17090"><span data-slate-leaf="true" data-offset-key="17090:0" data-first-offset="true"><span data-slate-string="true">该方法首先获取 ZooKeeper 上最权威的 Broker 数据，将其与元数据缓存上的数据进行比对。如果发现两者不一致，就会更新元数据缓存，同时调用 onBrokerUpdate 方法执行更新逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17091"><span data-slate-object="text" data-key="17092"><span data-slate-leaf="true" data-offset-key="17092:0" data-first-offset="true"><span data-slate-string="true">那么，onBrokerUpdate 方法又是如何实现的呢？我们先看下代码：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="17093"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17094"><span data-slate-object="text" data-key="17095"><span data-slate-leaf="true" data-offset-key="17095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span></span><span data-slate-object="text" data-key="17096"><span data-slate-leaf="true" data-offset-key="17096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="17097"><span data-slate-leaf="true" data-offset-key="17097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">onBrokerUpdate</span></span></span></span></span><span data-slate-object="text" data-key="17098"><span data-slate-leaf="true" data-offset-key="17098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(updatedBrokerId: Int)</span></span></span></span></span><span data-slate-object="text" data-key="17099"><span data-slate-leaf="true" data-offset-key="17099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="17100"><span data-slate-leaf="true" data-offset-key="17100:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17101"><span data-slate-object="text" data-key="17102"><span data-slate-leaf="true" data-offset-key="17102:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17103"><span data-slate-leaf="true" data-offset-key="17103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">info</span></span></span></span><span data-slate-object="text" data-key="17104"><span data-slate-leaf="true" data-offset-key="17104:0" data-first-offset="true"><span data-slate-string="true">(s</span></span></span><span data-slate-object="text" data-key="17105"><span data-slate-leaf="true" data-offset-key="17105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Broker info update callback for $updatedBrokerId"</span></span></span></span><span data-slate-object="text" data-key="17106"><span data-slate-leaf="true" data-offset-key="17106:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17107"><span data-slate-object="text" data-key="17108"><span data-slate-leaf="true" data-offset-key="17108:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17109"><span data-slate-leaf="true" data-offset-key="17109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 给集群所有 Broker 发送 UpdateMetadataRequest，让她它们去更新元数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17110"><span data-slate-object="text" data-key="17111"><span data-slate-leaf="true" data-offset-key="17111:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17112"><span data-slate-leaf="true" data-offset-key="17112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendUpdateMetadataRequest</span></span></span></span><span data-slate-object="text" data-key="17113"><span data-slate-leaf="true" data-offset-key="17113:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17114"><span data-slate-object="text" data-key="17115"><span data-slate-leaf="true" data-offset-key="17115:0" data-first-offset="true"><span data-slate-string="true">    controllerContext.liveOrShuttingDownBrokerIds.toSeq, Set.empty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17116"><span data-slate-object="text" data-key="17117"><span data-slate-leaf="true" data-offset-key="17117:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17118"><span data-slate-object="text" data-key="17119"><span data-slate-leaf="true" data-offset-key="17119:0" data-first-offset="true"><span data-slate-string="true">可以看到，onBrokerUpdate 就是向集群所有 Broker 发送更新元数据信息请求，把变更信息广播出去。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17120"><span data-slate-object="text" data-key="17121"><span data-slate-leaf="true" data-offset-key="17121:0" data-first-offset="true"><span data-slate-string="true">怎么样，应对 Broker 信息变更的方法还是比较简单的吧？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17122" id="sr-toc-4"><span data-slate-object="text" data-key="17123"><span data-slate-leaf="true" data-offset-key="17123:0" data-first-offset="true"><span data-slate-string="true">主题管理</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17124"><span data-slate-object="text" data-key="17125"><span data-slate-leaf="true" data-offset-key="17125:0" data-first-offset="true"><span data-slate-string="true">除了维护集群成员之外，Controller 还有一个重要的任务，那就是对所有主题进行管理，主要包括主题的创建、变更与删除。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17126"><span data-slate-object="text" data-key="17127"><span data-slate-leaf="true" data-offset-key="17127:0" data-first-offset="true"><span data-slate-string="true">掌握了前面集群成员管理的方法，在学习下面的内容时会轻松很多。因为它们的实现机制是一脉相承的，几乎没有任何差异。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17128" id="sr-toc-5"><span data-slate-object="text" data-key="17129"><span data-slate-leaf="true" data-offset-key="17129:0" data-first-offset="true"><span data-slate-string="true">主题创建 / 变更</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17130"><span data-slate-object="text" data-key="17131"><span data-slate-leaf="true" data-offset-key="17131:0" data-first-offset="true"><span data-slate-string="true">我们重点学习下主题是如何被创建的。实际上，主题变更与创建是相同的逻辑，因此，源码使用了一套监听器统一处理这两种情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17132"><span data-slate-object="text" data-key="17133"><span data-slate-leaf="true" data-offset-key="17133:0" data-first-offset="true"><span data-slate-string="true">你一定使用过 Kafka 的 kafka-topics 脚本或 AdminClient 创建主题吧？实际上，这些工具仅仅是向 ZooKeeper 对应的目录下写入相应的数据而已，那么，Controller，或者说 Kafka 集群是如何感知到新创建的主题的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17134"><span data-slate-object="text" data-key="17135"><span data-slate-leaf="true" data-offset-key="17135:0" data-first-offset="true"><span data-slate-string="true">这当然要归功于监听主题路径的 ZooKeeper 监听器：TopicChangeHandler。代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="17136"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17137"><span data-slate-object="text" data-key="17138"><span data-slate-leaf="true" data-offset-key="17138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="17139"><span data-slate-leaf="true" data-offset-key="17139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17140"><span data-slate-leaf="true" data-offset-key="17140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicChangeHandler</span></span></span></span></span><span data-slate-object="text" data-key="17141"><span data-slate-leaf="true" data-offset-key="17141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(eventManager: ControllerEventManager)</span></span></span></span></span><span data-slate-object="text" data-key="17142"><span data-slate-leaf="true" data-offset-key="17142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> extends ZNodeChildChangeHandler </span></span></span></span><span data-slate-object="text" data-key="17143"><span data-slate-leaf="true" data-offset-key="17143:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17144"><span data-slate-object="text" data-key="17145"><span data-slate-leaf="true" data-offset-key="17145:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17146"><span data-slate-leaf="true" data-offset-key="17146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ZooKeeper 节点：/brokers/topics</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17147"><span data-slate-object="text" data-key="17148"><span data-slate-leaf="true" data-offset-key="17148:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17149"><span data-slate-leaf="true" data-offset-key="17149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="17150"><span data-slate-leaf="true" data-offset-key="17150:0" data-first-offset="true"><span data-slate-string="true"> val path: String = TopicsZNode.path</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17151"><span data-slate-object="text" data-key="17152"><span data-slate-leaf="true" data-offset-key="17152:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17153"><span data-slate-leaf="true" data-offset-key="17153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向事件队列写入 TopicChange 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17154"><span data-slate-object="text" data-key="17155"><span data-slate-leaf="true" data-offset-key="17155:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17156"><span data-slate-leaf="true" data-offset-key="17156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="17157"><span data-slate-leaf="true" data-offset-key="17157:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="17158"><span data-slate-leaf="true" data-offset-key="17158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleChildChange</span></span></span></span><span data-slate-object="text" data-key="17159"><span data-slate-leaf="true" data-offset-key="17159:0" data-first-offset="true"><span data-slate-string="true">(): Unit = eventManager.</span></span></span><span data-slate-object="text" data-key="17160"><span data-slate-leaf="true" data-offset-key="17160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="17161"><span data-slate-leaf="true" data-offset-key="17161:0" data-first-offset="true"><span data-slate-string="true">(TopicChange)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17162"><span data-slate-object="text" data-key="17163"><span data-slate-leaf="true" data-offset-key="17163:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17164"><span data-slate-object="text" data-key="17165"><span data-slate-leaf="true" data-offset-key="17165:0" data-first-offset="true"><span data-slate-string="true">代码中的 TopicsZNode.path 就是 ZooKeeper 下 /brokers/topics 节点。一旦该节点下新增了主题信息，该监听器的 handleChildChange 就会被触发，Controller 通过 ControllerEventManager 对象，向事件队列写入 TopicChange 事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17166"><span data-slate-object="text" data-key="17167"><span data-slate-leaf="true" data-offset-key="17167:0" data-first-offset="true"><span data-slate-string="true">KafkaController 的 process 方法接到该事件后，调用 processTopicChange 方法执行主题创建。代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="17168"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17169"><span data-slate-object="text" data-key="17170"><span data-slate-leaf="true" data-offset-key="17170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="17171"><span data-slate-leaf="true" data-offset-key="17171:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="17172"><span data-slate-leaf="true" data-offset-key="17172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processTopicChange</span></span></span></span><span data-slate-object="text" data-key="17173"><span data-slate-leaf="true" data-offset-key="17173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="17174"><span data-slate-leaf="true" data-offset-key="17174:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17175"><span data-slate-object="text" data-key="17176"><span data-slate-leaf="true" data-offset-key="17176:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17177"><span data-slate-leaf="true" data-offset-key="17177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17178"><span data-slate-leaf="true" data-offset-key="17178:0" data-first-offset="true"><span data-slate-string="true"> (!isActive) </span></span></span><span data-slate-object="text" data-key="17179"><span data-slate-leaf="true" data-offset-key="17179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17180"><span data-slate-object="text" data-key="17181"><span data-slate-leaf="true" data-offset-key="17181:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17182"><span data-slate-leaf="true" data-offset-key="17182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 1 步：从 ZooKeeper 中获取所有主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17183"><span data-slate-object="text" data-key="17184"><span data-slate-leaf="true" data-offset-key="17184:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17185"><span data-slate-leaf="true" data-offset-key="17185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17186"><span data-slate-leaf="true" data-offset-key="17186:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17187"><span data-slate-leaf="true" data-offset-key="17187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topics</span></span></span></span><span data-slate-object="text" data-key="17188"><span data-slate-leaf="true" data-offset-key="17188:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17189"><span data-slate-leaf="true" data-offset-key="17189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17190"><span data-slate-leaf="true" data-offset-key="17190:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getAllTopicsInCluster(</span></span></span><span data-slate-object="text" data-key="17191"><span data-slate-leaf="true" data-offset-key="17191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="17192"><span data-slate-leaf="true" data-offset-key="17192:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17193"><span data-slate-object="text" data-key="17194"><span data-slate-leaf="true" data-offset-key="17194:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17195"><span data-slate-leaf="true" data-offset-key="17195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 2 步：与元数据缓存比对，找出新增主题列表与已删除主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17196"><span data-slate-object="text" data-key="17197"><span data-slate-leaf="true" data-offset-key="17197:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17198"><span data-slate-leaf="true" data-offset-key="17198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17199"><span data-slate-leaf="true" data-offset-key="17199:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17200"><span data-slate-leaf="true" data-offset-key="17200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newTopics</span></span></span></span><span data-slate-object="text" data-key="17201"><span data-slate-leaf="true" data-offset-key="17201:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17202"><span data-slate-leaf="true" data-offset-key="17202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17203"><span data-slate-leaf="true" data-offset-key="17203:0" data-first-offset="true"><span data-slate-string="true"> topics -- controllerContext.allTopics</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17204"><span data-slate-object="text" data-key="17205"><span data-slate-leaf="true" data-offset-key="17205:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17206"><span data-slate-leaf="true" data-offset-key="17206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17207"><span data-slate-leaf="true" data-offset-key="17207:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17208"><span data-slate-leaf="true" data-offset-key="17208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deletedTopics</span></span></span></span><span data-slate-object="text" data-key="17209"><span data-slate-leaf="true" data-offset-key="17209:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17210"><span data-slate-leaf="true" data-offset-key="17210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17211"><span data-slate-leaf="true" data-offset-key="17211:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.allTopics.diff(topics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17212"><span data-slate-object="text" data-key="17213"><span data-slate-leaf="true" data-offset-key="17213:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17214"><span data-slate-leaf="true" data-offset-key="17214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 3 步：使用 ZooKeeper 中的主题列表更新元数据缓存</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17215"><span data-slate-object="text" data-key="17216"><span data-slate-leaf="true" data-offset-key="17216:0" data-first-offset="true"><span data-slate-string="true">  controllerContext.setAllTopics(topics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17217"><span data-slate-object="text" data-key="17218"><span data-slate-leaf="true" data-offset-key="17218:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17219"><span data-slate-leaf="true" data-offset-key="17219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 4 步：为新增主题注册分区变更监听器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17220"><span data-slate-object="text" data-key="17221"><span data-slate-leaf="true" data-offset-key="17221:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17222"><span data-slate-leaf="true" data-offset-key="17222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分区变更监听器是监听主题分区变更的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17223"><span data-slate-object="text" data-key="17224"><span data-slate-leaf="true" data-offset-key="17224:0" data-first-offset="true"><span data-slate-string="true">  registerPartitionModificationsHandlers(newTopics.toSeq)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17225"><span data-slate-object="text" data-key="17226"><span data-slate-leaf="true" data-offset-key="17226:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17227"><span data-slate-leaf="true" data-offset-key="17227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 5 步：从 ZooKeeper 中获取新增主题的副本分配情况</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17228"><span data-slate-object="text" data-key="17229"><span data-slate-leaf="true" data-offset-key="17229:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17230"><span data-slate-leaf="true" data-offset-key="17230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17231"><span data-slate-leaf="true" data-offset-key="17231:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17232"><span data-slate-leaf="true" data-offset-key="17232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addedPartitionReplicaAssignment</span></span></span></span><span data-slate-object="text" data-key="17233"><span data-slate-leaf="true" data-offset-key="17233:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17234"><span data-slate-leaf="true" data-offset-key="17234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17235"><span data-slate-leaf="true" data-offset-key="17235:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getFullReplicaAssignmentForTopics(newTopics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17236"><span data-slate-object="text" data-key="17237"><span data-slate-leaf="true" data-offset-key="17237:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17238"><span data-slate-leaf="true" data-offset-key="17238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 6 步：清除元数据缓存中属于已删除主题的缓存项</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17239"><span data-slate-object="text" data-key="17240"><span data-slate-leaf="true" data-offset-key="17240:0" data-first-offset="true"><span data-slate-string="true">  deletedTopics.foreach(controllerContext.removeTopic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17241"><span data-slate-object="text" data-key="17242"><span data-slate-leaf="true" data-offset-key="17242:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17243"><span data-slate-leaf="true" data-offset-key="17243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 7 步：为新增主题更新元数据缓存中的副本分配条目</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17244"><span data-slate-object="text" data-key="17245"><span data-slate-leaf="true" data-offset-key="17245:0" data-first-offset="true"><span data-slate-string="true">  addedPartitionReplicaAssignment.foreach {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17246"><span data-slate-object="text" data-key="17247"><span data-slate-leaf="true" data-offset-key="17247:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17248"><span data-slate-leaf="true" data-offset-key="17248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17249"><span data-slate-leaf="true" data-offset-key="17249:0" data-first-offset="true"><span data-slate-string="true"> (topicAndPartition, newReplicaAssignment) =&gt; controllerContext.updatePartitionFullReplicaAssignment(topicAndPartition, newReplicaAssignment)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17250"><span data-slate-object="text" data-key="17251"><span data-slate-leaf="true" data-offset-key="17251:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17252"><span data-slate-object="text" data-key="17253"><span data-slate-leaf="true" data-offset-key="17253:0" data-first-offset="true"><span data-slate-string="true">  info(s</span></span></span><span data-slate-object="text" data-key="17254"><span data-slate-leaf="true" data-offset-key="17254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"New topics: [$newTopics], deleted topics: [$deletedTopics], new partition replica assignment"</span></span></span></span><span data-slate-object="text" data-key="17255"><span data-slate-leaf="true" data-offset-key="17255:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17256"><span data-slate-object="text" data-key="17257"><span data-slate-leaf="true" data-offset-key="17257:0" data-first-offset="true"><span data-slate-string="true">    s</span></span></span><span data-slate-object="text" data-key="17258"><span data-slate-leaf="true" data-offset-key="17258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"[$addedPartitionReplicaAssignment]"</span></span></span></span><span data-slate-object="text" data-key="17259"><span data-slate-leaf="true" data-offset-key="17259:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17260"><span data-slate-object="text" data-key="17261"><span data-slate-leaf="true" data-offset-key="17261:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17262"><span data-slate-leaf="true" data-offset-key="17262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 第 8 步：调整新增主题所有分区以及所属所有副本的运行状态为 “上线” 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17263"><span data-slate-object="text" data-key="17264"><span data-slate-leaf="true" data-offset-key="17264:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17265"><span data-slate-leaf="true" data-offset-key="17265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17266"><span data-slate-leaf="true" data-offset-key="17266:0" data-first-offset="true"><span data-slate-string="true"> (addedPartitionReplicaAssignment.nonEmpty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17267"><span data-slate-object="text" data-key="17268"><span data-slate-leaf="true" data-offset-key="17268:0" data-first-offset="true"><span data-slate-string="true">    onNewPartitionCreation(addedPartitionReplicaAssignment.keySet)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17269"><span data-slate-object="text" data-key="17270"><span data-slate-leaf="true" data-offset-key="17270:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17271"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17272"><span data-slate-object="text" data-key="17273"><span data-slate-leaf="true" data-offset-key="17273:0" data-first-offset="true"><span data-slate-string="true">虽然一共有 8 步，但大部分的逻辑都与更新元数据缓存项有关，因此，处理逻辑总体上还是比较简单的。需要注意的是，第 8 步涉及到了使用分区管理器和副本管理器来调整分区和副本状态。后面我们会详细介绍。这里你只需要知道，分区和副本处于 “上线” 状态，就表明它们能够正常工作，就足够了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17274" id="sr-toc-6"><span data-slate-object="text" data-key="17275"><span data-slate-leaf="true" data-offset-key="17275:0" data-first-offset="true"><span data-slate-string="true">主题删除</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17276"><span data-slate-object="text" data-key="17277"><span data-slate-leaf="true" data-offset-key="17277:0" data-first-offset="true"><span data-slate-string="true">和主题创建或变更类似，删除主题也依赖 ZooKeeper 监听器完成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17278"><span data-slate-object="text" data-key="17279"><span data-slate-leaf="true" data-offset-key="17279:0" data-first-offset="true"><span data-slate-string="true">Controller 定义了 TopicDeletionHandler，用它来实现对删除主题的监听，代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="17280"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17281"><span data-slate-object="text" data-key="17282"><span data-slate-leaf="true" data-offset-key="17282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span></span><span data-slate-object="text" data-key="17283"><span data-slate-leaf="true" data-offset-key="17283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17284"><span data-slate-leaf="true" data-offset-key="17284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicDeletionHandler</span></span></span></span></span><span data-slate-object="text" data-key="17285"><span data-slate-leaf="true" data-offset-key="17285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(eventManager: ControllerEventManager)</span></span></span></span></span><span data-slate-object="text" data-key="17286"><span data-slate-leaf="true" data-offset-key="17286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> extends ZNodeChildChangeHandler </span></span></span></span><span data-slate-object="text" data-key="17287"><span data-slate-leaf="true" data-offset-key="17287:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17288"><span data-slate-object="text" data-key="17289"><span data-slate-leaf="true" data-offset-key="17289:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17290"><span data-slate-leaf="true" data-offset-key="17290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ZooKeeper 节点：/admin/delete_topics</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17291"><span data-slate-object="text" data-key="17292"><span data-slate-leaf="true" data-offset-key="17292:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17293"><span data-slate-leaf="true" data-offset-key="17293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="17294"><span data-slate-leaf="true" data-offset-key="17294:0" data-first-offset="true"><span data-slate-string="true"> val path: String = DeleteTopicsZNode.path</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17295"><span data-slate-object="text" data-key="17296"><span data-slate-leaf="true" data-offset-key="17296:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17297"><span data-slate-leaf="true" data-offset-key="17297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向事件队列写入 TopicDeletion 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17298"><span data-slate-object="text" data-key="17299"><span data-slate-leaf="true" data-offset-key="17299:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17300"><span data-slate-leaf="true" data-offset-key="17300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span><span data-slate-object="text" data-key="17301"><span data-slate-leaf="true" data-offset-key="17301:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="17302"><span data-slate-leaf="true" data-offset-key="17302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">handleChildChange</span></span></span></span><span data-slate-object="text" data-key="17303"><span data-slate-leaf="true" data-offset-key="17303:0" data-first-offset="true"><span data-slate-string="true">(): Unit = eventManager.</span></span></span><span data-slate-object="text" data-key="17304"><span data-slate-leaf="true" data-offset-key="17304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">put</span></span></span></span><span data-slate-object="text" data-key="17305"><span data-slate-leaf="true" data-offset-key="17305:0" data-first-offset="true"><span data-slate-string="true">(TopicDeletion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17306"><span data-slate-object="text" data-key="17307"><span data-slate-leaf="true" data-offset-key="17307:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17308"><span data-slate-object="text" data-key="17309"><span data-slate-leaf="true" data-offset-key="17309:0" data-first-offset="true"><span data-slate-string="true">这里的 DeleteTopicsZNode.path 指的是 /admin/delete_topics 节点。目前，无论是 kafka-topics 脚本，还是 AdminClient，删除主题都是在 /admin/delete_topics 节点下创建名为待删除主题名的子节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17310"><span data-slate-object="text" data-key="17311"><span data-slate-leaf="true" data-offset-key="17311:0" data-first-offset="true"><span data-slate-string="true">比如，如果我要删除 test-topic 主题，那么，Kafka 的删除命令仅仅是在 ZooKeeper 上创建 /admin/delete_topics/test-topic 节点。一旦监听到该节点被创建，TopicDeletionHandler 的 handleChildChange 方法就会被触发，Controller 会向事件队列写入 TopicDeletion 事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17312"><span data-slate-object="text" data-key="17313"><span data-slate-leaf="true" data-offset-key="17313:0" data-first-offset="true"><span data-slate-string="true">处理 TopicDeletion 事件的方法是 processTopicDeletion，代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="17314"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17315"><span data-slate-object="text" data-key="17316"><span data-slate-leaf="true" data-offset-key="17316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="17317"><span data-slate-leaf="true" data-offset-key="17317:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="17318"><span data-slate-leaf="true" data-offset-key="17318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processTopicDeletion</span></span></span></span><span data-slate-object="text" data-key="17319"><span data-slate-leaf="true" data-offset-key="17319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="17320"><span data-slate-leaf="true" data-offset-key="17320:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17321"><span data-slate-object="text" data-key="17322"><span data-slate-leaf="true" data-offset-key="17322:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17323"><span data-slate-leaf="true" data-offset-key="17323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17324"><span data-slate-leaf="true" data-offset-key="17324:0" data-first-offset="true"><span data-slate-string="true"> (!isActive) </span></span></span><span data-slate-object="text" data-key="17325"><span data-slate-leaf="true" data-offset-key="17325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17326"><span data-slate-object="text" data-key="17327"><span data-slate-leaf="true" data-offset-key="17327:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17328"><span data-slate-leaf="true" data-offset-key="17328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 ZooKeeper 中获取待删除主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17329"><span data-slate-object="text" data-key="17330"><span data-slate-leaf="true" data-offset-key="17330:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17331"><span data-slate-leaf="true" data-offset-key="17331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="17332"><span data-slate-leaf="true" data-offset-key="17332:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17333"><span data-slate-leaf="true" data-offset-key="17333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">topicsToBeDeleted</span></span></span></span><span data-slate-object="text" data-key="17334"><span data-slate-leaf="true" data-offset-key="17334:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17335"><span data-slate-leaf="true" data-offset-key="17335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17336"><span data-slate-leaf="true" data-offset-key="17336:0" data-first-offset="true"><span data-slate-string="true"> zkClient.getTopicDeletions.toSet</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17337"><span data-slate-object="text" data-key="17338"><span data-slate-leaf="true" data-offset-key="17338:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17339"><span data-slate-leaf="true" data-offset-key="17339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">debug</span></span></span></span><span data-slate-object="text" data-key="17340"><span data-slate-leaf="true" data-offset-key="17340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s</span></span></span></span><span data-slate-object="text" data-key="17341"><span data-slate-leaf="true" data-offset-key="17341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Delete topics listener fired for topics ${topicsToBeDeleted.mkString("</span></span></span></span></span><span data-slate-object="text" data-key="17342"><span data-slate-leaf="true" data-offset-key="17342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,</span></span></span></span><span data-slate-object="text" data-key="17343"><span data-slate-leaf="true" data-offset-key="17343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")} to be deleted"</span></span></span></span></span><span data-slate-object="text" data-key="17344"><span data-slate-leaf="true" data-offset-key="17344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17345"><span data-slate-object="text" data-key="17346"><span data-slate-leaf="true" data-offset-key="17346:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17347"><span data-slate-leaf="true" data-offset-key="17347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找出不存在的主题列表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17348"><span data-slate-object="text" data-key="17349"><span data-slate-leaf="true" data-offset-key="17349:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17350"><span data-slate-leaf="true" data-offset-key="17350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17351"><span data-slate-leaf="true" data-offset-key="17351:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17352"><span data-slate-leaf="true" data-offset-key="17352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nonExistentTopics</span></span></span></span><span data-slate-object="text" data-key="17353"><span data-slate-leaf="true" data-offset-key="17353:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17354"><span data-slate-leaf="true" data-offset-key="17354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17355"><span data-slate-leaf="true" data-offset-key="17355:0" data-first-offset="true"><span data-slate-string="true"> topicsToBeDeleted -- controllerContext.allTopics</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17356"><span data-slate-object="text" data-key="17357"><span data-slate-leaf="true" data-offset-key="17357:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17358"><span data-slate-leaf="true" data-offset-key="17358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17359"><span data-slate-leaf="true" data-offset-key="17359:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17360"><span data-slate-leaf="true" data-offset-key="17360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(nonExistentTopics.nonEmpty)</span></span></span></span><span data-slate-object="text" data-key="17361"><span data-slate-leaf="true" data-offset-key="17361:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17362"><span data-slate-object="text" data-key="17363"><span data-slate-leaf="true" data-offset-key="17363:0" data-first-offset="true"><span data-slate-string="true">    warn(s</span></span></span><span data-slate-object="text" data-key="17364"><span data-slate-leaf="true" data-offset-key="17364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Ignoring request to delete non-existing topics ${nonExistentTopics.mkString("</span></span></span></span><span data-slate-object="text" data-key="17365"><span data-slate-leaf="true" data-offset-key="17365:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="17366"><span data-slate-leaf="true" data-offset-key="17366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")}"</span></span></span></span><span data-slate-object="text" data-key="17367"><span data-slate-leaf="true" data-offset-key="17367:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17368"><span data-slate-object="text" data-key="17369"><span data-slate-leaf="true" data-offset-key="17369:0" data-first-offset="true"><span data-slate-string="true">    zkClient.deleteTopicDeletions(nonExistentTopics.toSeq, controllerContext.epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17370"><span data-slate-object="text" data-key="17371"><span data-slate-leaf="true" data-offset-key="17371:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17372"><span data-slate-object="text" data-key="17373"><span data-slate-leaf="true" data-offset-key="17373:0" data-first-offset="true"><span data-slate-string="true">  topicsToBeDeleted --= nonExistentTopics</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17374"><span data-slate-object="text" data-key="17375"><span data-slate-leaf="true" data-offset-key="17375:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17376"><span data-slate-leaf="true" data-offset-key="17376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果 delete.topic.enable 参数设置成 true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17377"><span data-slate-object="text" data-key="17378"><span data-slate-leaf="true" data-offset-key="17378:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17379"><span data-slate-leaf="true" data-offset-key="17379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17380"><span data-slate-leaf="true" data-offset-key="17380:0" data-first-offset="true"><span data-slate-string="true"> (config.deleteTopicEnable) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17381"><span data-slate-object="text" data-key="17382"><span data-slate-leaf="true" data-offset-key="17382:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17383"><span data-slate-leaf="true" data-offset-key="17383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17384"><span data-slate-leaf="true" data-offset-key="17384:0" data-first-offset="true"><span data-slate-string="true"> (topicsToBeDeleted.nonEmpty) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17385"><span data-slate-object="text" data-key="17386"><span data-slate-leaf="true" data-offset-key="17386:0" data-first-offset="true"><span data-slate-string="true">      info(s</span></span></span><span data-slate-object="text" data-key="17387"><span data-slate-leaf="true" data-offset-key="17387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Starting topic deletion for topics ${topicsToBeDeleted.mkString("</span></span></span></span><span data-slate-object="text" data-key="17388"><span data-slate-leaf="true" data-offset-key="17388:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="17389"><span data-slate-leaf="true" data-offset-key="17389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")}"</span></span></span></span><span data-slate-object="text" data-key="17390"><span data-slate-leaf="true" data-offset-key="17390:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17391"><span data-slate-object="text" data-key="17392"><span data-slate-leaf="true" data-offset-key="17392:0" data-first-offset="true"><span data-slate-string="true">      topicsToBeDeleted.foreach {topic =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17393"><span data-slate-object="text" data-key="17394"><span data-slate-leaf="true" data-offset-key="17394:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17395"><span data-slate-leaf="true" data-offset-key="17395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="17396"><span data-slate-leaf="true" data-offset-key="17396:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17397"><span data-slate-leaf="true" data-offset-key="17397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">partitionReassignmentInProgress</span></span></span></span><span data-slate-object="text" data-key="17398"><span data-slate-leaf="true" data-offset-key="17398:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17399"><span data-slate-leaf="true" data-offset-key="17399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="17400"><span data-slate-leaf="true" data-offset-key="17400:0" data-first-offset="true"><span data-slate-string="true"> controllerContext.partitionsBeingReassigned.map(_.topic).contains(topic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17401"><span data-slate-object="text" data-key="17402"><span data-slate-leaf="true" data-offset-key="17402:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17403"><span data-slate-leaf="true" data-offset-key="17403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17404"><span data-slate-leaf="true" data-offset-key="17404:0" data-first-offset="true"><span data-slate-string="true"> (partitionReassignmentInProgress)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17405"><span data-slate-object="text" data-key="17406"><span data-slate-leaf="true" data-offset-key="17406:0" data-first-offset="true"><span data-slate-string="true">          topicDeletionManager.markTopicIneligibleForDeletion(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17407"><span data-slate-object="text" data-key="17408"><span data-slate-leaf="true" data-offset-key="17408:0" data-first-offset="true"><span data-slate-string="true">            Set(topic), reason = </span></span></span><span data-slate-object="text" data-key="17409"><span data-slate-leaf="true" data-offset-key="17409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"topic reassignment in progress"</span></span></span></span><span data-slate-object="text" data-key="17410"><span data-slate-leaf="true" data-offset-key="17410:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17411"><span data-slate-object="text" data-key="17412"><span data-slate-leaf="true" data-offset-key="17412:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17413"><span data-slate-object="text" data-key="17414"><span data-slate-leaf="true" data-offset-key="17414:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17415"><span data-slate-leaf="true" data-offset-key="17415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将待删除主题插入到删除等待集合交由 TopicDeletionManager 处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17416"><span data-slate-object="text" data-key="17417"><span data-slate-leaf="true" data-offset-key="17417:0" data-first-offset="true"><span data-slate-string="true">      topicDeletionManager.enqueueTopicsForDeletion(topicsToBeDeleted)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17418"><span data-slate-object="text" data-key="17419"><span data-slate-leaf="true" data-offset-key="17419:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17420"><span data-slate-object="text" data-key="17421"><span data-slate-leaf="true" data-offset-key="17421:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="17422"><span data-slate-leaf="true" data-offset-key="17422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17423"><span data-slate-leaf="true" data-offset-key="17423:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span><span data-slate-object="text" data-key="17424"><span data-slate-leaf="true" data-offset-key="17424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不允许删除主题</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17425"><span data-slate-object="text" data-key="17426"><span data-slate-leaf="true" data-offset-key="17426:0" data-first-offset="true"><span data-slate-string="true">    info(s</span></span></span><span data-slate-object="text" data-key="17427"><span data-slate-leaf="true" data-offset-key="17427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Removing $topicsToBeDeleted since delete topic is disabled"</span></span></span></span><span data-slate-object="text" data-key="17428"><span data-slate-leaf="true" data-offset-key="17428:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17429"><span data-slate-object="text" data-key="17430"><span data-slate-leaf="true" data-offset-key="17430:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17431"><span data-slate-leaf="true" data-offset-key="17431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清除 ZooKeeper 下 /admin/delete_topics 下的子节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17432"><span data-slate-object="text" data-key="17433"><span data-slate-leaf="true" data-offset-key="17433:0" data-first-offset="true"><span data-slate-string="true">    zkClient.deleteTopicDeletions(topicsToBeDeleted.toSeq, controllerContext.epochZkVersion)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17434"><span data-slate-object="text" data-key="17435"><span data-slate-leaf="true" data-offset-key="17435:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17436"><span data-slate-object="text" data-key="17437"><span data-slate-leaf="true" data-offset-key="17437:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17438"><span data-slate-object="text" data-key="17439"><span data-slate-leaf="true" data-offset-key="17439:0" data-first-offset="true"><span data-slate-string="true">为了帮助你更直观地理解，我再画一张图来说明下：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17440"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/97/c9/976d35f7771f4cd5ef94eda856fb53c9.jpg?wh=2400*2985"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17441"><span data-slate-object="text" data-key="17442"><span data-slate-leaf="true" data-offset-key="17442:0" data-first-offset="true"><span data-slate-string="true">首先，代码从 ZooKeeper 的 /admin/delete_topics 下获取子节点列表，即待删除主题列表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17443"><span data-slate-object="text" data-key="17444"><span data-slate-leaf="true" data-offset-key="17444:0" data-first-offset="true"><span data-slate-string="true">之后，比对元数据缓存中的主题列表，获知压根不存在的主题列表。如果确实有不存在的主题，删除 /admin/delete_topics 下对应的子节点就行了。同时，代码会更新待删除主题列表，将这些不存在的主题剔除掉。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17445"><span data-slate-object="text" data-key="17446"><span data-slate-leaf="true" data-offset-key="17446:0" data-first-offset="true"><span data-slate-string="true">接着，代码会检查 Broker 端参数 delete.topic.enable 的值。如果该参数为 false，即不允许删除主题，代码就会清除 ZooKeeper 下的对应子节点，不会做其他操作。反之，代码会遍历待删除主题列表，将那些正在执行分区迁移的主题暂时设置成 “不可删除” 状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17447"><span data-slate-object="text" data-key="17448"><span data-slate-leaf="true" data-offset-key="17448:0" data-first-offset="true"><span data-slate-string="true">最后，把剩下可以删除的主题交由 TopicDeletionManager，由它执行真正的删除逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17449"><span data-slate-object="text" data-key="17450"><span data-slate-leaf="true" data-offset-key="17450:0" data-first-offset="true"><span data-slate-string="true">这里的 TopicDeletionManager 是 Kafka 专门负责删除主题的管理器，下节课我会详细讲解它的代码实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17451" id="sr-toc-7"><span data-slate-object="text" data-key="17452"><span data-slate-leaf="true" data-offset-key="17452:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17453"><span data-slate-object="text" data-key="17454"><span data-slate-leaf="true" data-offset-key="17454:0" data-first-offset="true"><span data-slate-string="true">今天，我们学习了 Controller 的两个主要功能：管理集群 Broker 成员和主题。这两个功能是 Controller 端提供的重要服务。我建议你仔细地查看这两部分的源码，弄明白 Controller 是如何管理集群中的重要资源的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17455"><span data-slate-object="text" data-key="17456"><span data-slate-leaf="true" data-offset-key="17456:0" data-first-offset="true"><span data-slate-string="true">针对这些内容，我总结了几个重点，希望可以帮助你更好地理解和记忆。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17457"><div data-slate-type="list-line" data-slate-object="block" data-key="17458"><span data-slate-object="text" data-key="17459"><span data-slate-leaf="true" data-offset-key="17459:0" data-first-offset="true"><span data-slate-string="true">集群成员管理：Controller 负责对集群所有成员进行有效管理，包括自动发现新增 Broker、自动处理下线 Broker，以及及时响应 Broker 数据的变更。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17460"><span data-slate-object="text" data-key="17461"><span data-slate-leaf="true" data-offset-key="17461:0" data-first-offset="true"><span data-slate-string="true">主题管理：Controller 负责对集群上的所有主题进行高效管理，包括创建主题、变更主题以及删除主题，等等。对于删除主题而言，实际的删除操作由底层的 TopicDeletionManager 完成。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="17462"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/00/37/0035a579a02def8f5234831bf0857f37.jpg?wh=2250*1149"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17463"><span data-slate-object="text" data-key="17464"><span data-slate-leaf="true" data-offset-key="17464:0" data-first-offset="true"><span data-slate-string="true">接下来，我们将进入到下一个模块：状态机模块。在该模块中，我们将系统学习 Kafka 提供的三大状态机或管理器。Controller 非常依赖这些状态机对下辖的所有 Kafka 对象进行管理。在下一个模块中，我将带你深入了解分区或副本在底层的状态流转是怎么样的，你一定不要错过。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17465" id="sr-toc-8"><span data-slate-object="text" data-key="17466"><span data-slate-leaf="true" data-offset-key="17466:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17467"><span data-slate-object="text" data-key="17468"><span data-slate-leaf="true" data-offset-key="17468:0" data-first-offset="true"><span data-slate-string="true">如果我们想要使用脚本命令增加一个主题的分区，你知道应该用 KafkaController 类中的哪个方法吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17469"><span data-slate-object="text" data-key="17470"><span data-slate-leaf="true" data-offset-key="17470:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区畅所欲言，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-9">精选留言 (9)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们重点了解了 Controller 选举部分的代码。课后我请你思考这样一个问题：源码中当 Controller 选举之后哪里更新的元数据请求？ 其实这是在 onControllerFailover 方法中完成的。该方法中调用：
sendUpdateMetadataRequest (controllerContext.liveOrShuttingDownBrokerIds.toSeq, Set.empty) 令集群所有 Broker 更新元数据

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-05-29</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132"></div></div><div><div><div><span>RonnieXie</span></div></div><div>老师，学习了关于 Controller 源码课，我再深入看相关源码，梳理了流程图，您看这流程图是否正确
http://note.youdao.com/noteshare?id=1f999786b77ada75fbb58b2831770e47&amp;sub=554F637E4F984C7B8036365C51E0758B</div><div><p>作者回复：很棒的总结啊！我自己也学到了一些：）</p></div><div><div>2020-05-27</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI34ZlT6HSOtJBeTvTvfNLfYECDdJXnHCMj2BHdrRaqRLnZiafnxmKQ2aXoQkW1RLQOyt0tlyzEWIA/132"></div></div><div><div><div><span>ahu0605</span></div></div><div>这节课应该往前提，提到这个主题的前面，讲的太好了</div><div><div>2022-05-18</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/f7/8a/09a4c107.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>贝</span></div></div><div>胡夕老师，最近遇到个问题，向请教一下您：
我下线了 controller 节点 1 后，2 被选为新的 controller。但是发现有个 topic A 的 partition1 元数据信息不对，原先它的三个副本在 2，3，4（2 为 leader）。但是看打印的日志中发现新 controller 2 告诉 6 节点说 topic A 的 partition1 的副本是 3，2，6，但并没有向 2，3，4 同步元数据的变更，导致 6 节点无故新增了一副本并向 leader 拉取一直失败，以下是日志：您帮我看看这是为什么呢？感觉像是 controller 的下线导致元数据错乱了

6 机器上的日志：
[2021-03-16 14:12:39.979] TRACE [Broker id=6] Cached leader info UpdateMetadataPartitionState (topicName='A', p
artitionIndex=1, controllerEpoch=29, leader=2, leaderEpoch=13, isr=[2, 3, 4], zkVersion=25, replicas=[2, 3, 4], offlineReplicas=[
]) for partition A-1 in response to UpdateMetadata request sent by controller 1 epoch 29 with correlation id 0 (state.change.logger)

[2021-03-16 15:00:46.600] TRACE [Broker id=6] Cached leader info UpdateMetadataPartitionState (topicName='A', p
artitionIndex=1, controllerEpoch=29, leader=2, leaderEpoch=13, isr=[2, 3, 4], zkVersion=25, replicas=[3, 2, 6], offlineReplicas=[
]) for partition A-1 in response to UpdateMetadata request sent by controller 2 epoch 30 with correlation id 0 (state.change.logger)

2 机器上的日志：
[2021-03-16 15:07:26,164] WARN [ReplicaManager broker=2] Leader 2 failed to record follower 6's position 11679162 since the replica is not recognized to be one of the assigned replicas 3,4,2 for partition A-1. Empty records will be returned for this partition. (kafka.server.ReplicaManager)</div><div><div>2021-03-18</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLSEtGul3OLHfbkbq5qOywnsCmZ68icDaFcvghXyvmAicTUtLr9q18dmJHH3ZWq3QLGcaicHo1ARn5gA/132"></div></div><div><div><div><span>雕</span></div></div><div>老师，在看 Controller 处理各种事件的时候，发现相关的处理方法中都没有重新注册 watcher。比如新启动节点触发了 BrokerChange 事件，处理流程中并没有重新注册对 /brokers/ids 子节点的监听。这个是在哪里进行重新注册的</div><div><p>作者回复：在 KafkaController 的 onControllerFailover 方法中会注册</p></div><div><div>2020-12-22</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/76/53/21d62a23.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>鲁・本</span></div></div><div>增加一个主题的分区调用的是 KafkaController 的方法: processTopicChange -&gt; onNewPartitionCreation </div><div><div>2020-09-01</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div> 调用的是 onNewPartitionCreation 方法，源码如下
private def onNewPartitionCreation (newPartitions: Set [TopicPartition]): Unit = {
    info (s"New partition creation callback for ${newPartitions.mkString (",")}")
    partitionStateMachine.handleStateChanges (newPartitions.toSeq, NewPartition)
    replicaStateMachine.handleStateChanges (controllerContext.replicasForPartition (newPartitions).toSeq, NewReplica)
    partitionStateMachine.handleStateChanges (
      newPartitions.toSeq,
      OnlinePartition,
      Some (OfflinePartitionLeaderElectionStrategy (false))
    )
    replicaStateMachine.handleStateChanges (controllerContext.replicasForPartition (newPartitions).toSeq, OnlineReplica)
  }</div><div><div>2020-08-25</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132"></div></div><div><div><div><span>RonnieXie</span></div></div><div>	胡夕老师，我们项目最近在预研使用图数据库，刚看碰巧在一篇文章（https://zhuanlan.zhihu.com/p/99381529）
	看到你们公司使用 JanusGraph，想问下这数据库稳定性如何，同时也看到另外一款百度开源的 HugeGraph，
	你们选型的 JanusGraph 看中的优势是什么？</div><div><p>作者回复：比较稳定，API 也算好用。没怎么用过百度的图数据库。另外我们公司用图数据库很长时间了，那时 HugeGraph 还没有开源。</p></div><div><div>2020-05-27</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>空知</span></div></div><div>调用脚本 kafka-topics.sh
	exec $(dirname $0)/kafka-run-class.sh kafka.admin.TopicCommand "$@"
对应的类 object TopicCommand 的 topicService.createTopic (opts) 根据是否定义 ZK 信息走实现类 ZookeeperTopicService 或者 AdminClientTopicService 然后 ZookeeperTopicService 里面
adminZkClient.createTopic 然后就可以触发 topicChange 事件...</div><div><p>作者回复：是的</p></div><div><div>2020-05-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1g"><outline class="toc-level-h1" data-reactid=".1g.0" style="width: 175px;"><active data-reactid=".1g.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1g.0.1"><span data-reactid=".1g.0.1.0">15 | 如何理解 Controller 在 Kafka 集群中的作用？</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.1" style="width: 165px;"><active data-reactid=".1g.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1g.1.1"><span data-reactid=".1g.1.1.0">集群成员管理</span></a></outline><outline class="toc-level-h3" data-reactid=".1g.2" style="width: 155px;"><active data-reactid=".1g.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1g.2.1"><span data-reactid=".1g.2.1.0">成员数量管理</span></a></outline><outline class="toc-level-h3" data-reactid=".1g.3" style="width: 155px;"><active data-reactid=".1g.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1g.3.1"><span data-reactid=".1g.3.1.0">成员信息管理</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.4" style="width: 165px;"><active data-reactid=".1g.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1g.4.1"><span data-reactid=".1g.4.1.0">主题管理</span></a></outline><outline class="toc-level-h3" data-reactid=".1g.5" style="width: 155px;"><active data-reactid=".1g.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1g.5.1"><span data-reactid=".1g.5.1.0">主题创建 / 变更</span></a></outline><outline class="toc-level-h3" data-reactid=".1g.6" style="width: 155px;"><active data-reactid=".1g.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1g.6.1"><span data-reactid=".1g.6.1.0">主题删除</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.7" style="width: 165px;"><active data-reactid=".1g.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1g.7.1"><span data-reactid=".1g.7.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.8" style="width: 165px;"><active data-reactid=".1g.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1g.8.1"><span data-reactid=".1g.8.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.9" style="width: 165px;"><active data-reactid=".1g.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1g.9.1"><span data-reactid=".1g.9.1.0">精选留言 (9)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/239512" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>